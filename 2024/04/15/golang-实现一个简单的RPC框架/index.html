<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/Bopop-logo.png">
  <link rel="icon" type="image/png" href="/img/Bopop-logo.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="This v blog">
  <meta name="author" content="BoDen">
  <meta name="keywords" content="Bopop,blog,åšå®¢,PHP,Python,Golang">
  <title>golang å®ç°ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶ - Bopop</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 5.0.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Bopop</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/pexels.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
                golang å®ç°ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2024-04-15 10:25">
      2024å¹´4æœˆ15æ—¥ ä¸Šåˆ
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.9k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      60
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h2 id="ğŸ”Œ-golang-å®ç°ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶"><a class="header-anchor" href="#ğŸ”Œ-golang-å®ç°ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶"></a>ğŸ”Œ golang å®ç°ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶</h2>
<p>è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸å¯æˆ–ç¼ºçš„é€šä¿¡æ–¹å¼ï¼Œå®ƒå…è®¸ä¸€ä¸ªç¨‹åºè°ƒç”¨å¦ä¸€ä¸ªåœ°å€ç©ºé—´ï¼ˆé€šå¸¸æ˜¯ç½‘ç»œä¸Šçš„å¦ä¸€å°æœºå™¨ï¼‰çš„è¿‡ç¨‹æˆ–å‡½æ•°ï¼Œå°±åƒè°ƒç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·ã€‚æœ¬æ–‡å°†å¸¦ä½ ä»é›¶å¼€å§‹å®ç°ä¸€ä¸ªç®€å•ä½†åŠŸèƒ½å®Œæ•´çš„Goè¯­è¨€RPCæ¡†æ¶ï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£RPCçš„å·¥ä½œåŸç†ã€‚</p>
<h3 id="ğŸ“š-RPCåŸºç¡€æ¦‚å¿µ"><a class="header-anchor" href="#ğŸ“š-RPCåŸºç¡€æ¦‚å¿µ"></a>ğŸ“š RPCåŸºç¡€æ¦‚å¿µ</h3>
<p>åœ¨å¼€å§‹å®ç°ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£RPCçš„åŸºæœ¬æ¦‚å¿µå’Œå·¥ä½œæµç¨‹ï¼š</p>
<ol>
<li><strong>å®¢æˆ·ç«¯å­˜æ ¹(Client Stub)</strong>ï¼šåœ¨å®¢æˆ·ç«¯å°è£…è¿œç¨‹è°ƒç”¨çš„ç»†èŠ‚ï¼Œä½¿è¿œç¨‹è°ƒç”¨çœ‹èµ·æ¥åƒæœ¬åœ°è°ƒç”¨</li>
<li><strong>æœåŠ¡ç«¯å­˜æ ¹(Server Stub)</strong>ï¼šæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè§£ç å‚æ•°ï¼Œè°ƒç”¨æœ¬åœ°æœåŠ¡ï¼Œç„¶åç¼–ç ç»“æœè¿”å›</li>
<li><strong>åºåˆ—åŒ–/ååºåˆ—åŒ–</strong>ï¼šå°†å‡½æ•°è°ƒç”¨çš„å‚æ•°å’Œè¿”å›å€¼åœ¨ç½‘ç»œä¸Šä¼ è¾“</li>
<li><strong>ç½‘ç»œä¼ è¾“</strong>ï¼šåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´ä¼ è¾“åºåˆ—åŒ–åçš„æ•°æ®</li>
</ol>
<p>ä¸€ä¸ªå…¸å‹çš„RPCè°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs clean">å®¢æˆ·ç«¯ -&gt; å®¢æˆ·ç«¯å­˜æ ¹ -&gt; åºåˆ—åŒ– -&gt; ç½‘ç»œä¼ è¾“ -&gt; æœåŠ¡ç«¯å­˜æ ¹ -&gt; ååºåˆ—åŒ– -&gt; æœåŠ¡æ‰§è¡Œ -&gt; åºåˆ—åŒ–ç»“æœ -&gt; ç½‘ç»œä¼ è¾“ -&gt; å®¢æˆ·ç«¯å­˜æ ¹ -&gt; ååºåˆ—åŒ– -&gt; å®¢æˆ·ç«¯</code></pre>
<h3 id="ğŸ¯-è®¾è®¡ç›®æ ‡"><a class="header-anchor" href="#ğŸ¯-è®¾è®¡ç›®æ ‡"></a>ğŸ¯ è®¾è®¡ç›®æ ‡</h3>
<p>æˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç®€å•ä½†åŠŸèƒ½å®Œæ•´çš„RPCæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ol>
<li>æ”¯æŒæ³¨å†Œå’Œè°ƒç”¨æœåŠ¡æ–¹æ³•</li>
<li>ä½¿ç”¨JSONä½œä¸ºåºåˆ—åŒ–æ ¼å¼</li>
<li>åŸºäºTCPçš„ç½‘ç»œä¼ è¾“</li>
<li>ç®€å•çš„é”™è¯¯å¤„ç†</li>
<li>æ”¯æŒå¹¶å‘è°ƒç”¨</li>
</ol>
<h3 id="ğŸ—ï¸-æ¡†æ¶ç»“æ„è®¾è®¡"><a class="header-anchor" href="#ğŸ—ï¸-æ¡†æ¶ç»“æ„è®¾è®¡"></a>ğŸ—ï¸ æ¡†æ¶ç»“æ„è®¾è®¡</h3>
<p>æˆ‘ä»¬çš„RPCæ¡†æ¶å°†åŒ…å«ä»¥ä¸‹ä¸»è¦ç»„ä»¶ï¼š</p>
<ol>
<li><strong>æœåŠ¡æ³¨å†Œä¸­å¿ƒ</strong>ï¼šç®¡ç†å¯ç”¨çš„æœåŠ¡å’Œæ–¹æ³•</li>
<li><strong>æœåŠ¡ç«¯</strong>ï¼šæ³¨å†ŒæœåŠ¡å¹¶å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚</li>
<li><strong>å®¢æˆ·ç«¯</strong>ï¼šå‘é€è¯·æ±‚å¹¶æ¥æ”¶å“åº”</li>
<li><strong>ç¼–è§£ç å™¨</strong>ï¼šè´Ÿè´£è¯·æ±‚å’Œå“åº”çš„åºåˆ—åŒ–/ååºåˆ—åŒ–</li>
<li><strong>ä¼ è¾“å±‚</strong>ï¼šå¤„ç†ç½‘ç»œé€šä¿¡</li>
</ol>
<h3 id="ğŸ’»-ä»£ç å®ç°"><a class="header-anchor" href="#ğŸ’»-ä»£ç å®ç°"></a>ğŸ’» ä»£ç å®ç°</h3>
<p>è®©æˆ‘ä»¬å¼€å§‹å®ç°è¿™ä¸ªç®€å•çš„RPCæ¡†æ¶ï¼Œæˆ‘ä»¬å°†å…¶å‘½åä¸º&quot;SimpleRPC&quot;ã€‚</p>
<h4 id="1-å®šä¹‰æ¶ˆæ¯ç»“æ„"><a class="header-anchor" href="#1-å®šä¹‰æ¶ˆæ¯ç»“æ„"></a>1. å®šä¹‰æ¶ˆæ¯ç»“æ„</h4>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰RPCè¯·æ±‚å’Œå“åº”çš„æ¶ˆæ¯ç»“æ„ï¼š</p>
<pre><code class="hljs go"><span class="hljs-keyword">package</span> simplerpc

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">&quot;encoding/json&quot;</span>
	<span class="hljs-string">&quot;errors&quot;</span>
	<span class="hljs-string">&quot;fmt&quot;</span>
	<span class="hljs-string">&quot;io&quot;</span>
	<span class="hljs-string">&quot;log&quot;</span>
	<span class="hljs-string">&quot;net&quot;</span>
	<span class="hljs-string">&quot;reflect&quot;</span>
	<span class="hljs-string">&quot;strings&quot;</span>
	<span class="hljs-string">&quot;sync&quot;</span>
	<span class="hljs-string">&quot;unicode&quot;</span>
)

<span class="hljs-comment">// è¯·æ±‚ç»“æ„</span>
<span class="hljs-keyword">type</span> Request <span class="hljs-keyword">struct</span> &#123;
	ServiceMethod <span class="hljs-keyword">string</span>        <span class="hljs-string">`json:&quot;service_method&quot;`</span> <span class="hljs-comment">// æ ¼å¼: &quot;Service.Method&quot;</span>
	Args          <span class="hljs-keyword">interface</span>&#123;&#125;   <span class="hljs-string">`json:&quot;args&quot;`</span>           <span class="hljs-comment">// å‚æ•°</span>
	ReqID         <span class="hljs-keyword">uint64</span>        <span class="hljs-string">`json:&quot;req_id&quot;`</span>         <span class="hljs-comment">// è¯·æ±‚ID</span>
&#125;

<span class="hljs-comment">// å“åº”ç»“æ„</span>
<span class="hljs-keyword">type</span> Response <span class="hljs-keyword">struct</span> &#123;
	ServiceMethod <span class="hljs-keyword">string</span>      <span class="hljs-string">`json:&quot;service_method&quot;`</span> <span class="hljs-comment">// å¯¹åº”è¯·æ±‚çš„ServiceMethod</span>
	ReqID         <span class="hljs-keyword">uint64</span>      <span class="hljs-string">`json:&quot;req_id&quot;`</span>         <span class="hljs-comment">// å¯¹åº”è¯·æ±‚çš„ID</span>
	Error         <span class="hljs-keyword">string</span>      <span class="hljs-string">`json:&quot;error&quot;`</span>          <span class="hljs-comment">// é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœè°ƒç”¨æˆåŠŸåˆ™ä¸ºç©º</span>
	Result        <span class="hljs-keyword">interface</span>&#123;&#125; <span class="hljs-string">`json:&quot;result&quot;`</span>         <span class="hljs-comment">// è°ƒç”¨ç»“æœ</span>
&#125;</code></pre>
<h4 id="2-å®ç°ç¼–è§£ç å™¨"><a class="header-anchor" href="#2-å®ç°ç¼–è§£ç å™¨"></a>2. å®ç°ç¼–è§£ç å™¨</h4>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸ªç®€å•çš„JSONç¼–è§£ç å™¨ï¼š</p>
<pre><code class="hljs go"><span class="hljs-comment">// ç¼–è§£ç å™¨æ¥å£</span>
<span class="hljs-keyword">type</span> Codec <span class="hljs-keyword">interface</span> &#123;
	ReadRequest() (*Request, error)
	ReadResponse() (*Response, error)
	WriteRequest(*Request) error
	WriteResponse(*Response) error
	Close() error
&#125;

<span class="hljs-comment">// JSONç¼–è§£ç å™¨</span>
<span class="hljs-keyword">type</span> JSONCodec <span class="hljs-keyword">struct</span> &#123;
	conn io.ReadWriteCloser
	dec  *json.Decoder
	enc  *json.Encoder
	mu   sync.Mutex
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewJSONCodec</span><span class="hljs-params">(conn io.ReadWriteCloser)</span> *<span class="hljs-title">JSONCodec</span></span> &#123;
	<span class="hljs-keyword">return</span> &amp;JSONCodec&#123;
		conn: conn,
		dec:  json.NewDecoder(conn),
		enc:  json.NewEncoder(conn),
	&#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *JSONCodec)</span> <span class="hljs-title">ReadRequest</span><span class="hljs-params">()</span> <span class="hljs-params">(*Request, error)</span></span> &#123;
	<span class="hljs-keyword">var</span> req Request
	<span class="hljs-keyword">if</span> err := c.dec.Decode(&amp;req); err != <span class="hljs-literal">nil</span> &#123;
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
	&#125;
	<span class="hljs-keyword">return</span> &amp;req, <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *JSONCodec)</span> <span class="hljs-title">ReadResponse</span><span class="hljs-params">()</span> <span class="hljs-params">(*Response, error)</span></span> &#123;
	<span class="hljs-keyword">var</span> resp Response
	<span class="hljs-keyword">if</span> err := c.dec.Decode(&amp;resp); err != <span class="hljs-literal">nil</span> &#123;
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
	&#125;
	<span class="hljs-keyword">return</span> &amp;resp, <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *JSONCodec)</span> <span class="hljs-title">WriteRequest</span><span class="hljs-params">(req *Request)</span> <span class="hljs-title">error</span></span> &#123;
	c.mu.Lock()
	<span class="hljs-keyword">defer</span> c.mu.Unlock()
	<span class="hljs-keyword">return</span> c.enc.Encode(req)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *JSONCodec)</span> <span class="hljs-title">WriteResponse</span><span class="hljs-params">(resp *Response)</span> <span class="hljs-title">error</span></span> &#123;
	c.mu.Lock()
	<span class="hljs-keyword">defer</span> c.mu.Unlock()
	<span class="hljs-keyword">return</span> c.enc.Encode(resp)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *JSONCodec)</span> <span class="hljs-title">Close</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;
	<span class="hljs-keyword">return</span> c.conn.Close()
&#125;</code></pre>
<h4 id="3-æœåŠ¡æ³¨å†Œä¸æ–¹æ³•è°ƒç”¨"><a class="header-anchor" href="#3-æœåŠ¡æ³¨å†Œä¸æ–¹æ³•è°ƒç”¨"></a>3. æœåŠ¡æ³¨å†Œä¸æ–¹æ³•è°ƒç”¨</h4>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å®ç°æœåŠ¡æ³¨å†Œå’Œæ–¹æ³•è°ƒç”¨çš„æ ¸å¿ƒé€»è¾‘ï¼š</p>
<pre><code class="hljs go"><span class="hljs-comment">// æœåŠ¡ç±»å‹</span>
<span class="hljs-keyword">type</span> Service <span class="hljs-keyword">struct</span> &#123;
	name   <span class="hljs-keyword">string</span>                 <span class="hljs-comment">// æœåŠ¡åç§°</span>
	rcvr   reflect.Value          <span class="hljs-comment">// æ¥æ”¶è€…å¯¹è±¡</span>
	typ    reflect.Type           <span class="hljs-comment">// æ¥æ”¶è€…ç±»å‹</span>
	method <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*MethodType <span class="hljs-comment">// æ–¹æ³•é›†åˆ</span>
&#125;

<span class="hljs-comment">// æ–¹æ³•ç±»å‹</span>
<span class="hljs-keyword">type</span> MethodType <span class="hljs-keyword">struct</span> &#123;
	method    reflect.Method <span class="hljs-comment">// æ–¹æ³•æœ¬èº«</span>
	ArgType   reflect.Type   <span class="hljs-comment">// ç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹</span>
	ReplyType reflect.Type   <span class="hljs-comment">// ç¬¬äºŒä¸ªå‚æ•°ç±»å‹</span>
&#125;

<span class="hljs-comment">// æœåŠ¡æ³¨å†Œä¸­å¿ƒ</span>
<span class="hljs-keyword">type</span> Registry <span class="hljs-keyword">struct</span> &#123;
	mu       sync.RWMutex
	services <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*Service
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewRegistry</span><span class="hljs-params">()</span> *<span class="hljs-title">Registry</span></span> &#123;
	<span class="hljs-keyword">return</span> &amp;Registry&#123;
		services: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*Service),
	&#125;
&#125;

<span class="hljs-comment">// æ³¨å†ŒæœåŠ¡</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Registry)</span> <span class="hljs-title">Register</span><span class="hljs-params">(rcvr <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;
	s := <span class="hljs-built_in">new</span>(Service)
	s.rcvr = reflect.ValueOf(rcvr)
	s.typ = reflect.TypeOf(rcvr)
	s.name = reflect.Indirect(s.rcvr).Type().Name()
	<span class="hljs-keyword">if</span> s.name == <span class="hljs-string">&quot;&quot;</span> &#123;
		<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;æ— æ³•è·å–æœåŠ¡åç§°&quot;</span>)
	&#125;
	
	s.method = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*MethodType)
	
	<span class="hljs-comment">// éå†æ–¹æ³•å¹¶æ³¨å†Œ</span>
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; s.typ.NumMethod(); i++ &#123;
		method := s.typ.Method(i)
		mtype := method.Type
		
		<span class="hljs-comment">// æ–¹æ³•å¿…é¡»æ˜¯å¯¼å‡ºçš„</span>
		<span class="hljs-keyword">if</span> method.PkgPath != <span class="hljs-string">&quot;&quot;</span> &#123;
			<span class="hljs-keyword">continue</span>
		&#125;
		
		<span class="hljs-comment">// æ–¹æ³•å¿…é¡»æœ‰ä¸‰ä¸ªå‚æ•°: receiver, args, *reply</span>
		<span class="hljs-keyword">if</span> mtype.NumIn() != <span class="hljs-number">3</span> &#123;
			<span class="hljs-keyword">continue</span>
		&#125;
		
		<span class="hljs-comment">// ç¬¬äºŒä¸ªå‚æ•°å¿…é¡»æ˜¯å¯¼å‡ºçš„æˆ–å†…å»ºç±»å‹</span>
		argType := mtype.In(<span class="hljs-number">1</span>)
		<span class="hljs-keyword">if</span> !isExportedOrBuiltin(argType) &#123;
			<span class="hljs-keyword">continue</span>
		&#125;
		
		<span class="hljs-comment">// ç¬¬ä¸‰ä¸ªå‚æ•°å¿…é¡»æ˜¯æŒ‡é’ˆç±»å‹</span>
		replyType := mtype.In(<span class="hljs-number">2</span>)
		<span class="hljs-keyword">if</span> replyType.Kind() != reflect.Ptr &#123;
			<span class="hljs-keyword">continue</span>
		&#125;
		
		<span class="hljs-comment">// æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªerror</span>
		<span class="hljs-keyword">if</span> mtype.NumOut() != <span class="hljs-number">1</span> &#123;
			<span class="hljs-keyword">continue</span>
		&#125;
		<span class="hljs-keyword">if</span> returnType := mtype.Out(<span class="hljs-number">0</span>); returnType != reflect.TypeOf((*error)(<span class="hljs-literal">nil</span>)).Elem() &#123;
			<span class="hljs-keyword">continue</span>
		&#125;
		
		s.method[method.Name] = &amp;MethodType&#123;
			method:    method,
			ArgType:   argType,
			ReplyType: replyType,
		&#125;
	&#125;
	
	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(s.method) == <span class="hljs-number">0</span> &#123;
		<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;æœåŠ¡æ²¡æœ‰å¯ç”¨çš„RPCæ–¹æ³•&quot;</span>)
	&#125;
	
	r.mu.Lock()
	<span class="hljs-keyword">defer</span> r.mu.Unlock()
	r.services[s.name] = s
	
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-comment">// æŸ¥æ‰¾æœåŠ¡æ–¹æ³•</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Registry)</span> <span class="hljs-title">findMethod</span><span class="hljs-params">(serviceMethod <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(svc *Service, mtype *MethodType, err error)</span></span> &#123;
	r.mu.RLock()
	<span class="hljs-keyword">defer</span> r.mu.RUnlock()
	
	<span class="hljs-comment">// è§£ææœåŠ¡å’Œæ–¹æ³•å</span>
	parts := strings.Split(serviceMethod, <span class="hljs-string">&quot;.&quot;</span>)
	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) != <span class="hljs-number">2</span> &#123;
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;æœåŠ¡æ–¹æ³•æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º &#x27;Service.Method&#x27;&quot;</span>)
	&#125;
	
	serviceName, methodName := parts[<span class="hljs-number">0</span>], parts[<span class="hljs-number">1</span>]
	
	<span class="hljs-comment">// æŸ¥æ‰¾æœåŠ¡</span>
	service, ok := r.services[serviceName]
	<span class="hljs-keyword">if</span> !ok &#123;
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;æœåŠ¡ %s ä¸å­˜åœ¨&quot;</span>, serviceName)
	&#125;
	
	<span class="hljs-comment">// æŸ¥æ‰¾æ–¹æ³•</span>
	method, ok := service.method[methodName]
	<span class="hljs-keyword">if</span> !ok &#123;
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;æ–¹æ³• %s åœ¨æœåŠ¡ %s ä¸­ä¸å­˜åœ¨&quot;</span>, methodName, serviceName)
	&#125;
	
	<span class="hljs-keyword">return</span> service, method, <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-comment">// è°ƒç”¨æœåŠ¡æ–¹æ³•</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Registry)</span> <span class="hljs-title">call</span><span class="hljs-params">(serviceMethod <span class="hljs-keyword">string</span>, args <span class="hljs-keyword">interface</span>&#123;&#125;, reply <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;
	service, mtype, err := r.findMethod(serviceMethod)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
		<span class="hljs-keyword">return</span> err
	&#125;
	
	<span class="hljs-comment">// å°†å‚æ•°è½¬æ¢ä¸ºæ­£ç¡®çš„ç±»å‹</span>
	argValue := reflect.ValueOf(args)
	<span class="hljs-keyword">if</span> argValue.Type() != mtype.ArgType &#123;
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;å‚æ•°ç±»å‹ä¸åŒ¹é…: %v vs %v&quot;</span>, argValue.Type(), mtype.ArgType)
	&#125;
	
	replyValue := reflect.ValueOf(reply)
	<span class="hljs-keyword">if</span> replyValue.Type() != mtype.ReplyType &#123;
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;å›å¤ç±»å‹ä¸åŒ¹é…: %v vs %v&quot;</span>, replyValue.Type(), mtype.ReplyType)
	&#125;
	
	<span class="hljs-comment">// è°ƒç”¨æ–¹æ³•</span>
	function := mtype.method.Func
	returnValues := function.Call([]reflect.Value&#123;
		service.rcvr,
		argValue,
		replyValue,
	&#125;)
	
	<span class="hljs-comment">// å¤„ç†é”™è¯¯</span>
	errInter := returnValues[<span class="hljs-number">0</span>].Interface()
	<span class="hljs-keyword">if</span> errInter != <span class="hljs-literal">nil</span> &#123;
		<span class="hljs-keyword">return</span> errInter.(error)
	&#125;
	
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-comment">// åˆ¤æ–­ç±»å‹æ˜¯å¦ä¸ºå¯¼å‡ºæˆ–å†…å»ºç±»å‹</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isExportedOrBuiltin</span><span class="hljs-params">(t reflect.Type)</span> <span class="hljs-title">bool</span></span> &#123;
	<span class="hljs-keyword">if</span> t.Kind() == reflect.Ptr &#123;
		t = t.Elem()
	&#125;
	
	<span class="hljs-comment">// å†…å»ºç±»å‹</span>
	<span class="hljs-keyword">if</span> t.PkgPath() == <span class="hljs-string">&quot;&quot;</span> &#123;
		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
	&#125;
	
	<span class="hljs-comment">// å¯¼å‡ºç±»å‹</span>
	<span class="hljs-keyword">return</span> t.Name() != <span class="hljs-string">&quot;&quot;</span> &amp;&amp; unicode.IsUpper(<span class="hljs-keyword">rune</span>(t.Name()[<span class="hljs-number">0</span>]))
&#125;</code></pre>
<h4 id="4-å®ç°æœåŠ¡ç«¯"><a class="header-anchor" href="#4-å®ç°æœåŠ¡ç«¯"></a>4. å®ç°æœåŠ¡ç«¯</h4>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®ç°RPCæœåŠ¡ç«¯ï¼š</p>
<pre><code class="hljs go"><span class="hljs-comment">// æœåŠ¡ç«¯</span>
<span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;
	registry *Registry
	mu       sync.Mutex
	seq      <span class="hljs-keyword">uint64</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span><span class="hljs-params">()</span> *<span class="hljs-title">Server</span></span> &#123;
	<span class="hljs-keyword">return</span> &amp;Server&#123;
		registry: NewRegistry(),
	&#125;
&#125;

<span class="hljs-comment">// æ³¨å†ŒæœåŠ¡</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span> <span class="hljs-title">Register</span><span class="hljs-params">(rcvr <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;
	<span class="hljs-keyword">return</span> s.registry.Register(rcvr)
&#125;

<span class="hljs-comment">// å¯åŠ¨æœåŠ¡ç›‘å¬</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span> <span class="hljs-title">Listen</span><span class="hljs-params">(network, address <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;
	listener, err := net.Listen(network, address)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
		<span class="hljs-keyword">return</span> err
	&#125;
	<span class="hljs-keyword">defer</span> listener.Close()
	
	log.Printf(<span class="hljs-string">&quot;RPCæœåŠ¡å™¨ç›‘å¬åœ¨ %s\n&quot;</span>, address)
	
	<span class="hljs-keyword">for</span> &#123;
		conn, err := listener.Accept()
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
			log.Printf(<span class="hljs-string">&quot;æ¥å—è¿æ¥é”™è¯¯: %v\n&quot;</span>, err)
			<span class="hljs-keyword">continue</span>
		&#125;
		
		<span class="hljs-keyword">go</span> s.handleConnection(conn)
	&#125;
&#125;

<span class="hljs-comment">// å¤„ç†è¿æ¥</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span> <span class="hljs-title">handleConnection</span><span class="hljs-params">(conn net.Conn)</span></span> &#123;
	<span class="hljs-keyword">defer</span> conn.Close()
	
	codec := NewJSONCodec(conn)
	<span class="hljs-keyword">defer</span> codec.Close()
	
	<span class="hljs-keyword">for</span> &#123;
		req, err := codec.ReadRequest()
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
			<span class="hljs-keyword">if</span> err != io.EOF &#123;
				log.Printf(<span class="hljs-string">&quot;è¯»å–è¯·æ±‚é”™è¯¯: %v\n&quot;</span>, err)
			&#125;
			<span class="hljs-keyword">break</span>
		&#125;
		
		<span class="hljs-keyword">go</span> s.handleRequest(codec, req)
	&#125;
&#125;

<span class="hljs-comment">// å¤„ç†è¯·æ±‚</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span> <span class="hljs-title">handleRequest</span><span class="hljs-params">(codec *JSONCodec, req *Request)</span></span> &#123;
	resp := &amp;Response&#123;
		ServiceMethod: req.ServiceMethod,
		ReqID:         req.ReqID,
	&#125;
	
	<span class="hljs-comment">// åˆ›å»ºå‚æ•°å’Œå›å¤å€¼</span>
	service, mtype, err := s.registry.findMethod(req.ServiceMethod)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
		resp.Error = err.Error()
		codec.WriteResponse(resp)
		<span class="hljs-keyword">return</span>
	&#125;
	
	<span class="hljs-comment">// åˆ›å»ºå‚æ•°å®ä¾‹</span>
	argv := reflect.New(mtype.ArgType)
	
	<span class="hljs-comment">// å°†è¯·æ±‚å‚æ•°è§£ç åˆ°argv</span>
	<span class="hljs-keyword">if</span> req.Args != <span class="hljs-literal">nil</span> &#123;
		argBytes, err := json.Marshal(req.Args)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
			resp.Error = fmt.Sprintf(<span class="hljs-string">&quot;å‚æ•°ç¼–ç é”™è¯¯: %v&quot;</span>, err)
			codec.WriteResponse(resp)
			<span class="hljs-keyword">return</span>
		&#125;
		
		<span class="hljs-keyword">if</span> err := json.Unmarshal(argBytes, argv.Interface()); err != <span class="hljs-literal">nil</span> &#123;
			resp.Error = fmt.Sprintf(<span class="hljs-string">&quot;å‚æ•°è§£ç é”™è¯¯: %v&quot;</span>, err)
			codec.WriteResponse(resp)
			<span class="hljs-keyword">return</span>
		&#125;
	&#125;
	
	<span class="hljs-comment">// åˆ›å»ºå›å¤å®ä¾‹</span>
	replyv := reflect.New(mtype.ReplyType.Elem())
	
	<span class="hljs-comment">// è°ƒç”¨æœåŠ¡æ–¹æ³•</span>
	function := mtype.method.Func
	returnValues := function.Call([]reflect.Value&#123;
		service.rcvr,
		argv.Elem(),
		replyv,
	&#125;)
	
	<span class="hljs-comment">// å¤„ç†é”™è¯¯</span>
	errInter := returnValues[<span class="hljs-number">0</span>].Interface()
	<span class="hljs-keyword">if</span> errInter != <span class="hljs-literal">nil</span> &#123;
		resp.Error = errInter.(error).Error()
	&#125; <span class="hljs-keyword">else</span> &#123;
		resp.Result = replyv.Interface()
	&#125;
	
	<span class="hljs-comment">// å‘é€å“åº”</span>
	<span class="hljs-keyword">if</span> err := codec.WriteResponse(resp); err != <span class="hljs-literal">nil</span> &#123;
		log.Printf(<span class="hljs-string">&quot;å†™å…¥å“åº”é”™è¯¯: %v\n&quot;</span>, err)
	&#125;
&#125;</code></pre>
<h4 id="5-å®ç°å®¢æˆ·ç«¯"><a class="header-anchor" href="#5-å®ç°å®¢æˆ·ç«¯"></a>5. å®ç°å®¢æˆ·ç«¯</h4>
<p>æœ€åï¼Œæˆ‘ä»¬å®ç°RPCå®¢æˆ·ç«¯ï¼š</p>
<pre><code class="hljs go"><span class="hljs-comment">// å®¢æˆ·ç«¯</span>
<span class="hljs-keyword">type</span> Client <span class="hljs-keyword">struct</span> &#123;
	codec  Codec
	mu     sync.Mutex
	seq    <span class="hljs-keyword">uint64</span>
	pending <span class="hljs-keyword">map</span>[<span class="hljs-keyword">uint64</span>]*Call
&#125;

<span class="hljs-comment">// è°ƒç”¨ç»“æ„</span>
<span class="hljs-keyword">type</span> Call <span class="hljs-keyword">struct</span> &#123;
	ServiceMethod <span class="hljs-keyword">string</span>      <span class="hljs-comment">// æ ¼å¼: &quot;Service.Method&quot;</span>
	Args          <span class="hljs-keyword">interface</span>&#123;&#125; <span class="hljs-comment">// å‚æ•°</span>
	Reply         <span class="hljs-keyword">interface</span>&#123;&#125; <span class="hljs-comment">// å›å¤</span>
	Error         error       <span class="hljs-comment">// é”™è¯¯</span>
	Done          <span class="hljs-keyword">chan</span> *Call  <span class="hljs-comment">// è°ƒç”¨å®Œæˆæ—¶çš„ä¿¡å·</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(call *Call)</span> <span class="hljs-title">done</span><span class="hljs-params">()</span></span> &#123;
	call.Done &lt;- call
&#125;

<span class="hljs-comment">// åˆ›å»ºæ–°å®¢æˆ·ç«¯</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewClient</span><span class="hljs-params">(conn io.ReadWriteCloser)</span> *<span class="hljs-title">Client</span></span> &#123;
	client := &amp;Client&#123;
		codec:   NewJSONCodec(conn),
		pending: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">uint64</span>]*Call),
	&#125;
	
	<span class="hljs-keyword">go</span> client.receiveResponse()
	
	<span class="hljs-keyword">return</span> client
&#125;

<span class="hljs-comment">// è¿æ¥åˆ°RPCæœåŠ¡å™¨</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Dial</span><span class="hljs-params">(network, address <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Client, error)</span></span> &#123;
	conn, err := net.Dial(network, address)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
	&#125;
	
	<span class="hljs-keyword">return</span> NewClient(conn), <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-comment">// æ¥æ”¶å“åº”</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span> <span class="hljs-title">receiveResponse</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-keyword">for</span> &#123;
		resp, err := c.codec.ReadResponse()
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
			<span class="hljs-keyword">if</span> err != io.EOF &#123;
				log.Printf(<span class="hljs-string">&quot;è¯»å–å“åº”é”™è¯¯: %v\n&quot;</span>, err)
			&#125;
			<span class="hljs-keyword">break</span>
		&#125;
		
		c.mu.Lock()
		call, ok := c.pending[resp.ReqID]
		<span class="hljs-built_in">delete</span>(c.pending, resp.ReqID)
		c.mu.Unlock()
		
		<span class="hljs-keyword">if</span> !ok &#123;
			log.Printf(<span class="hljs-string">&quot;æ‰¾ä¸åˆ°è¯·æ±‚ID: %d\n&quot;</span>, resp.ReqID)
			<span class="hljs-keyword">continue</span>
		&#125;
		
		<span class="hljs-keyword">if</span> resp.Error != <span class="hljs-string">&quot;&quot;</span> &#123;
			call.Error = errors.New(resp.Error)
		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> resp.Result != <span class="hljs-literal">nil</span> &#123;
			<span class="hljs-comment">// å°†ç»“æœè§£ç åˆ°reply</span>
			resultBytes, err := json.Marshal(resp.Result)
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
				call.Error = fmt.Errorf(<span class="hljs-string">&quot;ç»“æœç¼–ç é”™è¯¯: %v&quot;</span>, err)
			&#125; <span class="hljs-keyword">else</span> &#123;
				<span class="hljs-keyword">if</span> err := json.Unmarshal(resultBytes, call.Reply); err != <span class="hljs-literal">nil</span> &#123;
					call.Error = fmt.Errorf(<span class="hljs-string">&quot;ç»“æœè§£ç é”™è¯¯: %v&quot;</span>, err)
				&#125;
			&#125;
		&#125;
		
		call.done()
	&#125;
	
	<span class="hljs-comment">// å…³é—­è¿æ¥æ—¶ï¼Œå°†æ‰€æœ‰æŒ‚èµ·çš„è°ƒç”¨æ ‡è®°ä¸ºå¤±è´¥</span>
	c.mu.Lock()
	<span class="hljs-keyword">for</span> _, call := <span class="hljs-keyword">range</span> c.pending &#123;
		call.Error = errors.New(<span class="hljs-string">&quot;è¿æ¥å·²å…³é—­&quot;</span>)
		call.done()
	&#125;
	c.mu.Unlock()
&#125;

<span class="hljs-comment">// å‘é€è¯·æ±‚</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span> <span class="hljs-title">send</span><span class="hljs-params">(call *Call)</span></span> &#123;
	c.mu.Lock()
	<span class="hljs-keyword">defer</span> c.mu.Unlock()
	
	<span class="hljs-comment">// åˆ†é…è¯·æ±‚ID</span>
	c.seq++
	reqID := c.seq
	
	<span class="hljs-comment">// æ³¨å†Œè°ƒç”¨</span>
	c.pending[reqID] = call
	
	<span class="hljs-comment">// åˆ›å»ºå¹¶å‘é€è¯·æ±‚</span>
	req := &amp;Request&#123;
		ServiceMethod: call.ServiceMethod,
		Args:          call.Args,
		ReqID:         reqID,
	&#125;
	
	<span class="hljs-keyword">if</span> err := c.codec.WriteRequest(req); err != <span class="hljs-literal">nil</span> &#123;
		<span class="hljs-built_in">delete</span>(c.pending, reqID)
		call.Error = err
		call.done()
	&#125;
&#125;

<span class="hljs-comment">// è°ƒç”¨æœåŠ¡æ–¹æ³•</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span> <span class="hljs-title">Call</span><span class="hljs-params">(serviceMethod <span class="hljs-keyword">string</span>, args <span class="hljs-keyword">interface</span>&#123;&#125;, reply <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;
	call := &amp;Call&#123;
		ServiceMethod: serviceMethod,
		Args:          args,
		Reply:         reply,
		Done:          <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Call, <span class="hljs-number">1</span>),
	&#125;
	
	c.send(call)
	
	<span class="hljs-comment">// ç­‰å¾…è°ƒç”¨å®Œæˆ</span>
	&lt;-call.Done
	
	<span class="hljs-keyword">return</span> call.Error
&#125;

<span class="hljs-comment">// å¼‚æ­¥è°ƒç”¨æœåŠ¡æ–¹æ³•</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span> <span class="hljs-title">Go</span><span class="hljs-params">(serviceMethod <span class="hljs-keyword">string</span>, args <span class="hljs-keyword">interface</span>&#123;&#125;, reply <span class="hljs-keyword">interface</span>&#123;&#125;)</span> *<span class="hljs-title">Call</span></span> &#123;
	call := &amp;Call&#123;
		ServiceMethod: serviceMethod,
		Args:          args,
		Reply:         reply,
		Done:          <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Call, <span class="hljs-number">1</span>),
	&#125;
	
	c.send(call)
	
	<span class="hljs-keyword">return</span> call
&#125;

<span class="hljs-comment">// å…³é—­å®¢æˆ·ç«¯</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span> <span class="hljs-title">Close</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;
	<span class="hljs-keyword">return</span> c.codec.Close()
&#125;</code></pre>
<h3 id="ğŸ§ª-ä½¿ç”¨ç¤ºä¾‹"><a class="header-anchor" href="#ğŸ§ª-ä½¿ç”¨ç¤ºä¾‹"></a>ğŸ§ª ä½¿ç”¨ç¤ºä¾‹</h3>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»å®ç°äº†ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨å®ƒï¼š</p>
<pre><code class="hljs go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">&quot;fmt&quot;</span>
	<span class="hljs-string">&quot;log&quot;</span>
	<span class="hljs-string">&quot;simplerpc&quot;</span>
	<span class="hljs-string">&quot;time&quot;</span>
)

<span class="hljs-comment">// ç®—æœ¯æœåŠ¡</span>
<span class="hljs-keyword">type</span> Arith <span class="hljs-keyword">struct</span>&#123;&#125;

<span class="hljs-comment">// ä¹˜æ³•æ–¹æ³•</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Arith)</span> <span class="hljs-title">Multiply</span><span class="hljs-params">(args Args, reply *<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">error</span></span> &#123;
	*reply = args.A * args.B
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-comment">// é™¤æ³•æ–¹æ³•</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Arith)</span> <span class="hljs-title">Divide</span><span class="hljs-params">(args Args, reply *Quotient)</span> <span class="hljs-title">error</span></span> &#123;
	<span class="hljs-keyword">if</span> args.B == <span class="hljs-number">0</span> &#123;
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;é™¤æ•°ä¸èƒ½ä¸ºé›¶&quot;</span>)
	&#125;
	reply.Quo = args.A / args.B
	reply.Rem = args.A % args.B
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-comment">// å‚æ•°ç»“æ„</span>
<span class="hljs-keyword">type</span> Args <span class="hljs-keyword">struct</span> &#123;
	A, B <span class="hljs-keyword">int</span>
&#125;

<span class="hljs-comment">// å•†å’Œä½™æ•°</span>
<span class="hljs-keyword">type</span> Quotient <span class="hljs-keyword">struct</span> &#123;
	Quo, Rem <span class="hljs-keyword">int</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-comment">// å¯åŠ¨æœåŠ¡å™¨</span>
	<span class="hljs-keyword">go</span> startServer()
	
	<span class="hljs-comment">// ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨</span>
	time.Sleep(<span class="hljs-number">1</span> * time.Second)
	
	<span class="hljs-comment">// åˆ›å»ºå®¢æˆ·ç«¯</span>
	client, err := simplerpc.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;localhost:1234&quot;</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
		log.Fatal(<span class="hljs-string">&quot;è¿æ¥æœåŠ¡å™¨å¤±è´¥:&quot;</span>, err)
	&#125;
	<span class="hljs-keyword">defer</span> client.Close()
	
	<span class="hljs-comment">// åŒæ­¥è°ƒç”¨</span>
	args := &amp;Args&#123;<span class="hljs-number">7</span>, <span class="hljs-number">8</span>&#125;
	<span class="hljs-keyword">var</span> reply <span class="hljs-keyword">int</span>
	<span class="hljs-keyword">if</span> err := client.Call(<span class="hljs-string">&quot;Arith.Multiply&quot;</span>, args, &amp;reply); err != <span class="hljs-literal">nil</span> &#123;
		log.Fatal(<span class="hljs-string">&quot;è°ƒç”¨Arith.Multiplyå¤±è´¥:&quot;</span>, err)
	&#125;
	fmt.Printf(<span class="hljs-string">&quot;Arith.Multiply: %d * %d = %d\n&quot;</span>, args.A, args.B, reply)
	
	<span class="hljs-comment">// å¼‚æ­¥è°ƒç”¨</span>
	quotient := <span class="hljs-built_in">new</span>(Quotient)
	divCall := client.Go(<span class="hljs-string">&quot;Arith.Divide&quot;</span>, &amp;Args&#123;<span class="hljs-number">15</span>, <span class="hljs-number">5</span>&#125;, quotient)
	
	<span class="hljs-comment">// åšå…¶ä»–äº‹æƒ…...</span>
	
	<span class="hljs-comment">// ç­‰å¾…è°ƒç”¨å®Œæˆ</span>
	&lt;-divCall.Done
	<span class="hljs-keyword">if</span> divCall.Error != <span class="hljs-literal">nil</span> &#123;
		log.Fatal(<span class="hljs-string">&quot;è°ƒç”¨Arith.Divideå¤±è´¥:&quot;</span>, divCall.Error)
	&#125;
	fmt.Printf(<span class="hljs-string">&quot;Arith.Divide: %d / %d = %d ä½™ %d\n&quot;</span>, <span class="hljs-number">15</span>, <span class="hljs-number">5</span>, quotient.Quo, quotient.Rem)
	
	<span class="hljs-comment">// æµ‹è¯•é”™è¯¯å¤„ç†</span>
	<span class="hljs-keyword">if</span> err := client.Call(<span class="hljs-string">&quot;Arith.Divide&quot;</span>, &amp;Args&#123;<span class="hljs-number">10</span>, <span class="hljs-number">0</span>&#125;, quotient); err != <span class="hljs-literal">nil</span> &#123;
		fmt.Println(<span class="hljs-string">&quot;é¢„æœŸçš„é”™è¯¯:&quot;</span>, err)
	&#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startServer</span><span class="hljs-params">()</span></span> &#123;
	server := simplerpc.NewServer()
	<span class="hljs-keyword">if</span> err := server.Register(<span class="hljs-built_in">new</span>(Arith)); err != <span class="hljs-literal">nil</span> &#123;
		log.Fatal(<span class="hljs-string">&quot;æ³¨å†ŒArithæœåŠ¡å¤±è´¥:&quot;</span>, err)
	&#125;
	
	<span class="hljs-keyword">if</span> err := server.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;localhost:1234&quot;</span>); err != <span class="hljs-literal">nil</span> &#123;
		log.Fatal(<span class="hljs-string">&quot;å¯åŠ¨æœåŠ¡å™¨å¤±è´¥:&quot;</span>, err)
	&#125;
&#125;</code></pre>
<h3 id="ğŸ”§-æ¡†æ¶ä¼˜åŒ–"><a class="header-anchor" href="#ğŸ”§-æ¡†æ¶ä¼˜åŒ–"></a>ğŸ”§ æ¡†æ¶ä¼˜åŒ–</h3>
<p>æˆ‘ä»¬çš„RPCæ¡†æ¶è™½ç„¶ç®€å•ï¼Œä½†ä»æœ‰å¾ˆå¤šå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼š</p>
<h4 id="1-æ”¯æŒå¤šç§ç¼–è§£ç æ ¼å¼"><a class="header-anchor" href="#1-æ”¯æŒå¤šç§ç¼–è§£ç æ ¼å¼"></a>1. æ”¯æŒå¤šç§ç¼–è§£ç æ ¼å¼</h4>
<p>æˆ‘ä»¬å¯ä»¥æ‰©å±•æ¡†æ¶ï¼Œæ”¯æŒæ›´å¤šçš„ç¼–è§£ç æ ¼å¼ï¼Œå¦‚Protocol Buffersã€MessagePackç­‰ï¼š</p>
<pre><code class="hljs go"><span class="hljs-keyword">type</span> CodecType <span class="hljs-keyword">string</span>

<span class="hljs-keyword">const</span> (
	JSONCodecType   CodecType = <span class="hljs-string">&quot;json&quot;</span>
	ProtoCodecType  CodecType = <span class="hljs-string">&quot;proto&quot;</span>
	MsgPackCodecType CodecType = <span class="hljs-string">&quot;msgpack&quot;</span>
)

<span class="hljs-comment">// ç¼–è§£ç å™¨å·¥å‚</span>
<span class="hljs-keyword">type</span> CodecFactory <span class="hljs-keyword">interface</span> &#123;
	NewCodec(conn io.ReadWriteCloser) Codec
&#125;

<span class="hljs-comment">// æ³¨å†Œç¼–è§£ç å™¨å·¥å‚</span>
<span class="hljs-keyword">var</span> codecFactories = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[CodecType]CodecFactory)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RegisterCodecFactory</span><span class="hljs-params">(typ CodecType, factory CodecFactory)</span></span> &#123;
	codecFactories[typ] = factory
&#125;</code></pre>
<h4 id="2-æ·»åŠ è¶…æ—¶æ§åˆ¶"><a class="header-anchor" href="#2-æ·»åŠ è¶…æ—¶æ§åˆ¶"></a>2. æ·»åŠ è¶…æ—¶æ§åˆ¶</h4>
<p>ä¸ºäº†æé«˜ç³»ç»Ÿçš„å¯é æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ è¯·æ±‚è¶…æ—¶æ§åˆ¶ï¼š</p>
<pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span> <span class="hljs-title">CallWithTimeout</span><span class="hljs-params">(serviceMethod <span class="hljs-keyword">string</span>, args <span class="hljs-keyword">interface</span>&#123;&#125;, reply <span class="hljs-keyword">interface</span>&#123;&#125;, timeout time.Duration)</span> <span class="hljs-title">error</span></span> &#123;
	call := &amp;Call&#123;
		ServiceMethod: serviceMethod,
		Args:          args,
		Reply:         reply,
		Done:          <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Call, <span class="hljs-number">1</span>),
	&#125;
	
	c.send(call)
	
	<span class="hljs-keyword">select</span> &#123;
	<span class="hljs-keyword">case</span> &lt;-call.Done:
		<span class="hljs-keyword">return</span> call.Error
	<span class="hljs-keyword">case</span> &lt;-time.After(timeout):
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;è°ƒç”¨è¶…æ—¶: %s&quot;</span>, serviceMethod)
	&#125;
&#125;</code></pre>
<h4 id="3-æ·»åŠ è¿æ¥æ± "><a class="header-anchor" href="#3-æ·»åŠ è¿æ¥æ± "></a>3. æ·»åŠ è¿æ¥æ± </h4>
<p>å¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªè¿æ¥æ± æ¥å¤ç”¨è¿æ¥ï¼š</p>
<pre><code class="hljs go"><span class="hljs-keyword">type</span> ClientPool <span class="hljs-keyword">struct</span> &#123;
	mu      sync.Mutex
	clients []*Client
	addr    <span class="hljs-keyword">string</span>
	network <span class="hljs-keyword">string</span>
	size    <span class="hljs-keyword">int</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewClientPool</span><span class="hljs-params">(network, addr <span class="hljs-keyword">string</span>, size <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(*ClientPool, error)</span></span> &#123;
	pool := &amp;ClientPool&#123;
		network: network,
		addr:    addr,
		size:    size,
	&#125;
	
	<span class="hljs-comment">// é¢„åˆ›å»ºè¿æ¥</span>
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; size; i++ &#123;
		client, err := Dial(network, addr)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
		&#125;
		pool.clients = <span class="hljs-built_in">append</span>(pool.clients, client)
	&#125;
	
	<span class="hljs-keyword">return</span> pool, <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *ClientPool)</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-params">(*Client, error)</span></span> &#123;
	p.mu.Lock()
	<span class="hljs-keyword">defer</span> p.mu.Unlock()
	
	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(p.clients) == <span class="hljs-number">0</span> &#123;
		<span class="hljs-keyword">return</span> Dial(p.network, p.addr)
	&#125;
	
	<span class="hljs-comment">// å–å‡ºæœ€åä¸€ä¸ªå®¢æˆ·ç«¯</span>
	client := p.clients[<span class="hljs-built_in">len</span>(p.clients)<span class="hljs-number">-1</span>]
	p.clients = p.clients[:<span class="hljs-built_in">len</span>(p.clients)<span class="hljs-number">-1</span>]
	
	<span class="hljs-keyword">return</span> client, <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *ClientPool)</span> <span class="hljs-title">Put</span><span class="hljs-params">(client *Client)</span></span> &#123;
	p.mu.Lock()
	<span class="hljs-keyword">defer</span> p.mu.Unlock()
	
	<span class="hljs-comment">// å¦‚æœæ± å·²æ»¡ï¼Œå…³é—­å®¢æˆ·ç«¯</span>
	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(p.clients) &gt;= p.size &#123;
		client.Close()
		<span class="hljs-keyword">return</span>
	&#125;
	
	p.clients = <span class="hljs-built_in">append</span>(p.clients, client)
&#125;</code></pre>
<h4 id="4-æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡"><a class="header-anchor" href="#4-æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡"></a>4. æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡</h4>
<p>åœ¨å®é™…çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬éœ€è¦æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡æœºåˆ¶ï¼š</p>
<pre><code class="hljs go"><span class="hljs-keyword">type</span> ServiceDiscovery <span class="hljs-keyword">interface</span> &#123;
	GetService(name <span class="hljs-keyword">string</span>) ([]<span class="hljs-keyword">string</span>, error) <span class="hljs-comment">// è¿”å›æœåŠ¡åœ°å€åˆ—è¡¨</span>
	Register(name, addr <span class="hljs-keyword">string</span>) error         <span class="hljs-comment">// æ³¨å†ŒæœåŠ¡</span>
	Deregister(name, addr <span class="hljs-keyword">string</span>) error       <span class="hljs-comment">// æ³¨é”€æœåŠ¡</span>
&#125;

<span class="hljs-keyword">type</span> LoadBalancer <span class="hljs-keyword">interface</span> &#123;
	Select(servers []<span class="hljs-keyword">string</span>) <span class="hljs-keyword">string</span> <span class="hljs-comment">// é€‰æ‹©ä¸€ä¸ªæœåŠ¡å™¨</span>
&#125;

<span class="hljs-comment">// ç®€å•çš„è½®è¯¢è´Ÿè½½å‡è¡¡å™¨</span>
<span class="hljs-keyword">type</span> RoundRobinBalancer <span class="hljs-keyword">struct</span> &#123;
	mu    sync.Mutex
	index <span class="hljs-keyword">int</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *RoundRobinBalancer)</span> <span class="hljs-title">Select</span><span class="hljs-params">(servers []<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;
	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(servers) == <span class="hljs-number">0</span> &#123;
		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>
	&#125;
	
	b.mu.Lock()
	<span class="hljs-keyword">defer</span> b.mu.Unlock()
	
	server := servers[b.index]
	b.index = (b.index + <span class="hljs-number">1</span>) % <span class="hljs-built_in">len</span>(servers)
	
	<span class="hljs-keyword">return</span> server
&#125;</code></pre>
<h3 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h3>
<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»é›¶å¼€å§‹å®ç°äº†ä¸€ä¸ªç®€å•ä½†åŠŸèƒ½å®Œæ•´çš„RPCæ¡†æ¶ï¼ŒåŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>æ¶ˆæ¯ç»“æ„è®¾è®¡</strong>ï¼šå®šä¹‰äº†RPCè¯·æ±‚å’Œå“åº”çš„æ ¼å¼</li>
<li><strong>ç¼–è§£ç å™¨</strong>ï¼šå®ç°äº†åŸºäºJSONçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</li>
<li><strong>æœåŠ¡æ³¨å†Œ</strong>ï¼šæ”¯æŒæ³¨å†ŒæœåŠ¡å’Œæ–¹æ³•</li>
<li><strong>æœåŠ¡è°ƒç”¨</strong>ï¼šé€šè¿‡åå°„æœºåˆ¶è°ƒç”¨æœåŠ¡æ–¹æ³•</li>
<li><strong>ç½‘ç»œä¼ è¾“</strong>ï¼šåŸºäºTCPçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å®ç°</li>
<li><strong>é”™è¯¯å¤„ç†</strong>ï¼šåœ¨å„ä¸ªç¯èŠ‚å¤„ç†å¯èƒ½çš„é”™è¯¯</li>
<li><strong>å¹¶å‘æ”¯æŒ</strong>ï¼šæ”¯æŒå¹¶å‘è°ƒç”¨å’Œå¤„ç†</li>
</ol>
<p>è¿™ä¸ªç®€å•çš„RPCæ¡†æ¶å±•ç¤ºäº†RPCçš„åŸºæœ¬å·¥ä½œåŸç†ï¼Œè™½ç„¶å®ƒä¸ç”Ÿäº§çº§çš„RPCæ¡†æ¶ï¼ˆå¦‚gRPCã€Thriftç­‰ï¼‰ç›¸æ¯”è¿˜æœ‰å¾ˆå¤§å·®è·ï¼Œä½†å®ƒåŒ…å«äº†RPCçš„æ ¸å¿ƒæ¦‚å¿µå’Œå®ç°ç»†èŠ‚ã€‚é€šè¿‡ç†è§£è¿™ä¸ªç®€å•çš„å®ç°ï¼Œä½ å¯ä»¥æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨å¤æ‚çš„RPCæ¡†æ¶ã€‚</p>
<p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå»ºè®®ä½¿ç”¨æˆç†Ÿçš„RPCæ¡†æ¶ï¼Œå¦‚Goæ ‡å‡†åº“çš„<code>net/rpc</code>ã€<code>net/rpc/jsonrpc</code>ï¼Œæˆ–è€…ç¬¬ä¸‰æ–¹æ¡†æ¶å¦‚gRPCã€Thriftç­‰ã€‚è¿™äº›æ¡†æ¶ç»è¿‡äº†å¹¿æ³›çš„æµ‹è¯•å’Œä¼˜åŒ–ï¼Œæä¾›äº†æ›´å¤šçš„åŠŸèƒ½å’Œæ›´å¥½çš„æ€§èƒ½ã€‚</p>
<p>ä¸è¿‡ï¼Œé€šè¿‡è‡ªå·±å®ç°ä¸€ä¸ªRPCæ¡†æ¶ï¼Œä½ å¯ä»¥æ·±å…¥ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿçš„é€šä¿¡æœºåˆ¶ï¼Œè¿™å¯¹äºè®¾è®¡å’Œä¼˜åŒ–åˆ†å¸ƒå¼ç³»ç»Ÿéå¸¸æœ‰å¸®åŠ©ã€‚</p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Golang/">Golang</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/golang/">golang</a>
                    
                      <a class="hover-with-bg" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">å¾®æœåŠ¡</a>
                    
                      <a class="hover-with-bg" href="/tags/RPC/">RPC</a>
                    
                      <a class="hover-with-bg" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">ç½‘ç»œç¼–ç¨‹</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2024/05/05/golang-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3sync%E5%8C%85%E7%9A%84%E5%B9%B6%E5%8F%91%E5%8E%9F%E8%AF%AD/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">golang æ·±å…¥ç†è§£syncåŒ…çš„å¹¶å‘åŸè¯­</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2024/04/02/golang-%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5/">
                        <span class="hidden-mobile">golang å‡½æ•°å¼ç¼–ç¨‹å®è·µ</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
              <!-- Comments -->
              <div class="comments" id="comments">
                
                
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      function loadDisqus() {
        var disqus_config = function () {
          this.page.url = 'https://blog.bopop.sbs/2024/04/15/golang-å®ç°ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶/';
          this.page.identifier = '/2024/04/15/golang-å®ç°ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶/';
        };
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = '//' + '' + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', new Date());
          (d.head || d.body).appendChild(s);
        })();
      }
      createObserver(loadDisqus, 'disqus_thread');
    </script>
    <noscript>Please enable JavaScript to view the
      <a target="_blank" href="https://disqus.com/?ref_noscript" rel="nofollow noopener noopener">comments powered by Disqus.</a>
    </noscript>
  </div>


              </div>
            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  
    <div class="col-lg-7 mx-auto nopadding-md">
      <div class="container custom mx-auto">
        <img src="/img/Bopop-logo.png" srcset="/img/loading.gif" class="rounded mx-auto d-block mt-5" style="width:220px; height:150px;">
      </div>
    </div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <!-- <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a> -->
        <span>Â© Bopop</span>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>





  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
