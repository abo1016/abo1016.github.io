<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/Bopop-logo.png">
  <link rel="icon" type="image/png" href="/img/Bopop-logo.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="This v blog">
  <meta name="author" content="BoDen">
  <meta name="keywords" content="Bopop,blog,åšå®¢,PHP,Python,Golang">
  <title>Goå®ç°é«˜æ€§èƒ½åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ - Bopop</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 5.0.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Bopop</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/pexels.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
                Goå®ç°é«˜æ€§èƒ½åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2024-09-05 08:50">
      2024å¹´9æœˆ5æ—¥ æ—©ä¸Š
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.8k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      59
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h2 id="â°-Goå®ç°é«˜æ€§èƒ½åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ"><a class="header-anchor" href="#â°-Goå®ç°é«˜æ€§èƒ½åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ"></a>â° Goå®ç°é«˜æ€§èƒ½åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ</h2>
<p>åœ¨ç°ä»£åº”ç”¨æ¶æ„ä¸­ï¼Œå®šæ—¶ä»»åŠ¡ç³»ç»Ÿæ˜¯ä¸å¯æˆ–ç¼ºçš„ç»„ä»¶ã€‚ä»æ—¥å¿—è½®è½¬ã€æ•°æ®åŒæ­¥åˆ°å®šæœŸæŠ¥å‘Šç”Ÿæˆï¼Œå„ç§åœºæ™¯éƒ½éœ€è¦å¯é çš„å®šæ—¶ä»»åŠ¡æ”¯æŒã€‚å½“ç³»ç»Ÿè§„æ¨¡æ‰©å¤§ï¼Œå•æœºå®šæ—¶ä»»åŠ¡ç³»ç»Ÿé¢ä¸´è¯¸å¤šæŒ‘æˆ˜ï¼Œå¦‚å•ç‚¹æ•…éšœã€ä»»åŠ¡å †ç§¯ã€èµ„æºç“¶é¢ˆç­‰ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨Goè¯­è¨€å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿã€‚</p>
<h3 id="ğŸŒ-ç³»ç»Ÿè®¾è®¡æ¦‚è¿°"><a class="header-anchor" href="#ğŸŒ-ç³»ç»Ÿè®¾è®¡æ¦‚è¿°"></a>ğŸŒ ç³»ç»Ÿè®¾è®¡æ¦‚è¿°</h3>
<h4 id="æ ¸å¿ƒéœ€æ±‚"><a class="header-anchor" href="#æ ¸å¿ƒéœ€æ±‚"></a>æ ¸å¿ƒéœ€æ±‚</h4>
<p>ä¸€ä¸ªä¼˜ç§€çš„åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿåº”æ»¡è¶³ä»¥ä¸‹æ ¸å¿ƒéœ€æ±‚ï¼š</p>
<ol>
<li><strong>é«˜å¯ç”¨æ€§</strong>ï¼šæ— å•ç‚¹æ•…éšœï¼ŒèŠ‚ç‚¹æ•…éšœä¸å½±å“æ•´ä½“ç³»ç»Ÿè¿è¡Œ</li>
<li><strong>å¯æ‰©å±•æ€§</strong>ï¼šæ”¯æŒåŠ¨æ€æ°´å¹³æ‰©å±•ï¼Œåº”å¯¹ä¸šåŠ¡å¢é•¿</li>
<li><strong>ä»»åŠ¡å‡†ç¡®æ€§</strong>ï¼šç¡®ä¿ä»»åŠ¡æŒ‰æ—¶æ‰§è¡Œä¸”ä¸ä¼šé‡å¤æ‰§è¡Œ</li>
<li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šä»»åŠ¡åœ¨é›†ç¾¤èŠ‚ç‚¹é—´åˆç†åˆ†é…</li>
<li><strong>æ•…éšœæ¢å¤</strong>ï¼šèŠ‚ç‚¹æ•…éšœåä»»åŠ¡èƒ½è‡ªåŠ¨è½¬ç§»</li>
<li><strong>å¯è§‚æµ‹æ€§</strong>ï¼šå®Œå–„çš„ç›‘æ§å’Œæ—¥å¿—æœºåˆ¶</li>
</ol>
<h4 id="ç³»ç»Ÿæ¶æ„"><a class="header-anchor" href="#ç³»ç»Ÿæ¶æ„"></a>ç³»ç»Ÿæ¶æ„</h4>
<p>æˆ‘ä»¬çš„åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿé‡‡ç”¨ä¸»ä»æ¶æ„ï¼Œç”±è°ƒåº¦å™¨å’Œæ‰§è¡Œå™¨ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p>
<pre><code class="hljs angelscript">                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   ä»»åŠ¡ç®¡ç†UI  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»»åŠ¡å­˜å‚¨  â”‚â—„â”€â”€â”€â”€â–ºâ”‚   è°ƒåº¦å™¨é›†ç¾¤  â”‚â—„â”€â”€â”€â”€â–ºâ”‚  æœåŠ¡æ³¨å†Œ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   æ‰§è¡Œå™¨èŠ‚ç‚¹<span class="hljs-number">1</span>  â”‚     â”‚   æ‰§è¡Œå™¨èŠ‚ç‚¹<span class="hljs-number">2</span>  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
<p>æ ¸å¿ƒç»„ä»¶ï¼š</p>
<ol>
<li><strong>è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰</strong>ï¼šè´Ÿè´£ä»»åŠ¡è°ƒåº¦ã€åˆ†å‘å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†</li>
<li><strong>æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰</strong>ï¼šè´Ÿè´£å®é™…æ‰§è¡Œä»»åŠ¡çš„å·¥ä½œèŠ‚ç‚¹</li>
<li><strong>ä»»åŠ¡å­˜å‚¨ï¼ˆTask Storeï¼‰</strong>ï¼šæŒä¹…åŒ–å­˜å‚¨ä»»åŠ¡é…ç½®å’Œæ‰§è¡ŒçŠ¶æ€</li>
<li><strong>æœåŠ¡æ³¨å†Œï¼ˆRegistryï¼‰</strong>ï¼šç®¡ç†æ‰§è¡Œå™¨èŠ‚ç‚¹çš„æ³¨å†Œå’Œå‘ç°</li>
<li><strong>ä»»åŠ¡ç®¡ç†UI</strong>ï¼šæä¾›ä»»åŠ¡é…ç½®å’Œç›‘æ§çš„Webç•Œé¢</li>
</ol>
<h3 id="ğŸ—ï¸-æ ¸å¿ƒç»„ä»¶å®ç°"><a class="header-anchor" href="#ğŸ—ï¸-æ ¸å¿ƒç»„ä»¶å®ç°"></a>ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶å®ç°</h3>
<h4 id="ä»»åŠ¡æ¨¡å‹è®¾è®¡"><a class="header-anchor" href="#ä»»åŠ¡æ¨¡å‹è®¾è®¡"></a>ä»»åŠ¡æ¨¡å‹è®¾è®¡</h4>
<p>é¦–å…ˆå®šä¹‰ä»»åŠ¡æ¨¡å‹ï¼ŒåŒ…å«ä»»åŠ¡çš„åŸºæœ¬ä¿¡æ¯å’Œè°ƒåº¦è§„åˆ™ï¼š</p>
<pre><code class="hljs go"><span class="hljs-keyword">type</span> Task <span class="hljs-keyword">struct</span> &#123;
    ID          <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;id&quot;`</span>
    Name        <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;name&quot;`</span>
    Cron        <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;cron&quot;`</span>        <span class="hljs-comment">// Cronè¡¨è¾¾å¼</span>
    Command     <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;command&quot;`</span>     <span class="hljs-comment">// è¦æ‰§è¡Œçš„å‘½ä»¤</span>
    Timeout     <span class="hljs-keyword">int</span>       <span class="hljs-string">`json:&quot;timeout&quot;`</span>     <span class="hljs-comment">// è¶…æ—¶æ—¶é—´(ç§’)</span>
    RetryTimes  <span class="hljs-keyword">int</span>       <span class="hljs-string">`json:&quot;retryTimes&quot;`</span>  <span class="hljs-comment">// é‡è¯•æ¬¡æ•°</span>
    RetryDelay  <span class="hljs-keyword">int</span>       <span class="hljs-string">`json:&quot;retryDelay&quot;`</span>  <span class="hljs-comment">// é‡è¯•å»¶è¿Ÿ(ç§’)</span>
    CreatedAt   time.Time <span class="hljs-string">`json:&quot;createdAt&quot;`</span>
    UpdatedAt   time.Time <span class="hljs-string">`json:&quot;updatedAt&quot;`</span>
    
    <span class="hljs-comment">// åˆ†å¸ƒå¼ç›¸å…³å­—æ®µ</span>
    ShardingKey <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;shardingKey&quot;`</span> <span class="hljs-comment">// åˆ†ç‰‡é”®</span>
    NodeID      <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;nodeId&quot;`</span>      <span class="hljs-comment">// æŒ‡å®šæ‰§è¡ŒèŠ‚ç‚¹ï¼Œä¸ºç©ºåˆ™è‡ªåŠ¨é€‰æ‹©</span>
&#125;

<span class="hljs-keyword">type</span> TaskExecution <span class="hljs-keyword">struct</span> &#123;
    ID          <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;id&quot;`</span>
    TaskID      <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;taskId&quot;`</span>
    Status      <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;status&quot;`</span>      <span class="hljs-comment">// pending, running, success, failed</span>
    NodeID      <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;nodeId&quot;`</span>      <span class="hljs-comment">// æ‰§è¡ŒèŠ‚ç‚¹ID</span>
    StartTime   time.Time <span class="hljs-string">`json:&quot;startTime&quot;`</span>   <span class="hljs-comment">// å¼€å§‹æ—¶é—´</span>
    EndTime     time.Time <span class="hljs-string">`json:&quot;endTime&quot;`</span>     <span class="hljs-comment">// ç»“æŸæ—¶é—´</span>
    Output      <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;output&quot;`</span>      <span class="hljs-comment">// æ‰§è¡Œè¾“å‡º</span>
    Error       <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;error&quot;`</span>       <span class="hljs-comment">// é”™è¯¯ä¿¡æ¯</span>
    RetryCount  <span class="hljs-keyword">int</span>       <span class="hljs-string">`json:&quot;retryCount&quot;`</span>  <span class="hljs-comment">// é‡è¯•è®¡æ•°</span>
&#125;</code></pre>
<h4 id="è°ƒåº¦å™¨å®ç°"><a class="header-anchor" href="#è°ƒåº¦å™¨å®ç°"></a>è°ƒåº¦å™¨å®ç°</h4>
<p>è°ƒåº¦å™¨æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£è§£æCronè¡¨è¾¾å¼å¹¶ç¡®å®šä»»åŠ¡çš„è°ƒåº¦æ—¶é—´ï¼š</p>
<pre><code class="hljs go"><span class="hljs-keyword">type</span> Scheduler <span class="hljs-keyword">struct</span> &#123;
    store         TaskStore
    registry      ServiceRegistry
    cronParser    *cron.Parser
    taskQueue     <span class="hljs-keyword">chan</span> *Task
    executionLock DistributedLock
    metrics       *SchedulerMetrics
    logger        *zap.Logger
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewScheduler</span><span class="hljs-params">(store TaskStore, registry ServiceRegistry)</span> *<span class="hljs-title">Scheduler</span></span> &#123;
    <span class="hljs-keyword">return</span> &amp;Scheduler&#123;
        store:      store,
        registry:   registry,
        cronParser: cron.NewParser(
            cron.Second | cron.Minute | cron.Hour | cron.Dom | cron.Month | cron.Dow,
        ),
        taskQueue:     <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Task, <span class="hljs-number">10000</span>),
        executionLock: NewRedisLock(<span class="hljs-string">&quot;task_execution_lock&quot;</span>),
        metrics:       NewSchedulerMetrics(),
        logger:        zap.NewProduction(),
    &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">Start</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-title">error</span></span> &#123;
    <span class="hljs-comment">// å®šæœŸæ‰«æä»»åŠ¡è¡¨ï¼Œè®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´</span>
    <span class="hljs-keyword">go</span> s.scanTasks(ctx)
    
    <span class="hljs-comment">// å¤„ç†å¾…æ‰§è¡Œçš„ä»»åŠ¡</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; runtime.NumCPU(); i++ &#123;
        <span class="hljs-keyword">go</span> s.processTaskQueue(ctx)
    &#125;
    
    <span class="hljs-comment">// å¯åŠ¨leaderé€‰ä¸¾</span>
    <span class="hljs-keyword">go</span> s.leaderElection(ctx)
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">scanTasks</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;
    ticker := time.NewTicker(<span class="hljs-number">1</span> * time.Second)
    <span class="hljs-keyword">defer</span> ticker.Stop()
    
    <span class="hljs-keyword">for</span> &#123;
        <span class="hljs-keyword">select</span> &#123;
        <span class="hljs-keyword">case</span> &lt;-ctx.Done():
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">case</span> now := &lt;-ticker.C:
            tasks, err := s.store.GetDueTasks(now)
            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
                s.logger.Error(<span class="hljs-string">&quot;Failed to get due tasks&quot;</span>, zap.Error(err))
                <span class="hljs-keyword">continue</span>
            &#125;
            
            <span class="hljs-keyword">for</span> _, task := <span class="hljs-keyword">range</span> tasks &#123;
                s.taskQueue &lt;- task
                s.metrics.TaskScheduled.Inc()
            &#125;
        &#125;
    &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">processTaskQueue</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;
    <span class="hljs-keyword">for</span> &#123;
        <span class="hljs-keyword">select</span> &#123;
        <span class="hljs-keyword">case</span> &lt;-ctx.Done():
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">case</span> task := &lt;-s.taskQueue:
            <span class="hljs-comment">// è·å–åˆ†å¸ƒå¼é”ï¼Œé˜²æ­¢ä»»åŠ¡é‡å¤æ‰§è¡Œ</span>
            lockKey := fmt.Sprintf(<span class="hljs-string">&quot;task_lock:%s:%s&quot;</span>, task.ID, time.Now().Format(<span class="hljs-string">&quot;2006-01-02T15:04:05Z&quot;</span>))
            acquired, err := s.executionLock.Acquire(lockKey, <span class="hljs-number">10</span>*time.Second)
            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || !acquired &#123;
                s.logger.Warn(<span class="hljs-string">&quot;Failed to acquire execution lock&quot;</span>, zap.String(<span class="hljs-string">&quot;taskId&quot;</span>, task.ID))
                <span class="hljs-keyword">continue</span>
            &#125;
            
            <span class="hljs-comment">// åˆ†é…æ‰§è¡ŒèŠ‚ç‚¹</span>
            node, err := s.allocateExecutionNode(task)
            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
                s.logger.Error(<span class="hljs-string">&quot;Failed to allocate execution node&quot;</span>, zap.Error(err))
                s.executionLock.Release(lockKey)
                <span class="hljs-keyword">continue</span>
            &#125;
            
            <span class="hljs-comment">// åˆ›å»ºæ‰§è¡Œè®°å½•</span>
            execution := &amp;TaskExecution&#123;
                ID:        uuid.New().String(),
                TaskID:    task.ID,
                Status:    <span class="hljs-string">&quot;pending&quot;</span>,
                NodeID:    node.ID,
                StartTime: time.Now(),
            &#125;
            
            <span class="hljs-keyword">if</span> err := s.store.CreateExecution(execution); err != <span class="hljs-literal">nil</span> &#123;
                s.logger.Error(<span class="hljs-string">&quot;Failed to create execution record&quot;</span>, zap.Error(err))
                s.executionLock.Release(lockKey)
                <span class="hljs-keyword">continue</span>
            &#125;
            
            <span class="hljs-comment">// å°†ä»»åŠ¡æ¨é€åˆ°æ‰§è¡ŒèŠ‚ç‚¹</span>
            <span class="hljs-keyword">if</span> err := s.dispatchTaskToNode(node, task, execution); err != <span class="hljs-literal">nil</span> &#123;
                s.logger.Error(<span class="hljs-string">&quot;Failed to dispatch task&quot;</span>, zap.Error(err))
                
                <span class="hljs-comment">// æ›´æ–°æ‰§è¡ŒçŠ¶æ€ä¸ºå¤±è´¥</span>
                execution.Status = <span class="hljs-string">&quot;failed&quot;</span>
                execution.Error = err.Error()
                execution.EndTime = time.Now()
                s.store.UpdateExecution(execution)
            &#125;
            
            <span class="hljs-comment">// è®¡ç®—ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´å¹¶æ›´æ–°ä»»åŠ¡</span>
            nextTime, err := s.calculateNextExecutionTime(task)
            <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;
                s.store.UpdateTaskNextExecutionTime(task.ID, nextTime)
            &#125;
            
            s.executionLock.Release(lockKey)
        &#125;
    &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">allocateExecutionNode</span><span class="hljs-params">(task *Task)</span> <span class="hljs-params">(*Node, error)</span></span> &#123;
    <span class="hljs-comment">// å¦‚æœæŒ‡å®šäº†èŠ‚ç‚¹ï¼Œåˆ™ä½¿ç”¨æŒ‡å®šèŠ‚ç‚¹</span>
    <span class="hljs-keyword">if</span> task.NodeID != <span class="hljs-string">&quot;&quot;</span> &#123;
        node, err := s.registry.GetNode(task.NodeID)
        <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; node.Status == <span class="hljs-string">&quot;online&quot;</span> &#123;
            <span class="hljs-keyword">return</span> node, <span class="hljs-literal">nil</span>
        &#125;
        <span class="hljs-comment">// æŒ‡å®šèŠ‚ç‚¹ä¸å¯ç”¨ï¼Œé™çº§ä¸ºè‡ªåŠ¨é€‰æ‹©</span>
        s.logger.Warn(<span class="hljs-string">&quot;Specified node unavailable&quot;</span>, zap.String(<span class="hljs-string">&quot;nodeId&quot;</span>, task.NodeID))
    &#125;
    
    <span class="hljs-comment">// è·å–å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨</span>
    nodes, err := s.registry.GetAvailableNodes()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || <span class="hljs-built_in">len</span>(nodes) == <span class="hljs-number">0</span> &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;no available execution nodes&quot;</span>)
    &#125;
    
    <span class="hljs-comment">// ä¸€è‡´æ€§å“ˆå¸Œé€‰æ‹©èŠ‚ç‚¹ï¼ˆæ ¹æ®åˆ†ç‰‡é”®ï¼‰</span>
    <span class="hljs-keyword">if</span> task.ShardingKey != <span class="hljs-string">&quot;&quot;</span> &#123;
        <span class="hljs-keyword">return</span> s.consistentHashNode(task.ShardingKey, nodes)
    &#125;
    
    <span class="hljs-comment">// è´Ÿè½½å‡è¡¡é€‰æ‹©èŠ‚ç‚¹</span>
    <span class="hljs-keyword">return</span> s.selectNodeByLoad(nodes)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">consistentHashNode</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, nodes []*Node)</span> <span class="hljs-params">(*Node, error)</span></span> &#123;
    <span class="hljs-comment">// å®ç°ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</span>
    hasher := consistenthash.New(<span class="hljs-number">100</span>, <span class="hljs-literal">nil</span>)
    <span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> nodes &#123;
        hasher.Add(node.ID)
    &#125;
    
    selectedNodeID := hasher.Get(key)
    <span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> nodes &#123;
        <span class="hljs-keyword">if</span> node.ID == selectedNodeID &#123;
            <span class="hljs-keyword">return</span> node, <span class="hljs-literal">nil</span>
        &#125;
    &#125;
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;failed to select node by consistent hash&quot;</span>)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">selectNodeByLoad</span><span class="hljs-params">(nodes []*Node)</span> <span class="hljs-params">(*Node, error)</span></span> &#123;
    <span class="hljs-comment">// ç®€å•çš„è´Ÿè½½å‡è¡¡ï¼šé€‰æ‹©æ´»è·ƒä»»åŠ¡æ•°æœ€å°‘çš„èŠ‚ç‚¹</span>
    <span class="hljs-keyword">var</span> selectedNode *Node
    minActiveTasks := math.MaxInt32
    
    <span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> nodes &#123;
        <span class="hljs-keyword">if</span> node.ActiveTasks &lt; minActiveTasks &#123;
            minActiveTasks = node.ActiveTasks
            selectedNode = node
        &#125;
    &#125;
    
    <span class="hljs-keyword">if</span> selectedNode == <span class="hljs-literal">nil</span> &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;failed to select node by load&quot;</span>)
    &#125;
    
    <span class="hljs-keyword">return</span> selectedNode, <span class="hljs-literal">nil</span>
&#125;</code></pre>
<h4 id="æ‰§è¡Œå™¨å®ç°"><a class="header-anchor" href="#æ‰§è¡Œå™¨å®ç°"></a>æ‰§è¡Œå™¨å®ç°</h4>
<p>æ‰§è¡Œå™¨è´Ÿè´£å®é™…è¿è¡Œä»»åŠ¡ï¼Œå¹¶æŠ¥å‘Šæ‰§è¡Œç»“æœï¼š</p>
<pre><code class="hljs go"><span class="hljs-keyword">type</span> Executor <span class="hljs-keyword">struct</span> &#123;
    nodeID      <span class="hljs-keyword">string</span>
    registry    ServiceRegistry
    taskClient  TaskClient
    workerPool  *WorkerPool
    metrics     *ExecutorMetrics
    logger      *zap.Logger
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewExecutor</span><span class="hljs-params">(nodeID <span class="hljs-keyword">string</span>, registry ServiceRegistry)</span> *<span class="hljs-title">Executor</span></span> &#123;
    <span class="hljs-keyword">return</span> &amp;Executor&#123;
        nodeID:     nodeID,
        registry:   registry,
        taskClient: NewTaskClient(),
        workerPool: NewWorkerPool(<span class="hljs-number">100</span>), <span class="hljs-comment">// æœ€å¤š100ä¸ªå¹¶å‘ä»»åŠ¡</span>
        metrics:    NewExecutorMetrics(),
        logger:     zap.NewProduction(),
    &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Executor)</span> <span class="hljs-title">Start</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-title">error</span></span> &#123;
    <span class="hljs-comment">// å‘æœåŠ¡æ³¨å†Œä¸­å¿ƒæ³¨å†Œæœ¬èŠ‚ç‚¹</span>
    <span class="hljs-keyword">if</span> err := e.registry.RegisterNode(&amp;Node&#123;
        ID:          e.nodeID,
        Address:     getLocalAddress(),
        Status:      <span class="hljs-string">&quot;online&quot;</span>,
        ActiveTasks: <span class="hljs-number">0</span>,
        Tags:        <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>),
    &#125;); err != <span class="hljs-literal">nil</span> &#123;
        <span class="hljs-keyword">return</span> err
    &#125;
    
    <span class="hljs-comment">// å®šæœŸå‘é€å¿ƒè·³</span>
    <span class="hljs-keyword">go</span> e.heartbeat(ctx)
    
    <span class="hljs-comment">// å¯åŠ¨ä»»åŠ¡ç›‘å¬å™¨</span>
    <span class="hljs-keyword">go</span> e.listenForTasks(ctx)
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Executor)</span> <span class="hljs-title">executeTask</span><span class="hljs-params">(task *Task, execution *TaskExecution)</span></span> &#123;
    <span class="hljs-comment">// å¢åŠ æ´»è·ƒä»»åŠ¡è®¡æ•°</span>
    e.metrics.ActiveTasks.Inc()
    e.registry.UpdateNodeActiveTaskCount(e.nodeID, <span class="hljs-number">1</span>)
    
    <span class="hljs-comment">// å®Œæˆåå‡å°‘è®¡æ•°</span>
    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
        e.metrics.ActiveTasks.Dec()
        e.registry.UpdateNodeActiveTaskCount(e.nodeID, <span class="hljs-number">-1</span>)
    &#125;()
    
    <span class="hljs-comment">// æ›´æ–°æ‰§è¡ŒçŠ¶æ€ä¸ºè¿è¡Œä¸­</span>
    execution.Status = <span class="hljs-string">&quot;running&quot;</span>
    e.taskClient.UpdateExecution(execution)
    
    <span class="hljs-comment">// åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œæ”¯æŒè¶…æ—¶æ§åˆ¶</span>
    ctx := context.Background()
    <span class="hljs-keyword">if</span> task.Timeout &gt; <span class="hljs-number">0</span> &#123;
        <span class="hljs-keyword">var</span> cancel context.CancelFunc
        ctx, cancel = context.WithTimeout(ctx, time.Duration(task.Timeout)*time.Second)
        <span class="hljs-keyword">defer</span> cancel()
    &#125;
    
    <span class="hljs-comment">// æ‰§è¡Œå‘½ä»¤</span>
    <span class="hljs-keyword">var</span> output bytes.Buffer
    <span class="hljs-keyword">var</span> stderr bytes.Buffer
    cmd := exec.CommandContext(ctx, <span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, task.Command)
    cmd.Stdout = &amp;output
    cmd.Stderr = &amp;stderr
    
    startTime := time.Now()
    err := cmd.Run()
    duration := time.Since(startTime)
    
    <span class="hljs-comment">// è®°å½•æ‰§è¡ŒæŒ‡æ ‡</span>
    e.metrics.TaskExecutionTime.Observe(duration.Seconds())
    
    <span class="hljs-comment">// æ›´æ–°æ‰§è¡Œç»“æœ</span>
    execution.EndTime = time.Now()
    execution.Output = output.String()
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
        execution.Status = <span class="hljs-string">&quot;failed&quot;</span>
        execution.Error = fmt.Sprintf(<span class="hljs-string">&quot;%v: %s&quot;</span>, err, stderr.String())
        e.metrics.TaskExecutionFailures.Inc()
        
        <span class="hljs-comment">// å¤„ç†é‡è¯•é€»è¾‘</span>
        <span class="hljs-keyword">if</span> execution.RetryCount &lt; task.RetryTimes &#123;
            execution.RetryCount++
            execution.Status = <span class="hljs-string">&quot;pending&quot;</span>
            
            <span class="hljs-comment">// å»¶è¿Ÿé‡è¯•</span>
            time.AfterFunc(time.Duration(task.RetryDelay)*time.Second, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
                e.executeTask(task, execution)
            &#125;)
            <span class="hljs-keyword">return</span>
        &#125;
    &#125; <span class="hljs-keyword">else</span> &#123;
        execution.Status = <span class="hljs-string">&quot;success&quot;</span>
        e.metrics.TaskExecutionSuccess.Inc()
    &#125;
    
    <span class="hljs-comment">// æ›´æ–°æ‰§è¡Œè®°å½•</span>
    e.taskClient.UpdateExecution(execution)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Executor)</span> <span class="hljs-title">heartbeat</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;
    ticker := time.NewTicker(<span class="hljs-number">5</span> * time.Second)
    <span class="hljs-keyword">defer</span> ticker.Stop()
    
    <span class="hljs-keyword">for</span> &#123;
        <span class="hljs-keyword">select</span> &#123;
        <span class="hljs-keyword">case</span> &lt;-ctx.Done():
            <span class="hljs-comment">// æ³¨é”€èŠ‚ç‚¹</span>
            e.registry.DeregisterNode(e.nodeID)
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">case</span> &lt;-ticker.C:
            <span class="hljs-comment">// å‘é€å¿ƒè·³</span>
            <span class="hljs-keyword">if</span> err := e.registry.Heartbeat(e.nodeID); err != <span class="hljs-literal">nil</span> &#123;
                e.logger.Error(<span class="hljs-string">&quot;Failed to send heartbeat&quot;</span>, zap.Error(err))
            &#125;
        &#125;
    &#125;
&#125;</code></pre>
<h4 id="åˆ†å¸ƒå¼åè°ƒä¸æœåŠ¡å‘ç°"><a class="header-anchor" href="#åˆ†å¸ƒå¼åè°ƒä¸æœåŠ¡å‘ç°"></a>åˆ†å¸ƒå¼åè°ƒä¸æœåŠ¡å‘ç°</h4>
<p>ä½¿ç”¨etcdå®ç°æœåŠ¡æ³¨å†Œå‘ç°å’Œåˆ†å¸ƒå¼åè°ƒï¼š</p>
<pre><code class="hljs go"><span class="hljs-keyword">type</span> EtcdRegistry <span class="hljs-keyword">struct</span> &#123;
    client *clientv3.Client
    ttl    <span class="hljs-keyword">int64</span>
    logger *zap.Logger
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewEtcdRegistry</span><span class="hljs-params">(endpoints []<span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*EtcdRegistry, error)</span></span> &#123;
    client, err := clientv3.New(clientv3.Config&#123;
        Endpoints:   endpoints,
        DialTimeout: <span class="hljs-number">5</span> * time.Second,
    &#125;)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    &#125;
    
    <span class="hljs-keyword">return</span> &amp;EtcdRegistry&#123;
        client: client,
        ttl:    <span class="hljs-number">30</span>, <span class="hljs-comment">// 30ç§’</span>
        logger: zap.NewProduction(),
    &#125;, <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *EtcdRegistry)</span> <span class="hljs-title">RegisterNode</span><span class="hljs-params">(node *Node)</span> <span class="hljs-title">error</span></span> &#123;
    <span class="hljs-comment">// åˆ›å»ºç§Ÿçº¦</span>
    lease, err := r.client.Grant(context.Background(), r.ttl)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
        <span class="hljs-keyword">return</span> err
    &#125;
    
    <span class="hljs-comment">// å°†èŠ‚ç‚¹ä¿¡æ¯åºåˆ—åŒ–</span>
    nodeData, err := json.Marshal(node)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
        <span class="hljs-keyword">return</span> err
    &#125;
    
    <span class="hljs-comment">// æ³¨å†ŒèŠ‚ç‚¹</span>
    key := fmt.Sprintf(<span class="hljs-string">&quot;/cronex/nodes/%s&quot;</span>, node.ID)
    _, err = r.client.Put(context.Background(), key, <span class="hljs-keyword">string</span>(nodeData), clientv3.WithLease(lease.ID))
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
        <span class="hljs-keyword">return</span> err
    &#125;
    
    <span class="hljs-comment">// ä¿æŒç§Ÿçº¦</span>
    ch, err := r.client.KeepAlive(context.Background(), lease.ID)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
        <span class="hljs-keyword">return</span> err
    &#125;
    
    <span class="hljs-comment">// æ¶ˆè´¹keepaliveé€šé“</span>
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> ch &#123;
            <span class="hljs-comment">// ä»…ç”¨äºæ¶ˆè´¹é€šé“ï¼Œé¿å…é€šé“æ»¡</span>
        &#125;
    &#125;()
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *EtcdRegistry)</span> <span class="hljs-title">GetAvailableNodes</span><span class="hljs-params">()</span> <span class="hljs-params">([]*Node, error)</span></span> &#123;
    resp, err := r.client.Get(context.Background(), <span class="hljs-string">&quot;/cronex/nodes/&quot;</span>, clientv3.WithPrefix())
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    &#125;
    
    nodes := <span class="hljs-built_in">make</span>([]*Node, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(resp.Kvs))
    <span class="hljs-keyword">for</span> _, kv := <span class="hljs-keyword">range</span> resp.Kvs &#123;
        <span class="hljs-keyword">var</span> node Node
        <span class="hljs-keyword">if</span> err := json.Unmarshal(kv.Value, &amp;node); err != <span class="hljs-literal">nil</span> &#123;
            r.logger.Error(<span class="hljs-string">&quot;Failed to unmarshal node data&quot;</span>, zap.Error(err))
            <span class="hljs-keyword">continue</span>
        &#125;
        
        <span class="hljs-keyword">if</span> node.Status == <span class="hljs-string">&quot;online&quot;</span> &#123;
            nodes = <span class="hljs-built_in">append</span>(nodes, &amp;node)
        &#125;
    &#125;
    
    <span class="hljs-keyword">return</span> nodes, <span class="hljs-literal">nil</span>
&#125;</code></pre>
<h3 id="ğŸ”-é«˜å¯ç”¨ä¸æ•…éšœè½¬ç§»"><a class="header-anchor" href="#ğŸ”-é«˜å¯ç”¨ä¸æ•…éšœè½¬ç§»"></a>ğŸ” é«˜å¯ç”¨ä¸æ•…éšœè½¬ç§»</h3>
<h4 id="Leaderé€‰ä¸¾"><a class="header-anchor" href="#Leaderé€‰ä¸¾"></a>Leaderé€‰ä¸¾</h4>
<p>åœ¨å¤šè°ƒåº¦å™¨åœºæ™¯ä¸‹ï¼Œéœ€è¦é€šè¿‡Leaderé€‰ä¸¾ç¡®ä¿æŸäº›æ“ä½œåªè¢«ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œï¼š</p>
<pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">leaderElection</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;
    session, err := concurrency.NewSession(s.registry.(*EtcdRegistry).client)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
        s.logger.Error(<span class="hljs-string">&quot;Failed to create etcd session&quot;</span>, zap.Error(err))
        <span class="hljs-keyword">return</span>
    &#125;
    <span class="hljs-keyword">defer</span> session.Close()
    
    election := concurrency.NewElection(session, <span class="hljs-string">&quot;/cronex/leader&quot;</span>)
    
    <span class="hljs-comment">// ç«é€‰Leader</span>
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
        <span class="hljs-keyword">if</span> err := election.Campaign(ctx, s.nodeID); err != <span class="hljs-literal">nil</span> &#123;
            s.logger.Error(<span class="hljs-string">&quot;Failed to campaign for leadership&quot;</span>, zap.Error(err))
            <span class="hljs-keyword">return</span>
        &#125;
        
        s.logger.Info(<span class="hljs-string">&quot;Became leader&quot;</span>)
        s.becameLeader()
    &#125;()
    
    <span class="hljs-comment">// ç›‘å¬Leaderå˜åŒ–</span>
    ch := election.Observe(ctx)
    <span class="hljs-keyword">for</span> resp := <span class="hljs-keyword">range</span> ch &#123;
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(resp.Kvs) &gt; <span class="hljs-number">0</span> &#123;
            leader := <span class="hljs-keyword">string</span>(resp.Kvs[<span class="hljs-number">0</span>].Value)
            s.logger.Info(<span class="hljs-string">&quot;Leader changed&quot;</span>, zap.String(<span class="hljs-string">&quot;leader&quot;</span>, leader))
            
            <span class="hljs-keyword">if</span> leader == s.nodeID &#123;
                s.isLeader = <span class="hljs-literal">true</span>
            &#125; <span class="hljs-keyword">else</span> &#123;
                s.isLeader = <span class="hljs-literal">false</span>
            &#125;
        &#125;
    &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">becameLeader</span><span class="hljs-params">()</span></span> &#123;
    <span class="hljs-comment">// åªåœ¨LeaderèŠ‚ç‚¹ä¸Šæ‰§è¡Œçš„ä»»åŠ¡</span>
    <span class="hljs-comment">// ä¾‹å¦‚ï¼šæ•…éšœæ£€æµ‹ä¸ä»»åŠ¡é‡æ–°åˆ†é…</span>
    <span class="hljs-keyword">go</span> s.detectFailedNodes()
    <span class="hljs-keyword">go</span> s.rebalanceTasks()
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">detectFailedNodes</span><span class="hljs-params">()</span></span> &#123;
    ticker := time.NewTicker(<span class="hljs-number">10</span> * time.Second)
    <span class="hljs-keyword">defer</span> ticker.Stop()
    
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> ticker.C &#123;
        <span class="hljs-keyword">if</span> !s.isLeader &#123;
            <span class="hljs-keyword">return</span>
        &#125;
        
        <span class="hljs-comment">// è·å–æ‰€æœ‰èŠ‚ç‚¹</span>
        nodes, err := s.registry.GetAllNodes()
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
            s.logger.Error(<span class="hljs-string">&quot;Failed to get all nodes&quot;</span>, zap.Error(err))
            <span class="hljs-keyword">continue</span>
        &#125;
        
        <span class="hljs-comment">// æ£€æµ‹ç¦»çº¿èŠ‚ç‚¹</span>
        <span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> nodes &#123;
            <span class="hljs-keyword">if</span> node.Status == <span class="hljs-string">&quot;offline&quot;</span> || time.Since(node.LastHeartbeat) &gt; <span class="hljs-number">30</span>*time.Second &#123;
                s.handleNodeFailure(node)
            &#125;
        &#125;
    &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">handleNodeFailure</span><span class="hljs-params">(node *Node)</span></span> &#123;
    <span class="hljs-comment">// å°†èŠ‚ç‚¹æ ‡è®°ä¸ºä¸‹çº¿</span>
    s.registry.UpdateNodeStatus(node.ID, <span class="hljs-string">&quot;offline&quot;</span>)
    
    <span class="hljs-comment">// è·å–è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ä»»åŠ¡</span>
    executions, err := s.store.GetRunningExecutionsByNodeID(node.ID)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
        s.logger.Error(<span class="hljs-string">&quot;Failed to get running executions&quot;</span>, zap.Error(err))
        <span class="hljs-keyword">return</span>
    &#125;
    
    <span class="hljs-comment">// é‡æ–°è°ƒåº¦å¤±è´¥èŠ‚ç‚¹ä¸Šçš„ä»»åŠ¡</span>
    <span class="hljs-keyword">for</span> _, execution := <span class="hljs-keyword">range</span> executions &#123;
        task, err := s.store.GetTask(execution.TaskID)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
            <span class="hljs-keyword">continue</span>
        &#125;
        
        <span class="hljs-comment">// å°†ä»»åŠ¡çŠ¶æ€æ›´æ–°ä¸ºå¤±è´¥</span>
        execution.Status = <span class="hljs-string">&quot;failed&quot;</span>
        execution.Error = <span class="hljs-string">&quot;Node failure&quot;</span>
        execution.EndTime = time.Now()
        s.store.UpdateExecution(execution)
        
        <span class="hljs-comment">// é‡æ–°å…¥é˜Ÿè¿›è¡Œè°ƒåº¦</span>
        s.taskQueue &lt;- task
    &#125;
    
    s.logger.Info(<span class="hljs-string">&quot;Completed handling node failure&quot;</span>, zap.String(<span class="hljs-string">&quot;nodeId&quot;</span>, node.ID))
&#125;</code></pre>
<h3 id="ğŸ“Š-å¯è§‚æµ‹æ€§ä¸ç›‘æ§"><a class="header-anchor" href="#ğŸ“Š-å¯è§‚æµ‹æ€§ä¸ç›‘æ§"></a>ğŸ“Š å¯è§‚æµ‹æ€§ä¸ç›‘æ§</h3>
<h4 id="ç›‘æ§æŒ‡æ ‡è®¾è®¡"><a class="header-anchor" href="#ç›‘æ§æŒ‡æ ‡è®¾è®¡"></a>ç›‘æ§æŒ‡æ ‡è®¾è®¡</h4>
<p>ä½¿ç”¨Prometheusç›‘æ§å…³é”®æŒ‡æ ‡ï¼š</p>
<pre><code class="hljs go"><span class="hljs-keyword">type</span> SchedulerMetrics <span class="hljs-keyword">struct</span> &#123;
    TaskScheduled   prometheus.Counter
    TaskDispatched  prometheus.Counter
    DispatchFailed  prometheus.Counter
    ActiveLeaders   prometheus.Gauge
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewSchedulerMetrics</span><span class="hljs-params">()</span> *<span class="hljs-title">SchedulerMetrics</span></span> &#123;
    m := &amp;SchedulerMetrics&#123;
        TaskScheduled: prometheus.NewCounter(prometheus.CounterOpts&#123;
            Name: <span class="hljs-string">&quot;cronex_tasks_scheduled_total&quot;</span>,
            Help: <span class="hljs-string">&quot;Total number of tasks scheduled&quot;</span>,
        &#125;),
        TaskDispatched: prometheus.NewCounter(prometheus.CounterOpts&#123;
            Name: <span class="hljs-string">&quot;cronex_tasks_dispatched_total&quot;</span>,
            Help: <span class="hljs-string">&quot;Total number of tasks dispatched to executors&quot;</span>,
        &#125;),
        DispatchFailed: prometheus.NewCounter(prometheus.CounterOpts&#123;
            Name: <span class="hljs-string">&quot;cronex_dispatch_failures_total&quot;</span>,
            Help: <span class="hljs-string">&quot;Total number of task dispatch failures&quot;</span>,
        &#125;),
        ActiveLeaders: prometheus.NewGauge(prometheus.GaugeOpts&#123;
            Name: <span class="hljs-string">&quot;cronex_active_leaders&quot;</span>,
            Help: <span class="hljs-string">&quot;Number of active leaders (should be 1 or 0)&quot;</span>,
        &#125;),
    &#125;
    
    <span class="hljs-comment">// æ³¨å†ŒæŒ‡æ ‡</span>
    prometheus.MustRegister(
        m.TaskScheduled,
        m.TaskDispatched,
        m.DispatchFailed,
        m.ActiveLeaders,
    )
    
    <span class="hljs-keyword">return</span> m
&#125;

<span class="hljs-keyword">type</span> ExecutorMetrics <span class="hljs-keyword">struct</span> &#123;
    ActiveTasks           prometheus.Gauge
    TaskExecutionTime     prometheus.Histogram
    TaskExecutionSuccess  prometheus.Counter
    TaskExecutionFailures prometheus.Counter
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewExecutorMetrics</span><span class="hljs-params">()</span> *<span class="hljs-title">ExecutorMetrics</span></span> &#123;
    m := &amp;ExecutorMetrics&#123;
        ActiveTasks: prometheus.NewGauge(prometheus.GaugeOpts&#123;
            Name: <span class="hljs-string">&quot;cronex_executor_active_tasks&quot;</span>,
            Help: <span class="hljs-string">&quot;Number of active tasks currently being executed&quot;</span>,
        &#125;),
        TaskExecutionTime: prometheus.NewHistogram(prometheus.HistogramOpts&#123;
            Name:    <span class="hljs-string">&quot;cronex_task_execution_time_seconds&quot;</span>,
            Help:    <span class="hljs-string">&quot;Distribution of task execution time in seconds&quot;</span>,
            Buckets: prometheus.DefBuckets,
        &#125;),
        TaskExecutionSuccess: prometheus.NewCounter(prometheus.CounterOpts&#123;
            Name: <span class="hljs-string">&quot;cronex_task_execution_success_total&quot;</span>,
            Help: <span class="hljs-string">&quot;Total number of successful task executions&quot;</span>,
        &#125;),
        TaskExecutionFailures: prometheus.NewCounter(prometheus.CounterOpts&#123;
            Name: <span class="hljs-string">&quot;cronex_task_execution_failures_total&quot;</span>,
            Help: <span class="hljs-string">&quot;Total number of failed task executions&quot;</span>,
        &#125;),
    &#125;
    
    <span class="hljs-comment">// æ³¨å†ŒæŒ‡æ ‡</span>
    prometheus.MustRegister(
        m.ActiveTasks,
        m.TaskExecutionTime,
        m.TaskExecutionSuccess,
        m.TaskExecutionFailures,
    )
    
    <span class="hljs-keyword">return</span> m
&#125;</code></pre>
<h3 id="ğŸ“-æ€§èƒ½ä¼˜åŒ–ä¸æ‰©å±•"><a class="header-anchor" href="#ğŸ“-æ€§èƒ½ä¼˜åŒ–ä¸æ‰©å±•"></a>ğŸ“ æ€§èƒ½ä¼˜åŒ–ä¸æ‰©å±•</h3>
<h4 id="æ‰¹é‡ä»»åŠ¡è°ƒåº¦"><a class="header-anchor" href="#æ‰¹é‡ä»»åŠ¡è°ƒåº¦"></a>æ‰¹é‡ä»»åŠ¡è°ƒåº¦</h4>
<p>å¯¹äºé«˜é¢‘å®šæ—¶ä»»åŠ¡ï¼Œå¯ä»¥é‡‡ç”¨æ‰¹é‡å¤„ç†æ–¹å¼æé«˜æ•ˆç‡ï¼š</p>
<pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">batchProcessTasks</span><span class="hljs-params">()</span></span> &#123;
    <span class="hljs-comment">// ä½¿ç”¨æ—¶é—´çª—å£æ”¶é›†ä»»åŠ¡</span>
    window := <span class="hljs-number">500</span> * time.Millisecond
    batchSize := <span class="hljs-number">1000</span>
    
    <span class="hljs-keyword">var</span> tasks []*Task
    timer := time.NewTimer(window)
    
    <span class="hljs-keyword">for</span> &#123;
        <span class="hljs-keyword">select</span> &#123;
        <span class="hljs-keyword">case</span> task := &lt;-s.taskQueue:
            tasks = <span class="hljs-built_in">append</span>(tasks, task)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tasks) &gt;= batchSize &#123;
                s.processBatch(tasks)
                tasks = tasks[:<span class="hljs-number">0</span>] <span class="hljs-comment">// æ¸…ç©º</span>
                timer.Reset(window)
            &#125;
        <span class="hljs-keyword">case</span> &lt;-timer.C:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tasks) &gt; <span class="hljs-number">0</span> &#123;
                s.processBatch(tasks)
                tasks = tasks[:<span class="hljs-number">0</span>] <span class="hljs-comment">// æ¸…ç©º</span>
            &#125;
            timer.Reset(window)
        &#125;
    &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">processBatch</span><span class="hljs-params">(tasks []*Task)</span></span> &#123;
    <span class="hljs-comment">// æŒ‰æ‰§è¡ŒèŠ‚ç‚¹åˆ†ç»„</span>
    nodeGroups := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>][]*Task)
    <span class="hljs-keyword">for</span> _, task := <span class="hljs-keyword">range</span> tasks &#123;
        node, err := s.allocateExecutionNode(task)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
            s.logger.Error(<span class="hljs-string">&quot;Failed to allocate node for task&quot;</span>, zap.Error(err))
            <span class="hljs-keyword">continue</span>
        &#125;
        
        nodeGroups[node.ID] = <span class="hljs-built_in">append</span>(nodeGroups[node.ID], task)
    &#125;
    
    <span class="hljs-comment">// å¹¶è¡Œåˆ†å‘ä»»åŠ¡åˆ°å„èŠ‚ç‚¹</span>
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    <span class="hljs-keyword">for</span> nodeID, nodeTasks := <span class="hljs-keyword">range</span> nodeGroups &#123;
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(nodeID <span class="hljs-keyword">string</span>, tasks []*Task)</span></span> &#123;
            <span class="hljs-keyword">defer</span> wg.Done()
            s.batchDispatchToNode(nodeID, tasks)
        &#125;(nodeID, nodeTasks)
    &#125;
    wg.Wait()
&#125;</code></pre>
<h4 id="å¤šçº§ä»»åŠ¡é˜Ÿåˆ—"><a class="header-anchor" href="#å¤šçº§ä»»åŠ¡é˜Ÿåˆ—"></a>å¤šçº§ä»»åŠ¡é˜Ÿåˆ—</h4>
<p>ä¸ºä»»åŠ¡è®¾ç½®ä¼˜å…ˆçº§ï¼Œç¡®ä¿é‡è¦ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œï¼š</p>
<pre><code class="hljs go"><span class="hljs-keyword">type</span> PriorityQueue <span class="hljs-keyword">struct</span> &#123;
    highPriority    <span class="hljs-keyword">chan</span> *Task
    normalPriority  <span class="hljs-keyword">chan</span> *Task
    lowPriority     <span class="hljs-keyword">chan</span> *Task
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPriorityQueue</span><span class="hljs-params">()</span> *<span class="hljs-title">PriorityQueue</span></span> &#123;
    <span class="hljs-keyword">return</span> &amp;PriorityQueue&#123;
        highPriority:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Task, <span class="hljs-number">1000</span>),
        normalPriority: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Task, <span class="hljs-number">5000</span>),
        lowPriority:    <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Task, <span class="hljs-number">10000</span>),
    &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *PriorityQueue)</span> <span class="hljs-title">Push</span><span class="hljs-params">(task *Task, priority <span class="hljs-keyword">string</span>)</span></span> &#123;
    <span class="hljs-keyword">switch</span> priority &#123;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;high&quot;</span>:
        q.highPriority &lt;- task
    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;low&quot;</span>:
        q.lowPriority &lt;- task
    <span class="hljs-keyword">default</span>:
        q.normalPriority &lt;- task
    &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *PriorityQueue)</span> <span class="hljs-title">Pop</span><span class="hljs-params">()</span> *<span class="hljs-title">Task</span></span> &#123;
    <span class="hljs-comment">// ä¼˜å…ˆä»é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—å–ä»»åŠ¡</span>
    <span class="hljs-keyword">select</span> &#123;
    <span class="hljs-keyword">case</span> task := &lt;-q.highPriority:
        <span class="hljs-keyword">return</span> task
    <span class="hljs-keyword">default</span>:
    &#125;
    
    <span class="hljs-comment">// å…¶æ¬¡ä»æ™®é€šä¼˜å…ˆçº§é˜Ÿåˆ—å–ä»»åŠ¡</span>
    <span class="hljs-keyword">select</span> &#123;
    <span class="hljs-keyword">case</span> task := &lt;-q.normalPriority:
        <span class="hljs-keyword">return</span> task
    <span class="hljs-keyword">default</span>:
    &#125;
    
    <span class="hljs-comment">// æœ€åä»ä½ä¼˜å…ˆçº§é˜Ÿåˆ—å–ä»»åŠ¡</span>
    <span class="hljs-keyword">select</span> &#123;
    <span class="hljs-keyword">case</span> task := &lt;-q.lowPriority:
        <span class="hljs-keyword">return</span> task
    <span class="hljs-keyword">default</span>:
    &#125;
    
    <span class="hljs-comment">// æ‰€æœ‰é˜Ÿåˆ—éƒ½ç©ºï¼Œé˜»å¡ç­‰å¾…ä»»åŠ¡</span>
    <span class="hljs-keyword">select</span> &#123;
    <span class="hljs-keyword">case</span> task := &lt;-q.highPriority:
        <span class="hljs-keyword">return</span> task
    <span class="hljs-keyword">case</span> task := &lt;-q.normalPriority:
        <span class="hljs-keyword">return</span> task
    <span class="hljs-keyword">case</span> task := &lt;-q.lowPriority:
        <span class="hljs-keyword">return</span> task
    &#125;
&#125;</code></pre>
<h3 id="ğŸ“‹-æ€»ç»“ä¸æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸ“‹-æ€»ç»“ä¸æœ€ä½³å®è·µ"></a>ğŸ“‹ æ€»ç»“ä¸æœ€ä½³å®è·µ</h3>
<p>é€šè¿‡æœ¬æ–‡çš„å®ç°ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹çš„åˆ†å¸ƒå¼ä»»åŠ¡ç³»ç»Ÿï¼š</p>
<ol>
<li><strong>é«˜å¯ç”¨</strong>ï¼šå¤šè°ƒåº¦å™¨è®¾è®¡ï¼ŒLeaderé€‰ä¸¾æœºåˆ¶</li>
<li><strong>æ°´å¹³æ‰©å±•</strong>ï¼šåŠ¨æ€èŠ‚ç‚¹å‘ç°ï¼Œä»»åŠ¡å‡è¡¡åˆ†é…</li>
<li><strong>ä»»åŠ¡ç²¾ç¡®æ€§</strong>ï¼šåˆ†å¸ƒå¼é”é˜²æ­¢ä»»åŠ¡é‡å¤æ‰§è¡Œ</li>
<li><strong>æ•…éšœæ¢å¤</strong>ï¼šèŠ‚ç‚¹æ•…éšœè‡ªåŠ¨æ£€æµ‹ä¸ä»»åŠ¡é‡æ–°åˆ†é…</li>
<li><strong>å¯è§‚æµ‹æ€§</strong>ï¼šå®Œå–„çš„ç›‘æ§æŒ‡æ ‡å’Œæ—¥å¿—ç³»ç»Ÿ</li>
</ol>
<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜åº”æ³¨æ„ä»¥ä¸‹æœ€ä½³å®è·µï¼š</p>
<ul>
<li><strong>ä»»åŠ¡å¹‚ç­‰æ€§</strong>ï¼šè®¾è®¡ä»»åŠ¡æ—¶ç¡®ä¿å¤šæ¬¡æ‰§è¡Œäº§ç”Ÿç›¸åŒç»“æœ</li>
<li><strong>éš”ç¦»ç¯å¢ƒ</strong>ï¼šä¸ºä»»åŠ¡æä¾›éš”ç¦»çš„æ‰§è¡Œç¯å¢ƒï¼Œé˜²æ­¢ç›¸äº’å½±å“</li>
<li><strong>èµ„æºé™åˆ¶</strong>ï¼šå¯¹ä»»åŠ¡ä½¿ç”¨çš„CPUã€å†…å­˜ç­‰èµ„æºè¿›è¡Œé™åˆ¶</li>
<li><strong>ç°åº¦å‘å¸ƒ</strong>ï¼šæ–°ä»»åŠ¡å…ˆåœ¨å°‘é‡èŠ‚ç‚¹ä¸Šè¿è¡Œï¼ŒéªŒè¯æ— è¯¯åå†å…¨é¢éƒ¨ç½²</li>
<li><strong>å®‰å…¨æ€§</strong>ï¼šå®ç°è®¿é—®æ§åˆ¶å’Œæ•æ„Ÿæ•°æ®åŠ å¯†</li>
</ul>
<p>åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿæ˜¯ç°ä»£å¾®æœåŠ¡æ¶æ„ä¸­ä¸å¯æˆ–ç¼ºçš„åŸºç¡€ç»„ä»¶ã€‚é€šè¿‡Goè¯­è¨€çš„å¹¶å‘ä¼˜åŠ¿å’Œä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºå‡ºé«˜æ€§èƒ½ã€å¯é çš„è§£å†³æ–¹æ¡ˆï¼Œä¸ºå„ç§åœºæ™¯æä¾›ç¨³å®šçš„è°ƒåº¦æœåŠ¡ã€‚</p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Golang/">Golang</a>
                    
                      <a class="hover-with-bg" href="/categories/Golang/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">åˆ†å¸ƒå¼ç³»ç»Ÿ</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/golang/">golang</a>
                    
                      <a class="hover-with-bg" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">åˆ†å¸ƒå¼ç³»ç»Ÿ</a>
                    
                      <a class="hover-with-bg" href="/tags/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/">å®šæ—¶ä»»åŠ¡</a>
                    
                      <a class="hover-with-bg" href="/tags/%E9%AB%98%E6%80%A7%E8%83%BD/">é«˜æ€§èƒ½</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2024/09/12/%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BDGo%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3-%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E8%B7%B5/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">æ„å»ºé«˜æ€§èƒ½Goå¾®æœåŠ¡ç½‘å…³-è®¾è®¡ä¸å®è·µ</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2024/08/27/goroutine-%E5%8D%8F%E7%A8%8B%E6%B1%A0/">
                        <span class="hidden-mobile">goroutine åç¨‹æ± </span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
              <!-- Comments -->
              <div class="comments" id="comments">
                
                
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      function loadDisqus() {
        var disqus_config = function () {
          this.page.url = 'https://blog.bopop.sbs/2024/09/05/Goå®ç°é«˜æ€§èƒ½åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ/';
          this.page.identifier = '/2024/09/05/Goå®ç°é«˜æ€§èƒ½åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ/';
        };
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = '//' + '' + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', new Date());
          (d.head || d.body).appendChild(s);
        })();
      }
      createObserver(loadDisqus, 'disqus_thread');
    </script>
    <noscript>Please enable JavaScript to view the
      <a target="_blank" href="https://disqus.com/?ref_noscript" rel="nofollow noopener noopener">comments powered by Disqus.</a>
    </noscript>
  </div>


              </div>
            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  
    <div class="col-lg-7 mx-auto nopadding-md">
      <div class="container custom mx-auto">
        <img src="/img/Bopop-logo.png" srcset="/img/loading.gif" class="rounded mx-auto d-block mt-5" style="width:220px; height:150px;">
      </div>
    </div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <!-- <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a> -->
        <span>Â© Bopop</span>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>





  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
