<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>æ„å»ºé«˜æ€§èƒ½ç‰©è”ç½‘æ¡†æ¶-ä»æ¶æ„åˆ°å®è·µ</title>
    <link href="/2025/04/15/%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E7%89%A9%E8%81%94%E7%BD%91%E6%A1%86%E6%9E%B6-%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%B0%E5%AE%9E%E8%B7%B5/"/>
    <url>/2025/04/15/%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E7%89%A9%E8%81%94%E7%BD%91%E6%A1%86%E6%9E%B6-%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%B0%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ—ï¸-æ„å»ºé«˜æ€§èƒ½ç‰©è”ç½‘æ¡†æ¶-ä»æ¶æ„åˆ°å®è·µ"><a class="header-anchor" href="#ğŸ—ï¸-æ„å»ºé«˜æ€§èƒ½ç‰©è”ç½‘æ¡†æ¶-ä»æ¶æ„åˆ°å®è·µ"></a>ğŸ—ï¸ æ„å»ºé«˜æ€§èƒ½ç‰©è”ç½‘æ¡†æ¶-ä»æ¶æ„åˆ°å®è·µ</h2><p>éšç€ç‰©è”ç½‘è®¾å¤‡åœ¨å·¥ä¸šã€å†œä¸šã€æ™ºæ…§åŸå¸‚ç­‰é¢†åŸŸçš„å¹¿æ³›åº”ç”¨ï¼Œæ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€å¯æ‰©å±•çš„ç‰©è”ç½‘å¹³å°æˆä¸ºä¼—å¤šä¼ä¸šçš„éœ€æ±‚ã€‚æœ¬æ–‡å°†åˆ†äº«å¦‚ä½•åŸºäº Go è¯­è¨€å’Œå¾®æœåŠ¡æ¶æ„ï¼Œæ„å»ºä¸€ä¸ªç°ä»£åŒ–çš„ç‰©è”ç½‘å¹³å°ï¼Œå®ç°å¯¹å¤šç§è®¾å¤‡åè®®çš„ç»Ÿä¸€ç®¡ç†ã€‚</p><h3 id="ğŸ“Š-ç‰©è”ç½‘å¹³å°æ•´ä½“æ¶æ„"><a class="header-anchor" href="#ğŸ“Š-ç‰©è”ç½‘å¹³å°æ•´ä½“æ¶æ„"></a>ğŸ“Š ç‰©è”ç½‘å¹³å°æ•´ä½“æ¶æ„</h3><h4 id="æ¶æ„æ€»è§ˆ"><a class="header-anchor" href="#æ¶æ„æ€»è§ˆ"></a>æ¶æ„æ€»è§ˆ</h4><p>ç‰©è”ç½‘å¹³å°éœ€è¦å¤„ç†å¤§é‡è®¾å¤‡è¿æ¥ã€æ•°æ®é‡‡é›†ã€å¤„ç†å’Œå­˜å‚¨ç­‰å¤æ‚é—®é¢˜ã€‚ä¸€ä¸ªè‰¯å¥½è®¾è®¡çš„æ¶æ„å¯ä»¥ä¸ºåç»­å¼€å‘å’Œæ‰©å±•å¥ å®šåŸºç¡€ã€‚</p><pre><code class="hljs mermaid">graph TB    subgraph &quot;ç‰©è”ç½‘å¹³å°æ¶æ„&quot;        subgraph &quot;è®¾å¤‡æ¥å…¥å±‚&quot;            DEV1[&quot;è®¾å¤‡ 1&quot;]            DEV2[&quot;è®¾å¤‡ 2&quot;]            DEV3[&quot;è®¾å¤‡ 3&quot;]            ADAPTER1[&quot;Modbusé€‚é…å™¨&quot;]            ADAPTER2[&quot;MQTTé€‚é…å™¨&quot;]            ADAPTER3[&quot;OPC UAé€‚é…å™¨&quot;]        end                subgraph &quot;åè®®æ’ä»¶å±‚&quot;            PLUGIN1[&quot;Modbusæ’ä»¶&quot;]            PLUGIN2[&quot;MQTTæ’ä»¶&quot;]            PLUGIN3[&quot;OPC UAæ’ä»¶&quot;]        end                subgraph &quot;æ ¸å¿ƒæœåŠ¡å±‚&quot;            DEV_SVC[&quot;è®¾å¤‡æœåŠ¡&quot;]            DATA_SVC[&quot;æ•°æ®æœåŠ¡&quot;]            RULE_SVC[&quot;è§„åˆ™å¼•æ“æœåŠ¡&quot;]            ALARM_SVC[&quot;å‘Šè­¦æœåŠ¡&quot;]        end                subgraph &quot;åº”ç”¨å±‚&quot;            WEB[&quot;Webåº”ç”¨&quot;]            APP[&quot;ç§»åŠ¨åº”ç”¨&quot;]            API[&quot;å¼€æ”¾API&quot;]        end                subgraph &quot;åŸºç¡€è®¾æ–½å±‚&quot;            DB[&quot;æ•°æ®åº“&quot;]            MQ[&quot;æ¶ˆæ¯é˜Ÿåˆ—&quot;]            REDIS[&quot;ç¼“å­˜&quot;]            ETL[&quot;æ•°æ®å¤„ç†&quot;]        end    end        DEV1 --&gt; ADAPTER1    DEV2 --&gt; ADAPTER2    DEV3 --&gt; ADAPTER3        ADAPTER1 --&gt; PLUGIN1    ADAPTER2 --&gt; PLUGIN2    ADAPTER3 --&gt; PLUGIN3        PLUGIN1 --&gt; DEV_SVC    PLUGIN2 --&gt; DEV_SVC    PLUGIN3 --&gt; DEV_SVC        DEV_SVC --&gt; DATA_SVC    DEV_SVC --&gt; RULE_SVC    RULE_SVC --&gt; ALARM_SVC        DATA_SVC --&gt; DB    DATA_SVC --&gt; MQ    DATA_SVC --&gt; REDIS    DATA_SVC --&gt; ETL        WEB --&gt; API    APP --&gt; API    API --&gt; DEV_SVC    API --&gt; DATA_SVC    API --&gt; RULE_SVC    API --&gt; ALARM_SVC</code></pre><h4 id="æ ¸å¿ƒæ¨¡å—è¯´æ˜"><a class="header-anchor" href="#æ ¸å¿ƒæ¨¡å—è¯´æ˜"></a>æ ¸å¿ƒæ¨¡å—è¯´æ˜</h4><table><thead><tr><th>æ¨¡å—</th><th>åŠŸèƒ½æè¿°</th><th>æŠ€æœ¯é€‰å‹</th></tr></thead><tbody><tr><td>è®¾å¤‡æ¥å…¥å±‚</td><td>è´Ÿè´£ä¸å„ç§ç‰©è”ç½‘è®¾å¤‡ç›´æ¥é€šä¿¡ï¼Œæ”¯æŒå¤šç§åè®®</td><td>å®šåˆ¶åè®®é€‚é…å™¨</td></tr><tr><td>åè®®æ’ä»¶å±‚</td><td>å°†å„ç§åè®®è½¬æ¢ä¸ºå¹³å°ç»Ÿä¸€æ ¼å¼</td><td>æ’ä»¶åŒ–è®¾è®¡</td></tr><tr><td>æ ¸å¿ƒæœåŠ¡å±‚</td><td>å®ç°è®¾å¤‡ç®¡ç†ã€æ•°æ®å¤„ç†ã€è§„åˆ™å¼•æ“ç­‰æ ¸å¿ƒåŠŸèƒ½</td><td>go-zero å¾®æœåŠ¡æ¡†æ¶</td></tr><tr><td>åº”ç”¨å±‚</td><td>æä¾› Web/ç§»åŠ¨ç«¯ç•Œé¢å’Œå¼€æ”¾ API</td><td>RESTful API + gRPC</td></tr><tr><td>åŸºç¡€è®¾æ–½å±‚</td><td>æä¾›æ•°æ®å­˜å‚¨ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰åŸºç¡€æœåŠ¡</td><td>TimescaleDB, Kafka, Redis</td></tr></tbody></table><h3 id="ğŸ”Œ-åŸºäº-go-zero-çš„å¾®æœåŠ¡æ¶æ„è®¾è®¡"><a class="header-anchor" href="#ğŸ”Œ-åŸºäº-go-zero-çš„å¾®æœåŠ¡æ¶æ„è®¾è®¡"></a>ğŸ”Œ åŸºäº go-zero çš„å¾®æœåŠ¡æ¶æ„è®¾è®¡</h3><h4 id="go-zero-å¾®æœåŠ¡æ¡†æ¶ä¼˜åŠ¿"><a class="header-anchor" href="#go-zero-å¾®æœåŠ¡æ¡†æ¶ä¼˜åŠ¿"></a>go-zero å¾®æœåŠ¡æ¡†æ¶ä¼˜åŠ¿</h4><p>go-zero æ˜¯å­—èŠ‚è·³åŠ¨å¼€æºçš„ Go è¯­è¨€å¾®æœåŠ¡æ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>å†…ç½®æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡å’Œç†”æ–­</li><li>æœåŠ¡æ²»ç†ã€ç›‘æ§å’Œè¿½è¸ª</li><li>å¼ºå¤§çš„ä»£ç ç”Ÿæˆèƒ½åŠ›</li><li>å†…ç½®ç¼“å­˜å’Œæ•°æ®åº“è®¿é—®å±‚</li><li>é«˜æ€§èƒ½ï¼Œç»è¿‡å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒéªŒè¯</li></ul><h4 id="å¾®æœåŠ¡åˆ’åˆ†"><a class="header-anchor" href="#å¾®æœåŠ¡åˆ’åˆ†"></a>å¾®æœåŠ¡åˆ’åˆ†</h4><p>æˆ‘ä»¬å°†ç‰©è”ç½‘å¹³å°åˆ’åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒå¾®æœåŠ¡ï¼š</p><ol><li><strong>è®¾å¤‡æœåŠ¡ (Device Service)</strong>ï¼šè´Ÿè´£è®¾å¤‡æ¥å…¥ã€ç®¡ç†å’Œå‘½ä»¤ä¸‹å‘</li><li><strong>æ•°æ®æœåŠ¡ (Data Service)</strong>ï¼šå¤„ç†æ—¶åºæ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢</li><li><strong>è§„åˆ™å¼•æ“æœåŠ¡ (Rule Service)</strong>ï¼šæ‰§è¡Œæ•°æ®å¤„ç†è§„åˆ™å’Œè§¦å‘åŠ¨ä½œ</li><li><strong>å‘Šè­¦æœåŠ¡ (Alarm Service)</strong>ï¼šå¤„ç†ç³»ç»Ÿå‘Šè­¦å’Œé€šçŸ¥</li><li><strong>ç”¨æˆ·æœåŠ¡ (User Service)</strong>ï¼šç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†</li><li><strong>API ç½‘å…³ (API Gateway)</strong>ï¼šç»Ÿä¸€å…¥å£å’Œè¯·æ±‚è·¯ç”±</li></ol><h4 id="æ•°æ®æµç¨‹"><a class="header-anchor" href="#æ•°æ®æµç¨‹"></a>æ•°æ®æµç¨‹</h4><p>ä¸‹é¢æ˜¯è®¾å¤‡æ•°æ®ä»æ¥å…¥åˆ°å¤„ç†çš„å®Œæ•´æµç¨‹ï¼š</p><pre><code class="hljs mermaid">sequenceDiagram    participant Device as &quot;ç‰©è”ç½‘è®¾å¤‡&quot;    participant Adapter as &quot;åè®®é€‚é…å™¨&quot;    participant Plugin as &quot;åè®®æ’ä»¶&quot;    participant DeviceSvc as &quot;è®¾å¤‡æœåŠ¡&quot;    participant DataSvc as &quot;æ•°æ®æœåŠ¡&quot;    participant RuleSvc as &quot;è§„åˆ™å¼•æ“æœåŠ¡&quot;    participant DB as &quot;æ—¶åºæ•°æ®åº“&quot;    participant MQ as &quot;æ¶ˆæ¯é˜Ÿåˆ—&quot;    participant App as &quot;åº”ç”¨å±‚&quot;        Device-&gt;&gt;Adapter: å‘é€é¥æµ‹æ•°æ®    Adapter-&gt;&gt;Plugin: è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼    Plugin-&gt;&gt;DeviceSvc: æ³¨å†Œ&#x2F;è®¤è¯è®¾å¤‡    Plugin-&gt;&gt;DeviceSvc: æäº¤æ•°æ®    DeviceSvc-&gt;&gt;DataSvc: å­˜å‚¨é¥æµ‹æ•°æ®    DeviceSvc-&gt;&gt;MQ: å‘å¸ƒæ•°æ®å˜æ›´äº‹ä»¶    DataSvc-&gt;&gt;DB: æŒä¹…åŒ–æ•°æ®    MQ-&gt;&gt;RuleSvc: è§¦å‘è§„åˆ™å¼•æ“    RuleSvc-&gt;&gt;DeviceSvc: æ‰§è¡Œæ§åˆ¶å‘½ä»¤(å¯é€‰)    DeviceSvc-&gt;&gt;Plugin: ä¸‹å‘æ§åˆ¶å‘½ä»¤    Plugin-&gt;&gt;Adapter: è½¬æ¢ä¸ºè®¾å¤‡åè®®    Adapter-&gt;&gt;Device: æ‰§è¡Œæ§åˆ¶å‘½ä»¤    App-&gt;&gt;DeviceSvc: æŸ¥è¯¢è®¾å¤‡çŠ¶æ€    DeviceSvc-&gt;&gt;App: è¿”å›å®æ—¶æ•°æ®</code></pre><h3 id="ğŸ”§-æ’ä»¶åŒ–è®¾è®¡ï¼šå®ç°å¤šåè®®æ”¯æŒ"><a class="header-anchor" href="#ğŸ”§-æ’ä»¶åŒ–è®¾è®¡ï¼šå®ç°å¤šåè®®æ”¯æŒ"></a>ğŸ”§ æ’ä»¶åŒ–è®¾è®¡ï¼šå®ç°å¤šåè®®æ”¯æŒ</h3><p>ç‰©è”ç½‘å¹³å°æœ€å¤§çš„æŒ‘æˆ˜ä¹‹ä¸€æ˜¯éœ€è¦æ”¯æŒå¤šç§åè®®ã€‚æˆ‘ä»¬é‡‡ç”¨æ’ä»¶åŒ–è®¾è®¡ï¼Œå®ç°äº†å¯¹ Modbusã€MQTTã€OPC UA ç­‰åè®®çš„ç»Ÿä¸€ç®¡ç†ã€‚</p><h4 id="åè®®é€‚é…å™¨æ¥å£è®¾è®¡"><a class="header-anchor" href="#åè®®é€‚é…å™¨æ¥å£è®¾è®¡"></a>åè®®é€‚é…å™¨æ¥å£è®¾è®¡</h4><pre><code class="hljs mermaid">classDiagram    class IProtocolAdapter &#123;        &lt;&lt;interface&gt;&gt;        +Connect()        +Disconnect()        +Read()        +Write()    &#125;        class ModbusAdapter &#123;        -config ModbusConfig        +Connect()        +Disconnect()        +Read()        +Write()    &#125;        class MQTTAdapter &#123;        -config MQTTConfig        -client MQTTClient        +Connect()        +Disconnect()        +Read()        +Publish()        +Subscribe()    &#125;        class OPCUAAdapter &#123;        -config OPCUAConfig        -client OPCUAClient        +Connect()        +Disconnect()        +Read()        +Write()        +Subscribe()    &#125;        class DeviceManager &#123;        -adapters map[string]IProtocolAdapter        -devices map[string]Device        +RegisterAdapter(name string, adapter IProtocolAdapter)        +ConnectDevice(deviceId string)        +DisconnectDevice(deviceId string)        +GetDeviceData(deviceId string)        +SendCommand(deviceId string, command Command)    &#125;        IProtocolAdapter &lt;|.. ModbusAdapter    IProtocolAdapter &lt;|.. MQTTAdapter    IProtocolAdapter &lt;|.. OPCUAAdapter    DeviceManager o-- IProtocolAdapter</code></pre><h4 id="åè®®é€‚é…å™¨å®ç°ç¤ºä¾‹"><a class="header-anchor" href="#åè®®é€‚é…å™¨å®ç°ç¤ºä¾‹"></a>åè®®é€‚é…å™¨å®ç°ç¤ºä¾‹</h4><p>ä»¥ä¸‹æ˜¯ Modbus åè®®é€‚é…å™¨çš„ç®€åŒ–å®ç°ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ModbusAdapter å®ç° IProtocolAdapter æ¥å£</span><span class="hljs-keyword">type</span> ModbusAdapter <span class="hljs-keyword">struct</span> &#123;    config     ModbusConfig    client     modbus.Client    deviceChan <span class="hljs-keyword">chan</span> DeviceData    ctx        context.Context    cancel     context.CancelFunc    logger     *zap.Logger&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewModbusAdapter</span><span class="hljs-params">(config ModbusConfig)</span> *<span class="hljs-title">ModbusAdapter</span></span> &#123;    ctx, cancel := context.WithCancel(context.Background())    <span class="hljs-keyword">return</span> &amp;ModbusAdapter&#123;        config:     config,        deviceChan: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> DeviceData, <span class="hljs-number">100</span>),        ctx:        ctx,        cancel:     cancel,        logger:     log.With(zap.String(<span class="hljs-string">&quot;adapter&quot;</span>, <span class="hljs-string">&quot;modbus&quot;</span>)),    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *ModbusAdapter)</span> <span class="hljs-title">Connect</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-comment">// æ ¹æ®é…ç½®åˆ›å»º Modbus å®¢æˆ·ç«¯</span>    handler := modbus.NewTCPClientHandler(fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, a.config.Host, a.config.Port))    handler.Timeout = time.Second * <span class="hljs-number">5</span>    <span class="hljs-keyword">if</span> err := handler.Connect(); err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> errors.Wrap(err, <span class="hljs-string">&quot;failed to connect modbus device&quot;</span>)    &#125;        a.client = modbus.NewClient(handler)    a.startPolling()    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *ModbusAdapter)</span> <span class="hljs-title">startPolling</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        ticker := time.NewTicker(time.Duration(a.config.PollInterval) * time.Millisecond)        <span class="hljs-keyword">defer</span> ticker.Stop()                <span class="hljs-keyword">for</span> &#123;            <span class="hljs-keyword">select</span> &#123;            <span class="hljs-keyword">case</span> &lt;-ticker.C:                <span class="hljs-keyword">for</span> _, point := <span class="hljs-keyword">range</span> a.config.Points &#123;                    value, err := a.readPoint(point)                    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;                        a.logger.Error(<span class="hljs-string">&quot;failed to read point&quot;</span>, zap.Error(err))                        <span class="hljs-keyword">continue</span>                    &#125;                                        a.deviceChan &lt;- DeviceData&#123;                        DeviceID:  a.config.DeviceID,                        Timestamp: time.Now(),                        Point:     point.Name,                        Value:     value,                    &#125;                &#125;            <span class="hljs-keyword">case</span> &lt;-a.ctx.Done():                <span class="hljs-keyword">return</span>            &#125;        &#125;    &#125;()&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *ModbusAdapter)</span> <span class="hljs-title">readPoint</span><span class="hljs-params">(point ModbusPoint)</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span></span> &#123;    <span class="hljs-keyword">var</span> result []<span class="hljs-keyword">byte</span>    <span class="hljs-keyword">var</span> err error        <span class="hljs-keyword">switch</span> point.FunctionCode &#123;    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-comment">// Read Coils</span>        result, err = a.client.ReadCoils(point.Address, point.Quantity)    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-comment">// Read Discrete Inputs</span>        result, err = a.client.ReadDiscreteInputs(point.Address, point.Quantity)    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-comment">// Read Holding Registers</span>        result, err = a.client.ReadHoldingRegisters(point.Address, point.Quantity)    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-comment">// Read Input Registers</span>        result, err = a.client.ReadInputRegisters(point.Address, point.Quantity)    <span class="hljs-keyword">default</span>:        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;unsupported function code&quot;</span>)    &#125;        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;        <span class="hljs-keyword">return</span> a.convertValue(result, point.DataType), <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// å…¶ä»–æ–¹æ³•å®ç°...</span></code></pre><h3 id="âš™ï¸-GORM-ä»£ç ç”Ÿæˆä¸å¼€å‘ææ•ˆå·¥å…·"><a class="header-anchor" href="#âš™ï¸-GORM-ä»£ç ç”Ÿæˆä¸å¼€å‘ææ•ˆå·¥å…·"></a>âš™ï¸ GORM ä»£ç ç”Ÿæˆä¸å¼€å‘ææ•ˆå·¥å…·</h3><h4 id="è‡ªå®šä¹‰-GORM-ä»£ç ç”Ÿæˆå™¨"><a class="header-anchor" href="#è‡ªå®šä¹‰-GORM-ä»£ç ç”Ÿæˆå™¨"></a>è‡ªå®šä¹‰ GORM ä»£ç ç”Ÿæˆå™¨</h4><p>ä¸ºæé«˜å¼€å‘æ•ˆç‡ï¼Œæˆ‘ä»¬å¼€å‘äº†è‡ªå®šä¹‰ GORM ä»£ç ç”Ÿæˆå·¥å…·ï¼Œæ”¯æŒä»æ•°æ®åº“æ¨¡å‹è‡ªåŠ¨ç”Ÿæˆ CRUD ä»£ç ã€‚</p><pre><code class="hljs go"><span class="hljs-comment">// ä»£ç ç”Ÿæˆå™¨ä¸»ä½“</span><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;fmt&quot;</span>    <span class="hljs-string">&quot;os&quot;</span>    <span class="hljs-string">&quot;path/filepath&quot;</span>    <span class="hljs-string">&quot;strings&quot;</span>    <span class="hljs-string">&quot;text/template&quot;</span>        <span class="hljs-string">&quot;gorm.io/driver/mysql&quot;</span>    <span class="hljs-string">&quot;gorm.io/gorm&quot;</span>)<span class="hljs-keyword">type</span> Table <span class="hljs-keyword">struct</span> &#123;    Name    <span class="hljs-keyword">string</span>    Comment <span class="hljs-keyword">string</span>    Columns []Column&#125;<span class="hljs-keyword">type</span> Column <span class="hljs-keyword">struct</span> &#123;    Name     <span class="hljs-keyword">string</span>    Type     <span class="hljs-keyword">string</span>    Comment  <span class="hljs-keyword">string</span>    Nullable <span class="hljs-keyword">bool</span>    Primary  <span class="hljs-keyword">bool</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    dsn := <span class="hljs-string">&quot;user:password@tcp(127.0.0.1:3306)/iot_platform?charset=utf8mb4&amp;parseTime=True&quot;</span>    db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;failed to connect database&quot;</span>)    &#125;        <span class="hljs-comment">// è·å–æ‰€æœ‰è¡¨ä¿¡æ¯</span>    <span class="hljs-keyword">var</span> tables []<span class="hljs-keyword">string</span>    db.Raw(<span class="hljs-string">&quot;SHOW TABLES&quot;</span>).Scan(&amp;tables)        <span class="hljs-keyword">for</span> _, tableName := <span class="hljs-keyword">range</span> tables &#123;        generateModelAndRepo(db, tableName)    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateModelAndRepo</span><span class="hljs-params">(db *gorm.DB, tableName <span class="hljs-keyword">string</span>)</span></span> &#123;    <span class="hljs-comment">// è·å–è¡¨ç»“æ„ä¿¡æ¯å¹¶ç”Ÿæˆä»£ç </span>    <span class="hljs-comment">// ...</span>&#125;</code></pre><p>ç”Ÿæˆçš„ä»£ç åŒ…å«ï¼š</p><ul><li>æ¨¡å‹å®šä¹‰</li><li>åŸºç¡€ CRUD æ“ä½œ</li><li>è‡ªå®šä¹‰æŸ¥è¯¢æ–¹æ³•</li><li>æœåŠ¡å±‚ä»£ç </li></ul><h4 id="Makefile-å¼€å‘æµç¨‹ä¼˜åŒ–"><a class="header-anchor" href="#Makefile-å¼€å‘æµç¨‹ä¼˜åŒ–"></a>Makefile å¼€å‘æµç¨‹ä¼˜åŒ–</h4><p>åˆ›å»ºç®€æ˜“ Makefile ç»Ÿä¸€å¼€å‘æµç¨‹ï¼Œæé«˜å›¢é˜Ÿåä½œæ•ˆç‡ï¼š</p><pre><code class="hljs makefile"><span class="hljs-meta"><span class="hljs-meta-keyword">.PHONY</span>: all build run test clean docker</span><span class="hljs-comment"># åŸºæœ¬é…ç½®</span>APP=iot-platformVERSION=1.0.0<span class="hljs-section">all: build</span><span class="hljs-comment"># ç¼–è¯‘åº”ç”¨</span><span class="hljs-section">build:</span>@echo <span class="hljs-string">&quot;ç¼–è¯‘åº”ç”¨...&quot;</span>go build -o bin/<span class="hljs-variable">$(APP)</span> ./cmd/main.go<span class="hljs-comment"># è¿è¡Œåº”ç”¨</span><span class="hljs-section">run:</span>@echo <span class="hljs-string">&quot;å¯åŠ¨æœåŠ¡...&quot;</span>go run ./cmd/main.go<span class="hljs-comment"># è¿è¡Œæµ‹è¯•</span><span class="hljs-section">test:</span>@echo <span class="hljs-string">&quot;æ‰§è¡Œæµ‹è¯•...&quot;</span>go test ./...<span class="hljs-comment"># ç”Ÿæˆæ¨¡å‹ä»£ç </span><span class="hljs-section">model:</span>@echo <span class="hljs-string">&quot;ç”Ÿæˆæ•°æ®æ¨¡å‹...&quot;</span>go run ./tools/generator/main.go<span class="hljs-comment"># æ„å»ºDockeré•œåƒ</span><span class="hljs-section">docker:</span>@echo <span class="hljs-string">&quot;æ„å»ºDockeré•œåƒ...&quot;</span>docker build -t <span class="hljs-variable">$(APP)</span>:<span class="hljs-variable">$(VERSION)</span> .<span class="hljs-comment"># æ¸…ç†æ„å»ºäº§ç‰©</span><span class="hljs-section">clean:</span>@echo <span class="hljs-string">&quot;æ¸…ç†æ–‡ä»¶...&quot;</span>rm -rf bin/</code></pre><h4 id="Dockerfile-æœ€ä½³å®è·µ"><a class="header-anchor" href="#Dockerfile-æœ€ä½³å®è·µ"></a>Dockerfile æœ€ä½³å®è·µ</h4><p>é‡‡ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œå‡å°é•œåƒä½“ç§¯ï¼Œæé«˜å®‰å…¨æ€§ï¼š</p><pre><code class="hljs dockerfile"><span class="hljs-comment"># æ„å»ºé˜¶æ®µ</span><span class="hljs-keyword">FROM</span> golang:<span class="hljs-number">1.21</span>-alpine AS builder<span class="hljs-keyword">WORKDIR</span><span class="bash"> /app</span><span class="hljs-comment"># å®‰è£…æ„å»ºä¾èµ–</span><span class="hljs-keyword">RUN</span><span class="bash"> apk add --no-cache git make</span><span class="hljs-comment"># ä¼˜å…ˆå¤åˆ¶ go.mod æ–‡ä»¶ï¼Œåˆ©ç”¨ Docker ç¼“å­˜</span><span class="hljs-keyword">COPY</span><span class="bash"> go.mod go.sum ./</span><span class="hljs-keyword">RUN</span><span class="bash"> go mod download</span><span class="hljs-comment"># å¤åˆ¶æºä»£ç </span><span class="hljs-keyword">COPY</span><span class="bash"> . .</span><span class="hljs-comment"># æ„å»ºåº”ç”¨</span><span class="hljs-keyword">RUN</span><span class="bash"> make build</span><span class="hljs-comment"># è¿è¡Œé˜¶æ®µ</span><span class="hljs-keyword">FROM</span> alpine:<span class="hljs-number">3.19</span><span class="hljs-keyword">WORKDIR</span><span class="bash"> /app</span><span class="hljs-comment"># å®‰è£…è¿è¡Œæ—¶ä¾èµ–</span><span class="hljs-keyword">RUN</span><span class="bash"> apk add --no-cache ca-certificates tzdata</span><span class="hljs-comment"># è®¾ç½®æ—¶åŒº</span><span class="hljs-keyword">ENV</span> TZ=Asia/Shanghai<span class="hljs-comment"># ä»æ„å»ºé˜¶æ®µå¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶</span><span class="hljs-keyword">COPY</span><span class="bash"> --from=builder /app/build/iot-platform /app/iot-platform</span><span class="hljs-keyword">COPY</span><span class="bash"> --from=builder /app/configs /app/configs</span><span class="hljs-comment"># åˆ›å»ºé root ç”¨æˆ·</span><span class="hljs-keyword">RUN</span><span class="bash"> adduser -D -g <span class="hljs-string">&#x27;&#x27;</span> appuser</span><span class="hljs-keyword">USER</span> appuser<span class="hljs-comment"># æš´éœ²ç«¯å£</span><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8000</span> <span class="hljs-number">9000</span><span class="hljs-comment"># å¯åŠ¨å‘½ä»¤</span><span class="hljs-keyword">ENTRYPOINT</span><span class="bash"> [<span class="hljs-string">&quot;/app/iot-platform&quot;</span>]</span></code></pre><h3 id="ğŸ“-æ€»ç»“ä¸å±•æœ›"><a class="header-anchor" href="#ğŸ“-æ€»ç»“ä¸å±•æœ›"></a>ğŸ“ æ€»ç»“ä¸å±•æœ›</h3><p>æ„å»ºç°ä»£åŒ–ç‰©è”ç½‘å¹³å°éœ€è¦:</p><ol><li><strong>æ¶æ„è®¾è®¡</strong>ï¼šé‡‡ç”¨å¾®æœåŠ¡æ¶æ„æé«˜ç³»ç»Ÿå¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§</li><li><strong>åè®®æ”¯æŒ</strong>ï¼šé€šè¿‡æ’ä»¶åŒ–è®¾è®¡å®ç°å¯¹å¤šç§ç‰©è”ç½‘åè®®çš„çµæ´»æ”¯æŒ</li><li><strong>å¼€å‘æ•ˆç‡</strong>ï¼šåˆ©ç”¨ä»£ç ç”Ÿæˆã€Makefileã€Dockerfile ç­‰å·¥å…·æé«˜å¼€å‘æ•ˆç‡</li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šå¯¹è¿æ¥æ± ã€ç¼“å­˜ç­‰å…³é”®ç»„ä»¶è¿›è¡Œé’ˆå¯¹æ€§ä¼˜åŒ–</li></ol><p>æœªæ¥ï¼Œæˆ‘ä»¬è®¡åˆ’åœ¨ä»¥ä¸‹æ–¹é¢ç»§ç»­ä¼˜åŒ–ç‰©è”ç½‘å¹³å°ï¼š</p><ul><li>å¼•å…¥ EdgeX Foundry å®ç°è¾¹ç¼˜è®¡ç®—èƒ½åŠ›</li><li>é›†æˆæœºå™¨å­¦ä¹ æ¡†æ¶ï¼Œæä¾›è®¾å¤‡é¢„æµ‹æ€§ç»´æŠ¤åŠŸèƒ½</li><li>æ”¯æŒ LoRaWANã€Zigbee ç­‰ä½åŠŸè€—å¹¿åŸŸç½‘åè®®</li><li>å¢å¼ºåŸºäº Kubernetes çš„è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œå¼¹æ€§ä¼¸ç¼©èƒ½åŠ›</li></ul><p>é€šè¿‡åˆç†çš„æ¶æ„è®¾è®¡å’ŒæŠ€æœ¯é€‰å‹ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªé«˜æ€§èƒ½ã€å¯æ‰©å±•çš„ç‰©è”ç½‘å¹³å°ï¼ŒæˆåŠŸåº”ç”¨äºæ™ºæ…§å·¥å‚ã€æ™ºèƒ½å†œä¸šç­‰å¤šä¸ªé¢†åŸŸã€‚å¸Œæœ›æœ¬æ–‡çš„ç»éªŒåˆ†äº«èƒ½ä¸ºæ›´å¤šç‰©è”ç½‘å¼€å‘è€…æä¾›å‚è€ƒã€‚</p><p><strong>åŒæ ·çš„ï¼Œå†è¡¥å……ä¸€ç‚¹ææ•ˆåˆ©å™¨ - go-zeroå·¥å…·æ ˆ</strong>ğŸ˜œ</p><ul><li>goctlï¼šä»£ç ç”Ÿæˆå·¥å…·ï¼Œæå¤§æé«˜å¼€å‘é€Ÿåº¦</li><li>go-zero grpcï¼šåŸºäºprotoæ–‡ä»¶è‡ªåŠ¨ç”ŸæˆæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä»£ç </li><li>entï¼šå£°æ˜å¼ORMæ¡†æ¶ï¼Œç®€åŒ–æ•°æ®åº“æ“ä½œ</li><li>ddl2entï¼šå°†æ•°æ®åº“ç»“æ„ç›´æ¥è½¬æ¢ä¸ºent schema</li></ul>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
      <category>ç‰©è”ç½‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
      <tag>ç‰©è”ç½‘</tag>
      
      <tag>go-zero</tag>
      
      <tag>IoT</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>âš¡ Goè¯­è¨€å¹¶å‘ç¼–ç¨‹æ¨¡å¼ä¸æ€§èƒ½è°ƒä¼˜</title>
    <link href="/2025/03/24/Go%E8%AF%AD%E8%A8%80%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/"/>
    <url>/2025/03/24/Go%E8%AF%AD%E8%A8%80%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/</url>
    
    <content type="html"><![CDATA[<h1>âš¡ Goè¯­è¨€å¹¶å‘ç¼–ç¨‹æ¨¡å¼ä¸æ€§èƒ½è°ƒä¼˜</h1><p>Goè¯­è¨€å‡­å€Ÿå…¶ç®€æ´é«˜æ•ˆçš„å¹¶å‘æ¨¡å‹ï¼Œå·²æˆä¸ºæ„å»ºé«˜æ€§èƒ½æœåŠ¡çš„é¦–é€‰è¯­è¨€ä¹‹ä¸€ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Goçš„å¹¶å‘ç¼–ç¨‹æ¨¡å¼å’Œæ€§èƒ½è°ƒä¼˜æŠ€å·§ï¼Œç»“åˆæˆ‘åœ¨å®é™…é¡¹ç›®ä¸­çš„ç»éªŒï¼Œå¸®åŠ©ä½ ç¼–å†™æ›´é«˜æ•ˆçš„Goç¨‹åºã€‚</p><h2 id="ğŸ”„-Goå¹¶å‘æ¨¡å‹åŸºç¡€"><a class="header-anchor" href="#ğŸ”„-Goå¹¶å‘æ¨¡å‹åŸºç¡€"></a>ğŸ”„ Goå¹¶å‘æ¨¡å‹åŸºç¡€</h2><p>åœ¨æ·±å…¥å…·ä½“çš„å¹¶å‘æ¨¡å¼ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹Goå¹¶å‘çš„æ ¸å¿ƒæ¦‚å¿µï¼š</p><h3 id="goroutine-è½»é‡çº§çº¿ç¨‹"><a class="header-anchor" href="#goroutine-è½»é‡çº§çº¿ç¨‹"></a>goroutine: è½»é‡çº§çº¿ç¨‹</h3><p>goroutineæ˜¯Goè¯­è¨€çš„å¹¶å‘å•å…ƒï¼Œç”±Goè¿è¡Œæ—¶ç®¡ç†ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// å¯åŠ¨ä¸€ä¸ªgoroutine</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        fmt.Println(<span class="hljs-string">&quot;æˆ‘åœ¨ä¸€ä¸ªgoroutineä¸­è¿è¡Œ&quot;</span>)    &#125;()        <span class="hljs-comment">// ä¸»goroutineç»§ç»­æ‰§è¡Œ</span>    fmt.Println(<span class="hljs-string">&quot;æˆ‘åœ¨ä¸»goroutineä¸­è¿è¡Œ&quot;</span>)    time.Sleep(time.Second) <span class="hljs-comment">// ç¡®ä¿å­goroutineæœ‰æ—¶é—´æ‰§è¡Œ</span>&#125;</code></pre><p>ä¸ä¼ ç»Ÿçº¿ç¨‹ç›¸æ¯”ï¼Œgoroutineæœ‰å‡ ä¸ªæ˜¾è‘—ä¼˜åŠ¿ï¼š</p><table><thead><tr><th>ç‰¹æ€§</th><th>ä¼ ç»Ÿçº¿ç¨‹</th><th>goroutine</th></tr></thead><tbody><tr><td>åˆ›å»ºæˆæœ¬</td><td>~1MBæ ˆç©ºé—´</td><td>åˆå§‹2KBæ ˆç©ºé—´</td></tr><tr><td>è°ƒåº¦æ–¹å¼</td><td>å†…æ ¸çº§è°ƒåº¦</td><td>ç”¨æˆ·çº§è°ƒåº¦(GMPæ¨¡å‹)</td></tr><tr><td>åˆ›å»ºæ•°é‡</td><td>å—ç³»ç»Ÿé™åˆ¶(æ•°åƒ)</td><td>å¯åˆ›å»ºæ•°ç™¾ä¸‡</td></tr><tr><td>ä¸Šä¸‹æ–‡åˆ‡æ¢</td><td>ç›¸å¯¹æ˜‚è´µ</td><td>éå¸¸è½»é‡</td></tr><tr><td>é€šä¿¡æ–¹å¼</td><td>å…±äº«å†…å­˜</td><td>CSPæ¨¡å‹(é€šè¿‡channel)</td></tr></tbody></table><h3 id="channel-é€šä¿¡æœºåˆ¶"><a class="header-anchor" href="#channel-é€šä¿¡æœºåˆ¶"></a>channel: é€šä¿¡æœºåˆ¶</h3><p>channelæ˜¯goroutineä¹‹é—´é€šä¿¡çš„ç®¡é“ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ— ç¼“å†²channel</span>    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">string</span>)        <span class="hljs-comment">// å‘é€è€…goroutine</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        ch &lt;- <span class="hljs-string">&quot;Hello from goroutine!&quot;</span> <span class="hljs-comment">// å‘é€æ•°æ®</span>    &#125;()        <span class="hljs-comment">// æ¥æ”¶è€…(ä¸»goroutine)</span>    msg := &lt;-ch <span class="hljs-comment">// æ¥æ”¶æ•°æ®</span>    fmt.Println(msg)&#125;</code></pre><p>channelæœ‰ä¸¤ç§ä¸»è¦ç±»å‹ï¼š</p><ol><li><strong>æ— ç¼“å†²channel</strong>ï¼šå‘é€æ“ä½œä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ¥æ”¶è€…</li><li><strong>å¸¦ç¼“å†²channel</strong>ï¼šæœ‰å®¹é‡é™åˆ¶ï¼Œç¼“å†²åŒºæ»¡æ—¶å‘é€æ‰ä¼šé˜»å¡</li></ol><pre><code class="hljs go"><span class="hljs-comment">// å¸¦ç¼“å†²channel(å®¹é‡ä¸º3)</span>bufferedCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, <span class="hljs-number">3</span>)bufferedCh &lt;- <span class="hljs-number">1</span>  <span class="hljs-comment">// ä¸ä¼šé˜»å¡</span>bufferedCh &lt;- <span class="hljs-number">2</span>  <span class="hljs-comment">// ä¸ä¼šé˜»å¡</span>bufferedCh &lt;- <span class="hljs-number">3</span>  <span class="hljs-comment">// ä¸ä¼šé˜»å¡</span><span class="hljs-comment">// bufferedCh &lt;- 4  // ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰å€¼è¢«å–å‡º</span></code></pre><h2 id="ğŸ”¨-å¸¸ç”¨å¹¶å‘æ¨¡å¼"><a class="header-anchor" href="#ğŸ”¨-å¸¸ç”¨å¹¶å‘æ¨¡å¼"></a>ğŸ”¨ å¸¸ç”¨å¹¶å‘æ¨¡å¼</h2><h3 id="1-Worker-Pool-å·¥ä½œæ± æ¨¡å¼"><a class="header-anchor" href="#1-Worker-Pool-å·¥ä½œæ± æ¨¡å¼"></a>1. Worker Pool (å·¥ä½œæ± æ¨¡å¼)</h3><p>å·¥ä½œæ± æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­æœ€å¸¸ç”¨çš„æ¨¡å¼ä¹‹ä¸€ï¼Œç‰¹åˆ«é€‚åˆå¤„ç†å¤§é‡ç‹¬ç«‹ä»»åŠ¡ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WorkerPool</span><span class="hljs-params">(numWorkers <span class="hljs-keyword">int</span>, tasks []Task, timeout time.Duration)</span> []<span class="hljs-title">Result</span></span> &#123;    tasksCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Task, <span class="hljs-built_in">len</span>(tasks))    resultsCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result, <span class="hljs-built_in">len</span>(tasks))        <span class="hljs-comment">// å¯åŠ¨å·¥ä½œgoroutine</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; numWorkers; i++ &#123;        <span class="hljs-keyword">go</span> worker(tasksCh, resultsCh)    &#125;        <span class="hljs-comment">// å‘é€ä»»åŠ¡</span>    <span class="hljs-keyword">for</span> _, task := <span class="hljs-keyword">range</span> tasks &#123;        tasksCh &lt;- task    &#125;    <span class="hljs-built_in">close</span>(tasksCh) <span class="hljs-comment">// å…³é—­ä»»åŠ¡é€šé“ï¼Œè¡¨ç¤ºæ²¡æœ‰æ›´å¤šä»»åŠ¡</span>        <span class="hljs-comment">// æ”¶é›†ç»“æœ</span>    results := <span class="hljs-built_in">make</span>([]Result, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(tasks))    timeoutCh := time.After(timeout)        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(tasks); i++ &#123;        <span class="hljs-keyword">select</span> &#123;        <span class="hljs-keyword">case</span> result := &lt;-resultsCh:            results = <span class="hljs-built_in">append</span>(results, result)        <span class="hljs-keyword">case</span> &lt;-timeoutCh:            <span class="hljs-keyword">return</span> results <span class="hljs-comment">// è¶…æ—¶è¿”å›å·²æ”¶é›†çš„ç»“æœ</span>        &#125;    &#125;        <span class="hljs-keyword">return</span> results&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker</span><span class="hljs-params">(tasksCh &lt;-<span class="hljs-keyword">chan</span> Task, resultsCh <span class="hljs-keyword">chan</span>&lt;- Result)</span></span> &#123;    <span class="hljs-keyword">for</span> task := <span class="hljs-keyword">range</span> tasksCh &#123;        result := process(task)        resultsCh &lt;- result    &#125;&#125;</code></pre><p>å·¥ä½œæ± æ¨¡å¼çš„ä¼˜åŠ¿ï¼š</p><ul><li>æ§åˆ¶å¹¶å‘åº¦ï¼Œé¿å…èµ„æºè€—å°½</li><li>é‡ç”¨goroutineï¼Œå‡å°‘åˆ›å»º/é”€æ¯å¼€é”€</li><li>ä¾¿äºæ·»åŠ è¶…æ—¶æ§åˆ¶å’Œé”™è¯¯å¤„ç†</li></ul><h3 id="2-Pipeline-ç®¡é“æ¨¡å¼"><a class="header-anchor" href="#2-Pipeline-ç®¡é“æ¨¡å¼"></a>2. Pipeline (ç®¡é“æ¨¡å¼)</h3><p>ç®¡é“æ¨¡å¼å°†æ•°æ®å¤„ç†åˆ†è§£ä¸ºä¸€ç³»åˆ—é˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µç”±ä¸€ä¸ªæˆ–å¤šä¸ªgoroutineå¤„ç†ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generator</span><span class="hljs-params">(nums ...<span class="hljs-keyword">int</span>)</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(out)        <span class="hljs-keyword">for</span> _, n := <span class="hljs-keyword">range</span> nums &#123;            out &lt;- n        &#125;    &#125;()    <span class="hljs-keyword">return</span> out&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">square</span><span class="hljs-params">(in &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(out)        <span class="hljs-keyword">for</span> n := <span class="hljs-keyword">range</span> in &#123;            out &lt;- n * n        &#125;    &#125;()    <span class="hljs-keyword">return</span> out&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">filter</span><span class="hljs-params">(in &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, predicate <span class="hljs-keyword">func</span>(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span>) &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(out)        <span class="hljs-keyword">for</span> n := <span class="hljs-keyword">range</span> in &#123;            <span class="hljs-keyword">if</span> predicate(n) &#123;                out &lt;- n            &#125;        &#125;    &#125;()    <span class="hljs-keyword">return</span> out&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// æ„å»ºç®¡é“: ç”Ÿæˆæ•°å­— -&gt; å¹³æ–¹ -&gt; è¿‡æ»¤å¶æ•°</span>    c := generator(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)    c = square(c)    c = filter(c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123;        <span class="hljs-keyword">return</span> n%<span class="hljs-number">2</span> == <span class="hljs-number">0</span>    &#125;)        <span class="hljs-comment">// æ¶ˆè´¹ç»“æœ</span>    <span class="hljs-keyword">for</span> n := <span class="hljs-keyword">range</span> c &#123;        fmt.Println(n) <span class="hljs-comment">// è¾“å‡º: 4, 16</span>    &#125;&#125;</code></pre><p>ç®¡é“æ¨¡å¼é€‚åˆå¤„ç†æ•°æ®æµï¼Œæ¯ä¸ªé˜¶æ®µä¸“æ³¨äºä¸€ä¸ªè½¬æ¢ï¼Œä½¿ä»£ç æ›´æ¨¡å—åŒ–ã€å¯ç»´æŠ¤ã€‚</p><h3 id="3-Fan-Out-Fan-In-æ‰‡å‡ºæ‰‡å…¥æ¨¡å¼"><a class="header-anchor" href="#3-Fan-Out-Fan-In-æ‰‡å‡ºæ‰‡å…¥æ¨¡å¼"></a>3. Fan-Out, Fan-In (æ‰‡å‡ºæ‰‡å…¥æ¨¡å¼)</h3><p>å½“æŸä¸ªé˜¶æ®µè®¡ç®—å¯†é›†æˆ–IOå¯†é›†æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªgoroutineå¹¶è¡Œå¤„ç†ï¼Œç„¶ååˆå¹¶ç»“æœï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fanOut</span><span class="hljs-params">(in &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, workers <span class="hljs-keyword">int</span>)</span> []&lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    channels := <span class="hljs-built_in">make</span>([]&lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, workers)    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; workers; i++ &#123;        channels[i] = processChannel(in)    &#125;    <span class="hljs-keyword">return</span> channels&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fanIn</span><span class="hljs-params">(channels []&lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">var</span> wg sync.WaitGroup    wg.Add(<span class="hljs-built_in">len</span>(channels))        <span class="hljs-comment">// ä¸ºæ¯ä¸ªè¾“å…¥channelå¯åŠ¨ä¸€ä¸ªgoroutine</span>    <span class="hljs-keyword">for</span> _, ch := <span class="hljs-keyword">range</span> channels &#123;        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span></span> &#123;            <span class="hljs-keyword">defer</span> wg.Done()            <span class="hljs-keyword">for</span> n := <span class="hljs-keyword">range</span> c &#123;                out &lt;- n            &#125;        &#125;(ch)    &#125;        <span class="hljs-comment">// æ‰€æœ‰è¾“å…¥channelå…³é—­åå…³é—­è¾“å‡ºchannel</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        wg.Wait()        <span class="hljs-built_in">close</span>(out)    &#125;()        <span class="hljs-keyword">return</span> out&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processChannel</span><span class="hljs-params">(in &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(out)        <span class="hljs-keyword">for</span> n := <span class="hljs-keyword">range</span> in &#123;            <span class="hljs-comment">// å‡è®¾è¿™æ˜¯CPUå¯†é›†å‹æ“ä½œ</span>            result := complexCalculation(n)            out &lt;- result        &#125;    &#125;()    <span class="hljs-keyword">return</span> out&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    input := generator(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>)        <span class="hljs-comment">// æ‰‡å‡ºåˆ°4ä¸ªworker</span>    channels := fanOut(input, <span class="hljs-number">4</span>)        <span class="hljs-comment">// æ‰‡å…¥ç»“æœ</span>    merged := fanIn(channels)        <span class="hljs-comment">// ä½¿ç”¨ç»“æœ</span>    <span class="hljs-keyword">for</span> n := <span class="hljs-keyword">range</span> merged &#123;        fmt.Println(n)    &#125;&#125;</code></pre><p>æ‰‡å‡ºæ‰‡å…¥æ¨¡å¼ç‰¹åˆ«é€‚åˆéœ€è¦å¹¶è¡Œå¤„ç†çš„åœºæ™¯ï¼Œå¦‚å¹¶è¡ŒAPIè¯·æ±‚ã€å¹¶è¡Œæ–‡ä»¶å¤„ç†ç­‰ã€‚</p><h3 id="4-Timeout-Pattern-è¶…æ—¶æ¨¡å¼"><a class="header-anchor" href="#4-Timeout-Pattern-è¶…æ—¶æ¨¡å¼"></a>4. Timeout Pattern (è¶…æ—¶æ¨¡å¼)</h3><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œé¿å…æ— é™æœŸç­‰å¾…æ˜¯å¾ˆé‡è¦çš„ã€‚Goçš„<code>select</code>è¯­å¥ä½¿æ·»åŠ è¶…æ—¶å˜å¾—ç®€å•ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fetchDataWithTimeout</span><span class="hljs-params">(url <span class="hljs-keyword">string</span>, timeout time.Duration)</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, error)</span></span> &#123;    responseCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> []<span class="hljs-keyword">byte</span>)    errorCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> error)        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-comment">// å‘èµ·HTTPè¯·æ±‚</span>        resp, err := http.Get(url)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            errorCh &lt;- err            <span class="hljs-keyword">return</span>        &#125;        <span class="hljs-keyword">defer</span> resp.Body.Close()                <span class="hljs-comment">// è¯»å–å“åº”</span>        data, err := io.ReadAll(resp.Body)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            errorCh &lt;- err            <span class="hljs-keyword">return</span>        &#125;                responseCh &lt;- data    &#125;()        <span class="hljs-comment">// ç­‰å¾…ç»“æœæˆ–è¶…æ—¶</span>    <span class="hljs-keyword">select</span> &#123;    <span class="hljs-keyword">case</span> data := &lt;-responseCh:        <span class="hljs-keyword">return</span> data, <span class="hljs-literal">nil</span>    <span class="hljs-keyword">case</span> err := &lt;-errorCh:        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    <span class="hljs-keyword">case</span> &lt;-time.After(timeout):        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;request timed out after %v&quot;</span>, timeout)    &#125;&#125;</code></pre><p>è¿™ä¸ªæ¨¡å¼å¯ä»¥åº”ç”¨äºä»»ä½•å¯èƒ½è€—æ—¶çš„æ“ä½œï¼Œç¡®ä¿ä½ çš„ç¨‹åºä¸ä¼šæ— é™æœŸç­‰å¾…æŸä¸ªæ“ä½œå®Œæˆã€‚</p><h3 id="5-å–æ¶ˆæ¨¡å¼-Cancellation-Pattern"><a class="header-anchor" href="#5-å–æ¶ˆæ¨¡å¼-Cancellation-Pattern"></a>5. å–æ¶ˆæ¨¡å¼ (Cancellation Pattern)</h3><p>Goçš„<code>context</code>åŒ…æä¾›äº†å–æ¶ˆæ“ä½œçš„æ ‡å‡†æ–¹å¼ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processWithCancellation</span><span class="hljs-params">(ctx context.Context, tasks []<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-keyword">for</span> _, task := <span class="hljs-keyword">range</span> tasks &#123;        <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦åº”è¯¥å–æ¶ˆ</span>        <span class="hljs-keyword">select</span> &#123;        <span class="hljs-keyword">case</span> &lt;-ctx.Done():            <span class="hljs-keyword">return</span> ctx.Err()        <span class="hljs-keyword">default</span>:            <span class="hljs-comment">// ç»§ç»­å¤„ç†</span>        &#125;                <span class="hljs-comment">// å¤„ç†ä»»åŠ¡</span>        err := processTask(task)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> err        &#125;    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºå¯å–æ¶ˆçš„context</span>    ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">5</span>*time.Second)    <span class="hljs-keyword">defer</span> cancel() <span class="hljs-comment">// ç¡®ä¿æ‰€æœ‰è·¯å¾„éƒ½è°ƒç”¨cancel</span>        tasks := []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;task1&quot;</span>, <span class="hljs-string">&quot;task2&quot;</span>, <span class="hljs-string">&quot;task3&quot;</span>&#125;    err := processWithCancellation(ctx, tasks)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        fmt.Printf(<span class="hljs-string">&quot;å¤„ç†ä¸­æ–­: %v\n&quot;</span>, err)    &#125;&#125;</code></pre><p>å–æ¶ˆæ¨¡å¼çš„æœ€ä½³å®è·µï¼š</p><ul><li>æ€»æ˜¯ä¼ é€’contextä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°</li><li>ä¸è¦åœ¨å‡½æ•°ä¸­å­˜å‚¨contextï¼Œè€Œæ˜¯ä¼ é€’å®ƒ</li><li>ä½¿ç”¨<code>defer cancel()</code>ç¡®ä¿èµ„æºé‡Šæ”¾</li><li>å®šæœŸæ£€æŸ¥<code>ctx.Done()</code>ï¼Œç‰¹åˆ«æ˜¯åœ¨å¾ªç¯ä¸­</li></ul><h2 id="ğŸ”-å¹¶å‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ"><a class="header-anchor" href="#ğŸ”-å¹¶å‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ"></a>ğŸ” å¹¶å‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ</h2><p>å³ä½¿æœ‰ä¼˜é›…çš„å¹¶å‘æ¨¡å‹ï¼ŒGoç¼–ç¨‹ä¸­ä»æœ‰ä¸€äº›å¸¸è§é™·é˜±éœ€è¦é¿å…ï¼š</p><h3 id="1-å¹¶å‘è®¿é—®å…±äº«æ•°æ®"><a class="header-anchor" href="#1-å¹¶å‘è®¿é—®å…±äº«æ•°æ®"></a>1. å¹¶å‘è®¿é—®å…±äº«æ•°æ®</h3><p>æœ€å¸¸è§çš„å¹¶å‘é—®é¢˜æ˜¯å¤šä¸ªgoroutineåŒæ—¶è®¿é—®å…±äº«æ•°æ®ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// é”™è¯¯ç¤ºä¾‹</span>counter := <span class="hljs-number">0</span><span class="hljs-keyword">var</span> wg sync.WaitGroup<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ &#123;    wg.Add(<span class="hljs-number">1</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> wg.Done()        counter++ <span class="hljs-comment">// ç«æ€æ¡ä»¶!</span>    &#125;()&#125;wg.Wait()fmt.Println(counter) <span class="hljs-comment">// å¯èƒ½ä¸æ˜¯1000</span></code></pre><p>è§£å†³æ–¹æ¡ˆåŒ…æ‹¬ï¼š</p><ol><li><strong>ä½¿ç”¨äº’æ–¥é”</strong></li></ol><pre><code class="hljs go"><span class="hljs-keyword">var</span> (    counter <span class="hljs-keyword">int</span>    mu      sync.Mutex    wg      sync.WaitGroup)<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ &#123;    wg.Add(<span class="hljs-number">1</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> wg.Done()        mu.Lock()        counter++        mu.Unlock()    &#125;()&#125;wg.Wait()fmt.Println(counter) <span class="hljs-comment">// 1000</span></code></pre><ol start="2"><li><strong>ä½¿ç”¨atomicåŒ…</strong></li></ol><pre><code class="hljs go"><span class="hljs-keyword">var</span> (    counter <span class="hljs-keyword">int64</span>    wg      sync.WaitGroup)<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ &#123;    wg.Add(<span class="hljs-number">1</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> wg.Done()        atomic.AddInt64(&amp;counter, <span class="hljs-number">1</span>)    &#125;()&#125;wg.Wait()fmt.Println(counter) <span class="hljs-comment">// 1000</span></code></pre><ol start="3"><li><strong>ä½¿ç”¨channelé€šä¿¡</strong></li></ol><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    counter := <span class="hljs-number">0</span>    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, <span class="hljs-number">1000</span>)    <span class="hljs-keyword">var</span> wg sync.WaitGroup        <span class="hljs-comment">// ç”Ÿäº§incrementä¿¡å·</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ &#123;        wg.Add(<span class="hljs-number">1</span>)        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;            <span class="hljs-keyword">defer</span> wg.Done()            ch &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// å‘é€ä¿¡å·</span>        &#125;()    &#125;        <span class="hljs-comment">// å…³é—­channel(å½“æ‰€æœ‰goroutineå®Œæˆæ—¶)</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        wg.Wait()        <span class="hljs-built_in">close</span>(ch)    &#125;()        <span class="hljs-comment">// è®¡æ•°ä¿¡å·</span>    <span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> ch &#123;        counter++    &#125;        fmt.Println(counter) <span class="hljs-comment">// 1000</span>&#125;</code></pre><h3 id="2-goroutineæ³„æ¼"><a class="header-anchor" href="#2-goroutineæ³„æ¼"></a>2. goroutineæ³„æ¼</h3><p>goroutineæ³„æ¼æ˜¯æŒ‡åˆ›å»ºçš„goroutineæ°¸è¿œä¸ä¼šé€€å‡ºï¼Œä»è€Œæ¶ˆè€—èµ„æºï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æœ‰æ³„æ¼é£é™©çš„ä»£ç </span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">leakyFunction</span><span class="hljs-params">()</span> <span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        val := expensiveOperation()        ch &lt;- val <span class="hljs-comment">// å¦‚æœæ²¡äººæ¥æ”¶ï¼Œå°†æ°¸è¿œé˜»å¡</span>    &#125;()    <span class="hljs-keyword">return</span> ch&#125;</code></pre><p>é¿å…goroutineæ³„æ¼çš„æŠ€å·§ï¼š</p><ol><li><strong>æ€»æ˜¯ç¡®ä¿channelèƒ½å…³é—­</strong></li></ol><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">nonLeakyFunction</span><span class="hljs-params">()</span> <span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// ç¼“å†²åŒºç¡®ä¿å‘é€ä¸ä¼šé˜»å¡</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        val := expensiveOperation()        ch &lt;- val        <span class="hljs-built_in">close</span>(ch) <span class="hljs-comment">// æ˜¾å¼å…³é—­channel</span>    &#125;()    <span class="hljs-keyword">return</span> ch&#125;</code></pre><ol start="2"><li><strong>ä½¿ç”¨contextè¿›è¡Œå–æ¶ˆæ§åˆ¶</strong></li></ol><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">withContextFunction</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-params">(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, error)</span></span> &#123;    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(ch)                result, err := expensiveOperation()        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> <span class="hljs-comment">// å…³é—­channelå¹¶é€€å‡º</span>        &#125;                <span class="hljs-comment">// å°è¯•å‘é€æˆ–å“åº”å–æ¶ˆ</span>        <span class="hljs-keyword">select</span> &#123;        <span class="hljs-keyword">case</span> ch &lt;- result:            <span class="hljs-comment">// æˆåŠŸå‘é€</span>        <span class="hljs-keyword">case</span> &lt;-ctx.Done():            <span class="hljs-comment">// contextå·²å–æ¶ˆ</span>            <span class="hljs-keyword">return</span>        &#125;    &#125;()    <span class="hljs-keyword">return</span> ch, <span class="hljs-literal">nil</span>&#125;</code></pre><h3 id="3-æ­»é”"><a class="header-anchor" href="#3-æ­»é”"></a>3. æ­»é”</h3><p>æ­»é”åœ¨goroutineäº’ç›¸ç­‰å¾…æ—¶å‘ç”Ÿï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æ­»é”ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    ch1 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    ch2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        ch1 &lt;- <span class="hljs-number">42</span> <span class="hljs-comment">// é˜»å¡ç›´åˆ°æœ‰äººä»ch1æ¥æ”¶</span>        val := &lt;-ch2 <span class="hljs-comment">// æ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ</span>        fmt.Println(val)    &#125;()        val := &lt;-ch2 <span class="hljs-comment">// é˜»å¡ç­‰å¾…ch2ï¼Œä½†æ²¡äººä¼šå‘é€</span>    ch1 &lt;- val   <span class="hljs-comment">// æ°¸è¿œä¸ä¼šæ‰§è¡Œ</span>&#125;</code></pre><p>é¿å…æ­»é”çš„ç­–ç•¥ï¼š</p><ol><li><strong>ä½¿ç”¨ç¼“å†²channel</strong></li><li><strong>æ­£ç¡®è®¾è®¡é€šä¿¡é¡ºåº</strong></li><li><strong>ä½¿ç”¨selectå¤„ç†å¤šä¸ªchannel</strong></li><li><strong>è®¾ç½®è¶…æ—¶æœºåˆ¶</strong></li></ol><pre><code class="hljs go"><span class="hljs-comment">// ä½¿ç”¨selecté¿å…æ­»é”</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    ch1 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    ch2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">select</span> &#123;        <span class="hljs-keyword">case</span> ch1 &lt;- <span class="hljs-number">42</span>:            <span class="hljs-comment">// ch1æˆåŠŸå‘é€</span>        <span class="hljs-keyword">case</span> val := &lt;-ch2:            <span class="hljs-comment">// ä»ch2æ¥æ”¶</span>            fmt.Println(val)        <span class="hljs-keyword">case</span> &lt;-time.After(time.Second):            <span class="hljs-comment">// è¶…æ—¶ï¼Œé¿å…æ°¸ä¹…é˜»å¡</span>            fmt.Println(<span class="hljs-string">&quot;è¶…æ—¶&quot;</span>)            <span class="hljs-keyword">return</span>        &#125;    &#125;()        <span class="hljs-keyword">select</span> &#123;    <span class="hljs-keyword">case</span> val := &lt;-ch1:        <span class="hljs-comment">// å¤„ç†ä»ch1æ¥æ”¶çš„å€¼</span>        ch2 &lt;- val * <span class="hljs-number">2</span>    <span class="hljs-keyword">case</span> ch2 &lt;- <span class="hljs-number">10</span>:        <span class="hljs-comment">// å‘ch2å‘é€å€¼</span>    <span class="hljs-keyword">case</span> &lt;-time.After(time.Second):        <span class="hljs-comment">// è¶…æ—¶å¤„ç†</span>        fmt.Println(<span class="hljs-string">&quot;è¶…æ—¶&quot;</span>)    &#125;&#125;</code></pre><h2 id="ğŸš€-æ€§èƒ½è°ƒä¼˜å®æˆ˜"><a class="header-anchor" href="#ğŸš€-æ€§èƒ½è°ƒä¼˜å®æˆ˜"></a>ğŸš€ æ€§èƒ½è°ƒä¼˜å®æˆ˜</h2><h3 id="1-æ€§èƒ½åˆ†æå·¥å…·"><a class="header-anchor" href="#1-æ€§èƒ½åˆ†æå·¥å…·"></a>1. æ€§èƒ½åˆ†æå·¥å…·</h3><p>Goæä¾›äº†å¼ºå¤§çš„æ€§èƒ½åˆ†æå·¥å…·ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;net/http&quot;</span>    _ <span class="hljs-string">&quot;net/http/pprof&quot;</span> <span class="hljs-comment">// ä»…å¯¼å…¥ï¼Œä¸ç›´æ¥ä½¿ç”¨</span>    <span class="hljs-string">&quot;runtime&quot;</span>    <span class="hljs-string">&quot;runtime/pprof&quot;</span>    <span class="hljs-string">&quot;os&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// å¯åŠ¨pprof HTTPæœåŠ¡å™¨(åœ¨ç”Ÿäº§ç¯å¢ƒè¦å°å¿ƒä½¿ç”¨)</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        http.ListenAndServe(<span class="hljs-string">&quot;localhost:6060&quot;</span>, <span class="hljs-literal">nil</span>)    &#125;()        <span class="hljs-comment">// CPUåˆ†æ</span>    f, _ := os.Create(<span class="hljs-string">&quot;cpu.prof&quot;</span>)    <span class="hljs-keyword">defer</span> f.Close()    pprof.StartCPUProfile(f)    <span class="hljs-keyword">defer</span> pprof.StopCPUProfile()        <span class="hljs-comment">// ä½ çš„ç¨‹åº...</span>        <span class="hljs-comment">// å†…å­˜åˆ†æ</span>    memoryProfile, _ := os.Create(<span class="hljs-string">&quot;memory.prof&quot;</span>)    <span class="hljs-keyword">defer</span> memoryProfile.Close()    runtime.GC() <span class="hljs-comment">// åœ¨åˆ†æå‰æ‰§è¡ŒGC</span>    pprof.WriteHeapProfile(memoryProfile)&#125;</code></pre><p>ä½¿ç”¨è¿™äº›æ–‡ä»¶è¿›è¡Œåˆ†æï¼š</p><pre><code class="hljs bash"><span class="hljs-comment"># æŸ¥çœ‹CPUçƒ­ç‚¹</span>go tool pprof -http=:8080 cpu.prof<span class="hljs-comment"># æŸ¥çœ‹å†…å­˜åˆ†é…çƒ­ç‚¹ </span>go tool pprof -http=:8080 memory.prof</code></pre><h3 id="2-é¿å…è¿‡åº¦å¹¶å‘"><a class="header-anchor" href="#2-é¿å…è¿‡åº¦å¹¶å‘"></a>2. é¿å…è¿‡åº¦å¹¶å‘</h3><p>è™½ç„¶Goå¤„ç†å¹¶å‘çš„èƒ½åŠ›å¾ˆå¼ºï¼Œä½†è¿‡å¤šçš„goroutineä¹Ÿä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// é™åˆ¶å¹¶å‘æ•°çš„å‡½æ•°</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">limitedConcurrency</span><span class="hljs-params">(tasks []Task, maxConcurrency <span class="hljs-keyword">int</span>)</span> []<span class="hljs-title">Result</span></span> &#123;    taskCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Task, <span class="hljs-built_in">len</span>(tasks))    resultCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result, <span class="hljs-built_in">len</span>(tasks))        <span class="hljs-comment">// å¡«å……ä»»åŠ¡é€šé“</span>    <span class="hljs-keyword">for</span> _, task := <span class="hljs-keyword">range</span> tasks &#123;        taskCh &lt;- task    &#125;    <span class="hljs-built_in">close</span>(taskCh)        <span class="hljs-comment">// é™åˆ¶workeræ•°é‡</span>    workers := min(maxConcurrency, <span class="hljs-built_in">len</span>(tasks))    <span class="hljs-keyword">var</span> wg sync.WaitGroup        <span class="hljs-comment">// å¯åŠ¨å›ºå®šæ•°é‡çš„worker</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; workers; i++ &#123;        wg.Add(<span class="hljs-number">1</span>)        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;            <span class="hljs-keyword">defer</span> wg.Done()            <span class="hljs-keyword">for</span> task := <span class="hljs-keyword">range</span> taskCh &#123;                result := processTask(task)                resultCh &lt;- result            &#125;        &#125;()    &#125;        <span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰workerå®Œæˆï¼Œç„¶åå…³é—­ç»“æœé€šé“</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        wg.Wait()        <span class="hljs-built_in">close</span>(resultCh)    &#125;()        <span class="hljs-comment">// æ”¶é›†ç»“æœ</span>    results := <span class="hljs-built_in">make</span>([]Result, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(tasks))    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultCh &#123;        results = <span class="hljs-built_in">append</span>(results, result)    &#125;        <span class="hljs-keyword">return</span> results&#125;</code></pre><p>ä½•æ—¶éœ€è¦é™åˆ¶å¹¶å‘ï¼š</p><ul><li>IOå¯†é›†å‹æ“ä½œ(å¦‚ç½‘ç»œè¯·æ±‚)ï¼šé€šå¸¸å¯ä»¥æœ‰è¾ƒé«˜çš„å¹¶å‘åº¦</li><li>CPUå¯†é›†å‹æ“ä½œï¼šå¹¶å‘åº¦æœ€å¥½æ¥è¿‘CPUæ ¸å¿ƒæ•°</li><li>å­˜åœ¨å…±äº«èµ„æº(å¦‚æ•°æ®åº“è¿æ¥)ï¼šæ ¹æ®èµ„æºå®¹é‡é™åˆ¶</li></ul><h3 id="3-ä¼˜åŒ–å†…å­˜åˆ†é…"><a class="header-anchor" href="#3-ä¼˜åŒ–å†…å­˜åˆ†é…"></a>3. ä¼˜åŒ–å†…å­˜åˆ†é…</h3><p>å‡å°‘åƒåœ¾å›æ”¶å‹åŠ›çš„å…³é”®æ˜¯å‡å°‘å†…å­˜åˆ†é…ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æœªä¼˜åŒ–ç‰ˆæœ¬</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processLargeData</span><span class="hljs-params">(data []<span class="hljs-keyword">int</span>)</span> []<span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">var</span> result []<span class="hljs-keyword">int</span>    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> data &#123;        <span class="hljs-keyword">if</span> v%<span class="hljs-number">2</span> == <span class="hljs-number">0</span> &#123;            result = <span class="hljs-built_in">append</span>(result, v)        &#125;    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-comment">// ä¼˜åŒ–ç‰ˆæœ¬(é¢„åˆ†é…å†…å­˜)</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processLargeDataOptimized</span><span class="hljs-params">(data []<span class="hljs-keyword">int</span>)</span> []<span class="hljs-title">int</span></span> &#123;    <span class="hljs-comment">// é¢„ä¼°ç»“æœå¤§å°(å‡è®¾çº¦ä¸€åŠæ˜¯å¶æ•°)</span>    result := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(data)/<span class="hljs-number">2</span>)    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> data &#123;        <span class="hljs-keyword">if</span> v%<span class="hljs-number">2</span> == <span class="hljs-number">0</span> &#123;            result = <span class="hljs-built_in">append</span>(result, v)        &#125;    &#125;    <span class="hljs-keyword">return</span> result&#125;</code></pre><p>æ›´å¤šå†…å­˜ä¼˜åŒ–æŠ€å·§ï¼š</p><ol><li><strong>ä½¿ç”¨å¯¹è±¡æ± </strong></li></ol><pre><code class="hljs go"><span class="hljs-keyword">var</span> bufferPool = sync.Pool&#123;    New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;        <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(bytes.Buffer)    &#125;,&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processRequest</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// ä»æ± è·å–å¯¹è±¡</span>    buf := bufferPool.Get().(*bytes.Buffer)    buf.Reset() <span class="hljs-comment">// é‡ç½®çŠ¶æ€</span>        <span class="hljs-comment">// ä½¿ç”¨ç¼“å†²åŒº</span>    buf.WriteString(<span class="hljs-string">&quot;some data&quot;</span>)    processBuffer(buf)        <span class="hljs-comment">// å½’è¿˜å¯¹è±¡åˆ°æ± </span>    bufferPool.Put(buf)&#125;</code></pre><ol start="2"><li><strong>é›¶æ‹·è´æŠ€æœ¯</strong></li></ol><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">copyData</span><span class="hljs-params">(dst, src []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-comment">// é¿å…ä¸å¿…è¦çš„å¤åˆ¶</span>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">copy</span>(dst, src)&#125;<span class="hljs-comment">// å­—ç¬¦ä¸²è½¬æ¢ä¸åˆ†é…æ–°å†…å­˜</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">stringToBytes</span><span class="hljs-params">(s <span class="hljs-keyword">string</span>)</span> []<span class="hljs-title">byte</span></span> &#123;    <span class="hljs-keyword">return</span> *(*[]<span class="hljs-keyword">byte</span>)(unsafe.Pointer(        &amp;<span class="hljs-keyword">struct</span> &#123;            <span class="hljs-keyword">string</span>            Cap <span class="hljs-keyword">int</span>        &#125;&#123;s, <span class="hljs-built_in">len</span>(s)&#125;,    ))&#125;</code></pre><h3 id="4-CPUç¼“å­˜ä¼˜åŒ–"><a class="header-anchor" href="#4-CPUç¼“å­˜ä¼˜åŒ–"></a>4. CPUç¼“å­˜ä¼˜åŒ–</h3><p>ç†è§£CPUç¼“å­˜å¯ä»¥å¸®åŠ©ç¼–å†™æ›´é«˜æ•ˆçš„ä»£ç ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ç¼“å­˜ä¸å‹å¥½(æŒ‰åˆ—è®¿é—®2Dæ•°ç»„)</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sumMatrixByColumn</span><span class="hljs-params">(matrix [][]<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    sum := <span class="hljs-number">0</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(matrix[<span class="hljs-number">0</span>]); i++ &#123;        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(matrix); j++ &#123;            sum += matrix[j][i] <span class="hljs-comment">// è·¨è¶Šå†…å­˜ï¼Œç¼“å­˜å‘½ä¸­ç‡ä½</span>        &#125;    &#125;    <span class="hljs-keyword">return</span> sum&#125;<span class="hljs-comment">// ç¼“å­˜å‹å¥½(æŒ‰è¡Œè®¿é—®2Dæ•°ç»„)</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sumMatrixByRow</span><span class="hljs-params">(matrix [][]<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    sum := <span class="hljs-number">0</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(matrix); i++ &#123;        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(matrix[i]); j++ &#123;            sum += matrix[i][j] <span class="hljs-comment">// é¡ºåºè®¿é—®å†…å­˜ï¼Œç¼“å­˜å‘½ä¸­ç‡é«˜</span>        &#125;    &#125;    <span class="hljs-keyword">return</span> sum&#125;</code></pre><p>ç¼“å­˜ä¼˜åŒ–çš„å…³é”®åŸåˆ™ï¼š</p><ul><li>å°½é‡ä¿æŒæ•°æ®è®¿é—®çš„ç©ºé—´å±€éƒ¨æ€§</li><li>ä½¿ç”¨é€‚åˆç¼“å­˜è¡Œå¤§å°(é€šå¸¸64å­—èŠ‚)çš„æ•°æ®ç»“æ„</li><li>é¿å…é¢‘ç¹è·¨è¶Šå¤§å†…å­˜åŒºåŸŸ</li></ul><h3 id="5-é¿å…åå°„å’Œinterface"><a class="header-anchor" href="#5-é¿å…åå°„å’Œinterface"></a>5. é¿å…åå°„å’Œinterface{}</h3><p>Goçš„åå°„åŠŸèƒ½å¼ºå¤§ä½†å¼€é”€å¤§ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä½¿ç”¨åå°„(è¾ƒæ…¢)</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getField</span><span class="hljs-params">(obj <span class="hljs-keyword">interface</span>&#123;&#125;, fieldName <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    v := reflect.ValueOf(obj)    <span class="hljs-keyword">if</span> v.Kind() == reflect.Ptr &#123;        v = v.Elem()    &#125;    <span class="hljs-keyword">return</span> v.FieldByName(fieldName).Interface()&#125;<span class="hljs-comment">// ä¸ä½¿ç”¨åå°„(æ›´å¿«)</span><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;    Name <span class="hljs-keyword">string</span>    Age  <span class="hljs-keyword">int</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getUserName</span><span class="hljs-params">(u User)</span> <span class="hljs-title">string</span></span> &#123;    <span class="hljs-keyword">return</span> u.Name&#125;</code></pre><p>ä½•æ—¶é¿å…ä½¿ç”¨<code>interface&#123;&#125;</code>ï¼š</p><ul><li>æ€§èƒ½å…³é”®è·¯å¾„</li><li>é«˜é¢‘è°ƒç”¨çš„å‡½æ•°</li><li>å¤„ç†å¤§é‡æ•°æ®çš„å¾ªç¯</li></ul><h3 id="6-ä½¿ç”¨åŸºå‡†æµ‹è¯•é©±åŠ¨ä¼˜åŒ–"><a class="header-anchor" href="#6-ä½¿ç”¨åŸºå‡†æµ‹è¯•é©±åŠ¨ä¼˜åŒ–"></a>6. ä½¿ç”¨åŸºå‡†æµ‹è¯•é©±åŠ¨ä¼˜åŒ–</h3><p>å§‹ç»ˆä½¿ç”¨åŸºå‡†æµ‹è¯•ç¡®è®¤ä¼˜åŒ–æ•ˆæœï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkProcess</span><span class="hljs-params">(b *testing.B)</span></span> &#123;    data := generateLargeData()    b.ResetTimer()        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;        process(data)    &#125;&#125;</code></pre><p>è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼š</p><pre><code class="hljs bash">go <span class="hljs-built_in">test</span> -bench=. -benchmem</code></pre><p>åŸºå‡†æµ‹è¯•æœ€ä½³å®è·µï¼š</p><ul><li>æ¯”è¾ƒå‰åç‰ˆæœ¬ï¼Œç¡®ä¿ä¼˜åŒ–æœ‰æ•ˆ</li><li>å…³æ³¨å†…å­˜åˆ†é…æ¬¡æ•°å’Œæ€»é‡</li><li>é¿å…è¿‡æ—©ä¼˜åŒ–ï¼Œå…ˆåˆ†æåè¡ŒåŠ¨</li><li>ä¿æŒä»£ç å¯è¯»æ€§ï¼Œé™¤éæ€§èƒ½æå‡æ˜¾è‘—</li></ul><h2 id="ğŸ“ˆ-æ¡ˆä¾‹ç ”ç©¶ï¼šå®é™…ä¼˜åŒ–è¿‡ç¨‹"><a class="header-anchor" href="#ğŸ“ˆ-æ¡ˆä¾‹ç ”ç©¶ï¼šå®é™…ä¼˜åŒ–è¿‡ç¨‹"></a>ğŸ“ˆ æ¡ˆä¾‹ç ”ç©¶ï¼šå®é™…ä¼˜åŒ–è¿‡ç¨‹</h2><p>ä»¥ä¸‹æ˜¯æˆ‘åœ¨ä¸€ä¸ªçœŸå®é¡¹ç›®ä¸­ä¼˜åŒ–ä¸€ä¸ªHTTP APIæœåŠ¡çš„è¿‡ç¨‹ï¼š</p><h3 id="åˆå§‹ç‰ˆæœ¬"><a class="header-anchor" href="#åˆå§‹ç‰ˆæœ¬"></a>åˆå§‹ç‰ˆæœ¬</h3><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fetchDataHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;    userID := r.URL.Query().Get(<span class="hljs-string">&quot;user_id&quot;</span>)        <span class="hljs-comment">// è·å–ç”¨æˆ·è¯¦æƒ…</span>    user, err := getUserDetails(userID)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        http.Error(w, err.Error(), http.StatusInternalServerError)        <span class="hljs-keyword">return</span>    &#125;        <span class="hljs-comment">// è·å–ç”¨æˆ·è®¢å•</span>    orders, err := getUserOrders(userID)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        http.Error(w, err.Error(), http.StatusInternalServerError)        <span class="hljs-keyword">return</span>    &#125;        <span class="hljs-comment">// è·å–æ¨èå•†å“</span>    recommendations, err := getRecommendations(userID)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        http.Error(w, err.Error(), http.StatusInternalServerError)        <span class="hljs-keyword">return</span>    &#125;        <span class="hljs-comment">// ç»„åˆç»“æœ</span>    result := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;        <span class="hljs-string">&quot;user&quot;</span>: user,        <span class="hljs-string">&quot;orders&quot;</span>: orders,        <span class="hljs-string">&quot;recommendations&quot;</span>: recommendations,    &#125;        <span class="hljs-comment">// åºåˆ—åŒ–å¹¶è¿”å›</span>    data, err := json.Marshal(result)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        http.Error(w, err.Error(), http.StatusInternalServerError)        <span class="hljs-keyword">return</span>    &#125;        w.Header().Set(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>)    w.Write(data)&#125;</code></pre><h3 id="é—®é¢˜åˆ†æ"><a class="header-anchor" href="#é—®é¢˜åˆ†æ"></a>é—®é¢˜åˆ†æ</h3><p>ä½¿ç”¨pprofåˆ†æåå‘ç°ï¼š</p><ol><li>ä¸‰ä¸ªæ•°æ®è·å–å‡½æ•°ä¸²è¡Œæ‰§è¡Œï¼Œæ€»å“åº”æ—¶é—´æ˜¯ä¸‰è€…ä¹‹å’Œ</li><li>JSONåºåˆ—åŒ–å ç”¨å¤§é‡CPUæ—¶é—´</li><li>æ²¡æœ‰è¯·æ±‚è¶…æ—¶æ§åˆ¶</li></ol><h3 id="ä¼˜åŒ–ç‰ˆæœ¬"><a class="header-anchor" href="#ä¼˜åŒ–ç‰ˆæœ¬"></a>ä¼˜åŒ–ç‰ˆæœ¬</h3><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fetchDataHandlerOptimized</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;    <span class="hljs-comment">// æ·»åŠ è¯·æ±‚çº§context</span>    ctx, cancel := context.WithTimeout(r.Context(), <span class="hljs-number">3</span>*time.Second)    <span class="hljs-keyword">defer</span> cancel()        userID := r.URL.Query().Get(<span class="hljs-string">&quot;user_id&quot;</span>)        <span class="hljs-comment">// å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ®</span>    <span class="hljs-keyword">var</span> wg sync.WaitGroup    <span class="hljs-keyword">var</span> userMu, ordersMu, recomMu sync.Mutex    <span class="hljs-keyword">var</span> user User    <span class="hljs-keyword">var</span> orders []Order    <span class="hljs-keyword">var</span> recommendations []Product    <span class="hljs-keyword">var</span> userErr, ordersErr, recomErr error        wg.Add(<span class="hljs-number">3</span>)        <span class="hljs-comment">// è·å–ç”¨æˆ·è¯¦æƒ…</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> wg.Done()        u, err := getUserDetails(ctx, userID)        userMu.Lock()        user, userErr = u, err        userMu.Unlock()    &#125;()        <span class="hljs-comment">// è·å–ç”¨æˆ·è®¢å•</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> wg.Done()        o, err := getUserOrders(ctx, userID)        ordersMu.Lock()        orders, ordersErr = o, err        ordersMu.Unlock()    &#125;()        <span class="hljs-comment">// è·å–æ¨èå•†å“</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> wg.Done()        r, err := getRecommendations(ctx, userID)        recomMu.Lock()        recommendations, recomErr = r, err        recomMu.Unlock()    &#125;()        <span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰goroutineå®Œæˆ</span>    wg.Wait()        <span class="hljs-comment">// æ£€æŸ¥é”™è¯¯</span>    <span class="hljs-keyword">if</span> userErr != <span class="hljs-literal">nil</span> &#123;        http.Error(w, userErr.Error(), http.StatusInternalServerError)        <span class="hljs-keyword">return</span>    &#125;    <span class="hljs-keyword">if</span> ordersErr != <span class="hljs-literal">nil</span> &#123;        http.Error(w, ordersErr.Error(), http.StatusInternalServerError)        <span class="hljs-keyword">return</span>    &#125;    <span class="hljs-keyword">if</span> recomErr != <span class="hljs-literal">nil</span> &#123;        http.Error(w, recomErr.Error(), http.StatusInternalServerError)        <span class="hljs-keyword">return</span>    &#125;        <span class="hljs-comment">// ä½¿ç”¨é¢„å®šä¹‰ç»“æ„ä½“è€Œémap</span>    result := ResponseData&#123;        User:            user,        Orders:          orders,        Recommendations: recommendations,    &#125;        <span class="hljs-comment">// ä½¿ç”¨æ›´é«˜æ•ˆçš„JSONç¼–ç </span>    w.Header().Set(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>)        <span class="hljs-comment">// ç›´æ¥å†™å…¥å“åº”ï¼Œé¿å…ä¸­é—´ç¼“å†²</span>    encoder := json.NewEncoder(w)    <span class="hljs-keyword">if</span> err := encoder.Encode(result); err != <span class="hljs-literal">nil</span> &#123;        http.Error(w, err.Error(), http.StatusInternalServerError)        <span class="hljs-keyword">return</span>    &#125;&#125;</code></pre><h3 id="è¿›ä¸€æ­¥ä¼˜åŒ–"><a class="header-anchor" href="#è¿›ä¸€æ­¥ä¼˜åŒ–"></a>è¿›ä¸€æ­¥ä¼˜åŒ–</h3><p>è€ƒè™‘æ›´å¤šçš„ç°å®æƒ…å†µï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fetchDataHandlerFinal</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;    <span class="hljs-comment">// æ·»åŠ è¯·æ±‚çº§contextå’Œè¶…æ—¶</span>    ctx, cancel := context.WithTimeout(r.Context(), <span class="hljs-number">3</span>*time.Second)    <span class="hljs-keyword">defer</span> cancel()        userID := r.URL.Query().Get(<span class="hljs-string">&quot;user_id&quot;</span>)        <span class="hljs-comment">// ä½¿ç”¨errgroupæ›´ä¼˜é›…åœ°å¤„ç†å¹¶å‘å’Œé”™è¯¯</span>    group, ctx := errgroup.WithContext(ctx)        <span class="hljs-keyword">var</span> user User    group.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;        <span class="hljs-keyword">var</span> err error        user, err = getUserDetails(ctx, userID)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥: %w&quot;</span>, err)        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>    &#125;)        <span class="hljs-keyword">var</span> orders []Order    group.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;        <span class="hljs-keyword">var</span> err error        orders, err = getUserOrders(ctx, userID)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-comment">// è®¢å•è·å–å¤±è´¥ä¸é˜»æ­¢æ•´ä½“å“åº”ï¼Œåªè®°å½•é”™è¯¯</span>            log.Printf(<span class="hljs-string">&quot;è·å–ç”¨æˆ·è®¢å•å¤±è´¥: %v&quot;</span>, err)            orders = []Order&#123;&#125; <span class="hljs-comment">// è¿”å›ç©ºè®¢å•è€Œéé”™è¯¯</span>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>    &#125;)        <span class="hljs-keyword">var</span> recommendations []Product    group.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;        <span class="hljs-keyword">var</span> err error        recommendations, err = getRecommendations(ctx, userID)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-comment">// æ¨èè·å–å¤±è´¥ä¸é˜»æ­¢æ•´ä½“å“åº”</span>            log.Printf(<span class="hljs-string">&quot;è·å–æ¨èå•†å“å¤±è´¥: %v&quot;</span>, err)            recommendations = []Product&#123;&#125; <span class="hljs-comment">// è¿”å›ç©ºæ¨è</span>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>    &#125;)        <span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰goroutineå®Œæˆ</span>    <span class="hljs-keyword">if</span> err := group.Wait(); err != <span class="hljs-literal">nil</span> &#123;        http.Error(w, err.Error(), http.StatusInternalServerError)        <span class="hljs-keyword">return</span>    &#125;        <span class="hljs-comment">// é¢„å…ˆå®šä¹‰ç»“æ„ä½“ç±»å‹å¹¶å¤ç”¨</span>    result := responsePool.Get().(*ResponseData)    <span class="hljs-keyword">defer</span> responsePool.Put(result)        result.User = user    result.Orders = orders    result.Recommendations = recommendations        <span class="hljs-comment">// ä½¿ç”¨æ›´é«˜æ•ˆçš„JSONç¼–ç </span>    w.Header().Set(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>)    w.Header().Set(<span class="hljs-string">&quot;Cache-Control&quot;</span>, <span class="hljs-string">&quot;max-age=10&quot;</span>) <span class="hljs-comment">// æ·»åŠ åˆé€‚çš„ç¼“å­˜å¤´</span>        <span class="hljs-keyword">if</span> err := json.NewEncoder(w).Encode(result); err != <span class="hljs-literal">nil</span> &#123;        http.Error(w, err.Error(), http.StatusInternalServerError)        <span class="hljs-keyword">return</span>    &#125;&#125;<span class="hljs-comment">// å¯¹è±¡æ± </span><span class="hljs-keyword">var</span> responsePool = sync.Pool&#123;    New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;        <span class="hljs-keyword">return</span> &amp;ResponseData&#123;&#125;    &#125;,&#125;<span class="hljs-keyword">type</span> ResponseData <span class="hljs-keyword">struct</span> &#123;    User            User      <span class="hljs-string">`json:&quot;user&quot;`</span>    Orders          []Order   <span class="hljs-string">`json:&quot;orders&quot;`</span>    Recommendations []Product <span class="hljs-string">`json:&quot;recommendations&quot;`</span>&#125;</code></pre><p>è¿™ä¸ªæœ€ç»ˆä¼˜åŒ–ç‰ˆæœ¬å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li>ä½¿ç”¨<code>errgroup</code>æ›´ä¼˜é›…åœ°å¤„ç†å¹¶å‘å’Œé”™è¯¯</li><li>å®ç°ä¼˜é›…é™çº§(éƒ¨åˆ†æ•°æ®è·å–å¤±è´¥ä¸å½±å“æ•´ä½“å“åº”)</li><li>ä½¿ç”¨å¯¹è±¡æ± å‡å°‘å†…å­˜åˆ†é…</li><li>æ·»åŠ é€‚å½“çš„HTTPå¤´(å¦‚ç¼“å­˜æ§åˆ¶)</li></ol><h3 id="ä¼˜åŒ–æ•ˆæœ"><a class="header-anchor" href="#ä¼˜åŒ–æ•ˆæœ"></a>ä¼˜åŒ–æ•ˆæœ</h3><table><thead><tr><th>æŒ‡æ ‡</th><th>åˆå§‹ç‰ˆæœ¬</th><th>æœ€ç»ˆä¼˜åŒ–ç‰ˆ</th><th>æ”¹è¿›</th></tr></thead><tbody><tr><td>å¹³å‡å“åº”æ—¶é—´</td><td>350ms</td><td>120ms</td><td>65%â†“</td></tr><tr><td>æ¯ç§’è¯·æ±‚æ•°(RPS)</td><td>285</td><td>850</td><td>198%â†‘</td></tr><tr><td>å†…å­˜åˆ†é…</td><td>32KB/è¯·æ±‚</td><td>8KB/è¯·æ±‚</td><td>75%â†“</td></tr><tr><td>P99å»¶è¿Ÿ</td><td>750ms</td><td>180ms</td><td>76%â†“</td></tr></tbody></table><h2 id="ğŸ¯-æ€»ç»“"><a class="header-anchor" href="#ğŸ¯-æ€»ç»“"></a>ğŸ¯ æ€»ç»“</h2><p>Goè¯­è¨€çš„å¹¶å‘æ¨¡å‹ç®€æ´è€Œå¼ºå¤§ï¼ŒæŒæ¡å¸¸ç”¨çš„å¹¶å‘æ¨¡å¼å’Œæ€§èƒ½ä¼˜åŒ–æŠ€å·§ï¼Œå¯ä»¥å¸®åŠ©ä½ æ„å»ºçœŸæ­£é«˜æ•ˆçš„Goåº”ç”¨ã€‚</p><h3 id="å…³é”®è¦ç‚¹å›é¡¾"><a class="header-anchor" href="#å…³é”®è¦ç‚¹å›é¡¾"></a>å…³é”®è¦ç‚¹å›é¡¾</h3><ol><li><p><strong>å¹¶å‘æ¨¡å¼</strong>ï¼š</p><ul><li>Worker Poolé€‚åˆå¤„ç†ç‹¬ç«‹ä»»åŠ¡</li><li>Pipelineé€‚åˆæ•°æ®æµå¤„ç†</li><li>Fan-Out/Fan-Iné€‚åˆå¹¶è¡Œå¤„ç†ç“¶é¢ˆé˜¶æ®µ</li><li>è¶…æ—¶å’Œå–æ¶ˆæ¨¡å¼ç¡®ä¿ç¨‹åºè¡Œä¸ºå¯æ§</li></ul></li><li><p><strong>é¿å…å¹¶å‘é™·é˜±</strong>ï¼š</p><ul><li>ä½¿ç”¨é€‚å½“åŒæ­¥æœºåˆ¶ä¿æŠ¤å…±äº«æ•°æ®</li><li>é˜²æ­¢goroutineæ³„æ¼</li><li>é¿å…æ­»é”å’Œç«æ€æ¡ä»¶</li></ul></li><li><p><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼š</p><ul><li>ä½¿ç”¨pprofè¯†åˆ«ç“¶é¢ˆ</li><li>ä¼˜åŒ–å†…å­˜åˆ†é…å’Œå‡å°‘GCå‹åŠ›</li><li>è€ƒè™‘CPUç¼“å­˜å‹å¥½æ€§</li><li>é¿å…è¿‡åº¦ä½¿ç”¨åå°„å’Œinterface{}</li><li>å§‹ç»ˆé€šè¿‡åŸºå‡†æµ‹è¯•éªŒè¯ä¼˜åŒ–</li></ul></li></ol><p>æˆ‘è®¤ä¸ºï¼ŒGoè¯­è¨€çš„å¹¶å‘ç¼–ç¨‹å“²å­¦å¯ä»¥æ€»ç»“ä¸ºï¼šâ€œé€šè¿‡é€šä¿¡å…±äº«å†…å­˜ï¼Œè€Œä¸æ˜¯é€šè¿‡å…±äº«å†…å­˜é€šä¿¡â€ã€‚éµå¾ªè¿™ä¸€åŸåˆ™ï¼Œä½ çš„å¹¶å‘ä»£ç å°†æ›´ç®€æ´ã€æ›´å¥å£®ã€æ›´é«˜æ•ˆã€‚</p><p>å¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–ç»éªŒåˆ†äº«ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®ºï¼</p><hr><p><strong>å‚è€ƒèµ„æ–™</strong>ï¼š</p><ol><li>ã€ŠConcurrency in Goã€‹by Katherine Cox-Buday</li><li>Goå®˜æ–¹åšå®¢: <a href="https://blog.golang.org/">https://blog.golang.org/</a></li><li>Effective Go: <a href="https://golang.org/doc/effective_go.html">https://golang.org/doc/effective_go.html</a></li><li>Uber Go Style Guide: <a href="https://github.com/uber-go/guide">https://github.com/uber-go/guide</a><br>&lt;/rewritten_file&gt;</li></ol>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å¹¶å‘</tag>
      
      <tag>æ€§èƒ½ä¼˜åŒ–</tag>
      
      <tag>goroutine</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ğŸ¤– AI Agentå¼€å‘å®æˆ˜ï¼šä»åŸç†åˆ°åº”ç”¨</title>
    <link href="/2025/02/16/AI%20Agent%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E5%BA%94%E7%94%A8/"/>
    <url>/2025/02/16/AI%20Agent%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E5%BA%94%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1>ğŸ¤– AI Agentå¼€å‘å®æˆ˜ï¼šä»åŸç†åˆ°åº”ç”¨</h1><p>AI Agentï¼ˆæ™ºèƒ½ä»£ç†ï¼‰æ˜¯å¤§æ¨¡å‹åº”ç”¨çš„å‰æ²¿é¢†åŸŸï¼Œå®ƒè®©AIç³»ç»Ÿèƒ½å¤Ÿè§„åˆ’ã€æ¨ç†å¹¶åˆ©ç”¨å·¥å…·å®Œæˆå¤æ‚ä»»åŠ¡ã€‚è¿™ç¯‡æ–‡ç« å°†ç»“åˆæˆ‘çš„å®è·µç»éªŒï¼Œä»åŸç†åˆ°ä»£ç å®ç°ï¼Œåˆ†äº«å¦‚ä½•æ„å»ºæœ‰å®ç”¨ä»·å€¼çš„AI Agentã€‚</p><h2 id="ğŸ“š-ä»€ä¹ˆæ˜¯AI-Agentï¼Ÿ"><a class="header-anchor" href="#ğŸ“š-ä»€ä¹ˆæ˜¯AI-Agentï¼Ÿ"></a>ğŸ“š ä»€ä¹ˆæ˜¯AI Agentï¼Ÿ</h2><p>ç®€å•æ¥è¯´ï¼ŒAI Agentæ˜¯ä¸€ä¸ªèƒ½å¤Ÿ<strong>è‡ªä¸»å†³ç­–å¹¶é‡‡å–è¡ŒåŠ¨</strong>çš„AIç³»ç»Ÿã€‚ä¸ç®€å•çš„é—®ç­”ç³»ç»Ÿä¸åŒï¼ŒAgentå¯ä»¥ï¼š</p><ul><li>åˆ†æå¹¶ç†è§£å¤æ‚ä»»åŠ¡</li><li>åˆ¶å®šè§£å†³é—®é¢˜çš„è®¡åˆ’</li><li>é€šè¿‡è°ƒç”¨å·¥å…·ä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’</li><li>æ ¹æ®åé¦ˆè°ƒæ•´è¡Œä¸º</li></ul><p>è¿™ç§èƒ½åŠ›è®©AIä»å•çº¯çš„&quot;å›ç­”å™¨&quot;å˜æˆäº†èƒ½å¤Ÿå®Œæˆå®é™…ä»»åŠ¡çš„&quot;åŠ©æ‰‹&quot;ã€‚</p><h3 id="Agent-vs-ä¼ ç»ŸAIåº”ç”¨"><a class="header-anchor" href="#Agent-vs-ä¼ ç»ŸAIåº”ç”¨"></a>Agent vs ä¼ ç»ŸAIåº”ç”¨</h3><table><thead><tr><th>ç‰¹ç‚¹</th><th>ä¼ ç»ŸAIåº”ç”¨</th><th>AI Agent</th></tr></thead><tbody><tr><td>è¡Œä¸ºæ¨¡å¼</td><td>è¢«åŠ¨å“åº”</td><td>ä¸»åŠ¨è§„åˆ’</td></tr><tr><td>äº¤äº’æ–¹å¼</td><td>å•è½®æˆ–ç®€å•å¤šè½®</td><td>å¤æ‚å¤šè½®ã€å·¥å…·ä½¿ç”¨</td></tr><tr><td>å†³ç­–èƒ½åŠ›</td><td>ç›´æ¥æ˜ å°„è¾“å…¥åˆ°è¾“å‡º</td><td>å¯ä»¥åˆ¶å®šå’Œè°ƒæ•´è®¡åˆ’</td></tr><tr><td>å¤æ‚åº¦</td><td>ç›¸å¯¹ç®€å•</td><td>å¤æ‚ä¸”çµæ´»</td></tr><tr><td>åº”ç”¨åœºæ™¯</td><td>ç‰¹å®šä»»åŠ¡å›ç­”</td><td>æµç¨‹å‹ä»»åŠ¡æ‰§è¡Œ</td></tr></tbody></table><h2 id="ğŸ§ -Agentçš„æ ¸å¿ƒåŸç†"><a class="header-anchor" href="#ğŸ§ -Agentçš„æ ¸å¿ƒåŸç†"></a>ğŸ§  Agentçš„æ ¸å¿ƒåŸç†</h2><p>è¦ç†è§£AI Agentçš„å·¥ä½œåŸç†ï¼Œæˆ‘ä»¬éœ€è¦ç†Ÿæ‚‰å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š</p><h3 id="1-ReActæ¨¡å¼-Reasoning-Acting"><a class="header-anchor" href="#1-ReActæ¨¡å¼-Reasoning-Acting"></a>1. ReActæ¨¡å¼ (Reasoning + Acting)</h3><p>å¤§å¤šæ•°ç°ä»£Agentéµå¾ªReActæ¨¡å¼ï¼Œå°†æ€è€ƒå’Œè¡ŒåŠ¨ç»“åˆèµ·æ¥ï¼š</p><pre><code class="hljs gcode">è§‚å¯Ÿ<span class="hljs-comment">(Observe)</span> â†’ æ€è€ƒ<span class="hljs-comment">(Think)</span> â†’ è¡ŒåŠ¨<span class="hljs-comment">(Act)</span> â†’ è§‚å¯Ÿæ–°ç»“æœ â†’ ...</code></pre><p>è¿™ä¸ªå¾ªç¯è®©Agentèƒ½å¤Ÿåƒäººç±»ä¸€æ ·ï¼Œè¾¹æ€è€ƒè¾¹è¡ŒåŠ¨ï¼Œå¹¶æ ¹æ®ç»“æœè°ƒæ•´åç»­è¡Œä¸ºã€‚</p><h3 id="2-æç¤ºå·¥ç¨‹æŠ€å·§"><a class="header-anchor" href="#2-æç¤ºå·¥ç¨‹æŠ€å·§"></a>2. æç¤ºå·¥ç¨‹æŠ€å·§</h3><p>æœ‰æ•ˆçš„Agentæç¤ºé€šå¸¸åŒ…å«ä»¥ä¸‹è¦ç´ ï¼š</p><ul><li>æ˜ç¡®çš„è§’è‰²å®šä¹‰</li><li>å¯ç”¨å·¥å…·åˆ—è¡¨åŠå…¶åŠŸèƒ½æè¿°</li><li>ä»»åŠ¡åˆ†è§£æŒ‡å¯¼</li><li>è¾“å‡ºæ ¼å¼è§„èŒƒ</li></ul><p>ä¸€ä¸ªç®€åŒ–çš„Agentæç¤ºæ¨¡æ¿ï¼š</p><pre><code class="hljs ldif">ä½ æ˜¯ä¸€ä¸ªä»»åŠ¡åŠ©æ‰‹ã€‚ä½ å°†è·å¾—ä¸€ä¸ªä»»åŠ¡ï¼Œéœ€è¦è§„åˆ’å¹¶æ‰§è¡Œå®Œæˆå®ƒã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·:<span class="hljs-attribute">1. search_web(query)</span>: æœç´¢äº’è”ç½‘è·å–ä¿¡æ¯<span class="hljs-attribute">2. calculator(expression)</span>: è®¡ç®—æ•°å­¦è¡¨è¾¾å¼<span class="hljs-attribute">3. code_interpreter(code)</span>: æ‰§è¡ŒPythonä»£ç å½“éœ€è¦ä½¿ç”¨å·¥å…·æ—¶ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ ¼å¼:<span class="hljs-attribute">Thought</span>: ä½ çš„æ€è€ƒè¿‡ç¨‹<span class="hljs-attribute">Action</span>: å·¥å…·åç§°<span class="hljs-attribute">Action Input</span>: &#123;å·¥å…·è¾“å…¥å‚æ•°&#125;å·¥å…·å°†è¿”å›ç»“æœï¼Œç„¶åä½ å¯ä»¥ç»§ç»­æ€è€ƒå’Œä½¿ç”¨å·¥å…·ï¼Œç›´åˆ°å®Œæˆä»»åŠ¡ã€‚æœ€ç»ˆå›ç­”åº”ä»¥&quot;Final Answer:&quot;å¼€å¤´ã€‚ä»»åŠ¡: &#123;ç”¨æˆ·ä»»åŠ¡&#125;</code></pre><h3 id="3-å·¥å…·ä½¿ç”¨æ¡†æ¶"><a class="header-anchor" href="#3-å·¥å…·ä½¿ç”¨æ¡†æ¶"></a>3. å·¥å…·ä½¿ç”¨æ¡†æ¶</h3><p>å·¥å…·ä½¿ç”¨æ˜¯Agentçš„æ ¸å¿ƒèƒ½åŠ›ï¼Œä¸»è¦åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li><strong>å·¥å…·å®šä¹‰</strong>ï¼šæè¿°å·¥å…·åŠŸèƒ½å’Œå‚æ•°</li><li><strong>å·¥å…·è°ƒç”¨</strong>ï¼šAgenté€‰æ‹©å¹¶è°ƒç”¨é€‚å½“çš„å·¥å…·</li><li><strong>ç»“æœå¤„ç†</strong>ï¼šè§£æå·¥å…·è¿”å›ç»“æœå¹¶ç»§ç»­ä¸‹ä¸€æ­¥</li></ul><h2 id="ğŸ› ï¸-æ„å»ºAgentçš„æŠ€æœ¯æ ˆ"><a class="header-anchor" href="#ğŸ› ï¸-æ„å»ºAgentçš„æŠ€æœ¯æ ˆ"></a>ğŸ› ï¸ æ„å»ºAgentçš„æŠ€æœ¯æ ˆ</h2><h3 id="åŸºç¡€ç»„ä»¶"><a class="header-anchor" href="#åŸºç¡€ç»„ä»¶"></a>åŸºç¡€ç»„ä»¶</h3><p>ç°ä»£AI Agenté€šå¸¸åŸºäºä»¥ä¸‹ç»„ä»¶æ„å»ºï¼š</p><ol><li><strong>å¤§è¯­è¨€æ¨¡å‹</strong>ï¼šä½œä¸ºAgentçš„&quot;å¤§è„‘&quot;</li><li><strong>å·¥å…·é›†</strong>ï¼šæ‰©å±•Agentçš„èƒ½åŠ›è¾¹ç•Œ</li><li><strong>è®°å¿†ç³»ç»Ÿ</strong>ï¼šå­˜å‚¨å¯¹è¯å†å²å’Œä¸Šä¸‹æ–‡</li><li><strong>è°ƒåº¦å™¨</strong>ï¼šæ§åˆ¶Agentçš„æ‰§è¡Œæµç¨‹</li><li><strong>ç›‘æ§ä¸å®‰å…¨æœºåˆ¶</strong>ï¼šç¡®ä¿Agentè¡Œä¸ºå®‰å…¨å¯æ§</li></ol><h3 id="å¸¸ç”¨æŠ€æœ¯æ¡†æ¶"><a class="header-anchor" href="#å¸¸ç”¨æŠ€æœ¯æ¡†æ¶"></a>å¸¸ç”¨æŠ€æœ¯æ¡†æ¶</h3><p>å‡ ä¸ªæµè¡Œçš„Agentå¼€å‘æ¡†æ¶ï¼š</p><table><thead><tr><th>æ¡†æ¶</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>LangChain</td><td>ç»„ä»¶ä¸°å¯Œï¼Œé«˜åº¦æ¨¡å—åŒ–</td><td>æœ‰ä¸€å®šå­¦ä¹ æ›²çº¿</td><td>å…¨åŠŸèƒ½Agentå¼€å‘</td></tr><tr><td>LlamaIndex</td><td>ä¸“æ³¨äºçŸ¥è¯†æ£€ç´¢å¢å¼º</td><td>AgentåŠŸèƒ½ç›¸å¯¹æœ‰é™</td><td>çŸ¥è¯†å¯†é›†å‹åº”ç”¨</td></tr><tr><td>AutoGPT</td><td>è‡ªä¸»æ€§å¼º</td><td>æ§åˆ¶ç²¾åº¦è¾ƒä½</td><td>æ¢ç´¢æ€§ä»»åŠ¡</td></tr><tr><td>CrewAI</td><td>ä¸“æ³¨å¤šAgentåä½œ</td><td>è¾ƒæ–°ï¼Œæ–‡æ¡£æœ‰é™</td><td>å¤æ‚ä»»åŠ¡åˆ†å·¥</td></tr></tbody></table><p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä¸»è¦ä½¿ç”¨LangChainæ¡†æ¶è¿›è¡Œå®æˆ˜æ¼”ç¤ºã€‚</p><h2 id="ğŸ’»-å®æˆ˜æ¡ˆä¾‹ä¸€ï¼šæ„å»ºåŸºç¡€Agent"><a class="header-anchor" href="#ğŸ’»-å®æˆ˜æ¡ˆä¾‹ä¸€ï¼šæ„å»ºåŸºç¡€Agent"></a>ğŸ’» å®æˆ˜æ¡ˆä¾‹ä¸€ï¼šæ„å»ºåŸºç¡€Agent</h2><p>è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„Agentå¼€å§‹ï¼Œå®ƒå¯ä»¥å›ç­”é—®é¢˜ã€æœç´¢ä¿¡æ¯å’Œæ‰§è¡ŒåŸºæœ¬è®¡ç®—ï¼š</p><h3 id="ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡"><a class="header-anchor" href="#ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡"></a>ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡</h3><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span>python -m venv agent-env<span class="hljs-built_in">source</span> agent-env/bin/activate  <span class="hljs-comment"># Linux/Mac</span><span class="hljs-comment"># agent-env\Scripts\activate    # Windows</span><span class="hljs-comment"># å®‰è£…ä¾èµ–åŒ…</span>pip install langchain langchain-openai pydantic python-dotenv</code></pre><h3 id="ç¬¬äºŒæ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡"><a class="header-anchor" href="#ç¬¬äºŒæ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡"></a>ç¬¬äºŒæ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡</h3><pre><code class="hljs python"><span class="hljs-comment"># .env æ–‡ä»¶</span>OPENAI_API_KEY=your_openai_api_keySERPAPI_API_KEY=your_serpapi_key  <span class="hljs-comment"># ç”¨äºç½‘ç»œæœç´¢</span></code></pre><h3 id="ç¬¬ä¸‰æ­¥ï¼šå®šä¹‰å·¥å…·"><a class="header-anchor" href="#ç¬¬ä¸‰æ­¥ï¼šå®šä¹‰å·¥å…·"></a>ç¬¬ä¸‰æ­¥ï¼šå®šä¹‰å·¥å…·</h3><pre><code class="hljs python"><span class="hljs-comment"># tools.py</span><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> BaseTool, StructuredTool<span class="hljs-keyword">from</span> langchain.callbacks.manager <span class="hljs-keyword">import</span> CallbackManagerForToolRun<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Optional, Type<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field<span class="hljs-keyword">import</span> math<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CalculatorInput</span>(<span class="hljs-params">BaseModel</span>):</span>    expression: str = Field(description=<span class="hljs-string">&quot;æ•°å­¦è¡¨è¾¾å¼ï¼Œå¦‚ &#x27;2 + 2&#x27; æˆ– &#x27;sin(30)&#x27;&quot;</span>)<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Calculator</span>(<span class="hljs-params">BaseTool</span>):</span>    name = <span class="hljs-string">&quot;calculator&quot;</span>    description = <span class="hljs-string">&quot;ç”¨äºè®¡ç®—æ•°å­¦è¡¨è¾¾å¼&quot;</span>    args_schema: Type[BaseModel] = CalculatorInput        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_run</span>(<span class="hljs-params">self, expression: str, run_manager: Optional[CallbackManagerForToolRun] = None</span>) -&gt; str:</span>        <span class="hljs-keyword">try</span>:            <span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªå®‰å…¨çš„å±€éƒ¨ç¯å¢ƒï¼ŒåªåŒ…å«åŸºæœ¬æ•°å­¦å‡½æ•°</span>            safe_locals = &#123;                <span class="hljs-string">&#x27;sin&#x27;</span>: math.sin,                <span class="hljs-string">&#x27;cos&#x27;</span>: math.cos,                <span class="hljs-string">&#x27;tan&#x27;</span>: math.tan,                <span class="hljs-string">&#x27;sqrt&#x27;</span>: math.sqrt,                <span class="hljs-string">&#x27;pi&#x27;</span>: math.pi,                <span class="hljs-string">&#x27;e&#x27;</span>: math.e            &#125;                        <span class="hljs-comment"># è®¡ç®—è¡¨è¾¾å¼</span>            result = eval(expression, &#123;<span class="hljs-string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;, safe_locals)            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;è¡¨è¾¾å¼ &#x27;<span class="hljs-subst">&#123;expression&#125;</span>&#x27; çš„è®¡ç®—ç»“æœæ˜¯: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;è®¡ç®—è¡¨è¾¾å¼æ—¶å‡ºé”™: <span class="hljs-subst">&#123;str(e)&#125;</span>&quot;</span><span class="hljs-comment"># æ›´å¤šå·¥å…·å®šä¹‰...</span></code></pre><h3 id="ç¬¬å››æ­¥ï¼šæ„å»ºAgent"><a class="header-anchor" href="#ç¬¬å››æ­¥ï¼šæ„å»ºAgent"></a>ç¬¬å››æ­¥ï¼šæ„å»ºAgent</h3><pre><code class="hljs python"><span class="hljs-comment"># agent.py</span><span class="hljs-keyword">import</span> os<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> initialize_agent, AgentType<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> ChatOpenAI<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> DuckDuckGoSearchRun<span class="hljs-comment"># å¯¼å…¥æˆ‘ä»¬çš„è‡ªå®šä¹‰å·¥å…·</span><span class="hljs-keyword">from</span> tools <span class="hljs-keyword">import</span> Calculator<span class="hljs-comment"># åŠ è½½ç¯å¢ƒå˜é‡</span>load_dotenv()<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_assistant</span>():</span>    <span class="hljs-comment"># åˆå§‹åŒ–LLM</span>    llm = ChatOpenAI(        model=<span class="hljs-string">&quot;gpt-4-turbo&quot;</span>,        temperature=<span class="hljs-number">0</span>,  <span class="hljs-comment"># ä½¿ç”¨ç¡®å®šæ€§è¾“å‡º</span>    )        <span class="hljs-comment"># åˆå§‹åŒ–å·¥å…·</span>    search_tool = DuckDuckGoSearchRun()    calculator_tool = Calculator()        tools = [search_tool, calculator_tool]        <span class="hljs-comment"># åˆ›å»ºAgent</span>    agent = initialize_agent(        tools=tools,        llm=llm,        agent=AgentType.CHAT_CONVERSATIONAL_REACT_DESCRIPTION,        verbose=<span class="hljs-literal">True</span>,        handle_parsing_errors=<span class="hljs-literal">True</span>,        max_iterations=<span class="hljs-number">10</span>,  <span class="hljs-comment"># é˜²æ­¢æ— é™å¾ªç¯</span>    )        <span class="hljs-comment"># è‡ªå®šä¹‰ç³»ç»Ÿæ¶ˆæ¯</span>    system_message = <span class="hljs-string">&quot;&quot;&quot;</span><span class="hljs-string">    ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥å›ç­”é—®é¢˜ã€æœç´¢ä¿¡æ¯å’Œæ‰§è¡Œè®¡ç®—ã€‚</span><span class="hljs-string">    å¯¹äºä¸ç¡®å®šçš„é—®é¢˜ï¼Œè¯·ä½¿ç”¨æœç´¢å·¥å…·è·å–æœ€æ–°ä¿¡æ¯ã€‚</span><span class="hljs-string">    å¯¹äºéœ€è¦è®¡ç®—çš„é—®é¢˜ï¼Œè¯·ä½¿ç”¨è®¡ç®—å™¨å·¥å…·ã€‚</span><span class="hljs-string">    è¯·å…ˆæ€è€ƒé—®é¢˜éœ€è¦å“ªäº›ä¿¡æ¯æˆ–è®¡ç®—ï¼Œç„¶åé€‰æ‹©åˆé€‚çš„å·¥å…·ã€‚</span><span class="hljs-string">    &quot;&quot;&quot;</span>        agent.agent.llm_chain.prompt.messages[<span class="hljs-number">0</span>].prompt.template = system_message        <span class="hljs-keyword">return</span> agent<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:    agent = create_assistant()        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:        query = input(<span class="hljs-string">&quot;\nè¯·è¾“å…¥æ‚¨çš„é—®é¢˜ (è¾“å…¥&#x27;quit&#x27;é€€å‡º): &quot;</span>)        <span class="hljs-keyword">if</span> query.lower() == <span class="hljs-string">&quot;quit&quot;</span>:            <span class="hljs-keyword">break</span>                    response = agent.run(input=query)        print(<span class="hljs-string">f&quot;\nå›ç­”: <span class="hljs-subst">&#123;response&#125;</span>&quot;</span>)</code></pre><h3 id="ç¬¬äº”æ­¥ï¼šè¿è¡Œä¸æµ‹è¯•"><a class="header-anchor" href="#ç¬¬äº”æ­¥ï¼šè¿è¡Œä¸æµ‹è¯•"></a>ç¬¬äº”æ­¥ï¼šè¿è¡Œä¸æµ‹è¯•</h3><pre><code class="hljs python"><span class="hljs-comment"># è¿è¡Œç¤ºä¾‹</span>python agent.py<span class="hljs-comment"># ç¤ºä¾‹é—®é¢˜:</span><span class="hljs-comment"># 1. è®¡ç®—åœ°çƒåˆ°æœˆçƒçš„è·ç¦»é™¤ä»¥å…‰é€Ÿéœ€è¦å¤šå°‘ç§’?</span><span class="hljs-comment"># 2. 2023å¹´ä¸–ç•Œæ¯å† å†›æ˜¯å“ªä¸ªå›½å®¶?</span><span class="hljs-comment"># 3. è§£é‡Šé‡å­è®¡ç®—çš„åŸºæœ¬åŸç†</span></code></pre><p>åœ¨è¿™ä¸ªåŸºç¡€Agentä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š</p><ul><li>è‡ªå®šä¹‰å·¥å…·é›†æˆ</li><li>æœç´¢å¼•æ“æŸ¥è¯¢</li><li>ç®€å•çš„Agentå¾ªç¯æ§åˆ¶</li><li>ç”¨æˆ·å‹å¥½çš„äº¤äº’ç•Œé¢</li></ul><h2 id="ğŸ”„-å®æˆ˜æ¡ˆä¾‹äºŒï¼šå¤šæ­¥éª¤ä»»åŠ¡Agent"><a class="header-anchor" href="#ğŸ”„-å®æˆ˜æ¡ˆä¾‹äºŒï¼šå¤šæ­¥éª¤ä»»åŠ¡Agent"></a>ğŸ”„ å®æˆ˜æ¡ˆä¾‹äºŒï¼šå¤šæ­¥éª¤ä»»åŠ¡Agent</h2><p>åŸºç¡€Agentåªèƒ½å¤„ç†ç®€å•æŸ¥è¯¢ï¼Œç°åœ¨è®©æˆ‘ä»¬æ„å»ºä¸€ä¸ªèƒ½å¤„ç†å¤šæ­¥éª¤ä»»åŠ¡çš„Agentã€‚è¿™ä¸ªAgentå¯ä»¥ï¼š</p><ol><li>åˆ†æå¤æ‚ä»»åŠ¡</li><li>åˆ†è§£ä¸ºå­ä»»åŠ¡</li><li>é¡ºåºæ‰§è¡Œå­ä»»åŠ¡</li><li>æ•´åˆç»“æœæä¾›æœ€ç»ˆç­”æ¡ˆ</li></ol><p>è¿™ç±»Agentç‰¹åˆ«é€‚åˆå¤„ç†éœ€è¦å¤šä¸ªæ­¥éª¤çš„å·¥ä½œæµç¨‹ã€‚</p><h3 id="ä½¿ç”¨LangChainçš„PLAN-AND-EXECUTEä»£ç†"><a class="header-anchor" href="#ä½¿ç”¨LangChainçš„PLAN-AND-EXECUTEä»£ç†"></a>ä½¿ç”¨LangChainçš„PLAN_AND_EXECUTEä»£ç†</h3><pre><code class="hljs python"><span class="hljs-comment"># advanced_agent.py</span><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_plan_and_execute_agent<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> ChatOpenAI<span class="hljs-keyword">from</span> langchain_community.tools.tavily_search <span class="hljs-keyword">import</span> TavilySearchResults<span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> Tool<span class="hljs-comment"># åˆå§‹åŒ–LLM</span>llm = ChatOpenAI(model=<span class="hljs-string">&quot;gpt-4-turbo&quot;</span>, temperature=<span class="hljs-number">0</span>)<span class="hljs-comment"># å®šä¹‰æ›´å¤šå·¥å…·</span>search = TavilySearchResults(max_results=<span class="hljs-number">3</span>)<span class="hljs-comment"># è‡ªå®šä¹‰å·¥å…·ï¼šæ•°æ®åˆ†æ</span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">analyze_data</span>(<span class="hljs-params">data_description</span>):</span>    <span class="hljs-comment"># è¿™é‡Œæ˜¯ç®€åŒ–å®ç°ï¼Œå®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦è°ƒç”¨æ•°æ®åˆ†æåº“</span>    <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;åˆ†æç»“æœ: å·²å®Œæˆå¯¹ &#x27;<span class="hljs-subst">&#123;data_description&#125;</span>&#x27; çš„åŸºç¡€ç»Ÿè®¡åˆ†æ&quot;</span><span class="hljs-comment"># è‡ªå®šä¹‰å·¥å…·ï¼šç”ŸæˆæŠ¥å‘Š</span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_report</span>(<span class="hljs-params">analysis_results, report_type=<span class="hljs-string">&quot;summary&quot;</span></span>):</span>    <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;å·²ç”Ÿæˆ <span class="hljs-subst">&#123;report_type&#125;</span> æŠ¥å‘Šï¼ŒåŸºäºåˆ†æ: <span class="hljs-subst">&#123;analysis_results&#125;</span>&quot;</span><span class="hljs-comment"># ç»„è£…å·¥å…·é›†</span>tools = [    Tool(        name=<span class="hljs-string">&quot;web_search&quot;</span>,        func=search.run,        description=<span class="hljs-string">&quot;å½“ä½ éœ€è¦æŸ¥æ‰¾æœ€æ–°ä¿¡æ¯æ—¶ä½¿ç”¨è¿™ä¸ªå·¥å…·ã€‚è¾“å…¥åº”è¯¥æ˜¯ä¸€ä¸ªæœç´¢æŸ¥è¯¢ã€‚&quot;</span>    ),    Tool(        name=<span class="hljs-string">&quot;data_analysis&quot;</span>,        func=analyze_data,        description=<span class="hljs-string">&quot;ç”¨äºåˆ†ææ•°æ®é›†ã€‚è¾“å…¥åº”è¯¥æ˜¯å¯¹æ•°æ®çš„æè¿°ã€‚&quot;</span>    ),    Tool(        name=<span class="hljs-string">&quot;report_generator&quot;</span>,        func=generate_report,        description=<span class="hljs-string">&quot;ç”ŸæˆåŸºäºåˆ†æç»“æœçš„æŠ¥å‘Šã€‚è¾“å…¥æ ¼å¼ä¸º: &#x27;åˆ†æç»“æœ,æŠ¥å‘Šç±»å‹&#x27;ã€‚&quot;</span>    )]<span class="hljs-comment"># åˆ›å»ºè§„åˆ’æ‰§è¡Œå‹Agent</span>agent = create_plan_and_execute_agent(llm, tools, verbose=<span class="hljs-literal">True</span>)<span class="hljs-comment"># è¿è¡ŒAgentå¤„ç†å¤æ‚ä»»åŠ¡</span>task = <span class="hljs-string">&quot;&quot;&quot;</span><span class="hljs-string">ä¸ºæˆ‘åˆ†æ2023å¹´å…¨çƒç”µåŠ¨æ±½è½¦é”€å”®è¶‹åŠ¿ï¼Œå¹¶ç”Ÿæˆä¸€ä»½åŒ…å«ä¸»è¦å¸‚åœºã€å¢é•¿ç‡å’Œä¸»è¦åˆ¶é€ å•†çš„ç®€æŠ¥ã€‚</span><span class="hljs-string">&quot;&quot;&quot;</span>result = agent.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: task&#125;)print(result[<span class="hljs-string">&quot;output&quot;</span>])</code></pre><h3 id="PLAN-AND-EXECUTEä»£ç†å·¥ä½œæµç¨‹"><a class="header-anchor" href="#PLAN-AND-EXECUTEä»£ç†å·¥ä½œæµç¨‹"></a>PLAN_AND_EXECUTEä»£ç†å·¥ä½œæµç¨‹</h3><p>è¿™ç§ä»£ç†é¦–å…ˆåˆ¶å®šä¸€ä¸ªè®¡åˆ’ï¼Œç„¶åæŒ‰æ­¥æ‰§è¡Œï¼š</p><pre><code class="hljs angelscript">è®¡åˆ’é˜¶æ®µ:<span class="hljs-number">1.</span> æœç´¢<span class="hljs-number">2023</span>å¹´å…¨çƒç”µåŠ¨æ±½è½¦é”€å”®æ•°æ®<span class="hljs-number">2.</span> åˆ†æé”€å”®æ•°æ®ä»¥æå–å…³é”®è¶‹åŠ¿<span class="hljs-number">3.</span> è¯†åˆ«ä¸»è¦å¸‚åœºå’Œå¢é•¿ç‡<span class="hljs-number">4.</span> ç¡®å®šä¸»è¦ç”µåŠ¨æ±½è½¦åˆ¶é€ å•†<span class="hljs-number">5.</span> ç”ŸæˆåŒ…å«æ‰€æœ‰ä¿¡æ¯çš„ç®€æŠ¥æ‰§è¡Œé˜¶æ®µ:[æ‰§è¡Œæ­¥éª¤<span class="hljs-number">1</span>] ä½¿ç”¨web_searchå·¥å…·æœç´¢æ•°æ®...[æ‰§è¡Œæ­¥éª¤<span class="hljs-number">2</span>] ä½¿ç”¨data_analysiså·¥å…·åˆ†ææ•°æ®......ä¾æ­¤ç±»æ¨</code></pre><h2 id="ğŸ§©-å®æˆ˜æ¡ˆä¾‹ä¸‰ï¼šæ„å»ºä¸“ä¸šé¢†åŸŸAgent"><a class="header-anchor" href="#ğŸ§©-å®æˆ˜æ¡ˆä¾‹ä¸‰ï¼šæ„å»ºä¸“ä¸šé¢†åŸŸAgent"></a>ğŸ§© å®æˆ˜æ¡ˆä¾‹ä¸‰ï¼šæ„å»ºä¸“ä¸šé¢†åŸŸAgent</h2><p>é€šç”¨Agentå¾ˆå¼ºå¤§ï¼Œä½†ä¸“æ³¨äºç‰¹å®šé¢†åŸŸçš„Agentå¾€å¾€æ›´å®ç”¨ã€‚ä¸‹é¢æˆ‘ä»¬æ„å»ºä¸€ä¸ªä¸“æ³¨äºç¼–ç¨‹è¾…åŠ©çš„Agentï¼š</p><h3 id="ä»£ç åŠ©æ‰‹Agent"><a class="header-anchor" href="#ä»£ç åŠ©æ‰‹Agent"></a>ä»£ç åŠ©æ‰‹Agent</h3><pre><code class="hljs python"><span class="hljs-comment"># code_agent.py</span><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> initialize_agent, AgentType<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> ChatOpenAI<span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> Tool<span class="hljs-keyword">from</span> langchain.utilities <span class="hljs-keyword">import</span> PythonREPL<span class="hljs-keyword">import</span> subprocess<span class="hljs-keyword">import</span> tempfile<span class="hljs-keyword">import</span> os<span class="hljs-comment"># åˆå§‹åŒ–Python REPLå·¥å…·</span>python_repl = PythonREPL()<span class="hljs-comment"># ä»£ç è§£é‡Šå·¥å…·</span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">explain_code</span>(<span class="hljs-params">code_snippet</span>):</span>    <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;è¿™æ®µä»£ç çš„åŠŸèƒ½æ˜¯: [ä»£ç è§£é‡Šç»“æœ]&quot;</span>  <span class="hljs-comment"># å®é™…ä¸­å¯è°ƒç”¨LLMç”Ÿæˆè§£é‡Š</span><span class="hljs-comment"># ä»£ç æ‰§è¡Œå·¥å…·ï¼ˆå®‰å…¨ç‰ˆæœ¬ï¼‰</span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute_code_safely</span>(<span class="hljs-params">code</span>):</span>    <span class="hljs-keyword">try</span>:        <span class="hljs-comment"># åˆ›å»ºä¸´æ—¶æ–‡ä»¶</span>        <span class="hljs-keyword">with</span> tempfile.NamedTemporaryFile(suffix=<span class="hljs-string">&#x27;.py&#x27;</span>, delete=<span class="hljs-literal">False</span>) <span class="hljs-keyword">as</span> f:            f.write(code.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))            temp_file_name = f.name                <span class="hljs-comment"># åœ¨å­è¿›ç¨‹ä¸­æ‰§è¡Œä»£ç ï¼Œè®¾ç½®è¶…æ—¶</span>        result = subprocess.run(            [<span class="hljs-string">&#x27;python&#x27;</span>, temp_file_name],            capture_output=<span class="hljs-literal">True</span>,            text=<span class="hljs-literal">True</span>,            timeout=<span class="hljs-number">5</span>  <span class="hljs-comment"># 5ç§’è¶…æ—¶</span>        )                <span class="hljs-comment"># æ¸…ç†ä¸´æ—¶æ–‡ä»¶</span>        os.unlink(temp_file_name)                <span class="hljs-comment"># è¿”å›æ‰§è¡Œç»“æœ</span>        <span class="hljs-keyword">if</span> result.returncode == <span class="hljs-number">0</span>:            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;ä»£ç æ‰§è¡ŒæˆåŠŸ:\n<span class="hljs-subst">&#123;result.stdout&#125;</span>&quot;</span>        <span class="hljs-keyword">else</span>:            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;ä»£ç æ‰§è¡Œé”™è¯¯:\n<span class="hljs-subst">&#123;result.stderr&#125;</span>&quot;</span>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;æ‰§è¡Œå‡ºç°å¼‚å¸¸: <span class="hljs-subst">&#123;str(e)&#125;</span>&quot;</span><span class="hljs-comment"># ä»£ç ä¼˜åŒ–å·¥å…·</span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">optimize_code</span>(<span class="hljs-params">code_snippet</span>):</span>    <span class="hljs-comment"># å®é™…ä½¿ç”¨ä¸­å¯è°ƒç”¨ä¸“é—¨çš„ä»£ç ä¼˜åŒ–LLM</span>    <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;ä¼˜åŒ–åçš„ä»£ç :\n```python\n<span class="hljs-subst">&#123;code_snippet&#125;</span>\n```&quot;</span><span class="hljs-comment"># å®šä¹‰å·¥å…·é›†</span>tools = [    Tool(        name=<span class="hljs-string">&quot;python_repl&quot;</span>,        func=python_repl.run,        description=<span class="hljs-string">&quot;ç”¨äºæ‰§è¡ŒPythonä»£ç å¹¶è·å–ç»“æœçš„Python REPLã€‚&quot;</span>    ),    Tool(        name=<span class="hljs-string">&quot;explain_code&quot;</span>,        func=explain_code,        description=<span class="hljs-string">&quot;è§£é‡Šä¸€æ®µä»£ç çš„åŠŸèƒ½å’Œå·¥ä½œåŸç†ã€‚&quot;</span>    ),    Tool(        name=<span class="hljs-string">&quot;execute_code_safely&quot;</span>,        func=execute_code_safely,        description=<span class="hljs-string">&quot;å®‰å…¨åœ°æ‰§è¡ŒPythonä»£ç ï¼Œå¹¶è¿”å›ç»“æœæˆ–é”™è¯¯ä¿¡æ¯ã€‚&quot;</span>    ),    Tool(        name=<span class="hljs-string">&quot;optimize_code&quot;</span>,        func=optimize_code,        description=<span class="hljs-string">&quot;ä¼˜åŒ–æä¾›çš„ä»£ç ï¼Œæé«˜å…¶æ•ˆç‡æˆ–å¯è¯»æ€§ã€‚&quot;</span>    )]<span class="hljs-comment"># åˆ›å»ºå¯¹è¯è®°å¿†</span>memory = ConversationBufferMemory(memory_key=<span class="hljs-string">&quot;chat_history&quot;</span>, return_messages=<span class="hljs-literal">True</span>)<span class="hljs-comment"># åˆå§‹åŒ–LLM</span>llm = ChatOpenAI(model=<span class="hljs-string">&quot;gpt-4-turbo&quot;</span>, temperature=<span class="hljs-number">0</span>)<span class="hljs-comment"># åˆ›å»ºAgent</span>agent = initialize_agent(    tools,    llm,    agent=AgentType.CHAT_CONVERSATIONAL_REACT_DESCRIPTION,    memory=memory,    verbose=<span class="hljs-literal">True</span>)<span class="hljs-comment"># è‡ªå®šä¹‰ç³»ç»Ÿæç¤º</span>system_message = <span class="hljs-string">&quot;&quot;&quot;</span><span class="hljs-string">ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–ç¨‹åŠ©æ‰‹ï¼Œä¸“æ³¨äºå¸®åŠ©ç”¨æˆ·ç¼–å†™ã€ç†è§£å’Œä¼˜åŒ–Pythonä»£ç ã€‚</span><span class="hljs-string"></span><span class="hljs-string">å·¥ä½œæµç¨‹æŒ‡å—:</span><span class="hljs-string">1. å½“ç”¨æˆ·è¯·æ±‚ç¼–å†™ä»£ç æ—¶ï¼Œç”Ÿæˆé«˜è´¨é‡ã€ç¬¦åˆPEP8è§„èŒƒçš„Pythonä»£ç </span><span class="hljs-string">2. å½“ç”¨æˆ·è¦æ±‚è§£é‡Šä»£ç æ—¶ï¼Œä½¿ç”¨explain_codeå·¥å…·æä¾›æ¸…æ™°è§£é‡Š</span><span class="hljs-string">3. å½“éœ€è¦æµ‹è¯•ä»£ç æ—¶ï¼Œä½¿ç”¨execute_code_safelyå·¥å…·å®‰å…¨æ‰§è¡Œ</span><span class="hljs-string">4. å½“ç”¨æˆ·è¦æ±‚ä¼˜åŒ–ä»£ç æ—¶ï¼Œä½¿ç”¨optimize_codeå·¥å…·</span><span class="hljs-string"></span><span class="hljs-string">å§‹ç»ˆä¼˜å…ˆè€ƒè™‘ä»£ç çš„:</span><span class="hljs-string">- æ­£ç¡®æ€§</span><span class="hljs-string">- æ•ˆç‡</span><span class="hljs-string">- å¯è¯»æ€§</span><span class="hljs-string">- å®‰å…¨æ€§</span><span class="hljs-string"></span><span class="hljs-string">åœ¨å›ç­”ä¸­ï¼Œå…ˆç®€è¦è§£é‡Šä»£ç çš„åŠŸèƒ½å’Œé€»è¾‘ï¼Œå†æä¾›ä»£ç ã€‚</span><span class="hljs-string">&quot;&quot;&quot;</span><span class="hljs-comment"># è®¾ç½®Agentçš„ç³»ç»Ÿæ¶ˆæ¯</span>agent.agent.llm_chain.prompt.messages[<span class="hljs-number">0</span>].prompt.template = system_message<span class="hljs-comment"># äº¤äº’å¼æµ‹è¯•</span><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:    print(<span class="hljs-string">&quot;Pythonç¼–ç¨‹åŠ©æ‰‹å·²å¯åŠ¨ã€‚è¾“å…¥&#x27;quit&#x27;é€€å‡ºã€‚&quot;</span>)    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:        query = input(<span class="hljs-string">&quot;\nè¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–ä»£ç éœ€æ±‚: &quot;</span>)        <span class="hljs-keyword">if</span> query.lower() == <span class="hljs-string">&quot;quit&quot;</span>:            <span class="hljs-keyword">break</span>                    response = agent.run(input=query)        print(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;response&#125;</span>&quot;</span>)</code></pre><h3 id="ä¸“ä¸šé¢†åŸŸAgentçš„å…³é”®ç‚¹"><a class="header-anchor" href="#ä¸“ä¸šé¢†åŸŸAgentçš„å…³é”®ç‚¹"></a>ä¸“ä¸šé¢†åŸŸAgentçš„å…³é”®ç‚¹</h3><ol><li><strong>å·¥å…·ä¸“ä¸šåŒ–</strong>ï¼šæä¾›é¢†åŸŸç‰¹å®šå·¥å…·</li><li><strong>ä»»åŠ¡èšç„¦</strong>ï¼šæ˜ç¡®Agentçš„èŒè´£è¾¹ç•Œ</li><li><strong>ä¸“ä¸šçŸ¥è¯†æ³¨å…¥</strong>ï¼šé€šè¿‡ç³»ç»Ÿæç¤ºæä¾›é¢†åŸŸçŸ¥è¯†</li><li><strong>å®‰å…¨æ€§è€ƒè™‘</strong>ï¼šç‰¹åˆ«æ˜¯æ‰§è¡Œä»£ç ç­‰æ•æ„Ÿæ“ä½œæ—¶</li></ol><h2 id="ğŸ”§-å®æˆ˜æ¡ˆä¾‹å››ï¼šå¸¦æœ‰è‡ªå®šä¹‰UIçš„Agentåº”ç”¨"><a class="header-anchor" href="#ğŸ”§-å®æˆ˜æ¡ˆä¾‹å››ï¼šå¸¦æœ‰è‡ªå®šä¹‰UIçš„Agentåº”ç”¨"></a>ğŸ”§ å®æˆ˜æ¡ˆä¾‹å››ï¼šå¸¦æœ‰è‡ªå®šä¹‰UIçš„Agentåº”ç”¨</h2><p>å‰é¢çš„ä¾‹å­éƒ½æ˜¯å‘½ä»¤è¡Œäº¤äº’ï¼Œç°åœ¨æˆ‘ä»¬æ„å»ºä¸€ä¸ªå¸¦æœ‰Webç•Œé¢çš„Agentåº”ç”¨ã€‚è¿™é‡Œä½¿ç”¨Gradioæ¡†æ¶å¿«é€Ÿæ­å»ºä¸€ä¸ªç®€å•ç•Œé¢ï¼š</p><pre><code class="hljs python"><span class="hljs-comment"># agent_webapp.py</span><span class="hljs-keyword">import</span> gradio <span class="hljs-keyword">as</span> gr<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> initialize_agent, AgentType<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> ChatOpenAI<span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> SystemMessage<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> DuckDuckGoSearchRun<span class="hljs-comment"># åˆå§‹åŒ–ç»„ä»¶</span>llm = ChatOpenAI(model=<span class="hljs-string">&quot;gpt-4-turbo&quot;</span>, temperature=<span class="hljs-number">0.7</span>)search = DuckDuckGoSearchRun()memory = ConversationBufferMemory(memory_key=<span class="hljs-string">&quot;chat_history&quot;</span>, return_messages=<span class="hljs-literal">True</span>)<span class="hljs-comment"># å®šä¹‰å·¥å…·</span>tools = [    Tool(        name=<span class="hljs-string">&quot;web_search&quot;</span>,        func=search.run,        description=<span class="hljs-string">&quot;æœç´¢äº’è”ç½‘è·å–æœ€æ–°ä¿¡æ¯&quot;</span>    )]<span class="hljs-comment"># åˆ›å»ºAgent</span>agent = initialize_agent(    tools,    llm,    agent=AgentType.CHAT_CONVERSATIONAL_REACT_DESCRIPTION,    memory=memory,    verbose=<span class="hljs-literal">True</span>)<span class="hljs-comment"># è‡ªå®šä¹‰ç³»ç»Ÿæ¶ˆæ¯</span>system_msg = <span class="hljs-string">&quot;&quot;&quot;</span><span class="hljs-string">ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥å›ç­”ç”¨æˆ·é—®é¢˜å¹¶æœç´¢äº’è”ç½‘è·å–ä¿¡æ¯ã€‚</span><span class="hljs-string">å½“ä½ ä¸ç¡®å®šæˆ–éœ€è¦æœ€æ–°ä¿¡æ¯æ—¶ï¼Œè¯·ä½¿ç”¨æœç´¢å·¥å…·ã€‚</span><span class="hljs-string">å›ç­”è¦ç®€æ´ã€å‡†ç¡®ï¼Œå¹¶æ ‡æ˜ä¿¡æ¯æ¥æºã€‚</span><span class="hljs-string">&quot;&quot;&quot;</span>agent.agent.llm_chain.prompt.messages[<span class="hljs-number">0</span>].prompt.template = system_msg<span class="hljs-comment"># å¤„ç†å‡½æ•°</span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_query</span>(<span class="hljs-params">message, history</span>):</span>    <span class="hljs-comment"># è®°å½•å¯¹è¯å†å²</span>    <span class="hljs-keyword">if</span> history:        <span class="hljs-keyword">for</span> human, ai <span class="hljs-keyword">in</span> history:            memory.chat_memory.add_user_message(human)            memory.chat_memory.add_ai_message(ai)        <span class="hljs-comment"># è°ƒç”¨Agentå¤„ç†æ¶ˆæ¯</span>    response = agent.run(input=message)        <span class="hljs-comment"># æ¸…ç†å“åº”ä¸­å¯èƒ½çš„å·¥å…·è°ƒç”¨æ ¼å¼</span>    cleaned_response = response.replace(<span class="hljs-string">&quot;Action:&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-string">&quot;Action Input:&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-string">&quot;Observation:&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-string">&quot;Thought:&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)        <span class="hljs-keyword">return</span> cleaned_response<span class="hljs-comment"># åˆ›å»ºGradioç•Œé¢</span>demo = gr.ChatInterface(    process_query,    title=<span class="hljs-string">&quot;AIæ™ºèƒ½åŠ©æ‰‹&quot;</span>,    description=<span class="hljs-string">&quot;æˆ‘å¯ä»¥å›ç­”é—®é¢˜å¹¶æœç´¢äº’è”ç½‘è·å–æœ€æ–°ä¿¡æ¯ã€‚è¯·è¾“å…¥æ‚¨çš„é—®é¢˜:&quot;</span>,    theme=<span class="hljs-string">&quot;soft&quot;</span>,    examples=[        <span class="hljs-string">&quot;2024å¹´çš„çƒ­é—¨AIæŠ€æœ¯è¶‹åŠ¿æœ‰å“ªäº›?&quot;</span>,        <span class="hljs-string">&quot;Pythonå’ŒGoè¯­è¨€å“ªä¸ªæ›´é€‚åˆå¾®æœåŠ¡å¼€å‘?&quot;</span>,        <span class="hljs-string">&quot;å¦‚ä½•å¼€å§‹å­¦ä¹ AI Agentå¼€å‘?&quot;</span>    ])<span class="hljs-comment"># å¯åŠ¨åº”ç”¨</span><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:    demo.launch()</code></pre><h2 id="ğŸ“ˆ-æ‰©å±•ä¸é«˜çº§åŠŸèƒ½"><a class="header-anchor" href="#ğŸ“ˆ-æ‰©å±•ä¸é«˜çº§åŠŸèƒ½"></a>ğŸ“ˆ æ‰©å±•ä¸é«˜çº§åŠŸèƒ½</h2><p>éšç€å¼€å‘çš„æ·±å…¥ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºAgentæ·»åŠ æ›´é«˜çº§çš„åŠŸèƒ½ï¼š</p><h3 id="1-è®°å¿†ç³»ç»Ÿå¢å¼º"><a class="header-anchor" href="#1-è®°å¿†ç³»ç»Ÿå¢å¼º"></a>1. è®°å¿†ç³»ç»Ÿå¢å¼º</h3><p>åŸºæœ¬è®°å¿†åªå­˜å‚¨å¯¹è¯å†å²ï¼Œå¯ä»¥æ‰©å±•ä¸ºï¼š</p><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationSummaryMemory<span class="hljs-comment"># æ‘˜è¦è®°å¿†ï¼šè‡ªåŠ¨æ€»ç»“é•¿å¯¹è¯</span>summary_memory = ConversationSummaryMemory(    llm=llm,    memory_key=<span class="hljs-string">&quot;chat_history&quot;</span>,    return_messages=<span class="hljs-literal">True</span>)<span class="hljs-comment"># å‘é‡å­˜å‚¨è®°å¿†ï¼šåŸºäºè¯­ä¹‰ç›¸ä¼¼æ€§æ£€ç´¢</span><span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> VectorStoreRetrieverMemory<span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> FAISS<span class="hljs-keyword">from</span> langchain.embeddings <span class="hljs-keyword">import</span> OpenAIEmbeddings<span class="hljs-comment"># åˆå§‹åŒ–å‘é‡å­˜å‚¨</span>embeddings = OpenAIEmbeddings()vectorstore = FAISS.from_texts([<span class="hljs-string">&quot;&quot;</span>], embedding=embeddings)retriever = vectorstore.as_retriever(search_kwargs=dict(k=<span class="hljs-number">5</span>))<span class="hljs-comment"># åˆ›å»ºå‘é‡è®°å¿†</span>vector_memory = VectorStoreRetrieverMemory(retriever=retriever)</code></pre><h3 id="2-å¤šAgentç³»ç»Ÿ"><a class="header-anchor" href="#2-å¤šAgentç³»ç»Ÿ"></a>2. å¤šAgentç³»ç»Ÿ</h3><p>å¯¹äºå¤æ‚ä»»åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªä¸“ä¸šAgentåä½œï¼š</p><pre><code class="hljs python"><span class="hljs-keyword">from</span> crewai <span class="hljs-keyword">import</span> Agent, Task, Crew, Process<span class="hljs-comment"># å®šä¹‰ä¸“ä¸šAgent</span>researcher = Agent(    role=<span class="hljs-string">&quot;ç ”ç©¶å‘˜&quot;</span>,    goal=<span class="hljs-string">&quot;æ‰¾åˆ°æœ€æ–°ã€æœ€ç›¸å…³çš„ä¿¡æ¯&quot;</span>,    backstory=<span class="hljs-string">&quot;ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šç ”ç©¶å‘˜ï¼Œå–„äºæœç´¢å’Œåˆ†æä¿¡æ¯&quot;</span>,    allow_delegation=<span class="hljs-literal">True</span>,    verbose=<span class="hljs-literal">True</span>,    llm=llm)analyst = Agent(    role=<span class="hljs-string">&quot;æ•°æ®åˆ†æå¸ˆ&quot;</span>,    goal=<span class="hljs-string">&quot;åˆ†ææ•°æ®å¹¶æå–æ´è§&quot;</span>,    backstory=<span class="hljs-string">&quot;ä½ æ˜¯ä¸€ä¸ªç»éªŒä¸°å¯Œçš„æ•°æ®åˆ†æå¸ˆï¼Œèƒ½ä»åŸå§‹æ•°æ®ä¸­æ‰¾å‡ºæœ‰ä»·å€¼çš„æ¨¡å¼&quot;</span>,    allow_delegation=<span class="hljs-literal">True</span>,    verbose=<span class="hljs-literal">True</span>,    llm=llm)writer = Agent(    role=<span class="hljs-string">&quot;å†…å®¹åˆ›ä½œè€…&quot;</span>,    goal=<span class="hljs-string">&quot;åˆ›ä½œæ¸…æ™°ã€å¼•äººå…¥èƒœçš„å†…å®¹&quot;</span>,    backstory=<span class="hljs-string">&quot;ä½ æ˜¯ä¸€ä¸ªæŠ€æœ¯å†™ä½œä¸“å®¶ï¼Œæ“…é•¿å°†å¤æ‚æ¦‚å¿µè½¬åŒ–ä¸ºæ˜“æ‡‚çš„å†…å®¹&quot;</span>,    allow_delegation=<span class="hljs-literal">True</span>,    verbose=<span class="hljs-literal">True</span>,    llm=llm)<span class="hljs-comment"># å®šä¹‰ä»»åŠ¡</span>research_task = Task(    description=<span class="hljs-string">&quot;ç ”ç©¶æœ€æ–°çš„AI AgentæŠ€æœ¯å‘å±•è¶‹åŠ¿&quot;</span>,    expected_output=<span class="hljs-string">&quot;ä¸€ä»½åŒ…å«å…³é”®å‘å±•çš„ç ”ç©¶æŠ¥å‘Š&quot;</span>,    agent=researcher,    tools=[search_tool])analysis_task = Task(    description=<span class="hljs-string">&quot;åˆ†æç ”ç©¶ç»“æœï¼Œç¡®å®šä¸»è¦è¶‹åŠ¿å’Œæœºä¼š&quot;</span>,    expected_output=<span class="hljs-string">&quot;ä¸€ä»½åˆ†ææŠ¥å‘Šï¼ŒåŒ…å«å…³é”®è¶‹åŠ¿å’Œæœºä¼š&quot;</span>,    agent=analyst,)writing_task = Task(    description=<span class="hljs-string">&quot;åŸºäºç ”ç©¶å’Œåˆ†æï¼Œæ’°å†™ä¸€ç¯‡åšå®¢æ–‡ç« &quot;</span>,    expected_output=<span class="hljs-string">&quot;ä¸€ç¯‡2000å­—çš„åšå®¢æ–‡ç« ï¼Œä»‹ç»AI Agentçš„å‘å±•è¶‹åŠ¿&quot;</span>,    agent=writer,)<span class="hljs-comment"># ç»„å»ºCrewå¹¶æ‰§è¡Œä»»åŠ¡</span>crew = Crew(    agents=[researcher, analyst, writer],    tasks=[research_task, analysis_task, writing_task],    process=Process.sequential,  <span class="hljs-comment"># æŒ‰é¡ºåºæ‰§è¡Œä»»åŠ¡</span>    verbose=<span class="hljs-number">2</span>)result = crew.kickoff()print(result)</code></pre><h3 id="3-åæ€å’Œè‡ªæˆ‘æ”¹è¿›æœºåˆ¶"><a class="header-anchor" href="#3-åæ€å’Œè‡ªæˆ‘æ”¹è¿›æœºåˆ¶"></a>3. åæ€å’Œè‡ªæˆ‘æ”¹è¿›æœºåˆ¶</h3><p>è®©Agentèƒ½å¤Ÿè¯„ä¼°è‡ªå·±çš„è¾“å‡ºå¹¶æ”¹è¿›ï¼š</p><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">agent_with_reflection</span>(<span class="hljs-params">query</span>):</span>    <span class="hljs-comment"># ç¬¬ä¸€æ¬¡å“åº”</span>    initial_response = agent.run(input=query)        <span class="hljs-comment"># åæ€æç¤º</span>    reflection_prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><span class="hljs-string">    è¯·è¯„ä¼°ä½ å¯¹ä»¥ä¸‹æŸ¥è¯¢çš„å“åº”è´¨é‡:</span><span class="hljs-string">    </span><span class="hljs-string">    æŸ¥è¯¢: <span class="hljs-subst">&#123;query&#125;</span></span><span class="hljs-string">    </span><span class="hljs-string">    ä½ çš„å“åº”: <span class="hljs-subst">&#123;initial_response&#125;</span></span><span class="hljs-string">    </span><span class="hljs-string">    è¯·æ£€æŸ¥:</span><span class="hljs-string">    1. å›ç­”æ˜¯å¦å®Œæ•´è§£å†³äº†ç”¨æˆ·é—®é¢˜</span><span class="hljs-string">    2. æ˜¯å¦æœ‰ä»»ä½•äº‹å®é”™è¯¯æˆ–è¯¯å¯¼ä¿¡æ¯</span><span class="hljs-string">    3. å›ç­”æ˜¯å¦æ¸…æ™°ã€ç»“æ„è‰¯å¥½</span><span class="hljs-string">    4. æœ‰å“ªäº›æ–¹é¢å¯ä»¥æ”¹è¿›</span><span class="hljs-string">    </span><span class="hljs-string">    å¦‚æœéœ€è¦æ”¹è¿›ï¼Œè¯·æä¾›æ”¹è¿›åçš„å›ç­”ã€‚</span><span class="hljs-string">    &quot;&quot;&quot;</span>        <span class="hljs-comment"># è¯·Agentåæ€å¹¶æ”¹è¿›</span>    reflection = llm.predict(reflection_prompt)        <span class="hljs-comment"># å¦‚æœåæ€åŒ…å«æ–°çš„å›ç­”ï¼Œåˆ™ä½¿ç”¨æ”¹è¿›ç‰ˆ</span>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;æ”¹è¿›åçš„å›ç­”&quot;</span> <span class="hljs-keyword">in</span> reflection:        improved_answer = reflection.split(<span class="hljs-string">&quot;æ”¹è¿›åçš„å›ç­”:&quot;</span>)[<span class="hljs-number">-1</span>].strip()        <span class="hljs-keyword">return</span> improved_answer        <span class="hljs-comment"># å¦åˆ™è¿”å›åŸå§‹å›ç­”</span>    <span class="hljs-keyword">return</span> initial_response</code></pre><h2 id="ğŸ›¡ï¸-Agentçš„å®‰å…¨ä¸è´£ä»»"><a class="header-anchor" href="#ğŸ›¡ï¸-Agentçš„å®‰å…¨ä¸è´£ä»»"></a>ğŸ›¡ï¸ Agentçš„å®‰å…¨ä¸è´£ä»»</h2><p>å¼€å‘å¼ºå¤§çš„Agentç³»ç»Ÿä¹Ÿå¸¦æ¥äº†å®‰å…¨è´£ä»»ï¼š</p><h3 id="1-æƒé™æ§åˆ¶"><a class="header-anchor" href="#1-æƒé™æ§åˆ¶"></a>1. æƒé™æ§åˆ¶</h3><p>é™åˆ¶Agentå¯ä»¥æ‰§è¡Œçš„æ“ä½œèŒƒå›´ï¼š</p><pre><code class="hljs python"><span class="hljs-comment"># å®‰å…¨çš„æ–‡ä»¶æ“ä½œå·¥å…·</span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">safe_read_file</span>(<span class="hljs-params">filepath</span>):</span>    <span class="hljs-comment"># æ£€æŸ¥æ–‡ä»¶è·¯å¾„ï¼Œé˜²æ­¢ç›®å½•éå†</span>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;..&quot;</span> <span class="hljs-keyword">in</span> filepath <span class="hljs-keyword">or</span> filepath.startswith(<span class="hljs-string">&quot;/&quot;</span>):        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;é”™è¯¯: ä¸å…è®¸è®¿é—®æ­¤è·¯å¾„&quot;</span>            <span class="hljs-comment"># é™åˆ¶å¯è®¿é—®çš„æ–‡ä»¶ç±»å‹</span>    allowed_extensions = [<span class="hljs-string">&#x27;.txt&#x27;</span>, <span class="hljs-string">&#x27;.md&#x27;</span>, <span class="hljs-string">&#x27;.csv&#x27;</span>, <span class="hljs-string">&#x27;.json&#x27;</span>]    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> any(filepath.endswith(ext) <span class="hljs-keyword">for</span> ext <span class="hljs-keyword">in</span> allowed_extensions):        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;é”™è¯¯: åªèƒ½è®¿é—®æ–‡æœ¬å’Œæ•°æ®æ–‡ä»¶&quot;</span>        <span class="hljs-comment"># å®‰å…¨è¯»å–æ–‡ä»¶</span>    <span class="hljs-keyword">try</span>:        <span class="hljs-keyword">with</span> open(filepath, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:            <span class="hljs-keyword">return</span> f.read()    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;è¯»å–æ–‡ä»¶æ—¶å‡ºé”™: <span class="hljs-subst">&#123;str(e)&#125;</span>&quot;</span></code></pre><h3 id="2-è¾“å‡ºè¿‡æ»¤"><a class="header-anchor" href="#2-è¾“å‡ºè¿‡æ»¤"></a>2. è¾“å‡ºè¿‡æ»¤</h3><p>é˜²æ­¢æœ‰å®³å†…å®¹ç”Ÿæˆï¼š</p><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">filter_content</span>(<span class="hljs-params">content</span>):</span>    <span class="hljs-comment"># æ£€æŸ¥æ˜¯å¦åŒ…å«æœ‰å®³å†…å®¹çš„ç®€å•ç¤ºä¾‹</span>    harmful_patterns = [        <span class="hljs-string">&quot;rm -rf&quot;</span>,  <span class="hljs-comment"># å±é™©å‘½ä»¤</span>        <span class="hljs-string">&quot;DROP TABLE&quot;</span>,  <span class="hljs-comment"># SQLæ³¨å…¥</span>        <span class="hljs-string">&quot;&lt;script&gt;&quot;</span>,  <span class="hljs-comment"># XSSæ”»å‡»</span>        <span class="hljs-comment"># æ›´å¤šæ¨¡å¼...</span>    ]        <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> harmful_patterns:        <span class="hljs-keyword">if</span> pattern.lower() <span class="hljs-keyword">in</span> content.lower():            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;å†…å®¹åŒ…å«æ½œåœ¨æœ‰å®³ä»£ç ï¼Œå·²è¢«è¿‡æ»¤ã€‚&quot;</span>        <span class="hljs-keyword">return</span> content</code></pre><h3 id="3-è¡Œä¸ºç›‘æ§"><a class="header-anchor" href="#3-è¡Œä¸ºç›‘æ§"></a>3. è¡Œä¸ºç›‘æ§</h3><p>å®ç°ç›‘æ§ç³»ç»Ÿè®°å½•Agentæ´»åŠ¨ï¼š</p><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AgentMonitor</span>:</span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, log_file=<span class="hljs-string">&quot;agent_logs.jsonl&quot;</span></span>):</span>        self.log_file = log_file        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">log_action</span>(<span class="hljs-params">self, action_type, action_input, action_output, user_query</span>):</span>        log_entry = &#123;            <span class="hljs-string">&quot;timestamp&quot;</span>: datetime.now().isoformat(),            <span class="hljs-string">&quot;action_type&quot;</span>: action_type,            <span class="hljs-string">&quot;action_input&quot;</span>: action_input,            <span class="hljs-string">&quot;action_output&quot;</span>: action_output,            <span class="hljs-string">&quot;user_query&quot;</span>: user_query        &#125;                <span class="hljs-keyword">with</span> open(self.log_file, <span class="hljs-string">&quot;a&quot;</span>) <span class="hljs-keyword">as</span> f:            f.write(json.dumps(log_entry) + <span class="hljs-string">&quot;\n&quot;</span>)        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_agent_stats</span>(<span class="hljs-params">self</span>):</span>        <span class="hljs-comment"># åˆ†ææ—¥å¿—ï¼Œç”Ÿæˆç»Ÿè®¡ä¿¡æ¯</span>        <span class="hljs-keyword">pass</span></code></pre><h2 id="ğŸ’¼-Agentçš„å•†ä¸šåº”ç”¨åœºæ™¯"><a class="header-anchor" href="#ğŸ’¼-Agentçš„å•†ä¸šåº”ç”¨åœºæ™¯"></a>ğŸ’¼ Agentçš„å•†ä¸šåº”ç”¨åœºæ™¯</h2><p>AI Agentåœ¨å¤šä¸ªè¡Œä¸šéƒ½æœ‰å®ç”¨ä»·å€¼ï¼š</p><h3 id="1-å®¢æˆ·æœåŠ¡"><a class="header-anchor" href="#1-å®¢æˆ·æœåŠ¡"></a>1. å®¢æˆ·æœåŠ¡</h3><p>æ„å»ºå¯ä»¥å›ç­”é—®é¢˜ã€å¤„ç†è®¢å•å’Œè§£å†³é—®é¢˜çš„å®¢æœAgentï¼š</p><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerServiceAgent</span>:</span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, company_knowledge_base, order_system_api, ticket_system_api</span>):</span>        self.kb = company_knowledge_base        self.order_api = order_system_api        self.ticket_api = ticket_system_api                <span class="hljs-comment"># åˆå§‹åŒ–LLMå’Œå·¥å…·</span>        self.llm = ChatOpenAI(model=<span class="hljs-string">&quot;gpt-4-turbo&quot;</span>, temperature=<span class="hljs-number">0.2</span>)                <span class="hljs-comment"># å®šä¹‰æŸ¥è¯¢äº§å“ä¿¡æ¯å·¥å…·</span>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">query_product</span>(<span class="hljs-params">product_id</span>):</span>            <span class="hljs-comment"># è°ƒç”¨äº§å“APIè·å–ä¿¡æ¯</span>            <span class="hljs-keyword">return</span> self.kb.get_product_info(product_id)                    <span class="hljs-comment"># å®šä¹‰æŸ¥è¯¢è®¢å•å·¥å…·</span>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_order_status</span>(<span class="hljs-params">order_id</span>):</span>            <span class="hljs-comment"># è°ƒç”¨è®¢å•ç³»ç»ŸAPI</span>            <span class="hljs-keyword">return</span> self.order_api.get_order_status(order_id)                    <span class="hljs-comment"># å®šä¹‰åˆ›å»ºæ”¯æŒå·¥å•å·¥å…·</span>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_support_ticket</span>(<span class="hljs-params">customer_id, issue, priority=<span class="hljs-string">&quot;medium&quot;</span></span>):</span>            <span class="hljs-comment"># åˆ›å»ºæ”¯æŒå·¥å•</span>            ticket_id = self.ticket_api.create_ticket(customer_id, issue, priority)            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;å·²åˆ›å»ºå·¥å•ï¼Œç¼–å·: <span class="hljs-subst">&#123;ticket_id&#125;</span>&quot;</span>                <span class="hljs-comment"># ç»„è£…å·¥å…·é›†</span>        self.tools = [            Tool(<span class="hljs-string">&quot;query_product&quot;</span>, query_product, <span class="hljs-string">&quot;æŸ¥è¯¢äº§å“ä¿¡æ¯&quot;</span>),            Tool(<span class="hljs-string">&quot;check_order_status&quot;</span>, check_order_status, <span class="hljs-string">&quot;æŸ¥è¯¢è®¢å•çŠ¶æ€&quot;</span>),            Tool(<span class="hljs-string">&quot;create_support_ticket&quot;</span>, create_support_ticket, <span class="hljs-string">&quot;åˆ›å»ºæ”¯æŒå·¥å•&quot;</span>)        ]                <span class="hljs-comment"># åˆ›å»ºAgent</span>        self.agent = initialize_agent(            self.tools,            self.llm,            agent=AgentType.CHAT_CONVERSATIONAL_REACT_DESCRIPTION,            verbose=<span class="hljs-literal">True</span>        )            <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_customer_query</span>(<span class="hljs-params">self, customer_id, query</span>):</span>        <span class="hljs-comment"># æ·»åŠ å®¢æˆ·ä¸Šä¸‹æ–‡</span>        customer_context = self.kb.get_customer_info(customer_id)        enhanced_query = <span class="hljs-string">f&quot;å®¢æˆ·ä¿¡æ¯: <span class="hljs-subst">&#123;customer_context&#125;</span>\n\nå®¢æˆ·æŸ¥è¯¢: <span class="hljs-subst">&#123;query&#125;</span>&quot;</span>                <span class="hljs-comment"># è°ƒç”¨Agentå¤„ç†æŸ¥è¯¢</span>        response = self.agent.run(enhanced_query)        <span class="hljs-keyword">return</span> response</code></pre><h3 id="2-ä¸ªäººç”Ÿäº§åŠ›åŠ©æ‰‹"><a class="header-anchor" href="#2-ä¸ªäººç”Ÿäº§åŠ›åŠ©æ‰‹"></a>2. ä¸ªäººç”Ÿäº§åŠ›åŠ©æ‰‹</h3><p>æ„å»ºå¯ä»¥å¸®åŠ©ç®¡ç†æ—¥ç¨‹ã€æ€»ç»“ä¼šè®®å’Œèµ·è‰ç”µå­é‚®ä»¶çš„ä¸ªäººåŠ©æ‰‹ï¼š</p><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProductivityAssistant</span>:</span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, calendar_api, email_api, document_api</span>):</span>        self.calendar = calendar_api        self.email = email_api        self.docs = document_api                <span class="hljs-comment"># åˆ›å»ºAgentå’Œå·¥å…·...</span>            <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">summarize_meeting</span>(<span class="hljs-params">self, meeting_transcript</span>):</span>        <span class="hljs-string">&quot;&quot;&quot;æ€»ç»“ä¼šè®®å†…å®¹&quot;&quot;&quot;</span>        prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><span class="hljs-string">        è¯·æ€»ç»“ä»¥ä¸‹ä¼šè®®è®°å½•çš„å…³é”®ç‚¹ã€å†³ç­–å’Œåç»­è¡ŒåŠ¨é¡¹:</span><span class="hljs-string">        </span><span class="hljs-string">        <span class="hljs-subst">&#123;meeting_transcript&#125;</span></span><span class="hljs-string">        </span><span class="hljs-string">        æ ¼å¼:</span><span class="hljs-string">        1. ä¸»è¦è®¨è®ºç‚¹</span><span class="hljs-string">        2. å†³ç­–</span><span class="hljs-string">        3. è¡ŒåŠ¨é¡¹(åŒ…æ‹¬è´Ÿè´£äººå’Œæˆªæ­¢æ—¥æœŸ)</span><span class="hljs-string">        &quot;&quot;&quot;</span>                <span class="hljs-keyword">return</span> self.llm.predict(prompt)            <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">draft_email</span>(<span class="hljs-params">self, context, recipient, purpose</span>):</span>        <span class="hljs-string">&quot;&quot;&quot;èµ·è‰ç”µå­é‚®ä»¶&quot;&quot;&quot;</span>        prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><span class="hljs-string">        è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯èµ·è‰ä¸€å°ä¸“ä¸šçš„ç”µå­é‚®ä»¶:</span><span class="hljs-string">        </span><span class="hljs-string">        æ”¶ä»¶äºº: <span class="hljs-subst">&#123;recipient&#125;</span></span><span class="hljs-string">        ç›®çš„: <span class="hljs-subst">&#123;purpose&#125;</span></span><span class="hljs-string">        èƒŒæ™¯ä¿¡æ¯: <span class="hljs-subst">&#123;context&#125;</span></span><span class="hljs-string">        </span><span class="hljs-string">        ç”µå­é‚®ä»¶åº”åŒ…å«:</span><span class="hljs-string">        - ä¸“ä¸šçš„é—®å€™è¯­</span><span class="hljs-string">        - æ¸…æ™°çš„ä¸»é¢˜è¯´æ˜</span><span class="hljs-string">        - ä¸»è¦å†…å®¹</span><span class="hljs-string">        - é€‚å½“çš„ç»“æŸè¯­</span><span class="hljs-string">        &quot;&quot;&quot;</span>                <span class="hljs-keyword">return</span> self.llm.predict(prompt)</code></pre><h2 id="ğŸ”®-AgentæŠ€æœ¯çš„æœªæ¥è¶‹åŠ¿"><a class="header-anchor" href="#ğŸ”®-AgentæŠ€æœ¯çš„æœªæ¥è¶‹åŠ¿"></a>ğŸ”® AgentæŠ€æœ¯çš„æœªæ¥è¶‹åŠ¿</h2><p>AI AgentæŠ€æœ¯æ­£åœ¨å¿«é€Ÿå‘å±•ï¼Œå‡ ä¸ªå€¼å¾—å…³æ³¨çš„è¶‹åŠ¿ï¼š</p><ol><li><strong>å¤šæ¨¡æ€Agent</strong>ï¼šèƒ½å¤„ç†å›¾åƒã€éŸ³é¢‘å’Œè§†é¢‘</li><li><strong>é•¿æœŸè®°å¿†</strong>: åŸºäºæ£€ç´¢å¢å¼ºå’Œå‘é‡æ•°æ®åº“çš„æŒä¹…è®°å¿†</li><li><strong>å¤šAgentåä½œç³»ç»Ÿ</strong>: å¤šä¸ªä¸“ä¸šAgentååŒå·¥ä½œ</li><li><strong>è‡ªä¸»å­¦ä¹ ä¸æ”¹è¿›</strong>: Agentè‡ªä¸»æ”¶é›†åé¦ˆå¹¶æ”¹è¿›</li><li><strong>ä½ä»£ç Agentæ„å»ºå¹³å°</strong>: ä½¿éæŠ€æœ¯ç”¨æˆ·ä¹Ÿèƒ½åˆ›å»ºAgent</li></ol><h2 id="ğŸ’¡-ç»“è¯­"><a class="header-anchor" href="#ğŸ’¡-ç»“è¯­"></a>ğŸ’¡ ç»“è¯­</h2><p>AI AgentæŠ€æœ¯ä»£è¡¨äº†AIåº”ç”¨çš„ä¸‹ä¸€ä»£å‘å±•æ–¹å‘ï¼Œä»ç®€å•çš„é—®ç­”ç³»ç»Ÿåˆ°èƒ½å¤Ÿè§„åˆ’å’Œæ‰§è¡Œå¤æ‚ä»»åŠ¡çš„æ™ºèƒ½åŠ©æ‰‹ã€‚é€šè¿‡æœ¬æ–‡ä»‹ç»çš„åŸç†å’Œå®æˆ˜æ¡ˆä¾‹ï¼Œå¸Œæœ›ä½ èƒ½æŒæ¡æ„å»ºå®ç”¨Agentçš„åŸºæœ¬æŠ€èƒ½ã€‚</p><p>éšç€å¤§è¯­è¨€æ¨¡å‹å’Œå·¥å…·è°ƒç”¨èƒ½åŠ›çš„ä¸æ–­è¿›æ­¥ï¼Œæˆ‘ç›¸ä¿¡Agentå°†åœ¨æ›´å¤šé¢†åŸŸå±•ç°ä»·å€¼ã€‚æ— è®ºæ˜¯æ„å»ºä¸ªäººåŠ©æ‰‹ã€ä¼ä¸šè‡ªåŠ¨åŒ–ç³»ç»Ÿè¿˜æ˜¯ä¸“ä¸šé¢†åŸŸåº”ç”¨ï¼ŒæŒæ¡Agentå¼€å‘æŠ€æœ¯éƒ½å°†æ˜¯ä¸€é¡¹è¶Šæ¥è¶Šé‡è¦çš„èƒ½åŠ›ã€‚</p><p>æœ€åï¼Œè®°ä½æ„å»ºAgentçš„æ ¸å¿ƒåœ¨äºæ¸…æ™°çš„ç›®æ ‡å®šä¹‰ã€åˆé€‚çš„å·¥å…·é€‰æ‹©å’Œè‰¯å¥½çš„æç¤ºè®¾è®¡ã€‚ä»ç®€å•å¼€å§‹ï¼Œé€æ­¥è¿­ä»£å®Œå–„ï¼Œä½ ä¹Ÿèƒ½æ„å»ºå‡ºå¼ºå¤§å®ç”¨çš„AI Agentç³»ç»Ÿã€‚</p><p>æœ‰ä»€ä¹ˆé—®é¢˜æˆ–è€…Agentå¼€å‘ç»éªŒï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµï¼</p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>Agent</tag>
      
      <tag>LangChain</tag>
      
      <tag>å·¥å…·è°ƒç”¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ğŸ”„ åŸºäºGoè¯­è¨€æ„å»ºé«˜æ€§èƒ½å¾®æœåŠ¡æ¶æ„</title>
    <link href="/2025/01/18/%E5%9F%BA%E4%BA%8EGo%E8%AF%AD%E8%A8%80%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    <url>/2025/01/18/%E5%9F%BA%E4%BA%8EGo%E8%AF%AD%E8%A8%80%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h1>ğŸ”„ åŸºäºGoè¯­è¨€æ„å»ºé«˜æ€§èƒ½å¾®æœåŠ¡æ¶æ„</h1><p>éšç€ä¸šåŠ¡è§„æ¨¡çš„å¢é•¿ï¼Œå•ä½“åº”ç”¨å¾€å¾€éš¾ä»¥æ»¡è¶³é«˜å¹¶å‘ã€é«˜å¯ç”¨çš„éœ€æ±‚ã€‚å¾®æœåŠ¡æ¶æ„ä½œä¸ºä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå·²ç»è¢«ä¼—å¤šå¤§å‚é‡‡ç”¨ã€‚è€ŒGoè¯­è¨€å‡­å€Ÿå…¶å‡ºè‰²çš„å¹¶å‘æ€§èƒ½å’Œä½èµ„æºå ç”¨ï¼Œæˆä¸ºæ„å»ºå¾®æœåŠ¡çš„ç†æƒ³é€‰æ‹©ã€‚æœ¬æ–‡å°†ç»“åˆæˆ‘çš„å®è·µç»éªŒï¼Œåˆ†äº«å¦‚ä½•åŸºäºGoè¯­è¨€æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½çš„å¾®æœåŠ¡æ¶æ„ã€‚</p><h2 id="ğŸŒŸ-ä¸ºä»€ä¹ˆé€‰æ‹©Goè¯­è¨€æ„å»ºå¾®æœåŠ¡ï¼Ÿ"><a class="header-anchor" href="#ğŸŒŸ-ä¸ºä»€ä¹ˆé€‰æ‹©Goè¯­è¨€æ„å»ºå¾®æœåŠ¡ï¼Ÿ"></a>ğŸŒŸ ä¸ºä»€ä¹ˆé€‰æ‹©Goè¯­è¨€æ„å»ºå¾®æœåŠ¡ï¼Ÿ</h2><p>åœ¨ä¼—å¤šç¼–ç¨‹è¯­è¨€ä¸­ï¼ŒGoè¯­è¨€å…·æœ‰ç‹¬ç‰¹çš„ä¼˜åŠ¿ï¼š</p><ul><li><strong>å‡ºè‰²çš„å¹¶å‘æ¨¡å‹</strong>ï¼šgoroutineå’Œchannelè®©å¹¶å‘ç¼–ç¨‹å˜å¾—ç®€å•é«˜æ•ˆ</li><li><strong>æä½çš„èµ„æºå ç”¨</strong>ï¼šç›¸æ¯”Java/Pythonï¼ŒGoæœåŠ¡å†…å­˜å ç”¨é€šå¸¸ä½10å€ä»¥ä¸Š</li><li><strong>æå¿«çš„å¯åŠ¨æ—¶é—´</strong>ï¼šæ¯«ç§’çº§å¯åŠ¨é€Ÿåº¦ï¼Œé€‚åˆå®¹å™¨åŒ–ç¯å¢ƒ</li><li><strong>ä¸°å¯Œçš„å¾®æœåŠ¡ç”Ÿæ€</strong>ï¼šgRPCã€æœåŠ¡ç½‘æ ¼ç­‰å·¥å…·é“¾å®Œå–„</li><li><strong>ç¼–è¯‘å‹è¯­è¨€</strong>ï¼šé™æ€ç±»å‹æ£€æŸ¥ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯</li></ul><p>æˆ‘åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­å°†Pythonå¾®æœåŠ¡é‡æ„ä¸ºGoï¼Œæ€§èƒ½å¯¹æ¯”æ•°æ®å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æŒ‡æ ‡</th><th>Python (Flask)</th><th>Go (Gin)</th><th>æå‡æ¯”ä¾‹</th></tr></thead><tbody><tr><td>æ¯ç§’è¯·æ±‚æ•° (RPS)</td><td>1,200</td><td>18,000</td><td>15å€</td></tr><tr><td>å¹³å‡å“åº”æ—¶é—´</td><td>85ms</td><td>12ms</td><td>7å€</td></tr><tr><td>å†…å­˜å ç”¨</td><td>280MB</td><td>24MB</td><td>11.7å€</td></tr><tr><td>å†·å¯åŠ¨æ—¶é—´</td><td>2-3ç§’</td><td>0.1ç§’</td><td>20-30å€</td></tr></tbody></table><p>è¿™ç§æ€§èƒ½å·®å¼‚åœ¨å¤§è§„æ¨¡éƒ¨ç½²æ—¶å°¤ä¸ºæ˜æ˜¾ï¼Œç›´æ¥å½±å“æœåŠ¡æ‰©å±•æ€§å’Œæˆæœ¬ã€‚</p><h2 id="ğŸ—ï¸-å¾®æœåŠ¡æ¶æ„è®¾è®¡åŸåˆ™"><a class="header-anchor" href="#ğŸ—ï¸-å¾®æœåŠ¡æ¶æ„è®¾è®¡åŸåˆ™"></a>ğŸ—ï¸ å¾®æœåŠ¡æ¶æ„è®¾è®¡åŸåˆ™</h2><p>åœ¨è¿›å…¥æŠ€æœ¯å®ç°å‰ï¼Œæˆ‘ä»¬å…ˆæ˜ç¡®ä¸€äº›è®¾è®¡åŸåˆ™ï¼š</p><h3 id="1-æœåŠ¡è¾¹ç•Œåˆ’åˆ†"><a class="header-anchor" href="#1-æœåŠ¡è¾¹ç•Œåˆ’åˆ†"></a>1. æœåŠ¡è¾¹ç•Œåˆ’åˆ†</h3><p>æœåŠ¡æ‹†åˆ†æ˜¯å¾®æœåŠ¡è®¾è®¡çš„é¦–è¦é—®é¢˜ï¼Œæˆ‘æ¨èä»¥ä¸‹æ–¹æ³•ï¼š</p><ul><li><strong>æŒ‰ä¸šåŠ¡èƒ½åŠ›åˆ’åˆ†</strong>ï¼šä¾‹å¦‚ç”¨æˆ·æœåŠ¡ã€è®¢å•æœåŠ¡ã€æ”¯ä»˜æœåŠ¡</li><li><strong>å•ä¸€èŒè´£</strong>ï¼šæ¯ä¸ªæœåŠ¡ä¸“æ³¨äºä¸€ä¸ªä¸šåŠ¡åŠŸèƒ½</li><li><strong>æ•°æ®è‡ªæ²»</strong>ï¼šæœåŠ¡æ‹¥æœ‰å¹¶ç®¡ç†è‡ªå·±çš„æ•°æ®</li><li><strong>é€‚åº¦ç²’åº¦</strong>ï¼šè¿‡ç»†çš„æ‹†åˆ†å¢åŠ å¤æ‚åº¦ï¼Œè¿‡ç²—å¤±å»å¾®æœåŠ¡ä¼˜åŠ¿</li></ul><h3 id="2-é€šä¿¡åè®®é€‰æ‹©"><a class="header-anchor" href="#2-é€šä¿¡åè®®é€‰æ‹©"></a>2. é€šä¿¡åè®®é€‰æ‹©</h3><p>å¾®æœåŠ¡é—´é€šä¿¡åè®®çš„é€‰æ‹©ç›´æ¥å½±å“æ€§èƒ½å’Œå¼€å‘æ•ˆç‡ï¼š</p><table><thead><tr><th>åè®®</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>REST (HTTP)</td><td>ç®€å•ã€å¹¿æ³›æ”¯æŒã€è°ƒè¯•æ–¹ä¾¿</td><td>æ€§èƒ½ä¸€èˆ¬ã€æ— ç±»å‹æ£€æŸ¥</td><td>å¤–éƒ¨APIã€ç®€å•åœºæ™¯</td></tr><tr><td>gRPC</td><td>é«˜æ€§èƒ½ã€ç±»å‹å®‰å…¨ã€åŒå‘æµ</td><td>è°ƒè¯•ç¨å¤æ‚ã€éœ€è¦protobuf</td><td>å†…éƒ¨æœåŠ¡é€šä¿¡ã€æ€§èƒ½æ•æ„Ÿåœºæ™¯</td></tr><tr><td>GraphQL</td><td>çµæ´»æŸ¥è¯¢ã€å‡å°‘è¯·æ±‚æ•°</td><td>å®ç°å¤æ‚ã€æ€§èƒ½è€ƒé‡</td><td>é¢å‘å‰ç«¯çš„èšåˆAPI</td></tr><tr><td>æ¶ˆæ¯é˜Ÿåˆ—</td><td>å¼‚æ­¥é€šä¿¡ã€è§£è€¦ã€å‰Šå³°</td><td>é¢å¤–åŸºç¡€è®¾æ–½ã€å¤æ‚æ€§</td><td>äº‹ä»¶é©±åŠ¨ã€ä»»åŠ¡å¤„ç†</td></tr></tbody></table><p>æˆ‘çš„å»ºè®®æ˜¯å†…éƒ¨æœåŠ¡é€šä¿¡ä¼˜å…ˆé€‰ç”¨gRPCï¼Œé¢å‘å¤–éƒ¨çš„APIç½‘å…³å¯æä¾›RESTæ¥å£ã€‚</p><h2 id="ğŸ› ï¸-æŠ€æœ¯æ ˆé€‰å‹"><a class="header-anchor" href="#ğŸ› ï¸-æŠ€æœ¯æ ˆé€‰å‹"></a>ğŸ› ï¸ æŠ€æœ¯æ ˆé€‰å‹</h2><p>æ„å»ºGoå¾®æœåŠ¡çš„å…³é”®æŠ€æœ¯ç»„ä»¶ï¼š</p><h3 id="1-æ ¸å¿ƒæ¡†æ¶"><a class="header-anchor" href="#1-æ ¸å¿ƒæ¡†æ¶"></a>1. æ ¸å¿ƒæ¡†æ¶</h3><pre><code class="hljs go"><span class="hljs-comment">// ä½¿ç”¨Ginæ„å»ºHTTPæœåŠ¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setupRouter</span><span class="hljs-params">()</span> *<span class="hljs-title">gin</span>.<span class="hljs-title">Engine</span></span> &#123;    r := gin.Default()        <span class="hljs-comment">// å¥åº·æ£€æŸ¥</span>    r.GET(<span class="hljs-string">&quot;/health&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;        c.JSON(<span class="hljs-number">200</span>, gin.H&#123;            <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;ok&quot;</span>,        &#125;)    &#125;)        <span class="hljs-comment">// APIè·¯ç”±ç»„</span>    v1 := r.Group(<span class="hljs-string">&quot;/api/v1&quot;</span>)    &#123;        v1.GET(<span class="hljs-string">&quot;/users&quot;</span>, controller.ListUsers)        v1.GET(<span class="hljs-string">&quot;/users/:id&quot;</span>, controller.GetUser)        v1.POST(<span class="hljs-string">&quot;/users&quot;</span>, controller.CreateUser)        <span class="hljs-comment">// ...æ›´å¤šè·¯ç”±</span>    &#125;        <span class="hljs-keyword">return</span> r&#125;</code></pre><h3 id="2-æœåŠ¡é—´é€šä¿¡"><a class="header-anchor" href="#2-æœåŠ¡é—´é€šä¿¡"></a>2. æœåŠ¡é—´é€šä¿¡</h3><p>gRPCæ˜¯Goå¾®æœåŠ¡ä¸­æœ€å—æ¬¢è¿çš„RPCæ¡†æ¶ï¼š</p><pre><code class="hljs protobuf"><span class="hljs-comment">// user.proto</span>syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<span class="hljs-keyword">package</span> user;<span class="hljs-keyword">option</span> go_package = <span class="hljs-string">&quot;github.com/myorg/myapp/user&quot;</span>;<span class="hljs-class"><span class="hljs-keyword">service</span> <span class="hljs-title">UserService</span> </span>&#123;  <span class="hljs-function"><span class="hljs-keyword">rpc</span> GetUser(GetUserRequest) <span class="hljs-keyword">returns</span> (User) </span>&#123;&#125;  <span class="hljs-function"><span class="hljs-keyword">rpc</span> ListUsers(ListUsersRequest) <span class="hljs-keyword">returns</span> (ListUsersResponse) </span>&#123;&#125;  <span class="hljs-function"><span class="hljs-keyword">rpc</span> CreateUser(CreateUserRequest) <span class="hljs-keyword">returns</span> (User) </span>&#123;&#125;  <span class="hljs-comment">// ...æ›´å¤šæ–¹æ³•</span>&#125;<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">User</span> </span>&#123;  <span class="hljs-built_in">string</span> id = <span class="hljs-number">1</span>;  <span class="hljs-built_in">string</span> name = <span class="hljs-number">2</span>;  <span class="hljs-built_in">string</span> email = <span class="hljs-number">3</span>;  <span class="hljs-comment">// ...æ›´å¤šå­—æ®µ</span>&#125;<span class="hljs-comment">// è¯·æ±‚ã€å“åº”æ¶ˆæ¯å®šä¹‰...</span></code></pre><p>æœåŠ¡å™¨ç«¯å®ç°ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// user_service.go</span><span class="hljs-keyword">type</span> userServiceServer <span class="hljs-keyword">struct</span> &#123;    repository UserRepository    pb.UnimplementedUserServiceServer&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *userServiceServer)</span> <span class="hljs-title">GetUser</span><span class="hljs-params">(ctx context.Context, req *pb.GetUserRequest)</span> <span class="hljs-params">(*pb.User, error)</span></span> &#123;    user, err := s.repository.GetByID(ctx, req.Id)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">if</span> errors.Is(err, sql.ErrNoRows) &#123;            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, status.Errorf(codes.NotFound, <span class="hljs-string">&quot;user not found: %v&quot;</span>, err)        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, status.Errorf(codes.Internal, <span class="hljs-string">&quot;failed to get user: %v&quot;</span>, err)    &#125;        <span class="hljs-keyword">return</span> &amp;pb.User&#123;        Id:    user.ID,        Name:  user.Name,        Email: user.Email,    &#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// ...å…¶ä»–æ–¹æ³•å®ç°</span></code></pre><p>å®¢æˆ·ç«¯è°ƒç”¨ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// åˆ›å»ºgRPCè¿æ¥</span>conn, err := grpc.Dial(<span class="hljs-string">&quot;user-service:50051&quot;</span>,     grpc.WithTransportCredentials(insecure.NewCredentials()))<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;    log.Fatalf(<span class="hljs-string">&quot;Failed to connect: %v&quot;</span>, err)&#125;<span class="hljs-keyword">defer</span> conn.Close()<span class="hljs-comment">// åˆ›å»ºå®¢æˆ·ç«¯</span>client := pb.NewUserServiceClient(conn)<span class="hljs-comment">// è°ƒç”¨è¿œç¨‹æ–¹æ³•</span>user, err := client.GetUser(ctx, &amp;pb.GetUserRequest&#123;Id: <span class="hljs-string">&quot;123&quot;</span>&#125;)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;    log.Printf(<span class="hljs-string">&quot;Error calling GetUser: %v&quot;</span>, err)    <span class="hljs-keyword">return</span>&#125;log.Printf(<span class="hljs-string">&quot;Got user: %s&quot;</span>, user.Name)</code></pre><h3 id="3-æ•°æ®æŒä¹…åŒ–"><a class="header-anchor" href="#3-æ•°æ®æŒä¹…åŒ–"></a>3. æ•°æ®æŒä¹…åŒ–</h3><p>æ¯ä¸ªå¾®æœåŠ¡åº”è¯¥æœ‰è‡ªå·±çš„æ•°æ®å­˜å‚¨ï¼Œä¾‹å¦‚ä½¿ç”¨GORMæ“ä½œæ•°æ®åº“ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// user_repository.go</span><span class="hljs-keyword">type</span> UserRepository <span class="hljs-keyword">interface</span> &#123;    GetByID(ctx context.Context, id <span class="hljs-keyword">string</span>) (*User, error)    Create(ctx context.Context, user *User) error    <span class="hljs-comment">// ...å…¶ä»–æ–¹æ³•</span>&#125;<span class="hljs-keyword">type</span> sqlUserRepository <span class="hljs-keyword">struct</span> &#123;    db *gorm.DB&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserRepository</span><span class="hljs-params">(db *gorm.DB)</span> <span class="hljs-title">UserRepository</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;sqlUserRepository&#123;db: db&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *sqlUserRepository)</span> <span class="hljs-title">GetByID</span><span class="hljs-params">(ctx context.Context, id <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*User, error)</span></span> &#123;    <span class="hljs-keyword">var</span> user User    result := r.db.WithContext(ctx).First(&amp;user, <span class="hljs-string">&quot;id = ?&quot;</span>, id)    <span class="hljs-keyword">return</span> &amp;user, result.Error&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *sqlUserRepository)</span> <span class="hljs-title">Create</span><span class="hljs-params">(ctx context.Context, user *User)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-keyword">return</span> r.db.WithContext(ctx).Create(user).Error&#125;</code></pre><h3 id="4-æœåŠ¡å‘ç°ä¸æ³¨å†Œ"><a class="header-anchor" href="#4-æœåŠ¡å‘ç°ä¸æ³¨å†Œ"></a>4. æœåŠ¡å‘ç°ä¸æ³¨å†Œ</h3><p>å¯¹äºæœåŠ¡å‘ç°ï¼ŒConsulå’Œetcdæ˜¯å¸¸ç”¨é€‰æ‹©ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æœåŠ¡æ³¨å†Œ</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">registerService</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºConsulå®¢æˆ·ç«¯</span>    client, err := api.NewClient(api.DefaultConfig())    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;Failed to create Consul client: %v&quot;</span>, err)    &#125;    <span class="hljs-comment">// æœåŠ¡å®šä¹‰</span>    serviceID := <span class="hljs-string">&quot;user-service-&quot;</span> + uuid.New().String()    serviceDef := &amp;api.AgentServiceRegistration&#123;        ID:      serviceID,        Name:    <span class="hljs-string">&quot;user-service&quot;</span>,        Port:    <span class="hljs-number">8080</span>,        Address: getOutboundIP(),        Check: &amp;api.AgentServiceCheck&#123;            HTTP:                           <span class="hljs-string">&quot;http://localhost:8080/health&quot;</span>,            Interval:                       <span class="hljs-string">&quot;10s&quot;</span>,            Timeout:                        <span class="hljs-string">&quot;5s&quot;</span>,            DeregisterCriticalServiceAfter: <span class="hljs-string">&quot;30s&quot;</span>,        &#125;,    &#125;    <span class="hljs-comment">// æ³¨å†ŒæœåŠ¡</span>    <span class="hljs-keyword">if</span> err := client.Agent().ServiceRegister(serviceDef); err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;Failed to register service: %v&quot;</span>, err)    &#125;    <span class="hljs-comment">// ç¨‹åºé€€å‡ºæ—¶å–æ¶ˆæ³¨å†Œ</span>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        client.Agent().ServiceDeregister(serviceID)    &#125;()&#125;</code></pre><h3 id="5-é…ç½®ç®¡ç†"><a class="header-anchor" href="#5-é…ç½®ç®¡ç†"></a>5. é…ç½®ç®¡ç†</h3><p>ä½¿ç”¨Viperå®ç°é…ç½®ç®¡ç†ï¼Œæ”¯æŒç¯å¢ƒå˜é‡ã€é…ç½®æ–‡ä»¶ç­‰å¤šç§æ–¹å¼ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// config.go</span><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;    Server <span class="hljs-keyword">struct</span> &#123;        Port <span class="hljs-keyword">int</span> <span class="hljs-string">`mapstructure:&quot;port&quot;`</span>    &#125; <span class="hljs-string">`mapstructure:&quot;server&quot;`</span>        Database <span class="hljs-keyword">struct</span> &#123;        Host     <span class="hljs-keyword">string</span> <span class="hljs-string">`mapstructure:&quot;host&quot;`</span>        Port     <span class="hljs-keyword">int</span>    <span class="hljs-string">`mapstructure:&quot;port&quot;`</span>        User     <span class="hljs-keyword">string</span> <span class="hljs-string">`mapstructure:&quot;user&quot;`</span>        Password <span class="hljs-keyword">string</span> <span class="hljs-string">`mapstructure:&quot;password&quot;`</span>        DBName   <span class="hljs-keyword">string</span> <span class="hljs-string">`mapstructure:&quot;dbname&quot;`</span>    &#125; <span class="hljs-string">`mapstructure:&quot;database&quot;`</span>        <span class="hljs-comment">// ...å…¶ä»–é…ç½®</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadConfig</span><span class="hljs-params">()</span> <span class="hljs-params">(*Config, error)</span></span> &#123;    viper.SetConfigName(<span class="hljs-string">&quot;config&quot;</span>)    viper.SetConfigType(<span class="hljs-string">&quot;yaml&quot;</span>)    viper.AddConfigPath(<span class="hljs-string">&quot;.&quot;</span>)    viper.AddConfigPath(<span class="hljs-string">&quot;./config&quot;</span>)    viper.AutomaticEnv()    viper.SetEnvKeyReplacer(strings.NewReplacer(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;_&quot;</span>))    <span class="hljs-keyword">if</span> err := viper.ReadInConfig(); err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to read config: %w&quot;</span>, err)    &#125;    <span class="hljs-keyword">var</span> config Config    <span class="hljs-keyword">if</span> err := viper.Unmarshal(&amp;config); err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to unmarshal config: %w&quot;</span>, err)    &#125;    <span class="hljs-keyword">return</span> &amp;config, <span class="hljs-literal">nil</span>&#125;</code></pre><h2 id="ğŸ”Œ-æ„å»ºå¾®æœåŠ¡æ¶æ„"><a class="header-anchor" href="#ğŸ”Œ-æ„å»ºå¾®æœåŠ¡æ¶æ„"></a>ğŸ”Œ æ„å»ºå¾®æœåŠ¡æ¶æ„</h2><p>æœ‰äº†åŸºç¡€ç»„ä»¶ï¼Œä¸‹é¢çœ‹å¦‚ä½•ç»„è£…ä¸€ä¸ªå®Œæ•´çš„å¾®æœåŠ¡æ¶æ„ï¼š</p><h3 id="1-é¡¹ç›®ç»“æ„"><a class="header-anchor" href="#1-é¡¹ç›®ç»“æ„"></a>1. é¡¹ç›®ç»“æ„</h3><p>ä¸€ä¸ªå…¸å‹çš„Goå¾®æœåŠ¡é¡¹ç›®ç»“æ„ï¼š</p><pre><code class="hljs axapta">service-name/â”œâ”€â”€ api/â”‚   â””â”€â”€ proto/            <span class="hljs-meta"># Protobuf å®šä¹‰</span>â”‚       â”œâ”€â”€ user.protoâ”‚       â””â”€â”€ <span class="hljs-keyword">order</span>.protoâ”œâ”€â”€ cmd/â”‚   â””â”€â”€ <span class="hljs-keyword">server</span>/           <span class="hljs-meta"># åº”ç”¨å…¥å£</span>â”‚       â””â”€â”€ main.goâ”œâ”€â”€ config/               <span class="hljs-meta"># é…ç½®æ–‡ä»¶</span>â”‚   â”œâ”€â”€ config.yamlâ”‚   â””â”€â”€ config_test.yamlâ”œâ”€â”€ internal/             <span class="hljs-meta"># ç§æœ‰ä»£ç </span>â”‚   â”œâ”€â”€ handler/          <span class="hljs-meta"># HTTPå¤„ç†å™¨</span>â”‚   â”œâ”€â”€ repository/       <span class="hljs-meta"># æ•°æ®è®¿é—®</span>â”‚   â”œâ”€â”€ service/          <span class="hljs-meta"># ä¸šåŠ¡é€»è¾‘</span>â”‚   â””â”€â”€ middleware/       <span class="hljs-meta"># ä¸­é—´ä»¶</span>â”œâ”€â”€ pkg/                  <span class="hljs-meta"># å¯é‡ç”¨å…¬å…±ä»£ç </span>â”‚   â”œâ”€â”€ auth/â”‚   â”œâ”€â”€ logging/â”‚   â””â”€â”€ tracing/â”œâ”€â”€ Dockerfileâ”œâ”€â”€ go.<span class="hljs-keyword">mod</span>â””â”€â”€ go.<span class="hljs-keyword">sum</span></code></pre><h3 id="2-å®Œæ•´æœåŠ¡å®ç°ç¤ºä¾‹"><a class="header-anchor" href="#2-å®Œæ•´æœåŠ¡å®ç°ç¤ºä¾‹"></a>2. å®Œæ•´æœåŠ¡å®ç°ç¤ºä¾‹</h3><p>ä¸€ä¸ªç®€åŒ–çš„ç”¨æˆ·å¾®æœåŠ¡<code>main.go</code>ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;context&quot;</span>    <span class="hljs-string">&quot;log&quot;</span>    <span class="hljs-string">&quot;net&quot;</span>    <span class="hljs-string">&quot;net/http&quot;</span>    <span class="hljs-string">&quot;os&quot;</span>    <span class="hljs-string">&quot;os/signal&quot;</span>    <span class="hljs-string">&quot;syscall&quot;</span>    <span class="hljs-string">&quot;time&quot;</span>    <span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span>    <span class="hljs-string">&quot;google.golang.org/grpc&quot;</span>        <span class="hljs-string">&quot;myapp/config&quot;</span>    <span class="hljs-string">&quot;myapp/internal/handler&quot;</span>    <span class="hljs-string">&quot;myapp/internal/repository&quot;</span>    <span class="hljs-string">&quot;myapp/internal/service&quot;</span>    <span class="hljs-string">&quot;myapp/pkg/database&quot;</span>    pb <span class="hljs-string">&quot;myapp/api/proto&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åŠ è½½é…ç½®</span>    cfg, err := config.LoadConfig()    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;Failed to load config: %v&quot;</span>, err)    &#125;    <span class="hljs-comment">// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥</span>    db, err := database.NewConnection(cfg.Database)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;Failed to connect to database: %v&quot;</span>, err)    &#125;    <span class="hljs-keyword">defer</span> db.Close()    <span class="hljs-comment">// åˆå§‹åŒ–å­˜å‚¨åº“</span>    userRepo := repository.NewUserRepository(db)    <span class="hljs-comment">// åˆå§‹åŒ–æœåŠ¡å±‚</span>    userService := service.NewUserService(userRepo)    <span class="hljs-comment">// å¯åŠ¨gRPCæœåŠ¡</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        listener, err := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;:50051&quot;</span>)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            log.Fatalf(<span class="hljs-string">&quot;Failed to listen: %v&quot;</span>, err)        &#125;        grpcServer := grpc.NewServer()        pb.RegisterUserServiceServer(grpcServer, service.NewGrpcUserServer(userService))        log.Println(<span class="hljs-string">&quot;gRPC server listening on :50051&quot;</span>)        <span class="hljs-keyword">if</span> err := grpcServer.Serve(listener); err != <span class="hljs-literal">nil</span> &#123;            log.Fatalf(<span class="hljs-string">&quot;Failed to serve: %v&quot;</span>, err)        &#125;    &#125;()    <span class="hljs-comment">// åˆå§‹åŒ–HTTPæœåŠ¡å™¨</span>    router := gin.Default()        <span class="hljs-comment">// æ³¨å†ŒHTTPå¤„ç†ç¨‹åº</span>    handler.RegisterUserRoutes(router, userService)        <span class="hljs-comment">// å¥åº·æ£€æŸ¥</span>    router.GET(<span class="hljs-string">&quot;/health&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;        c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;ok&quot;</span>&#125;)    &#125;)    <span class="hljs-comment">// å¯åŠ¨HTTPæœåŠ¡å™¨</span>    srv := &amp;http.Server&#123;        Addr:    <span class="hljs-string">&quot;:8080&quot;</span>,        Handler: router,    &#125;    <span class="hljs-comment">// ä¼˜é›…å…³é—­</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        log.Println(<span class="hljs-string">&quot;HTTP server listening on :8080&quot;</span>)        <span class="hljs-keyword">if</span> err := srv.ListenAndServe(); err != <span class="hljs-literal">nil</span> &amp;&amp; err != http.ErrServerClosed &#123;            log.Fatalf(<span class="hljs-string">&quot;Failed to start server: %v&quot;</span>, err)        &#125;    &#125;()    <span class="hljs-comment">// ç­‰å¾…ä¸­æ–­ä¿¡å·</span>    quit := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">1</span>)    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)    &lt;-quit    log.Println(<span class="hljs-string">&quot;Shutting down server...&quot;</span>)    <span class="hljs-comment">// ä¼˜é›…å…³é—­æœåŠ¡å™¨</span>    ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">10</span>*time.Second)    <span class="hljs-keyword">defer</span> cancel()    <span class="hljs-keyword">if</span> err := srv.Shutdown(ctx); err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;Server forced to shutdown: %v&quot;</span>, err)    &#125;    log.Println(<span class="hljs-string">&quot;Server exiting&quot;</span>)&#125;</code></pre><h2 id="ğŸš€-é«˜æ€§èƒ½ä¼˜åŒ–æŠ€å·§"><a class="header-anchor" href="#ğŸš€-é«˜æ€§èƒ½ä¼˜åŒ–æŠ€å·§"></a>ğŸš€ é«˜æ€§èƒ½ä¼˜åŒ–æŠ€å·§</h2><p>Goå¾®æœåŠ¡æ€§èƒ½ä¼˜åŒ–çš„å‡ ä¸ªå…³é”®ç‚¹ï¼š</p><h3 id="1-è¿æ¥æ± ç®¡ç†"><a class="header-anchor" href="#1-è¿æ¥æ± ç®¡ç†"></a>1. è¿æ¥æ± ç®¡ç†</h3><p>æ•°æ®åº“å’ŒHTTPè¿æ¥æ± é…ç½®å¯¹æ€§èƒ½å½±å“æå¤§ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setupDBPool</span><span class="hljs-params">(dsn <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*gorm.DB, error)</span></span> &#123;    sqlDB, err := sql.Open(<span class="hljs-string">&quot;postgres&quot;</span>, dsn)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;        <span class="hljs-comment">// è®¾ç½®è¿æ¥æ± å‚æ•°</span>    sqlDB.SetMaxOpenConns(<span class="hljs-number">25</span>)              <span class="hljs-comment">// æœ€å¤§è¿æ¥æ•°</span>    sqlDB.SetMaxIdleConns(<span class="hljs-number">10</span>)              <span class="hljs-comment">// æœ€å¤§ç©ºé—²è¿æ¥æ•°</span>    sqlDB.SetConnMaxLifetime(time.Hour)    <span class="hljs-comment">// è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ</span>    sqlDB.SetConnMaxIdleTime(<span class="hljs-number">30</span> * time.Minute) <span class="hljs-comment">// ç©ºé—²è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ</span>        <span class="hljs-comment">// åˆå§‹åŒ–GORM</span>    db, err := gorm.Open(postgres.New(postgres.Config&#123;        Conn: sqlDB,    &#125;), &amp;gorm.Config&#123;&#125;)        <span class="hljs-keyword">return</span> db, err&#125;<span class="hljs-comment">// HTTPå®¢æˆ·ç«¯è¿æ¥æ± </span><span class="hljs-keyword">var</span> httpClient = &amp;http.Client&#123;    Transport: &amp;http.Transport&#123;        MaxIdleConns:        <span class="hljs-number">100</span>,        MaxIdleConnsPerHost: <span class="hljs-number">10</span>,        IdleConnTimeout:     <span class="hljs-number">90</span> * time.Second,    &#125;,    Timeout: <span class="hljs-number">10</span> * time.Second,&#125;</code></pre><h3 id="2-å¹¶å‘æ§åˆ¶"><a class="header-anchor" href="#2-å¹¶å‘æ§åˆ¶"></a>2. å¹¶å‘æ§åˆ¶</h3><p>åˆç†åˆ©ç”¨Goçš„goroutineå’Œchannelè¿›è¡Œå¹¶å‘æ§åˆ¶ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// å¹¶å‘å¤„ç†å¤šä¸ªè¯·æ±‚</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processItems</span><span class="hljs-params">(items []Item)</span> []<span class="hljs-title">Result</span></span> &#123;    results := <span class="hljs-built_in">make</span>([]Result, <span class="hljs-built_in">len</span>(items))    wg := sync.WaitGroup&#123;&#125;        <span class="hljs-comment">// é™åˆ¶å¹¶å‘æ•°é‡</span>    sem := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, <span class="hljs-number">10</span>)         <span class="hljs-keyword">for</span> i, item := <span class="hljs-keyword">range</span> items &#123;        wg.Add(<span class="hljs-number">1</span>)        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>, item Item)</span></span> &#123;            <span class="hljs-keyword">defer</span> wg.Done()                        <span class="hljs-comment">// è·å–ä¿¡å·é‡</span>            sem &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; &lt;-sem &#125;()                        <span class="hljs-comment">// å¤„ç†é¡¹ç›®</span>            results[i] = processItem(item)        &#125;(i, item)    &#125;        wg.Wait()    <span class="hljs-keyword">return</span> results&#125;</code></pre><h3 id="3-ç¼“å­˜ç­–ç•¥"><a class="header-anchor" href="#3-ç¼“å­˜ç­–ç•¥"></a>3. ç¼“å­˜ç­–ç•¥</h3><p>ä½¿ç”¨å¤šçº§ç¼“å­˜æé«˜è¯»å–æ€§èƒ½ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä½¿ç”¨Redisä½œä¸ºåˆ†å¸ƒå¼ç¼“å­˜</span><span class="hljs-keyword">type</span> CachedUserRepository <span class="hljs-keyword">struct</span> &#123;    repo      UserRepository    redisClient *redis.Client    cacheTTL  time.Duration&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *CachedUserRepository)</span> <span class="hljs-title">GetByID</span><span class="hljs-params">(ctx context.Context, id <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*User, error)</span></span> &#123;    cacheKey := fmt.Sprintf(<span class="hljs-string">&quot;user:%s&quot;</span>, id)        <span class="hljs-comment">// å°è¯•ä»ç¼“å­˜è·å–</span>    userData, err := r.redisClient.Get(ctx, cacheKey).Bytes()    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;        <span class="hljs-comment">// ç¼“å­˜å‘½ä¸­</span>        <span class="hljs-keyword">var</span> user User        <span class="hljs-keyword">if</span> err := json.Unmarshal(userData, &amp;user); err == <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> &amp;user, <span class="hljs-literal">nil</span>        &#125;    &#125;        <span class="hljs-comment">// ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“è·å–</span>    user, err := r.repo.GetByID(ctx, id)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;        <span class="hljs-comment">// æ›´æ–°ç¼“å­˜</span>    <span class="hljs-keyword">if</span> userData, err := json.Marshal(user); err == <span class="hljs-literal">nil</span> &#123;        r.redisClient.Set(ctx, cacheKey, userData, r.cacheTTL)    &#125;        <span class="hljs-keyword">return</span> user, <span class="hljs-literal">nil</span>&#125;</code></pre><h3 id="4-è¯·æ±‚è¶…æ—¶ä¸æ–­è·¯å™¨"><a class="header-anchor" href="#4-è¯·æ±‚è¶…æ—¶ä¸æ–­è·¯å™¨"></a>4. è¯·æ±‚è¶…æ—¶ä¸æ–­è·¯å™¨</h3><p>ä¿æŠ¤ç³»ç»Ÿé¿å…çº§è”æ•…éšœï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/sony/gobreaker&quot;</span><span class="hljs-comment">// åˆ›å»ºæ–­è·¯å™¨</span>cb := gobreaker.NewCircuitBreaker(gobreaker.Settings&#123;    Name:        <span class="hljs-string">&quot;my-service&quot;</span>,    MaxRequests: <span class="hljs-number">5</span>,              <span class="hljs-comment">// åŠå¼€çŠ¶æ€å…è®¸çš„è¯·æ±‚æ•°</span>    Interval:    <span class="hljs-number">5</span> * time.Minute, <span class="hljs-comment">// ç»Ÿè®¡æ—¶é—´çª—å£</span>    Timeout:     <span class="hljs-number">1</span> * time.Minute, <span class="hljs-comment">// æ–­è·¯å™¨æ‰“å¼€æŒç»­æ—¶é—´</span>    ReadyToTrip: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(counts gobreaker.Counts)</span> <span class="hljs-title">bool</span></span> &#123;        failureRatio := <span class="hljs-keyword">float64</span>(counts.TotalFailures) / <span class="hljs-keyword">float64</span>(counts.Requests)        <span class="hljs-keyword">return</span> counts.Requests &gt;= <span class="hljs-number">10</span> &amp;&amp; failureRatio &gt;= <span class="hljs-number">0.5</span>    &#125;,&#125;)<span class="hljs-comment">// ä½¿ç”¨æ–­è·¯å™¨æ‰§è¡Œè¯·æ±‚</span>response, err := cb.Execute(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span></span> &#123;    ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">2</span>*time.Second)    <span class="hljs-keyword">defer</span> cancel()        <span class="hljs-keyword">return</span> client.GetUser(ctx, &amp;pb.GetUserRequest&#123;Id: <span class="hljs-string">&quot;123&quot;</span>&#125;)&#125;)</code></pre><h2 id="ğŸ“Š-ç›‘æ§ä¸å¯è§‚æµ‹æ€§"><a class="header-anchor" href="#ğŸ“Š-ç›‘æ§ä¸å¯è§‚æµ‹æ€§"></a>ğŸ“Š ç›‘æ§ä¸å¯è§‚æµ‹æ€§</h2><p>å¯è§‚æµ‹æ€§æ˜¯å¾®æœåŠ¡æ¶æ„çš„å…³é”®ï¼š</p><h3 id="1-åˆ†å¸ƒå¼è¿½è¸ª"><a class="header-anchor" href="#1-åˆ†å¸ƒå¼è¿½è¸ª"></a>1. åˆ†å¸ƒå¼è¿½è¸ª</h3><p>ä½¿ç”¨OpenTelemetryå®ç°åˆ†å¸ƒå¼è¿½è¸ªï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;context&quot;</span>    <span class="hljs-string">&quot;log&quot;</span>        <span class="hljs-string">&quot;go.opentelemetry.io/otel&quot;</span>    <span class="hljs-string">&quot;go.opentelemetry.io/otel/exporters/jaeger&quot;</span>    <span class="hljs-string">&quot;go.opentelemetry.io/otel/sdk/resource&quot;</span>    sdktrace <span class="hljs-string">&quot;go.opentelemetry.io/otel/sdk/trace&quot;</span>    semconv <span class="hljs-string">&quot;go.opentelemetry.io/otel/semconv/v1.7.0&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initTracer</span><span class="hljs-params">()</span> <span class="hljs-title">func</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºJaegerå¯¼å‡ºå™¨</span>    exporter, err := jaeger.New(jaeger.WithCollectorEndpoint(        jaeger.WithEndpoint(<span class="hljs-string">&quot;http://jaeger:14268/api/traces&quot;</span>),    ))    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;Failed to create exporter: %v&quot;</span>, err)    &#125;        <span class="hljs-comment">// åˆ›å»ºèµ„æº</span>    res, err := resource.New(context.Background(),        resource.WithAttributes(            semconv.ServiceNameKey.String(<span class="hljs-string">&quot;user-service&quot;</span>),            semconv.ServiceVersionKey.String(<span class="hljs-string">&quot;1.0.0&quot;</span>),        ),    )    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;Failed to create resource: %v&quot;</span>, err)    &#125;        <span class="hljs-comment">// åˆ›å»ºè¿½è¸ªå™¨æä¾›è€…</span>    tp := sdktrace.NewTracerProvider(        sdktrace.WithBatcher(exporter),        sdktrace.WithResource(res),    )        <span class="hljs-comment">// è®¾ç½®å…¨å±€è¿½è¸ªå™¨æä¾›è€…</span>    otel.SetTracerProvider(tp)        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">if</span> err := tp.Shutdown(context.Background()); err != <span class="hljs-literal">nil</span> &#123;            log.Printf(<span class="hljs-string">&quot;Error shutting down tracer provider: %v&quot;</span>, err)        &#125;    &#125;&#125;<span class="hljs-comment">// åœ¨HTTPå¤„ç†å‡½æ•°ä¸­ä½¿ç”¨è¿½è¸ª</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserHandler</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;    ctx := c.Request.Context()    tracer := otel.Tracer(<span class="hljs-string">&quot;user-service&quot;</span>)        ctx, span := tracer.Start(ctx, <span class="hljs-string">&quot;GetUser&quot;</span>)    <span class="hljs-keyword">defer</span> span.End()        <span class="hljs-comment">// è·å–ç”¨æˆ·IDå¹¶æ·»åŠ åˆ°span</span>    userID := c.Param(<span class="hljs-string">&quot;id&quot;</span>)    span.SetAttributes(attribute.String(<span class="hljs-string">&quot;user.id&quot;</span>, userID))        <span class="hljs-comment">// è°ƒç”¨æœåŠ¡å±‚</span>    user, err := userService.GetUser(ctx, userID)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        span.RecordError(err)        <span class="hljs-comment">// å¤„ç†é”™è¯¯...</span>        <span class="hljs-keyword">return</span>    &#125;        c.JSON(<span class="hljs-number">200</span>, user)&#125;</code></pre><h3 id="2-æŒ‡æ ‡æ”¶é›†"><a class="header-anchor" href="#2-æŒ‡æ ‡æ”¶é›†"></a>2. æŒ‡æ ‡æ”¶é›†</h3><p>ä½¿ç”¨Prometheusæ”¶é›†æ€§èƒ½æŒ‡æ ‡ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;github.com/prometheus/client_golang/prometheus&quot;</span>    <span class="hljs-string">&quot;github.com/prometheus/client_golang/prometheus/promauto&quot;</span>)<span class="hljs-keyword">var</span> (    <span class="hljs-comment">// è¯·æ±‚è®¡æ•°å™¨</span>    requestsTotal = promauto.NewCounterVec(        prometheus.CounterOpts&#123;            Name: <span class="hljs-string">&quot;http_requests_total&quot;</span>,            Help: <span class="hljs-string">&quot;The total number of HTTP requests&quot;</span>,        &#125;,        []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;method&quot;</span>, <span class="hljs-string">&quot;endpoint&quot;</span>, <span class="hljs-string">&quot;status&quot;</span>&#125;,    )        <span class="hljs-comment">// è¯·æ±‚å»¶è¿Ÿç›´æ–¹å›¾</span>    requestDuration = promauto.NewHistogramVec(        prometheus.HistogramOpts&#123;            Name:    <span class="hljs-string">&quot;http_request_duration_seconds&quot;</span>,            Help:    <span class="hljs-string">&quot;HTTP request latency in seconds&quot;</span>,            Buckets: prometheus.DefBuckets,        &#125;,        []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;method&quot;</span>, <span class="hljs-string">&quot;endpoint&quot;</span>&#125;,    ))<span class="hljs-comment">// ä¸­é—´ä»¶ï¼šè®°å½•è¯·æ±‚æŒ‡æ ‡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MetricsMiddleware</span><span class="hljs-params">()</span> <span class="hljs-title">gin</span>.<span class="hljs-title">HandlerFunc</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;        start := time.Now()        path := c.Request.URL.Path        method := c.Request.Method                <span class="hljs-comment">// å¤„ç†è¯·æ±‚</span>        c.Next()                <span class="hljs-comment">// è®°å½•æŒ‡æ ‡</span>        status := strconv.Itoa(c.Writer.Status())        duration := time.Since(start).Seconds()                requestsTotal.WithLabelValues(method, path, status).Inc()        requestDuration.WithLabelValues(method, path).Observe(duration)    &#125;&#125;</code></pre><h2 id="ğŸŒ-APIç½‘å…³"><a class="header-anchor" href="#ğŸŒ-APIç½‘å…³"></a>ğŸŒ APIç½‘å…³</h2><p>APIç½‘å…³æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„é‡è¦ç»„ä»¶ï¼Œå®ƒæä¾›è·¯ç”±ã€è®¤è¯ã€é™æµç­‰åŠŸèƒ½ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ç®€åŒ–ç‰ˆAPIç½‘å…³</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    r := gin.Default()        <span class="hljs-comment">// é™æµä¸­é—´ä»¶</span>    limiter := rate.NewLimiter(<span class="hljs-number">100</span>, <span class="hljs-number">200</span>)  <span class="hljs-comment">// æ¯ç§’100ä¸ªè¯·æ±‚ï¼Œçªå‘200ä¸ª</span>    r.Use(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;        <span class="hljs-keyword">if</span> !limiter.Allow() &#123;            c.AbortWithStatus(<span class="hljs-number">429</span>) <span class="hljs-comment">// Too Many Requests</span>            <span class="hljs-keyword">return</span>        &#125;        c.Next()    &#125;)        <span class="hljs-comment">// JWTè®¤è¯ä¸­é—´ä»¶</span>    r.Use(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;        tokenString := c.GetHeader(<span class="hljs-string">&quot;Authorization&quot;</span>)        <span class="hljs-keyword">if</span> tokenString == <span class="hljs-string">&quot;&quot;</span> &#123;            c.AbortWithStatus(<span class="hljs-number">401</span>)            <span class="hljs-keyword">return</span>        &#125;                <span class="hljs-comment">// éªŒè¯JWTä»¤ç‰Œ</span>        <span class="hljs-comment">// ...</span>                c.Next()    &#125;)        <span class="hljs-comment">// è·¯ç”±åˆ°ç”¨æˆ·æœåŠ¡</span>    userGroup := r.Group(<span class="hljs-string">&quot;/api/users&quot;</span>)    &#123;        userConn := createServiceConnection(<span class="hljs-string">&quot;user-service:50051&quot;</span>)        userClient := pb.NewUserServiceClient(userConn)                userGroup.GET(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;            ctx := c.Request.Context()            resp, err := userClient.ListUsers(ctx, &amp;pb.ListUsersRequest&#123;&#125;)            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;                <span class="hljs-comment">// å¤„ç†é”™è¯¯</span>                <span class="hljs-keyword">return</span>            &#125;            c.JSON(<span class="hljs-number">200</span>, resp)        &#125;)                userGroup.GET(<span class="hljs-string">&quot;/:id&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;            <span class="hljs-comment">// è½¬å‘åˆ°ç”¨æˆ·æœåŠ¡</span>        &#125;)                <span class="hljs-comment">// æ›´å¤šè·¯ç”±...</span>    &#125;        <span class="hljs-comment">// è·¯ç”±åˆ°è®¢å•æœåŠ¡</span>    orderGroup := r.Group(<span class="hljs-string">&quot;/api/orders&quot;</span>)    &#123;        <span class="hljs-comment">// ç±»ä¼¼å®ç°...</span>    &#125;        r.Run(<span class="hljs-string">&quot;:8000&quot;</span>)&#125;</code></pre><h2 id="ğŸ“-å¾®æœåŠ¡æµ‹è¯•ç­–ç•¥"><a class="header-anchor" href="#ğŸ“-å¾®æœåŠ¡æµ‹è¯•ç­–ç•¥"></a>ğŸ“ å¾®æœåŠ¡æµ‹è¯•ç­–ç•¥</h2><p>å¾®æœåŠ¡æµ‹è¯•éœ€è¦æ³¨æ„æœåŠ¡é—´ä¾èµ–ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä½¿ç”¨testcontainersè¿›è¡Œé›†æˆæµ‹è¯•</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestOrderService_Integration</span><span class="hljs-params">(t *testing.T)</span></span> &#123;    <span class="hljs-comment">// å¯åŠ¨PostgreSQLå®¹å™¨</span>    pgContainer, err := testcontainers.GenericContainer(        context.Background(),        testcontainers.GenericContainerRequest&#123;            ContainerRequest: testcontainers.ContainerRequest&#123;                Image:        <span class="hljs-string">&quot;postgres:14&quot;</span>,                ExposedPorts: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;5432/tcp&quot;</span>&#125;,                Env: <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>&#123;                    <span class="hljs-string">&quot;POSTGRES_USER&quot;</span>:     <span class="hljs-string">&quot;test&quot;</span>,                    <span class="hljs-string">&quot;POSTGRES_PASSWORD&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>,                    <span class="hljs-string">&quot;POSTGRES_DB&quot;</span>:       <span class="hljs-string">&quot;testdb&quot;</span>,                &#125;,                WaitingFor: wait.ForListeningPort(<span class="hljs-string">&quot;5432/tcp&quot;</span>),            &#125;,        &#125;,    )    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        t.Fatal(err)    &#125;    <span class="hljs-keyword">defer</span> pgContainer.Terminate(context.Background())        <span class="hljs-comment">// è·å–è¿æ¥ä¿¡æ¯</span>    pgHost, err := pgContainer.Host(context.Background())    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        t.Fatal(err)    &#125;    pgPort, err := pgContainer.MappedPort(context.Background(), <span class="hljs-string">&quot;5432&quot;</span>)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        t.Fatal(err)    &#125;        <span class="hljs-comment">// é…ç½®æ•°æ®åº“è¿æ¥</span>    dsn := fmt.Sprintf(<span class="hljs-string">&quot;host=%s port=%s user=test password=test dbname=testdb sslmode=disable&quot;</span>,        pgHost, pgPort.Port())        <span class="hljs-comment">// è®¾ç½®æ•°æ®åº“</span>    db, err := gorm.Open(postgres.Open(dsn), &amp;gorm.Config&#123;&#125;)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        t.Fatal(err)    &#125;        <span class="hljs-comment">// è¿ç§»è¡¨ç»“æ„</span>    db.AutoMigrate(&amp;Order&#123;&#125;, &amp;OrderItem&#123;&#125;)        <span class="hljs-comment">// åˆ›å»ºå­˜å‚¨åº“å’ŒæœåŠ¡</span>    repo := repository.NewOrderRepository(db)    service := service.NewOrderService(repo)        <span class="hljs-comment">// æµ‹è¯•ä¸šåŠ¡é€»è¾‘</span>    t.Run(<span class="hljs-string">&quot;CreateOrder&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;        order, err := service.CreateOrder(context.Background(), &amp;CreateOrderRequest&#123;            UserID: <span class="hljs-string">&quot;user123&quot;</span>,            Items: []OrderItemRequest&#123;                &#123;ProductID: <span class="hljs-string">&quot;prod1&quot;</span>, Quantity: <span class="hljs-number">2</span>, Price: <span class="hljs-number">10.00</span>&#125;,            &#125;,        &#125;)                assert.NoError(t, err)        assert.NotEmpty(t, order.ID)        assert.Equal(t, <span class="hljs-string">&quot;user123&quot;</span>, order.UserID)        assert.Equal(t, <span class="hljs-number">20.00</span>, order.TotalAmount)    &#125;)&#125;</code></pre><h2 id="ğŸ”-å®‰å…¨æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸ”-å®‰å…¨æœ€ä½³å®è·µ"></a>ğŸ” å®‰å…¨æœ€ä½³å®è·µ</h2><p>å¾®æœåŠ¡å®‰å…¨æ¶‰åŠå¤šä¸ªæ–¹é¢ï¼š</p><ol><li><strong>æœåŠ¡é—´è®¤è¯</strong>ï¼šä½¿ç”¨mTLSå®ç°æœåŠ¡é—´å®‰å…¨é€šä¿¡</li><li><strong>ç§˜å¯†ç®¡ç†</strong>ï¼šä½¿ç”¨Vaultæˆ–Kubernetes Secretsç®¡ç†æ•æ„Ÿä¿¡æ¯</li><li><strong>æœ€å°æƒé™</strong>ï¼šæœåŠ¡åªèƒ½è®¿é—®å¿…éœ€çš„èµ„æº</li><li><strong>APIå®‰å…¨</strong>ï¼šå®æ–½é€Ÿç‡é™åˆ¶ã€è¾“å…¥éªŒè¯å’Œè®¤è¯</li></ol><pre><code class="hljs go"><span class="hljs-comment">// mTLSé…ç½®ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createSecureGrpcServer</span><span class="hljs-params">()</span> *<span class="hljs-title">grpc</span>.<span class="hljs-title">Server</span></span> &#123;    <span class="hljs-comment">// åŠ è½½CAè¯ä¹¦</span>    caPem, err := os.ReadFile(<span class="hljs-string">&quot;ca.pem&quot;</span>)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;Failed to load CA cert: %v&quot;</span>, err)    &#125;        caPool := x509.NewCertPool()    <span class="hljs-keyword">if</span> !caPool.AppendCertsFromPEM(caPem) &#123;        log.Fatal(<span class="hljs-string">&quot;Failed to add CA cert to pool&quot;</span>)    &#125;        <span class="hljs-comment">// åŠ è½½æœåŠ¡å™¨è¯ä¹¦å’Œç§é’¥</span>    cert, err := tls.LoadX509KeyPair(<span class="hljs-string">&quot;server.pem&quot;</span>, <span class="hljs-string">&quot;server.key&quot;</span>)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;Failed to load server cert/key: %v&quot;</span>, err)    &#125;        <span class="hljs-comment">// åˆ›å»ºTLSé…ç½®</span>    tlsConfig := &amp;tls.Config&#123;        Certificates: []tls.Certificate&#123;cert&#125;,        ClientAuth:   tls.RequireAndVerifyClientCert,        ClientCAs:    caPool,    &#125;        <span class="hljs-comment">// åˆ›å»ºTLSå‡­è¯</span>    creds := credentials.NewTLS(tlsConfig)        <span class="hljs-comment">// åˆ›å»ºå¸¦TLSçš„gRPCæœåŠ¡å™¨</span>    <span class="hljs-keyword">return</span> grpc.NewServer(grpc.Creds(creds))&#125;</code></pre><h2 id="ğŸ­-éƒ¨ç½²ä¸æ‰©å±•"><a class="header-anchor" href="#ğŸ­-éƒ¨ç½²ä¸æ‰©å±•"></a>ğŸ­ éƒ¨ç½²ä¸æ‰©å±•</h2><p>å¾®æœåŠ¡éƒ¨ç½²é€šå¸¸é‡‡ç”¨å®¹å™¨åŒ–æ–¹å¼ï¼š</p><pre><code class="hljs dockerfile"><span class="hljs-comment"># Dockerfile</span><span class="hljs-keyword">FROM</span> golang:<span class="hljs-number">1.21</span>-alpine AS builder<span class="hljs-keyword">WORKDIR</span><span class="bash"> /app</span><span class="hljs-keyword">COPY</span><span class="bash"> go.mod go.sum ./</span><span class="hljs-keyword">RUN</span><span class="bash"> go mod download</span><span class="hljs-keyword">COPY</span><span class="bash"> . .</span><span class="hljs-keyword">RUN</span><span class="bash"> CGO_ENABLED=0 go build -o server ./cmd/server</span><span class="hljs-keyword">FROM</span> alpine:<span class="hljs-number">3.18</span><span class="hljs-keyword">RUN</span><span class="bash"> apk --no-cache add ca-certificates</span><span class="hljs-keyword">WORKDIR</span><span class="bash"> /app</span><span class="hljs-keyword">COPY</span><span class="bash"> --from=builder /app/server .</span><span class="hljs-keyword">COPY</span><span class="bash"> config/config.yaml ./config/</span><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span> <span class="hljs-number">50051</span><span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">&quot;./server&quot;</span>]</span></code></pre><p>Kuberneteséƒ¨ç½²é…ç½®ï¼š</p><pre><code class="hljs yaml"><span class="hljs-comment"># deployment.yaml</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">user-service</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>  <span class="hljs-attr">selector:</span>    <span class="hljs-attr">matchLabels:</span>      <span class="hljs-attr">app:</span> <span class="hljs-string">user-service</span>  <span class="hljs-attr">template:</span>    <span class="hljs-attr">metadata:</span>      <span class="hljs-attr">labels:</span>        <span class="hljs-attr">app:</span> <span class="hljs-string">user-service</span>    <span class="hljs-attr">spec:</span>      <span class="hljs-attr">containers:</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">user-service</span>        <span class="hljs-attr">image:</span> <span class="hljs-string">my-registry/user-service:1.0.0</span>        <span class="hljs-attr">ports:</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>          <span class="hljs-attr">name:</span> <span class="hljs-string">http</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">50051</span>          <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span>        <span class="hljs-attr">resources:</span>          <span class="hljs-attr">requests:</span>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;100m&quot;</span>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;128Mi&quot;</span>          <span class="hljs-attr">limits:</span>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;500m&quot;</span>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;512Mi&quot;</span>        <span class="hljs-attr">readinessProbe:</span>          <span class="hljs-attr">httpGet:</span>            <span class="hljs-attr">path:</span> <span class="hljs-string">/health</span>            <span class="hljs-attr">port:</span> <span class="hljs-string">http</span>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span>          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>        <span class="hljs-attr">livenessProbe:</span>          <span class="hljs-attr">httpGet:</span>            <span class="hljs-attr">path:</span> <span class="hljs-string">/health</span>            <span class="hljs-attr">port:</span> <span class="hljs-string">http</span>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">15</span>          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">20</span>        <span class="hljs-attr">env:</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DATABASE_HOST</span>          <span class="hljs-attr">valueFrom:</span>            <span class="hljs-attr">configMapKeyRef:</span>              <span class="hljs-attr">name:</span> <span class="hljs-string">user-service-config</span>              <span class="hljs-attr">key:</span> <span class="hljs-string">db.host</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DATABASE_PASSWORD</span>          <span class="hljs-attr">valueFrom:</span>            <span class="hljs-attr">secretKeyRef:</span>              <span class="hljs-attr">name:</span> <span class="hljs-string">user-service-secrets</span>              <span class="hljs-attr">key:</span> <span class="hljs-string">db.password</span><span class="hljs-meta">---</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">user-service</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">selector:</span>    <span class="hljs-attr">app:</span> <span class="hljs-string">user-service</span>  <span class="hljs-attr">ports:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span>    <span class="hljs-attr">port:</span> <span class="hljs-number">50051</span>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">50051</span></code></pre><h2 id="ğŸ”®-å¾®æœåŠ¡æ²»ç†"><a class="header-anchor" href="#ğŸ”®-å¾®æœåŠ¡æ²»ç†"></a>ğŸ”® å¾®æœåŠ¡æ²»ç†</h2><p>éšç€æœåŠ¡æ•°é‡å¢åŠ ï¼Œå¾®æœåŠ¡æ²»ç†å˜å¾—å…³é”®ï¼š</p><h3 id="1-ç†”æ–­ä¸é™çº§"><a class="header-anchor" href="#1-ç†”æ–­ä¸é™çº§"></a>1. ç†”æ–­ä¸é™çº§</h3><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/afex/hystrix-go/hystrix&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// é…ç½®ç†”æ–­å™¨</span>    hystrix.ConfigureCommand(<span class="hljs-string">&quot;get_user&quot;</span>, hystrix.CommandConfig&#123;        Timeout:               <span class="hljs-number">1000</span>, <span class="hljs-comment">// è¶…æ—¶æ—¶é—´(ms)</span>        MaxConcurrentRequests: <span class="hljs-number">100</span>,  <span class="hljs-comment">// æœ€å¤§å¹¶å‘è¯·æ±‚</span>        ErrorPercentThreshold: <span class="hljs-number">25</span>,   <span class="hljs-comment">// é”™è¯¯ç™¾åˆ†æ¯”é˜ˆå€¼</span>    &#125;)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserWithFallback</span><span class="hljs-params">(ctx context.Context, client pb.UserServiceClient, userID <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*pb.User, error)</span></span> &#123;    <span class="hljs-keyword">var</span> user *pb.User    <span class="hljs-keyword">var</span> err error        <span class="hljs-comment">// ä½¿ç”¨ç†”æ–­å™¨åŒ…è£…è°ƒç”¨</span>    err = hystrix.Do(<span class="hljs-string">&quot;get_user&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;        <span class="hljs-keyword">var</span> callErr error        user, callErr = client.GetUser(ctx, &amp;pb.GetUserRequest&#123;Id: userID&#125;)        <span class="hljs-keyword">return</span> callErr    &#125;, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(he error)</span> <span class="hljs-title">error</span></span> &#123;        <span class="hljs-comment">// é™çº§å¤„ç†</span>        log.Printf(<span class="hljs-string">&quot;Circuit open or error: %v, using fallback&quot;</span>, he)        user = getFallbackUser(userID)        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>    &#125;)        <span class="hljs-keyword">return</span> user, err&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getFallbackUser</span><span class="hljs-params">(userID <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">pb</span>.<span class="hljs-title">User</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;pb.User&#123;        Id:   userID,        Name: <span class="hljs-string">&quot;Unknown User&quot;</span>,    &#125;&#125;</code></pre><h3 id="2-æœåŠ¡ç½‘æ ¼"><a class="header-anchor" href="#2-æœåŠ¡ç½‘æ ¼"></a>2. æœåŠ¡ç½‘æ ¼</h3><p>ä½¿ç”¨Istioç­‰æœåŠ¡ç½‘æ ¼ç®€åŒ–å¾®æœåŠ¡æ²»ç†ï¼š</p><pre><code class="hljs yaml"><span class="hljs-comment"># Istio VirtualServiceé…ç½®ç¤ºä¾‹</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span><span class="hljs-attr">kind:</span> <span class="hljs-string">VirtualService</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">user-service</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">hosts:</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">user-service</span>  <span class="hljs-attr">http:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">route:</span>    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>        <span class="hljs-attr">host:</span> <span class="hljs-string">user-service</span>        <span class="hljs-attr">subset:</span> <span class="hljs-string">v1</span>      <span class="hljs-attr">weight:</span> <span class="hljs-number">90</span>    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>        <span class="hljs-attr">host:</span> <span class="hljs-string">user-service</span>        <span class="hljs-attr">subset:</span> <span class="hljs-string">v2</span>      <span class="hljs-attr">weight:</span> <span class="hljs-number">10</span>    <span class="hljs-attr">retries:</span>      <span class="hljs-attr">attempts:</span> <span class="hljs-number">3</span>      <span class="hljs-attr">perTryTimeout:</span> <span class="hljs-string">2s</span>    <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span></code></pre><h2 id="ğŸ’¡-æ€»ç»“"><a class="header-anchor" href="#ğŸ’¡-æ€»ç»“"></a>ğŸ’¡ æ€»ç»“</h2><p>Goè¯­è¨€å‡­å€Ÿå…¶å‡ºè‰²çš„å¹¶å‘æ€§èƒ½å’Œç®€æ´çš„è¯­æ³•ï¼Œæˆä¸ºæ„å»ºå¾®æœåŠ¡çš„ç†æƒ³é€‰æ‹©ã€‚é€šè¿‡æœ¬æ–‡ä»‹ç»çš„æ¶æ„è®¾è®¡å’Œæœ€ä½³å®è·µï¼Œä½ å¯ä»¥æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€å¯é ä¸”å¯æ‰©å±•çš„å¾®æœåŠ¡ç³»ç»Ÿã€‚</p><p>å¾®æœåŠ¡æ¶æ„ä¸æ˜¯é“¶å¼¹ï¼Œå®ƒä¹Ÿå¸¦æ¥äº†é¢å¤–çš„å¤æ‚æ€§ã€‚ä½†åœ¨å¤§å‹åº”ç”¨å’Œå›¢é˜Ÿä¸­ï¼Œå¾®æœåŠ¡çš„ä¼˜åŠ¿é€šå¸¸è¿œå¤§äºå®ƒçš„æˆæœ¬ã€‚é€šè¿‡åˆç†çš„æŠ€æœ¯é€‰å‹å’Œæ¶æ„è®¾è®¡ï¼Œæˆ‘ä»¬å¯ä»¥æœ€å¤§åŒ–å¾®æœåŠ¡å¸¦æ¥çš„æ”¶ç›Šï¼ŒåŒæ—¶é™ä½å…¶å¤æ‚æ€§ã€‚</p><p>åœ¨å®é™…å®æ–½è¿‡ç¨‹ä¸­ï¼Œå»ºè®®é‡‡å–æ¸è¿›å¼ç­–ç•¥ï¼šä»å•ä½“åº”ç”¨å¼€å§‹ï¼Œéšç€ä¸šåŠ¡çš„å¢é•¿å’Œå¤æ‚æ€§çš„æé«˜ï¼Œé€æ­¥æ‹†åˆ†ä¸ºå¾®æœåŠ¡ï¼Œè€Œä¸æ˜¯ä¸€å¼€å§‹å°±ç›²ç›®è¿½æ±‚å®Œå…¨çš„å¾®æœåŠ¡æ¶æ„ã€‚</p><p>ä½ æœ‰ä»€ä¹ˆå¾®æœåŠ¡å®è·µç»éªŒæˆ–é—®é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®ºï¼</p>]]></content>
    
    
    <categories>
      
      <category>å¾®æœåŠ¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
      <tag>gRPC</tag>
      
      <tag>æœåŠ¡å‘ç°</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang å®ç°ä¸€ä¸ªå‘å¸ƒè®¢é˜…äº‹ä»¶ç»„ä»¶</title>
    <link href="/2025/01/06/golang-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E4%BA%8B%E4%BB%B6%E7%BB%84%E4%BB%B6/"/>
    <url>/2025/01/06/golang-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E4%BA%8B%E4%BB%B6%E7%BB%84%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="golang-å®ç°ä¸€ä¸ªå‘å¸ƒè®¢é˜…æ—¶é—´ç»„ä»¶"><a class="header-anchor" href="#golang-å®ç°ä¸€ä¸ªå‘å¸ƒè®¢é˜…æ—¶é—´ç»„ä»¶"></a>golang å®ç°ä¸€ä¸ªå‘å¸ƒè®¢é˜…æ—¶é—´ç»„ä»¶</h2><h3 id="ğŸˆè€è§„çŸ©ï¼Œå®ç°æ€è·¯"><a class="header-anchor" href="#ğŸˆè€è§„çŸ©ï¼Œå®ç°æ€è·¯"></a>ğŸˆè€è§„çŸ©ï¼Œå®ç°æ€è·¯</h3><ul><li>å®ç°ä¸€ä¸ªå¹¿æ’­å™¨ï¼Œä¸»è¦æœ‰è®¢é˜…é€šé“ <code>channel</code> å’Œ å‘å¸ƒè®¢é˜…äº‹ä»¶ <code>publish()</code> å¹¿æ’­äº‹ä»¶å‘é€ <code>send()</code>ç»„æˆ</li><li>ä½¿ç”¨ <code>sync</code>åŒ…ç®¡ç†äº‹ä»¶æ˜ å°„å…³ç³»<code>map</code></li><li>ä½¿ç”¨äº’æ–¥é” <code>sync.Mutex</code> æ£€æŸ¥å¹¿æ’­å™¨çŠ¶æ€å’Œè®¢é˜…è€…çš„ä¼˜é›…å…³é—­é€€å‡º</li><li>å¹¿æ’­æ¶ˆæ¯é€šè¿‡å¹¿æ’­å™¨ <code>channel</code> åˆ†å‘åˆ°å„ä¸ªè®¢é˜…è€…ï¼ˆ<code>channel</code>ï¼‰</li></ul><h3 id="ğŸ“ƒå…·ä½“å®ç°ä»£ç "><a class="header-anchor" href="#ğŸ“ƒå…·ä½“å®ç°ä»£ç "></a>ğŸ“ƒå…·ä½“å®ç°ä»£ç </h3><h4 id="äº‹ä»¶æšä¸¾"><a class="header-anchor" href="#äº‹ä»¶æšä¸¾"></a>äº‹ä»¶æšä¸¾</h4><pre><code class="hljs go"><span class="hljs-keyword">package</span> event<span class="hljs-keyword">const</span> (<span class="hljs-comment">// ConfigChangeEvent é…ç½®å˜æ›´äº‹ä»¶</span>ConfigChangeEvent = <span class="hljs-string">&quot;config-change&quot;</span>)<span class="hljs-comment">// Events äº‹ä»¶</span><span class="hljs-keyword">var</span> Events = []<span class="hljs-keyword">string</span>&#123;ConfigChangeEvent,&#125;</code></pre><h4 id="ä¸»è¦é€»è¾‘"><a class="header-anchor" href="#ä¸»è¦é€»è¾‘"></a>ä¸»è¦é€»è¾‘</h4><pre><code class="hljs go"><span class="hljs-keyword">package</span> event<span class="hljs-keyword">import</span> (<span class="hljs-string">&quot;errors&quot;</span><span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-string">&quot;sync&quot;</span><span class="hljs-string">&quot;time&quot;</span><span class="hljs-string">&quot;gitlab.com/bopop/tool&quot;</span><span class="hljs-string">&quot;gitlab.com/bopop/log&quot;</span>)<span class="hljs-comment">// Broadcast å¹¿æ’­å™¨æ¥å£</span><span class="hljs-keyword">type</span> Broadcast <span class="hljs-keyword">interface</span> &#123;publish()Subscribe(<span class="hljs-keyword">chan</span>&lt;- any)Send(any)Close()&#125;<span class="hljs-comment">// Broadcaster å¹¿æ’­å™¨</span><span class="hljs-keyword">type</span> Broadcaster <span class="hljs-keyword">struct</span> &#123;subscribers []<span class="hljs-keyword">chan</span>&lt;- anybroadcast   <span class="hljs-keyword">chan</span> anymux         sync.MutexeventName   <span class="hljs-keyword">string</span>closeChan   <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;closed      <span class="hljs-keyword">bool</span>&#125;<span class="hljs-comment">// BroadcasterMap å¹¿æ’­å™¨æ˜ å°„</span><span class="hljs-keyword">var</span> BroadcasterMap sync.Map<span class="hljs-comment">// NewBroadcaster åˆ›å»ºä¸€ä¸ªæ–°çš„ Broadcaster</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewBroadcaster</span><span class="hljs-params">(event <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">Broadcaster</span></span> &#123;<span class="hljs-keyword">if</span> !tool.InSlice(event, Events) &#123;log.ErrorP(fmt.Sprintf(<span class="hljs-string">&quot;invalid event: %s&quot;</span>, event))<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-keyword">if</span> _, exist := BroadcasterMap.Load(event); exist &#123;log.ErrorP(fmt.Sprintf(<span class="hljs-string">&quot;event %s already exists&quot;</span>, event))<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;b := &amp;Broadcaster&#123;subscribers: <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">chan</span>&lt;- any, <span class="hljs-number">0</span>),broadcast:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> any),eventName:   event,closeChan:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;),closed:      <span class="hljs-literal">false</span>,&#125;BroadcasterMap.Store(event, b)b.publish() <span class="hljs-comment">// è‡ªåŠ¨å¼€å§‹å‘å¸ƒ</span><span class="hljs-keyword">return</span> b&#125;<span class="hljs-comment">// Close åœæ­¢å¹¿æ’­å¹¶å…³é—­æ‰€æœ‰è®¢é˜…è€…é€šé“</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Broadcaster)</span> <span class="hljs-title">Close</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">if</span> nilObjReturn(b) != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span>&#125;b.mux.Lock()<span class="hljs-keyword">defer</span> b.mux.Unlock()<span class="hljs-keyword">if</span> !b.closed &#123;b.closed = <span class="hljs-literal">true</span><span class="hljs-built_in">close</span>(b.closeChan) <span class="hljs-comment">// å‘goroutineå‘å‡ºå…³é—­ä¿¡å·</span><span class="hljs-keyword">for</span> _, sub := <span class="hljs-keyword">range</span> b.subscribers &#123;<span class="hljs-built_in">close</span>(sub) <span class="hljs-comment">// ä¸»åŠ¨å…³é—­æ‰€æœ‰è®¢é˜…è€…é€šé“</span>&#125;BroadcasterMap.Delete(b.eventName)                     <span class="hljs-comment">// ä»mapä¸­ç§»é™¤</span>log.InfoP(fmt.Sprintf(<span class="hljs-string">&quot;closed %s event&quot;</span>, b.eventName)) <span class="hljs-comment">// nolint:gosimple</span>&#125;&#125;<span class="hljs-comment">// CloseAll å…³é—­æ‰€æœ‰äº‹ä»¶å¹¿æ’­å’Œè®¢é˜…è€…</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CloseAll</span><span class="hljs-params">()</span></span> &#123;BroadcasterMap.Range(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(key, value <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span> &#123;value.(*Broadcaster).Close()<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>&#125;)log.InfoP(<span class="hljs-string">&quot;closed all events&quot;</span>)&#125;<span class="hljs-comment">// GetBroadcaster è·å–ä¸€ä¸ª Broadcaster</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetBroadcaster</span><span class="hljs-params">(event <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">Broadcaster</span></span> &#123;<span class="hljs-keyword">if</span> v, ok := BroadcasterMap.Load(event); ok &#123;<span class="hljs-keyword">return</span> v.(*Broadcaster)&#125;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// publish å‘å¸ƒè®¢é˜…äº‹ä»¶</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Broadcaster)</span> <span class="hljs-title">publish</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">for</span> &#123;<span class="hljs-keyword">select</span> &#123;<span class="hljs-keyword">case</span> msg, ok := &lt;-b.broadcast:<span class="hljs-keyword">if</span> !ok &#123;<span class="hljs-keyword">return</span> <span class="hljs-comment">// å¦‚æœ broadcast è¢«å…³é—­ï¼Œç»“æŸ goroutine</span>&#125;<span class="hljs-comment">// å‘é€æ¶ˆæ¯åˆ°è®¢é˜…è€…</span>b.mux.Lock()<span class="hljs-keyword">for</span> _, sub := <span class="hljs-keyword">range</span> b.subscribers &#123;sub &lt;- msg&#125;b.mux.Unlock()<span class="hljs-keyword">case</span> &lt;-b.closeChan:<span class="hljs-keyword">return</span> <span class="hljs-comment">// æ”¶åˆ°å…³é—­ä¿¡å·ï¼Œç»“æŸ goroutine</span>&#125;&#125;&#125;()<span class="hljs-comment">// ç»™ä¸€ä¸ª 100ms çš„å»¶æ—¶ï¼Œä¿è¯å‘å¸ƒäº‹ä»¶ goroutine å·²ç»å¯åŠ¨</span>time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)log.InfoP(fmt.Sprintf(<span class="hljs-string">&quot;publish event: %v&quot;</span>, b.eventName)) <span class="hljs-comment">// nolint:gosimple</span>&#125;<span class="hljs-comment">// Subscribe æ³¨å†Œä¸€ä¸ªè®¢é˜…è€…çš„é€šé“</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Broadcaster)</span> <span class="hljs-title">Subscribe</span><span class="hljs-params">(sub <span class="hljs-keyword">chan</span>&lt;- any)</span></span> &#123;<span class="hljs-keyword">if</span> err := nilObjReturn(b); err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span>&#125;b.mux.Lock()<span class="hljs-keyword">defer</span> b.mux.Unlock()<span class="hljs-keyword">if</span> b.closed &#123;errStr := fmt.Sprintf(<span class="hljs-string">&quot;attempt to subscribe to closed broadcaster: %v&quot;</span>, b.eventName)log.InfoP(errStr)sub &lt;- errors.New(errStr)<span class="hljs-built_in">close</span>(sub)<span class="hljs-keyword">return</span>&#125;b.subscribers = <span class="hljs-built_in">append</span>(b.subscribers, sub)&#125;<span class="hljs-comment">// Send å¹¿æ’­ä¸€ä¸ªæ¶ˆæ¯ç»™æ‰€æœ‰è®¢é˜…è€…</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Broadcaster)</span> <span class="hljs-title">Send</span><span class="hljs-params">(msg any)</span></span> &#123;<span class="hljs-keyword">if</span> err := nilObjReturn(b); err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span>&#125;b.mux.Lock()subCount := <span class="hljs-built_in">len</span>(b.subscribers)closed := b.closedb.mux.Unlock()<span class="hljs-keyword">if</span> closed &#123;log.InfoP(fmt.Sprintf(<span class="hljs-string">&quot;broadcast to closed event: %v&quot;</span>, b.eventName)) <span class="hljs-comment">// nolint:gosimple</span><span class="hljs-keyword">return</span>&#125;<span class="hljs-keyword">if</span> subCount == <span class="hljs-number">0</span> &#123;log.InfoP(fmt.Sprintf(<span class="hljs-string">&quot;no subscribers for event: %v&quot;</span>, b.eventName)) <span class="hljs-comment">// nolint:gosimple</span><span class="hljs-keyword">return</span>&#125;<span class="hljs-keyword">select</span> &#123;<span class="hljs-keyword">case</span> b.broadcast &lt;- msg:<span class="hljs-comment">// æ¶ˆæ¯å‘é€æˆåŠŸ</span><span class="hljs-keyword">default</span>:<span class="hljs-comment">// é€šé“å·²æ»¡ï¼Œè®°å½•è­¦å‘Š</span>log.InfoP(fmt.Sprintf(<span class="hljs-string">&quot;broadcast channel is full for event %v&quot;</span>, b.eventName)) <span class="hljs-comment">// nolint:gosimple</span>&#125;&#125;<span class="hljs-comment">// nilObjReturn æ£€æŸ¥ Broadcaster æ˜¯å¦ä¸º nil</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">nilObjReturn</span><span class="hljs-params">(b *Broadcaster)</span> <span class="hljs-params">(err error)</span></span> &#123;<span class="hljs-keyword">if</span> b == <span class="hljs-literal">nil</span> &#123;errStr := <span class="hljs-string">&quot;called on nil broadcaster&quot;</span>log.InfoP(errStr)<span class="hljs-keyword">return</span> errors.New(errStr)&#125;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="è‡ªæµ‹"><a class="header-anchor" href="#è‡ªæµ‹"></a>è‡ªæµ‹</h4><pre><code class="hljs go"><span class="hljs-keyword">package</span> event_test<span class="hljs-keyword">import</span> (<span class="hljs-string">&quot;testing&quot;</span><span class="hljs-string">&quot;time&quot;</span><span class="hljs-string">&quot;gitlab.com/bopop/event&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestBroadcaster</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<span class="hljs-comment">// åˆ›å»ºBroadcaster</span>event.Events = <span class="hljs-built_in">append</span>(event.Events, <span class="hljs-string">&quot;testEvent&quot;</span>)b := event.NewBroadcaster(<span class="hljs-string">&quot;testEvent&quot;</span>)<span class="hljs-comment">// åˆ›å»ºè®¢é˜…è€…é€šé“å¹¶è®¢é˜…</span>sub := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> any)b.Subscribe(sub)<span class="hljs-comment">// å‘é€æ¶ˆæ¯</span>msg := <span class="hljs-string">&quot;hello world&quot;</span>b.Send(msg)<span class="hljs-comment">// ä»è®¢é˜…è€…é€šé“ä¸­è·å–æ¶ˆæ¯</span><span class="hljs-keyword">select</span> &#123;<span class="hljs-keyword">case</span> receivedMsg := &lt;-sub:<span class="hljs-keyword">if</span> receivedMsg != msg &#123;t.Errorf(<span class="hljs-string">&quot;expected message &#x27;%v&#x27;, got &#x27;%v&#x27;&quot;</span>, msg, receivedMsg)&#125;<span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">1</span> * time.Second):t.Fatal(<span class="hljs-string">&quot;did not receive message in time&quot;</span>)&#125;<span class="hljs-comment">// æµ‹è¯•å…³é—­</span>b.Close()<span class="hljs-comment">// å°è¯•ç›‘å¬å…³é—­çš„é€šé“ï¼Œç¡®ä¿é€šé“å·²å…³é—­</span>_, ok := &lt;-sub<span class="hljs-keyword">if</span> ok &#123;t.Errorf(<span class="hljs-string">&quot;expected closed channel, but it&#x27;s still open&quot;</span>)&#125;<span class="hljs-comment">// å†æ¬¡è®¢é˜…å¹¶ç¡®è®¤é”™è¯¯è¿”å›</span>sub2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> any, <span class="hljs-number">1</span>)b.Subscribe(sub2)receivedError, ok := &lt;-sub2<span class="hljs-keyword">if</span> !ok &#123;t.Errorf(<span class="hljs-string">&quot;expected error on subscribing to closed broadcaster, but channel is open&quot;</span>)&#125;<span class="hljs-keyword">if</span> receivedError == <span class="hljs-literal">nil</span> &#123;t.Errorf(<span class="hljs-string">&quot;expected error on subscribing to closed broadcaster, but got nil&quot;</span>)&#125;&#125;<span class="hljs-comment">// æµ‹è¯•å…³é—­æ‰€æœ‰ Broadcaster</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestCloseAll</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<span class="hljs-comment">// åˆ›å»ºä¸¤ä¸ªBroadcaster</span>event.Events = <span class="hljs-built_in">append</span>(event.Events, <span class="hljs-string">&quot;testEvent1&quot;</span>, <span class="hljs-string">&quot;testEvent2&quot;</span>)b1 := event.NewBroadcaster(<span class="hljs-string">&quot;testEvent1&quot;</span>)b2 := event.NewBroadcaster(<span class="hljs-string">&quot;testEvent2&quot;</span>)<span class="hljs-comment">// åˆ›å»ºè®¢é˜…è€…å¹¶è®¢é˜…</span>sub1 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> any, <span class="hljs-number">1</span>)sub2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> any, <span class="hljs-number">1</span>)b1.Subscribe(sub1)b2.Subscribe(sub2)<span class="hljs-comment">// ä½¿ç”¨CloseAllå…³é—­æ‰€æœ‰Broadcaster</span>event.CloseAll()<span class="hljs-comment">// ç¡®è®¤æ‰€æœ‰è®¢é˜…è€…é€šé“å·²å…³é—­</span>_, ok := &lt;-sub1<span class="hljs-keyword">if</span> ok &#123;t.Errorf(<span class="hljs-string">&quot;expected closed channel for Broadcaster 1, but it&#x27;s still open&quot;</span>)&#125;_, ok = &lt;-sub2<span class="hljs-keyword">if</span> ok &#123;t.Errorf(<span class="hljs-string">&quot;expected closed channel for Broadcaster 2, but it&#x27;s still open&quot;</span>)&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestBroadcastToMultipleSubscribers</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„Broadcaster</span>event.Events = <span class="hljs-built_in">append</span>(event.Events, <span class="hljs-string">&quot;multiSubEvent&quot;</span>)b := event.NewBroadcaster(<span class="hljs-string">&quot;multiSubEvent&quot;</span>)<span class="hljs-comment">// åˆ›å»ºå¤šä¸ªè®¢é˜…è€…å¹¶è®¢é˜…</span>subscriberCount := <span class="hljs-number">3</span>subscribers := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">chan</span> any, subscriberCount)<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; subscriberCount; i++ &#123;subscribers[i] = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> any, <span class="hljs-number">1</span>) <span class="hljs-comment">// Buffer to prevent blocking</span>b.Subscribe(subscribers[i])&#125;<span class="hljs-comment">// å‘é€æ¶ˆæ¯</span>expectedMsg := <span class="hljs-string">&quot;broadcast message&quot;</span>b.Send(expectedMsg)<span class="hljs-comment">// ç¡®è®¤æ‰€æœ‰è®¢é˜…è€…éƒ½æ”¶åˆ°äº†æ¶ˆæ¯</span><span class="hljs-keyword">for</span> i, sub := <span class="hljs-keyword">range</span> subscribers &#123;<span class="hljs-keyword">select</span> &#123;<span class="hljs-keyword">case</span> msg := &lt;-sub:<span class="hljs-keyword">if</span> msg != expectedMsg &#123;t.Errorf(<span class="hljs-string">&quot;subscriber %d received wrong message: got %v, want %v&quot;</span>, i, msg, expectedMsg)&#125;<span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">1</span> * time.Second):t.Fatalf(<span class="hljs-string">&quot;subscriber %d did not receive message in time&quot;</span>, i)&#125;&#125;<span class="hljs-comment">// æ¸…ç†ï¼šå…³é—­Broadcasterå’Œæ‰€æœ‰è®¢é˜…è€…é€šé“</span>b.Close()<span class="hljs-keyword">for</span> _, sub := <span class="hljs-keyword">range</span> subscribers &#123;_, ok := &lt;-sub<span class="hljs-keyword">if</span> ok &#123;t.Errorf(<span class="hljs-string">&quot;expected closed channel for subscriber, but it&#x27;s still open&quot;</span>)&#125;&#125;&#125;</code></pre><p><strong>åŒæ ·çš„ï¼Œå’±ä»¬çš„æ³¨é‡Šè¿™å—è¿˜æ˜¯æ¯”è¾ƒç»™åŠ›çš„ï¼Œåº”è¯¥èƒ½çœ‹æ‡‚çš„</strong>ğŸ˜œ</p>]]></content>
    
    
    
    <tags>
      
      <tag>goalngã€å‘å¸ƒè®¢é˜…ã€event</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ğŸš€ DevOpsè‡ªåŠ¨åŒ–æµ‹è¯•ä¸éƒ¨ç½²æœ€ä½³å®è·µ</title>
    <link href="/2024/12/27/DevOps%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%83%A8%E7%BD%B2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"/>
    <url>/2024/12/27/DevOps%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%83%A8%E7%BD%B2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h1>ğŸš€ DevOpsè‡ªåŠ¨åŒ–æµ‹è¯•ä¸éƒ¨ç½²æœ€ä½³å®è·µ</h1><p>åœ¨å½“ä»Šå¿«èŠ‚å¥çš„è½¯ä»¶å¼€å‘ç¯å¢ƒä¸­ï¼ŒDevOpså·²ç»ä»ä¸€ç§è¶‹åŠ¿æ¼”å˜ä¸ºå¿…è¦å®è·µã€‚é€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²ï¼Œå›¢é˜Ÿå¯ä»¥æ˜¾è‘—æé«˜äº¤ä»˜é€Ÿåº¦å’Œè´¨é‡ã€‚æœ¬æ–‡å°†åˆ†äº«æˆ‘åœ¨å¤šä¸ªé¡¹ç›®ä¸­ç§¯ç´¯çš„DevOpså®è·µç»éªŒï¼Œç‰¹åˆ«æ˜¯è‡ªåŠ¨åŒ–æµ‹è¯•ä¸éƒ¨ç½²æ–¹é¢çš„æœ€ä½³å®è·µã€‚</p><h2 id="ğŸ”„-DevOpsè‡ªåŠ¨åŒ–çš„æ ¸å¿ƒä»·å€¼"><a class="header-anchor" href="#ğŸ”„-DevOpsè‡ªåŠ¨åŒ–çš„æ ¸å¿ƒä»·å€¼"></a>ğŸ”„ DevOpsè‡ªåŠ¨åŒ–çš„æ ¸å¿ƒä»·å€¼</h2><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ˜ç¡®ä¸ºä»€ä¹ˆDevOpsè‡ªåŠ¨åŒ–å¦‚æ­¤é‡è¦ï¼š</p><ul><li><strong>é€Ÿåº¦</strong>: å‡å°‘ä»ä»£ç æäº¤åˆ°éƒ¨ç½²çš„æ—¶é—´</li><li><strong>è´¨é‡</strong>: é€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•å‡å°‘äººä¸ºé”™è¯¯</li><li><strong>ä¸€è‡´æ€§</strong>: ç¡®ä¿æ¯æ¬¡éƒ¨ç½²è¿‡ç¨‹ç›¸åŒ</li><li><strong>å¯è¿½æº¯</strong>: æ¯ä¸ªå˜æ›´éƒ½æœ‰å®Œæ•´è®°å½•</li><li><strong>åé¦ˆå¾ªç¯</strong>: å¿«é€Ÿè·å¾—é—®é¢˜åé¦ˆå¹¶ä¿®å¤</li></ul><p>å®æ–½è‰¯å¥½çš„DevOpsè‡ªåŠ¨åŒ–å¯ä»¥å°†éƒ¨ç½²æ—¶é—´ä»å°æ—¶çº§ç¼©çŸ­åˆ°åˆ†é’Ÿç”šè‡³ç§’çº§ï¼ŒåŒæ—¶å¤§å¹…é™ä½ç”Ÿäº§ç¯å¢ƒé—®é¢˜çš„é£é™©ã€‚</p><h2 id="ğŸ§ª-è‡ªåŠ¨åŒ–æµ‹è¯•æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸ§ª-è‡ªåŠ¨åŒ–æµ‹è¯•æœ€ä½³å®è·µ"></a>ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•æœ€ä½³å®è·µ</h2><h3 id="æµ‹è¯•é‡‘å­—å¡”ç­–ç•¥"><a class="header-anchor" href="#æµ‹è¯•é‡‘å­—å¡”ç­–ç•¥"></a>æµ‹è¯•é‡‘å­—å¡”ç­–ç•¥</h3><p>æµ‹è¯•é‡‘å­—å¡”æ˜¯ä¸€ç§æµ‹è¯•ç­–ç•¥æ¨¡å‹ï¼Œå¸®åŠ©æˆ‘ä»¬å¹³è¡¡ä¸åŒç±»å‹çš„æµ‹è¯•ï¼š</p><pre><code class="hljs livescript">    /<span class="hljs-string">\</span>   /  <span class="hljs-string">\</span>  /    <span class="hljs-string">\</span> / E2E  <span class="hljs-string">\</span>/--------<span class="hljs-string">\</span>/ é›†æˆæµ‹è¯• <span class="hljs-string">\</span>/------------<span class="hljs-string">\</span>/    å•å…ƒæµ‹è¯•   <span class="hljs-string">\</span></code></pre><table><thead><tr><th>æµ‹è¯•ç±»å‹</th><th>æ•°é‡</th><th>æ‰§è¡Œé€Ÿåº¦</th><th>ç»´æŠ¤æˆæœ¬</th><th>ä»·å€¼</th></tr></thead><tbody><tr><td>å•å…ƒæµ‹è¯•</td><td>å¤š</td><td>å¿«</td><td>ä½</td><td>éªŒè¯åŸºæœ¬åŠŸèƒ½</td></tr><tr><td>é›†æˆæµ‹è¯•</td><td>ä¸­</td><td>ä¸­</td><td>ä¸­</td><td>éªŒè¯ç»„ä»¶äº¤äº’</td></tr><tr><td>E2Eæµ‹è¯•</td><td>å°‘</td><td>æ…¢</td><td>é«˜</td><td>éªŒè¯ç”¨æˆ·æµç¨‹</td></tr></tbody></table><h3 id="1-å•å…ƒæµ‹è¯•å®è·µ"><a class="header-anchor" href="#1-å•å…ƒæµ‹è¯•å®è·µ"></a>1. å•å…ƒæµ‹è¯•å®è·µ</h3><p>å•å…ƒæµ‹è¯•æ˜¯æµ‹è¯•é‡‘å­—å¡”çš„åŸºç¡€ï¼Œåº”å æ€»æµ‹è¯•æ•°é‡çš„70-80%ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸€ä¸ªGoé¡¹ç›®çš„å•å…ƒæµ‹è¯•ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestCalculateDiscount</span><span class="hljs-params">(t *testing.T)</span></span> &#123;    tests := []<span class="hljs-keyword">struct</span> &#123;        name     <span class="hljs-keyword">string</span>        amount   <span class="hljs-keyword">float64</span>        vip      <span class="hljs-keyword">bool</span>        expected <span class="hljs-keyword">float64</span>    &#125;&#123;        &#123;<span class="hljs-string">&quot;æ™®é€šå®¢æˆ·æ— æŠ˜æ‰£&quot;</span>, <span class="hljs-number">100.0</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100.0</span>&#125;,        &#123;<span class="hljs-string">&quot;VIPå®¢æˆ·æœ‰10%æŠ˜æ‰£&quot;</span>, <span class="hljs-number">100.0</span>, <span class="hljs-literal">true</span>, <span class="hljs-number">90.0</span>&#125;,        &#123;<span class="hljs-string">&quot;é›¶é‡‘é¢è¾¹ç•Œæ¡ä»¶&quot;</span>, <span class="hljs-number">0.0</span>, <span class="hljs-literal">true</span>, <span class="hljs-number">0.0</span>&#125;,    &#125;    <span class="hljs-keyword">for</span> _, tc := <span class="hljs-keyword">range</span> tests &#123;        t.Run(tc.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;            result := CalculateDiscount(tc.amount, tc.vip)            <span class="hljs-keyword">if</span> result != tc.expected &#123;                t.Errorf(<span class="hljs-string">&quot;æœŸæœ› %.2fï¼Œå®é™… %.2f&quot;</span>, tc.expected, result)            &#125;        &#125;)    &#125;&#125;</code></pre><p><strong>å•å…ƒæµ‹è¯•æœ€ä½³å®è·µ</strong>ï¼š</p><ul><li>æ¯ä¸ªæµ‹è¯•åªå…³æ³¨ä¸€ä¸ªåŠŸèƒ½ç‚¹</li><li>ä½¿ç”¨è¡¨é©±åŠ¨æµ‹è¯•å¤„ç†å¤šä¸ªåœºæ™¯</li><li>æµ‹è¯•è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ</li><li>æ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–ï¼ˆæ•°æ®åº“ã€APIç­‰ï¼‰</li><li>åšæŒæµ‹è¯•ä¼˜å…ˆï¼ˆTDDï¼‰æˆ–è‡³å°‘ä¿æŒæµ‹è¯•è¦†ç›–ç‡</li></ul><h3 id="2-é›†æˆæµ‹è¯•ç­–ç•¥"><a class="header-anchor" href="#2-é›†æˆæµ‹è¯•ç­–ç•¥"></a>2. é›†æˆæµ‹è¯•ç­–ç•¥</h3><p>é›†æˆæµ‹è¯•éªŒè¯å¤šä¸ªç»„ä»¶ä¹‹é—´çš„äº¤äº’ï¼Œåº”å 20-25%ï¼š</p><pre><code class="hljs javascript"><span class="hljs-comment">// ä½¿ç”¨Jestæµ‹è¯•APIé›†æˆ</span>describe(<span class="hljs-string">&#x27;ç”¨æˆ·APIé›†æˆæµ‹è¯•&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;    <span class="hljs-keyword">let</span> server;    <span class="hljs-keyword">let</span> token;        beforeAll(<span class="hljs-keyword">async</span> () =&gt; &#123;        server = <span class="hljs-keyword">await</span> startTestServer();        <span class="hljs-comment">// ç™»å½•è·å–token</span>        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> request(server)            .post(<span class="hljs-string">&#x27;/api/auth/login&#x27;</span>)            .send(&#123; <span class="hljs-attr">username</span>: <span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;test123&#x27;</span> &#125;);        token = response.body.token;    &#125;);        afterAll(<span class="hljs-keyword">async</span> () =&gt; &#123;        <span class="hljs-keyword">await</span> stopTestServer(server);    &#125;);        test(<span class="hljs-string">&#x27;åˆ›å»ºç”¨æˆ·åèƒ½æ­£ç¡®è·å–ç”¨æˆ·ä¿¡æ¯&#x27;</span>, <span class="hljs-keyword">async</span> () =&gt; &#123;        <span class="hljs-comment">// åˆ›å»ºç”¨æˆ·</span>        <span class="hljs-keyword">const</span> createResponse = <span class="hljs-keyword">await</span> request(server)            .post(<span class="hljs-string">&#x27;/api/users&#x27;</span>)            .set(<span class="hljs-string">&#x27;Authorization&#x27;</span>, <span class="hljs-string">`Bearer <span class="hljs-subst">$&#123;token&#125;</span>`</span>)            .send(&#123;                name: <span class="hljs-string">&#x27;John Doe&#x27;</span>,                email: <span class="hljs-string">&#x27;john@example.com&#x27;</span>,                role: <span class="hljs-string">&#x27;user&#x27;</span>            &#125;);                expect(createResponse.status).toBe(<span class="hljs-number">201</span>);        <span class="hljs-keyword">const</span> userId = createResponse.body.id;                <span class="hljs-comment">// è·å–ç”¨æˆ·ä¿¡æ¯</span>        <span class="hljs-keyword">const</span> getResponse = <span class="hljs-keyword">await</span> request(server)            .get(<span class="hljs-string">`/api/users/<span class="hljs-subst">$&#123;userId&#125;</span>`</span>)            .set(<span class="hljs-string">&#x27;Authorization&#x27;</span>, <span class="hljs-string">`Bearer <span class="hljs-subst">$&#123;token&#125;</span>`</span>);                expect(getResponse.status).toBe(<span class="hljs-number">200</span>);        expect(getResponse.body.name).toBe(<span class="hljs-string">&#x27;John Doe&#x27;</span>);        expect(getResponse.body.email).toBe(<span class="hljs-string">&#x27;john@example.com&#x27;</span>);    &#125;);&#125;);</code></pre><p><strong>é›†æˆæµ‹è¯•æœ€ä½³å®è·µ</strong>ï¼š</p><ul><li>ä½¿ç”¨æµ‹è¯•å®¹å™¨æ›¿ä»£æ¨¡æ‹Ÿå¤–éƒ¨ç³»ç»Ÿ</li><li>æµ‹è¯•å…³é”®ä¸šåŠ¡æµç¨‹å’Œç³»ç»Ÿè¾¹ç•Œ</li><li>é‡ç‚¹å…³æ³¨é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶</li><li>è€ƒè™‘æ•°æ®ä¸€è‡´æ€§å’Œäº‹åŠ¡ç®¡ç†</li></ul><h3 id="3-ç«¯åˆ°ç«¯-E2E-æµ‹è¯•"><a class="header-anchor" href="#3-ç«¯åˆ°ç«¯-E2E-æµ‹è¯•"></a>3. ç«¯åˆ°ç«¯(E2E)æµ‹è¯•</h3><p>E2Eæµ‹è¯•æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸ºï¼Œåº”å 5-10%ï¼š</p><pre><code class="hljs javascript"><span class="hljs-comment">// ä½¿ç”¨Playwrightçš„E2Eæµ‹è¯•ç¤ºä¾‹</span>test(<span class="hljs-string">&#x27;ç”¨æˆ·ç™»å½•å’Œä¸‹å•æµç¨‹&#x27;</span>, <span class="hljs-keyword">async</span> (&#123; page &#125;) =&gt; &#123;    <span class="hljs-comment">// è®¿é—®ç™»å½•é¡µé¢</span>    <span class="hljs-keyword">await</span> page.goto(<span class="hljs-string">&#x27;https://myapp.com/login&#x27;</span>);        <span class="hljs-comment">// å¡«å†™å¹¶æäº¤ç™»å½•è¡¨å•</span>    <span class="hljs-keyword">await</span> page.fill(<span class="hljs-string">&#x27;input[name=&quot;username&quot;]&#x27;</span>, <span class="hljs-string">&#x27;testuser&#x27;</span>);    <span class="hljs-keyword">await</span> page.fill(<span class="hljs-string">&#x27;input[name=&quot;password&quot;]&#x27;</span>, <span class="hljs-string">&#x27;password123&#x27;</span>);    <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">&#x27;button[type=&quot;submit&quot;]&#x27;</span>);        <span class="hljs-comment">// éªŒè¯ç™»å½•æˆåŠŸ</span>    <span class="hljs-keyword">await</span> expect(page.locator(<span class="hljs-string">&#x27;.welcome-message&#x27;</span>)).toContainText(<span class="hljs-string">&#x27;æ¬¢è¿&#x27;</span>);        <span class="hljs-comment">// æµè§ˆå•†å“å¹¶æ·»åŠ åˆ°è´­ç‰©è½¦</span>    <span class="hljs-keyword">await</span> page.goto(<span class="hljs-string">&#x27;https://myapp.com/products&#x27;</span>);    <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">&#x27;.product-card:first-child .add-to-cart&#x27;</span>);        <span class="hljs-comment">// æ£€æŸ¥è´­ç‰©è½¦</span>    <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">&#x27;.cart-icon&#x27;</span>);    <span class="hljs-keyword">await</span> expect(page.locator(<span class="hljs-string">&#x27;.cart-items&#x27;</span>)).toHaveCount(<span class="hljs-number">1</span>);        <span class="hljs-comment">// å®Œæˆç»“è´¦æµç¨‹</span>    <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">&#x27;.checkout-button&#x27;</span>);    <span class="hljs-keyword">await</span> page.fill(<span class="hljs-string">&#x27;input[name=&quot;address&quot;]&#x27;</span>, <span class="hljs-string">&#x27;æµ‹è¯•åœ°å€123å·&#x27;</span>);    <span class="hljs-keyword">await</span> page.selectOption(<span class="hljs-string">&#x27;select[name=&quot;payment&quot;]&#x27;</span>, <span class="hljs-string">&#x27;credit-card&#x27;</span>);    <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">&#x27;#complete-order&#x27;</span>);        <span class="hljs-comment">// éªŒè¯è®¢å•æˆåŠŸ</span>    <span class="hljs-keyword">await</span> expect(page.locator(<span class="hljs-string">&#x27;.order-confirmation&#x27;</span>)).toBeVisible();    <span class="hljs-keyword">await</span> expect(page.locator(<span class="hljs-string">&#x27;.order-number&#x27;</span>)).toHaveText(<span class="hljs-regexp">/ORD-\d+/</span>);&#125;);</code></pre><p><strong>E2Eæµ‹è¯•æœ€ä½³å®è·µ</strong>ï¼š</p><ul><li>ä¸“æ³¨äºå…³é”®ç”¨æˆ·è·¯å¾„ï¼Œä¸è¦è¿‡åº¦æµ‹è¯•</li><li>ä½¿ç”¨ç¨³å®šçš„é€‰æ‹©å™¨ï¼ˆæ•°æ®å±æ€§ä¼˜äºCSSç±»ï¼‰</li><li>å®ç°æµ‹è¯•éš”ç¦»ä»¥é¿å…å¹²æ‰°</li><li>æ•è·å±å¹•æˆªå›¾å’Œè§†é¢‘ç”¨äºè°ƒè¯•</li><li>å¹¶è¡Œè¿è¡Œä»¥æé«˜é€Ÿåº¦</li></ul><h3 id="æµ‹è¯•æ•°æ®ç®¡ç†"><a class="header-anchor" href="#æµ‹è¯•æ•°æ®ç®¡ç†"></a>æµ‹è¯•æ•°æ®ç®¡ç†</h3><p>è‡ªåŠ¨åŒ–æµ‹è¯•çš„ä¸€ä¸ªå¸¸è§æŒ‘æˆ˜æ˜¯æµ‹è¯•æ•°æ®ç®¡ç†ï¼š</p><pre><code class="hljs yaml"><span class="hljs-comment"># docker-compose-test.ymlç”¨äºæµ‹è¯•ç¯å¢ƒ</span><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><span class="hljs-attr">services:</span>  <span class="hljs-attr">test-db:</span>    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:14</span>    <span class="hljs-attr">environment:</span>      <span class="hljs-attr">POSTGRES_DB:</span> <span class="hljs-string">testdb</span>      <span class="hljs-attr">POSTGRES_USER:</span> <span class="hljs-string">test</span>      <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">testpass</span>    <span class="hljs-attr">volumes:</span>      <span class="hljs-bullet">-</span> <span class="hljs-string">./testdata/init.sql:/docker-entrypoint-initdb.d/init.sql</span>    <span class="hljs-attr">ports:</span>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;5433:5432&quot;</span>    <span class="hljs-attr">test-redis:</span>    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:6</span>    <span class="hljs-attr">ports:</span>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;6380:6379&quot;</span></code></pre><p><strong>æµ‹è¯•æ•°æ®æœ€ä½³å®è·µ</strong>ï¼š</p><ol><li><strong>ä½¿ç”¨å›ºå®šç§å­æ•°æ®</strong>ï¼šç¡®ä¿æµ‹è¯•å¯é‡å¤æ€§</li><li><strong>æ•°æ®éš”ç¦»</strong>ï¼šæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ä½¿ç”¨ç‹¬ç«‹æ•°æ®</li><li><strong>æµ‹è¯•åæ¸…ç†</strong>ï¼šæ¢å¤ç¯å¢ƒåˆ°åˆå§‹çŠ¶æ€</li><li><strong>ä½¿ç”¨æµ‹è¯•å®¹å™¨</strong>ï¼šæä¾›éš”ç¦»ä¸”ä¸€è‡´çš„ç¯å¢ƒ</li></ol><h2 id="âš™ï¸-CI-CDç®¡é“æ„å»º"><a class="header-anchor" href="#âš™ï¸-CI-CDç®¡é“æ„å»º"></a>âš™ï¸ CI/CDç®¡é“æ„å»º</h2><h3 id="ä¸»æµCI-CDå·¥å…·å¯¹æ¯”"><a class="header-anchor" href="#ä¸»æµCI-CDå·¥å…·å¯¹æ¯”"></a>ä¸»æµCI/CDå·¥å…·å¯¹æ¯”</h3><p>é€‰æ‹©åˆé€‚çš„CI/CDå·¥å…·å¯¹äºé¡¹ç›®æˆåŠŸè‡³å…³é‡è¦ï¼š</p><table><thead><tr><th>å·¥å…·</th><th>ä¼˜åŠ¿</th><th>åŠ£åŠ¿</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>GitHub Actions</td><td>ä¸GitHubç´§å¯†é›†æˆï¼Œé…ç½®ç®€å•</td><td>å…è´¹é¢åº¦æœ‰é™</td><td>å¼€æºé¡¹ç›®ï¼Œå°å‹å›¢é˜Ÿ</td></tr><tr><td>GitLab CI/CD</td><td>ä¸GitLabé›†æˆï¼Œè‡ªæ‰˜ç®¡é€‰é¡¹</td><td>UIä¸å¤Ÿç›´è§‚</td><td>å…¨GitLabç¯å¢ƒçš„å›¢é˜Ÿ</td></tr><tr><td>Jenkins</td><td>é«˜åº¦å¯å®šåˆ¶ï¼Œä¸°å¯Œæ’ä»¶</td><td>é…ç½®å¤æ‚ï¼Œç»´æŠ¤æˆæœ¬é«˜</td><td>ä¼ä¸šçº§éœ€æ±‚ï¼Œç‰¹æ®Šé›†æˆéœ€æ±‚</td></tr><tr><td>CircleCI</td><td>æ˜“äºä½¿ç”¨ï¼Œè‰¯å¥½æ‰©å±•æ€§</td><td>é«˜çº§åŠŸèƒ½ä»˜è´¹</td><td>ä¸­å‹å›¢é˜Ÿï¼Œéœ€è¦å¿«é€Ÿå¯åŠ¨</td></tr></tbody></table><h3 id="ç¤ºä¾‹ï¼šGitHub-Actionså·¥ä½œæµ"><a class="header-anchor" href="#ç¤ºä¾‹ï¼šGitHub-Actionså·¥ä½œæµ"></a>ç¤ºä¾‹ï¼šGitHub Actionså·¥ä½œæµ</h3><p>è¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹Goé¡¹ç›®çš„å®Œæ•´CI/CDå·¥ä½œæµï¼š</p><pre><code class="hljs yaml"><span class="hljs-comment"># .github/workflows/ci-cd.yml</span><span class="hljs-attr">name:</span> <span class="hljs-string">CI/CD</span> <span class="hljs-string">Pipeline</span><span class="hljs-attr">on:</span>  <span class="hljs-attr">push:</span>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]  <span class="hljs-attr">pull_request:</span>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]<span class="hljs-attr">jobs:</span>  <span class="hljs-attr">test:</span>    <span class="hljs-attr">name:</span> <span class="hljs-string">Test</span>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>    <span class="hljs-attr">services:</span>      <span class="hljs-attr">postgres:</span>        <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:14</span>        <span class="hljs-attr">env:</span>          <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">postgres</span>          <span class="hljs-attr">POSTGRES_USER:</span> <span class="hljs-string">postgres</span>          <span class="hljs-attr">POSTGRES_DB:</span> <span class="hljs-string">testdb</span>        <span class="hljs-attr">ports:</span>          <span class="hljs-bullet">-</span> <span class="hljs-number">5432</span><span class="hljs-string">:5432</span>        <span class="hljs-attr">options:</span> <span class="hljs-string">&gt;-</span>          <span class="hljs-string">--health-cmd</span> <span class="hljs-string">pg_isready</span>          <span class="hljs-string">--health-interval</span> <span class="hljs-string">10s</span>          <span class="hljs-string">--health-timeout</span> <span class="hljs-string">5s</span>          <span class="hljs-string">--health-retries</span> <span class="hljs-number">5</span>        <span class="hljs-attr">steps:</span>    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Go</span>      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-go@v4</span>      <span class="hljs-attr">with:</span>        <span class="hljs-attr">go-version:</span> <span class="hljs-string">&#x27;1.21&#x27;</span>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span>      <span class="hljs-attr">run:</span> <span class="hljs-string">go</span> <span class="hljs-string">mod</span> <span class="hljs-string">download</span>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">linters</span>      <span class="hljs-attr">uses:</span> <span class="hljs-string">golangci/golangci-lint-action@v3</span>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">unit</span> <span class="hljs-string">tests</span>      <span class="hljs-attr">run:</span> <span class="hljs-string">go</span> <span class="hljs-string">test</span> <span class="hljs-string">-v</span> <span class="hljs-string">./...</span> <span class="hljs-string">-coverprofile=coverage.out</span>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">coverage</span> <span class="hljs-string">report</span>      <span class="hljs-attr">uses:</span> <span class="hljs-string">codecov/codecov-action@v3</span>      <span class="hljs-attr">with:</span>        <span class="hljs-attr">file:</span> <span class="hljs-string">./coverage.out</span>    <span class="hljs-attr">build:</span>    <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span>    <span class="hljs-attr">needs:</span> <span class="hljs-string">test</span>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>    <span class="hljs-attr">steps:</span>    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Go</span>      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-go@v4</span>      <span class="hljs-attr">with:</span>        <span class="hljs-attr">go-version:</span> <span class="hljs-string">&#x27;1.21&#x27;</span>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">application</span>      <span class="hljs-attr">run:</span> <span class="hljs-string">go</span> <span class="hljs-string">build</span> <span class="hljs-string">-v</span> <span class="hljs-string">-o</span> <span class="hljs-string">app</span> <span class="hljs-string">./cmd/server</span>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">Trivy</span> <span class="hljs-string">vulnerability</span> <span class="hljs-string">scanner</span>      <span class="hljs-attr">uses:</span> <span class="hljs-string">aquasecurity/trivy-action@master</span>      <span class="hljs-attr">with:</span>        <span class="hljs-attr">scan-type:</span> <span class="hljs-string">&#x27;fs&#x27;</span>        <span class="hljs-attr">format:</span> <span class="hljs-string">&#x27;table&#x27;</span>        <span class="hljs-attr">exit-code:</span> <span class="hljs-string">&#x27;1&#x27;</span>        <span class="hljs-attr">ignore-unfixed:</span> <span class="hljs-literal">true</span>        <span class="hljs-attr">severity:</span> <span class="hljs-string">&#x27;CRITICAL,HIGH&#x27;</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">and</span> <span class="hljs-string">push</span> <span class="hljs-string">Docker</span> <span class="hljs-string">image</span>      <span class="hljs-attr">if:</span> <span class="hljs-string">github.event_name</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;push&#x27;</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;refs/heads/main&#x27;</span>      <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/build-push-action@v4</span>      <span class="hljs-attr">with:</span>        <span class="hljs-attr">context:</span> <span class="hljs-string">.</span>        <span class="hljs-attr">push:</span> <span class="hljs-literal">true</span>        <span class="hljs-attr">tags:</span> <span class="hljs-string">myregistry.com/myapp:latest,myregistry.com/myapp:$&#123;&#123;</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">&#125;&#125;</span>          <span class="hljs-attr">deploy:</span>    <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span>    <span class="hljs-attr">needs:</span> <span class="hljs-string">build</span>    <span class="hljs-attr">if:</span> <span class="hljs-string">github.event_name</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;push&#x27;</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;refs/heads/main&#x27;</span>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>    <span class="hljs-attr">steps:</span>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Kubernetes</span>      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions-hub/kubectl@master</span>      <span class="hljs-attr">env:</span>        <span class="hljs-attr">KUBE_CONFIG:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.KUBE_CONFIG</span> <span class="hljs-string">&#125;&#125;</span>      <span class="hljs-attr">with:</span>        <span class="hljs-attr">args:</span> <span class="hljs-string">set</span> <span class="hljs-string">image</span> <span class="hljs-string">deployment/myapp</span> <span class="hljs-string">myapp=myregistry.com/myapp:$&#123;&#123;</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">--record</span>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Verify</span> <span class="hljs-string">deployment</span>      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions-hub/kubectl@master</span>      <span class="hljs-attr">env:</span>        <span class="hljs-attr">KUBE_CONFIG:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.KUBE_CONFIG</span> <span class="hljs-string">&#125;&#125;</span>      <span class="hljs-attr">with:</span>        <span class="hljs-attr">args:</span> <span class="hljs-string">rollout</span> <span class="hljs-string">status</span> <span class="hljs-string">deployment/myapp</span></code></pre><h3 id="CI-CDç®¡é“æœ€ä½³å®è·µ"><a class="header-anchor" href="#CI-CDç®¡é“æœ€ä½³å®è·µ"></a>CI/CDç®¡é“æœ€ä½³å®è·µ</h3><ol><li><strong>å¿«é€Ÿåé¦ˆ</strong>ï¼šä¼˜åŒ–ç®¡é“æ‰§è¡Œæ—¶é—´</li><li><strong>å¹¶è¡ŒåŒ–</strong>ï¼šåŒæ—¶è¿è¡Œç‹¬ç«‹ä»»åŠ¡</li><li><strong>ç¼“å­˜ä¾èµ–</strong>ï¼šé¿å…é‡å¤ä¸‹è½½</li><li><strong>å¤±è´¥å¿«é€Ÿ</strong>ï¼šå…ˆè¿è¡Œå¿«é€Ÿå¤±è´¥çš„æµ‹è¯•</li><li><strong>ç¯å¢ƒä¸€è‡´æ€§</strong>ï¼šä½¿ç”¨å®¹å™¨ç¡®ä¿ç¯å¢ƒä¸€è‡´</li><li><strong>å®‰å…¨æ‰«æ</strong>ï¼šé›†æˆæ¼æ´å’Œä»£ç è´¨é‡æ£€æŸ¥</li></ol><pre><code class="hljs yaml"><span class="hljs-comment"># ç¼“å­˜ä¾èµ–ç¤ºä¾‹</span><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Cache</span> <span class="hljs-string">Go</span> <span class="hljs-string">modules</span>  <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/cache@v3</span>  <span class="hljs-attr">with:</span>    <span class="hljs-attr">path:</span> <span class="hljs-string">~/go/pkg/mod</span>    <span class="hljs-attr">key:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">runner.os</span> <span class="hljs-string">&#125;&#125;-go-$&#123;&#123;</span> <span class="hljs-string">hashFiles(&#x27;**/go.sum&#x27;)</span> <span class="hljs-string">&#125;&#125;</span>    <span class="hljs-attr">restore-keys:</span> <span class="hljs-string">|</span>      <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">runner.os</span> <span class="hljs-string">&#125;&#125;-go-</span></code></pre><h2 id="ğŸš¢-è‡ªåŠ¨åŒ–éƒ¨ç½²ç­–ç•¥"><a class="header-anchor" href="#ğŸš¢-è‡ªåŠ¨åŒ–éƒ¨ç½²ç­–ç•¥"></a>ğŸš¢ è‡ªåŠ¨åŒ–éƒ¨ç½²ç­–ç•¥</h2><h3 id="1-éƒ¨ç½²ç­–ç•¥æ¯”è¾ƒ"><a class="header-anchor" href="#1-éƒ¨ç½²ç­–ç•¥æ¯”è¾ƒ"></a>1. éƒ¨ç½²ç­–ç•¥æ¯”è¾ƒ</h3><table><thead><tr><th>ç­–ç•¥</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>è“ç»¿éƒ¨ç½²</td><td>é›¶åœæœºï¼Œå›æ»šç®€å•</td><td>èµ„æºæ¶ˆè€—é«˜</td><td>é«˜å¯ç”¨åœºæ™¯</td></tr><tr><td>é‡‘ä¸é›€å‘å¸ƒ</td><td>æ¸è¿›å¼é£é™©æ§åˆ¶</td><td>éœ€è¦æµé‡æ§åˆ¶</td><td>å…³é”®ä¸šåŠ¡ç³»ç»Ÿ</td></tr><tr><td>æ»šåŠ¨æ›´æ–°</td><td>èµ„æºåˆ©ç”¨é«˜</td><td>éƒ¨ç½²æ—¶é—´é•¿</td><td>ä¸€èˆ¬åº”ç”¨</td></tr><tr><td>A/Bæµ‹è¯•éƒ¨ç½²</td><td>æ”¯æŒåŠŸèƒ½éªŒè¯</td><td>å¤æ‚åº¦é«˜</td><td>éœ€è¦ç”¨æˆ·åé¦ˆéªŒè¯çš„åŠŸèƒ½</td></tr></tbody></table><h3 id="2-Kuberneteséƒ¨ç½²ç¤ºä¾‹"><a class="header-anchor" href="#2-Kuberneteséƒ¨ç½²ç¤ºä¾‹"></a>2. Kuberneteséƒ¨ç½²ç¤ºä¾‹</h3><p>Kuberneteså·²æˆä¸ºå®¹å™¨ç¼–æ’çš„æ ‡å‡†ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªæ»šåŠ¨æ›´æ–°éƒ¨ç½²çš„ä¾‹å­ï¼š</p><pre><code class="hljs yaml"><span class="hljs-comment"># deployment.yaml</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>  <span class="hljs-attr">strategy:</span>    <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span>    <span class="hljs-attr">rollingUpdate:</span>      <span class="hljs-attr">maxUnavailable:</span> <span class="hljs-number">1</span>      <span class="hljs-attr">maxSurge:</span> <span class="hljs-number">1</span>  <span class="hljs-attr">selector:</span>    <span class="hljs-attr">matchLabels:</span>      <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span>  <span class="hljs-attr">template:</span>    <span class="hljs-attr">metadata:</span>      <span class="hljs-attr">labels:</span>        <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span>    <span class="hljs-attr">spec:</span>      <span class="hljs-attr">containers:</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>        <span class="hljs-attr">image:</span> <span class="hljs-string">myregistry.com/myapp:latest</span>        <span class="hljs-attr">ports:</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>        <span class="hljs-attr">readinessProbe:</span>          <span class="hljs-attr">httpGet:</span>            <span class="hljs-attr">path:</span> <span class="hljs-string">/health</span>            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span>          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>        <span class="hljs-attr">resources:</span>          <span class="hljs-attr">limits:</span>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;500m&quot;</span>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;512Mi&quot;</span>          <span class="hljs-attr">requests:</span>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;200m&quot;</span>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;256Mi&quot;</span></code></pre><h3 id="3-å®ç°é‡‘ä¸é›€å‘å¸ƒ"><a class="header-anchor" href="#3-å®ç°é‡‘ä¸é›€å‘å¸ƒ"></a>3. å®ç°é‡‘ä¸é›€å‘å¸ƒ</h3><p>é‡‘ä¸é›€å‘å¸ƒæ˜¯ä¸€ç§é£é™©è¾ƒä½çš„éƒ¨ç½²ç­–ç•¥ï¼š</p><pre><code class="hljs yaml"><span class="hljs-comment"># ç¬¬ä¸€æ­¥ï¼šéƒ¨ç½²å°‘é‡é‡‘ä¸é›€å®ä¾‹</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp-canary</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>  <span class="hljs-comment"># åªéƒ¨ç½²1ä¸ªå®ä¾‹</span>  <span class="hljs-attr">template:</span>    <span class="hljs-attr">metadata:</span>      <span class="hljs-attr">labels:</span>        <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span>        <span class="hljs-attr">version:</span> <span class="hljs-string">v2</span>  <span class="hljs-comment"># æ–°ç‰ˆæœ¬æ ‡ç­¾</span>    <span class="hljs-comment"># å…¶ä»–é…ç½®...</span><span class="hljs-comment"># ç¬¬äºŒæ­¥ï¼šé…ç½®æœåŠ¡å°†éƒ¨åˆ†æµé‡è·¯ç”±åˆ°é‡‘ä¸é›€</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">selector:</span>    <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span>  <span class="hljs-comment"># åŒæ—¶åŒ¹é…ç¨³å®šç‰ˆå’Œé‡‘ä¸é›€ç‰ˆæœ¬</span>  <span class="hljs-attr">ports:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span></code></pre><h3 id="4-åŸºç¡€è®¾æ–½å³ä»£ç -IaC"><a class="header-anchor" href="#4-åŸºç¡€è®¾æ–½å³ä»£ç -IaC"></a>4. åŸºç¡€è®¾æ–½å³ä»£ç (IaC)</h3><p>ä½¿ç”¨Terraformç®¡ç†äº‘èµ„æºæ˜¯ç°ä»£DevOpsçš„å…³é”®å®è·µï¼š</p><pre><code class="hljs hcl"># main.tfprovider &quot;aws&quot; &#123;  region &#x3D; &quot;us-west-2&quot;&#125;module &quot;vpc&quot; &#123;  source &#x3D; &quot;terraform-aws-modules&#x2F;vpc&#x2F;aws&quot;    name &#x3D; &quot;my-vpc&quot;  cidr &#x3D; &quot;10.0.0.0&#x2F;16&quot;    azs             &#x3D; [&quot;us-west-2a&quot;, &quot;us-west-2b&quot;]  private_subnets &#x3D; [&quot;10.0.1.0&#x2F;24&quot;, &quot;10.0.2.0&#x2F;24&quot;]  public_subnets  &#x3D; [&quot;10.0.101.0&#x2F;24&quot;, &quot;10.0.102.0&#x2F;24&quot;]    enable_nat_gateway &#x3D; true&#125;module &quot;eks&quot; &#123;  source  &#x3D; &quot;terraform-aws-modules&#x2F;eks&#x2F;aws&quot;    cluster_name    &#x3D; &quot;my-cluster&quot;  cluster_version &#x3D; &quot;1.27&quot;    vpc_id     &#x3D; module.vpc.vpc_id  subnet_ids &#x3D; module.vpc.private_subnets    eks_managed_node_groups &#x3D; &#123;    default &#x3D; &#123;      min_size     &#x3D; 2      max_size     &#x3D; 5      desired_size &#x3D; 2            instance_types &#x3D; [&quot;t3.medium&quot;]    &#125;  &#125;&#125;# è¾“å‡ºKubernetesé…ç½®output &quot;kubeconfig&quot; &#123;  value     &#x3D; module.eks.kubeconfig  sensitive &#x3D; true&#125;</code></pre><h2 id="ğŸ”-ç›‘æ§ä¸å¯è§‚æµ‹æ€§"><a class="header-anchor" href="#ğŸ”-ç›‘æ§ä¸å¯è§‚æµ‹æ€§"></a>ğŸ” ç›‘æ§ä¸å¯è§‚æµ‹æ€§</h2><p>éƒ¨ç½²åç›‘æ§æ˜¯DevOpsé—­ç¯çš„é‡è¦ç¯èŠ‚ï¼š</p><h3 id="1-ä¸‰å¤§æ”¯æŸ±"><a class="header-anchor" href="#1-ä¸‰å¤§æ”¯æŸ±"></a>1. ä¸‰å¤§æ”¯æŸ±</h3><ul><li><strong>æŒ‡æ ‡(Metrics)</strong>: æ•°å€¼å‹æ•°æ®ï¼Œå¦‚å“åº”æ—¶é—´ã€é”™è¯¯ç‡</li><li><strong>æ—¥å¿—(Logs)</strong>: äº‹ä»¶è®°å½•ï¼Œå¸®åŠ©è°ƒè¯•é—®é¢˜</li><li><strong>è¿½è¸ª(Traces)</strong>: è¯·æ±‚åœ¨å„æœåŠ¡é—´çš„æµåŠ¨è·¯å¾„</li></ul><h3 id="2-Prometheusç›‘æ§ç¤ºä¾‹"><a class="header-anchor" href="#2-Prometheusç›‘æ§ç¤ºä¾‹"></a>2. Prometheusç›‘æ§ç¤ºä¾‹</h3><pre><code class="hljs yaml"><span class="hljs-comment"># prometheus-config.yaml</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config</span><span class="hljs-attr">data:</span>  <span class="hljs-attr">prometheus.yml:</span> <span class="hljs-string">|</span>    <span class="hljs-attr">global:</span>      <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span>        <span class="hljs-attr">scrape_configs:</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;kubernetes-pods&#x27;</span>        <span class="hljs-attr">kubernetes_sd_configs:</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">pod</span>        <span class="hljs-attr">relabel_configs:</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]          <span class="hljs-attr">action:</span> <span class="hljs-string">keep</span>          <span class="hljs-attr">regex:</span> <span class="hljs-literal">true</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]          <span class="hljs-attr">action:</span> <span class="hljs-string">replace</span>          <span class="hljs-attr">target_label:</span> <span class="hljs-string">__metrics_path__</span>          <span class="hljs-attr">regex:</span> <span class="hljs-string">(.+)</span></code></pre><h3 id="3-ä½¿ç”¨Grafanaæ„å»ºä»ªè¡¨æ¿"><a class="header-anchor" href="#3-ä½¿ç”¨Grafanaæ„å»ºä»ªè¡¨æ¿"></a>3. ä½¿ç”¨Grafanaæ„å»ºä»ªè¡¨æ¿</h3><pre><code class="hljs yaml"><span class="hljs-comment"># grafana-dashboard.json (ç®€åŒ–)</span>&#123;  <span class="hljs-attr">&quot;title&quot;:</span> <span class="hljs-string">&quot;åº”ç”¨æ€§èƒ½ä»ªè¡¨æ¿&quot;</span>,  <span class="hljs-attr">&quot;panels&quot;:</span> [    &#123;      <span class="hljs-attr">&quot;title&quot;:</span> <span class="hljs-string">&quot;APIå“åº”æ—¶é—´&quot;</span>,      <span class="hljs-attr">&quot;type&quot;:</span> <span class="hljs-string">&quot;graph&quot;</span>,      <span class="hljs-attr">&quot;datasource&quot;:</span> <span class="hljs-string">&quot;Prometheus&quot;</span>,      <span class="hljs-attr">&quot;targets&quot;:</span> [        &#123;          <span class="hljs-attr">&quot;expr&quot;:</span> <span class="hljs-string">&quot;histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket&#123;job=\&quot;api\&quot;&#125;[5m])) by (le))&quot;</span>,          <span class="hljs-attr">&quot;legendFormat&quot;:</span> <span class="hljs-string">&quot;P95&quot;</span>        &#125;      ]    &#125;,    &#123;      <span class="hljs-attr">&quot;title&quot;:</span> <span class="hljs-string">&quot;é”™è¯¯ç‡&quot;</span>,      <span class="hljs-attr">&quot;type&quot;:</span> <span class="hljs-string">&quot;graph&quot;</span>,      <span class="hljs-attr">&quot;datasource&quot;:</span> <span class="hljs-string">&quot;Prometheus&quot;</span>,      <span class="hljs-attr">&quot;targets&quot;:</span> [        &#123;          <span class="hljs-attr">&quot;expr&quot;:</span> <span class="hljs-string">&quot;sum(rate(http_requests_total&#123;job=\&quot;api\&quot;,status=~\&quot;5..\&quot;&#125;[5m])) / sum(rate(http_requests_total&#123;job=\&quot;api\&quot;&#125;[5m]))&quot;</span>,          <span class="hljs-attr">&quot;legendFormat&quot;:</span> <span class="hljs-string">&quot;é”™è¯¯ç‡&quot;</span>        &#125;      ]    &#125;  ]&#125;</code></pre><h3 id="4-å‘Šè­¦é…ç½®"><a class="header-anchor" href="#4-å‘Šè­¦é…ç½®"></a>4. å‘Šè­¦é…ç½®</h3><pre><code class="hljs yaml"><span class="hljs-comment"># alertmanager-config.yaml</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager-config</span><span class="hljs-attr">data:</span>  <span class="hljs-attr">alertmanager.yml:</span> <span class="hljs-string">|</span>    <span class="hljs-attr">global:</span>      <span class="hljs-attr">resolve_timeout:</span> <span class="hljs-string">5m</span>      <span class="hljs-attr">slack_api_url:</span> <span class="hljs-string">&#x27;https://hooks.slack.com/services/xxx/yyy/zzz&#x27;</span>        <span class="hljs-attr">route:</span>      <span class="hljs-attr">group_by:</span> [<span class="hljs-string">&#x27;alertname&#x27;</span>, <span class="hljs-string">&#x27;job&#x27;</span>]      <span class="hljs-attr">group_wait:</span> <span class="hljs-string">30s</span>      <span class="hljs-attr">group_interval:</span> <span class="hljs-string">5m</span>      <span class="hljs-attr">repeat_interval:</span> <span class="hljs-string">4h</span>      <span class="hljs-attr">receiver:</span> <span class="hljs-string">&#x27;slack-notifications&#x27;</span>        <span class="hljs-attr">receivers:</span>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;slack-notifications&#x27;</span>      <span class="hljs-attr">slack_configs:</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">channel:</span> <span class="hljs-string">&#x27;#alerts&#x27;</span>        <span class="hljs-attr">send_resolved:</span> <span class="hljs-literal">true</span>        <span class="hljs-attr">title:</span> <span class="hljs-string">&#x27;<span class="hljs-template-variable">&#123;&#123; .GroupLabels.alertname &#125;&#125;</span>&#x27;</span>        <span class="hljs-attr">text:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; range .Alerts &#125;&#125;</span><span class="hljs-template-variable">&#123;&#123; .Annotations.description &#125;&#125;</span>\n<span class="hljs-template-variable">&#123;&#123; end &#125;&#125;</span>&quot;</span></code></pre><h2 id="ğŸ’¡-DevOpsæˆç†Ÿåº¦æ¼”è¿›"><a class="header-anchor" href="#ğŸ’¡-DevOpsæˆç†Ÿåº¦æ¼”è¿›"></a>ğŸ’¡ DevOpsæˆç†Ÿåº¦æ¼”è¿›</h2><p>DevOpså®è·µçš„å®æ–½æ˜¯ä¸€ä¸ªæ¸è¿›è¿‡ç¨‹ï¼š</p><h3 id="1-æˆç†Ÿåº¦çº§åˆ«"><a class="header-anchor" href="#1-æˆç†Ÿåº¦çº§åˆ«"></a>1. æˆç†Ÿåº¦çº§åˆ«</h3><table><thead><tr><th>çº§åˆ«</th><th>ç‰¹å¾</th><th>å®è·µé‡ç‚¹</th></tr></thead><tbody><tr><td>åˆçº§</td><td>æ‰‹åŠ¨éƒ¨ç½²ï¼Œåˆ†æ•£æµ‹è¯•</td><td>å¼•å…¥åŸºæœ¬è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œç®€åŒ–éƒ¨ç½²è„šæœ¬</td></tr><tr><td>ä¸­çº§</td><td>æœ‰CI/CDä½†ä¸å®Œå–„ï¼Œéƒ¨åˆ†è‡ªåŠ¨åŒ–</td><td>æ‰©å±•æµ‹è¯•è¦†ç›–ç‡ï¼Œå»ºç«‹å®Œæ•´CIç®¡é“</td></tr><tr><td>é«˜çº§</td><td>å…¨è‡ªåŠ¨CI/CDï¼Œç›‘æ§å®Œå–„</td><td>ä¼˜åŒ–éƒ¨ç½²ç­–ç•¥ï¼Œé›†æˆå®‰å…¨æµ‹è¯•</td></tr><tr><td>ç²¾é€š</td><td>DevOpsæ–‡åŒ–å†…åŒ–ï¼ŒæŒç»­ä¼˜åŒ–</td><td>å®æ–½é«˜çº§åº¦é‡ï¼Œå¹³å°å³æœåŠ¡</td></tr></tbody></table><h3 id="2-æ”¹è¿›è·¯å¾„"><a class="header-anchor" href="#2-æ”¹è¿›è·¯å¾„"></a>2. æ”¹è¿›è·¯å¾„</h3><p>æ¯ä¸ªå›¢é˜Ÿçš„DevOpsè¿›åŒ–è·¯å¾„å¯èƒ½ä¸åŒï¼Œä½†é€šå¸¸éµå¾ªä»¥ä¸‹æ¨¡å¼ï¼š</p><pre><code class="hljs stata">åŸºæœ¬<span class="hljs-keyword">CI</span> â†’ åŸºæœ¬<span class="hljs-keyword">CD</span> â†’ æµ‹è¯•è‡ªåŠ¨åŒ– â†’ ç›‘æ§é›†æˆ â†’ é«˜çº§éƒ¨ç½²ç­–ç•¥ â†’ å®‰å…¨é›†æˆ â†’ å®Œå…¨è‡ªåŠ¨åŒ–</code></pre><h2 id="ğŸ“ˆ-è¡¡é‡DevOpsæˆæ•ˆ"><a class="header-anchor" href="#ğŸ“ˆ-è¡¡é‡DevOpsæˆæ•ˆ"></a>ğŸ“ˆ è¡¡é‡DevOpsæˆæ•ˆ</h2><p>å»ºç«‹è¡¡é‡æ ‡å‡†æ˜¯æ”¹è¿›çš„åŸºç¡€ï¼š</p><h3 id="1-å…³é”®æŒ‡æ ‡"><a class="header-anchor" href="#1-å…³é”®æŒ‡æ ‡"></a>1. å…³é”®æŒ‡æ ‡</h3><ul><li><strong>éƒ¨ç½²é¢‘ç‡</strong>: æ¯å¤©ã€æ¯å‘¨æˆ–æ¯æœˆéƒ¨ç½²æ¬¡æ•°</li><li><strong>å˜æ›´å‰ç½®æ—¶é—´</strong>: ä»ä»£ç æäº¤åˆ°ç”Ÿäº§éƒ¨ç½²çš„æ—¶é—´</li><li><strong>å˜æ›´å¤±è´¥ç‡</strong>: å¯¼è‡´æ•…éšœçš„éƒ¨ç½²ç™¾åˆ†æ¯”</li><li><strong>æ¢å¤æ—¶é—´</strong>: ä»æ•…éšœåˆ°æ¢å¤çš„å¹³å‡æ—¶é—´</li></ul><h3 id="2-æŒç»­æ”¹è¿›"><a class="header-anchor" href="#2-æŒç»­æ”¹è¿›"></a>2. æŒç»­æ”¹è¿›</h3><pre><code class="hljs python"><span class="hljs-comment"># ç®€åŒ–çš„éƒ¨ç½²ç»Ÿè®¡è„šæœ¬</span><span class="hljs-keyword">import</span> datetime<span class="hljs-keyword">from</span> github <span class="hljs-keyword">import</span> Github<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">analyze_deployments</span>(<span class="hljs-params">repo_name, token, days=<span class="hljs-number">30</span></span>):</span>    g = Github(token)    repo = g.get_repo(repo_name)        <span class="hljs-comment"># è·å–æ‰€æœ‰å·¥ä½œæµè¿è¡Œ</span>    workflows = repo.get_workflows()    deploy_workflow = next(w <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> workflows <span class="hljs-keyword">if</span> w.name == <span class="hljs-string">&quot;Deploy&quot;</span>)        <span class="hljs-comment"># åˆ†æéƒ¨ç½²</span>    cutoff_date = datetime.datetime.now() - datetime.timedelta(days=days)    runs = deploy_workflow.get_runs()        successful_deploys = <span class="hljs-number">0</span>    failed_deploys = <span class="hljs-number">0</span>        <span class="hljs-keyword">for</span> run <span class="hljs-keyword">in</span> runs:        <span class="hljs-keyword">if</span> run.created_at &lt; cutoff_date:            <span class="hljs-keyword">continue</span>                    <span class="hljs-keyword">if</span> run.conclusion == <span class="hljs-string">&quot;success&quot;</span>:            successful_deploys += <span class="hljs-number">1</span>        <span class="hljs-keyword">elif</span> run.conclusion == <span class="hljs-string">&quot;failure&quot;</span>:            failed_deploys += <span class="hljs-number">1</span>        total_deploys = successful_deploys + failed_deploys    success_rate = (successful_deploys / total_deploys * <span class="hljs-number">100</span>) <span class="hljs-keyword">if</span> total_deploys &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>        <span class="hljs-keyword">return</span> &#123;        <span class="hljs-string">&quot;total_deploys&quot;</span>: total_deploys,        <span class="hljs-string">&quot;deploys_per_day&quot;</span>: total_deploys / days,        <span class="hljs-string">&quot;success_rate&quot;</span>: success_rate    &#125;</code></pre><h2 id="ğŸ†-æ€»ç»“ä¸æœ€ä½³å®è·µæ¸…å•"><a class="header-anchor" href="#ğŸ†-æ€»ç»“ä¸æœ€ä½³å®è·µæ¸…å•"></a>ğŸ† æ€»ç»“ä¸æœ€ä½³å®è·µæ¸…å•</h2><p>DevOpsè‡ªåŠ¨åŒ–æ˜¯ä¸€ä¸ªæŒç»­æ¼”è¿›çš„è¿‡ç¨‹ï¼Œä»¥ä¸‹æ˜¯å…³é”®æœ€ä½³å®è·µæ€»ç»“ï¼š</p><ol><li><p><strong>æµ‹è¯•è‡ªåŠ¨åŒ–</strong></p><ul><li>å®æ–½æµ‹è¯•é‡‘å­—å¡”ç­–ç•¥</li><li>è‡ªåŠ¨åŒ–æ‰€æœ‰å¯é‡å¤çš„æµ‹è¯•</li><li>ç¡®ä¿æµ‹è¯•éš”ç¦»å’Œå¯é æ€§</li><li>æŒç»­ç›‘æ§å¹¶æé«˜æµ‹è¯•è¦†ç›–ç‡</li></ul></li><li><p><strong>CI/CDç®¡é“</strong></p><ul><li>ä¿æŒç®¡é“ç®€å•å’Œå¿«é€Ÿ</li><li>å°½æ—©å‘ç°é—®é¢˜ï¼ˆâ€œå·¦ç§»â€ï¼‰</li><li>å®ç°ç®¡é“å³ä»£ç </li><li>æ‰€æœ‰ç¯å¢ƒä½¿ç”¨ç›¸åŒçš„éƒ¨ç½²æµç¨‹</li></ul></li><li><p><strong>éƒ¨ç½²ç­–ç•¥</strong></p><ul><li>é€‰æ‹©é€‚åˆä¸šåŠ¡éœ€æ±‚çš„éƒ¨ç½²ç­–ç•¥</li><li>å®ç°è‡ªåŠ¨å›æ»šæœºåˆ¶</li><li>ä½¿ç”¨åŸºç¡€è®¾æ–½å³ä»£ç (IaC)</li><li>ä¿è¯æ‰€æœ‰ç¯å¢ƒçš„ä¸€è‡´æ€§</li></ul></li><li><p><strong>ç›‘æ§ä¸åé¦ˆ</strong></p><ul><li>å®æ–½å…¨é¢çš„ç›‘æ§ç­–ç•¥</li><li>å»ºç«‹æœ‰æ•ˆçš„å‘Šè­¦æœºåˆ¶</li><li>è¿›è¡Œå®šæœŸçš„å›é¡¾å’Œæ”¹è¿›</li><li>ä½¿ç”¨æ•°æ®é©±åŠ¨å†³ç­–</li></ul></li></ol><p>DevOpsä¸ä»…ä»…æ˜¯å·¥å…·å’ŒæŠ€æœ¯ï¼Œæ›´æ˜¯ä¸€ç§æ–‡åŒ–å’Œæ€ç»´æ–¹å¼ã€‚é€šè¿‡æŒç»­æ”¹è¿›å’Œè‡ªåŠ¨åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºæ›´é«˜è´¨é‡çš„è½¯ä»¶ï¼Œæ›´å¿«åœ°äº¤ä»˜ä»·å€¼ï¼ŒåŒæ—¶æé«˜å›¢é˜Ÿåä½œå’Œå·¥ä½œæ»¡æ„åº¦ã€‚</p><p>ä½ çš„å›¢é˜Ÿç›®å‰å¤„äºDevOpsæˆç†Ÿåº¦çš„å“ªä¸ªé˜¶æ®µï¼Ÿæ¬¢è¿åœ¨è¯„è®ºä¸­åˆ†äº«ä½ çš„ç»éªŒå’Œé—®é¢˜ï¼</p>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CI/CD</tag>
      
      <tag>è‡ªåŠ¨åŒ–æµ‹è¯•</tag>
      
      <tag>éƒ¨ç½²</tag>
      
      <tag>GitHub Actions</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ğŸŒ Goè¯­è¨€ä¸WebAssemblyå®æˆ˜æŒ‡å—</title>
    <link href="/2024/12/05/Go%E8%AF%AD%E8%A8%80%E4%B8%8EWebAssembly%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/"/>
    <url>/2024/12/05/Go%E8%AF%AD%E8%A8%80%E4%B8%8EWebAssembly%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/</url>
    
    <content type="html"><![CDATA[<h1>ğŸŒ Goè¯­è¨€ä¸WebAssemblyå®æˆ˜æŒ‡å—</h1><p>WebAssembly(ç®€ç§°Wasm)ä½œä¸ºä¸€ç§æ–°å…´çš„webæŠ€æœ¯ï¼Œè®©æˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œæ¥è¿‘åŸç”Ÿæ€§èƒ½çš„ä»£ç ã€‚è€ŒGoè¯­è¨€ä»1.11ç‰ˆæœ¬å¼€å§‹å·²ç»æ”¯æŒç¼–è¯‘åˆ°WebAssemblyï¼Œè¿™ä¸ºGoå¼€å‘è€…æ‰“å¼€äº†ä¸€æ‰‡é€šå‘å‰ç«¯ä¸–ç•Œçš„å¤§é—¨ã€‚æœ¬æ–‡å°†åˆ†äº«æˆ‘åœ¨ä½¿ç”¨Go+WebAssemblyå¼€å‘è¿‡ç¨‹ä¸­çš„å®æˆ˜ç»éªŒã€‚</p><h2 id="ğŸ“š-WebAssemblyç®€ä»‹"><a class="header-anchor" href="#ğŸ“š-WebAssemblyç®€ä»‹"></a>ğŸ“š WebAssemblyç®€ä»‹</h2><p>WebAssemblyæ˜¯ä¸€ç§ä½çº§å­—èŠ‚ç æ ¼å¼ï¼Œè®¾è®¡ç›®æ ‡æ˜¯æˆä¸ºé«˜æ€§èƒ½webåº”ç”¨çš„ä¾¿æºå¼ç¼–è¯‘ç›®æ ‡ã€‚å®ƒä¸»è¦ç‰¹ç‚¹æœ‰ï¼š</p><ul><li>âš¡ <strong>æ¥è¿‘åŸç”Ÿçš„æ‰§è¡Œé€Ÿåº¦</strong>ï¼šæ¯”JavaScriptå¿«å¾—å¤š</li><li>ğŸ”’ <strong>å®‰å…¨çš„æ²™ç›’æ‰§è¡Œç¯å¢ƒ</strong>ï¼šå†…å­˜å®‰å…¨ï¼Œä¸èƒ½ç›´æ¥è®¿é—®å®¿ä¸»ç¯å¢ƒ</li><li>ğŸŒ‰ <strong>ä¸JavaScriptçš„äº’æ“ä½œæ€§</strong>ï¼šå¯ä»¥ä¸JSä»£ç äº¤äº’</li><li>ğŸ”„ <strong>ä¸Web APIçš„äº’æ“ä½œ</strong>ï¼šå¯ä»¥è°ƒç”¨DOMç­‰Web API</li></ul><p>ä¸JavaScriptç›¸æ¯”ï¼ŒWebAssemblyçš„ä¼˜åŠ¿åœ¨å“ªé‡Œï¼Ÿ</p><table><thead><tr><th>ç‰¹ç‚¹</th><th>JavaScript</th><th>WebAssembly</th></tr></thead><tbody><tr><td>æ‰§è¡Œé€Ÿåº¦</td><td>è¾ƒæ…¢</td><td>æ¥è¿‘åŸç”Ÿ</td></tr><tr><td>åŠ è½½æ—¶é—´</td><td>éœ€è¦è§£æ</td><td>äºŒè¿›åˆ¶æ ¼å¼ï¼ŒåŠ è½½å¿«</td></tr><tr><td>å¼€å‘è¯­è¨€</td><td>JavaScript/TypeScript</td><td>C/C++/Rust/Goç­‰</td></tr><tr><td>å†…å­˜æ§åˆ¶</td><td>è‡ªåŠ¨åƒåœ¾å›æ”¶</td><td>æ›´ç²¾ç»†çš„å†…å­˜ç®¡ç†</td></tr><tr><td>å­¦ä¹ æ›²çº¿</td><td>ç›¸å¯¹ç®€å•</td><td>å–å†³äºæºè¯­è¨€</td></tr></tbody></table><h2 id="ğŸ› ï¸-ç¯å¢ƒæ­å»º"><a class="header-anchor" href="#ğŸ› ï¸-ç¯å¢ƒæ­å»º"></a>ğŸ› ï¸ ç¯å¢ƒæ­å»º</h2><p>è¦å¼€å§‹ä½¿ç”¨Go+WebAssemblyï¼Œé¦–å…ˆéœ€è¦ç¡®ä¿ä½ çš„ç¯å¢ƒå·²ç»å‡†å¤‡å¥½ï¼š</p><h3 id="1-Goç¯å¢ƒå‡†å¤‡"><a class="header-anchor" href="#1-Goç¯å¢ƒå‡†å¤‡"></a>1. Goç¯å¢ƒå‡†å¤‡</h3><p>ç¡®ä¿ä½ å·²å®‰è£…Go 1.11æˆ–æ›´é«˜ç‰ˆæœ¬ï¼š</p><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥Goç‰ˆæœ¬</span>go version<span class="hljs-comment"># åº”å½“çœ‹åˆ°ç±»ä¼¼è¾“å‡º</span>go version go1.21.0 windows/amd64</code></pre><h3 id="2-è®¾ç½®GOOSå’ŒGOARCH"><a class="header-anchor" href="#2-è®¾ç½®GOOSå’ŒGOARCH"></a>2. è®¾ç½®GOOSå’ŒGOARCH</h3><p>ç¼–è¯‘WebAssemblyéœ€è¦è®¾ç½®ç‰¹å®šçš„ç¯å¢ƒå˜é‡ï¼š</p><pre><code class="hljs bash"><span class="hljs-comment"># Linux/macOS</span><span class="hljs-built_in">export</span> GOOS=js<span class="hljs-built_in">export</span> GOARCH=wasm<span class="hljs-comment"># Windows (PowerShell)</span><span class="hljs-variable">$env</span>:GOOS = <span class="hljs-string">&quot;js&quot;</span><span class="hljs-variable">$env</span>:GOARCH = <span class="hljs-string">&quot;wasm&quot;</span></code></pre><h3 id="3-å¤åˆ¶WebAssemblyæ”¯æŒæ–‡ä»¶"><a class="header-anchor" href="#3-å¤åˆ¶WebAssemblyæ”¯æŒæ–‡ä»¶"></a>3. å¤åˆ¶WebAssemblyæ”¯æŒæ–‡ä»¶</h3><p>Goæä¾›äº†ä¸€ä¸ªJavaScriptæ–‡ä»¶ï¼Œå¸®åŠ©åŠ è½½å’Œè¿è¡ŒWebAssemblyæ¨¡å—ï¼š</p><pre><code class="hljs bash"><span class="hljs-comment"># å¤åˆ¶wasm_exec.jsåˆ°ä½ çš„é¡¹ç›®ç›®å½•</span>cp <span class="hljs-string">&quot;<span class="hljs-subst">$(go env GOROOT)</span>/misc/wasm/wasm_exec.js&quot;</span> ./</code></pre><h2 id="ğŸš€-ä½ å¥½ï¼ŒWebAssemblyï¼"><a class="header-anchor" href="#ğŸš€-ä½ å¥½ï¼ŒWebAssemblyï¼"></a>ğŸš€ ä½ å¥½ï¼ŒWebAssemblyï¼</h2><p>è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­å¼€å§‹ï¼Œåˆ›å»ºä¸€ä¸ªHello Worldåº”ç”¨ï¼š</p><h3 id="1-åˆ›å»ºGoæ–‡ä»¶"><a class="header-anchor" href="#1-åˆ›å»ºGoæ–‡ä»¶"></a>1. åˆ›å»ºGoæ–‡ä»¶</h3><p>åˆ›å»ºmain.goæ–‡ä»¶ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;syscall/js&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªJavaScriptå‡½æ•°</span>    hello := js.FuncOf(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(this js.Value, args []js.Value)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;        name := <span class="hljs-string">&quot;World&quot;</span>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &#123;            name = args[<span class="hljs-number">0</span>].String()        &#125;        msg := <span class="hljs-string">&quot;Hello, &quot;</span> + name + <span class="hljs-string">&quot;!&quot;</span>                <span class="hljs-comment">// è°ƒç”¨JavaScriptçš„console.logå‡½æ•°</span>        js.Global().Get(<span class="hljs-string">&quot;console&quot;</span>).Call(<span class="hljs-string">&quot;log&quot;</span>, msg)                <span class="hljs-comment">// è¿”å›æ¶ˆæ¯</span>        <span class="hljs-keyword">return</span> msg    &#125;)    <span class="hljs-comment">// å°†å‡½æ•°å¯¼å‡ºåˆ°JavaScriptå…¨å±€ç©ºé—´</span>    js.Global().Set(<span class="hljs-string">&quot;goHello&quot;</span>, hello)    <span class="hljs-comment">// ä¿æŒç¨‹åºè¿è¡Œ</span>    <span class="hljs-keyword">select</span> &#123;&#125;&#125;</code></pre><h3 id="2-ç¼–è¯‘ä¸ºWebAssembly"><a class="header-anchor" href="#2-ç¼–è¯‘ä¸ºWebAssembly"></a>2. ç¼–è¯‘ä¸ºWebAssembly</h3><pre><code class="hljs bash">GOOS=js GOARCH=wasm go build -o main.wasm</code></pre><h3 id="3-åˆ›å»ºHTMLæ–‡ä»¶"><a class="header-anchor" href="#3-åˆ›å»ºHTMLæ–‡ä»¶"></a>3. åˆ›å»ºHTMLæ–‡ä»¶</h3><p>åˆ›å»ºindex.htmlæ–‡ä»¶ï¼š</p><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Go WebAssembly<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;wasm_exec.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">        <span class="hljs-keyword">const</span> go = <span class="hljs-keyword">new</span> Go();</span><span class="javascript">        WebAssembly.instantiateStreaming(fetch(<span class="hljs-string">&quot;main.wasm&quot;</span>), go.importObject)</span><span class="javascript">            .then(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> &#123;</span>                go.run(result.instance);                <span class="javascript">                <span class="hljs-comment">// ç°åœ¨å¯ä»¥è°ƒç”¨æˆ‘ä»¬åœ¨Goä¸­å®šä¹‰çš„å‡½æ•°</span></span><span class="javascript">                <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;btn&quot;</span>).addEventListener(<span class="hljs-string">&quot;click&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;</span><span class="javascript">                    <span class="hljs-keyword">const</span> name = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;name&quot;</span>).value || <span class="hljs-string">&quot;World&quot;</span>;</span><span class="javascript">                    <span class="hljs-keyword">const</span> result = goHello(name);</span><span class="javascript">                    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;output&quot;</span>).textContent = result;</span>                &#125;);            &#125;);    <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Go WebAssembly ç¤ºä¾‹<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;è¾“å…¥ä½ çš„åå­—&quot;</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;btn&quot;</span>&gt;</span>é—®å€™<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;output&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><h3 id="4-å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨"><a class="header-anchor" href="#4-å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨"></a>4. å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨</h3><p>ç”±äºæµè§ˆå™¨çš„å®‰å…¨é™åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨HTTPæœåŠ¡å™¨æ¥æä¾›æ–‡ä»¶ï¼š</p><pre><code class="hljs bash"><span class="hljs-comment"># ä½¿ç”¨Goè‡ªå¸¦çš„HTTPæœåŠ¡å™¨</span>go run -v server.go</code></pre><p>server.go å†…å®¹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;flag&quot;</span>    <span class="hljs-string">&quot;log&quot;</span>    <span class="hljs-string">&quot;net/http&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    port := flag.String(<span class="hljs-string">&quot;p&quot;</span>, <span class="hljs-string">&quot;8080&quot;</span>, <span class="hljs-string">&quot;ç«¯å£å·&quot;</span>)    directory := flag.String(<span class="hljs-string">&quot;d&quot;</span>, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;è¦æä¾›çš„ç›®å½•&quot;</span>)    flag.Parse()    http.Handle(<span class="hljs-string">&quot;/&quot;</span>, http.FileServer(http.Dir(*directory)))    log.Printf(<span class="hljs-string">&quot;æœåŠ¡å™¨å¯åŠ¨åœ¨ http://localhost:%s&quot;</span>, *port)    log.Fatal(http.ListenAndServe(<span class="hljs-string">&quot;:&quot;</span>+*port, <span class="hljs-literal">nil</span>))&#125;</code></pre><h2 id="ğŸ’¡-Goä¸JavaScriptäº¤äº’"><a class="header-anchor" href="#ğŸ’¡-Goä¸JavaScriptäº¤äº’"></a>ğŸ’¡ Goä¸JavaScriptäº¤äº’</h2><p>Goå’ŒJavaScriptä¹‹é—´çš„äº¤äº’æ˜¯ä½¿ç”¨WebAssemblyçš„æ ¸å¿ƒï¼Œä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†äº†è§£å®ƒä»¬å¦‚ä½•é€šä¿¡ï¼š</p><h3 id="1-ä»Goè°ƒç”¨JavaScriptå‡½æ•°"><a class="header-anchor" href="#1-ä»Goè°ƒç”¨JavaScriptå‡½æ•°"></a>1. ä»Goè°ƒç”¨JavaScriptå‡½æ•°</h3><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;syscall/js&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// è·å–documentå¯¹è±¡</span>    document := js.Global().Get(<span class="hljs-string">&quot;document&quot;</span>)        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„divå…ƒç´ </span>    div := document.Call(<span class="hljs-string">&quot;createElement&quot;</span>, <span class="hljs-string">&quot;div&quot;</span>)    div.Set(<span class="hljs-string">&quot;innerHTML&quot;</span>, <span class="hljs-string">&quot;è¿™ä¸ªdivæ˜¯ç”±Goåˆ›å»ºçš„ï¼&quot;</span>)        <span class="hljs-comment">// å°†divæ·»åŠ åˆ°body</span>    document.Get(<span class="hljs-string">&quot;body&quot;</span>).Call(<span class="hljs-string">&quot;appendChild&quot;</span>, div)        <span class="hljs-comment">// é˜²æ­¢ç¨‹åºé€€å‡º</span>    <span class="hljs-keyword">select</span> &#123;&#125;&#125;</code></pre><h3 id="2-å‘JavaScriptæš´éœ²Goå‡½æ•°"><a class="header-anchor" href="#2-å‘JavaScriptæš´éœ²Goå‡½æ•°"></a>2. å‘JavaScriptæš´éœ²Goå‡½æ•°</h3><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;fmt&quot;</span>    <span class="hljs-string">&quot;syscall/js&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">calculateFactorial</span><span class="hljs-params">(this js.Value, args []js.Value)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) == <span class="hljs-number">0</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;è¯·æä¾›ä¸€ä¸ªæ•°å­—&quot;</span>    &#125;        n := args[<span class="hljs-number">0</span>].Int()    result := <span class="hljs-number">1</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">2</span>; i &lt;= n; i++ &#123;        result *= i    &#125;        <span class="hljs-keyword">return</span> result&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// å°†å‡½æ•°æ³¨å†Œåˆ°JavaScriptå…¨å±€ç©ºé—´</span>    js.Global().Set(<span class="hljs-string">&quot;factorial&quot;</span>, js.FuncOf(calculateFactorial))        fmt.Println(<span class="hljs-string">&quot;Go WebAssemblyå·²åˆå§‹åŒ–ï¼Œfactorialå‡½æ•°å·²å¯¼å‡º&quot;</span>)        <span class="hljs-comment">// ä¿æŒç¨‹åºè¿è¡Œ</span>    <span class="hljs-keyword">select</span> &#123;&#125;&#125;</code></pre><p>åœ¨JavaScriptä¸­è°ƒç”¨ï¼š</p><pre><code class="hljs javascript"><span class="hljs-comment">// HTMLä¸­</span><span class="hljs-keyword">const</span> result = factorial(<span class="hljs-number">5</span>);  <span class="hljs-comment">// è¿”å›120</span></code></pre><h3 id="3-å›è°ƒå‡½æ•°å¤„ç†"><a class="header-anchor" href="#3-å›è°ƒå‡½æ•°å¤„ç†"></a>3. å›è°ƒå‡½æ•°å¤„ç†</h3><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;syscall/js&quot;</span>    <span class="hljs-string">&quot;time&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">asyncOperation</span><span class="hljs-params">(this js.Value, args []js.Value)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    <span class="hljs-comment">// æ£€æŸ¥å›è°ƒå‡½æ•°</span>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) == <span class="hljs-number">0</span> || !args[<span class="hljs-number">0</span>].InstanceOf(js.Global().Get(<span class="hljs-string">&quot;Function&quot;</span>)) &#123;        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;è¯·æä¾›å›è°ƒå‡½æ•°&quot;</span>    &#125;        callback := args[<span class="hljs-number">0</span>]        <span class="hljs-comment">// æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        time.Sleep(<span class="hljs-number">2</span> * time.Second)                <span class="hljs-comment">// è°ƒç”¨JavaScriptå›è°ƒ</span>        callback.Invoke(<span class="hljs-string">&quot;æ“ä½œå®Œæˆï¼&quot;</span>)    &#125;()        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    js.Global().Set(<span class="hljs-string">&quot;performAsync&quot;</span>, js.FuncOf(asyncOperation))    <span class="hljs-keyword">select</span> &#123;&#125;&#125;</code></pre><p>åœ¨JavaScriptä¸­ä½¿ç”¨ï¼š</p><pre><code class="hljs javascript"><span class="hljs-comment">// HTMLä¸­</span>performAsync(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> &#123;    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;æ”¶åˆ°ç»“æœ:&quot;</span>, result);&#125;);</code></pre><h2 id="ğŸ”„-æ•°æ®ç±»å‹è½¬æ¢"><a class="header-anchor" href="#ğŸ”„-æ•°æ®ç±»å‹è½¬æ¢"></a>ğŸ”„ æ•°æ®ç±»å‹è½¬æ¢</h2><p>Goå’ŒJavaScriptä¹‹é—´ä¼ é€’æ•°æ®éœ€è¦è¿›è¡Œç±»å‹è½¬æ¢ï¼Œä¸‹é¢æ˜¯å¸¸è§æ•°æ®ç±»å‹çš„å¤„ç†æ–¹æ³•ï¼š</p><h3 id="åŸºæœ¬ç±»å‹è½¬æ¢"><a class="header-anchor" href="#åŸºæœ¬ç±»å‹è½¬æ¢"></a>åŸºæœ¬ç±»å‹è½¬æ¢</h3><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;syscall/js&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">typeConversionExample</span><span class="hljs-params">(this js.Value, args []js.Value)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    <span class="hljs-comment">// JavaScript -&gt; Go</span>    jsString := args[<span class="hljs-number">0</span>].String()           <span class="hljs-comment">// string</span>    jsNumber := args[<span class="hljs-number">1</span>].Float()            <span class="hljs-comment">// float64</span>    jsInt := args[<span class="hljs-number">2</span>].Int()                 <span class="hljs-comment">// int</span>    jsBool := args[<span class="hljs-number">3</span>].Bool()               <span class="hljs-comment">// bool</span>        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªJavaScriptå¯¹è±¡</span>    result := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)    result[<span class="hljs-string">&quot;stringSquared&quot;</span>] = jsString + jsString    result[<span class="hljs-string">&quot;numberDoubled&quot;</span>] = jsNumber * <span class="hljs-number">2</span>    result[<span class="hljs-string">&quot;intSquared&quot;</span>] = jsInt * jsInt    result[<span class="hljs-string">&quot;boolInverted&quot;</span>] = !jsBool        <span class="hljs-comment">// Go -&gt; JavaScript (ä½¿ç”¨mapè½¬æ¢ä¸ºJSå¯¹è±¡)</span>    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    js.Global().Set(<span class="hljs-string">&quot;convertTypes&quot;</span>, js.FuncOf(typeConversionExample))    <span class="hljs-keyword">select</span> &#123;&#125;&#125;</code></pre><h3 id="æ•°ç»„å’Œåˆ‡ç‰‡è½¬æ¢"><a class="header-anchor" href="#æ•°ç»„å’Œåˆ‡ç‰‡è½¬æ¢"></a>æ•°ç»„å’Œåˆ‡ç‰‡è½¬æ¢</h3><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">arrayExample</span><span class="hljs-params">(this js.Value, args []js.Value)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    <span class="hljs-comment">// å°†JavaScriptæ•°ç»„è½¬æ¢ä¸ºGoåˆ‡ç‰‡</span>    jsArray := args[<span class="hljs-number">0</span>]    length := jsArray.Length()    goSlice := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, length)        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; length; i++ &#123;        goSlice[i] = jsArray.Index(i).Int()    &#125;        <span class="hljs-comment">// å¤„ç†æ•°æ®ï¼ˆå°†æ¯ä¸ªå…ƒç´ ç¿»å€ï¼‰</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> goSlice &#123;        goSlice[i] *= <span class="hljs-number">2</span>    &#125;        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„JavaScriptæ•°ç»„</span>    jsResult := js.Global().Get(<span class="hljs-string">&quot;Array&quot;</span>).New(<span class="hljs-built_in">len</span>(goSlice))    <span class="hljs-keyword">for</span> i, val := <span class="hljs-keyword">range</span> goSlice &#123;        jsResult.SetIndex(i, val)    &#125;        <span class="hljs-keyword">return</span> jsResult&#125;</code></pre><h3 id="å¤æ‚æ•°æ®ç»“æ„"><a class="header-anchor" href="#å¤æ‚æ•°æ®ç»“æ„"></a>å¤æ‚æ•°æ®ç»“æ„</h3><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;    Name    <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span>    Age     <span class="hljs-keyword">int</span>    <span class="hljs-string">`json:&quot;age&quot;`</span>    IsAdmin <span class="hljs-keyword">bool</span>   <span class="hljs-string">`json:&quot;isAdmin&quot;`</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">structExample</span><span class="hljs-params">(this js.Value, args []js.Value)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    <span class="hljs-comment">// ä»JavaScriptå¯¹è±¡åˆ›å»ºGoç»“æ„ä½“</span>    jsObj := args[<span class="hljs-number">0</span>]    person := Person&#123;        Name:    jsObj.Get(<span class="hljs-string">&quot;name&quot;</span>).String(),        Age:     jsObj.Get(<span class="hljs-string">&quot;age&quot;</span>).Int(),        IsAdmin: jsObj.Get(<span class="hljs-string">&quot;isAdmin&quot;</span>).Bool(),    &#125;        <span class="hljs-comment">// å¤„ç†æ•°æ®</span>    person.Age++    person.IsAdmin = !person.IsAdmin        <span class="hljs-comment">// å°†Goç»“æ„ä½“è½¬å›JavaScriptå¯¹è±¡</span>    result := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)    result[<span class="hljs-string">&quot;name&quot;</span>] = person.Name    result[<span class="hljs-string">&quot;age&quot;</span>] = person.Age    result[<span class="hljs-string">&quot;isAdmin&quot;</span>] = person.IsAdmin        <span class="hljs-keyword">return</span> result&#125;</code></pre><h2 id="ğŸ“Š-å®æˆ˜æ¡ˆä¾‹ï¼šæµè§ˆå™¨ä¸­çš„æ•°æ®å¯è§†åŒ–"><a class="header-anchor" href="#ğŸ“Š-å®æˆ˜æ¡ˆä¾‹ï¼šæµè§ˆå™¨ä¸­çš„æ•°æ®å¯è§†åŒ–"></a>ğŸ“Š å®æˆ˜æ¡ˆä¾‹ï¼šæµè§ˆå™¨ä¸­çš„æ•°æ®å¯è§†åŒ–</h2><p>ç°åœ¨æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªå®ç”¨çš„ä¾‹å­ï¼šä¸€ä¸ªåœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨Goè¿›è¡Œæ•°æ®å¤„ç†å’Œå¯è§†åŒ–çš„åº”ç”¨ã€‚</p><h3 id="1-é¡¹ç›®ç»“æ„"><a class="header-anchor" href="#1-é¡¹ç›®ç»“æ„"></a>1. é¡¹ç›®ç»“æ„</h3><pre><code class="hljs awk">data-viz/â”œâ”€â”€ main.go          <span class="hljs-regexp">//</span> Go WebAssemblyä»£ç â”œâ”€â”€ index.html       <span class="hljs-regexp">//</span> HTMLç•Œé¢â”œâ”€â”€ style.css        <span class="hljs-regexp">//</span> æ ·å¼â”œâ”€â”€ wasm_exec.js     <span class="hljs-regexp">//</span> Go WebAssemblyæ”¯æŒæ–‡ä»¶â””â”€â”€ server.go        <span class="hljs-regexp">//</span> æœ¬åœ°æœåŠ¡å™¨</code></pre><h3 id="2-Goä»£ç ï¼ˆmain-goï¼‰"><a class="header-anchor" href="#2-Goä»£ç ï¼ˆmain-goï¼‰"></a>2. Goä»£ç ï¼ˆmain.goï¼‰</h3><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;encoding/json&quot;</span>    <span class="hljs-string">&quot;math&quot;</span>    <span class="hljs-string">&quot;syscall/js&quot;</span>)<span class="hljs-comment">// æ•°æ®ç‚¹ç»“æ„</span><span class="hljs-keyword">type</span> DataPoint <span class="hljs-keyword">struct</span> &#123;    X <span class="hljs-keyword">float64</span> <span class="hljs-string">`json:&quot;x&quot;`</span>    Y <span class="hljs-keyword">float64</span> <span class="hljs-string">`json:&quot;y&quot;`</span>&#125;<span class="hljs-comment">// ç”Ÿæˆæ­£å¼¦æ³¢æ•°æ®</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateSineWave</span><span class="hljs-params">(this js.Value, args []js.Value)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    <span class="hljs-comment">// ä»å‚æ•°è·å–ç‚¹æ•°å’ŒæŒ¯å¹…</span>    points := <span class="hljs-number">100</span>    amplitude := <span class="hljs-number">1.0</span>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">0</span> &#123;        points = args[<span class="hljs-number">0</span>].Int()    &#125;    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">1</span> &#123;        amplitude = args[<span class="hljs-number">1</span>].Float()    &#125;        <span class="hljs-comment">// ç”Ÿæˆæ•°æ®ç‚¹</span>    data := <span class="hljs-built_in">make</span>([]DataPoint, points)    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; points; i++ &#123;        x := <span class="hljs-keyword">float64</span>(i) * (<span class="hljs-number">2</span> * math.Pi / <span class="hljs-keyword">float64</span>(points))        y := amplitude * math.Sin(x)        data[i] = DataPoint&#123;X: x, Y: y&#125;    &#125;        <span class="hljs-comment">// å°†æ•°æ®åºåˆ—åŒ–ä¸ºJSON</span>    jsonData, _ := json.Marshal(data)        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªUint8Arrayæ¥å­˜å‚¨JSONæ•°æ®</span>    uint8Array := js.Global().Get(<span class="hljs-string">&quot;Uint8Array&quot;</span>).New(<span class="hljs-built_in">len</span>(jsonData))    js.CopyBytesToJS(uint8Array, jsonData)        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªTextDecoderæ¥å°†Uint8Arrayè½¬æ¢ä¸ºå­—ç¬¦ä¸²</span>    decoder := js.Global().Get(<span class="hljs-string">&quot;TextDecoder&quot;</span>).New(<span class="hljs-string">&quot;utf-8&quot;</span>)    result := decoder.Call(<span class="hljs-string">&quot;decode&quot;</span>, uint8Array)        <span class="hljs-keyword">return</span> result&#125;<span class="hljs-comment">// è®¡ç®—ç§»åŠ¨å¹³å‡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">calculateMovingAverage</span><span class="hljs-params">(this js.Value, args []js.Value)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    <span class="hljs-comment">// è§£æè¾“å…¥æ•°æ®</span>    jsonStr := args[<span class="hljs-number">0</span>].String()    windowSize := <span class="hljs-number">5</span>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) &gt; <span class="hljs-number">1</span> &#123;        windowSize = args[<span class="hljs-number">1</span>].Int()    &#125;        <span class="hljs-comment">// è§£æJSONæ•°æ®</span>    <span class="hljs-keyword">var</span> data []DataPoint    <span class="hljs-keyword">if</span> err := json.Unmarshal([]<span class="hljs-keyword">byte</span>(jsonStr), &amp;data); err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;JSONè§£æé”™è¯¯&quot;</span>    &#125;        <span class="hljs-comment">// è®¡ç®—ç§»åŠ¨å¹³å‡</span>    result := <span class="hljs-built_in">make</span>([]DataPoint, <span class="hljs-built_in">len</span>(data))    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> data &#123;        sum := <span class="hljs-number">0.0</span>        count := <span class="hljs-number">0</span>                <span class="hljs-comment">// è®¡ç®—çª—å£å†…çš„å¹³å‡å€¼</span>        <span class="hljs-keyword">for</span> j := i - windowSize + <span class="hljs-number">1</span>; j &lt;= i; j++ &#123;            <span class="hljs-keyword">if</span> j &gt;= <span class="hljs-number">0</span> &#123;                sum += data[j].Y                count++            &#125;        &#125;                <span class="hljs-comment">// è®¾ç½®ç»“æœ</span>        <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">0</span> &#123;            result[i] = DataPoint&#123;X: data[i].X, Y: sum / <span class="hljs-keyword">float64</span>(count)&#125;        &#125; <span class="hljs-keyword">else</span> &#123;            result[i] = data[i]        &#125;    &#125;        <span class="hljs-comment">// å°†ç»“æœåºåˆ—åŒ–ä¸ºJSON</span>    jsonResult, _ := json.Marshal(result)        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªUint8Arrayæ¥å­˜å‚¨JSONæ•°æ®</span>    uint8Array := js.Global().Get(<span class="hljs-string">&quot;Uint8Array&quot;</span>).New(<span class="hljs-built_in">len</span>(jsonResult))    js.CopyBytesToJS(uint8Array, jsonResult)        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªTextDecoderæ¥å°†Uint8Arrayè½¬æ¢ä¸ºå­—ç¬¦ä¸²</span>    decoder := js.Global().Get(<span class="hljs-string">&quot;TextDecoder&quot;</span>).New(<span class="hljs-string">&quot;utf-8&quot;</span>)    <span class="hljs-keyword">return</span> decoder.Call(<span class="hljs-string">&quot;decode&quot;</span>, uint8Array)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// æ³¨å†Œå‡½æ•°åˆ°JavaScript</span>    js.Global().Set(<span class="hljs-string">&quot;generateSineWave&quot;</span>, js.FuncOf(generateSineWave))    js.Global().Set(<span class="hljs-string">&quot;calculateMovingAverage&quot;</span>, js.FuncOf(calculateMovingAverage))        <span class="hljs-comment">// ä¿æŒç¨‹åºè¿è¡Œ</span>    <span class="hljs-keyword">select</span> &#123;&#125;&#125;</code></pre><h3 id="3-HTMLç•Œé¢ï¼ˆindex-htmlï¼‰"><a class="header-anchor" href="#3-HTMLç•Œé¢ï¼ˆindex-htmlï¼‰"></a>3. HTMLç•Œé¢ï¼ˆindex.htmlï¼‰</h3><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Go WebAssembly æ•°æ®å¯è§†åŒ–<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;style.css&quot;</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;wasm_exec.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.jsdelivr.net/npm/chart.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">        <span class="hljs-comment">// åˆå§‹åŒ–Go WebAssembly</span></span><span class="javascript">        <span class="hljs-keyword">const</span> go = <span class="hljs-keyword">new</span> Go();</span><span class="javascript">        WebAssembly.instantiateStreaming(fetch(<span class="hljs-string">&quot;main.wasm&quot;</span>), go.importObject)</span><span class="javascript">            .then(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> &#123;</span>                go.run(result.instance);<span class="javascript">                <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;status&quot;</span>).textContent = <span class="hljs-string">&quot;WebAssemblyå·²åŠ è½½&quot;</span>;</span>                <span class="javascript">                <span class="hljs-comment">// åˆå§‹åŒ–å›¾è¡¨</span></span>                initChart();            &#125;);        <span class="javascript">        <span class="hljs-keyword">let</span> chart;</span><span class="javascript">        <span class="hljs-keyword">let</span> rawData;</span>        <span class="javascript">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initChart</span>(<span class="hljs-params"></span>) </span>&#123;</span><span class="javascript">            <span class="hljs-keyword">const</span> ctx = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;chart&#x27;</span>).getContext(<span class="hljs-string">&#x27;2d&#x27;</span>);</span><span class="javascript">            chart = <span class="hljs-keyword">new</span> Chart(ctx, &#123;</span><span class="javascript">                type: <span class="hljs-string">&#x27;line&#x27;</span>,</span>                data: &#123;                    datasets: [                        &#123;<span class="javascript">                            label: <span class="hljs-string">&#x27;åŸå§‹æ•°æ®&#x27;</span>,</span><span class="javascript">                            borderColor: <span class="hljs-string">&#x27;rgb(75, 192, 192)&#x27;</span>,</span>                            data: []                        &#125;,                        &#123;<span class="javascript">                            label: <span class="hljs-string">&#x27;ç§»åŠ¨å¹³å‡&#x27;</span>,</span><span class="javascript">                            borderColor: <span class="hljs-string">&#x27;rgb(255, 99, 132)&#x27;</span>,</span>                            data: []                        &#125;                    ]                &#125;,                options: &#123;<span class="javascript">                    responsive: <span class="hljs-literal">true</span>,</span>                    scales: &#123;                        x: &#123;                            title: &#123;<span class="javascript">                                display: <span class="hljs-literal">true</span>,</span><span class="javascript">                                text: <span class="hljs-string">&#x27;X&#x27;</span></span>                            &#125;                        &#125;,                        y: &#123;                            title: &#123;<span class="javascript">                                display: <span class="hljs-literal">true</span>,</span><span class="javascript">                                text: <span class="hljs-string">&#x27;Y&#x27;</span></span>                            &#125;                        &#125;                    &#125;                &#125;            &#125;);        &#125;        <span class="javascript">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateChart</span>(<span class="hljs-params"></span>) </span>&#123;</span><span class="javascript">            <span class="hljs-keyword">const</span> points = <span class="hljs-built_in">parseInt</span>(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;points&quot;</span>).value);</span><span class="javascript">            <span class="hljs-keyword">const</span> amplitude = <span class="hljs-built_in">parseFloat</span>(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;amplitude&quot;</span>).value);</span><span class="javascript">            <span class="hljs-keyword">const</span> windowSize = <span class="hljs-built_in">parseInt</span>(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;windowSize&quot;</span>).value);</span>            <span class="javascript">            <span class="hljs-comment">// ä½¿ç”¨Goå‡½æ•°ç”Ÿæˆæ•°æ®</span></span><span class="javascript">            rawData = <span class="hljs-built_in">JSON</span>.parse(generateSineWave(points, amplitude));</span>            <span class="javascript">            <span class="hljs-comment">// ä½¿ç”¨Goå‡½æ•°è®¡ç®—ç§»åŠ¨å¹³å‡</span></span><span class="javascript">            <span class="hljs-keyword">const</span> avgData = <span class="hljs-built_in">JSON</span>.parse(calculateMovingAverage(<span class="hljs-built_in">JSON</span>.stringify(rawData), windowSize));</span>            <span class="javascript">            <span class="hljs-comment">// æ›´æ–°å›¾è¡¨</span></span><span class="javascript">            chart.data.datasets[<span class="hljs-number">0</span>].data = rawData.map(<span class="hljs-function"><span class="hljs-params">point</span> =&gt;</span> (&#123;<span class="hljs-attr">x</span>: point.x, <span class="hljs-attr">y</span>: point.y&#125;));</span><span class="javascript">            chart.data.datasets[<span class="hljs-number">1</span>].data = avgData.map(<span class="hljs-function"><span class="hljs-params">point</span> =&gt;</span> (&#123;<span class="hljs-attr">x</span>: point.x, <span class="hljs-attr">y</span>: point.y&#125;));</span>            chart.update();        &#125;    <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Go WebAssembly æ•°æ®å¯è§†åŒ–<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;status&quot;</span>&gt;</span>æ­£åœ¨åŠ è½½WebAssembly...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;controls&quot;</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>                æ•°æ®ç‚¹æ•°é‡:                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;points&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;100&quot;</span> <span class="hljs-attr">min</span>=<span class="hljs-string">&quot;10&quot;</span> <span class="hljs-attr">max</span>=<span class="hljs-string">&quot;1000&quot;</span>&gt;</span>            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>                æŒ¯å¹…:                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;amplitude&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;1&quot;</span> <span class="hljs-attr">min</span>=<span class="hljs-string">&quot;0.1&quot;</span> <span class="hljs-attr">max</span>=<span class="hljs-string">&quot;10&quot;</span> <span class="hljs-attr">step</span>=<span class="hljs-string">&quot;0.1&quot;</span>&gt;</span>            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>                ç§»åŠ¨å¹³å‡çª—å£å¤§å°:                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;windowSize&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;5&quot;</span> <span class="hljs-attr">min</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">max</span>=<span class="hljs-string">&quot;20&quot;</span>&gt;</span>            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;updateChart()&quot;</span>&gt;</span>æ›´æ–°å›¾è¡¨<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;chart-container&quot;</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;chart&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><h3 id="4-æ ·å¼æ–‡ä»¶ï¼ˆstyle-cssï¼‰"><a class="header-anchor" href="#4-æ ·å¼æ–‡ä»¶ï¼ˆstyle-cssï¼‰"></a>4. æ ·å¼æ–‡ä»¶ï¼ˆstyle.cssï¼‰</h3><pre><code class="hljs css"><span class="hljs-selector-tag">body</span> &#123;    <span class="hljs-attribute">font-family</span>: Arial, sans-serif;    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.6</span>;    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;    <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;&#125;<span class="hljs-selector-class">.container</span> &#123;    <span class="hljs-attribute">max-width</span>: <span class="hljs-number">800px</span>;    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;    <span class="hljs-attribute">background</span>: white;    <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);&#125;<span class="hljs-selector-tag">h1</span> &#123;    <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;    <span class="hljs-attribute">text-align</span>: center;&#125;<span class="hljs-selector-class">.controls</span> &#123;    <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0</span>;    <span class="hljs-attribute">display</span>: flex;    <span class="hljs-attribute">flex-wrap</span>: wrap;    <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;    <span class="hljs-attribute">align-items</span>: center;&#125;<span class="hljs-selector-class">.controls</span> <span class="hljs-selector-tag">label</span> &#123;    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">10px</span>;&#125;<span class="hljs-selector-class">.controls</span> <span class="hljs-selector-tag">input</span> &#123;    <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span>;    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;&#125;<span class="hljs-selector-tag">button</span> &#123;    <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#4CAF50</span>;    <span class="hljs-attribute">color</span>: white;    <span class="hljs-attribute">border</span>: none;    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;    <span class="hljs-attribute">cursor</span>: pointer;&#125;<span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:hover</span> &#123;    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#45a049</span>;&#125;<span class="hljs-selector-class">.chart-container</span> &#123;    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;    <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;&#125;<span class="hljs-selector-id">#status</span> &#123;    <span class="hljs-attribute">text-align</span>: center;    <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;&#125;</code></pre><h2 id="ğŸš€-æ€§èƒ½ä¼˜åŒ–æŠ€å·§"><a class="header-anchor" href="#ğŸš€-æ€§èƒ½ä¼˜åŒ–æŠ€å·§"></a>ğŸš€ æ€§èƒ½ä¼˜åŒ–æŠ€å·§</h2><p>åœ¨ä½¿ç”¨Go WebAssemblyæ—¶ï¼Œæ€§èƒ½ä¼˜åŒ–éå¸¸é‡è¦ï¼Œä¸‹é¢æ˜¯ä¸€äº›å®ç”¨çš„ä¼˜åŒ–æŠ€å·§ï¼š</p><h3 id="1-æœ€å°åŒ–Goå’ŒJavaScriptä¹‹é—´çš„é€šä¿¡"><a class="header-anchor" href="#1-æœ€å°åŒ–Goå’ŒJavaScriptä¹‹é—´çš„é€šä¿¡"></a>1. æœ€å°åŒ–Goå’ŒJavaScriptä¹‹é—´çš„é€šä¿¡</h3><p>æ¯æ¬¡è·¨è¾¹ç•Œè°ƒç”¨éƒ½æœ‰ä¸€å®šå¼€é”€ï¼Œå°½é‡æ‰¹é‡å¤„ç†ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä½æ•ˆæ–¹å¼ï¼šé¢‘ç¹è·¨è¾¹ç•Œè°ƒç”¨</span><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ &#123;    js.Global().Call(<span class="hljs-string">&quot;processItem&quot;</span>, i)&#125;<span class="hljs-comment">// ä¼˜åŒ–æ–¹å¼ï¼šä¸€æ¬¡æ€§ä¼ é€’æ•°æ®</span>items := js.Global().Get(<span class="hljs-string">&quot;Array&quot;</span>).New(<span class="hljs-number">1000</span>)<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ &#123;    items.SetIndex(i, i)&#125;js.Global().Call(<span class="hljs-string">&quot;processItems&quot;</span>, items)</code></pre><h3 id="2-ä½¿ç”¨TypedArraysè¿›è¡ŒäºŒè¿›åˆ¶æ•°æ®äº¤æ¢"><a class="header-anchor" href="#2-ä½¿ç”¨TypedArraysè¿›è¡ŒäºŒè¿›åˆ¶æ•°æ®äº¤æ¢"></a>2. ä½¿ç”¨TypedArraysè¿›è¡ŒäºŒè¿›åˆ¶æ•°æ®äº¤æ¢</h3><p>å¯¹äºå¤§å‹æ•°æ®ä¼ è¾“ï¼Œä½¿ç”¨TypedArraysæ¯”JSONåºåˆ—åŒ–æ•ˆç‡æ›´é«˜ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªFloat64Array</span>length := <span class="hljs-number">1000</span>array := js.Global().Get(<span class="hljs-string">&quot;Float64Array&quot;</span>).New(length)<span class="hljs-comment">// å°†Goæ•°æ®å¤åˆ¶åˆ°TypedArray</span><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; length; i++ &#123;    array.SetIndex(i, math.Sin(<span class="hljs-keyword">float64</span>(i)*<span class="hljs-number">0.01</span>))&#125;<span class="hljs-comment">// å°†TypedArrayä¼ é€’ç»™JavaScript</span>js.Global().Call(<span class="hljs-string">&quot;processArray&quot;</span>, array)</code></pre><h3 id="3-é¿å…é¢‘ç¹å†…å­˜åˆ†é…"><a class="header-anchor" href="#3-é¿å…é¢‘ç¹å†…å­˜åˆ†é…"></a>3. é¿å…é¢‘ç¹å†…å­˜åˆ†é…</h3><p>é‡ç”¨å¯¹è±¡ä»¥å‡å°‘åƒåœ¾å›æ”¶ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ç¼“å­˜å¸¸ç”¨JSå¯¹è±¡å¼•ç”¨</span><span class="hljs-keyword">var</span> (    document = js.Global().Get(<span class="hljs-string">&quot;document&quot;</span>)    console  = js.Global().Get(<span class="hljs-string">&quot;console&quot;</span>))<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">updateUI</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„å¼•ç”¨</span>    document.Call(<span class="hljs-string">&quot;getElementById&quot;</span>, <span class="hljs-string">&quot;status&quot;</span>).Set(<span class="hljs-string">&quot;textContent&quot;</span>, <span class="hljs-string">&quot;æ›´æ–°å®Œæˆ&quot;</span>)    console.Call(<span class="hljs-string">&quot;log&quot;</span>, <span class="hljs-string">&quot;UIå·²æ›´æ–°&quot;</span>)&#125;</code></pre><h3 id="4-ä½¿ç”¨Workerè¿›è¡Œå¹¶è¡Œå¤„ç†"><a class="header-anchor" href="#4-ä½¿ç”¨Workerè¿›è¡Œå¹¶è¡Œå¤„ç†"></a>4. ä½¿ç”¨Workerè¿›è¡Œå¹¶è¡Œå¤„ç†</h3><p>Go WebAssemblyå¯ä»¥åœ¨Web Workerä¸­è¿è¡Œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼š</p><pre><code class="hljs javascript"><span class="hljs-comment">// main.js</span><span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> Worker(<span class="hljs-string">&#x27;worker.js&#x27;</span>);worker.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>&#123;    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;ä»Workeræ”¶åˆ°ç»“æœ:&#x27;</span>, e.data);&#125;;worker.postMessage(&#123;<span class="hljs-attr">action</span>: <span class="hljs-string">&#x27;process&#x27;</span>, <span class="hljs-attr">data</span>: [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>]&#125;);<span class="hljs-comment">// worker.js</span>importScripts(<span class="hljs-string">&#x27;wasm_exec.js&#x27;</span>);<span class="hljs-keyword">const</span> go = <span class="hljs-keyword">new</span> Go();WebAssembly.instantiateStreaming(fetch(<span class="hljs-string">&quot;worker.wasm&quot;</span>), go.importObject)    .then(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> &#123;        go.run(result.instance);                <span class="hljs-comment">// æ¥æ”¶æ¥è‡ªä¸»çº¿ç¨‹çš„æ¶ˆæ¯</span>        self.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>&#123;            <span class="hljs-keyword">if</span> (e.data.action === <span class="hljs-string">&#x27;process&#x27;</span>) &#123;                <span class="hljs-comment">// è°ƒç”¨Goå‡½æ•°å¤„ç†æ•°æ®</span>                <span class="hljs-keyword">const</span> result = processData(e.data.data);                <span class="hljs-comment">// å°†ç»“æœå‘é€å›ä¸»çº¿ç¨‹</span>                self.postMessage(result);            &#125;        &#125;;    &#125;);</code></pre><h2 id="ğŸ”-è°ƒè¯•æŠ€å·§"><a class="header-anchor" href="#ğŸ”-è°ƒè¯•æŠ€å·§"></a>ğŸ” è°ƒè¯•æŠ€å·§</h2><p>WebAssemblyè°ƒè¯•å¯èƒ½æ¯”è¾ƒæ£˜æ‰‹ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›æœ‰ç”¨çš„æŠ€å·§ï¼š</p><h3 id="1-ä½¿ç”¨console-logè¿›è¡Œè°ƒè¯•"><a class="header-anchor" href="#1-ä½¿ç”¨console-logè¿›è¡Œè°ƒè¯•"></a>1. ä½¿ç”¨console.logè¿›è¡Œè°ƒè¯•</h3><p>åœ¨Goä¸­ï¼Œä½¿ç”¨<code>println</code>æˆ–é€šè¿‡JavaScriptçš„<code>console.log</code>ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// Goä¸­çš„åŸç”Ÿprintlnï¼ˆè¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°ï¼‰</span><span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;Debug:&quot;</span>, someValue)<span class="hljs-comment">// æˆ–é€šè¿‡JavaScriptçš„console.log</span>js.Global().Get(<span class="hljs-string">&quot;console&quot;</span>).Call(<span class="hljs-string">&quot;log&quot;</span>, <span class="hljs-string">&quot;Debug:&quot;</span>, someValue)</code></pre><h3 id="2-ä½¿ç”¨Chrome-DevTools"><a class="header-anchor" href="#2-ä½¿ç”¨Chrome-DevTools"></a>2. ä½¿ç”¨Chrome DevTools</h3><p>Chromeæµè§ˆå™¨ç°åœ¨æ”¯æŒWebAssemblyè°ƒè¯•ï¼š</p><ol><li>æ‰“å¼€Chrome DevTools</li><li>è½¬åˆ°Sourcesæ ‡ç­¾</li><li>åœ¨å·¦ä¾§é¢æ¿æ‰¾åˆ°.wasmæ–‡ä»¶</li><li>å¯ä»¥çœ‹åˆ°åæ±‡ç¼–çš„WebAssemblyä»£ç </li><li>è®¾ç½®æ–­ç‚¹å¹¶æ£€æŸ¥æ•°æ®</li></ol><h3 id="3-å®ç°é”™è¯¯å¤„ç†"><a class="header-anchor" href="#3-å®ç°é”™è¯¯å¤„ç†"></a>3. å®ç°é”™è¯¯å¤„ç†</h3><p>åŒ…è£…Goå‡½æ•°ä»¥æ•è·å¹¶æŠ¥å‘Šé”™è¯¯ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">safeJsFunc</span><span class="hljs-params">(fn <span class="hljs-keyword">func</span>(js.Value, []js.Value)</span> <span class="hljs-title">interface</span></span>&#123;&#125;) js.Func &#123;    <span class="hljs-keyword">return</span> js.FuncOf(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(this js.Value, args []js.Value)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;            <span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> &#123;                js.Global().Get(<span class="hljs-string">&quot;console&quot;</span>).Call(<span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;Goå‡½æ•°é”™è¯¯:&quot;</span>, r)            &#125;        &#125;()        <span class="hljs-keyword">return</span> fn(this, args)    &#125;)&#125;<span class="hljs-comment">// ä½¿ç”¨</span>js.Global().Set(<span class="hljs-string">&quot;myFunction&quot;</span>, safeJsFunc(actualFunction))</code></pre><h2 id="ğŸ”®-æœªæ¥å±•æœ›ä¸å±€é™æ€§"><a class="header-anchor" href="#ğŸ”®-æœªæ¥å±•æœ›ä¸å±€é™æ€§"></a>ğŸ”® æœªæ¥å±•æœ›ä¸å±€é™æ€§</h2><p>Go WebAssemblyè™½ç„¶æœ‰å·¨å¤§æ½œåŠ›ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›å±€é™æ€§ï¼š</p><h3 id="ä¼˜åŠ¿"><a class="header-anchor" href="#ä¼˜åŠ¿"></a>ä¼˜åŠ¿</h3><ul><li>Goçš„å¼ºå¤§ç±»å‹ç³»ç»Ÿå’Œå¹¶å‘æ¨¡å‹</li><li>èƒ½å¤Ÿå¤ç”¨ç°æœ‰çš„Goä»£ç </li><li>åœ¨æµè§ˆå™¨ä¸­å®ç°æ¥è¿‘åŸç”Ÿçš„æ€§èƒ½</li><li>å¯ä»¥ä½¿ç”¨Goç”Ÿæ€ç³»ç»Ÿä¸­çš„åº“</li></ul><h3 id="å±€é™æ€§"><a class="header-anchor" href="#å±€é™æ€§"></a>å±€é™æ€§</h3><ul><li>äºŒè¿›åˆ¶å¤§å°é—®é¢˜ï¼šGo WebAssemblyé€šå¸¸æ¯”Rustæˆ–C++ç¼–è¯‘çš„äºŒè¿›åˆ¶æ›´å¤§</li><li>åƒåœ¾æ”¶é›†å™¨å¼€é”€ï¼šGoçš„GCå¯èƒ½ä¼šå¯¼è‡´å¶å°”çš„å¡é¡¿</li><li>DOMæ“ä½œä¸å¤ŸåŸç”Ÿï¼šä¸JavaScriptç›¸æ¯”ï¼ŒDOMæ“ä½œè¾ƒç¹ç</li><li>å·¥å…·æ”¯æŒä»åœ¨å®Œå–„ä¸­</li></ul><h3 id="æœªæ¥å‘å±•è¶‹åŠ¿"><a class="header-anchor" href="#æœªæ¥å‘å±•è¶‹åŠ¿"></a>æœªæ¥å‘å±•è¶‹åŠ¿</h3><ul><li>WASIï¼ˆWebAssemblyç³»ç»Ÿæ¥å£ï¼‰çš„å‘å±•å°†ä½¿WebAssemblyç”¨é€”æ›´å¹¿</li><li>ç»„ä»¶æ¨¡å‹å°†æ”¹è¿›æ¨¡å—åŒ–å’Œäº’æ“ä½œæ€§</li><li>åƒåœ¾æ”¶é›†å™¨ææ¡ˆå°†æå‡Goç­‰è¯­è¨€çš„è¡¨ç°</li><li>å¤šçº¿ç¨‹æ”¯æŒå°†æ”¹è¿›å¹¶å‘æ€§èƒ½</li></ul><h2 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h2><p>Go WebAssemblyä¸ºå¼€å‘è€…æä¾›äº†ä¸€ç§åœ¨Webå‰ç«¯ä½¿ç”¨Goè¯­è¨€èƒ½åŠ›çš„é€”å¾„ã€‚è™½ç„¶å­˜åœ¨ä¸€äº›å±€é™æ€§ï¼Œä½†éšç€WebAssemblyæŠ€æœ¯çš„ä¸æ–­æˆç†Ÿï¼Œè¿™äº›é™åˆ¶å°†é€æ¸è¢«è§£å†³ã€‚</p><p>å¯¹äºä»¥ä¸‹åœºæ™¯ï¼ŒGo WebAssemblyç‰¹åˆ«æœ‰ä»·å€¼ï¼š</p><ul><li>å¸Œæœ›åœ¨å‰ç«¯å¤ç”¨Goåç«¯ä»£ç çš„åº”ç”¨</li><li>éœ€è¦é«˜æ€§èƒ½è®¡ç®—çš„Webåº”ç”¨ï¼ˆå¦‚æ•°æ®å¤„ç†ã€å›¾å½¢å¤„ç†ï¼‰</li><li>å¯¹ç±»å‹å®‰å…¨å’Œå¹¶å‘æ€§æœ‰é«˜è¦æ±‚çš„å‰ç«¯åº”ç”¨</li></ul><p>å¸Œæœ›æœ¬æ–‡èƒ½å¸®åŠ©ä½ å¼€å§‹ä½¿ç”¨Go WebAssemblyï¼Œæ¢ç´¢è¿™ä¸€æ¿€åŠ¨äººå¿ƒçš„æŠ€æœ¯ã€‚å¦‚æœä½ æœ‰é—®é¢˜æˆ–ç»éªŒè¦åˆ†äº«ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµï¼</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>WebAssembly</tag>
      
      <tag>Wasm</tag>
      
      <tag>å‰ç«¯</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ğŸ¤– AIå¤§æ¨¡å‹è¾…åŠ©Goä»£ç ç”Ÿæˆæœ€ä½³å®è·µ</title>
    <link href="/2024/11/15/AI%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%BE%85%E5%8A%A9Go%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"/>
    <url>/2024/11/15/AI%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%BE%85%E5%8A%A9Go%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h1>ğŸ¤– AIå¤§æ¨¡å‹è¾…åŠ©Goä»£ç ç”Ÿæˆæœ€ä½³å®è·µ</h1><p>æœ€è¿‘ä¸€å¹´å¤šï¼Œæˆ‘ä¸€ç›´åœ¨æ¢ç´¢å¦‚ä½•å°†ChatGPTã€Claudeç­‰å¤§è¯­è¨€æ¨¡å‹(LLM)èå…¥åˆ°Goè¯­è¨€å¼€å‘å·¥ä½œæµä¸­ã€‚ç»è¿‡ä¸æ–­å°è¯•å’Œæ€»ç»“ï¼Œæˆ‘å‘ç°AIç¡®å®èƒ½å¤§å¹…æå‡ç¼–ç æ•ˆç‡ï¼Œä½†å‰ææ˜¯ä½ å¾—æŒæ¡æ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•ã€‚æœ¬æ–‡å°†åˆ†äº«æˆ‘åœ¨å®é™…å·¥ä½œä¸­ç§¯ç´¯çš„ä¸€äº›æœ€ä½³å®è·µç»éªŒã€‚</p><h2 id="ğŸ”-AIè¾…åŠ©Goå¼€å‘çš„ä¼˜åŠ¿"><a class="header-anchor" href="#ğŸ”-AIè¾…åŠ©Goå¼€å‘çš„ä¼˜åŠ¿"></a>ğŸ” AIè¾…åŠ©Goå¼€å‘çš„ä¼˜åŠ¿</h2><p>ç›¸æ¯”ä¼ ç»Ÿçš„ç¼–ç æ–¹å¼ï¼Œä½¿ç”¨AIè¾…åŠ©Goå¼€å‘æœ‰ä»¥ä¸‹å‡ ä¸ªæ˜æ˜¾ä¼˜åŠ¿ï¼š</p><ol><li><strong>åŠ é€Ÿç¼–ç </strong>ï¼šå‡å°‘é‡å¤æ€§ä»£ç ç¼–å†™ï¼Œä¸“æ³¨æ ¸å¿ƒä¸šåŠ¡é€»è¾‘</li><li><strong>å­¦ä¹ æ–°æŠ€æœ¯</strong>ï¼šå¿«é€Ÿè·å–å¹¶åº”ç”¨Goç”Ÿæ€æœ€æ–°çŸ¥è¯†</li><li><strong>è´¨é‡æå‡</strong>ï¼šAIå¯æä¾›ä»£ç å®¡æŸ¥å’Œä¼˜åŒ–å»ºè®®</li><li><strong>é™ä½å…¥é—¨é—¨æ§›</strong>ï¼šå¸®åŠ©æ–°æ‰‹å¿«é€ŸæŒæ¡Goè¯­è¨€ç‰¹æ€§å’Œæƒ¯ç”¨æ¨¡å¼</li></ol><h2 id="ğŸ› ï¸-å·¥å…·é€‰æ‹©ä¸é…ç½®"><a class="header-anchor" href="#ğŸ› ï¸-å·¥å…·é€‰æ‹©ä¸é…ç½®"></a>ğŸ› ï¸ å·¥å…·é€‰æ‹©ä¸é…ç½®</h2><h3 id="ä¸»æµAIç¼–ç åŠ©æ‰‹æ¯”è¾ƒ"><a class="header-anchor" href="#ä¸»æµAIç¼–ç åŠ©æ‰‹æ¯”è¾ƒ"></a>ä¸»æµAIç¼–ç åŠ©æ‰‹æ¯”è¾ƒ</h3><p>æˆ‘å°è¯•è¿‡å¤šç§AIç¼–ç å·¥å…·ï¼Œä¸‹é¢æ˜¯æˆ‘çš„ä½¿ç”¨ä½“éªŒï¼š</p><table><thead><tr><th>å·¥å…·</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>GitHub Copilot</td><td>ç¼–è¾‘å™¨é›†æˆå¥½ï¼Œå®æ—¶å»ºè®®</td><td>ä¸Šä¸‹æ–‡ç†è§£æœ‰é™ï¼Œæ— æ³•è¿›è¡Œäº¤äº’å¼å¯¹è¯</td><td>æ—¥å¸¸å°è§„æ¨¡ç¼–ç </td></tr><tr><td>ChatGPTï¼ˆ4.0ï¼‰</td><td>ä¸Šä¸‹æ–‡ç†è§£å¼ºï¼Œæ¨ç†èƒ½åŠ›å¥½</td><td>éœ€è¦åœ¨æµè§ˆå™¨ä¸­æ“ä½œï¼Œä»£ç é›†æˆä¸å¤Ÿæµç•…</td><td>å¤æ‚ç®—æ³•ï¼Œæ¶æ„è®¾è®¡</td></tr><tr><td>Claude</td><td>é•¿ä¸Šä¸‹æ–‡æ”¯æŒå¾ˆå¥½ï¼Œä»£ç è§£é‡Šæ¸…æ™°</td><td>æœ‰æ—¶ç”Ÿæˆä»£ç è¾ƒä¿å®ˆ</td><td>åˆ†æå¤§å‹ä»£ç åº“ï¼Œæ–‡æ¡£ç”Ÿæˆ</td></tr><tr><td>Cursor</td><td>Goæ”¯æŒä¸é”™ï¼Œç›´æ¥é›†æˆç¼–è¾‘å™¨</td><td>æœ‰æ—¶ä¼šç”Ÿæˆå¹»è§‰ä»£ç </td><td>å¿«é€ŸåŸå‹å¼€å‘</td></tr></tbody></table><h3 id="ç¼–è¾‘å™¨é›†æˆè®¾ç½®"><a class="header-anchor" href="#ç¼–è¾‘å™¨é›†æˆè®¾ç½®"></a>ç¼–è¾‘å™¨é›†æˆè®¾ç½®</h3><p>æˆ‘ç›®å‰ä½¿ç”¨VS Code+GitHub Copilot+è‡ªå®šä¹‰å¿«æ·é”®çš„ç»„åˆæ–¹æ¡ˆï¼š</p><pre><code class="hljs json"><span class="hljs-comment">// settings.json éƒ¨åˆ†é…ç½®</span>&#123;  <span class="hljs-attr">&quot;github.copilot.enable&quot;</span>: &#123;    <span class="hljs-attr">&quot;*&quot;</span>: <span class="hljs-literal">true</span>,    <span class="hljs-attr">&quot;go&quot;</span>: <span class="hljs-literal">true</span>,    <span class="hljs-attr">&quot;plaintext&quot;</span>: <span class="hljs-literal">false</span>,    <span class="hljs-attr">&quot;markdown&quot;</span>: <span class="hljs-literal">true</span>  &#125;,  <span class="hljs-attr">&quot;editor.inlineSuggest.enabled&quot;</span>: <span class="hljs-literal">true</span>,  <span class="hljs-attr">&quot;github.copilot.advanced&quot;</span>: &#123;    <span class="hljs-attr">&quot;inlineSuggestCount&quot;</span>: <span class="hljs-number">5</span>,    <span class="hljs-attr">&quot;listCount&quot;</span>: <span class="hljs-number">10</span>  &#125;&#125;</code></pre><h2 id="ğŸ¯-é«˜æ•ˆæç¤ºå·¥ç¨‹æŠ€å·§"><a class="header-anchor" href="#ğŸ¯-é«˜æ•ˆæç¤ºå·¥ç¨‹æŠ€å·§"></a>ğŸ¯ é«˜æ•ˆæç¤ºå·¥ç¨‹æŠ€å·§</h2><p>æƒ³è®©AIç”Ÿæˆé«˜è´¨é‡çš„Goä»£ç ï¼Œæç¤º(Prompt)è®¾è®¡éå¸¸å…³é”®ã€‚</p><h3 id="åŸºæœ¬æç¤ºæ¨¡æ¿"><a class="header-anchor" href="#åŸºæœ¬æç¤ºæ¨¡æ¿"></a>åŸºæœ¬æç¤ºæ¨¡æ¿</h3><pre><code class="hljs markdown">ä»»åŠ¡ï¼š[ç®€æ˜æè¿°éœ€è¦ç”Ÿæˆçš„Goä»£ç åŠŸèƒ½]èƒŒæ™¯ï¼š[æä¾›ç›¸å…³ä¸Šä¸‹æ–‡ï¼Œå¦‚é¡¹ç›®æ¶æ„ã€ä¾èµ–åº“ç­‰]æŠ€æœ¯çº¦æŸï¼š<span class="hljs-bullet">-</span> Goç‰ˆæœ¬ï¼š[å¦‚ Go 1.21]<span class="hljs-bullet">-</span> ä¾èµ–ç®¡ç†ï¼š[å¦‚ Go modules]<span class="hljs-bullet">-</span> ä»£ç é£æ ¼ï¼š[å¦‚ éµå¾ªGoå®˜æ–¹ä»£ç é£æ ¼æŒ‡å—]éœ€æ±‚è¯¦æƒ…ï¼š<span class="hljs-bullet">1.</span> [åŠŸèƒ½ç‚¹1]<span class="hljs-bullet">2.</span> [åŠŸèƒ½ç‚¹2]...å¸Œæœ›è¾“å‡ºï¼š<span class="hljs-bullet">-</span> å®Œæ•´çš„Goä»£ç å®ç°<span class="hljs-bullet">-</span> ç®€å•è§£é‡Šå…³é”®éƒ¨åˆ†é€»è¾‘<span class="hljs-bullet">-</span> åŸºæœ¬å•å…ƒæµ‹è¯•ç¤ºä¾‹</code></pre><h3 id="å®é™…æ¡ˆä¾‹ï¼šç”ŸæˆHTTPä¸­é—´ä»¶"><a class="header-anchor" href="#å®é™…æ¡ˆä¾‹ï¼šç”ŸæˆHTTPä¸­é—´ä»¶"></a>å®é™…æ¡ˆä¾‹ï¼šç”ŸæˆHTTPä¸­é—´ä»¶</h3><p>ä»¥ä¸‹æ˜¯æˆ‘å‘å¤§æ¨¡å‹è¯·æ±‚ç”Ÿæˆä¸€ä¸ªHTTPè¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶çš„å®é™…æç¤ºæ¡ˆä¾‹ï¼š</p><pre><code class="hljs markdown">è¯·å¸®æˆ‘å®ç°ä¸€ä¸ªGoè¯­è¨€çš„HTTPä¸­é—´ä»¶ï¼Œç”¨äºè®°å½•è¯·æ±‚æ—¥å¿—ã€‚æŠ€æœ¯çº¦æŸï¼š<span class="hljs-bullet">-</span> Go 1.18+<span class="hljs-bullet">-</span> ä½¿ç”¨æ ‡å‡†åº“ net/http<span class="hljs-bullet">-</span> éœ€å…¼å®¹ Gin æ¡†æ¶éœ€æ±‚ï¼š<span class="hljs-bullet">1.</span> è®°å½•è¯·æ±‚æ–¹æ³•ã€URLã€å®¢æˆ·ç«¯IPã€å“åº”çŠ¶æ€ç <span class="hljs-bullet">2.</span> è®¡ç®—è¯·æ±‚å¤„ç†è€—æ—¶<span class="hljs-bullet">3.</span> æ”¯æŒä¸åŒæ—¥å¿—çº§åˆ«ï¼ˆinfo/warn/errorï¼‰<span class="hljs-bullet">4.</span> æä¾›å¯é€‰çš„è¯·æ±‚ä½“é‡‡æ ·åŠŸèƒ½ï¼Œé»˜è®¤ä¸å¼€å¯<span class="hljs-bullet">5.</span> å®ç°è·Ÿè¸ªIDä¼ é€’ï¼Œä¼˜å…ˆä½¿ç”¨è¯·æ±‚å¤´ä¸­çš„X-Request-IDè¯·ç»™å‡ºå®Œæ•´å®ç°å’Œç®€å•ä½¿ç”¨ç¤ºä¾‹ã€‚</code></pre><p>è¿™ä¸ªæç¤ºæ¸…æ™°è¡¨è¾¾äº†éœ€æ±‚å’Œçº¦æŸï¼Œç”Ÿæˆçš„ä»£ç æ›´ç¬¦åˆå®é™…ä½¿ç”¨éœ€æ±‚ã€‚</p><h3 id="ç”Ÿæˆé«˜è´¨é‡Goä»£ç çš„æç¤ºæŠ€å·§"><a class="header-anchor" href="#ç”Ÿæˆé«˜è´¨é‡Goä»£ç çš„æç¤ºæŠ€å·§"></a>ç”Ÿæˆé«˜è´¨é‡Goä»£ç çš„æç¤ºæŠ€å·§</h3><ol><li><p><strong>æ˜ç¡®Goç‰ˆæœ¬å’Œä¾èµ–</strong>ï¼šä¸åŒGoç‰ˆæœ¬ç‰¹æ€§æœ‰å·®å¼‚ï¼Œæ˜ç¡®ç‰ˆæœ¬é¿å…ç”Ÿæˆä¸å…¼å®¹ä»£ç </p></li><li><p><strong>æä¾›é¡¹ç›®ä¸Šä¸‹æ–‡</strong>ï¼šç®€è¦æè¿°é¡¹ç›®æ¶æ„å’Œç›¸å…³æ¨¡å—ï¼Œè®©AIç†è§£ä»£ç ç”Ÿæˆçš„ç¯å¢ƒ</p></li><li><p><strong>æŒ‡å®šä»£ç é£æ ¼å’Œè§„èŒƒ</strong>ï¼š</p><pre><code class="hljs haml">è¯·éµå¾ªä»¥ä¸‹Goä»£ç é£æ ¼:</li></ol><p>-<span class="ruby"> ä½¿ç”¨gofmtæ ‡å‡†æ ¼å¼</span><br><span class="ruby">- é”™è¯¯å¤„ç†ä½¿ç”¨è¿”å›é”™è¯¯è€Œépanic</span><br><span class="ruby">- æ¥å£å‘½åä½¿ç”¨<span class="hljs-string">â€œ-erâ€</span>åç¼€</span><br><span class="ruby">- éµå¾ªæ ‡å‡†åº“å‘½åçº¦å®š</span></code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="4"><li><strong>è¿­ä»£å¼å¼€å‘</strong>ï¼šå…ˆè®©AIç”Ÿæˆæ¡†æ¶ï¼Œæ£€æŸ¥åå†é€æ­¥å®Œå–„<pre><code class="hljs angelscript"><span class="hljs-number">1.</span> å…ˆè¯·ä½ ç”Ÿæˆæ•´ä½“ç»“æ„å’Œæ¥å£</li></ol><p><span class="hljs-number">2.</span> æˆ‘æ£€æŸ¥ç¡®è®¤åï¼Œå†è¯·ä½ å®ç°å…·ä½“æ–¹æ³•</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="5"><li><strong>ç¤ºä¾‹é©±åŠ¨å¼€å‘</strong>ï¼šæä¾›å…·ä½“ä½¿ç”¨åœºæ™¯å’Œç¤ºä¾‹<pre><code class="hljs yaml"><span class="hljs-string">æˆ‘éœ€è¦è§£æä»¥ä¸‹æ ¼å¼çš„é…ç½®æ–‡ä»¶:</span></li></ol><p><span class="hljs-string">```yaml</span><br><span class="hljs-attr">database:</span><br><span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br><span class="hljs-attr">port:</span> <span class="hljs-number">5432</span></code></pre>:hexoPostRenderEscapeâ€“&gt;<br>è¯·ç”ŸæˆGoç»“æ„ä½“å’Œè§£æä»£ç </p>   <pre><code class="hljs clean">## ğŸ“ å¸¸è§Goä»£ç ç”Ÿæˆåœºæ™¯ä¸æ¨¡æ¿### <span class="hljs-number">1.</span> CRUD APIç”Ÿæˆè¿™æ˜¯æœ€å¸¸è§çš„åœºæ™¯ä¹‹ä¸€ï¼Œä¸‹é¢æ˜¯æˆ‘å¸¸ç”¨çš„æ¨¡æ¿ï¼š</code></pre><p>è¯·ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„Go RESTful APIå®ç°ï¼Œç”¨äº[èµ„æºç±»å‹]çš„CRUDæ“ä½œã€‚</p><p>æŠ€æœ¯æ ˆï¼š</p><ul><li>Go 1.20</li><li>Ginæ¡†æ¶</li><li>GORM</li><li>PostgreSQL</li></ul><p>æ•°æ®æ¨¡å‹:</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> [æ¨¡å‹åç§°] <span class="hljs-keyword">struct</span> &#123;    ID        <span class="hljs-keyword">uint</span>      <span class="hljs-string">`json:&quot;id&quot; gorm:&quot;primaryKey&quot;`</span>    <span class="hljs-comment">// å…¶ä»–å­—æ®µ...</span>    CreatedAt time.Time <span class="hljs-string">`json:&quot;created_at&quot;`</span>    UpdatedAt time.Time <span class="hljs-string">`json:&quot;updated_at&quot;`</span>&#125;</code></pre><p>éœ€è¦å®ç°çš„APIç«¯ç‚¹:</p><ul><li>GET /api/[èµ„æºå¤æ•°å½¢å¼] - åˆ—å‡ºæ‰€æœ‰èµ„æº</li><li>GET /api/[èµ„æºå¤æ•°å½¢å¼]/:id - è·å–å•ä¸ªèµ„æº</li><li>POST /api/[èµ„æºå¤æ•°å½¢å¼] - åˆ›å»ºèµ„æº</li><li>PUT /api/[èµ„æºå¤æ•°å½¢å¼]/:id - æ›´æ–°èµ„æº</li><li>DELETE /api/[èµ„æºå¤æ•°å½¢å¼]/:id - åˆ é™¤èµ„æº</li></ul><p>é¢å¤–è¦æ±‚:</p><ul><li>å®ç°åŸºæœ¬çš„æ•°æ®éªŒè¯</li><li>è¿”å›æ ‡å‡†åŒ–çš„JSONå“åº”</li><li>å®ç°åŸºæœ¬çš„é”™è¯¯å¤„ç†</li></ul><pre><code class="hljs clean">### <span class="hljs-number">2.</span> å¹¶å‘ä»»åŠ¡å¤„ç†Goçš„ä¼˜åŠ¿ä¹‹ä¸€æ˜¯å¹¶å‘å¤„ç†ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå·¥ä½œæ± å®ç°çš„æç¤ºï¼š</code></pre><p>è¯·å®ç°ä¸€ä¸ªGoè¯­è¨€çš„å¹¶å‘å·¥ä½œæ± ï¼Œè¦æ±‚:</p><ol><li>åˆ›å»ºå›ºå®šæ•°é‡çš„worker goroutine</li><li>é€šè¿‡channelåˆ†å‘ä»»åŠ¡</li><li>æ”¯æŒä¼˜é›…å…³é—­</li><li>æ”¯æŒä»»åŠ¡ç»“æœæ”¶é›†</li><li>å®ç°ä»»åŠ¡è¶…æ—¶å¤„ç†</li></ol><p>æŠ€æœ¯çº¦æŸ:</p><ul><li>åªä½¿ç”¨æ ‡å‡†åº“</li><li>Go 1.18+ï¼Œå¯ä½¿ç”¨æ³›å‹</li><li>çº¿ç¨‹å®‰å…¨</li></ul><pre><code class="hljs clean">### <span class="hljs-number">3.</span> gRPCæœåŠ¡ç”ŸæˆåŸºäºprotobufå®šä¹‰ç”ŸæˆgRPCæœåŠ¡ï¼š</code></pre><p>æˆ‘æœ‰ä»¥ä¸‹protoæ–‡ä»¶å®šä¹‰:</p><pre><code class="hljs proto">syntax &#x3D; &quot;proto3&quot;;package user;option go_package &#x3D; &quot;github.com&#x2F;myorg&#x2F;myapp&#x2F;user&quot;;service UserService &#123;  rpc GetUser(GetUserRequest) returns (User) &#123;&#125;  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse) &#123;&#125;  rpc CreateUser(CreateUserRequest) returns (User) &#123;&#125;  rpc UpdateUser(UpdateUserRequest) returns (User) &#123;&#125;  rpc DeleteUser(DeleteUserRequest) returns (DeleteUserResponse) &#123;&#125;&#125;message User &#123;  string id &#x3D; 1;  string name &#x3D; 2;  string email &#x3D; 3;&#125;&#x2F;&#x2F; å…¶ä»–è¯·æ±‚&#x2F;å“åº”æ¶ˆæ¯å®šä¹‰...</code></pre><p>è¯·ç”Ÿæˆ:</p><ol><li>ä¸€ä¸ªå®ç°äº†è¿™ä¸ªæœåŠ¡æ¥å£çš„Goç»“æ„ä½“</li><li>å°†ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨PostgreSQLæ•°æ®åº“ä¸­</li><li>åŒ…å«åŸºæœ¬çš„è¾“å…¥éªŒè¯</li><li>ä½¿ç”¨grpcä¸­é—´ä»¶è¿›è¡Œæ—¥å¿—è®°å½•å’Œæ¢å¤</li></ol><pre><code class="hljs clean">## ğŸš€ å®æˆ˜æ¡ˆä¾‹ï¼šåŸºäºAIç”Ÿæˆçš„æ—¥å¿—åº“ä¸‹é¢æ˜¯æˆ‘ä½¿ç”¨AIè¾…åŠ©å¼€å‘çš„ä¸€ä¸ªç®€æ´æ—¥å¿—åº“çš„å®ç°è¿‡ç¨‹ï¼š### æ­¥éª¤<span class="hljs-number">1</span>: æå‡ºéœ€æ±‚æˆ‘å‘AIæå‡ºäº†ä»¥ä¸‹éœ€æ±‚ï¼š</code></pre><p>æˆ‘éœ€è¦ä¸€ä¸ªè½»é‡çº§çš„Goæ—¥å¿—åº“ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§:</p><ol><li>æ”¯æŒä¸åŒæ—¥å¿—çº§åˆ«(debug, info, warn, error)</li><li>æ”¯æŒç»“æ„åŒ–æ—¥å¿—è¾“å‡º(JSONæ ¼å¼)</li><li>æ”¯æŒå­—æ®µæ‰©å±•(å¦‚æ·»åŠ è¯·æ±‚ID)</li><li>å¯é…ç½®è¾“å‡ºç›®æ ‡(æ§åˆ¶å°ã€æ–‡ä»¶)</li><li>æ€§èƒ½ä¼˜å…ˆè€ƒè™‘</li></ol><p>è¯·å…ˆè®¾è®¡æ¥å£ï¼Œç„¶åå®ç°æ ¸å¿ƒåŠŸèƒ½ã€‚</p><pre><code class="hljs reasonml">### æ­¥éª¤<span class="hljs-number">2</span>: è·å–åˆæ­¥è®¾è®¡AIç”Ÿæˆäº†åˆæ­¥çš„æ¥å£è®¾è®¡ï¼š```go<span class="hljs-comment">// logger.go</span>package loggerimport (<span class="hljs-string">&quot;io&quot;</span><span class="hljs-string">&quot;os&quot;</span>)<span class="hljs-comment">// Level è¡¨ç¤ºæ—¥å¿—çº§åˆ«</span><span class="hljs-keyword">type</span> Level <span class="hljs-built_in">int</span>const (DebugLevel Level = iotaInfoLevelWarnLevelErrorLevel)<span class="hljs-comment">// Logger æä¾›ç»“æ„åŒ–æ—¥å¿—è®°å½•åŠŸèƒ½</span><span class="hljs-keyword">type</span> Logger interface &#123;<span class="hljs-constructor">Debug(<span class="hljs-params">msg</span> <span class="hljs-params">string</span>, <span class="hljs-params">fields</span> <span class="hljs-operator">...</span>Field)</span><span class="hljs-constructor">Info(<span class="hljs-params">msg</span> <span class="hljs-params">string</span>, <span class="hljs-params">fields</span> <span class="hljs-operator">...</span>Field)</span><span class="hljs-constructor">Warn(<span class="hljs-params">msg</span> <span class="hljs-params">string</span>, <span class="hljs-params">fields</span> <span class="hljs-operator">...</span>Field)</span><span class="hljs-constructor">Error(<span class="hljs-params">msg</span> <span class="hljs-params">string</span>, <span class="hljs-params">fields</span> <span class="hljs-operator">...</span>Field)</span><span class="hljs-constructor">With(<span class="hljs-params">fields</span> <span class="hljs-operator">...</span>Field)</span> Logger&#125;<span class="hljs-comment">// Field è¡¨ç¤ºæ—¥å¿—ä¸­çš„é”®å€¼å¯¹</span><span class="hljs-keyword">type</span> Field <span class="hljs-keyword">struct</span> &#123;Key   <span class="hljs-built_in">string</span>Value interface&#123;&#125;&#125;<span class="hljs-comment">// Config é…ç½®æ—¥å¿—è®°å½•å™¨</span><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;Level      LevelOutput     io.WriterJSONFormat <span class="hljs-built_in">bool</span>TimeFormat <span class="hljs-built_in">string</span>&#125;<span class="hljs-comment">// New åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—è®°å½•å™¨</span>func <span class="hljs-constructor">New(<span class="hljs-params">config</span> Config)</span> Logger &#123;<span class="hljs-comment">// é»˜è®¤é…ç½®</span><span class="hljs-keyword">if</span> config.Output<span class="hljs-operator"> == </span>nil &#123;config.Output = os.Stdout&#125;<span class="hljs-keyword">if</span> config.TimeFormat<span class="hljs-operator"> == </span><span class="hljs-string">&quot;&quot;</span> &#123;config.TimeFormat = <span class="hljs-string">&quot;2006-01-02T15:04:05.000Z07:00&quot;</span>&#125;return &amp;logger&#123;level:      config.Level,output:     config.Output,jsonFormat: config.JSONFormat,timeFormat: config.TimeFormat,&#125;&#125;<span class="hljs-comment">// å®ç°ç•¥...</span></code></pre><h3 id="æ­¥éª¤3-è¿­ä»£å®Œå–„å®ç°"><a class="header-anchor" href="#æ­¥éª¤3-è¿­ä»£å®Œå–„å®ç°"></a>æ­¥éª¤3: è¿­ä»£å®Œå–„å®ç°</h3><p>æˆ‘è¦æ±‚AIå®Œå–„å®ç°ç»†èŠ‚ï¼Œç‰¹åˆ«æ˜¯JSONæ ¼å¼åŒ–è¾“å‡ºï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æ—¥å¿—è®°å½•å™¨å®ç°</span><span class="hljs-keyword">type</span> logger <span class="hljs-keyword">struct</span> &#123;level      Leveloutput     io.WriterjsonFormat <span class="hljs-keyword">bool</span>timeFormat <span class="hljs-keyword">string</span>fields     []Fieldmu         sync.Mutex&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *logger)</span> <span class="hljs-title">Debug</span><span class="hljs-params">(msg <span class="hljs-keyword">string</span>, fields ...Field)</span></span> &#123;<span class="hljs-keyword">if</span> l.level &lt;= DebugLevel &#123;l.log(DebugLevel, msg, fields...)&#125;&#125;<span class="hljs-comment">// å…¶ä»–çº§åˆ«æ–¹æ³•ç±»ä¼¼...</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *logger)</span> <span class="hljs-title">With</span><span class="hljs-params">(fields ...Field)</span> <span class="hljs-title">Logger</span></span> &#123;newLogger := &amp;logger&#123;level:      l.level,output:     l.output,jsonFormat: l.jsonFormat,timeFormat: l.timeFormat,fields:     <span class="hljs-built_in">make</span>([]Field, <span class="hljs-built_in">len</span>(l.fields)+<span class="hljs-built_in">len</span>(fields)),&#125;<span class="hljs-comment">// å¤åˆ¶ç°æœ‰å­—æ®µ</span><span class="hljs-built_in">copy</span>(newLogger.fields, l.fields)<span class="hljs-comment">// æ·»åŠ æ–°å­—æ®µ</span><span class="hljs-built_in">copy</span>(newLogger.fields[<span class="hljs-built_in">len</span>(l.fields):], fields)<span class="hljs-keyword">return</span> newLogger&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *logger)</span> <span class="hljs-title">log</span><span class="hljs-params">(level Level, msg <span class="hljs-keyword">string</span>, fields ...Field)</span></span> &#123;l.mu.Lock()<span class="hljs-keyword">defer</span> l.mu.Unlock()now := time.Now()<span class="hljs-keyword">if</span> l.jsonFormat &#123;l.writeJSON(level, now, msg, fields)&#125; <span class="hljs-keyword">else</span> &#123;l.writeText(level, now, msg, fields)&#125;&#125;<span class="hljs-comment">// JSONè¾“å‡ºå®ç°...</span></code></pre><h3 id="æ­¥éª¤4-æ·»åŠ å•å…ƒæµ‹è¯•"><a class="header-anchor" href="#æ­¥éª¤4-æ·»åŠ å•å…ƒæµ‹è¯•"></a>æ­¥éª¤4: æ·»åŠ å•å…ƒæµ‹è¯•</h3><pre><code class="hljs go"><span class="hljs-comment">// logger_test.go</span><span class="hljs-keyword">package</span> logger<span class="hljs-keyword">import</span> (<span class="hljs-string">&quot;bytes&quot;</span><span class="hljs-string">&quot;encoding/json&quot;</span><span class="hljs-string">&quot;strings&quot;</span><span class="hljs-string">&quot;testing&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestLogger_TextFormat</span><span class="hljs-params">(t *testing.T)</span></span> &#123;buf := &amp;bytes.Buffer&#123;&#125;log := New(Config&#123;Level:      DebugLevel,Output:     buf,JSONFormat: <span class="hljs-literal">false</span>,&#125;)log.Info(<span class="hljs-string">&quot;test message&quot;</span>, Field&#123;Key: <span class="hljs-string">&quot;key&quot;</span>, Value: <span class="hljs-string">&quot;value&quot;</span>&#125;)output := buf.String()<span class="hljs-keyword">if</span> !strings.Contains(output, <span class="hljs-string">&quot;INFO&quot;</span>) ||!strings.Contains(output, <span class="hljs-string">&quot;test message&quot;</span>) ||!strings.Contains(output, <span class="hljs-string">&quot;key=value&quot;</span>) &#123;t.Errorf(<span class="hljs-string">&quot;Unexpected log format: %s&quot;</span>, output)&#125;&#125;<span class="hljs-comment">// æ›´å¤šæµ‹è¯•...</span></code></pre><h3 id="æ­¥éª¤5-ä½¿ç”¨ç¤ºä¾‹ä»£ç "><a class="header-anchor" href="#æ­¥éª¤5-ä½¿ç”¨ç¤ºä¾‹ä»£ç "></a>æ­¥éª¤5: ä½¿ç”¨ç¤ºä¾‹ä»£ç </h3><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (<span class="hljs-string">&quot;os&quot;</span><span class="hljs-string">&quot;myapp/logger&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-comment">// åˆ›å»ºJSONæ ¼å¼çš„ç”Ÿäº§ç¯å¢ƒæ—¥å¿—è®°å½•å™¨</span>prodLogger := logger.New(logger.Config&#123;Level:      logger.InfoLevel,Output:     os.Stdout,JSONFormat: <span class="hljs-literal">true</span>,&#125;)<span class="hljs-comment">// ä½¿ç”¨åŸºæœ¬å­—æ®µçš„è®°å½•å™¨</span>appLogger := prodLogger.With(logger.Field&#123;Key: <span class="hljs-string">&quot;service&quot;</span>, Value: <span class="hljs-string">&quot;api&quot;</span>&#125;,logger.Field&#123;Key: <span class="hljs-string">&quot;version&quot;</span>, Value: <span class="hljs-string">&quot;1.0.0&quot;</span>&#125;,)<span class="hljs-comment">// è®°å½•ä¿¡æ¯</span>appLogger.Info(<span class="hljs-string">&quot;Server starting&quot;</span>, logger.Field&#123;Key: <span class="hljs-string">&quot;port&quot;</span>, Value: <span class="hljs-number">8080</span>&#125;)<span class="hljs-comment">// è¯·æ±‚çº§åˆ«çš„è®°å½•å™¨</span>reqLogger := appLogger.With(logger.Field&#123;Key: <span class="hljs-string">&quot;request_id&quot;</span>, Value: <span class="hljs-string">&quot;req-123&quot;</span>&#125;)<span class="hljs-comment">// è®°å½•é”™è¯¯</span>err := someFunction()<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;reqLogger.Error(<span class="hljs-string">&quot;Failed to process request&quot;</span>, logger.Field&#123;Key: <span class="hljs-string">&quot;error&quot;</span>, Value: err.Error()&#125;)&#125;&#125;</code></pre><h2 id="ğŸ”„-è°ƒæ•´ä¸ä¼˜åŒ–AIç”Ÿæˆä»£ç "><a class="header-anchor" href="#ğŸ”„-è°ƒæ•´ä¸ä¼˜åŒ–AIç”Ÿæˆä»£ç "></a>ğŸ”„ è°ƒæ•´ä¸ä¼˜åŒ–AIç”Ÿæˆä»£ç </h2><p>AIç”Ÿæˆçš„ä»£ç é€šå¸¸éœ€è¦ä¸€äº›è°ƒæ•´æ‰èƒ½æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼š</p><h3 id="å¸¸è§é—®é¢˜åŠä¿®å¤æŠ€å·§"><a class="header-anchor" href="#å¸¸è§é—®é¢˜åŠä¿®å¤æŠ€å·§"></a>å¸¸è§é—®é¢˜åŠä¿®å¤æŠ€å·§</h3><ol><li><strong>å¯¼å…¥ç®¡ç†</strong>ï¼šAIå¯èƒ½ä¼šå¯¼å…¥ä¸å¿…è¦æˆ–ä¸å­˜åœ¨çš„åŒ…<pre><code class="hljs go"><span class="hljs-comment">// AIç”Ÿæˆçš„</span></li></ol><p><span class="hljs-keyword">import</span> (<br><span class="hljs-string">â€œ<a href="http://github.com/nonexistent/pkg">github.com/nonexistent/pkg</a>â€</span><br><span class="hljs-string">â€œunused/packageâ€</span><br>)</p><p><span class="hljs-comment">// ä¿®å¤å</span><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">â€œcontextâ€</span><br><span class="hljs-string">â€œencoding/jsonâ€</span><br>)</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="2"><li><strong>é”™è¯¯å¤„ç†ä¿®æ­£</strong>ï¼šAIæœ‰æ—¶ä¼šé—æ¼é”™è¯¯å¤„ç†<pre><code class="hljs go"><span class="hljs-comment">// AIç”Ÿæˆçš„</span></li></ol><p>file, _ := os.Open(filename) <span class="hljs-comment">// é”™è¯¯è¢«å¿½ç•¥</span></p><p><span class="hljs-comment">// ä¿®å¤å</span><br>file, err := os.Open(filename)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">â€œfailed to open file: %wâ€</span>, err)<br>&#125;</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="3"><li><strong>èµ„æºé‡Šæ”¾</strong>ï¼šæ£€æŸ¥å¹¶æ·»åŠ deferè¯­å¥<pre><code class="hljs go"><span class="hljs-comment">// AIç”Ÿæˆçš„</span></li></ol><p>conn, err := db.Connect()<br><span class="hljs-comment">// ç¼ºå°‘èµ„æºé‡Šæ”¾</span></p><p><span class="hljs-comment">// ä¿®å¤å</span><br>conn, err := db.Connect()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><span class="hljs-keyword">defer</span> conn.Close()</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="4"><li><strong>ä¸Šä¸‹æ–‡ä¼ é€’</strong>ï¼šç¡®ä¿æ­£ç¡®ä¼ é€’context<pre><code class="hljs go"><span class="hljs-comment">// AIç”Ÿæˆçš„</span></li></ol><p><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handleRequest</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>data, err := fetchData() <span class="hljs-comment">// æ²¡æœ‰ä¼ é€’è¯·æ±‚ä¸Šä¸‹æ–‡</span><br>&#125;</p><p><span class="hljs-comment">// ä¿®å›ºå</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handleRequest</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>ctx := r.Context()<br>data, err := fetchData(ctx)<br>&#125;</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><h3 id="ä»£ç æ€§èƒ½ä¼˜åŒ–"><a class="header-anchor" href="#ä»£ç æ€§èƒ½ä¼˜åŒ–"></a>ä»£ç æ€§èƒ½ä¼˜åŒ–</h3><p>AIç”Ÿæˆçš„ä»£ç å¯èƒ½ä¸æ˜¯æœ€ä¼˜çš„ï¼Œå¸¸è§çš„æ€§èƒ½ä¼˜åŒ–åŒ…æ‹¬ï¼š</p><ol><li><strong>é¢„åˆ†é…å†…å­˜</strong>ï¼šå°¤å…¶æ˜¯å¤„ç†åˆ‡ç‰‡æ—¶<pre><code class="hljs go"><span class="hljs-comment">// AIç”Ÿæˆçš„</span></li></ol><p><span class="hljs-keyword">var</span> result []<span class="hljs-keyword">string</span><br><span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;<br>result = <span class="hljs-built_in">append</span>(result, process(item)) <span class="hljs-comment">// å¯èƒ½å¤šæ¬¡é‡æ–°åˆ†é…</span><br>&#125;</p><p><span class="hljs-comment">// ä¼˜åŒ–å</span><br>result := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">string</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(items)) <span class="hljs-comment">// é¢„åˆ†é…</span><br><span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;<br>result = <span class="hljs-built_in">append</span>(result, process(item))<br>&#125;</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="2"><li><strong>å‡å°‘å†…å­˜åˆ†é…</strong>ï¼šä½¿ç”¨å¯¹è±¡æ± <pre><code class="hljs go"><span class="hljs-comment">// ä¼˜åŒ–åæ·»åŠ å¯¹è±¡æ± </span></li></ol><p><span class="hljs-keyword">var</span> bufferPool = sync.Pool&#123;<br>New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(bytes.Buffer)<br>&#125;,<br>&#125;</p><p><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processData</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">string</span></span> &#123;<br>buf := bufferPool.Get().(*bytes.Buffer)<br>buf.Reset()<br><span class="hljs-keyword">defer</span> bufferPool.Put(buf)</p><pre><code>&lt;span class=&quot;hljs-comment&quot;&gt;// ä½¿ç”¨bufå¤„ç†æ•°æ®...&lt;/span&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; buf.String()</code></pre><p>}</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="3"><li><strong>é¿å…ä¸å¿…è¦çš„JSONåºåˆ—åŒ–</strong>ï¼š<pre><code class="hljs go"><span class="hljs-comment">// AIç”Ÿæˆçš„</span></li></ol><p>data, _ := json.Marshal(obj)<br>log.Println(<span class="hljs-keyword">string</span>(data)) <span class="hljs-comment">// æ¯æ¬¡è®°å½•éƒ½åºåˆ—åŒ–</span></p><p><span class="hljs-comment">// ä¼˜åŒ–å</span><br><span class="hljs-keyword">if</span> log.IsDebugEnabled() &#123;<br>data, _ := json.Marshal(obj)<br>log.Debugf(<span class="hljs-string">â€œ%sâ€</span>, data)<br>&#125;</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><h2 id="ğŸ“ˆ-å·¥ä½œæµé›†æˆä¸æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸ“ˆ-å·¥ä½œæµé›†æˆä¸æœ€ä½³å®è·µ"></a>ğŸ“ˆ å·¥ä½œæµé›†æˆä¸æœ€ä½³å®è·µ</h2><h3 id="é›†æˆåˆ°å¼€å‘æµç¨‹"><a class="header-anchor" href="#é›†æˆåˆ°å¼€å‘æµç¨‹"></a>é›†æˆåˆ°å¼€å‘æµç¨‹</h3><p>æˆ‘çš„AIè¾…åŠ©Goå¼€å‘å·¥ä½œæµï¼š</p><ol><li><strong>éœ€æ±‚åˆ†æ</strong>ï¼šæ˜ç¡®åŠŸèƒ½éœ€æ±‚å’ŒæŠ€æœ¯çº¦æŸ</li><li><strong>æ¥å£è®¾è®¡</strong>ï¼šä½¿ç”¨AIç”Ÿæˆæ¥å£å®šä¹‰</li><li><strong>å®ç°å¼€å‘</strong>ï¼š<ul><li>å…ˆç”Ÿæˆéª¨æ¶ä»£ç </li><li>æ£€æŸ¥å¹¶è°ƒæ•´å…³é”®é€»è¾‘</li><li>å¢é‡å¼å®Œå–„å®ç°</li></ul></li><li><strong>æµ‹è¯•ç”¨ä¾‹</strong>ï¼šä½¿ç”¨AIç”Ÿæˆå•å…ƒæµ‹è¯•</li><li><strong>ä»£ç å®¡æŸ¥</strong>ï¼šè®©AIå®¡æŸ¥ä»£ç å¹¶æå‡ºä¼˜åŒ–å»ºè®®</li><li><strong>æ–‡æ¡£ç”Ÿæˆ</strong>ï¼šä½¿ç”¨AIç”Ÿæˆgodocé£æ ¼æ–‡æ¡£</li></ol><h3 id="CI-CDä¸è‡ªåŠ¨åŒ–æµ‹è¯•"><a class="header-anchor" href="#CI-CDä¸è‡ªåŠ¨åŒ–æµ‹è¯•"></a>CI/CDä¸è‡ªåŠ¨åŒ–æµ‹è¯•</h3><p>å°†AIç”Ÿæˆçš„ä»£ç çº³å…¥ç°æœ‰CI/CDæµç¨‹ï¼š</p><pre><code class="hljs yaml"><span class="hljs-comment"># .github/workflows/go.yml</span><span class="hljs-attr">name:</span> <span class="hljs-string">Go</span><span class="hljs-attr">on:</span>  <span class="hljs-attr">push:</span>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]  <span class="hljs-attr">pull_request:</span>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]<span class="hljs-attr">jobs:</span>  <span class="hljs-attr">build:</span>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>    <span class="hljs-attr">steps:</span>    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Go</span>      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-go@v4</span>      <span class="hljs-attr">with:</span>        <span class="hljs-attr">go-version:</span> <span class="hljs-string">&#x27;1.21&#x27;</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Lint</span>      <span class="hljs-attr">uses:</span> <span class="hljs-string">golangci/golangci-lint-action@v3</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Test</span>      <span class="hljs-attr">run:</span> <span class="hljs-string">go</span> <span class="hljs-string">test</span> <span class="hljs-string">-v</span> <span class="hljs-string">./...</span></code></pre><h3 id="å›¢é˜Ÿåä½œæœ€ä½³å®è·µ"><a class="header-anchor" href="#å›¢é˜Ÿåä½œæœ€ä½³å®è·µ"></a>å›¢é˜Ÿåä½œæœ€ä½³å®è·µ</h3><p>åœ¨å›¢é˜Ÿä¸­ä½¿ç”¨AIè¾…åŠ©ä»£ç ç”Ÿæˆçš„å»ºè®®ï¼š</p><ol><li><strong>æ˜ç¡®æ³¨é‡ŠAIç”Ÿæˆçš„ä»£ç </strong>ï¼šå¸®åŠ©å›¢é˜Ÿæˆå‘˜åŒºåˆ†</li><li><strong>è®¾å®šä»£ç å®¡æŸ¥æ ‡å‡†</strong>ï¼šAIç”Ÿæˆä»£ç éœ€è¦é¢å¤–å®¡æŸ¥</li><li><strong>å…±äº«æœ‰æ•ˆæç¤º</strong>ï¼šå»ºç«‹å›¢é˜Ÿå†…éƒ¨çš„æç¤ºåº“</li><li><strong>æŒç»­å­¦ä¹ </strong>ï¼šåˆ†äº«AIä½¿ç”¨ç»éªŒå’ŒæŠ€å·§</li></ol><h2 id="ğŸ”®-æœªæ¥å±•æœ›"><a class="header-anchor" href="#ğŸ”®-æœªæ¥å±•æœ›"></a>ğŸ”® æœªæ¥å±•æœ›</h2><p>AIè¾…åŠ©Goå¼€å‘è¿˜å¤„äºå¿«é€Ÿå‘å±•é˜¶æ®µï¼Œæˆ‘çœ‹åˆ°çš„å‘å±•è¶‹åŠ¿åŒ…æ‹¬ï¼š</p><ol><li><strong>æ›´æ·±å…¥çš„ä»£ç ç†è§£</strong>ï¼šæœªæ¥çš„AIå°†æ›´å¥½ç†è§£ç°æœ‰ä»£ç åº“å’Œæ¶æ„</li><li><strong>æ›´ç²¾å‡†çš„ä»£ç ç”Ÿæˆ</strong>ï¼šèƒ½å¤Ÿä¸¥æ ¼éµå¾ªé¡¹ç›®è§„èŒƒå’Œæ€§èƒ½è¦æ±‚</li><li><strong>ç«¯åˆ°ç«¯è§£å†³æ–¹æ¡ˆ</strong>ï¼šä»éœ€æ±‚åˆ°æµ‹è¯•çš„å®Œæ•´å¼€å‘æµç¨‹</li><li><strong>è‡ªé€‚åº”å­¦ä¹ </strong>ï¼šåŸºäºå›¢é˜Ÿä»£ç é£æ ¼è‡ªåŠ¨è°ƒæ•´ç”Ÿæˆç­–ç•¥</li></ol><h2 id="ğŸ’¡-æ€»ç»“"><a class="header-anchor" href="#ğŸ’¡-æ€»ç»“"></a>ğŸ’¡ æ€»ç»“</h2><p>AIè¾…åŠ©Goä»£ç ç”Ÿæˆå·²ç»æˆä¸ºæå‡å¼€å‘æ•ˆç‡çš„é‡è¦å·¥å…·ï¼Œä½†æ­£ç¡®ä½¿ç”¨éœ€è¦æŒæ¡ä¸€å®šæŠ€å·§ã€‚æä¾›æ¸…æ™°çš„ä¸Šä¸‹æ–‡å’Œéœ€æ±‚æè¿°ï¼Œéµå¾ªè‰¯å¥½çš„æç¤ºå·¥ç¨‹å®è·µï¼Œå¹¶å¯¹ç”Ÿæˆçš„ä»£ç è¿›è¡Œé€‚å½“è°ƒæ•´å’Œä¼˜åŒ–æ˜¯è·å¾—æœ€ä½³ç»“æœçš„å…³é”®ã€‚</p><p>ä½œä¸ºGoå¼€å‘è€…ï¼Œæˆ‘ä»¬åº”å½“å°†AIè§†ä¸ºå¼ºå¤§çš„åŠ©æ‰‹è€Œéæ›¿ä»£å“ï¼Œåˆç†åˆ©ç”¨å®ƒçš„ä¼˜åŠ¿æ¥å¤„ç†é‡å¤æ€§å·¥ä½œï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿä¸“æ³¨äºæ›´å…·åˆ›é€ æ€§å’Œä»·å€¼çš„å¼€å‘ä»»åŠ¡ã€‚</p><p>ä½ æœ‰ä»€ä¹ˆAIè¾…åŠ©Goå¼€å‘çš„ç»éªŒæˆ–æŠ€å·§ï¼Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«è®¨è®ºï¼</p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>Go</tag>
      
      <tag>ä»£ç ç”Ÿæˆ</tag>
      
      <tag>LLM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ğŸ§© Goæ³›å‹é«˜çº§åº”ç”¨æŠ€å·§ä¸å®æˆ˜æ¡ˆä¾‹</title>
    <link href="/2024/10/20/Go%E6%B3%9B%E5%9E%8B%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8%E6%8A%80%E5%B7%A7%E4%B8%8E%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/"/>
    <url>/2024/10/20/Go%E6%B3%9B%E5%9E%8B%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8%E6%8A%80%E5%B7%A7%E4%B8%8E%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/</url>
    
    <content type="html"><![CDATA[<h1>ğŸ§© Goæ³›å‹é«˜çº§åº”ç”¨æŠ€å·§ä¸å®æˆ˜æ¡ˆä¾‹</h1><p>Go 1.18ç‰ˆæœ¬å¼•å…¥çš„æ³›å‹ç‰¹æ€§å·²ç»å‘å¸ƒä¸¤å¹´å¤šäº†ï¼Œç°åœ¨æ­£æ˜¯æ·±å…¥æ¢ç´¢å…¶é«˜çº§åº”ç”¨çš„å¥½æ—¶æœºã€‚æœ¬æ–‡å°†åˆ†äº«æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨Goæ³›å‹çš„ä¸€äº›æŠ€å·§å’Œç»éªŒï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¯å‘ã€‚</p><h2 id="âš¡-ä¸ºä»€ä¹ˆè¦ç”¨æ³›å‹ï¼Ÿ"><a class="header-anchor" href="#âš¡-ä¸ºä»€ä¹ˆè¦ç”¨æ³›å‹ï¼Ÿ"></a>âš¡ ä¸ºä»€ä¹ˆè¦ç”¨æ³›å‹ï¼Ÿ</h2><p>åœ¨æ³›å‹å‡ºç°ä¹‹å‰ï¼Œæˆ‘ä»¬è¦ä¹ˆç¼–å†™ç‰¹å®šç±»å‹çš„å‡½æ•°/ç»“æ„ä½“ï¼Œè¦ä¹ˆä½¿ç”¨<code>interface&#123;&#125;</code>(ç©ºæ¥å£)æ¥å¤„ç†å¤šç§ç±»å‹ï¼Œå‰è€…å¯¼è‡´å¤§é‡é‡å¤ä»£ç ï¼Œåè€…åˆ™ä¸¢å¤±äº†ç±»å‹å®‰å…¨æ€§å’Œç¼–è¯‘æœŸæ£€æŸ¥ã€‚</p><p>çœ‹ä¸ªç®€å•å¯¹æ¯”ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æ³›å‹ä¹‹å‰ï¼šä¸ºæ¯ç§ç±»å‹å†™ä¸€ä¸ªå‡½æ•°</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SumInt</span><span class="hljs-params">(nums []<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">var</span> sum <span class="hljs-keyword">int</span>    <span class="hljs-keyword">for</span> _, n := <span class="hljs-keyword">range</span> nums &#123;        sum += n    &#125;    <span class="hljs-keyword">return</span> sum&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SumFloat64</span><span class="hljs-params">(nums []<span class="hljs-keyword">float64</span>)</span> <span class="hljs-title">float64</span></span> &#123;    <span class="hljs-keyword">var</span> sum <span class="hljs-keyword">float64</span>    <span class="hljs-keyword">for</span> _, n := <span class="hljs-keyword">range</span> nums &#123;        sum += n    &#125;    <span class="hljs-keyword">return</span> sum&#125;<span class="hljs-comment">// æ³›å‹ä¹‹åï¼šä¸€ä¸ªå‡½æ•°å¤„ç†å¤šç§ç±»å‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Sum</span>[<span class="hljs-title">T</span> <span class="hljs-title">constraints</span>.<span class="hljs-title">Ordered</span>]<span class="hljs-params">(nums []T)</span> <span class="hljs-title">T</span></span> &#123;    <span class="hljs-keyword">var</span> sum T    <span class="hljs-keyword">for</span> _, n := <span class="hljs-keyword">range</span> nums &#123;        sum += n    &#125;    <span class="hljs-keyword">return</span> sum&#125;</code></pre><p>æœ‰äº†æ³›å‹ï¼Œæˆ‘å¯ä»¥å†™æ›´å°‘çš„ä»£ç ï¼ŒåŒæ—¶ä¿æŒç±»å‹å®‰å…¨æ€§ï¼Œè®©ç¼–è¯‘å™¨å¸®æˆ‘ä»¬æ•è·ç±»å‹é”™è¯¯ã€‚</p><h2 id="ğŸ› ï¸-å¸¸ç”¨æ³›å‹çº¦æŸæŠ€å·§"><a class="header-anchor" href="#ğŸ› ï¸-å¸¸ç”¨æ³›å‹çº¦æŸæŠ€å·§"></a>ğŸ› ï¸ å¸¸ç”¨æ³›å‹çº¦æŸæŠ€å·§</h2><p>æ³›å‹çº¦æŸå†³å®šäº†ç±»å‹å‚æ•°å¯ä»¥æ¥å—å“ªäº›å…·ä½“ç±»å‹ï¼Œä¸‹é¢æ˜¯ä¸€äº›å®ç”¨æŠ€å·§ï¼š</p><h3 id="1-å¤šç±»å‹çº¦æŸ"><a class="header-anchor" href="#1-å¤šç±»å‹çº¦æŸ"></a>1. å¤šç±»å‹çº¦æŸ</h3><pre><code class="hljs go"><span class="hljs-comment">// åŒæ—¶æ”¯æŒæ•´æ•°å’Œæµ®ç‚¹æ•°</span><span class="hljs-keyword">type</span> Number <span class="hljs-keyword">interface</span> &#123;    ~<span class="hljs-keyword">int</span> | ~<span class="hljs-keyword">int8</span> | ~<span class="hljs-keyword">int16</span> | ~<span class="hljs-keyword">int32</span> | ~<span class="hljs-keyword">int64</span> |    ~<span class="hljs-keyword">uint</span> | ~<span class="hljs-keyword">uint8</span> | ~<span class="hljs-keyword">uint16</span> | ~<span class="hljs-keyword">uint32</span> | ~<span class="hljs-keyword">uint64</span> |    ~<span class="hljs-keyword">float32</span> | ~<span class="hljs-keyword">float64</span>&#125;<span class="hljs-comment">// ä½¿ç”¨</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Max</span>[<span class="hljs-title">T</span> <span class="hljs-title">Number</span>]<span class="hljs-params">(a, b T)</span> <span class="hljs-title">T</span></span> &#123;    <span class="hljs-keyword">if</span> a &gt; b &#123;        <span class="hljs-keyword">return</span> a    &#125;    <span class="hljs-keyword">return</span> b&#125;</code></pre><h3 id="2-ç»“æ„åŒ–çº¦æŸ"><a class="header-anchor" href="#2-ç»“æ„åŒ–çº¦æŸ"></a>2. ç»“æ„åŒ–çº¦æŸ</h3><p>å½“ä½ éœ€è¦çº¦æŸç±»å‹å…·æœ‰ç‰¹å®šæ–¹æ³•æˆ–å­—æ®µæ—¶ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Storer <span class="hljs-keyword">interface</span> &#123;    Store() error    Load() error&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Process</span>[<span class="hljs-title">T</span> <span class="hljs-title">Storer</span>]<span class="hljs-params">(items []T)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;        <span class="hljs-keyword">if</span> err := item.Store(); err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> err        &#125;    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h3 id="3-ç±»å‹é›†ä¸æ³¢æµªç¬¦å·"><a class="header-anchor" href="#3-ç±»å‹é›†ä¸æ³¢æµªç¬¦å·"></a>3. ç±»å‹é›†ä¸æ³¢æµªç¬¦å·(~)</h3><p>ä½¿ç”¨æ³¢æµªç¬¦å·æ”¯æŒåŸºäºåŸºæœ¬ç±»å‹çš„è‡ªå®šä¹‰ç±»å‹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> MyInt <span class="hljs-keyword">int</span><span class="hljs-comment">// ä¸ä½¿ç”¨~ï¼Œåªæœ‰intç±»å‹å¯ç”¨</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Add1</span>[<span class="hljs-title">T</span> <span class="hljs-title">int</span>]<span class="hljs-params">(a, b T)</span> <span class="hljs-title">T</span></span> &#123;    <span class="hljs-keyword">return</span> a + b&#125;<span class="hljs-comment">// ä½¿ç”¨~ï¼Œè‡ªå®šä¹‰ç±»å‹MyIntä¹Ÿå¯ç”¨</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Add2</span>[<span class="hljs-title">T</span> ~<span class="hljs-title">int</span>]<span class="hljs-params">(a, b T)</span> <span class="hljs-title">T</span></span> &#123;    <span class="hljs-keyword">return</span> a + b&#125;</code></pre><h2 id="ğŸ“Š-æ³›å‹é«˜çº§åº”ç”¨åœºæ™¯"><a class="header-anchor" href="#ğŸ“Š-æ³›å‹é«˜çº§åº”ç”¨åœºæ™¯"></a>ğŸ“Š æ³›å‹é«˜çº§åº”ç”¨åœºæ™¯</h2><h3 id="1-é€šç”¨æ•°æ®ç»“æ„"><a class="header-anchor" href="#1-é€šç”¨æ•°æ®ç»“æ„"></a>1. é€šç”¨æ•°æ®ç»“æ„</h3><p>æœ€å¸¸è§çš„æ³›å‹åº”ç”¨å°±æ˜¯å®ç°é€šç”¨æ•°æ®ç»“æ„ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// é€šç”¨Stackå®ç°</span><span class="hljs-keyword">type</span> Stack[T any] <span class="hljs-keyword">struct</span> &#123;    elements []T&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewStack</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">()</span> *<span class="hljs-title">Stack</span>[<span class="hljs-title">T</span>]</span> &#123;    <span class="hljs-keyword">return</span> &amp;Stack[T]&#123;elements: <span class="hljs-built_in">make</span>([]T, <span class="hljs-number">0</span>)&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Stack[T])</span> <span class="hljs-title">Push</span><span class="hljs-params">(element T)</span></span> &#123;    s.elements = <span class="hljs-built_in">append</span>(s.elements, element)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Stack[T])</span> <span class="hljs-title">Pop</span><span class="hljs-params">()</span> <span class="hljs-params">(T, <span class="hljs-keyword">bool</span>)</span></span> &#123;    <span class="hljs-keyword">var</span> zero T    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(s.elements) == <span class="hljs-number">0</span> &#123;        <span class="hljs-keyword">return</span> zero, <span class="hljs-literal">false</span>    &#125;        lastIndex := <span class="hljs-built_in">len</span>(s.elements) - <span class="hljs-number">1</span>    element := s.elements[lastIndex]    s.elements = s.elements[:lastIndex]    <span class="hljs-keyword">return</span> element, <span class="hljs-literal">true</span>&#125;<span class="hljs-comment">// ä½¿ç”¨</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// æ•´æ•°æ ˆ</span>    intStack := NewStack[<span class="hljs-keyword">int</span>]()    intStack.Push(<span class="hljs-number">10</span>)    intStack.Push(<span class="hljs-number">20</span>)        <span class="hljs-comment">// å­—ç¬¦ä¸²æ ˆ</span>    stringStack := NewStack[<span class="hljs-keyword">string</span>]()    stringStack.Push(<span class="hljs-string">&quot;hello&quot;</span>)    stringStack.Push(<span class="hljs-string">&quot;world&quot;</span>)&#125;</code></pre><h3 id="2-å‡½æ•°å¼ç¼–ç¨‹"><a class="header-anchor" href="#2-å‡½æ•°å¼ç¼–ç¨‹"></a>2. å‡½æ•°å¼ç¼–ç¨‹</h3><p>æ³›å‹è®©Goçš„å‡½æ•°å¼ç¼–ç¨‹å˜å¾—æ›´åŠ ä¼˜é›…ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// Mapå‡½æ•°ï¼šå°†å‡½æ•°åº”ç”¨äºåˆ‡ç‰‡çš„æ¯ä¸ªå…ƒç´ </span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Map</span>[<span class="hljs-title">T</span>, <span class="hljs-title">U</span> <span class="hljs-title">any</span>]<span class="hljs-params">(slice []T, f <span class="hljs-keyword">func</span>(T)</span> <span class="hljs-title">U</span>) []<span class="hljs-title">U</span></span> &#123;    result := <span class="hljs-built_in">make</span>([]U, <span class="hljs-built_in">len</span>(slice))    <span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> slice &#123;        result[i] = f(v)    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-comment">// Filterå‡½æ•°ï¼šè¿‡æ»¤åˆ‡ç‰‡å…ƒç´ </span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Filter</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">(slice []T, predicate <span class="hljs-keyword">func</span>(T)</span> <span class="hljs-title">bool</span>) []<span class="hljs-title">T</span></span> &#123;    <span class="hljs-keyword">var</span> result []T    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> slice &#123;        <span class="hljs-keyword">if</span> predicate(v) &#123;            result = <span class="hljs-built_in">append</span>(result, v)        &#125;    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-comment">// Reduceå‡½æ•°ï¼šç´¯ç§¯æ“ä½œ</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Reduce</span>[<span class="hljs-title">T</span>, <span class="hljs-title">U</span> <span class="hljs-title">any</span>]<span class="hljs-params">(slice []T, initial U, reducer <span class="hljs-keyword">func</span>(U, T)</span> <span class="hljs-title">U</span>) <span class="hljs-title">U</span></span> &#123;    result := initial    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> slice &#123;        result = reducer(result, v)    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-comment">// å®é™…ä½¿ç”¨</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    nums := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;        <span class="hljs-comment">// Map: æ¯ä¸ªæ•°å­—ä¹˜ä»¥2</span>    doubled := Map(nums, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;        <span class="hljs-keyword">return</span> n * <span class="hljs-number">2</span>    &#125;)    <span class="hljs-comment">// doubled: [2 4 6 8 10]</span>        <span class="hljs-comment">// Filter: åªä¿ç•™å¶æ•°</span>    evens := Filter(nums, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123;        <span class="hljs-keyword">return</span> n%<span class="hljs-number">2</span> == <span class="hljs-number">0</span>    &#125;)    <span class="hljs-comment">// evens: [2 4]</span>        <span class="hljs-comment">// Reduce: æ±‚å’Œ</span>    sum := Reduce(nums, <span class="hljs-number">0</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(acc <span class="hljs-keyword">int</span>, n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;        <span class="hljs-keyword">return</span> acc + n    &#125;)    <span class="hljs-comment">// sum: 15</span>&#125;</code></pre><h3 id="3-æ³›å‹ç»“æœå¤„ç†"><a class="header-anchor" href="#3-æ³›å‹ç»“æœå¤„ç†"></a>3. æ³›å‹ç»“æœå¤„ç†</h3><p>å¤„ç†å¯èƒ½å‡ºé”™çš„æ“ä½œï¼Œç±»ä¼¼Rustçš„Resultç±»å‹ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// å®šä¹‰Resultç±»å‹</span><span class="hljs-keyword">type</span> Result[T any] <span class="hljs-keyword">struct</span> &#123;    Value T    Error error&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewResult</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">(value T, err error)</span> <span class="hljs-title">Result</span>[<span class="hljs-title">T</span>]</span> &#123;    <span class="hljs-keyword">return</span> Result[T]&#123;Value: value, Error: err&#125;&#125;<span class="hljs-comment">// é“¾å¼æ“ä½œ</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r Result[T])</span> <span class="hljs-title">Then</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>(T)</span> <span class="hljs-title">Result</span>[<span class="hljs-title">T</span>]) <span class="hljs-title">Result</span>[<span class="hljs-title">T</span>]</span> &#123;    <span class="hljs-keyword">if</span> r.Error != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> r    &#125;    <span class="hljs-keyword">return</span> f(r.Value)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r Result[T])</span> <span class="hljs-title">Map</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>(T)</span> <span class="hljs-title">T</span>) <span class="hljs-title">Result</span>[<span class="hljs-title">T</span>]</span> &#123;    <span class="hljs-keyword">if</span> r.Error != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> r    &#125;    <span class="hljs-keyword">return</span> Result[T]&#123;Value: f(r.Value), Error: <span class="hljs-literal">nil</span>&#125;&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readFile</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Result</span>[<span class="hljs-title">string</span>]</span> &#123;    data, err := os.ReadFile(path)    <span class="hljs-keyword">return</span> NewResult(<span class="hljs-keyword">string</span>(data), err)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processData</span><span class="hljs-params">(data <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Result</span>[<span class="hljs-title">string</span>]</span> &#123;    <span class="hljs-comment">// å¤„ç†æ•°æ®</span>    <span class="hljs-keyword">return</span> NewResult(strings.ToUpper(data), <span class="hljs-literal">nil</span>)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    result := readFile(<span class="hljs-string">&quot;data.txt&quot;</span>).              Then(processData).              Map(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;                  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Processed: &quot;</span> + s              &#125;)        <span class="hljs-keyword">if</span> result.Error != <span class="hljs-literal">nil</span> &#123;        fmt.Println(<span class="hljs-string">&quot;Error:&quot;</span>, result.Error)    &#125; <span class="hljs-keyword">else</span> &#123;        fmt.Println(result.Value)    &#125;&#125;</code></pre><h2 id="ğŸ”¥-å®æˆ˜æ¡ˆä¾‹ï¼šæ„å»ºé€šç”¨ç¼“å­˜ç³»ç»Ÿ"><a class="header-anchor" href="#ğŸ”¥-å®æˆ˜æ¡ˆä¾‹ï¼šæ„å»ºé€šç”¨ç¼“å­˜ç³»ç»Ÿ"></a>ğŸ”¥ å®æˆ˜æ¡ˆä¾‹ï¼šæ„å»ºé€šç”¨ç¼“å­˜ç³»ç»Ÿ</h2><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨æ³›å‹æ„å»ºçš„å†…å­˜ç¼“å­˜ç³»ç»Ÿï¼Œæ”¯æŒä»»æ„ç±»å‹çš„å€¼å’Œè¿‡æœŸæ—¶é—´ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> cache<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;sync&quot;</span>    <span class="hljs-string">&quot;time&quot;</span>)<span class="hljs-comment">// ç¼“å­˜é¡¹</span><span class="hljs-keyword">type</span> item[T any] <span class="hljs-keyword">struct</span> &#123;    value      T    expiration <span class="hljs-keyword">int64</span>&#125;<span class="hljs-comment">// æ˜¯å¦å·²è¿‡æœŸ</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(i item[T])</span> <span class="hljs-title">isExpired</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span> &#123;    <span class="hljs-keyword">if</span> i.expiration == <span class="hljs-number">0</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>    &#125;    <span class="hljs-keyword">return</span> time.Now().UnixNano() &gt; i.expiration&#125;<span class="hljs-comment">// ç¼“å­˜</span><span class="hljs-keyword">type</span> Cache[K comparable, V any] <span class="hljs-keyword">struct</span> &#123;    items <span class="hljs-keyword">map</span>[K]item[V]    mu    sync.RWMutex&#125;<span class="hljs-comment">// åˆ›å»ºæ–°ç¼“å­˜</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewCache</span>[<span class="hljs-title">K</span> <span class="hljs-title">comparable</span>, <span class="hljs-title">V</span> <span class="hljs-title">any</span>]<span class="hljs-params">()</span> *<span class="hljs-title">Cache</span>[<span class="hljs-title">K</span>, <span class="hljs-title">V</span>]</span> &#123;    cache := &amp;Cache[K, V]&#123;        items: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[K]item[V]),    &#125;        <span class="hljs-comment">// å¯åŠ¨æ¸…ç†è¿‡æœŸé¡¹çš„goroutine</span>    <span class="hljs-keyword">go</span> cache.startGC()        <span class="hljs-keyword">return</span> cache&#125;<span class="hljs-comment">// è®¾ç½®ç¼“å­˜é¡¹ï¼Œå¯é€‰è¿‡æœŸæ—¶é—´</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cache[K, V])</span> <span class="hljs-title">Set</span><span class="hljs-params">(key K, value V, duration time.Duration)</span></span> &#123;    c.mu.Lock()    <span class="hljs-keyword">defer</span> c.mu.Unlock()        <span class="hljs-keyword">var</span> expiration <span class="hljs-keyword">int64</span>    <span class="hljs-keyword">if</span> duration &gt; <span class="hljs-number">0</span> &#123;        expiration = time.Now().Add(duration).UnixNano()    &#125;        c.items[key] = item[V]&#123;        value:      value,        expiration: expiration,    &#125;&#125;<span class="hljs-comment">// è·å–ç¼“å­˜é¡¹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cache[K, V])</span> <span class="hljs-title">Get</span><span class="hljs-params">(key K)</span> <span class="hljs-params">(V, <span class="hljs-keyword">bool</span>)</span></span> &#123;    c.mu.RLock()    <span class="hljs-keyword">defer</span> c.mu.RUnlock()        item, found := c.items[key]    <span class="hljs-keyword">if</span> !found &#123;        <span class="hljs-keyword">var</span> zero V        <span class="hljs-keyword">return</span> zero, <span class="hljs-literal">false</span>    &#125;        <span class="hljs-comment">// å¦‚æœå·²è¿‡æœŸï¼Œè¿”å›æœªæ‰¾åˆ°</span>    <span class="hljs-keyword">if</span> item.isExpired() &#123;        <span class="hljs-keyword">var</span> zero V        <span class="hljs-keyword">return</span> zero, <span class="hljs-literal">false</span>    &#125;        <span class="hljs-keyword">return</span> item.value, <span class="hljs-literal">true</span>&#125;<span class="hljs-comment">// åˆ é™¤ç¼“å­˜é¡¹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cache[K, V])</span> <span class="hljs-title">Delete</span><span class="hljs-params">(key K)</span></span> &#123;    c.mu.Lock()    <span class="hljs-keyword">defer</span> c.mu.Unlock()        <span class="hljs-built_in">delete</span>(c.items, key)&#125;<span class="hljs-comment">// æ¸…ç†è¿‡æœŸé¡¹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cache[K, V])</span> <span class="hljs-title">startGC</span><span class="hljs-params">()</span></span> &#123;    ticker := time.NewTicker(time.Minute)    <span class="hljs-keyword">defer</span> ticker.Stop()        <span class="hljs-keyword">for</span> &#123;        &lt;-ticker.C        c.deleteExpired()    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cache[K, V])</span> <span class="hljs-title">deleteExpired</span><span class="hljs-params">()</span></span> &#123;    c.mu.Lock()    <span class="hljs-keyword">defer</span> c.mu.Unlock()        <span class="hljs-keyword">for</span> key, item := <span class="hljs-keyword">range</span> c.items &#123;        <span class="hljs-keyword">if</span> item.isExpired() &#123;            <span class="hljs-built_in">delete</span>(c.items, key)        &#125;    &#125;&#125;</code></pre><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// å­—ç¬¦ä¸²ç¼“å­˜</span>    strCache := cache.NewCache[<span class="hljs-keyword">string</span>, <span class="hljs-keyword">string</span>]()    strCache.Set(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;Hello World&quot;</span>, time.Minute)        <span class="hljs-keyword">if</span> msg, found := strCache.Get(<span class="hljs-string">&quot;message&quot;</span>); found &#123;        fmt.Println(msg) <span class="hljs-comment">// &quot;Hello World&quot;</span>    &#125;        <span class="hljs-comment">// ç”¨æˆ·å¯¹è±¡ç¼“å­˜</span>    <span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;        ID   <span class="hljs-keyword">int</span>        Name <span class="hljs-keyword">string</span>    &#125;        userCache := cache.NewCache[<span class="hljs-keyword">int</span>, User]()    userCache.Set(<span class="hljs-number">1</span>, User&#123;ID: <span class="hljs-number">1</span>, Name: <span class="hljs-string">&quot;Alice&quot;</span>&#125;, time.Hour)    userCache.Set(<span class="hljs-number">2</span>, User&#123;ID: <span class="hljs-number">2</span>, Name: <span class="hljs-string">&quot;Bob&quot;</span>&#125;, time.Hour*<span class="hljs-number">2</span>)        <span class="hljs-keyword">if</span> user, found := userCache.Get(<span class="hljs-number">1</span>); found &#123;        fmt.Println(user.Name) <span class="hljs-comment">// &quot;Alice&quot;</span>    &#125;&#125;</code></pre><h2 id="ğŸš«-æ³›å‹ä½¿ç”¨æ³¨æ„äº‹é¡¹"><a class="header-anchor" href="#ğŸš«-æ³›å‹ä½¿ç”¨æ³¨æ„äº‹é¡¹"></a>ğŸš« æ³›å‹ä½¿ç”¨æ³¨æ„äº‹é¡¹</h2><p>æ³›å‹è™½å¥½ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›ä½¿ç”¨é™·é˜±ï¼š</p><ol><li><strong>ç¼–è¯‘æ—¶é—´å¢åŠ </strong>ï¼šå¤§é‡ä½¿ç”¨æ³›å‹å¯èƒ½å¯¼è‡´ç¼–è¯‘å˜æ…¢</li><li><strong>è¿è¡Œæ—¶å¼€é”€</strong>ï¼šæŸäº›æƒ…å†µä¸‹æ³›å‹å®ç°å¯èƒ½å¸¦æ¥é¢å¤–çš„å†…å­˜åˆ†é…</li><li><strong>å¯è¯»æ€§é™ä½</strong>ï¼šè¿‡åº¦ä½¿ç”¨æ³›å‹ä¼šä½¿ä»£ç å˜å¾—æ™¦æ¶©éš¾æ‡‚</li><li><strong>è°ƒè¯•å›°éš¾</strong>ï¼šæ³›å‹é”™è¯¯ä¿¡æ¯å¾€å¾€æ¯”è¾ƒå¤æ‚</li></ol><table><thead><tr><th>åœºæ™¯</th><th>é€‚åˆä½¿ç”¨æ³›å‹</th><th>ä¸é€‚åˆä½¿ç”¨æ³›å‹</th></tr></thead><tbody><tr><td>é€šç”¨å®¹å™¨</td><td>âœ…</td><td></td></tr><tr><td>å·¥å…·å‡½æ•°</td><td>âœ…</td><td></td></tr><tr><td>ç®€å•æ•°æ®è½¬æ¢</td><td>âœ…</td><td></td></tr><tr><td>é«˜åº¦ç‰¹åŒ–çš„ä¸šåŠ¡é€»è¾‘</td><td></td><td>âœ…</td></tr><tr><td>åªæœ‰1-2ä¸ªç±»å‹çš„æƒ…å†µ</td><td></td><td>âœ…</td></tr><tr><td>æ€§èƒ½å…³é”®è·¯å¾„</td><td>éœ€æµ‹è¯•</td><td>éœ€æµ‹è¯•</td></tr></tbody></table><h2 id="ğŸ¯-æœ€ä½³å®è·µæ€»ç»“"><a class="header-anchor" href="#ğŸ¯-æœ€ä½³å®è·µæ€»ç»“"></a>ğŸ¯ æœ€ä½³å®è·µæ€»ç»“</h2><ol><li><strong>é€‚åº¦ä½¿ç”¨</strong>ï¼šä¸è¦ä¸ºäº†æ³›å‹è€Œæ³›å‹ï¼Œåªåœ¨æ˜æ˜¾èƒ½å‡å°‘ä»£ç é‡å¤æ—¶ä½¿ç”¨</li><li><strong>ä¿æŒç®€å•</strong>ï¼šé¿å…è¿‡äºå¤æ‚çš„çº¦æŸç±»å‹</li><li><strong>å‘½åçº¦å®š</strong>ï¼šç±»å‹å‚æ•°ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°ï¼ˆå¦‚Tä»£è¡¨ä¸€èˆ¬ç±»å‹ï¼ŒKä»£è¡¨é”®ï¼ŒVä»£è¡¨å€¼ï¼‰</li><li><strong>æ–‡æ¡£åŒ–</strong>ï¼šè¯¦ç»†æ³¨é‡Šè¯´æ˜ç±»å‹å‚æ•°çš„é¢„æœŸç”¨é€”</li><li><strong>ç»¼åˆè€ƒè™‘</strong>ï¼šåœ¨æ€§èƒ½å…³é”®åœºæ™¯ï¼Œæµ‹è¯•æ³›å‹å®ç°ä¸å…·ä½“ç±»å‹å®ç°çš„å·®å¼‚</li></ol><h2 id="ğŸ’¡-ç»“è¯­"><a class="header-anchor" href="#ğŸ’¡-ç»“è¯­"></a>ğŸ’¡ ç»“è¯­</h2><p>Goæ³›å‹å¸¦æ¥äº†æ›´å¼ºå¤§çš„è¡¨è¾¾èƒ½åŠ›å’Œä»£ç å¤ç”¨èƒ½åŠ›ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½é€‚åˆä½¿ç”¨ã€‚æŒæ¡å¥½ä½•æ—¶ä½¿ç”¨ã€å¦‚ä½•ä¼˜é›…ä½¿ç”¨æ˜¯æˆä¸ºGoé«˜çº§ç¨‹åºå‘˜çš„å¿…å¤‡èƒ½åŠ›ã€‚</p><p>æˆ‘ä¸ªäººçš„ç»éªŒæ˜¯ï¼šåœ¨è®¾è®¡åº“å’Œåº•å±‚åŸºç¡€è®¾æ–½æ—¶ï¼Œæ³›å‹éå¸¸æœ‰ä»·å€¼ï¼›ä½†åœ¨æ—¥å¸¸ä¸šåŠ¡é€»è¾‘ä¸­ï¼Œç®€å•ç›´æ¥çš„å…·ä½“ç±»å‹å¾€å¾€æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚å¸Œæœ›æœ¬æ–‡èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°åœ¨å®é™…é¡¹ç›®ä¸­è¿ç”¨æ³›å‹ï¼</p><p>æœ‰ä»€ä¹ˆé—®é¢˜æˆ–æƒ³æ³•ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®º~</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>æ³›å‹</tag>
      
      <tag>é«˜çº§æŠ€å·§</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ„å»ºé«˜æ€§èƒ½Goå¾®æœåŠ¡ç½‘å…³-è®¾è®¡ä¸å®è·µ</title>
    <link href="/2024/09/12/%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BDGo%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3-%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E8%B7%B5/"/>
    <url>/2024/09/12/%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BDGo%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3-%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="æ„å»ºé«˜æ€§èƒ½Goå¾®æœåŠ¡ç½‘å…³ï¼šè®¾è®¡ä¸å®è·µ"><a class="header-anchor" href="#æ„å»ºé«˜æ€§èƒ½Goå¾®æœåŠ¡ç½‘å…³ï¼šè®¾è®¡ä¸å®è·µ"></a>æ„å»ºé«˜æ€§èƒ½Goå¾®æœåŠ¡ç½‘å…³ï¼šè®¾è®¡ä¸å®è·µ</h2><p>éšç€å¾®æœåŠ¡æ¶æ„çš„æ™®åŠï¼ŒAPIç½‘å…³ä½œä¸ºç³»ç»Ÿçš„æµé‡å…¥å£ï¼Œæ‰¿æ‹…ç€è´Ÿè½½å‡è¡¡ã€è®¤è¯æˆæƒã€é™æµç†”æ–­ç­‰å…³é”®èŒè´£ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å¦‚ä½•ä½¿ç”¨Goè¯­è¨€æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€å¯æ‰©å±•çš„å¾®æœåŠ¡ç½‘å…³ï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€æ ¸å¿ƒåŠŸèƒ½å®ç°ä»¥åŠæ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€‚</p><h3 id="å¾®æœåŠ¡ç½‘å…³çš„æ ¸å¿ƒå®šä½"><a class="header-anchor" href="#å¾®æœåŠ¡ç½‘å…³çš„æ ¸å¿ƒå®šä½"></a>å¾®æœåŠ¡ç½‘å…³çš„æ ¸å¿ƒå®šä½</h3><p>å¾®æœåŠ¡ç½‘å…³æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„å…³é”®ç»„ä»¶ï¼Œä¸»è¦æ‰¿æ‹…ä»¥ä¸‹èŒè´£ï¼š</p><ol><li><strong>è¯·æ±‚è·¯ç”±ä¸è½¬å‘</strong>ï¼šå°†å®¢æˆ·ç«¯è¯·æ±‚æ­£ç¡®è·¯ç”±åˆ°å¯¹åº”çš„åç«¯æœåŠ¡</li><li><strong>åè®®è½¬æ¢</strong>ï¼šåœ¨ä¸åŒåè®®é—´è¿›è¡Œè½¬æ¢ï¼ˆå¦‚HTTPåˆ°gRPCï¼‰</li><li><strong>è®¤è¯ä¸æˆæƒ</strong>ï¼šç»Ÿä¸€çš„èº«ä»½éªŒè¯å’Œè®¿é—®æ§åˆ¶</li><li><strong>æµé‡ç®¡æ§</strong>ï¼šé™æµã€ç†”æ–­ã€è´Ÿè½½å‡è¡¡</li><li><strong>å¯è§‚æµ‹æ€§</strong>ï¼šè¯·æ±‚æ—¥å¿—ã€ç›‘æ§æŒ‡æ ‡ã€é“¾è·¯è¿½è¸ª</li><li><strong>è¾¹ç¼˜åŠŸèƒ½</strong>ï¼šç¼“å­˜ã€è¯·æ±‚/å“åº”è½¬æ¢ç­‰</li></ol><h4 id="å¸¸è§å¾®æœåŠ¡ç½‘å…³å¯¹æ¯”"><a class="header-anchor" href="#å¸¸è§å¾®æœåŠ¡ç½‘å…³å¯¹æ¯”"></a>å¸¸è§å¾®æœåŠ¡ç½‘å…³å¯¹æ¯”</h4><table><thead><tr><th>ç‰¹æ€§</th><th>Kong</th><th>APISIX</th><th>Traefik</th><th>è‡ªå»ºGoç½‘å…³</th></tr></thead><tbody><tr><td>å¼€å‘è¯­è¨€</td><td>Lua/Nginx</td><td>Lua/Nginx</td><td>Go</td><td>Go</td></tr><tr><td>åŠ¨æ€è·¯ç”±</td><td>æ”¯æŒ</td><td>æ”¯æŒ</td><td>æ”¯æŒ</td><td>æ”¯æŒ</td></tr><tr><td>æ‰©å±•æ€§</td><td>æ’ä»¶æœºåˆ¶</td><td>æ’ä»¶æœºåˆ¶</td><td>ä¸­é—´ä»¶</td><td>å®Œå…¨è‡ªå®šä¹‰</td></tr><tr><td>æ€§èƒ½</td><td>å¾ˆé«˜</td><td>å¾ˆé«˜</td><td>é«˜</td><td>å¯ä¼˜åŒ–ä¸ºå¾ˆé«˜</td></tr><tr><td>éƒ¨ç½²å¤æ‚æ€§</td><td>ä¸­ç­‰</td><td>ä¸­ç­‰</td><td>ç®€å•</td><td>ç®€å•</td></tr><tr><td>å®šåˆ¶åŒ–éš¾åº¦</td><td>ä¸­ç­‰</td><td>ä¸­ç­‰</td><td>ä¸­ç­‰</td><td>ä½</td></tr></tbody></table><h3 id="ç½‘å…³æ¶æ„è®¾è®¡"><a class="header-anchor" href="#ç½‘å…³æ¶æ„è®¾è®¡"></a>ç½‘å…³æ¶æ„è®¾è®¡</h3><p>ä¸€ä¸ªé«˜æ€§èƒ½Goå¾®æœåŠ¡ç½‘å…³çš„æ ¸å¿ƒæ¶æ„é€šå¸¸åŒ…å«ä»¥ä¸‹å‡ ä¸ªå±‚æ¬¡ï¼š</p><h4 id="1-æ ¸å¿ƒå±‚æ¬¡ç»“æ„"><a class="header-anchor" href="#1-æ ¸å¿ƒå±‚æ¬¡ç»“æ„"></a>1. æ ¸å¿ƒå±‚æ¬¡ç»“æ„</h4><ul><li><strong>å®¢æˆ·ç«¯å±‚</strong>ï¼šæ¥æ”¶å¤–éƒ¨è¯·æ±‚</li><li><strong>HTTPæœåŠ¡å™¨å±‚</strong>ï¼šåŸºäºnet/httpæˆ–fasthttpæ¥æ”¶å’Œå¤„ç†HTTPè¯·æ±‚</li><li><strong>ä¸­é—´ä»¶å±‚</strong>ï¼šå¤„ç†è®¤è¯ã€æ—¥å¿—ã€ç›‘æ§ã€é™æµã€ç†”æ–­ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹</li><li><strong>è·¯ç”±å±‚</strong>ï¼šæ ¹æ®è·¯å¾„åŒ¹é…è§„åˆ™ï¼Œç¡®å®šè¯·æ±‚åº”è¯¥è½¬å‘åˆ°å“ªä¸ªæœåŠ¡</li><li><strong>åç«¯ä»£ç†å±‚</strong>ï¼šé€šè¿‡è´Ÿè½½å‡è¡¡é€‰æ‹©åç«¯æœåŠ¡å®ä¾‹ï¼Œå¹¶è½¬å‘è¯·æ±‚</li><li><strong>æœåŠ¡å®ä¾‹</strong>ï¼šå¤„ç†å®é™…ä¸šåŠ¡é€»è¾‘çš„åç«¯æœåŠ¡</li></ul><h4 id="2-æ ¸å¿ƒç»„ä»¶è®¾è®¡"><a class="header-anchor" href="#2-æ ¸å¿ƒç»„ä»¶è®¾è®¡"></a>2. æ ¸å¿ƒç»„ä»¶è®¾è®¡</h4><ol><li><strong>é…ç½®ç®¡ç†</strong>ï¼šè´Ÿè´£åŠ è½½ã€è§£æç½‘å…³é…ç½®ï¼Œæ”¯æŒåŠ¨æ€æ›´æ–°</li><li><strong>è·¯ç”±å¼•æ“</strong>ï¼šé«˜æ•ˆåŒ¹é…è¯·æ±‚è·¯å¾„ï¼Œç¡®å®šç›®æ ‡æœåŠ¡</li><li><strong>ä¸­é—´ä»¶ç®¡ç†</strong>ï¼šå¤„ç†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œå¦‚è®¤è¯ã€é™æµç­‰</li><li><strong>æœåŠ¡å‘ç°</strong>ï¼šä¸æ³¨å†Œä¸­å¿ƒé›†æˆï¼ŒåŠ¨æ€è·å–æœåŠ¡åˆ—è¡¨</li><li><strong>è´Ÿè½½å‡è¡¡å™¨</strong>ï¼šæŒ‰ç­–ç•¥é€‰æ‹©åç«¯å®ä¾‹</li><li><strong>è¯·æ±‚è½¬å‘å™¨</strong>ï¼šè½¬å‘è¯·æ±‚å¹¶å¤„ç†å“åº”</li><li><strong>ç›‘æ§ç»Ÿè®¡</strong>ï¼šæ”¶é›†è¿è¡ŒæŒ‡æ ‡ï¼Œæä¾›å¯è§‚æµ‹æ€§</li></ol><h3 id="Goå¾®æœåŠ¡ç½‘å…³æ ¸å¿ƒåŠŸèƒ½å®ç°"><a class="header-anchor" href="#Goå¾®æœåŠ¡ç½‘å…³æ ¸å¿ƒåŠŸèƒ½å®ç°"></a>Goå¾®æœåŠ¡ç½‘å…³æ ¸å¿ƒåŠŸèƒ½å®ç°</h3><h4 id="1-é«˜æ•ˆè·¯ç”±åŒ¹é…"><a class="header-anchor" href="#1-é«˜æ•ˆè·¯ç”±åŒ¹é…"></a>1. é«˜æ•ˆè·¯ç”±åŒ¹é…</h4><p>é«˜æ€§èƒ½è·¯ç”±åŒ¹é…æ˜¯ç½‘å…³çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ã€‚å¸¸è§çš„è·¯ç”±åŒ¹é…ç®—æ³•åŒ…æ‹¬ï¼š</p><ul><li><strong>å“ˆå¸Œè¡¨åŒ¹é…</strong>ï¼šé€‚åˆå®Œå…¨åŒ¹é…çš„åœºæ™¯ï¼ŒæŸ¥æ‰¾æ•ˆç‡O(1)</li><li><strong>å‰ç¼€æ ‘åŒ¹é…</strong>ï¼šé€‚åˆURLè·¯å¾„åŒ¹é…ï¼Œæ”¯æŒè·¯å¾„å‚æ•°æå–</li><li><strong>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…</strong>ï¼šçµæ´»ä½†æ€§èƒ½è¾ƒä½</li></ul><p>å‰ç¼€æ ‘(Trie)è·¯ç”±å®ç°çš„ä¼˜åŠ¿ï¼š</p><ul><li>é«˜æ•ˆåŒ¹é…è·¯å¾„ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(k)ï¼Œkä¸ºè·¯å¾„æ®µæ•°</li><li>æ”¯æŒè·¯å¾„å‚æ•°å’Œé€šé…ç¬¦</li><li>å†…å­˜å ç”¨ç›¸å¯¹è¾ƒä½</li><li>å¯ä»¥ç²¾ç¡®åŒ¹é…æœ€é•¿å‰ç¼€</li></ul><h4 id="2-ä¸­é—´ä»¶å®ç°"><a class="header-anchor" href="#2-ä¸­é—´ä»¶å®ç°"></a>2. ä¸­é—´ä»¶å®ç°</h4><p>ä¸­é—´ä»¶æ˜¯Go APIç½‘å…³ä¸­å¤„ç†æ¨ªåˆ‡å…³æ³¨ç‚¹çš„å…³é”®æœºåˆ¶ã€‚å¸¸è§çš„ä¸­é—´ä»¶åŒ…æ‹¬ï¼š</p><p><strong>1. è®¤è¯ä¸­é—´ä»¶</strong></p><p>è´Ÿè´£éªŒè¯è¯·æ±‚èº«ä»½ï¼Œå¯ä»¥æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼š</p><ul><li>JWTä»¤ç‰ŒéªŒè¯</li><li>APIå¯†é’¥éªŒè¯</li><li>OAuth2é›†æˆ</li></ul><p><strong>2. é™æµä¸­é—´ä»¶</strong></p><p>ä¿æŠ¤åç«¯æœåŠ¡å…äºè¿‡è½½ï¼š</p><ul><li>ä»¤ç‰Œæ¡¶ç®—æ³•å®ç°</li><li>æ”¯æŒåŸºäºæœåŠ¡/è·¯å¾„/å®¢æˆ·ç«¯çš„é™æµ</li><li>åˆ†å¸ƒå¼é™æµï¼ˆåŸºäºRedisï¼‰</li></ul><p><strong>3. ç†”æ–­ä¸­é—´ä»¶</strong></p><p>é˜²æ­¢çº§è”æ•…éšœï¼š</p><ul><li>ç»Ÿè®¡åç«¯æœåŠ¡é”™è¯¯ç‡å’Œå“åº”æ—¶é—´</li><li>å®ç°åŠå¼€ã€å¼€ã€å…³ä¸‰çŠ¶æ€è½¬æ¢</li><li>æ”¯æŒè‡ªå®šä¹‰ç†”æ–­ç­–ç•¥</li></ul><p><strong>4. ç›‘æ§ä¸­é—´ä»¶</strong></p><p>æ”¶é›†è¯·æ±‚æŒ‡æ ‡ï¼š</p><ul><li>è¯·æ±‚è®¡æ•°ç»Ÿè®¡</li><li>å“åº”æ—¶é—´åˆ†å¸ƒ</li><li>é”™è¯¯ç‡ç»Ÿè®¡</li></ul><h4 id="3-æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡"><a class="header-anchor" href="#3-æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡"></a>3. æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡</h4><p>ä¸æœåŠ¡æ³¨å†Œä¸­å¿ƒé›†æˆï¼ŒåŠ¨æ€å‘ç°åç«¯æœåŠ¡ï¼š</p><p><strong>æœåŠ¡å‘ç°é›†æˆ</strong>ï¼š</p><ul><li>Consulé›†æˆ</li><li>etcdé›†æˆ</li><li>Kubernetesé›†æˆ</li></ul><p><strong>è´Ÿè½½å‡è¡¡ç­–ç•¥</strong>ï¼š</p><ul><li>è½®è¯¢ï¼ˆRound Robinï¼‰</li><li>åŠ æƒè½®è¯¢ï¼ˆWeighted Round Robinï¼‰</li><li>æœ€å°‘è¿æ¥ï¼ˆLeast Connectionï¼‰</li><li>ä¸€è‡´æ€§å“ˆå¸Œï¼ˆConsistent Hashï¼‰</li></ul><h3 id="æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a class="header-anchor" href="#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3><p>æ„å»ºé«˜æ€§èƒ½ç½‘å…³éœ€è¦å…³æ³¨å¤šä¸ªæ–¹é¢çš„ä¼˜åŒ–ï¼š</p><h4 id="1-HTTPå¤„ç†ä¼˜åŒ–"><a class="header-anchor" href="#1-HTTPå¤„ç†ä¼˜åŒ–"></a>1. HTTPå¤„ç†ä¼˜åŒ–</h4><ul><li>ä½¿ç”¨<code>fasthttp</code>æ›¿ä»£æ ‡å‡†åº“<code>net/http</code></li><li>å¯ç”¨HTTP/2æ”¯æŒ</li><li>é…ç½®é€‚å½“çš„è¯»å†™è¶…æ—¶å’Œè¿æ¥ä¿æŒæ—¶é—´</li></ul><h4 id="2-è¿æ¥æ± ä¼˜åŒ–"><a class="header-anchor" href="#2-è¿æ¥æ± ä¼˜åŒ–"></a>2. è¿æ¥æ± ä¼˜åŒ–</h4><ul><li>åˆç†é…ç½®è¿æ¥æ± å¤§å°</li><li>è®¾ç½®é€‚å½“çš„è¿æ¥ç©ºé—²è¶…æ—¶</li><li>ä¼˜åŒ–è¿æ¥å¤ç”¨ç­–ç•¥</li></ul><h4 id="3-å†…å­˜ä¼˜åŒ–"><a class="header-anchor" href="#3-å†…å­˜ä¼˜åŒ–"></a>3. å†…å­˜ä¼˜åŒ–</h4><ul><li>ä½¿ç”¨å¯¹è±¡æ± å‡å°‘GCå‹åŠ›</li><li>é¿å…ä¸å¿…è¦çš„å¯¹è±¡åˆ†é…</li><li>ä½¿ç”¨é›¶æ‹·è´æŠ€æœ¯å¤„ç†è¯·æ±‚å’Œå“åº”ä½“</li></ul><h4 id="4-å¹¶å‘ä¼˜åŒ–"><a class="header-anchor" href="#4-å¹¶å‘ä¼˜åŒ–"></a>4. å¹¶å‘ä¼˜åŒ–</h4><ul><li>ä½¿ç”¨åˆé€‚çš„å¹¶å‘æ¨¡å‹</li><li>ä¼˜åŒ–é”ä½¿ç”¨ï¼Œå‡å°‘ç«äº‰</li><li>ä½¿ç”¨æ— é”æ•°æ®ç»“æ„</li></ul><h3 id="å®é™…æ€§èƒ½æµ‹è¯•ç»“æœ"><a class="header-anchor" href="#å®é™…æ€§èƒ½æµ‹è¯•ç»“æœ"></a>å®é™…æ€§èƒ½æµ‹è¯•ç»“æœ</h3><p>åœ¨8æ ¸16GæœåŠ¡å™¨ä¸Šçš„æµ‹è¯•ç»“æœï¼ˆå¹¶å‘500è¿æ¥ï¼ŒæŒç»­30ç§’ï¼‰ï¼š</p><table><thead><tr><th>æŒ‡æ ‡</th><th>æ ‡å‡†net/http</th><th>fasthttp</th><th>ä¼˜åŒ–å</th></tr></thead><tbody><tr><td>QPS</td><td>12,000</td><td>22,000</td><td>28,000</td></tr><tr><td>å¹³å‡å“åº”æ—¶é—´</td><td>32ms</td><td>18ms</td><td>12ms</td></tr><tr><td>æœ€å¤§å“åº”æ—¶é—´</td><td>120ms</td><td>80ms</td><td>52ms</td></tr><tr><td>å†…å­˜ä½¿ç”¨</td><td>1.2GB</td><td>800MB</td><td>650MB</td></tr><tr><td>CPUä½¿ç”¨</td><td>65%</td><td>48%</td><td>40%</td></tr></tbody></table><h3 id="æ€»ç»“ä¸å®è·µå»ºè®®"><a class="header-anchor" href="#æ€»ç»“ä¸å®è·µå»ºè®®"></a>æ€»ç»“ä¸å®è·µå»ºè®®</h3><p>æ„å»ºé«˜æ€§èƒ½Goå¾®æœåŠ¡ç½‘å…³éœ€è¦ç»¼åˆè€ƒè™‘æ¶æ„è®¾è®¡ã€åŠŸèƒ½å®ç°å’Œæ€§èƒ½ä¼˜åŒ–ç­‰å¤šä¸ªæ–¹é¢ï¼š</p><ol><li><strong>é€‰æ‹©åˆé€‚çš„åŸºç¡€ç»„ä»¶</strong>ï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„HTTPåº“ã€è·¯ç”±å¼•æ“ç­‰</li><li><strong>è®¾è®¡å¯æ‰©å±•æ¶æ„</strong>ï¼šé€šè¿‡ä¸­é—´ä»¶å’Œæ’ä»¶æœºåˆ¶å®ç°åŠŸèƒ½æ‰©å±•</li><li><strong>å®ç°æ ¸å¿ƒåŠŸèƒ½</strong>ï¼šè·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€ç†”æ–­ã€é™æµç­‰</li><li><strong>å…³æ³¨æ€§èƒ½ä¼˜åŒ–</strong>ï¼šè¿æ¥æ± ã€å†…å­˜ç®¡ç†ã€å¹¶å‘æ§åˆ¶ç­‰</li><li><strong>ä¿è¯å¯è§‚æµ‹æ€§</strong>ï¼šæ—¥å¿—ã€ç›‘æ§ã€é“¾è·¯è¿½è¸ª</li></ol><p>æ— è®ºæ˜¯ä½¿ç”¨ç°æœ‰å¼€æºç½‘å…³äº§å“è¿˜æ˜¯è‡ªå»ºç½‘å…³ï¼Œç†è§£å…¶æ ¸å¿ƒåŸç†å’Œè®¾è®¡æ€è·¯å¯¹äºæ„å»ºé«˜æ€§èƒ½ã€å¯é çš„å¾®æœåŠ¡æ¶æ„è‡³å…³é‡è¦ã€‚ä¸€ä¸ªä¼˜ç§€çš„å¾®æœåŠ¡ç½‘å…³åº”å½“åœ¨ä¿è¯åŠŸèƒ½å®Œæ•´çš„åŒæ—¶ï¼Œæä¾›è¶³å¤Ÿçš„æ‰©å±•æ€§å’Œæ€§èƒ½ï¼Œä»¥æ»¡è¶³ä¸æ–­å˜åŒ–çš„ä¸šåŠ¡éœ€æ±‚ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
      <category>å¾®æœåŠ¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>æ€§èƒ½ä¼˜åŒ–</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
      <tag>APIç½‘å…³</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå®ç°é«˜æ€§èƒ½åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ</title>
    <link href="/2024/09/05/Go%E5%AE%9E%E7%8E%B0%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%B3%BB%E7%BB%9F/"/>
    <url>/2024/09/05/Go%E5%AE%9E%E7%8E%B0%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h2 id="â°-Goå®ç°é«˜æ€§èƒ½åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ"><a class="header-anchor" href="#â°-Goå®ç°é«˜æ€§èƒ½åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ"></a>â° Goå®ç°é«˜æ€§èƒ½åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ</h2><p>åœ¨ç°ä»£åº”ç”¨æ¶æ„ä¸­ï¼Œå®šæ—¶ä»»åŠ¡ç³»ç»Ÿæ˜¯ä¸å¯æˆ–ç¼ºçš„ç»„ä»¶ã€‚ä»æ—¥å¿—è½®è½¬ã€æ•°æ®åŒæ­¥åˆ°å®šæœŸæŠ¥å‘Šç”Ÿæˆï¼Œå„ç§åœºæ™¯éƒ½éœ€è¦å¯é çš„å®šæ—¶ä»»åŠ¡æ”¯æŒã€‚å½“ç³»ç»Ÿè§„æ¨¡æ‰©å¤§ï¼Œå•æœºå®šæ—¶ä»»åŠ¡ç³»ç»Ÿé¢ä¸´è¯¸å¤šæŒ‘æˆ˜ï¼Œå¦‚å•ç‚¹æ•…éšœã€ä»»åŠ¡å †ç§¯ã€èµ„æºç“¶é¢ˆç­‰ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨Goè¯­è¨€å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿã€‚</p><h3 id="ğŸŒ-ç³»ç»Ÿè®¾è®¡æ¦‚è¿°"><a class="header-anchor" href="#ğŸŒ-ç³»ç»Ÿè®¾è®¡æ¦‚è¿°"></a>ğŸŒ ç³»ç»Ÿè®¾è®¡æ¦‚è¿°</h3><h4 id="æ ¸å¿ƒéœ€æ±‚"><a class="header-anchor" href="#æ ¸å¿ƒéœ€æ±‚"></a>æ ¸å¿ƒéœ€æ±‚</h4><p>ä¸€ä¸ªä¼˜ç§€çš„åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿåº”æ»¡è¶³ä»¥ä¸‹æ ¸å¿ƒéœ€æ±‚ï¼š</p><ol><li><strong>é«˜å¯ç”¨æ€§</strong>ï¼šæ— å•ç‚¹æ•…éšœï¼ŒèŠ‚ç‚¹æ•…éšœä¸å½±å“æ•´ä½“ç³»ç»Ÿè¿è¡Œ</li><li><strong>å¯æ‰©å±•æ€§</strong>ï¼šæ”¯æŒåŠ¨æ€æ°´å¹³æ‰©å±•ï¼Œåº”å¯¹ä¸šåŠ¡å¢é•¿</li><li><strong>ä»»åŠ¡å‡†ç¡®æ€§</strong>ï¼šç¡®ä¿ä»»åŠ¡æŒ‰æ—¶æ‰§è¡Œä¸”ä¸ä¼šé‡å¤æ‰§è¡Œ</li><li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šä»»åŠ¡åœ¨é›†ç¾¤èŠ‚ç‚¹é—´åˆç†åˆ†é…</li><li><strong>æ•…éšœæ¢å¤</strong>ï¼šèŠ‚ç‚¹æ•…éšœåä»»åŠ¡èƒ½è‡ªåŠ¨è½¬ç§»</li><li><strong>å¯è§‚æµ‹æ€§</strong>ï¼šå®Œå–„çš„ç›‘æ§å’Œæ—¥å¿—æœºåˆ¶</li></ol><h4 id="ç³»ç»Ÿæ¶æ„"><a class="header-anchor" href="#ç³»ç»Ÿæ¶æ„"></a>ç³»ç»Ÿæ¶æ„</h4><p>æˆ‘ä»¬çš„åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿé‡‡ç”¨ä¸»ä»æ¶æ„ï¼Œç”±è°ƒåº¦å™¨å’Œæ‰§è¡Œå™¨ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p><pre><code class="hljs angelscript">                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚   ä»»åŠ¡ç®¡ç†UI  â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                        â”‚                        â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  ä»»åŠ¡å­˜å‚¨  â”‚â—„â”€â”€â”€â”€â–ºâ”‚   è°ƒåº¦å™¨é›†ç¾¤  â”‚â—„â”€â”€â”€â”€â–ºâ”‚  æœåŠ¡æ³¨å†Œ   â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚                          â–¼                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚                     â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”        â”‚   æ‰§è¡Œå™¨èŠ‚ç‚¹<span class="hljs-number">1</span>  â”‚     â”‚   æ‰§è¡Œå™¨èŠ‚ç‚¹<span class="hljs-number">2</span>  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre><p>æ ¸å¿ƒç»„ä»¶ï¼š</p><ol><li><strong>è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰</strong>ï¼šè´Ÿè´£ä»»åŠ¡è°ƒåº¦ã€åˆ†å‘å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†</li><li><strong>æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰</strong>ï¼šè´Ÿè´£å®é™…æ‰§è¡Œä»»åŠ¡çš„å·¥ä½œèŠ‚ç‚¹</li><li><strong>ä»»åŠ¡å­˜å‚¨ï¼ˆTask Storeï¼‰</strong>ï¼šæŒä¹…åŒ–å­˜å‚¨ä»»åŠ¡é…ç½®å’Œæ‰§è¡ŒçŠ¶æ€</li><li><strong>æœåŠ¡æ³¨å†Œï¼ˆRegistryï¼‰</strong>ï¼šç®¡ç†æ‰§è¡Œå™¨èŠ‚ç‚¹çš„æ³¨å†Œå’Œå‘ç°</li><li><strong>ä»»åŠ¡ç®¡ç†UI</strong>ï¼šæä¾›ä»»åŠ¡é…ç½®å’Œç›‘æ§çš„Webç•Œé¢</li></ol><h3 id="ğŸ—ï¸-æ ¸å¿ƒç»„ä»¶å®ç°"><a class="header-anchor" href="#ğŸ—ï¸-æ ¸å¿ƒç»„ä»¶å®ç°"></a>ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶å®ç°</h3><h4 id="ä»»åŠ¡æ¨¡å‹è®¾è®¡"><a class="header-anchor" href="#ä»»åŠ¡æ¨¡å‹è®¾è®¡"></a>ä»»åŠ¡æ¨¡å‹è®¾è®¡</h4><p>é¦–å…ˆå®šä¹‰ä»»åŠ¡æ¨¡å‹ï¼ŒåŒ…å«ä»»åŠ¡çš„åŸºæœ¬ä¿¡æ¯å’Œè°ƒåº¦è§„åˆ™ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Task <span class="hljs-keyword">struct</span> &#123;    ID          <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;id&quot;`</span>    Name        <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;name&quot;`</span>    Cron        <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;cron&quot;`</span>        <span class="hljs-comment">// Cronè¡¨è¾¾å¼</span>    Command     <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;command&quot;`</span>     <span class="hljs-comment">// è¦æ‰§è¡Œçš„å‘½ä»¤</span>    Timeout     <span class="hljs-keyword">int</span>       <span class="hljs-string">`json:&quot;timeout&quot;`</span>     <span class="hljs-comment">// è¶…æ—¶æ—¶é—´(ç§’)</span>    RetryTimes  <span class="hljs-keyword">int</span>       <span class="hljs-string">`json:&quot;retryTimes&quot;`</span>  <span class="hljs-comment">// é‡è¯•æ¬¡æ•°</span>    RetryDelay  <span class="hljs-keyword">int</span>       <span class="hljs-string">`json:&quot;retryDelay&quot;`</span>  <span class="hljs-comment">// é‡è¯•å»¶è¿Ÿ(ç§’)</span>    CreatedAt   time.Time <span class="hljs-string">`json:&quot;createdAt&quot;`</span>    UpdatedAt   time.Time <span class="hljs-string">`json:&quot;updatedAt&quot;`</span>        <span class="hljs-comment">// åˆ†å¸ƒå¼ç›¸å…³å­—æ®µ</span>    ShardingKey <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;shardingKey&quot;`</span> <span class="hljs-comment">// åˆ†ç‰‡é”®</span>    NodeID      <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;nodeId&quot;`</span>      <span class="hljs-comment">// æŒ‡å®šæ‰§è¡ŒèŠ‚ç‚¹ï¼Œä¸ºç©ºåˆ™è‡ªåŠ¨é€‰æ‹©</span>&#125;<span class="hljs-keyword">type</span> TaskExecution <span class="hljs-keyword">struct</span> &#123;    ID          <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;id&quot;`</span>    TaskID      <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;taskId&quot;`</span>    Status      <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;status&quot;`</span>      <span class="hljs-comment">// pending, running, success, failed</span>    NodeID      <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;nodeId&quot;`</span>      <span class="hljs-comment">// æ‰§è¡ŒèŠ‚ç‚¹ID</span>    StartTime   time.Time <span class="hljs-string">`json:&quot;startTime&quot;`</span>   <span class="hljs-comment">// å¼€å§‹æ—¶é—´</span>    EndTime     time.Time <span class="hljs-string">`json:&quot;endTime&quot;`</span>     <span class="hljs-comment">// ç»“æŸæ—¶é—´</span>    Output      <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;output&quot;`</span>      <span class="hljs-comment">// æ‰§è¡Œè¾“å‡º</span>    Error       <span class="hljs-keyword">string</span>    <span class="hljs-string">`json:&quot;error&quot;`</span>       <span class="hljs-comment">// é”™è¯¯ä¿¡æ¯</span>    RetryCount  <span class="hljs-keyword">int</span>       <span class="hljs-string">`json:&quot;retryCount&quot;`</span>  <span class="hljs-comment">// é‡è¯•è®¡æ•°</span>&#125;</code></pre><h4 id="è°ƒåº¦å™¨å®ç°"><a class="header-anchor" href="#è°ƒåº¦å™¨å®ç°"></a>è°ƒåº¦å™¨å®ç°</h4><p>è°ƒåº¦å™¨æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£è§£æCronè¡¨è¾¾å¼å¹¶ç¡®å®šä»»åŠ¡çš„è°ƒåº¦æ—¶é—´ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Scheduler <span class="hljs-keyword">struct</span> &#123;    store         TaskStore    registry      ServiceRegistry    cronParser    *cron.Parser    taskQueue     <span class="hljs-keyword">chan</span> *Task    executionLock DistributedLock    metrics       *SchedulerMetrics    logger        *zap.Logger&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewScheduler</span><span class="hljs-params">(store TaskStore, registry ServiceRegistry)</span> *<span class="hljs-title">Scheduler</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;Scheduler&#123;        store:      store,        registry:   registry,        cronParser: cron.NewParser(            cron.Second | cron.Minute | cron.Hour | cron.Dom | cron.Month | cron.Dow,        ),        taskQueue:     <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Task, <span class="hljs-number">10000</span>),        executionLock: NewRedisLock(<span class="hljs-string">&quot;task_execution_lock&quot;</span>),        metrics:       NewSchedulerMetrics(),        logger:        zap.NewProduction(),    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">Start</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-comment">// å®šæœŸæ‰«æä»»åŠ¡è¡¨ï¼Œè®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´</span>    <span class="hljs-keyword">go</span> s.scanTasks(ctx)        <span class="hljs-comment">// å¤„ç†å¾…æ‰§è¡Œçš„ä»»åŠ¡</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; runtime.NumCPU(); i++ &#123;        <span class="hljs-keyword">go</span> s.processTaskQueue(ctx)    &#125;        <span class="hljs-comment">// å¯åŠ¨leaderé€‰ä¸¾</span>    <span class="hljs-keyword">go</span> s.leaderElection(ctx)        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">scanTasks</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;    ticker := time.NewTicker(<span class="hljs-number">1</span> * time.Second)    <span class="hljs-keyword">defer</span> ticker.Stop()        <span class="hljs-keyword">for</span> &#123;        <span class="hljs-keyword">select</span> &#123;        <span class="hljs-keyword">case</span> &lt;-ctx.Done():            <span class="hljs-keyword">return</span>        <span class="hljs-keyword">case</span> now := &lt;-ticker.C:            tasks, err := s.store.GetDueTasks(now)            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;                s.logger.Error(<span class="hljs-string">&quot;Failed to get due tasks&quot;</span>, zap.Error(err))                <span class="hljs-keyword">continue</span>            &#125;                        <span class="hljs-keyword">for</span> _, task := <span class="hljs-keyword">range</span> tasks &#123;                s.taskQueue &lt;- task                s.metrics.TaskScheduled.Inc()            &#125;        &#125;    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">processTaskQueue</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;    <span class="hljs-keyword">for</span> &#123;        <span class="hljs-keyword">select</span> &#123;        <span class="hljs-keyword">case</span> &lt;-ctx.Done():            <span class="hljs-keyword">return</span>        <span class="hljs-keyword">case</span> task := &lt;-s.taskQueue:            <span class="hljs-comment">// è·å–åˆ†å¸ƒå¼é”ï¼Œé˜²æ­¢ä»»åŠ¡é‡å¤æ‰§è¡Œ</span>            lockKey := fmt.Sprintf(<span class="hljs-string">&quot;task_lock:%s:%s&quot;</span>, task.ID, time.Now().Format(<span class="hljs-string">&quot;2006-01-02T15:04:05Z&quot;</span>))            acquired, err := s.executionLock.Acquire(lockKey, <span class="hljs-number">10</span>*time.Second)            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || !acquired &#123;                s.logger.Warn(<span class="hljs-string">&quot;Failed to acquire execution lock&quot;</span>, zap.String(<span class="hljs-string">&quot;taskId&quot;</span>, task.ID))                <span class="hljs-keyword">continue</span>            &#125;                        <span class="hljs-comment">// åˆ†é…æ‰§è¡ŒèŠ‚ç‚¹</span>            node, err := s.allocateExecutionNode(task)            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;                s.logger.Error(<span class="hljs-string">&quot;Failed to allocate execution node&quot;</span>, zap.Error(err))                s.executionLock.Release(lockKey)                <span class="hljs-keyword">continue</span>            &#125;                        <span class="hljs-comment">// åˆ›å»ºæ‰§è¡Œè®°å½•</span>            execution := &amp;TaskExecution&#123;                ID:        uuid.New().String(),                TaskID:    task.ID,                Status:    <span class="hljs-string">&quot;pending&quot;</span>,                NodeID:    node.ID,                StartTime: time.Now(),            &#125;                        <span class="hljs-keyword">if</span> err := s.store.CreateExecution(execution); err != <span class="hljs-literal">nil</span> &#123;                s.logger.Error(<span class="hljs-string">&quot;Failed to create execution record&quot;</span>, zap.Error(err))                s.executionLock.Release(lockKey)                <span class="hljs-keyword">continue</span>            &#125;                        <span class="hljs-comment">// å°†ä»»åŠ¡æ¨é€åˆ°æ‰§è¡ŒèŠ‚ç‚¹</span>            <span class="hljs-keyword">if</span> err := s.dispatchTaskToNode(node, task, execution); err != <span class="hljs-literal">nil</span> &#123;                s.logger.Error(<span class="hljs-string">&quot;Failed to dispatch task&quot;</span>, zap.Error(err))                                <span class="hljs-comment">// æ›´æ–°æ‰§è¡ŒçŠ¶æ€ä¸ºå¤±è´¥</span>                execution.Status = <span class="hljs-string">&quot;failed&quot;</span>                execution.Error = err.Error()                execution.EndTime = time.Now()                s.store.UpdateExecution(execution)            &#125;                        <span class="hljs-comment">// è®¡ç®—ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´å¹¶æ›´æ–°ä»»åŠ¡</span>            nextTime, err := s.calculateNextExecutionTime(task)            <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;                s.store.UpdateTaskNextExecutionTime(task.ID, nextTime)            &#125;                        s.executionLock.Release(lockKey)        &#125;    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">allocateExecutionNode</span><span class="hljs-params">(task *Task)</span> <span class="hljs-params">(*Node, error)</span></span> &#123;    <span class="hljs-comment">// å¦‚æœæŒ‡å®šäº†èŠ‚ç‚¹ï¼Œåˆ™ä½¿ç”¨æŒ‡å®šèŠ‚ç‚¹</span>    <span class="hljs-keyword">if</span> task.NodeID != <span class="hljs-string">&quot;&quot;</span> &#123;        node, err := s.registry.GetNode(task.NodeID)        <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; node.Status == <span class="hljs-string">&quot;online&quot;</span> &#123;            <span class="hljs-keyword">return</span> node, <span class="hljs-literal">nil</span>        &#125;        <span class="hljs-comment">// æŒ‡å®šèŠ‚ç‚¹ä¸å¯ç”¨ï¼Œé™çº§ä¸ºè‡ªåŠ¨é€‰æ‹©</span>        s.logger.Warn(<span class="hljs-string">&quot;Specified node unavailable&quot;</span>, zap.String(<span class="hljs-string">&quot;nodeId&quot;</span>, task.NodeID))    &#125;        <span class="hljs-comment">// è·å–å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨</span>    nodes, err := s.registry.GetAvailableNodes()    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || <span class="hljs-built_in">len</span>(nodes) == <span class="hljs-number">0</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;no available execution nodes&quot;</span>)    &#125;        <span class="hljs-comment">// ä¸€è‡´æ€§å“ˆå¸Œé€‰æ‹©èŠ‚ç‚¹ï¼ˆæ ¹æ®åˆ†ç‰‡é”®ï¼‰</span>    <span class="hljs-keyword">if</span> task.ShardingKey != <span class="hljs-string">&quot;&quot;</span> &#123;        <span class="hljs-keyword">return</span> s.consistentHashNode(task.ShardingKey, nodes)    &#125;        <span class="hljs-comment">// è´Ÿè½½å‡è¡¡é€‰æ‹©èŠ‚ç‚¹</span>    <span class="hljs-keyword">return</span> s.selectNodeByLoad(nodes)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">consistentHashNode</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, nodes []*Node)</span> <span class="hljs-params">(*Node, error)</span></span> &#123;    <span class="hljs-comment">// å®ç°ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</span>    hasher := consistenthash.New(<span class="hljs-number">100</span>, <span class="hljs-literal">nil</span>)    <span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> nodes &#123;        hasher.Add(node.ID)    &#125;        selectedNodeID := hasher.Get(key)    <span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> nodes &#123;        <span class="hljs-keyword">if</span> node.ID == selectedNodeID &#123;            <span class="hljs-keyword">return</span> node, <span class="hljs-literal">nil</span>        &#125;    &#125;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;failed to select node by consistent hash&quot;</span>)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">selectNodeByLoad</span><span class="hljs-params">(nodes []*Node)</span> <span class="hljs-params">(*Node, error)</span></span> &#123;    <span class="hljs-comment">// ç®€å•çš„è´Ÿè½½å‡è¡¡ï¼šé€‰æ‹©æ´»è·ƒä»»åŠ¡æ•°æœ€å°‘çš„èŠ‚ç‚¹</span>    <span class="hljs-keyword">var</span> selectedNode *Node    minActiveTasks := math.MaxInt32        <span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> nodes &#123;        <span class="hljs-keyword">if</span> node.ActiveTasks &lt; minActiveTasks &#123;            minActiveTasks = node.ActiveTasks            selectedNode = node        &#125;    &#125;        <span class="hljs-keyword">if</span> selectedNode == <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;failed to select node by load&quot;</span>)    &#125;        <span class="hljs-keyword">return</span> selectedNode, <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="æ‰§è¡Œå™¨å®ç°"><a class="header-anchor" href="#æ‰§è¡Œå™¨å®ç°"></a>æ‰§è¡Œå™¨å®ç°</h4><p>æ‰§è¡Œå™¨è´Ÿè´£å®é™…è¿è¡Œä»»åŠ¡ï¼Œå¹¶æŠ¥å‘Šæ‰§è¡Œç»“æœï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Executor <span class="hljs-keyword">struct</span> &#123;    nodeID      <span class="hljs-keyword">string</span>    registry    ServiceRegistry    taskClient  TaskClient    workerPool  *WorkerPool    metrics     *ExecutorMetrics    logger      *zap.Logger&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewExecutor</span><span class="hljs-params">(nodeID <span class="hljs-keyword">string</span>, registry ServiceRegistry)</span> *<span class="hljs-title">Executor</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;Executor&#123;        nodeID:     nodeID,        registry:   registry,        taskClient: NewTaskClient(),        workerPool: NewWorkerPool(<span class="hljs-number">100</span>), <span class="hljs-comment">// æœ€å¤š100ä¸ªå¹¶å‘ä»»åŠ¡</span>        metrics:    NewExecutorMetrics(),        logger:     zap.NewProduction(),    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Executor)</span> <span class="hljs-title">Start</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-comment">// å‘æœåŠ¡æ³¨å†Œä¸­å¿ƒæ³¨å†Œæœ¬èŠ‚ç‚¹</span>    <span class="hljs-keyword">if</span> err := e.registry.RegisterNode(&amp;Node&#123;        ID:          e.nodeID,        Address:     getLocalAddress(),        Status:      <span class="hljs-string">&quot;online&quot;</span>,        ActiveTasks: <span class="hljs-number">0</span>,        Tags:        <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>),    &#125;); err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> err    &#125;        <span class="hljs-comment">// å®šæœŸå‘é€å¿ƒè·³</span>    <span class="hljs-keyword">go</span> e.heartbeat(ctx)        <span class="hljs-comment">// å¯åŠ¨ä»»åŠ¡ç›‘å¬å™¨</span>    <span class="hljs-keyword">go</span> e.listenForTasks(ctx)        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Executor)</span> <span class="hljs-title">executeTask</span><span class="hljs-params">(task *Task, execution *TaskExecution)</span></span> &#123;    <span class="hljs-comment">// å¢åŠ æ´»è·ƒä»»åŠ¡è®¡æ•°</span>    e.metrics.ActiveTasks.Inc()    e.registry.UpdateNodeActiveTaskCount(e.nodeID, <span class="hljs-number">1</span>)        <span class="hljs-comment">// å®Œæˆåå‡å°‘è®¡æ•°</span>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        e.metrics.ActiveTasks.Dec()        e.registry.UpdateNodeActiveTaskCount(e.nodeID, <span class="hljs-number">-1</span>)    &#125;()        <span class="hljs-comment">// æ›´æ–°æ‰§è¡ŒçŠ¶æ€ä¸ºè¿è¡Œä¸­</span>    execution.Status = <span class="hljs-string">&quot;running&quot;</span>    e.taskClient.UpdateExecution(execution)        <span class="hljs-comment">// åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œæ”¯æŒè¶…æ—¶æ§åˆ¶</span>    ctx := context.Background()    <span class="hljs-keyword">if</span> task.Timeout &gt; <span class="hljs-number">0</span> &#123;        <span class="hljs-keyword">var</span> cancel context.CancelFunc        ctx, cancel = context.WithTimeout(ctx, time.Duration(task.Timeout)*time.Second)        <span class="hljs-keyword">defer</span> cancel()    &#125;        <span class="hljs-comment">// æ‰§è¡Œå‘½ä»¤</span>    <span class="hljs-keyword">var</span> output bytes.Buffer    <span class="hljs-keyword">var</span> stderr bytes.Buffer    cmd := exec.CommandContext(ctx, <span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, task.Command)    cmd.Stdout = &amp;output    cmd.Stderr = &amp;stderr        startTime := time.Now()    err := cmd.Run()    duration := time.Since(startTime)        <span class="hljs-comment">// è®°å½•æ‰§è¡ŒæŒ‡æ ‡</span>    e.metrics.TaskExecutionTime.Observe(duration.Seconds())        <span class="hljs-comment">// æ›´æ–°æ‰§è¡Œç»“æœ</span>    execution.EndTime = time.Now()    execution.Output = output.String()        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        execution.Status = <span class="hljs-string">&quot;failed&quot;</span>        execution.Error = fmt.Sprintf(<span class="hljs-string">&quot;%v: %s&quot;</span>, err, stderr.String())        e.metrics.TaskExecutionFailures.Inc()                <span class="hljs-comment">// å¤„ç†é‡è¯•é€»è¾‘</span>        <span class="hljs-keyword">if</span> execution.RetryCount &lt; task.RetryTimes &#123;            execution.RetryCount++            execution.Status = <span class="hljs-string">&quot;pending&quot;</span>                        <span class="hljs-comment">// å»¶è¿Ÿé‡è¯•</span>            time.AfterFunc(time.Duration(task.RetryDelay)*time.Second, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;                e.executeTask(task, execution)            &#125;)            <span class="hljs-keyword">return</span>        &#125;    &#125; <span class="hljs-keyword">else</span> &#123;        execution.Status = <span class="hljs-string">&quot;success&quot;</span>        e.metrics.TaskExecutionSuccess.Inc()    &#125;        <span class="hljs-comment">// æ›´æ–°æ‰§è¡Œè®°å½•</span>    e.taskClient.UpdateExecution(execution)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Executor)</span> <span class="hljs-title">heartbeat</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;    ticker := time.NewTicker(<span class="hljs-number">5</span> * time.Second)    <span class="hljs-keyword">defer</span> ticker.Stop()        <span class="hljs-keyword">for</span> &#123;        <span class="hljs-keyword">select</span> &#123;        <span class="hljs-keyword">case</span> &lt;-ctx.Done():            <span class="hljs-comment">// æ³¨é”€èŠ‚ç‚¹</span>            e.registry.DeregisterNode(e.nodeID)            <span class="hljs-keyword">return</span>        <span class="hljs-keyword">case</span> &lt;-ticker.C:            <span class="hljs-comment">// å‘é€å¿ƒè·³</span>            <span class="hljs-keyword">if</span> err := e.registry.Heartbeat(e.nodeID); err != <span class="hljs-literal">nil</span> &#123;                e.logger.Error(<span class="hljs-string">&quot;Failed to send heartbeat&quot;</span>, zap.Error(err))            &#125;        &#125;    &#125;&#125;</code></pre><h4 id="åˆ†å¸ƒå¼åè°ƒä¸æœåŠ¡å‘ç°"><a class="header-anchor" href="#åˆ†å¸ƒå¼åè°ƒä¸æœåŠ¡å‘ç°"></a>åˆ†å¸ƒå¼åè°ƒä¸æœåŠ¡å‘ç°</h4><p>ä½¿ç”¨etcdå®ç°æœåŠ¡æ³¨å†Œå‘ç°å’Œåˆ†å¸ƒå¼åè°ƒï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> EtcdRegistry <span class="hljs-keyword">struct</span> &#123;    client *clientv3.Client    ttl    <span class="hljs-keyword">int64</span>    logger *zap.Logger&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewEtcdRegistry</span><span class="hljs-params">(endpoints []<span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*EtcdRegistry, error)</span></span> &#123;    client, err := clientv3.New(clientv3.Config&#123;        Endpoints:   endpoints,        DialTimeout: <span class="hljs-number">5</span> * time.Second,    &#125;)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;        <span class="hljs-keyword">return</span> &amp;EtcdRegistry&#123;        client: client,        ttl:    <span class="hljs-number">30</span>, <span class="hljs-comment">// 30ç§’</span>        logger: zap.NewProduction(),    &#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *EtcdRegistry)</span> <span class="hljs-title">RegisterNode</span><span class="hljs-params">(node *Node)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºç§Ÿçº¦</span>    lease, err := r.client.Grant(context.Background(), r.ttl)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> err    &#125;        <span class="hljs-comment">// å°†èŠ‚ç‚¹ä¿¡æ¯åºåˆ—åŒ–</span>    nodeData, err := json.Marshal(node)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> err    &#125;        <span class="hljs-comment">// æ³¨å†ŒèŠ‚ç‚¹</span>    key := fmt.Sprintf(<span class="hljs-string">&quot;/cronex/nodes/%s&quot;</span>, node.ID)    _, err = r.client.Put(context.Background(), key, <span class="hljs-keyword">string</span>(nodeData), clientv3.WithLease(lease.ID))    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> err    &#125;        <span class="hljs-comment">// ä¿æŒç§Ÿçº¦</span>    ch, err := r.client.KeepAlive(context.Background(), lease.ID)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> err    &#125;        <span class="hljs-comment">// æ¶ˆè´¹keepaliveé€šé“</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> ch &#123;            <span class="hljs-comment">// ä»…ç”¨äºæ¶ˆè´¹é€šé“ï¼Œé¿å…é€šé“æ»¡</span>        &#125;    &#125;()        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *EtcdRegistry)</span> <span class="hljs-title">GetAvailableNodes</span><span class="hljs-params">()</span> <span class="hljs-params">([]*Node, error)</span></span> &#123;    resp, err := r.client.Get(context.Background(), <span class="hljs-string">&quot;/cronex/nodes/&quot;</span>, clientv3.WithPrefix())    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;        nodes := <span class="hljs-built_in">make</span>([]*Node, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(resp.Kvs))    <span class="hljs-keyword">for</span> _, kv := <span class="hljs-keyword">range</span> resp.Kvs &#123;        <span class="hljs-keyword">var</span> node Node        <span class="hljs-keyword">if</span> err := json.Unmarshal(kv.Value, &amp;node); err != <span class="hljs-literal">nil</span> &#123;            r.logger.Error(<span class="hljs-string">&quot;Failed to unmarshal node data&quot;</span>, zap.Error(err))            <span class="hljs-keyword">continue</span>        &#125;                <span class="hljs-keyword">if</span> node.Status == <span class="hljs-string">&quot;online&quot;</span> &#123;            nodes = <span class="hljs-built_in">append</span>(nodes, &amp;node)        &#125;    &#125;        <span class="hljs-keyword">return</span> nodes, <span class="hljs-literal">nil</span>&#125;</code></pre><h3 id="ğŸ”-é«˜å¯ç”¨ä¸æ•…éšœè½¬ç§»"><a class="header-anchor" href="#ğŸ”-é«˜å¯ç”¨ä¸æ•…éšœè½¬ç§»"></a>ğŸ” é«˜å¯ç”¨ä¸æ•…éšœè½¬ç§»</h3><h4 id="Leaderé€‰ä¸¾"><a class="header-anchor" href="#Leaderé€‰ä¸¾"></a>Leaderé€‰ä¸¾</h4><p>åœ¨å¤šè°ƒåº¦å™¨åœºæ™¯ä¸‹ï¼Œéœ€è¦é€šè¿‡Leaderé€‰ä¸¾ç¡®ä¿æŸäº›æ“ä½œåªè¢«ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">leaderElection</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;    session, err := concurrency.NewSession(s.registry.(*EtcdRegistry).client)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        s.logger.Error(<span class="hljs-string">&quot;Failed to create etcd session&quot;</span>, zap.Error(err))        <span class="hljs-keyword">return</span>    &#125;    <span class="hljs-keyword">defer</span> session.Close()        election := concurrency.NewElection(session, <span class="hljs-string">&quot;/cronex/leader&quot;</span>)        <span class="hljs-comment">// ç«é€‰Leader</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">if</span> err := election.Campaign(ctx, s.nodeID); err != <span class="hljs-literal">nil</span> &#123;            s.logger.Error(<span class="hljs-string">&quot;Failed to campaign for leadership&quot;</span>, zap.Error(err))            <span class="hljs-keyword">return</span>        &#125;                s.logger.Info(<span class="hljs-string">&quot;Became leader&quot;</span>)        s.becameLeader()    &#125;()        <span class="hljs-comment">// ç›‘å¬Leaderå˜åŒ–</span>    ch := election.Observe(ctx)    <span class="hljs-keyword">for</span> resp := <span class="hljs-keyword">range</span> ch &#123;        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(resp.Kvs) &gt; <span class="hljs-number">0</span> &#123;            leader := <span class="hljs-keyword">string</span>(resp.Kvs[<span class="hljs-number">0</span>].Value)            s.logger.Info(<span class="hljs-string">&quot;Leader changed&quot;</span>, zap.String(<span class="hljs-string">&quot;leader&quot;</span>, leader))                        <span class="hljs-keyword">if</span> leader == s.nodeID &#123;                s.isLeader = <span class="hljs-literal">true</span>            &#125; <span class="hljs-keyword">else</span> &#123;                s.isLeader = <span class="hljs-literal">false</span>            &#125;        &#125;    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">becameLeader</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åªåœ¨LeaderèŠ‚ç‚¹ä¸Šæ‰§è¡Œçš„ä»»åŠ¡</span>    <span class="hljs-comment">// ä¾‹å¦‚ï¼šæ•…éšœæ£€æµ‹ä¸ä»»åŠ¡é‡æ–°åˆ†é…</span>    <span class="hljs-keyword">go</span> s.detectFailedNodes()    <span class="hljs-keyword">go</span> s.rebalanceTasks()&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">detectFailedNodes</span><span class="hljs-params">()</span></span> &#123;    ticker := time.NewTicker(<span class="hljs-number">10</span> * time.Second)    <span class="hljs-keyword">defer</span> ticker.Stop()        <span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> ticker.C &#123;        <span class="hljs-keyword">if</span> !s.isLeader &#123;            <span class="hljs-keyword">return</span>        &#125;                <span class="hljs-comment">// è·å–æ‰€æœ‰èŠ‚ç‚¹</span>        nodes, err := s.registry.GetAllNodes()        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            s.logger.Error(<span class="hljs-string">&quot;Failed to get all nodes&quot;</span>, zap.Error(err))            <span class="hljs-keyword">continue</span>        &#125;                <span class="hljs-comment">// æ£€æµ‹ç¦»çº¿èŠ‚ç‚¹</span>        <span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> nodes &#123;            <span class="hljs-keyword">if</span> node.Status == <span class="hljs-string">&quot;offline&quot;</span> || time.Since(node.LastHeartbeat) &gt; <span class="hljs-number">30</span>*time.Second &#123;                s.handleNodeFailure(node)            &#125;        &#125;    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">handleNodeFailure</span><span class="hljs-params">(node *Node)</span></span> &#123;    <span class="hljs-comment">// å°†èŠ‚ç‚¹æ ‡è®°ä¸ºä¸‹çº¿</span>    s.registry.UpdateNodeStatus(node.ID, <span class="hljs-string">&quot;offline&quot;</span>)        <span class="hljs-comment">// è·å–è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ä»»åŠ¡</span>    executions, err := s.store.GetRunningExecutionsByNodeID(node.ID)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        s.logger.Error(<span class="hljs-string">&quot;Failed to get running executions&quot;</span>, zap.Error(err))        <span class="hljs-keyword">return</span>    &#125;        <span class="hljs-comment">// é‡æ–°è°ƒåº¦å¤±è´¥èŠ‚ç‚¹ä¸Šçš„ä»»åŠ¡</span>    <span class="hljs-keyword">for</span> _, execution := <span class="hljs-keyword">range</span> executions &#123;        task, err := s.store.GetTask(execution.TaskID)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">continue</span>        &#125;                <span class="hljs-comment">// å°†ä»»åŠ¡çŠ¶æ€æ›´æ–°ä¸ºå¤±è´¥</span>        execution.Status = <span class="hljs-string">&quot;failed&quot;</span>        execution.Error = <span class="hljs-string">&quot;Node failure&quot;</span>        execution.EndTime = time.Now()        s.store.UpdateExecution(execution)                <span class="hljs-comment">// é‡æ–°å…¥é˜Ÿè¿›è¡Œè°ƒåº¦</span>        s.taskQueue &lt;- task    &#125;        s.logger.Info(<span class="hljs-string">&quot;Completed handling node failure&quot;</span>, zap.String(<span class="hljs-string">&quot;nodeId&quot;</span>, node.ID))&#125;</code></pre><h3 id="ğŸ“Š-å¯è§‚æµ‹æ€§ä¸ç›‘æ§"><a class="header-anchor" href="#ğŸ“Š-å¯è§‚æµ‹æ€§ä¸ç›‘æ§"></a>ğŸ“Š å¯è§‚æµ‹æ€§ä¸ç›‘æ§</h3><h4 id="ç›‘æ§æŒ‡æ ‡è®¾è®¡"><a class="header-anchor" href="#ç›‘æ§æŒ‡æ ‡è®¾è®¡"></a>ç›‘æ§æŒ‡æ ‡è®¾è®¡</h4><p>ä½¿ç”¨Prometheusç›‘æ§å…³é”®æŒ‡æ ‡ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> SchedulerMetrics <span class="hljs-keyword">struct</span> &#123;    TaskScheduled   prometheus.Counter    TaskDispatched  prometheus.Counter    DispatchFailed  prometheus.Counter    ActiveLeaders   prometheus.Gauge&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewSchedulerMetrics</span><span class="hljs-params">()</span> *<span class="hljs-title">SchedulerMetrics</span></span> &#123;    m := &amp;SchedulerMetrics&#123;        TaskScheduled: prometheus.NewCounter(prometheus.CounterOpts&#123;            Name: <span class="hljs-string">&quot;cronex_tasks_scheduled_total&quot;</span>,            Help: <span class="hljs-string">&quot;Total number of tasks scheduled&quot;</span>,        &#125;),        TaskDispatched: prometheus.NewCounter(prometheus.CounterOpts&#123;            Name: <span class="hljs-string">&quot;cronex_tasks_dispatched_total&quot;</span>,            Help: <span class="hljs-string">&quot;Total number of tasks dispatched to executors&quot;</span>,        &#125;),        DispatchFailed: prometheus.NewCounter(prometheus.CounterOpts&#123;            Name: <span class="hljs-string">&quot;cronex_dispatch_failures_total&quot;</span>,            Help: <span class="hljs-string">&quot;Total number of task dispatch failures&quot;</span>,        &#125;),        ActiveLeaders: prometheus.NewGauge(prometheus.GaugeOpts&#123;            Name: <span class="hljs-string">&quot;cronex_active_leaders&quot;</span>,            Help: <span class="hljs-string">&quot;Number of active leaders (should be 1 or 0)&quot;</span>,        &#125;),    &#125;        <span class="hljs-comment">// æ³¨å†ŒæŒ‡æ ‡</span>    prometheus.MustRegister(        m.TaskScheduled,        m.TaskDispatched,        m.DispatchFailed,        m.ActiveLeaders,    )        <span class="hljs-keyword">return</span> m&#125;<span class="hljs-keyword">type</span> ExecutorMetrics <span class="hljs-keyword">struct</span> &#123;    ActiveTasks           prometheus.Gauge    TaskExecutionTime     prometheus.Histogram    TaskExecutionSuccess  prometheus.Counter    TaskExecutionFailures prometheus.Counter&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewExecutorMetrics</span><span class="hljs-params">()</span> *<span class="hljs-title">ExecutorMetrics</span></span> &#123;    m := &amp;ExecutorMetrics&#123;        ActiveTasks: prometheus.NewGauge(prometheus.GaugeOpts&#123;            Name: <span class="hljs-string">&quot;cronex_executor_active_tasks&quot;</span>,            Help: <span class="hljs-string">&quot;Number of active tasks currently being executed&quot;</span>,        &#125;),        TaskExecutionTime: prometheus.NewHistogram(prometheus.HistogramOpts&#123;            Name:    <span class="hljs-string">&quot;cronex_task_execution_time_seconds&quot;</span>,            Help:    <span class="hljs-string">&quot;Distribution of task execution time in seconds&quot;</span>,            Buckets: prometheus.DefBuckets,        &#125;),        TaskExecutionSuccess: prometheus.NewCounter(prometheus.CounterOpts&#123;            Name: <span class="hljs-string">&quot;cronex_task_execution_success_total&quot;</span>,            Help: <span class="hljs-string">&quot;Total number of successful task executions&quot;</span>,        &#125;),        TaskExecutionFailures: prometheus.NewCounter(prometheus.CounterOpts&#123;            Name: <span class="hljs-string">&quot;cronex_task_execution_failures_total&quot;</span>,            Help: <span class="hljs-string">&quot;Total number of failed task executions&quot;</span>,        &#125;),    &#125;        <span class="hljs-comment">// æ³¨å†ŒæŒ‡æ ‡</span>    prometheus.MustRegister(        m.ActiveTasks,        m.TaskExecutionTime,        m.TaskExecutionSuccess,        m.TaskExecutionFailures,    )        <span class="hljs-keyword">return</span> m&#125;</code></pre><h3 id="ğŸ“-æ€§èƒ½ä¼˜åŒ–ä¸æ‰©å±•"><a class="header-anchor" href="#ğŸ“-æ€§èƒ½ä¼˜åŒ–ä¸æ‰©å±•"></a>ğŸ“ æ€§èƒ½ä¼˜åŒ–ä¸æ‰©å±•</h3><h4 id="æ‰¹é‡ä»»åŠ¡è°ƒåº¦"><a class="header-anchor" href="#æ‰¹é‡ä»»åŠ¡è°ƒåº¦"></a>æ‰¹é‡ä»»åŠ¡è°ƒåº¦</h4><p>å¯¹äºé«˜é¢‘å®šæ—¶ä»»åŠ¡ï¼Œå¯ä»¥é‡‡ç”¨æ‰¹é‡å¤„ç†æ–¹å¼æé«˜æ•ˆç‡ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">batchProcessTasks</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// ä½¿ç”¨æ—¶é—´çª—å£æ”¶é›†ä»»åŠ¡</span>    window := <span class="hljs-number">500</span> * time.Millisecond    batchSize := <span class="hljs-number">1000</span>        <span class="hljs-keyword">var</span> tasks []*Task    timer := time.NewTimer(window)        <span class="hljs-keyword">for</span> &#123;        <span class="hljs-keyword">select</span> &#123;        <span class="hljs-keyword">case</span> task := &lt;-s.taskQueue:            tasks = <span class="hljs-built_in">append</span>(tasks, task)            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tasks) &gt;= batchSize &#123;                s.processBatch(tasks)                tasks = tasks[:<span class="hljs-number">0</span>] <span class="hljs-comment">// æ¸…ç©º</span>                timer.Reset(window)            &#125;        <span class="hljs-keyword">case</span> &lt;-timer.C:            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tasks) &gt; <span class="hljs-number">0</span> &#123;                s.processBatch(tasks)                tasks = tasks[:<span class="hljs-number">0</span>] <span class="hljs-comment">// æ¸…ç©º</span>            &#125;            timer.Reset(window)        &#125;    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span> <span class="hljs-title">processBatch</span><span class="hljs-params">(tasks []*Task)</span></span> &#123;    <span class="hljs-comment">// æŒ‰æ‰§è¡ŒèŠ‚ç‚¹åˆ†ç»„</span>    nodeGroups := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>][]*Task)    <span class="hljs-keyword">for</span> _, task := <span class="hljs-keyword">range</span> tasks &#123;        node, err := s.allocateExecutionNode(task)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            s.logger.Error(<span class="hljs-string">&quot;Failed to allocate node for task&quot;</span>, zap.Error(err))            <span class="hljs-keyword">continue</span>        &#125;                nodeGroups[node.ID] = <span class="hljs-built_in">append</span>(nodeGroups[node.ID], task)    &#125;        <span class="hljs-comment">// å¹¶è¡Œåˆ†å‘ä»»åŠ¡åˆ°å„èŠ‚ç‚¹</span>    <span class="hljs-keyword">var</span> wg sync.WaitGroup    <span class="hljs-keyword">for</span> nodeID, nodeTasks := <span class="hljs-keyword">range</span> nodeGroups &#123;        wg.Add(<span class="hljs-number">1</span>)        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(nodeID <span class="hljs-keyword">string</span>, tasks []*Task)</span></span> &#123;            <span class="hljs-keyword">defer</span> wg.Done()            s.batchDispatchToNode(nodeID, tasks)        &#125;(nodeID, nodeTasks)    &#125;    wg.Wait()&#125;</code></pre><h4 id="å¤šçº§ä»»åŠ¡é˜Ÿåˆ—"><a class="header-anchor" href="#å¤šçº§ä»»åŠ¡é˜Ÿåˆ—"></a>å¤šçº§ä»»åŠ¡é˜Ÿåˆ—</h4><p>ä¸ºä»»åŠ¡è®¾ç½®ä¼˜å…ˆçº§ï¼Œç¡®ä¿é‡è¦ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> PriorityQueue <span class="hljs-keyword">struct</span> &#123;    highPriority    <span class="hljs-keyword">chan</span> *Task    normalPriority  <span class="hljs-keyword">chan</span> *Task    lowPriority     <span class="hljs-keyword">chan</span> *Task&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPriorityQueue</span><span class="hljs-params">()</span> *<span class="hljs-title">PriorityQueue</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;PriorityQueue&#123;        highPriority:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Task, <span class="hljs-number">1000</span>),        normalPriority: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Task, <span class="hljs-number">5000</span>),        lowPriority:    <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Task, <span class="hljs-number">10000</span>),    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *PriorityQueue)</span> <span class="hljs-title">Push</span><span class="hljs-params">(task *Task, priority <span class="hljs-keyword">string</span>)</span></span> &#123;    <span class="hljs-keyword">switch</span> priority &#123;    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;high&quot;</span>:        q.highPriority &lt;- task    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;low&quot;</span>:        q.lowPriority &lt;- task    <span class="hljs-keyword">default</span>:        q.normalPriority &lt;- task    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *PriorityQueue)</span> <span class="hljs-title">Pop</span><span class="hljs-params">()</span> *<span class="hljs-title">Task</span></span> &#123;    <span class="hljs-comment">// ä¼˜å…ˆä»é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—å–ä»»åŠ¡</span>    <span class="hljs-keyword">select</span> &#123;    <span class="hljs-keyword">case</span> task := &lt;-q.highPriority:        <span class="hljs-keyword">return</span> task    <span class="hljs-keyword">default</span>:    &#125;        <span class="hljs-comment">// å…¶æ¬¡ä»æ™®é€šä¼˜å…ˆçº§é˜Ÿåˆ—å–ä»»åŠ¡</span>    <span class="hljs-keyword">select</span> &#123;    <span class="hljs-keyword">case</span> task := &lt;-q.normalPriority:        <span class="hljs-keyword">return</span> task    <span class="hljs-keyword">default</span>:    &#125;        <span class="hljs-comment">// æœ€åä»ä½ä¼˜å…ˆçº§é˜Ÿåˆ—å–ä»»åŠ¡</span>    <span class="hljs-keyword">select</span> &#123;    <span class="hljs-keyword">case</span> task := &lt;-q.lowPriority:        <span class="hljs-keyword">return</span> task    <span class="hljs-keyword">default</span>:    &#125;        <span class="hljs-comment">// æ‰€æœ‰é˜Ÿåˆ—éƒ½ç©ºï¼Œé˜»å¡ç­‰å¾…ä»»åŠ¡</span>    <span class="hljs-keyword">select</span> &#123;    <span class="hljs-keyword">case</span> task := &lt;-q.highPriority:        <span class="hljs-keyword">return</span> task    <span class="hljs-keyword">case</span> task := &lt;-q.normalPriority:        <span class="hljs-keyword">return</span> task    <span class="hljs-keyword">case</span> task := &lt;-q.lowPriority:        <span class="hljs-keyword">return</span> task    &#125;&#125;</code></pre><h3 id="ğŸ“‹-æ€»ç»“ä¸æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸ“‹-æ€»ç»“ä¸æœ€ä½³å®è·µ"></a>ğŸ“‹ æ€»ç»“ä¸æœ€ä½³å®è·µ</h3><p>é€šè¿‡æœ¬æ–‡çš„å®ç°ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹çš„åˆ†å¸ƒå¼ä»»åŠ¡ç³»ç»Ÿï¼š</p><ol><li><strong>é«˜å¯ç”¨</strong>ï¼šå¤šè°ƒåº¦å™¨è®¾è®¡ï¼ŒLeaderé€‰ä¸¾æœºåˆ¶</li><li><strong>æ°´å¹³æ‰©å±•</strong>ï¼šåŠ¨æ€èŠ‚ç‚¹å‘ç°ï¼Œä»»åŠ¡å‡è¡¡åˆ†é…</li><li><strong>ä»»åŠ¡ç²¾ç¡®æ€§</strong>ï¼šåˆ†å¸ƒå¼é”é˜²æ­¢ä»»åŠ¡é‡å¤æ‰§è¡Œ</li><li><strong>æ•…éšœæ¢å¤</strong>ï¼šèŠ‚ç‚¹æ•…éšœè‡ªåŠ¨æ£€æµ‹ä¸ä»»åŠ¡é‡æ–°åˆ†é…</li><li><strong>å¯è§‚æµ‹æ€§</strong>ï¼šå®Œå–„çš„ç›‘æ§æŒ‡æ ‡å’Œæ—¥å¿—ç³»ç»Ÿ</li></ol><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜åº”æ³¨æ„ä»¥ä¸‹æœ€ä½³å®è·µï¼š</p><ul><li><strong>ä»»åŠ¡å¹‚ç­‰æ€§</strong>ï¼šè®¾è®¡ä»»åŠ¡æ—¶ç¡®ä¿å¤šæ¬¡æ‰§è¡Œäº§ç”Ÿç›¸åŒç»“æœ</li><li><strong>éš”ç¦»ç¯å¢ƒ</strong>ï¼šä¸ºä»»åŠ¡æä¾›éš”ç¦»çš„æ‰§è¡Œç¯å¢ƒï¼Œé˜²æ­¢ç›¸äº’å½±å“</li><li><strong>èµ„æºé™åˆ¶</strong>ï¼šå¯¹ä»»åŠ¡ä½¿ç”¨çš„CPUã€å†…å­˜ç­‰èµ„æºè¿›è¡Œé™åˆ¶</li><li><strong>ç°åº¦å‘å¸ƒ</strong>ï¼šæ–°ä»»åŠ¡å…ˆåœ¨å°‘é‡èŠ‚ç‚¹ä¸Šè¿è¡Œï¼ŒéªŒè¯æ— è¯¯åå†å…¨é¢éƒ¨ç½²</li><li><strong>å®‰å…¨æ€§</strong>ï¼šå®ç°è®¿é—®æ§åˆ¶å’Œæ•æ„Ÿæ•°æ®åŠ å¯†</li></ul><p>åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿæ˜¯ç°ä»£å¾®æœåŠ¡æ¶æ„ä¸­ä¸å¯æˆ–ç¼ºçš„åŸºç¡€ç»„ä»¶ã€‚é€šè¿‡Goè¯­è¨€çš„å¹¶å‘ä¼˜åŠ¿å’Œä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºå‡ºé«˜æ€§èƒ½ã€å¯é çš„è§£å†³æ–¹æ¡ˆï¼Œä¸ºå„ç§åœºæ™¯æä¾›ç¨³å®šçš„è°ƒåº¦æœåŠ¡ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
      <category>åˆ†å¸ƒå¼ç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>åˆ†å¸ƒå¼ç³»ç»Ÿ</tag>
      
      <tag>å®šæ—¶ä»»åŠ¡</tag>
      
      <tag>é«˜æ€§èƒ½</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>goroutine åç¨‹æ± </title>
    <link href="/2024/08/27/goroutine-%E5%8D%8F%E7%A8%8B%E6%B1%A0/"/>
    <url>/2024/08/27/goroutine-%E5%8D%8F%E7%A8%8B%E6%B1%A0/</url>
    
    <content type="html"><![CDATA[<h2 id="Go-è¯­è¨€å®ç°åç¨‹æ± "><a class="header-anchor" href="#Go-è¯­è¨€å®ç°åç¨‹æ± "></a>Go è¯­è¨€å®ç°åç¨‹æ± </h2><h3 id="ğŸˆæ ¸å¿ƒæ€è·¯"><a class="header-anchor" href="#ğŸˆæ ¸å¿ƒæ€è·¯"></a>ğŸˆæ ¸å¿ƒæ€è·¯</h3><ul><li>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</li><li>é€šè¿‡ <code>channel</code> ä½œä¸ºä»»åŠ¡æŠ•é€’æ¸ é“</li><li>å¼‚æ­¥æ‰§è¡Œé—­åŒ… <code>handler</code></li><li>é€šè¿‡ <code>context</code>  åšä»»åŠ¡æ‰§è¡Œå®ä½“çš„è¶…æ—¶æ§åˆ¶</li><li>åç¨‹æ± ä¼˜é›…é€€å‡ºæœºåˆ¶ï¼Œé¿å…å¼‚æ­¥å‡½æ•°æ‰§è¡Œè¢«æš´åŠ›ç»ˆæ­¢</li></ul><h3 id="ğŸ“„Talk-is-cheap-Show-me-code"><a class="header-anchor" href="#ğŸ“„Talk-is-cheap-Show-me-code"></a>ğŸ“„Talk is cheap, Show me code</h3><h4 id="å®ç°ä»£ç "><a class="header-anchor" href="#å®ç°ä»£ç "></a>å®ç°ä»£ç </h4><pre><code class="hljs go"><span class="hljs-keyword">package</span> pool<span class="hljs-keyword">import</span> (<span class="hljs-string">&quot;context&quot;</span><span class="hljs-string">&quot;errors&quot;</span><span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-string">&quot;sync&quot;</span><span class="hljs-string">&quot;sync/atomic&quot;</span><span class="hljs-string">&quot;time&quot;</span><span class="hljs-string">&quot;gitlab.com/bopop/log&quot;</span>)<span class="hljs-comment">// Worker ä»»åŠ¡å·¥ä½œæ¥å£</span><span class="hljs-keyword">type</span> Worker <span class="hljs-keyword">interface</span> &#123;<span class="hljs-comment">// Task ä»»åŠ¡</span>Task() error&#125;<span class="hljs-comment">// TaskHandler ä»»åŠ¡å®ä½“,é¿å…é€ æˆ goroutine æ³„éœ²è¯·å‹¿ä½œä¸ºä¸€ä¸ªé•¿æœŸï¼ˆå¸¸é©»ï¼‰çš„å·¥ä½œä»»åŠ¡</span><span class="hljs-keyword">type</span> TaskHandler <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, params any)</span> <span class="hljs-title">error</span></span><span class="hljs-comment">// Process ä»»åŠ¡å®ä½“</span><span class="hljs-keyword">type</span> Process <span class="hljs-keyword">struct</span> &#123;<span class="hljs-comment">// Ctx ä»»åŠ¡ä¸Šä¸‹æ–‡</span>ctx context.Context<span class="hljs-comment">// Cancel ä»»åŠ¡ä¸Šä¸‹æ–‡å–æ¶ˆå‡½æ•°</span>cancel context.CancelFunc<span class="hljs-comment">// Params ä»»åŠ¡å¤„ç†æ•°æ®</span>Params any<span class="hljs-comment">// TaskFunc ä»»åŠ¡å®ä½“</span>TaskFunc TaskHandler<span class="hljs-comment">// Timeout ä»»åŠ¡è¶…æ—¶æ—¶é—´</span>Timeout time.Duration&#125;<span class="hljs-comment">// DefaultTimeout é»˜è®¤è¶…æ—¶æ—¶é—´</span><span class="hljs-keyword">const</span> DefaultTimeout = <span class="hljs-number">5</span> * time.Second<span class="hljs-comment">// WithTimeout è®¾ç½®ä»»åŠ¡è¶…æ—¶æ—¶é—´ (ç§’)</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithTimeout</span><span class="hljs-params">(timeout time.Duration)</span> <span class="hljs-title">func</span><span class="hljs-params">(*Process)</span></span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w *Process)</span></span> &#123;w.Timeout = timeout * time.Second&#125;&#125;<span class="hljs-comment">// WithParams è®¾ç½®ä»»åŠ¡å¤„ç†æ•°æ®</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithParams</span><span class="hljs-params">(params any)</span> <span class="hljs-title">func</span><span class="hljs-params">(*Process)</span></span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w *Process)</span></span> &#123;w.Params = params&#125;&#125;<span class="hljs-comment">// Task æ‰§è¡Œä»»åŠ¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Process)</span> <span class="hljs-title">Task</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<span class="hljs-keyword">return</span> p.TaskFunc(p.ctx, p.Params)&#125;<span class="hljs-comment">// NewProcess åˆ›å»ºä»»åŠ¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewProcess</span><span class="hljs-params">(taskFunc TaskHandler, opts ...<span class="hljs-keyword">func</span>(*Process)</span>) *<span class="hljs-title">Process</span></span> &#123;<span class="hljs-keyword">if</span> taskFunc == <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;p := &amp;Process&#123;TaskFunc: taskFunc,Timeout:  DefaultTimeout,&#125;<span class="hljs-keyword">for</span> _, opt := <span class="hljs-keyword">range</span> opts &#123;opt(p)&#125;<span class="hljs-keyword">return</span> p&#125;<span class="hljs-comment">// WorkerPool å·¥ä½œæ± </span><span class="hljs-keyword">type</span> WorkerPool <span class="hljs-keyword">struct</span> &#123;work <span class="hljs-keyword">chan</span> Workerwg   sync.WaitGroupsync.OncerunNum <span class="hljs-keyword">uint32</span>&#125;<span class="hljs-keyword">var</span> pools []*WorkerPool<span class="hljs-comment">// NewPool åˆ›å»ºå·¥ä½œæ± </span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPool</span><span class="hljs-params">(<span class="hljs-built_in">cap</span> <span class="hljs-keyword">int</span>)</span> *<span class="hljs-title">WorkerPool</span></span> &#123;p := &amp;WorkerPool&#123;work: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Worker),&#125;<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">cap</span>; i++ &#123;p.wg.Add(<span class="hljs-number">1</span>)<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;p.wg.Done()atomic.AddUint32(&amp;p.runNum, ^<span class="hljs-keyword">uint32</span>(<span class="hljs-number">0</span>))&#125;()<span class="hljs-keyword">for</span> w := <span class="hljs-keyword">range</span> p.work &#123;process := w.(*Process) <span class="hljs-comment">//nolint:errcheck</span>process.ctx, process.cancel = context.WithTimeout(context.Background(), process.Timeout)execTask(process)&#125;&#125;()atomic.AddUint32(&amp;p.runNum, <span class="hljs-number">1</span>)&#125;add(p)<span class="hljs-keyword">return</span> p&#125;<span class="hljs-comment">// execTask æ‰§è¡Œä»»åŠ¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">execTask</span><span class="hljs-params">(w *Process)</span></span> &#123;<span class="hljs-keyword">defer</span> w.cancel()done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<span class="hljs-keyword">var</span> err error<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;err = w.Task()<span class="hljs-built_in">close</span>(done)&#125;()<span class="hljs-keyword">select</span> &#123;<span class="hljs-keyword">case</span> &lt;-w.ctx.Done():log.Error(fmt.Sprintf(<span class="hljs-string">&quot;ä»»åŠ¡æ‰§è¡Œè¶…æ—¶: %v&quot;</span>, w.ctx.Err()))<span class="hljs-keyword">return</span><span class="hljs-keyword">case</span> &lt;-done:<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;log.Error(fmt.Sprintf(<span class="hljs-string">&quot;ä»»åŠ¡æ‰§è¡Œå¤±è´¥: %v&quot;</span>, err))&#125;<span class="hljs-keyword">return</span>&#125;&#125;<span class="hljs-comment">// Delivery æŠ•é€’ä»»åŠ¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *WorkerPool)</span> <span class="hljs-title">Delivery</span><span class="hljs-params">(w Worker)</span> <span class="hljs-title">error</span></span> &#123;<span class="hljs-keyword">if</span> w == <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;delivery task is nil&quot;</span>)&#125;p.work &lt;- w<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// Close å…³é—­å·¥ä½œæ± </span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *WorkerPool)</span> <span class="hljs-title">Close</span><span class="hljs-params">()</span></span> &#123;p.Once.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-built_in">close</span>(p.work)p.wg.Wait()&#125;)&#125;<span class="hljs-comment">// Add è®°å½•æ–°å¢çš„å·¥ä½œæ± </span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">(p *WorkerPool)</span></span> &#123;pools = <span class="hljs-built_in">append</span>(pools, p)&#125;<span class="hljs-comment">// PoolsShutdown å…³é—­æ‰€æœ‰çš„å·¥ä½œæ± </span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PoolsShutdown</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(pools) &gt; <span class="hljs-number">0</span> &#123;<span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> pools &#123;p.Close()&#125;&#125;&#125;</code></pre><p><strong>æ³¨æ„ï¼š<code>gitlab.com/bopop/log</code> ä¸ºç§æœ‰ç»„ä»¶ï¼Œè‹¥è¦æµ‹è¯•æœ¬ä»£ç è¯·æ³¨é‡Šæˆ–ä½¿ç”¨è‡ªç”¨ç»„ä»¶</strong></p><h4 id="Testing"><a class="header-anchor" href="#Testing"></a>Testing</h4><pre><code class="hljs go"><span class="hljs-keyword">package</span> pool<span class="hljs-keyword">import</span> (<span class="hljs-string">&quot;context&quot;</span><span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-string">&quot;math/rand&quot;</span><span class="hljs-string">&quot;runtime&quot;</span><span class="hljs-string">&quot;sync&quot;</span><span class="hljs-string">&quot;testing&quot;</span><span class="hljs-string">&quot;time&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">random</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;<span class="hljs-comment">// ä»¥å½“å‰æ—¶é—´ç”Ÿæˆç§å­</span>rand.Seed(time.Now().UnixNano())<span class="hljs-comment">// è®¾å®šèŒƒå›´</span>min := <span class="hljs-number">1</span>max := <span class="hljs-number">10</span><span class="hljs-comment">// ç”Ÿæˆ min åˆ° max èŒƒå›´å†…çš„éšæœºæ•°</span><span class="hljs-keyword">return</span> rand.Intn(max-min+<span class="hljs-number">1</span>) + min&#125;<span class="hljs-comment">// Task å®šä¹‰è¦æ‰§è¡Œçš„ä»»åŠ¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Task</span><span class="hljs-params">(ctx context.Context, extra any)</span> <span class="hljs-title">error</span></span> &#123;randNum := extra.(<span class="hljs-keyword">int</span>) <span class="hljs-comment">//nolint:errcheck</span>time.Sleep(time.Duration(randNum) * time.Second)<span class="hljs-keyword">if</span> randNum%<span class="hljs-number">2</span> == <span class="hljs-number">0</span> &#123;<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;randNum = %d, worker failed1&quot;</span>, randNum)&#125;<span class="hljs-comment">// æ¨¡æ‹Ÿ context deadline ç»ˆæ­¢</span><span class="hljs-keyword">if</span> ctx.Err() != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;randNum = %d, worker failed2&quot;</span>, randNum)&#125;fmt.Printf(<span class="hljs-string">&quot;randNum = %d, worker finished\n&quot;</span>, randNum)<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// TestNewPool æµ‹è¯• NewPool å‡½æ•°çš„åˆ›å»ºå·¥ä½œæ± è¡Œä¸ºæ˜¯å¦æ­£å¸¸</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestNewPool</span><span class="hljs-params">(t *testing.T)</span></span> &#123;wg := sync.WaitGroup&#123;&#125;wg.Add(<span class="hljs-number">1</span>)<span class="hljs-keyword">var</span> p *WorkerPool<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">defer</span> wg.Done()p = NewPool(<span class="hljs-number">5</span>)&#125;()wg.Wait()<span class="hljs-keyword">defer</span> p.Close()<span class="hljs-keyword">if</span> p.runNum != <span class="hljs-number">5</span> &#123;t.Errorf(<span class="hljs-string">&quot;Expected pool size of %d, but got %d&quot;</span>, <span class="hljs-number">5</span>, <span class="hljs-built_in">cap</span>(p.work))&#125;&#125;<span class="hljs-comment">// TestWorkerPool_Run æµ‹è¯•å·¥ä½œæ± èƒ½å¦æ­£å¸¸è¿è¡Œä»»åŠ¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestWorkerPool_Run</span><span class="hljs-params">(t *testing.T)</span></span> &#123;p := NewPool(runtime.NumCPU())<span class="hljs-comment">// ä¿è¯ pool åˆå§‹åŒ–</span>time.Sleep(<span class="hljs-number">300</span> * time.Millisecond)<span class="hljs-keyword">defer</span> p.Close()<span class="hljs-keyword">var</span> wg sync.WaitGrouptaskCount := <span class="hljs-number">5</span>wg.Add(taskCount)<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; taskCount; i++ &#123;<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span></span> &#123;<span class="hljs-keyword">defer</span> wg.Done()randNum := random()fmt.Println(<span class="hljs-string">&quot;randNum = &quot;</span>, randNum)process := NewProcess(Task, WithParams(randNum), WithTimeout(<span class="hljs-number">5</span>))p.Delivery(process)&#125;(i)time.Sleep(<span class="hljs-number">300</span> * time.Millisecond)&#125;wg.Wait()&#125;<span class="hljs-comment">// TestWorkerPool_Close æµ‹è¯• Close å‡½æ•°èƒ½å¦æ­£ç¡®å…³é—­å¹¶å®Œæˆæ‰€æœ‰ä»»åŠ¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestWorkerPool_Close</span><span class="hljs-params">(t *testing.T)</span></span> &#123;p := NewPool(<span class="hljs-number">2</span>)time.Sleep(<span class="hljs-number">300</span> * time.Millisecond)<span class="hljs-keyword">defer</span> p.Close() <span class="hljs-comment">// é€€å‡ºæ—¶å…³é—­</span><span class="hljs-keyword">var</span> counter <span class="hljs-keyword">int</span><span class="hljs-keyword">var</span> wg sync.WaitGroupwg.Add(<span class="hljs-number">1</span>)<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">defer</span> wg.Done()<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;process := NewProcess(Task, WithParams(counter))p.Delivery(process)&#125;&#125;()wg.Wait()p.Close() <span class="hljs-comment">// ç¬¬ä¸€æ¬¡æ˜¾ç¤ºå…³é—­ï¼Œæµ‹è¯•å¤šæ¬¡å…³é—­</span>finalCount := counter<span class="hljs-keyword">if</span> finalCount != <span class="hljs-number">0</span> &#123;t.Errorf(<span class="hljs-string">&quot;expected counter to be 0, got %d&quot;</span>, finalCount)&#125;&#125;<span class="hljs-comment">// TestPoolsShutdown æµ‹è¯• PoolsShutdown å‡½æ•°èƒ½å¦å…³é—­æ‰€æœ‰å·¥ä½œæ± </span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestPoolsShutdown</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<span class="hljs-comment">// åˆ›å»ºå¹¶æ·»åŠ å‡ ä¸ªå·¥ä½œæ± </span><span class="hljs-keyword">var</span> wg sync.WaitGroupwg.Add(<span class="hljs-number">3</span>)<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ &#123;<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">defer</span> wg.Done()NewPool(<span class="hljs-number">3</span>)&#125;()&#125;wg.Wait()PoolsShutdown()<span class="hljs-comment">// éªŒè¯å·¥ä½œæ± æ˜¯å¦å…¨éƒ¨å…³é—­</span><span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> pools &#123;<span class="hljs-keyword">select</span> &#123;<span class="hljs-keyword">case</span> _, ok := &lt;-p.work:<span class="hljs-keyword">if</span> ok &#123;t.Errorf(<span class="hljs-string">&quot;work channel should be closed&quot;</span>)&#125;<span class="hljs-keyword">default</span>:t.Errorf(<span class="hljs-string">&quot;work channel should be closed and empty&quot;</span>)&#125;&#125;&#125;</code></pre><p><em>æ³¨é‡Šæ¯”è¾ƒå…¨äº†åº”è¯¥å¾ˆå®¹æ˜“çœ‹æ‡‚äº†å“ˆğŸ˜</em></p>]]></content>
    
    
    
    <tags>
      
      <tag>golangã€channelã€goroutineã€context</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åŸºäºGitOpsçš„äº‘åŸç”ŸDevOpså®è·µæŒ‡å—</title>
    <link href="/2024/08/25/%E5%9F%BA%E4%BA%8EGitOps%E7%9A%84%E4%BA%91%E5%8E%9F%E7%94%9FDevOps%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/"/>
    <url>/2024/08/25/%E5%9F%BA%E4%BA%8EGitOps%E7%9A%84%E4%BA%91%E5%8E%9F%E7%94%9FDevOps%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ”„-åŸºäºGitOpsçš„äº‘åŸç”ŸDevOpså®è·µæŒ‡å—"><a class="header-anchor" href="#ğŸ”„-åŸºäºGitOpsçš„äº‘åŸç”ŸDevOpså®è·µæŒ‡å—"></a>ğŸ”„ åŸºäºGitOpsçš„äº‘åŸç”ŸDevOpså®è·µæŒ‡å—</h2><p>éšç€äº‘åŸç”ŸæŠ€æœ¯çš„æ™®åŠï¼ŒGitOpså·²æˆä¸ºç°ä»£DevOpså®è·µçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨GitOpsçš„æ ¸å¿ƒç†å¿µã€æŠ€æœ¯å®ç°ä»¥åŠåœ¨ä¼ä¸šä¸­çš„æœ€ä½³å®è·µï¼Œå¸®åŠ©å›¢é˜Ÿæ„å»ºæ›´åŠ è‡ªåŠ¨åŒ–ã€å¯é çš„äº‘åŸç”Ÿäº¤ä»˜æµç¨‹ã€‚</p><h3 id="ğŸ“Š-GitOpsæ ¸å¿ƒç†å¿µ"><a class="header-anchor" href="#ğŸ“Š-GitOpsæ ¸å¿ƒç†å¿µ"></a>ğŸ“Š GitOpsæ ¸å¿ƒç†å¿µ</h3><p>GitOpsæ˜¯ä¸€ç§è¿›è¡ŒKubernetesé›†ç¾¤ç®¡ç†å’Œåº”ç”¨ç¨‹åºäº¤ä»˜çš„æ–¹æ³•ï¼Œå®ƒä½¿ç”¨Gitä½œä¸ºæ•´ä¸ªç³»ç»Ÿçš„å”¯ä¸€äº‹å®æ¥æº(Single Source of Truth)ï¼Œå¹¶è‡ªåŠ¨åŒ–äº¤ä»˜è¿‡ç¨‹çš„æ–¹æ–¹é¢é¢ã€‚</p><h4 id="GitOpsçš„å››å¤§åŸåˆ™"><a class="header-anchor" href="#GitOpsçš„å››å¤§åŸåˆ™"></a>GitOpsçš„å››å¤§åŸåˆ™</h4><ol><li><strong>å£°æ˜å¼ç³»ç»Ÿæè¿°</strong>ï¼šç³»ç»Ÿçš„æ‰€æœ‰é…ç½®å¿…é¡»ä»¥å£°æ˜å¼å®šä¹‰ï¼Œå¹¶ä¿å­˜åœ¨Gitä¸­</li><li><strong>Gitä½œä¸ºå”¯ä¸€äº‹å®æ¥æº</strong>ï¼šç³»ç»ŸçŠ¶æ€çš„æœŸæœ›ç‰ˆæœ¬åº”è¯¥åœ¨Gitä¸­è¢«ç‰ˆæœ¬åŒ–</li><li><strong>è‡ªåŠ¨å˜æ›´åº”ç”¨</strong>ï¼šç³»ç»Ÿå˜æ›´ç”±è‡ªåŠ¨åŒ–ç³»ç»Ÿä»Gitä¸­æ‹‰å–å¹¶åº”ç”¨</li><li><strong>è‡ªæ„ˆä¸æ¼‚ç§»æ£€æµ‹</strong>ï¼šç³»ç»Ÿèƒ½å¤Ÿæ£€æµ‹å®é™…çŠ¶æ€ä¸æœŸæœ›çŠ¶æ€çš„åå·®å¹¶è‡ªåŠ¨ä¿®æ­£</li></ol><h4 id="ä¼ ç»ŸCI-CDä¸GitOpså¯¹æ¯”"><a class="header-anchor" href="#ä¼ ç»ŸCI-CDä¸GitOpså¯¹æ¯”"></a>ä¼ ç»ŸCI/CDä¸GitOpså¯¹æ¯”</h4><table><thead><tr><th>ä¼ ç»ŸCI/CD</th><th>GitOps</th></tr></thead><tbody><tr><td>åŸºäºæ¨é€(Push)æµç¨‹</td><td>åŸºäºæ‹‰å–(Pull)æµç¨‹</td></tr><tr><td>CIå·¥å…·è´Ÿè´£éƒ¨ç½²</td><td>éƒ¨ç½²ç”±é›†ç¾¤å†…çš„è¿ç®—ç¬¦æ‰§è¡Œ</td></tr><tr><td>éœ€è¦æä¾›å¤–éƒ¨ç³»ç»Ÿå¯¹é›†ç¾¤çš„è®¿é—®æƒé™</td><td>æ— éœ€å‘å¤–éƒ¨ç³»ç»Ÿæä¾›é›†ç¾¤å‡­æ®</td></tr><tr><td>éƒ¨ç½²çŠ¶æ€éš¾ä»¥è·Ÿè¸ª</td><td>çŠ¶æ€éšæ—¶å¯è§ï¼Œä¾¿äºå®¡è®¡å’Œå›æ»š</td></tr><tr><td>éš¾ä»¥æ‰©å±•å’Œè·¨å›¢é˜Ÿåä½œ</td><td>æ˜“äºæ‰©å±•å’Œå®ç°å¤šé›†ç¾¤ã€å¤šå›¢é˜Ÿç®¡ç†</td></tr></tbody></table><h3 id="ğŸ› ï¸-GitOpså·¥å…·ç”Ÿæ€"><a class="header-anchor" href="#ğŸ› ï¸-GitOpså·¥å…·ç”Ÿæ€"></a>ğŸ› ï¸ GitOpså·¥å…·ç”Ÿæ€</h3><h4 id="å¸¸è§GitOpså·¥å…·å¯¹æ¯”"><a class="header-anchor" href="#å¸¸è§GitOpså·¥å…·å¯¹æ¯”"></a>å¸¸è§GitOpså·¥å…·å¯¹æ¯”</h4><ol><li><strong>Flux CD</strong></li></ol><p><a href="https://fluxcd.io/">Flux</a> æ˜¯CNCFå­µåŒ–çš„GitOpså·¥å…·ï¼Œä¸“æ³¨äºè‡ªåŠ¨åŒ–éƒ¨ç½²åº”ç”¨å’Œé…ç½®ã€‚</p><p><strong>ä¼˜åŠ¿ï¼š</strong></p><ul><li>å†…ç½®å¤šé›†ç¾¤æ”¯æŒ</li><li>å¼ºå¤§çš„Kubernetesæ¸…å•ç®¡ç†</li><li>æ”¯æŒHelmã€Kustomizeç­‰å·¥å…·</li><li>é€šçŸ¥é›†æˆï¼ˆSlackã€Discordç­‰ï¼‰</li></ul><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> é€‚åˆéœ€è¦å¤šé›†ç¾¤ç®¡ç†å’Œå¼ºå¤§å®šåˆ¶èƒ½åŠ›çš„å›¢é˜Ÿ</p><pre><code class="hljs yaml"><span class="hljs-comment"># FluxåŸºæœ¬ç¤ºä¾‹ - GitRepository</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">source.toolkit.fluxcd.io/v1beta2</span><span class="hljs-attr">kind:</span> <span class="hljs-string">GitRepository</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">app-repo</span>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">flux-system</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">interval:</span> <span class="hljs-string">1m</span>  <span class="hljs-attr">url:</span> <span class="hljs-string">https://github.com/example/app-repo</span>  <span class="hljs-attr">ref:</span>    <span class="hljs-attr">branch:</span> <span class="hljs-string">main</span><span class="hljs-meta">---</span><span class="hljs-comment"># Kustomizationèµ„æº</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kustomize.toolkit.fluxcd.io/v1beta2</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Kustomization</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">app-kustomization</span>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">flux-system</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">interval:</span> <span class="hljs-string">10m</span>  <span class="hljs-attr">path:</span> <span class="hljs-string">&quot;./k8s&quot;</span>  <span class="hljs-attr">prune:</span> <span class="hljs-literal">true</span>  <span class="hljs-attr">sourceRef:</span>    <span class="hljs-attr">kind:</span> <span class="hljs-string">GitRepository</span>    <span class="hljs-attr">name:</span> <span class="hljs-string">app-repo</span>  <span class="hljs-attr">targetNamespace:</span> <span class="hljs-string">default</span></code></pre><ol start="2"><li><strong>ArgoCD</strong></li></ol><p><a href="https://argoproj.github.io/argo-cd/">ArgoCD</a> æ˜¯ä¸€ä¸ªGitOpsæŒç»­äº¤ä»˜å·¥å…·ï¼Œä¸“ä¸ºKubernetesè®¾è®¡ã€‚</p><p><strong>ä¼˜åŠ¿ï¼š</strong></p><ul><li>ç›´è§‚çš„Web UIå’Œä¸°å¯Œçš„å¯è§†åŒ–</li><li>æ”¯æŒå¤šç§åŒæ­¥ç­–ç•¥å’Œå¥åº·æ£€æŸ¥</li><li>ç»†ç²’åº¦RBACå’ŒSSOé›†æˆ</li><li>å¼ºå¤§çš„åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†</li></ul><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> é€‚åˆéœ€è¦å¼ºå¤§UIå’Œå¤æ‚åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„å›¢é˜Ÿ</p><pre><code class="hljs yaml"><span class="hljs-comment"># ArgoCD Applicationç¤ºä¾‹</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">argoproj.io/v1alpha1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Application</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">guestbook</span>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">argocd</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">project:</span> <span class="hljs-string">default</span>  <span class="hljs-attr">source:</span>    <span class="hljs-attr">repoURL:</span> <span class="hljs-string">https://github.com/example/guestbook</span>    <span class="hljs-attr">targetRevision:</span> <span class="hljs-string">HEAD</span>    <span class="hljs-attr">path:</span> <span class="hljs-string">k8s</span>  <span class="hljs-attr">destination:</span>    <span class="hljs-attr">server:</span> <span class="hljs-string">https://kubernetes.default.svc</span>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">guestbook</span>  <span class="hljs-attr">syncPolicy:</span>    <span class="hljs-attr">automated:</span>      <span class="hljs-attr">prune:</span> <span class="hljs-literal">true</span>      <span class="hljs-attr">selfHeal:</span> <span class="hljs-literal">true</span>    <span class="hljs-attr">syncOptions:</span>    <span class="hljs-bullet">-</span> <span class="hljs-string">CreateNamespace=true</span></code></pre><ol start="3"><li><strong>Jenkins X</strong></li></ol><p><a href="https://jenkins-x.io/">Jenkins X</a> æ˜¯åŸºäºJenkinsçš„äº‘åŸç”ŸCI/CDè§£å†³æ–¹æ¡ˆã€‚</p><p><strong>ä¼˜åŠ¿ï¼š</strong></p><ul><li>é›†æˆé¢„è§ˆç¯å¢ƒåŠŸèƒ½</li><li>å†…ç½®GitOpsæµç¨‹</li><li>è‡ªåŠ¨åŒ–CI/CDæµæ°´çº¿</li><li>æä¾›å¼€å‘è€…å¿«é€Ÿå¯åŠ¨æ¨¡æ¿</li></ul><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> é€‚åˆç†Ÿæ‚‰Jenkinsç”Ÿæ€ä¸”éœ€è¦å®Œæ•´CI/CDæµç¨‹çš„å›¢é˜Ÿ</p><h4 id="æŠ€æœ¯é€‰å‹å»ºè®®"><a class="header-anchor" href="#æŠ€æœ¯é€‰å‹å»ºè®®"></a>æŠ€æœ¯é€‰å‹å»ºè®®</h4><p>é€‰æ‹©GitOpså·¥å…·æ—¶ï¼Œåº”è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š</p><ol><li><strong>å›¢é˜Ÿç†Ÿæ‚‰åº¦</strong>ï¼šå›¢é˜Ÿæ˜¯å¦å·²æœ‰ç›¸å…³æŠ€èƒ½åŸºç¡€</li><li><strong>é¡¹ç›®è§„æ¨¡</strong>ï¼šå°å‹é¡¹ç›®å¯ä»¥ä»è½»é‡çº§å·¥å…·å¼€å§‹</li><li><strong>UIéœ€æ±‚</strong>ï¼šæ˜¯å¦éœ€è¦å¯è§†åŒ–ç•Œé¢ç®¡ç†</li><li><strong>é›†æˆéœ€æ±‚</strong>ï¼šä¸ç°æœ‰å·¥å…·çš„é›†æˆèƒ½åŠ›</li><li><strong>ç¤¾åŒºæ´»è·ƒåº¦</strong>ï¼šç¤¾åŒºæ”¯æŒå’Œæ›´æ–°é¢‘ç‡</li></ol><h3 id="ğŸ”„-GitOpså®è·µæµç¨‹"><a class="header-anchor" href="#ğŸ”„-GitOpså®è·µæµç¨‹"></a>ğŸ”„ GitOpså®è·µæµç¨‹</h3><h4 id="åŸºç¡€æ¶æ„æ­å»º"><a class="header-anchor" href="#åŸºç¡€æ¶æ„æ­å»º"></a>åŸºç¡€æ¶æ„æ­å»º</h4><p>ä»¥ArgoCDä¸ºä¾‹ï¼Œæ­å»ºåŸºç¡€GitOpså¹³å°ï¼š</p><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºå‘½åç©ºé—´</span>kubectl create namespace argocd<span class="hljs-comment"># å®‰è£…ArgoCD</span>kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml<span class="hljs-comment"># è·å–åˆå§‹å¯†ç </span>kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=<span class="hljs-string">&quot;&#123;.data.password&#125;&quot;</span> | base64 -d<span class="hljs-comment"># æš´éœ²æœåŠ¡ï¼ˆå¼€å‘ç¯å¢ƒå¯ç”¨ï¼‰</span>kubectl port-forward svc/argocd-server -n argocd 8080:443</code></pre><h4 id="å­˜å‚¨åº“ç»“æ„è®¾è®¡"><a class="header-anchor" href="#å­˜å‚¨åº“ç»“æ„è®¾è®¡"></a>å­˜å‚¨åº“ç»“æ„è®¾è®¡</h4><p>æœ‰æ•ˆçš„GitOpså®è·µä¾èµ–äºè‰¯å¥½çš„å­˜å‚¨åº“ç»“æ„è®¾è®¡ï¼š</p><ol><li><strong>å¤šä»“åº“æ¨¡å‹</strong>ï¼ˆé€‚åˆå¤§å‹ç»„ç»‡ï¼‰</li></ol><pre><code class="hljs csharp">infrastructure/          <span class="hljs-meta"># åŸºç¡€è®¾æ–½ä»£ç </span>â”œâ”€â”€ clusters/            <span class="hljs-meta"># é›†ç¾¤ç‰¹å®šé…ç½®</span>â”‚   â”œâ”€â”€ production/â”‚   â”œâ”€â”€ staging/â”‚   â””â”€â”€ development/â””â”€â”€ <span class="hljs-keyword">base</span>/                <span class="hljs-meta"># å…±äº«åŸºç¡€è®¾æ–½ç»„ä»¶</span>applications/            <span class="hljs-meta"># åº”ç”¨ä»£ç ä»“åº“</span>â”œâ”€â”€ app1/â”‚   â”œâ”€â”€ src/             <span class="hljs-meta"># åº”ç”¨æºä»£ç </span>â”‚   â””â”€â”€ k8s/             <span class="hljs-meta"># K8sé…ç½®æ¸…å•</span>â””â”€â”€ app2/    â”œâ”€â”€ src/    â””â”€â”€ k8s/</code></pre><ol start="2"><li><strong>å•ä»“åº“æ¨¡å‹</strong>ï¼ˆé€‚åˆå°å‹å›¢é˜Ÿï¼‰</li></ol><pre><code class="hljs bash">â”œâ”€â”€ apps/                <span class="hljs-comment"># åº”ç”¨é…ç½®</span>â”‚   â”œâ”€â”€ team<span class="hljs-_">-a</span>/â”‚   â”‚   â”œâ”€â”€ app1/â”‚   â”‚   â””â”€â”€ app2/â”‚   â””â”€â”€ team-b/â”œâ”€â”€ infrastructure/      <span class="hljs-comment"># å…±äº«åŸºç¡€è®¾æ–½</span>â”‚   â”œâ”€â”€ monitoring/â”‚   â”œâ”€â”€ networking/â”‚   â””â”€â”€ security/â””â”€â”€ clusters/            <span class="hljs-comment"># é›†ç¾¤ç‰¹å®šé…ç½®</span>    â”œâ”€â”€ production/    â”œâ”€â”€ staging/    â””â”€â”€ development/</code></pre><h4 id="ç¯å¢ƒç®¡ç†ç­–ç•¥"><a class="header-anchor" href="#ç¯å¢ƒç®¡ç†ç­–ç•¥"></a>ç¯å¢ƒç®¡ç†ç­–ç•¥</h4><p>GitOpsæ”¯æŒå¤šç§ç¯å¢ƒç®¡ç†ç­–ç•¥ï¼š</p><ol><li><strong>ç¯å¢ƒç›®å½•åˆ†ç¦»</strong>ï¼šæ¯ä¸ªç¯å¢ƒæœ‰ç‹¬ç«‹ç›®å½•</li></ol><pre><code class="hljs q">environments/â”œâ”€â”€ <span class="hljs-built_in">dev</span>/â”œâ”€â”€ staging/â””â”€â”€ production/</code></pre><ol start="2"><li><strong>ç¯å¢ƒåˆ†æ”¯ç­–ç•¥</strong>ï¼šä½¿ç”¨ä¸åŒåˆ†æ”¯ä»£è¡¨ä¸åŒç¯å¢ƒ</li></ol><pre><code class="hljs bash"><span class="hljs-comment"># å¼€å‘ç¯å¢ƒä½¿ç”¨developåˆ†æ”¯</span>git checkout develop<span class="hljs-comment"># ç”Ÿäº§ç¯å¢ƒä½¿ç”¨mainåˆ†æ”¯</span>git checkout main</code></pre><ol start="3"><li><strong>Kustomizeè¦†ç›–</strong>ï¼šä½¿ç”¨åŸºç¡€é…ç½®+ç¯å¢ƒç‰¹å®šè¦†ç›–</li></ol><pre><code class="hljs csharp"><span class="hljs-keyword">base</span>/                   <span class="hljs-meta"># åŸºç¡€é…ç½®</span>â”œâ”€â”€ deployment.yamlâ””â”€â”€ kustomization.yamloverlays/               <span class="hljs-meta"># ç¯å¢ƒè¦†ç›–å±‚</span>â”œâ”€â”€ dev/â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â””â”€â”€ patch.yamlâ”œâ”€â”€ staging/â””â”€â”€ production/</code></pre><h3 id="ğŸ”-å®‰å…¨ä¸åˆè§„æ€§"><a class="header-anchor" href="#ğŸ”-å®‰å…¨ä¸åˆè§„æ€§"></a>ğŸ” å®‰å…¨ä¸åˆè§„æ€§</h3><p>åœ¨GitOpsæµç¨‹ä¸­å®ç°å®‰å…¨å’Œåˆè§„è‡³å…³é‡è¦ã€‚</p><h4 id="æ•æ„Ÿä¿¡æ¯ç®¡ç†"><a class="header-anchor" href="#æ•æ„Ÿä¿¡æ¯ç®¡ç†"></a>æ•æ„Ÿä¿¡æ¯ç®¡ç†</h4><ol><li><strong>å¯†é’¥ç®¡ç†å·¥å…·é›†æˆ</strong></li></ol><p>ä½¿ç”¨å¤–éƒ¨å¯†é’¥ç®¡ç†å·¥å…·å¦‚HashiCorp Vaultæˆ–KubernetesåŸç”Ÿçš„Sealed Secretsï¼š</p><pre><code class="hljs yaml"><span class="hljs-comment"># ä½¿ç”¨Sealed Secretsçš„ç¤ºä¾‹</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">bitnami.com/v1alpha1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">SealedSecret</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">db-credentials</span>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">encryptedData:</span>    <span class="hljs-attr">username:</span> <span class="hljs-string">AgByD94TzZ3...</span>    <span class="hljs-attr">password:</span> <span class="hljs-string">AgCXk6B3rF9...</span></code></pre><ol start="2"><li><strong>ç¯å¢ƒå˜é‡ä¸é…ç½®åˆ†ç¦»</strong></li></ol><pre><code class="hljs yaml"><span class="hljs-comment"># ConfigMapç¤ºä¾‹</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">app-config</span><span class="hljs-attr">data:</span>  <span class="hljs-attr">APP_ENV:</span> <span class="hljs-string">production</span>  <span class="hljs-attr">LOG_LEVEL:</span> <span class="hljs-string">info</span>  <span class="hljs-meta">---</span><span class="hljs-comment"># Secretå¼•ç”¨ç¤ºä¾‹</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">app-pod</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">containers:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>    <span class="hljs-attr">image:</span> <span class="hljs-string">app:1.0.0</span>    <span class="hljs-attr">envFrom:</span>    <span class="hljs-bullet">-</span> <span class="hljs-attr">configMapRef:</span>        <span class="hljs-attr">name:</span> <span class="hljs-string">app-config</span>    <span class="hljs-bullet">-</span> <span class="hljs-attr">secretRef:</span>        <span class="hljs-attr">name:</span> <span class="hljs-string">db-credentials</span></code></pre><h4 id="åŸºäºç­–ç•¥çš„éªŒè¯"><a class="header-anchor" href="#åŸºäºç­–ç•¥çš„éªŒè¯"></a>åŸºäºç­–ç•¥çš„éªŒè¯</h4><p>ä½¿ç”¨Open Policy Agent (OPA) æˆ– Kyvernoè¿›è¡Œæ”¿ç­–éªŒè¯ï¼š</p><pre><code class="hljs yaml"><span class="hljs-comment"># Kyvernoç­–ç•¥ç¤ºä¾‹</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kyverno.io/v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterPolicy</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">require-labels</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">validationFailureAction:</span> <span class="hljs-string">enforce</span>  <span class="hljs-attr">rules:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">check-required-labels</span>    <span class="hljs-attr">match:</span>      <span class="hljs-attr">resources:</span>        <span class="hljs-attr">kinds:</span>        <span class="hljs-bullet">-</span> <span class="hljs-string">Deployment</span>    <span class="hljs-attr">validate:</span>      <span class="hljs-attr">message:</span> <span class="hljs-string">&quot;å¿…é¡»åŒ…å«teamæ ‡ç­¾&quot;</span>      <span class="hljs-attr">pattern:</span>        <span class="hljs-attr">metadata:</span>          <span class="hljs-attr">labels:</span>            <span class="hljs-attr">team:</span> <span class="hljs-string">&quot;?*&quot;</span></code></pre><h3 id="ğŸ“Š-ç›‘æ§ä¸å¯è§‚æµ‹æ€§"><a class="header-anchor" href="#ğŸ“Š-ç›‘æ§ä¸å¯è§‚æµ‹æ€§"></a>ğŸ“Š ç›‘æ§ä¸å¯è§‚æµ‹æ€§</h3><p>GitOpså®è·µéœ€è¦å¼ºå¤§çš„ç›‘æ§å’Œå¯è§‚æµ‹æ€§æ”¯æŒã€‚</p><h4 id="å…¸å‹ç›‘æ§æ¶æ„"><a class="header-anchor" href="#å…¸å‹ç›‘æ§æ¶æ„"></a>å…¸å‹ç›‘æ§æ¶æ„</h4><p>åœ¨GitOpsç¯å¢ƒä¸­ï¼Œåº”æ„å»ºä¸‰å±‚ç›‘æ§ï¼š</p><ol><li><strong>Gitä»“åº“ç›‘æ§</strong>ï¼šæäº¤é¢‘ç‡ã€PRå¤„ç†æ—¶é—´ç­‰</li><li><strong>éƒ¨ç½²æµç¨‹ç›‘æ§</strong>ï¼šåŒæ­¥çŠ¶æ€ã€éƒ¨ç½²æˆåŠŸç‡ç­‰</li><li><strong>åº”ç”¨ä¸åŸºç¡€è®¾æ–½ç›‘æ§</strong>ï¼šæ€§èƒ½æŒ‡æ ‡ã€å¯ç”¨æ€§ç­‰</li></ol><h4 id="Prometheus-Grafanaé›†æˆ"><a class="header-anchor" href="#Prometheus-Grafanaé›†æˆ"></a>Prometheus + Grafanaé›†æˆ</h4><p>ä½¿ç”¨Prometheuså’ŒGrafanaæ„å»ºç›‘æ§å¹³å°ï¼š</p><pre><code class="hljs yaml"><span class="hljs-comment"># Prometheusç¤ºä¾‹é…ç½®</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config</span><span class="hljs-attr">data:</span>  <span class="hljs-attr">prometheus.yml:</span> <span class="hljs-string">|</span>    <span class="hljs-attr">global:</span>      <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span>    <span class="hljs-attr">scrape_configs:</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;kubernetes-pods&#x27;</span>        <span class="hljs-attr">kubernetes_sd_configs:</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">pod</span>        <span class="hljs-attr">relabel_configs:</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]          <span class="hljs-attr">action:</span> <span class="hljs-string">keep</span>          <span class="hljs-attr">regex:</span> <span class="hljs-literal">true</span></code></pre><h4 id="ArgoCDç›‘æ§ç¤ºä¾‹"><a class="header-anchor" href="#ArgoCDç›‘æ§ç¤ºä¾‹"></a>ArgoCDç›‘æ§ç¤ºä¾‹</h4><p>ArgoCDæä¾›äº†ä¸°å¯Œçš„æŒ‡æ ‡å’Œå¥åº·çŠ¶æ€æ£€æŸ¥ï¼š</p><pre><code class="hljs yaml"><span class="hljs-comment"># ArgoCDæŒ‡æ ‡æœåŠ¡é…ç½®</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">argocd-metrics</span>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">argocd</span>  <span class="hljs-attr">labels:</span>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">argocd-metrics</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">ports:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">metrics</span>    <span class="hljs-attr">port:</span> <span class="hljs-number">8082</span>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8082</span>  <span class="hljs-attr">selector:</span>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">argocd-server</span><span class="hljs-meta">---</span><span class="hljs-comment"># Prometheus ServiceMonitor</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">monitoring.coreos.com/v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceMonitor</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">argocd-metrics</span>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">endpoints:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-string">metrics</span>  <span class="hljs-attr">namespaceSelector:</span>    <span class="hljs-attr">matchNames:</span>    <span class="hljs-bullet">-</span> <span class="hljs-string">argocd</span>  <span class="hljs-attr">selector:</span>    <span class="hljs-attr">matchLabels:</span>      <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">argocd-metrics</span></code></pre><h3 id="ğŸš€-GitOpså®è·µæ¡ˆä¾‹"><a class="header-anchor" href="#ğŸš€-GitOpså®è·µæ¡ˆä¾‹"></a>ğŸš€ GitOpså®è·µæ¡ˆä¾‹</h3><h4 id="æ¡ˆä¾‹ä¸€ï¼šå¾®æœåŠ¡åº”ç”¨éƒ¨ç½²æµç¨‹"><a class="header-anchor" href="#æ¡ˆä¾‹ä¸€ï¼šå¾®æœåŠ¡åº”ç”¨éƒ¨ç½²æµç¨‹"></a>æ¡ˆä¾‹ä¸€ï¼šå¾®æœåŠ¡åº”ç”¨éƒ¨ç½²æµç¨‹</h4><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¾®æœåŠ¡åº”ç”¨GitOpséƒ¨ç½²æµç¨‹ï¼š</p><ol><li><strong>ä»£ç å˜æ›´æµç¨‹</strong></li></ol><p>å¾®æœåŠ¡éƒ¨ç½²æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å¼€å‘è€…æäº¤ä»£ç </li><li>CIç³»ç»Ÿæ„å»ºå’Œæµ‹è¯•</li><li>æ„å»ºå®Œæˆåç”Ÿæˆå®¹å™¨é•œåƒ</li><li>è‡ªåŠ¨æ›´æ–°Gité…ç½®ä»“åº“</li><li>ArgoCDæ£€æµ‹åˆ°é…ç½®å˜æ›´</li><li>è‡ªåŠ¨å°†å˜æ›´åŒæ­¥åˆ°Kubernetesé›†ç¾¤</li></ul><ol start="2"><li><strong>å®ç°ç¤ºä¾‹</strong></li></ol><pre><code class="hljs yaml"><span class="hljs-comment"># åº”ç”¨éƒ¨ç½²æ¸…å•</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">microservice-a</span>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">production</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>  <span class="hljs-attr">selector:</span>    <span class="hljs-attr">matchLabels:</span>      <span class="hljs-attr">app:</span> <span class="hljs-string">microservice-a</span>  <span class="hljs-attr">template:</span>    <span class="hljs-attr">metadata:</span>      <span class="hljs-attr">labels:</span>        <span class="hljs-attr">app:</span> <span class="hljs-string">microservice-a</span>    <span class="hljs-attr">spec:</span>      <span class="hljs-attr">containers:</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>        <span class="hljs-attr">image:</span> <span class="hljs-string">example/microservice-a:$&#123;VERSION&#125;</span>        <span class="hljs-attr">resources:</span>          <span class="hljs-attr">limits:</span>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">500m</span>            <span class="hljs-attr">memory:</span> <span class="hljs-string">512Mi</span>          <span class="hljs-attr">requests:</span>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">200m</span>            <span class="hljs-attr">memory:</span> <span class="hljs-string">256Mi</span>        <span class="hljs-attr">ports:</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span></code></pre><ol start="3"><li><strong>CIæµæ°´çº¿ç¤ºä¾‹(GitHub Actions)</strong></li></ol><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">CI</span> <span class="hljs-string">Pipeline</span><span class="hljs-attr">on:</span>  <span class="hljs-attr">push:</span>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]<span class="hljs-attr">jobs:</span>  <span class="hljs-attr">build-and-push:</span>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>        <span class="hljs-attr">steps:</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Buildx</span>        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/setup-buildx-action@v2</span>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Login</span> <span class="hljs-string">to</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Hub</span>        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/login-action@v2</span>        <span class="hljs-attr">with:</span>          <span class="hljs-attr">username:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.DOCKERHUB_USERNAME</span> <span class="hljs-string">&#125;&#125;</span>          <span class="hljs-attr">password:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.DOCKERHUB_TOKEN</span> <span class="hljs-string">&#125;&#125;</span>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">and</span> <span class="hljs-string">push</span>        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/build-push-action@v3</span>        <span class="hljs-attr">with:</span>          <span class="hljs-attr">push:</span> <span class="hljs-literal">true</span>          <span class="hljs-attr">tags:</span> <span class="hljs-string">example/microservice-a:$&#123;&#123;</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">&#125;&#125;</span>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Update</span> <span class="hljs-string">deployment</span> <span class="hljs-string">manifest</span>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span>          <span class="hljs-string">git</span> <span class="hljs-string">config</span> <span class="hljs-string">--global</span> <span class="hljs-string">user.name</span> <span class="hljs-string">&#x27;CI Bot&#x27;</span>          <span class="hljs-string">git</span> <span class="hljs-string">config</span> <span class="hljs-string">--global</span> <span class="hljs-string">user.email</span> <span class="hljs-string">&#x27;ci@example.com&#x27;</span>          <span class="hljs-string">git</span> <span class="hljs-string">clone</span> <span class="hljs-string">https://github.com/example/gitops-config.git</span>          <span class="hljs-string">cd</span> <span class="hljs-string">gitops-config</span>          <span class="hljs-string">sed</span> <span class="hljs-string">-i</span> <span class="hljs-string">&quot;s|image: example/microservice-a:.*|image: example/microservice-a:$<span class="hljs-template-variable">&#123;&#123; github.sha &#125;&#125;</span>|g&quot;</span> <span class="hljs-string">apps/production/microservice-a.yaml</span>          <span class="hljs-string">git</span> <span class="hljs-string">add</span> <span class="hljs-string">.</span>          <span class="hljs-string">git</span> <span class="hljs-string">commit</span> <span class="hljs-string">-m</span> <span class="hljs-string">&quot;Update microservice-a image to $<span class="hljs-template-variable">&#123;&#123; github.sha &#125;&#125;</span>&quot;</span>          <span class="hljs-string">git</span> <span class="hljs-string">push</span></code></pre><h4 id="æ¡ˆä¾‹äºŒï¼šå¤šç¯å¢ƒç®¡ç†"><a class="header-anchor" href="#æ¡ˆä¾‹äºŒï¼šå¤šç¯å¢ƒç®¡ç†"></a>æ¡ˆä¾‹äºŒï¼šå¤šç¯å¢ƒç®¡ç†</h4><p>ä½¿ç”¨Kustomizeç®¡ç†å¤šç¯å¢ƒé…ç½®ï¼š</p><ol><li><strong>åŸºç¡€ç›®å½•ç»“æ„</strong></li></ol><pre><code class="hljs stylus">environments/â”œâ”€â”€ base/â”‚   â”œâ”€â”€ deployment.yamlâ”‚   â”œâ”€â”€ service.yamlâ”‚   â””â”€â”€ kustomization.yamlâ”œâ”€â”€ dev/â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â””â”€â”€ patches/â”‚       â””â”€â”€ deployment-env.yamlâ”œâ”€â”€ staging/â””â”€â”€ production/</code></pre><ol start="2"><li><strong>åŸºç¡€é…ç½®(base/kustomization.yaml)</strong></li></ol><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kustomize.config.k8s.io/v1beta1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Kustomization</span><span class="hljs-attr">resources:</span><span class="hljs-bullet">-</span> <span class="hljs-string">deployment.yaml</span><span class="hljs-bullet">-</span> <span class="hljs-string">service.yaml</span></code></pre><ol start="3"><li><strong>ç¯å¢ƒç‰¹å®šé…ç½®(dev/kustomization.yaml)</strong></li></ol><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kustomize.config.k8s.io/v1beta1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Kustomization</span><span class="hljs-attr">namePrefix:</span> <span class="hljs-string">dev-</span><span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span><span class="hljs-attr">resources:</span><span class="hljs-bullet">-</span> <span class="hljs-string">../base</span><span class="hljs-attr">patchesStrategicMerge:</span><span class="hljs-bullet">-</span> <span class="hljs-string">patches/deployment-env.yaml</span><span class="hljs-attr">replicas:</span><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app-deployment</span>  <span class="hljs-attr">count:</span> <span class="hljs-number">1</span></code></pre><ol start="4"><li><strong>ç¯å¢ƒè¡¥ä¸(dev/patches/deployment-env.yaml)</strong></li></ol><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">app-deployment</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">template:</span>    <span class="hljs-attr">spec:</span>      <span class="hljs-attr">containers:</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>        <span class="hljs-attr">env:</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ENVIRONMENT</span>          <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;development&quot;</span>        <span class="hljs-attr">resources:</span>          <span class="hljs-attr">limits:</span>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">200m</span>            <span class="hljs-attr">memory:</span> <span class="hljs-string">256Mi</span></code></pre><h3 id="ğŸ”-å¸¸è§æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ"><a class="header-anchor" href="#ğŸ”-å¸¸è§æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ"></a>ğŸ” å¸¸è§æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ</h3><h4 id="1-é…ç½®æ¼‚ç§»å¤„ç†"><a class="header-anchor" href="#1-é…ç½®æ¼‚ç§»å¤„ç†"></a>1. é…ç½®æ¼‚ç§»å¤„ç†</h4><p>é…ç½®æ¼‚ç§»æ˜¯æŒ‡é›†ç¾¤çŠ¶æ€ä¸Gitä»“åº“ä¸­çš„å£°æ˜å¼é…ç½®ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><ul><li>å¯ç”¨è‡ªåŠ¨åŒæ­¥å’Œè‡ªæ„ˆåŠŸèƒ½</li><li>å®æ–½å®šæœŸä¸€è‡´æ€§æ£€æŸ¥</li><li>å»ºç«‹æ¼‚ç§»å‘Šè­¦æœºåˆ¶</li></ul><pre><code class="hljs yaml"><span class="hljs-comment"># ArgoCDè‡ªæ„ˆé…ç½®</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">argoproj.io/v1alpha1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Application</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">app</span><span class="hljs-attr">spec:</span>  <span class="hljs-comment"># ...å…¶å®ƒé…ç½®</span>  <span class="hljs-attr">syncPolicy:</span>    <span class="hljs-attr">automated:</span>      <span class="hljs-attr">prune:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># ç§»é™¤æœªåœ¨Gitä¸­å®šä¹‰çš„èµ„æº</span>      <span class="hljs-attr">selfHeal:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># è‡ªåŠ¨ä¿®å¤é›†ç¾¤ä¸­çš„æ¼‚ç§»</span></code></pre><h4 id="2-å¤§è§„æ¨¡å›¢é˜Ÿåä½œ"><a class="header-anchor" href="#2-å¤§è§„æ¨¡å›¢é˜Ÿåä½œ"></a>2. å¤§è§„æ¨¡å›¢é˜Ÿåä½œ</h4><p>åœ¨å¤§å‹ç»„ç»‡ä¸­åè°ƒå¤šä¸ªå›¢é˜Ÿä½¿ç”¨GitOpså¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><ul><li>å®æ–½æ˜ç¡®çš„RBACæƒé™æ§åˆ¶</li><li>ä½¿ç”¨åº”ç”¨ç¨‹åºé¡¹ç›®éš”ç¦»</li><li>å»ºç«‹è·¨å›¢é˜Ÿåä½œæŒ‡å—</li></ul><pre><code class="hljs yaml"><span class="hljs-comment"># ArgoCDé¡¹ç›®éš”ç¦»</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">argoproj.io/v1alpha1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">AppProject</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">team-a</span>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">argocd</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">description:</span> <span class="hljs-string">Team</span> <span class="hljs-string">A</span> <span class="hljs-string">applications</span>  <span class="hljs-attr">sourceRepos:</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;https://github.com/example/team-a-apps&#x27;</span>  <span class="hljs-attr">destinations:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">namespace:</span> <span class="hljs-string">team-a-*</span>    <span class="hljs-attr">server:</span> <span class="hljs-string">https://kubernetes.default.svc</span>  <span class="hljs-attr">clusterResourceWhitelist:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;&#x27;</span>    <span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span></code></pre><h4 id="3-å¤„ç†å¤§å‹å˜æ›´å’Œè¿ç§»"><a class="header-anchor" href="#3-å¤„ç†å¤§å‹å˜æ›´å’Œè¿ç§»"></a>3. å¤„ç†å¤§å‹å˜æ›´å’Œè¿ç§»</h4><p>å¤§è§„æ¨¡å˜æ›´å¯èƒ½é£é™©è¾ƒé«˜ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><ul><li>å®æ–½è“ç»¿éƒ¨ç½²ç­–ç•¥</li><li>ä½¿ç”¨é‡‘ä¸é›€å‘å¸ƒ</li><li>æä¾›å›æ»šæœºåˆ¶</li></ul><h3 id="ğŸ“-æ€»ç»“ä¸æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸ“-æ€»ç»“ä¸æœ€ä½³å®è·µ"></a>ğŸ“ æ€»ç»“ä¸æœ€ä½³å®è·µ</h3><p>GitOpsæ–¹æ³•ä¸ºäº‘åŸç”Ÿåº”ç”¨äº¤ä»˜æä¾›äº†å¼ºå¤§çš„æ¡†æ¶ï¼Œé€šè¿‡é‡‡ç”¨ä»¥ä¸‹æœ€ä½³å®è·µï¼Œå¯ä»¥å……åˆ†å‘æŒ¥å…¶ä¼˜åŠ¿ï¼š</p><ol><li><strong>ç‰ˆæœ¬æ§åˆ¶ä¸€åˆ‡</strong>ï¼šä¸ä»…åº”ç”¨ä»£ç ï¼Œè¿˜åŒ…æ‹¬é…ç½®ã€åŸºç¡€è®¾æ–½å®šä¹‰</li><li><strong>è‡ªåŠ¨åŒ–ä¼˜å…ˆ</strong>ï¼šå‡å°‘æ‰‹åŠ¨æ“ä½œï¼Œå¢å¼ºå¯é‡å¤æ€§å’Œä¸€è‡´æ€§</li><li><strong>å£°æ˜å¼é…ç½®</strong>ï¼šä½¿ç”¨å£°æ˜å¼è€Œéå‘½ä»¤å¼çš„é…ç½®ç®¡ç†æ–¹å¼</li><li><strong>å®¡è®¡ä¸å¯è§æ€§</strong>ï¼šä¿æŒå®Œæ•´çš„å®¡è®¡å†å²å’Œå˜æ›´è¿½è¸ª</li><li><strong>æ‹¥æŠ±ä¸å¯å˜åŸºç¡€è®¾æ–½</strong>ï¼šé€šè¿‡é‡å»ºè€ŒéåŸåœ°ä¿®æ”¹å®æ–½å˜æ›´</li><li><strong>åˆ†ç¦»å…³æ³¨ç‚¹</strong>ï¼šå°†åº”ç”¨ã€ç¯å¢ƒå’ŒåŸºç¡€è®¾æ–½é…ç½®åˆ†å¼€ç®¡ç†</li><li><strong>å»ºç«‹å¼ºå¤§çš„æµ‹è¯•æœºåˆ¶</strong>ï¼šç¡®ä¿é…ç½®å˜æ›´ç»è¿‡å……åˆ†æµ‹è¯•</li></ol><p>GitOpsä¸ä»…æ˜¯ä¸€å¥—å·¥å…·ï¼Œæ›´æ˜¯ä¸€ç§æ€ç»´æ–¹å¼å’Œå·¥ä½œæµç¨‹ã€‚é€šè¿‡å°†Gitä½œä¸ºå•ä¸€äº‹å®æ¥æºï¼Œå›¢é˜Ÿå¯ä»¥æé«˜äº¤ä»˜é€Ÿåº¦ï¼Œå¢å¼ºç³»ç»Ÿå¯é æ€§ï¼Œç®€åŒ–è¿ç»´å·¥ä½œï¼Œå®ç°çœŸæ­£çš„äº‘åŸç”ŸDevOpså®è·µã€‚</p>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
    </categories>
    
    
    <tags>
      
      <tag>DevOps</tag>
      
      <tag>GitOps</tag>
      
      <tag>äº‘åŸç”Ÿ</tag>
      
      <tag>CI/CD</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¤§æ¨¡å‹æ—¶ä»£çš„AIåº”ç”¨å¼€å‘å®è·µ</title>
    <link href="/2024/08/15/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%97%B6%E4%BB%A3%E7%9A%84AI%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5/"/>
    <url>/2024/08/15/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%97%B6%E4%BB%A3%E7%9A%84AI%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h1>ğŸš€ å¤§æ¨¡å‹æ—¶ä»£çš„AIåº”ç”¨å¼€å‘å®è·µ</h1><p>æœ€è¿‘ä¸€å¹´å¤šæ¥ï¼Œéšç€ChatGPTã€Claudeã€æ–‡å¿ƒä¸€è¨€ç­‰å¤§è¯­è¨€æ¨¡å‹(LLM)çš„çˆ†ç«ï¼ŒAIåº”ç”¨å¼€å‘è¿æ¥äº†ç¿»å¤©è¦†åœ°çš„å˜åŒ–ã€‚æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­æ¥è§¦å¹¶ä½¿ç”¨äº†è¿™äº›æŠ€æœ¯ï¼Œè¿™é‡Œåˆ†äº«ä¸€äº›å®è·µç»éªŒå’Œæ€è€ƒã€‚</p><h3 id="ğŸ“š-å¤§æ¨¡å‹åŸºç¡€æ¦‚å¿µ"><a class="header-anchor" href="#ğŸ“š-å¤§æ¨¡å‹åŸºç¡€æ¦‚å¿µ"></a>ğŸ“š å¤§æ¨¡å‹åŸºç¡€æ¦‚å¿µ</h3><p><strong>ä»€ä¹ˆæ˜¯å¤§æ¨¡å‹ï¼Ÿ</strong></p><p>å¤§æ¨¡å‹(LLMs)å°±æ˜¯é‚£äº›å‚æ•°è§„æ¨¡åŠ¨è¾„ä¸Šåƒäº¿çš„é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ï¼Œæ¯”å¦‚ï¼š</p><ul><li>OpenAIçš„GPT-4/3.5</li><li>Anthropicçš„Claude</li><li>Googleçš„Gemini</li><li>å›½å†…çš„æ–‡å¿ƒä¸€è¨€ã€é€šä¹‰åƒé—®ç­‰</li></ul><p>è¿™äº›æ¨¡å‹é€šè¿‡æµ·é‡æ–‡æœ¬æ•°æ®é¢„è®­ç»ƒï¼Œå­¦ä¼šäº†è¯­è¨€è§„å¾‹å’Œä¸–ç•ŒçŸ¥è¯†ï¼Œæœ‰ç‚¹ç±»ä¼¼äºç»™äº†AIä¸€ä¸ª&quot;å¤§è„‘&quot;ã€‚</p><p><strong>èƒ½åŠ›è¾¹ç•Œ</strong></p><p>å¤§æ¨¡å‹ç›®å‰èƒ½åšçš„äº‹æƒ…ï¼š</p><ul><li>âœ… æµç•…å¯¹è¯ä¸æ–‡æœ¬ç”Ÿæˆ</li><li>âœ… ç¼–å†™å’Œè°ƒè¯•ä»£ç </li><li>âœ… å›ç­”çŸ¥è¯†é—®é¢˜</li><li>âœ… æ€»ç»“é•¿æ–‡æœ¬</li><li>âœ… åˆ›æ„å†…å®¹åˆ›ä½œ</li><li>âœ… å¤šæ¨¡æ€ç†è§£(å›¾åƒ+æ–‡æœ¬)</li></ul><p>ä½†ä¹Ÿæœ‰æ˜æ˜¾çš„çŸ­æ¿ï¼š</p><ul><li>âŒ å¹»è§‰é—®é¢˜ï¼ˆå°±æ˜¯èƒ¡è¯´å…«é“ï¼‰</li><li>âŒ æ—¶æ•ˆæ€§å—é™ï¼ˆè®­ç»ƒæ•°æ®æœ‰æˆªæ­¢æ—¥æœŸï¼‰</li><li>âŒ ä¸“ä¸šé¢†åŸŸæ·±åº¦ä¸è¶³</li><li>âŒ å¤æ‚æ¨ç†èƒ½åŠ›æœ‰é™</li></ul><h3 id="ğŸ”„-AIåº”ç”¨å¼€å‘æ–°èŒƒå¼"><a class="header-anchor" href="#ğŸ”„-AIåº”ç”¨å¼€å‘æ–°èŒƒå¼"></a>ğŸ”„ AIåº”ç”¨å¼€å‘æ–°èŒƒå¼</h3><p>è¿‡å»å’Œç°åœ¨çš„AIå¼€å‘åŒºåˆ«è¶…çº§å¤§ï¼š</p><table><thead><tr><th>å¯¹æ¯”é¡¹</th><th>ä¼ ç»ŸAIå¼€å‘</th><th>å¤§æ¨¡å‹åº”ç”¨å¼€å‘</th></tr></thead><tbody><tr><td>å¼€å‘æ–¹å¼</td><td>è®­ç»ƒä¸“ç”¨æ¨¡å‹</td><td>è°ƒç”¨API+æç¤ºå·¥ç¨‹</td></tr><tr><td>æ•°æ®éœ€æ±‚</td><td>å¤§é‡æ ‡æ³¨æ•°æ®</td><td>å°‘é‡ç¤ºä¾‹æˆ–é›¶æ ·æœ¬</td></tr><tr><td>å¼€å‘å‘¨æœŸ</td><td>æœˆçº§åˆ«</td><td>å¤©çº§åˆ«ç”šè‡³å°æ—¶çº§</td></tr><tr><td>æŠ€æœ¯é—¨æ§›</td><td>æœºå™¨å­¦ä¹ ä¸“ä¸šçŸ¥è¯†</td><td>æç¤ºè®¾è®¡èƒ½åŠ›</td></tr><tr><td>æˆæœ¬ç»“æ„</td><td>å‰æœŸå¤§æŠ•å…¥ï¼ŒåæœŸä½æˆæœ¬</td><td>æŒ‰é‡ä»˜è´¹æ¨¡å¼</td></tr></tbody></table><h3 id="ğŸ› ï¸-æ ¸å¿ƒæŠ€æœ¯æ ˆ"><a class="header-anchor" href="#ğŸ› ï¸-æ ¸å¿ƒæŠ€æœ¯æ ˆ"></a>ğŸ› ï¸ æ ¸å¿ƒæŠ€æœ¯æ ˆ</h3><h4 id="1-æç¤ºå·¥ç¨‹-Prompt-Engineering"><a class="header-anchor" href="#1-æç¤ºå·¥ç¨‹-Prompt-Engineering"></a>1. æç¤ºå·¥ç¨‹(Prompt Engineering)</h4><p>æç¤ºå·¥ç¨‹å°±æ˜¯å¦‚ä½•å’Œå¤§æ¨¡å‹&quot;è¯´è¯&quot;çš„è‰ºæœ¯ï¼Œç®€å•ç¤ºä¾‹ï¼š</p><pre><code class="hljs 1c"><span class="hljs-meta"># æ™®é€šæç¤º</span><span class="hljs-string">&quot;å†™ä¸€ä¸ªPythonå‡½æ•°è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—&quot;</span><span class="hljs-meta"># ä¼˜åŒ–æç¤º</span><span class="hljs-string">&quot;è¯·ç¼–å†™ä¸€ä¸ªPythonå‡½æ•°calc_fibonacci(n)ï¼Œå®ç°æ–æ³¢é‚£å¥‘æ•°åˆ—è®¡ç®—ã€‚</span>è¦æ±‚ï¼š<span class="hljs-number">1</span>. ä½¿ç”¨åŠ¨æ€è§„åˆ’ä¼˜åŒ–æ€§èƒ½<span class="hljs-number">2</span>. æ·»åŠ é€‚å½“çš„æ³¨é‡Š<span class="hljs-number">3</span>. å¤„ç†n&lt;=<span class="hljs-number">0</span>çš„è¾¹ç•Œæƒ…å†µ<span class="hljs-number">4</span>. åŒ…å«ç®€å•çš„æµ‹è¯•ç”¨ä¾‹<span class="hljs-string">&quot;</span></code></pre><h4 id="2-RAG-æ£€ç´¢å¢å¼ºç”Ÿæˆ"><a class="header-anchor" href="#2-RAG-æ£€ç´¢å¢å¼ºç”Ÿæˆ"></a>2. RAG(æ£€ç´¢å¢å¼ºç”Ÿæˆ)</h4><p>å½“ä½ éœ€è¦è®©AIè®¿é—®ç‰¹å®šçŸ¥è¯†æ—¶ï¼ŒRAGæ˜¯æœ€å¸¸ç”¨çš„æ–¹æ¡ˆï¼š</p><pre><code class="hljs python"><span class="hljs-comment"># ç®€åŒ–çš„RAGå®ç°ç¤ºä¾‹</span><span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> Chroma<span class="hljs-keyword">from</span> langchain.embeddings <span class="hljs-keyword">import</span> OpenAIEmbeddings<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> ChatOpenAI<span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> RetrievalQA<span class="hljs-comment"># 1. åˆ›å»ºå‘é‡æ•°æ®åº“</span>embeddings = OpenAIEmbeddings()vectordb = Chroma.from_documents(documents, embeddings)<span class="hljs-comment"># 2. åˆ›å»ºæ£€ç´¢å™¨</span>retriever = vectordb.as_retriever()<span class="hljs-comment"># 3. åˆ›å»ºé—®ç­”é“¾</span>llm = ChatOpenAI(model=<span class="hljs-string">&quot;gpt-3.5-turbo&quot;</span>)qa_chain = RetrievalQA.from_chain_type(    llm=llm,    chain_type=<span class="hljs-string">&quot;stuff&quot;</span>,    retriever=retriever)<span class="hljs-comment"># 4. æŸ¥è¯¢</span>result = qa_chain.run(<span class="hljs-string">&quot;ä½ çš„é—®é¢˜&quot;</span>)</code></pre><h4 id="3-Agentä¸å·¥å…·è°ƒç”¨"><a class="header-anchor" href="#3-Agentä¸å·¥å…·è°ƒç”¨"></a>3. Agentä¸å·¥å…·è°ƒç”¨</h4><p>è®©AIèƒ½å¤Ÿä½¿ç”¨å·¥å…·æ˜¯è¿‘æœŸæœ€ç«çš„æ–¹å‘ï¼š</p><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> initialize_agent, Tool<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> ChatOpenAI<span class="hljs-comment"># å®šä¹‰å·¥å…·</span>tools = [    Tool(        name=<span class="hljs-string">&quot;æœç´¢å¼•æ“&quot;</span>,        func=search_func,        description=<span class="hljs-string">&quot;å½“ä½ éœ€è¦æŸ¥è¯¢æœ€æ–°ä¿¡æ¯æ—¶ä½¿ç”¨&quot;</span>    ),    Tool(        name=<span class="hljs-string">&quot;è®¡ç®—å™¨&quot;</span>,        func=calculator_func,        description=<span class="hljs-string">&quot;è¿›è¡Œæ•°å­¦è®¡ç®—æ—¶ä½¿ç”¨&quot;</span>    )]<span class="hljs-comment"># åˆå§‹åŒ–Agent</span>agent = initialize_agent(    tools,     ChatOpenAI(temperature=<span class="hljs-number">0</span>),     agent=<span class="hljs-string">&quot;chat-zero-shot-react-description&quot;</span>,     verbose=<span class="hljs-literal">True</span>)<span class="hljs-comment"># æ‰§è¡Œä»»åŠ¡</span>agent.run(<span class="hljs-string">&quot;æŸ¥è¯¢ä»Šå¤©ä¸Šæµ·çš„å¤©æ°”ï¼Œå¹¶è®¡ç®—æœªæ¥3å¤©çš„å¹³å‡æ°”æ¸©&quot;</span>)</code></pre><h4 id="4-å¾®è°ƒä¸å®šåˆ¶"><a class="header-anchor" href="#4-å¾®è°ƒä¸å®šåˆ¶"></a>4. å¾®è°ƒä¸å®šåˆ¶</h4><p>æœ‰æ—¶å€™éœ€è¦é’ˆå¯¹ç‰¹å®šä»»åŠ¡å®šåˆ¶æ¨¡å‹ï¼š</p><pre><code class="hljs bash"><span class="hljs-comment"># ä½¿ç”¨OpenAIçš„å¾®è°ƒAPIç¤ºä¾‹</span>openai api fine_tunes.create \  -t training_data.jsonl \  -m davinci \  --n_epochs 3 \  --learning_rate_multiplier 0.1</code></pre><h3 id="ğŸ—ï¸-å®æˆ˜å¼€å‘æµç¨‹"><a class="header-anchor" href="#ğŸ—ï¸-å®æˆ˜å¼€å‘æµç¨‹"></a>ğŸ—ï¸ å®æˆ˜å¼€å‘æµç¨‹</h3><h4 id="1ï¸âƒ£-åœºæ™¯å®šä¹‰"><a class="header-anchor" href="#1ï¸âƒ£-åœºæ™¯å®šä¹‰"></a>1ï¸âƒ£ åœºæ™¯å®šä¹‰</h4><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä¸€èˆ¬ä¼šå…ˆé—®è‡ªå·±è¿™äº›é—®é¢˜ï¼š</p><ul><li>ç”¨æˆ·å®é™…ç—›ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>å¤§æ¨¡å‹å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ</li><li>æ˜¯å¦éœ€è¦ä¸“ä¸šé¢†åŸŸçŸ¥è¯†ï¼Ÿ</li><li>å‡†ç¡®æ€§å’Œå“åº”é€Ÿåº¦è¦æ±‚ï¼Ÿ</li></ul><h4 id="2ï¸âƒ£-æ¨¡å‹é€‰å‹"><a class="header-anchor" href="#2ï¸âƒ£-æ¨¡å‹é€‰å‹"></a>2ï¸âƒ£ æ¨¡å‹é€‰å‹</h4><p>é€‰æ¨¡å‹æ—¶çš„å‡ ä¸ªè€ƒè™‘å› ç´ ï¼š</p><ul><li>èƒ½åŠ›éœ€æ±‚ï¼šGPT-4æœ€å¼ºä½†æˆæœ¬é«˜ï¼Œ3.5é€‚ä¸­</li><li>é¢„ç®—é™åˆ¶ï¼šå¼€æºæ¨¡å‹éƒ¨ç½²æˆæœ¬ä½ï¼ŒAPIæŒ‰é‡ä»˜è´¹</li><li>éƒ¨ç½²è¦æ±‚ï¼šæœ¬åœ°éƒ¨ç½²æœ‰éšç§ä¼˜åŠ¿ä½†éœ€ç¡¬ä»¶</li><li>ä¸­è‹±æ–‡éœ€æ±‚ï¼šå›½å†…æ¨¡å‹ä¸­æ–‡è¡¨ç°æ›´å¥½</li></ul><h4 id="3ï¸âƒ£-å¼€å‘å®è·µ"><a class="header-anchor" href="#3ï¸âƒ£-å¼€å‘å®è·µ"></a>3ï¸âƒ£ å¼€å‘å®è·µ</h4><p>å®é™…å¼€å‘ä¸­çš„å…³é”®ç‚¹ï¼š</p><ul><li><strong>æç¤ºæ¨¡æ¿è®¾è®¡</strong>ï¼šç»“æ„åŒ–æç¤ºï¼Œè§’è‰²å®šä¹‰æ¸…æ™°</li></ul><pre><code class="hljs dust"><span class="xml">è§’è‰²ï¼š</span><span class="hljs-template-variable">&#123;ä½ æ˜¯ä¸€ä½åŒ»ç–—é¡¾é—®&#125;</span><span class="xml">èƒŒæ™¯ï¼š</span><span class="hljs-template-variable">&#123;ç”¨æˆ·æ­£åœ¨å’¨è¯¢å¥åº·é—®é¢˜&#125;</span><span class="xml">çº¦æŸï¼š</span><span class="hljs-template-variable">&#123;ä»…æä¾›ä¸€èˆ¬å»ºè®®ï¼Œä¸åšå…·ä½“è¯Šæ–­&#125;</span><span class="xml">è¾“å…¥ï¼š</span><span class="hljs-template-variable">&#123;ç”¨æˆ·é—®é¢˜&#125;</span><span class="xml">è¾“å‡ºæ ¼å¼ï¼š</span><span class="hljs-template-variable">&#123;ç®€æ˜æ‰¼è¦çš„å›ç­”ï¼Œå¿…è¦æ—¶å»ºè®®å°±åŒ»&#125;</span></code></pre><ul><li><p><strong>RAGç³»ç»Ÿå®ç°</strong>ï¼š</p><ul><li>æ–‡æ¡£åˆ‡åˆ†ï¼šæˆ‘ä¸€èˆ¬ç”¨500-1000tokenå¤§å°</li><li>é‡å å¤„ç†ï¼šç›¸é‚»å—é‡å 10-20%æé«˜è¿è´¯æ€§</li><li>å…ƒæ•°æ®æ ‡è®°ï¼šä¿ç•™æ–‡æ¡£æ¥æºã€æ—¶é—´ç­‰ä¿¡æ¯</li></ul></li><li><p><strong>æ¶æ„è®¾è®¡</strong>ï¼šä¸€ä¸ªå®ç”¨çš„ç”Ÿäº§æ¶æ„</p></li></ul><pre><code class="hljs plain">ç”¨æˆ·ç•Œé¢ â†’ APIç½‘å…³ â†’ åº”ç”¨æœåŠ¡ â†’ å¤§æ¨¡å‹æœåŠ¡                      â†‘           â†“                    å·¥å…·API   å‘é‡æ•°æ®åº“                      â†“           â†“                    ç›‘æ§ç³»ç»Ÿ     æ—¥å¿—ç³»ç»Ÿ</code></pre><h3 id="ğŸ“Š-å®æˆ˜æ¡ˆä¾‹åˆ†äº«"><a class="header-anchor" href="#ğŸ“Š-å®æˆ˜æ¡ˆä¾‹åˆ†äº«"></a>ğŸ“Š å®æˆ˜æ¡ˆä¾‹åˆ†äº«</h3><h4 id="æ¡ˆä¾‹ï¼šæ™ºèƒ½å®¢æœç³»ç»Ÿ"><a class="header-anchor" href="#æ¡ˆä¾‹ï¼šæ™ºèƒ½å®¢æœç³»ç»Ÿ"></a>æ¡ˆä¾‹ï¼šæ™ºèƒ½å®¢æœç³»ç»Ÿ</h4><p><strong>ç—›ç‚¹</strong>ï¼šä¼ ç»Ÿå®¢æœæœºå™¨äººå›ç­”åƒµç¡¬ï¼Œæ— æ³•ç†è§£ä¸Šä¸‹æ–‡</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ol><li>ä½¿ç”¨RAGæ£€ç´¢çŸ¥è¯†åº“</li><li>å¤šçº§å›ç­”ç­–ç•¥ï¼š</li></ol><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">answer_query</span>(<span class="hljs-params">query</span>):</span>    <span class="hljs-comment"># 1. å°è¯•FAQç²¾ç¡®åŒ¹é…</span>    faq_answer = faq_db.match(query)    <span class="hljs-keyword">if</span> faq_answer.confidence &gt; <span class="hljs-number">0.9</span>:        <span class="hljs-keyword">return</span> faq_answer            <span class="hljs-comment"># 2. çŸ¥è¯†åº“æ£€ç´¢</span>    rag_docs = vector_db.search(query)    <span class="hljs-keyword">if</span> rag_docs:        context = <span class="hljs-string">&quot;\n&quot;</span>.join(rag_docs)        rag_answer = llm.generate(<span class="hljs-string">f&quot;&quot;&quot;</span><span class="hljs-string">        åŸºäºä»¥ä¸‹ä¿¡æ¯å›ç­”é—®é¢˜: <span class="hljs-subst">&#123;query&#125;</span></span><span class="hljs-string">        </span><span class="hljs-string">        ä¿¡æ¯: <span class="hljs-subst">&#123;context&#125;</span></span><span class="hljs-string">        </span><span class="hljs-string">        å¦‚æœä¿¡æ¯ä¸è¶³ä»¥å›ç­”é—®é¢˜ï¼Œè¯·è¯´ä¸çŸ¥é“ã€‚</span><span class="hljs-string">        &quot;&quot;&quot;</span>)        <span class="hljs-keyword">return</span> rag_answer        <span class="hljs-comment"># 3. å…œåº•é€šç”¨å›ç­”</span>    <span class="hljs-keyword">return</span> llm.generate(<span class="hljs-string">f&quot;ä»¥å®¢æœèº«ä»½å›ç­”: <span class="hljs-subst">&#123;query&#125;</span>&quot;</span>)</code></pre><ol start="3"><li>é›†æˆä¸šåŠ¡æµç¨‹ï¼Œå®ç°è®¢å•æŸ¥è¯¢ã€çŠ¶æ€æ›´æ–°ç­‰</li></ol><p><strong>æ•ˆæœ</strong>ï¼š</p><ul><li>è§£å†³ç‡æå‡40%</li><li>å®¢æˆ·æ»¡æ„åº¦æå‡35%</li><li>äººå·¥å®¢æœå·¥ä½œé‡é™ä½50%</li></ul><h3 id="ğŸ”§-æ€§èƒ½ä¸æˆæœ¬ä¼˜åŒ–"><a class="header-anchor" href="#ğŸ”§-æ€§èƒ½ä¸æˆæœ¬ä¼˜åŒ–"></a>ğŸ”§ æ€§èƒ½ä¸æˆæœ¬ä¼˜åŒ–</h3><p>å‡ ä¸ªå®ç”¨ä¼˜åŒ–æ‰‹æ®µï¼š</p><ol><li><strong>ç¼“å­˜å¸¸è§é—®é¢˜å›ç­”</strong>ï¼š</li></ol><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_answer</span>(<span class="hljs-params">query</span>):</span>    <span class="hljs-comment"># ç¼“å­˜æŸ¥è¯¢</span>    cache_key = hash_function(query)    <span class="hljs-keyword">if</span> cache_key <span class="hljs-keyword">in</span> redis_cache:        <span class="hljs-keyword">return</span> redis_cache[cache_key]        <span class="hljs-comment"># ç”Ÿæˆæ–°å›ç­”</span>    answer = llm_chain.run(query)        <span class="hljs-comment"># å­˜å…¥ç¼“å­˜(è®¾ç½®è¿‡æœŸæ—¶é—´)</span>    redis_cache.set(cache_key, answer, ex=<span class="hljs-number">3600</span>*<span class="hljs-number">24</span>)    <span class="hljs-keyword">return</span> answer</code></pre><ol start="2"><li><strong>æµå¼å“åº”</strong>ï¼šä¸è¦ç­‰å…¨éƒ¨ç”Ÿæˆå®Œå†è¿”å›</li><li><strong>æ¨¡å‹å¤§å°é€‰æ‹©</strong>ï¼šç®€å•ä»»åŠ¡ç”¨å°æ¨¡å‹ï¼Œå¤æ‚ä»»åŠ¡ç”¨å¤§æ¨¡å‹</li><li><strong>æ‰¹é‡å¤„ç†</strong>ï¼šåˆå¹¶APIè¯·æ±‚å‡å°‘è°ƒç”¨æ¬¡æ•°</li></ol><h3 id="ğŸ”®-æœªæ¥å±•æœ›"><a class="header-anchor" href="#ğŸ”®-æœªæ¥å±•æœ›"></a>ğŸ”® æœªæ¥å±•æœ›</h3><p>æˆ‘è®¤ä¸ºå¤§æ¨¡å‹åº”ç”¨æœªæ¥ä¼šå¾€è¿™å‡ ä¸ªæ–¹å‘å‘å±•ï¼š</p><ul><li>å¤šæ¨¡æ€é›†æˆä¼šæ›´åŠ æ— ç¼</li><li>æ¨ç†èƒ½åŠ›ä¼šæ˜¾è‘—å¢å¼º</li><li>æ›´ç²¾ç»†çš„ä¸ªæ€§åŒ–ä½“éªŒ</li><li>ä¸å®é™…ä¸šåŠ¡ç³»ç»Ÿæ›´ç´§å¯†é›†æˆ</li></ul><h3 id="ğŸ’¡-ç»éªŒæ€»ç»“"><a class="header-anchor" href="#ğŸ’¡-ç»éªŒæ€»ç»“"></a>ğŸ’¡ ç»éªŒæ€»ç»“</h3><ol><li>ä¸è¦è¿·ä¿¡å¤§æ¨¡å‹ï¼Œå®ƒåªæ˜¯å·¥å…·</li><li>å…³æ³¨ç”¨æˆ·ä½“éªŒè€ŒéæŠ€æœ¯ç‚«è€€</li><li>æç¤ºå·¥ç¨‹æ˜¯æ ¸å¿ƒç«äº‰åŠ›</li><li>åšå¥½è¯„ä¼°ä¸è¿­ä»£</li><li>æ§åˆ¶æˆæœ¬åŒæ ·é‡è¦</li></ol><p>å¤§æ¨¡å‹æ—¶ä»£åˆšåˆšå¼€å§‹ï¼ŒæŠ€æœ¯è¿­ä»£æå¿«ï¼ŒæŒç»­å­¦ä¹ æ˜¯å¿…é¡»çš„ã€‚ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬æ­£ç«™åœ¨æ–°æŠ€æœ¯æµªæ½®çš„å‰æ²¿ï¼Œè¿™æ—¢æ˜¯æŒ‘æˆ˜ä¹Ÿæ˜¯å·¨å¤§çš„æœºé‡ï¼</p><h3 id="ğŸ“š-å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#ğŸ“š-å‚è€ƒèµ„æ–™"></a>ğŸ“š å‚è€ƒèµ„æ–™</h3><ol><li><a href="https://www.promptingguide.ai/">Prompt Engineering Guide</a></li><li><a href="https://docs.langchain.com/">LangChainæ–‡æ¡£</a></li><li><a href="https://learn.microsoft.com/zh-cn/azure/cognitive-services/openai/concepts/best-practices">Azure OpenAIæœ€ä½³å®è·µ</a></li><li><a href="https://huyenchip.com/2023/04/11/llm-engineering.html">Building LLM Applications</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>LLM</tag>
      
      <tag>å¤§æ¨¡å‹</tag>
      
      <tag>åº”ç”¨å¼€å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golangé”™è¯¯å¤„ç†æœ€ä½³å®è·µï¼šä»panicåˆ°ä¼˜é›…æ¢å¤</title>
    <link href="/2024/08/10/Golang%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%EF%BC%9A%E4%BB%8Epanic%E5%88%B0%E4%BC%98%E9%9B%85%E6%81%A2%E5%A4%8D/"/>
    <url>/2024/08/10/Golang%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%EF%BC%9A%E4%BB%8Epanic%E5%88%B0%E4%BC%98%E9%9B%85%E6%81%A2%E5%A4%8D/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ”-Golangé”™è¯¯å¤„ç†æœ€ä½³å®è·µï¼šä»panicåˆ°ä¼˜é›…æ¢å¤"><a class="header-anchor" href="#ğŸ”-Golangé”™è¯¯å¤„ç†æœ€ä½³å®è·µï¼šä»panicåˆ°ä¼˜é›…æ¢å¤"></a>ğŸ” Golangé”™è¯¯å¤„ç†æœ€ä½³å®è·µï¼šä»panicåˆ°ä¼˜é›…æ¢å¤</h2><p>Goè¯­è¨€ä»¥å…¶ç®€æ´ã€é«˜æ•ˆçš„é”™è¯¯å¤„ç†æœºåˆ¶è€Œè‘—ç§°ï¼Œä½†è®¸å¤šå¼€å‘è€…ä»åœ¨çº ç»“äºå¦‚ä½•ä¼˜é›…åœ°å®ç°é”™è¯¯å¤„ç†ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Goé”™è¯¯å¤„ç†çš„æœ€ä½³å®è·µï¼Œä»åŸºç¡€çš„erroræ¥å£åˆ°é«˜çº§çš„é”™è¯¯ç®¡ç†ç­–ç•¥ï¼Œå¸®åŠ©ä½ æ„å»ºæ›´å¥å£®çš„Goåº”ç”¨ã€‚</p><h3 id="ğŸ“Š-Goé”™è¯¯å¤„ç†çš„æ ¸å¿ƒç†å¿µ"><a class="header-anchor" href="#ğŸ“Š-Goé”™è¯¯å¤„ç†çš„æ ¸å¿ƒç†å¿µ"></a>ğŸ“Š Goé”™è¯¯å¤„ç†çš„æ ¸å¿ƒç†å¿µ</h3><p>Goè¯­è¨€çš„é”™è¯¯å¤„ç†éµå¾ª&quot;å‘å‰å¤±è´¥ï¼Œå‘åæ¢å¤&quot;çš„å“²å­¦ï¼Œå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒç‰¹ç‚¹ï¼š</p><ol><li><strong>æ˜¾å¼é”™è¯¯å¤„ç†</strong>ï¼šå¼ºåˆ¶æ£€æŸ¥å’Œå¤„ç†é”™è¯¯ï¼Œé¿å…éšå¼é”™è¯¯ä¼ é€’</li><li><strong>é”™è¯¯å³å€¼</strong>ï¼šé”™è¯¯æ˜¯æ™®é€šçš„è¿”å›å€¼ï¼Œè€Œéå¼‚å¸¸æœºåˆ¶</li><li><strong>åˆ†ç¦»å…³æ³¨ç‚¹</strong>ï¼šå°†é”™è¯¯å¤„ç†ä¸æ­£å¸¸é€»è¾‘åˆ†ç¦»</li><li><strong>ä¸Šä¸‹æ–‡ä¿å­˜</strong>ï¼šä¿ç•™è¶³å¤Ÿçš„é”™è¯¯ä¸Šä¸‹æ–‡ä¿¡æ¯</li></ol><h4 id="åŸºç¡€é”™è¯¯å¤„ç†æ¨¡å¼"><a class="header-anchor" href="#åŸºç¡€é”™è¯¯å¤„ç†æ¨¡å¼"></a>åŸºç¡€é”™è¯¯å¤„ç†æ¨¡å¼</h4><p>æœ€å¸¸è§çš„Goé”™è¯¯å¤„ç†æ¨¡å¼ï¼š</p><pre><code class="hljs go">result, err := someFunction()<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;    <span class="hljs-comment">// å¤„ç†é”™è¯¯</span>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err&#125;<span class="hljs-comment">// å¤„ç†ç»“æœ</span></code></pre><p>è¿™ç§æ¨¡å¼è™½ç„¶ç®€å•æ˜äº†ï¼Œä½†åœ¨å¤æ‚ç³»ç»Ÿä¸­å¯èƒ½å¯¼è‡´å¤§é‡é‡å¤ä»£ç ã€‚ä¸‹é¢æˆ‘ä»¬å°†æ¢è®¨æ›´é«˜çº§çš„é”™è¯¯å¤„ç†ç­–ç•¥ã€‚</p><h3 id="ğŸ› ï¸-é”™è¯¯åˆ›å»ºä¸åŒ…è£…"><a class="header-anchor" href="#ğŸ› ï¸-é”™è¯¯åˆ›å»ºä¸åŒ…è£…"></a>ğŸ› ï¸ é”™è¯¯åˆ›å»ºä¸åŒ…è£…</h3><h4 id="1-errorsåŒ…çš„åŸºæœ¬ä½¿ç”¨"><a class="header-anchor" href="#1-errorsåŒ…çš„åŸºæœ¬ä½¿ç”¨"></a>1. errorsåŒ…çš„åŸºæœ¬ä½¿ç”¨</h4><p>Go 1.13ä¹‹å‰ï¼Œåˆ›å»ºé”™è¯¯ä¸»è¦ä¾èµ–<code>errors.New</code>å’Œ<code>fmt.Errorf</code>ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;errors&quot;</span>    <span class="hljs-string">&quot;fmt&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">validateAge</span><span class="hljs-params">(age <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-keyword">if</span> age &lt; <span class="hljs-number">0</span> &#123;        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;å¹´é¾„ä¸èƒ½ä¸ºè´Ÿæ•°&quot;</span>)    &#125;    <span class="hljs-keyword">if</span> age &gt; <span class="hljs-number">150</span> &#123;        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;å¹´é¾„ %d è¶…å‡ºåˆç†èŒƒå›´&quot;</span>, age)    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="2-é”™è¯¯åŒ…è£…ä¸è§£åŒ…"><a class="header-anchor" href="#2-é”™è¯¯åŒ…è£…ä¸è§£åŒ…"></a>2. é”™è¯¯åŒ…è£…ä¸è§£åŒ…</h4><p>Go 1.13å¼•å…¥çš„é”™è¯¯åŒ…è£…æœºåˆ¶ï¼Œæä¾›äº†ä¿å­˜é”™è¯¯é“¾çš„èƒ½åŠ›ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;errors&quot;</span>    <span class="hljs-string">&quot;fmt&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processFile</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;    file, err := openFile(path)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;æ‰“å¼€æ–‡ä»¶å¤±è´¥: %w&quot;</span>, err)    &#125;        data, err := readData(file)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;è¯»å–æ•°æ®å¤±è´¥: %w&quot;</span>, err)    &#125;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// é”™è¯¯æ£€æŸ¥</span><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;    <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰¹å®šé”™è¯¯</span>    <span class="hljs-keyword">if</span> errors.Is(err, fs.ErrNotExist) &#123;        <span class="hljs-comment">// å¤„ç†æ–‡ä»¶ä¸å­˜åœ¨çš„æƒ…å†µ</span>    &#125;        <span class="hljs-comment">// æå–è‡ªå®šä¹‰é”™è¯¯ç±»å‹</span>    <span class="hljs-keyword">var</span> pathErr *PathError    <span class="hljs-keyword">if</span> errors.As(err, &amp;pathErr) &#123;        <span class="hljs-comment">// ä½¿ç”¨pathErrè¿›è¡Œå¤„ç†</span>    &#125;&#125;</code></pre><h4 id="3-è‡ªå®šä¹‰é”™è¯¯ç±»å‹"><a class="header-anchor" href="#3-è‡ªå®šä¹‰é”™è¯¯ç±»å‹"></a>3. è‡ªå®šä¹‰é”™è¯¯ç±»å‹</h4><p>å½“éœ€è¦é”™è¯¯æºå¸¦æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯æ—¶ï¼Œåº”å®šä¹‰è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> ValidationError <span class="hljs-keyword">struct</span> &#123;    Field <span class="hljs-keyword">string</span>    Value <span class="hljs-keyword">interface</span>&#123;&#125;    Reason <span class="hljs-keyword">string</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *ValidationError)</span> <span class="hljs-title">Error</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;å­—æ®µ &#x27;%s&#x27; éªŒè¯å¤±è´¥: %s (å€¼: %v)&quot;</span>, e.Field, e.Reason, e.Value)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">validateUser</span><span class="hljs-params">(user User)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(user.Name) &lt; <span class="hljs-number">2</span> &#123;        <span class="hljs-keyword">return</span> &amp;ValidationError&#123;            Field: <span class="hljs-string">&quot;name&quot;</span>,            Value: user.Name,            Reason: <span class="hljs-string">&quot;åç§°é•¿åº¦è‡³å°‘ä¸º2ä¸ªå­—ç¬¦&quot;</span>,        &#125;    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h3 id="âš¡-Panicä¸Recoveræœºåˆ¶"><a class="header-anchor" href="#âš¡-Panicä¸Recoveræœºåˆ¶"></a>âš¡ Panicä¸Recoveræœºåˆ¶</h3><p>Panicæ˜¯Goä¸­çš„å¼‚å¸¸æœºåˆ¶ï¼Œé€‚ç”¨äºçœŸæ­£æ— æ³•æ¢å¤çš„æƒ…å†µã€‚ä½†åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåº”ä¼˜å…ˆä½¿ç”¨é”™è¯¯è¿”å›å€¼è€Œépanicã€‚</p><h4 id="1-ä½•æ—¶ä½¿ç”¨panic"><a class="header-anchor" href="#1-ä½•æ—¶ä½¿ç”¨panic"></a>1. ä½•æ—¶ä½¿ç”¨panic</h4><ul><li>ç¨‹åºåˆå§‹åŒ–å¤±è´¥ï¼ˆå¦‚é…ç½®é”™è¯¯ï¼‰</li><li>æ˜æ˜¾çš„ç¨‹åºå‘˜é”™è¯¯ï¼ˆå¦‚ç´¢å¼•è¶Šç•Œï¼‰</li><li>ä¸å¯æ¢å¤çš„æƒ…å†µï¼ˆå¦‚ç¡¬ç›˜æŸåï¼‰</li></ul><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initConfig</span><span class="hljs-params">()</span></span> &#123;    config, err := loadConfig(<span class="hljs-string">&quot;config.json&quot;</span>)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">&quot;åˆå§‹åŒ–é…ç½®å¤±è´¥: %v&quot;</span>, err))    &#125;&#125;</code></pre><h4 id="2-ä½¿ç”¨recoverä¼˜é›…æ¢å¤"><a class="header-anchor" href="#2-ä½¿ç”¨recoverä¼˜é›…æ¢å¤"></a>2. ä½¿ç”¨recoverä¼˜é›…æ¢å¤</h4><p>recoverå¯ä»¥æ•è·panicï¼Œä½†åªèƒ½åœ¨deferå‡½æ•°ä¸­ä½¿ç”¨ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processRequest</span><span class="hljs-params">(req *Request)</span> <span class="hljs-params">(response <span class="hljs-keyword">string</span>)</span></span> &#123;    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> &#123;            log.Printf(<span class="hljs-string">&quot;è¯·æ±‚å¤„ç†å‡ºç°ä¸¥é‡é”™è¯¯: %v&quot;</span>, r)            response = <span class="hljs-string">`&#123;&quot;status&quot;:&quot;error&quot;,&quot;message&quot;:&quot;å†…éƒ¨æœåŠ¡å™¨é”™è¯¯&quot;&#125;`</span>        &#125;    &#125;()        <span class="hljs-comment">// æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘</span>    <span class="hljs-keyword">return</span> processBusinessLogic(req)&#125;</code></pre><h4 id="3-ä»åº“ä¸­è½¬æ¢panicä¸ºerror"><a class="header-anchor" href="#3-ä»åº“ä¸­è½¬æ¢panicä¸ºerror"></a>3. ä»åº“ä¸­è½¬æ¢panicä¸ºerror</h4><p>å½“è°ƒç”¨å¯èƒ½panicçš„ç¬¬ä¸‰æ–¹åº“æ—¶ï¼Œåº”å°†å…¶è½¬æ¢ä¸ºæ­£å¸¸çš„é”™è¯¯å¤„ç†ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">safeOperation</span><span class="hljs-params">()</span> <span class="hljs-params">(result <span class="hljs-keyword">string</span>, err error)</span></span> &#123;    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> &#123;            err = fmt.Errorf(<span class="hljs-string">&quot;æ“ä½œå¤±è´¥: %v&quot;</span>, r)        &#125;    &#125;()        <span class="hljs-comment">// å¯èƒ½å¯¼è‡´panicçš„æ“ä½œ</span>    result = riskyLibraryCall()    <span class="hljs-keyword">return</span> result, <span class="hljs-literal">nil</span>&#125;</code></pre><h3 id="ğŸ§©-é”™è¯¯å¤„ç†æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸ§©-é”™è¯¯å¤„ç†æœ€ä½³å®è·µ"></a>ğŸ§© é”™è¯¯å¤„ç†æœ€ä½³å®è·µ</h3><h4 id="1-ä¸è¦å¿½ç•¥é”™è¯¯"><a class="header-anchor" href="#1-ä¸è¦å¿½ç•¥é”™è¯¯"></a>1. ä¸è¦å¿½ç•¥é”™è¯¯</h4><p>æœ€ç³Ÿç³•çš„é”™è¯¯å¤„ç†æ˜¯ä¸å¤„ç†ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// é”™è¯¯ç¤ºä¾‹ âŒ</span>file, _ := os.Open(<span class="hljs-string">&quot;file.txt&quot;</span>)<span class="hljs-comment">// æ­£ç¡®ç¤ºä¾‹ âœ…</span>file, err := os.Open(<span class="hljs-string">&quot;file.txt&quot;</span>)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;    log.Fatalf(<span class="hljs-string">&quot;æ— æ³•æ‰“å¼€æ–‡ä»¶: %v&quot;</span>, err)&#125;</code></pre><h4 id="2-æ·»åŠ è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯"><a class="header-anchor" href="#2-æ·»åŠ è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯"></a>2. æ·»åŠ è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯</h4><p>é”™è¯¯åº”åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// é”™è¯¯ç¤ºä¾‹ âŒ</span><span class="hljs-keyword">return</span> err<span class="hljs-comment">// æ­£ç¡®ç¤ºä¾‹ âœ…</span><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;å¤„ç†ç”¨æˆ· %s çš„è®¢å• %d æ—¶å¤±è´¥: %w&quot;</span>, userID, orderID, err)</code></pre><h4 id="3-åœ¨é€‚å½“çš„å±‚çº§å¤„ç†é”™è¯¯"><a class="header-anchor" href="#3-åœ¨é€‚å½“çš„å±‚çº§å¤„ç†é”™è¯¯"></a>3. åœ¨é€‚å½“çš„å±‚çº§å¤„ç†é”™è¯¯</h4><p>ä¸æ˜¯æ‰€æœ‰é”™è¯¯éƒ½éœ€è¦å‘ä¸Šä¼ æ’­ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processRecords</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;    records, err := fetchRecords()    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;è·å–è®°å½•å¤±è´¥: %w&quot;</span>, err)    &#125;        <span class="hljs-keyword">for</span> _, record := <span class="hljs-keyword">range</span> records &#123;        <span class="hljs-comment">// å•æ¡è®°å½•å¤„ç†å¤±è´¥ä¸åº”å¯¼è‡´æ•´ä¸ªæ“ä½œå¤±è´¥</span>        <span class="hljs-keyword">if</span> err := processRecord(record); err != <span class="hljs-literal">nil</span> &#123;            log.Printf(<span class="hljs-string">&quot;å¤„ç†è®°å½• %s å¤±è´¥: %v&quot;</span>, record.ID, err)            <span class="hljs-keyword">continue</span>        &#125;    &#125;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="4-ä½¿ç”¨ç»“æ„åŒ–é”™è¯¯å¤„ç†"><a class="header-anchor" href="#4-ä½¿ç”¨ç»“æ„åŒ–é”™è¯¯å¤„ç†"></a>4. ä½¿ç”¨ç»“æ„åŒ–é”™è¯¯å¤„ç†</h4><p>å¯¹äºå¤æ‚åº”ç”¨ï¼Œåº”è€ƒè™‘é‡‡ç”¨ç»“æ„åŒ–çš„é”™è¯¯å¤„ç†åº“ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/pkg/errors&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    err := deepFunction()    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-comment">// æ‰“å°å®Œæ•´å †æ ˆ</span>        fmt.Printf(<span class="hljs-string">&quot;%+v\n&quot;</span>, err)    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deepFunction</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-comment">// ...</span>    <span class="hljs-keyword">return</span> errors.Wrap(err, <span class="hljs-string">&quot;æ·±å±‚å‡½æ•°å¤±è´¥&quot;</span>)&#125;</code></pre><h3 id="ğŸš€-é«˜çº§é”™è¯¯å¤„ç†æ¨¡å¼"><a class="header-anchor" href="#ğŸš€-é«˜çº§é”™è¯¯å¤„ç†æ¨¡å¼"></a>ğŸš€ é«˜çº§é”™è¯¯å¤„ç†æ¨¡å¼</h3><h4 id="1-é”™è¯¯å¤„ç†ä¸­é—´ä»¶"><a class="header-anchor" href="#1-é”™è¯¯å¤„ç†ä¸­é—´ä»¶"></a>1. é”™è¯¯å¤„ç†ä¸­é—´ä»¶</h4><p>åœ¨WebæœåŠ¡ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶ç»Ÿä¸€å¤„ç†é”™è¯¯ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">errorMiddleware</span><span class="hljs-params">(next http.Handler)</span> <span class="hljs-title">http</span>.<span class="hljs-title">Handler</span></span> &#123;    <span class="hljs-keyword">return</span> http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;            <span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;                log.Printf(<span class="hljs-string">&quot;è¯·æ±‚å¤„ç†panic: %v&quot;</span>, err)                http.Error(w, <span class="hljs-string">&quot;å†…éƒ¨æœåŠ¡å™¨é”™è¯¯&quot;</span>, http.StatusInternalServerError)            &#125;        &#125;()        next.ServeHTTP(w, r)    &#125;)&#125;</code></pre><h4 id="2-é”™è¯¯é‡è¯•ç­–ç•¥"><a class="header-anchor" href="#2-é”™è¯¯é‡è¯•ç­–ç•¥"></a>2. é”™è¯¯é‡è¯•ç­–ç•¥</h4><p>å¯¹äºå¯é‡è¯•çš„é”™è¯¯ï¼Œå®ç°æŒ‡æ•°é€€é¿é‡è¯•ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fetchWithRetry</span><span class="hljs-params">(url <span class="hljs-keyword">string</span>, maxRetries <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, error)</span></span> &#123;    <span class="hljs-keyword">var</span> err error    <span class="hljs-keyword">var</span> resp *http.Response        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; maxRetries; i++ &#123;        resp, err = http.Get(url)        <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">defer</span> resp.Body.Close()            <span class="hljs-keyword">return</span> ioutil.ReadAll(resp.Body)        &#125;                <span class="hljs-comment">// æŒ‡æ•°é€€é¿</span>        waitTime := time.Duration(math.Pow(<span class="hljs-number">2</span>, <span class="hljs-keyword">float64</span>(i))) * time.Second        log.Printf(<span class="hljs-string">&quot;ç¬¬%dæ¬¡è¯·æ±‚å¤±è´¥: %vï¼Œ%såé‡è¯•&quot;</span>, i+<span class="hljs-number">1</span>, err, waitTime)        time.Sleep(waitTime)    &#125;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° (%d): %w&quot;</span>, maxRetries, err)&#125;</code></pre><h4 id="3-Resultç±»å‹æ¨¡å¼"><a class="header-anchor" href="#3-Resultç±»å‹æ¨¡å¼"></a>3. Resultç±»å‹æ¨¡å¼</h4><p>å—å‡½æ•°å¼ç¼–ç¨‹å¯å‘ï¼Œå¯ä»¥ä½¿ç”¨Resultç±»å‹å°è£…æˆåŠŸæˆ–é”™è¯¯ç»“æœï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Result[T any] <span class="hljs-keyword">struct</span> &#123;    Value T    Err   error&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r Result[T])</span> <span class="hljs-title">Unwrap</span><span class="hljs-params">()</span> <span class="hljs-params">(T, error)</span></span> &#123;    <span class="hljs-keyword">return</span> r.Value, r.Err&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r Result[T])</span> <span class="hljs-title">Map</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>(T)</span> <span class="hljs-params">(T, error)</span>) <span class="hljs-title">Result</span>[<span class="hljs-title">T</span>]</span> &#123;    <span class="hljs-keyword">if</span> r.Err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> r    &#125;    val, err := f(r.Value)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> Result[T]&#123;Err: err&#125;    &#125;    <span class="hljs-keyword">return</span> Result[T]&#123;Value: val&#125;&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">process</span><span class="hljs-params">()</span> <span class="hljs-title">Result</span>[<span class="hljs-title">User</span>]</span> &#123;    <span class="hljs-keyword">return</span> Result[User]&#123;Value: User&#123;&#125;, Err: <span class="hljs-literal">nil</span>&#125;.        Map(validateUser).        Map(enrichUser).        Map(saveUser)&#125;user, err := process().Unwrap()</code></pre><h3 id="ğŸ“ˆ-æ€§èƒ½è€ƒé‡"><a class="header-anchor" href="#ğŸ“ˆ-æ€§èƒ½è€ƒé‡"></a>ğŸ“ˆ æ€§èƒ½è€ƒé‡</h3><p>é”™è¯¯å¤„ç†ä¹Ÿéœ€è¦å…³æ³¨æ€§èƒ½ï¼Œå°¤å…¶åœ¨é«˜æ€§èƒ½åœºæ™¯ä¸­ï¼š</p><ol><li><strong>é¿å…è¿‡åº¦åŒ…è£…</strong>ï¼šæ¯æ¬¡é”™è¯¯åŒ…è£…éƒ½ä¼šå¢åŠ å¼€é”€</li><li><strong>åˆç†ä½¿ç”¨å †æ ˆ</strong>ï¼šä»…åœ¨å…³é”®ç‚¹æ”¶é›†å †æ ˆä¿¡æ¯</li><li><strong>é”™è¯¯å¯¹è±¡æ± åŒ–</strong>ï¼šé¢‘ç¹çš„é”™è¯¯å¯ä»¥è€ƒè™‘å¯¹è±¡æ± åŒ–</li></ol><pre><code class="hljs go"><span class="hljs-keyword">var</span> ErrUserNotFound = errors.New(<span class="hljs-string">&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</span>)<span class="hljs-comment">// ä½¿ç”¨é¢„å®šä¹‰é”™è¯¯è€Œéæ¯æ¬¡åˆ›å»º</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findUser</span><span class="hljs-params">(id <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*User, error)</span></span> &#123;    user, exists := userStore[id]    <span class="hljs-keyword">if</span> !exists &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, ErrUserNotFound  <span class="hljs-comment">// å¤ç”¨é”™è¯¯å¯¹è±¡</span>    &#125;    <span class="hljs-keyword">return</span> user, <span class="hljs-literal">nil</span>&#125;</code></pre><h3 id="ğŸ’¡-Go-1-20-é”™è¯¯å¤„ç†çš„æ–°ç‰¹æ€§"><a class="header-anchor" href="#ğŸ’¡-Go-1-20-é”™è¯¯å¤„ç†çš„æ–°ç‰¹æ€§"></a>ğŸ’¡ Go 1.20+é”™è¯¯å¤„ç†çš„æ–°ç‰¹æ€§</h3><p>Go 1.20å¼•å…¥äº†<code>errors.Join</code>å‡½æ•°ï¼Œå¯ä»¥å°†å¤šä¸ªé”™è¯¯åˆå¹¶ä¸ºä¸€ä¸ªï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processMultipleItems</span><span class="hljs-params">(items []Item)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-keyword">var</span> errs []error    <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;        <span class="hljs-keyword">if</span> err := processItem(item); err != <span class="hljs-literal">nil</span> &#123;            errs = <span class="hljs-built_in">append</span>(errs, err)        &#125;    &#125;        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(errs) &gt; <span class="hljs-number">0</span> &#123;        <span class="hljs-keyword">return</span> errors.Join(errs...)    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h3 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h3><p>Goè¯­è¨€çš„é”™è¯¯å¤„ç†è™½ç®€å•å´å¼ºå¤§ï¼ŒæŒæ¡å…¶æœ€ä½³å®è·µèƒ½æ˜¾è‘—æå‡ä»£ç è´¨é‡ï¼š</p><ol><li><strong>é‡è§†é”™è¯¯å¤„ç†</strong>ï¼šåœ¨Goä¸­ï¼Œé”™è¯¯å¤„ç†æ˜¯é¦–è¦å…¬æ°‘</li><li><strong>ä¿ç•™ä¸Šä¸‹æ–‡</strong>ï¼šé€šè¿‡é”™è¯¯åŒ…è£…å’Œè‡ªå®šä¹‰é”™è¯¯ç±»å‹æä¾›ä¸°å¯Œä¸Šä¸‹æ–‡</li><li><strong>é€‚å½“å±‚çº§å¤„ç†</strong>ï¼šåœ¨æœ€åˆé€‚çš„å±‚çº§å¤„ç†é”™è¯¯</li><li><strong>æœ‰é€‰æ‹©åœ°ä½¿ç”¨panic</strong>ï¼šä»…åœ¨çœŸæ­£ä¸å¯æ¢å¤çš„æƒ…å†µä¸‹ä½¿ç”¨</li><li><strong>æ„å»ºé”™è¯¯å¤„ç†æ¡†æ¶</strong>ï¼šä¸ºå¤§å‹é¡¹ç›®æ„å»ºç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¡†æ¶</li></ol><p>éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œä½ çš„Goåº”ç”¨å°†æ›´åŠ å¥å£®ï¼Œé”™è¯¯æ›´æ˜“äºç†è§£å’Œè°ƒè¯•ï¼ŒåŒæ—¶ä¿æŒGoä»£ç çš„ç®€æ´ä¼˜é›…ç‰¹æ€§ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>é”™è¯¯å¤„ç†</tag>
      
      <tag>æœ€ä½³å®è·µ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè¯­è¨€å†…å­˜ç®¡ç†æ¨¡å‹æ·±åº¦è§£æ</title>
    <link href="/2024/08/08/go%E8%AF%AD%E8%A8%80%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9E%8B%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"/>
    <url>/2024/08/08/go%E8%AF%AD%E8%A8%80%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9E%8B%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ”-Goè¯­è¨€å†…å­˜ç®¡ç†æ¨¡å‹æ·±åº¦è§£æ"><a class="header-anchor" href="#ğŸ”-Goè¯­è¨€å†…å­˜ç®¡ç†æ¨¡å‹æ·±åº¦è§£æ"></a>ğŸ” Goè¯­è¨€å†…å­˜ç®¡ç†æ¨¡å‹æ·±åº¦è§£æ</h2><p>Goè¯­è¨€ä½œä¸ºä¸€ç§ç°ä»£åŒ–çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ‹¥æœ‰è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œè¿™è®©å¼€å‘è€…èƒ½å¤Ÿæ›´ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘è€Œéå†…å­˜æ“ä½œã€‚ä½†æ˜¯ï¼Œæ·±å…¥ç†è§£Goçš„å†…å­˜ç®¡ç†æ¨¡å‹å¯¹äºç¼–å†™é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿçš„åº”ç”¨ç¨‹åºè‡³å…³é‡è¦ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Goè¯­è¨€çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œè§£æå…¶å·¥ä½œåŸç†ï¼Œå¹¶æä¾›ä¼˜åŒ–å»ºè®®ã€‚</p><h3 id="ğŸ“¦-Goå†…å­˜åˆ†é…åŸºç¡€"><a class="header-anchor" href="#ğŸ“¦-Goå†…å­˜åˆ†é…åŸºç¡€"></a>ğŸ“¦ Goå†…å­˜åˆ†é…åŸºç¡€</h3><h4 id="TCMallocå¯å‘çš„å†…å­˜åˆ†é…å™¨"><a class="header-anchor" href="#TCMallocå¯å‘çš„å†…å­˜åˆ†é…å™¨"></a>TCMallocå¯å‘çš„å†…å­˜åˆ†é…å™¨</h4><p>Goçš„å†…å­˜åˆ†é…å™¨å€Ÿé‰´äº†TCMallocï¼ˆThread-Caching Mallocï¼‰çš„è®¾è®¡æ€æƒ³ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå±‚æ¬¡ï¼š</p><ol><li><strong>mcache</strong>: æ¯ä¸ªPï¼ˆå¤„ç†å™¨ï¼‰ç§æœ‰çš„ç¼“å­˜ï¼Œæ— éœ€åŠ é”ï¼Œåˆ†é…å°å¯¹è±¡æ—¶æ€§èƒ½æé«˜</li><li><strong>mcentral</strong>: å…¨å±€çš„ä¸­å¤®ç¼“å­˜ï¼Œå½“mcacheä¸è¶³æ—¶å‘å…¶è·å–å†…å­˜</li><li><strong>mheap</strong>: å †å†…å­˜ï¼Œå½“mcentralä¸è¶³æ—¶å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜</li></ol><p>è¿™ç§å¤šçº§ç¼“å­˜çš„è®¾è®¡å¤§å¤§å‡å°‘äº†é”ç«äº‰ï¼Œæé«˜äº†å†…å­˜åˆ†é…çš„æ•ˆç‡ã€‚</p><pre><code class="hljs go"><span class="hljs-comment">// æ¼”ç¤ºå†…å­˜åˆ†é…è¿‡ç¨‹çš„ç®€åŒ–ä¼ªä»£ç </span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">allocate</span><span class="hljs-params">(size <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">unsafe</span>.<span class="hljs-title">Pointer</span></span> &#123;    <span class="hljs-comment">// å°å¯¹è±¡ç›´æ¥ä»Pçš„mcacheåˆ†é…</span>    <span class="hljs-keyword">if</span> size &lt;= maxSmallSize &#123;        <span class="hljs-keyword">return</span> mcache.alloc(size)    &#125;        <span class="hljs-comment">// ä¸­ç­‰å¯¹è±¡ä»mcentralåˆ†é…</span>    <span class="hljs-keyword">if</span> size &lt;= maxMediumSize &#123;        <span class="hljs-keyword">return</span> mcentral.alloc(size)    &#125;        <span class="hljs-comment">// å¤§å¯¹è±¡ç›´æ¥ä»mheapåˆ†é…</span>    <span class="hljs-keyword">return</span> mheap.alloc(size)&#125;</code></pre><h4 id="å¯¹è±¡å¤§å°åˆ†ç±»"><a class="header-anchor" href="#å¯¹è±¡å¤§å°åˆ†ç±»"></a>å¯¹è±¡å¤§å°åˆ†ç±»</h4><p>Goå°†å¯¹è±¡æŒ‰å¤§å°åˆ†ä¸ºä¸‰ç±»ï¼š</p><ol><li><strong>å¾®å°å¯¹è±¡</strong>ï¼ˆ0~16Bï¼‰ï¼šç›´æ¥åœ¨å½“å‰Pçš„mcacheä¸Šåˆ†é…</li><li><strong>å°å¯¹è±¡</strong>ï¼ˆ16B~32KBï¼‰ï¼šä»å¯¹åº”å°ºå¯¸çš„mspanä¸­åˆ†é…</li><li><strong>å¤§å¯¹è±¡</strong>ï¼ˆ&gt;32KBï¼‰ï¼šç›´æ¥ä»mheapåˆ†é…</li></ol><p>å¯¹è±¡å¤§å°ä¸å†…å­˜åˆ†é…ç­–ç•¥çš„å¯¹åº”å…³ç³»ï¼š</p><table><thead><tr><th>å¯¹è±¡å¤§å°</th><th>åˆ†é…ç­–ç•¥</th><th>ä¼˜åŠ¿</th></tr></thead><tbody><tr><td>å¾®å°å¯¹è±¡</td><td>mcache</td><td>æå¿«ï¼Œæ— é”</td></tr><tr><td>å°å¯¹è±¡</td><td>mspan</td><td>å¿«é€Ÿï¼Œå†…å­˜åˆ©ç”¨ç‡é«˜</td></tr><tr><td>å¤§å¯¹è±¡</td><td>mheap</td><td>é¿å…å†…å­˜ç¢ç‰‡</td></tr></tbody></table><h3 id="ğŸ”„-åƒåœ¾å›æ”¶æœºåˆ¶"><a class="header-anchor" href="#ğŸ”„-åƒåœ¾å›æ”¶æœºåˆ¶"></a>ğŸ”„ åƒåœ¾å›æ”¶æœºåˆ¶</h3><h4 id="ä¸‰è‰²æ ‡è®°-æ¸…é™¤ç®—æ³•"><a class="header-anchor" href="#ä¸‰è‰²æ ‡è®°-æ¸…é™¤ç®—æ³•"></a>ä¸‰è‰²æ ‡è®°-æ¸…é™¤ç®—æ³•</h4><p>Goä½¿ç”¨å¹¶å‘çš„ä¸‰è‰²æ ‡è®°-æ¸…é™¤ç®—æ³•è¿›è¡Œåƒåœ¾å›æ”¶ï¼š</p><ol><li><strong>ç™½è‰²</strong>ï¼šæ½œåœ¨çš„åƒåœ¾ï¼Œå°šæœªè¢«å›æ”¶å™¨è®¿é—®</li><li><strong>ç°è‰²</strong>ï¼šå·²è¢«å›æ”¶å™¨è®¿é—®ï¼Œä½†å…¶å¼•ç”¨çš„å¯¹è±¡å°šæœªå…¨éƒ¨è¢«è®¿é—®</li><li><strong>é»‘è‰²</strong>ï¼šå·²è¢«å›æ”¶å™¨è®¿é—®ï¼Œä¸”å…¶å¼•ç”¨çš„å¯¹è±¡ä¹Ÿå·²å…¨éƒ¨è¢«è®¿é—®</li></ol><p>å·¥ä½œæµç¨‹ï¼š</p><pre><code class="hljs angelscript"><span class="hljs-number">1.</span> åˆå§‹æ—¶æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ç™½è‰²<span class="hljs-number">2.</span> ä»æ ¹å¯¹è±¡å¼€å§‹ï¼Œå°†å…¶æ ‡è®°ä¸ºç°è‰²å¹¶åŠ å…¥é˜Ÿåˆ—<span class="hljs-number">3.</span> ä»é˜Ÿåˆ—å–å‡ºç°è‰²å¯¹è±¡ï¼Œå°†å…¶å¼•ç”¨çš„ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²å¹¶åŠ å…¥é˜Ÿåˆ—ï¼Œç„¶åå°†è‡ªå·±æ ‡è®°ä¸ºé»‘è‰²<span class="hljs-number">4.</span> é‡å¤æ­¥éª¤<span class="hljs-number">3</span>ç›´åˆ°ç°è‰²å¯¹è±¡é˜Ÿåˆ—ä¸ºç©º<span class="hljs-number">5.</span> æ­¤æ—¶æ‰€æœ‰å¯è¾¾å¯¹è±¡éƒ½æ˜¯é»‘è‰²ï¼Œç™½è‰²å¯¹è±¡å³ä¸ºåƒåœ¾ï¼Œè¿›è¡Œå›æ”¶</code></pre><h4 id="å†™å±éšœä¸è¾…åŠ©GC"><a class="header-anchor" href="#å†™å±éšœä¸è¾…åŠ©GC"></a>å†™å±éšœä¸è¾…åŠ©GC</h4><p>ä¸ºäº†å¤„ç†æ ‡è®°è¿‡ç¨‹ä¸­çš„å¯¹è±¡å˜åŒ–ï¼ŒGoä½¿ç”¨äº†å†™å±éšœæŠ€æœ¯ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// å†™å±éšœä¼ªä»£ç ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">writePointer</span><span class="hljs-params">(slot, ptr *object)</span></span> &#123;    <span class="hljs-comment">// åœ¨ä¿®æ”¹æŒ‡é’ˆå‰æ‰§è¡Œå†™å±éšœ</span>    shade(ptr)  <span class="hljs-comment">// ç¡®ä¿ptrè¢«æ ‡è®°ä¸ºç°è‰²æˆ–é»‘è‰²</span>        <span class="hljs-comment">// å®é™…çš„æŒ‡é’ˆå†™å…¥</span>    *slot = ptr&#125;</code></pre><p>å½“å†…å­˜åˆ†é…é€Ÿåº¦è¶…è¿‡GCé€Ÿåº¦æ—¶ï¼Œä¼šè§¦å‘è¾…åŠ©GCï¼Œè®©åˆ†é…å†…å­˜çš„goroutineä¹Ÿå‚ä¸åˆ°GCå·¥ä½œä¸­ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// è¾…åŠ©GCä¼ªä»£ç </span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mallocgc</span><span class="hljs-params">(size <span class="hljs-keyword">uintptr</span>)</span> *<span class="hljs-title">object</span></span> &#123;    <span class="hljs-comment">// è®¡ç®—éœ€è¦è¾…åŠ©çš„å·¥ä½œé‡</span>    assistWorkPerByte := gcController.assistWorkPerByte    assistWork := <span class="hljs-keyword">int64</span>(size * assistWorkPerByte)        <span class="hljs-comment">// æ‰§è¡Œä¸€äº›GCå·¥ä½œ</span>    gcAssistAlloc(assistWork)        <span class="hljs-comment">// åˆ†é…å†…å­˜</span>    <span class="hljs-keyword">return</span> allocate(size)&#125;</code></pre><h4 id="GCè°ƒä¼˜å‚æ•°"><a class="header-anchor" href="#GCè°ƒä¼˜å‚æ•°"></a>GCè°ƒä¼˜å‚æ•°</h4><p>Goæä¾›äº†å‡ ä¸ªç¯å¢ƒå˜é‡ç”¨äºè°ƒä¼˜GCï¼š</p><ul><li><strong>GOGC</strong>: æ§åˆ¶è§¦å‘GCçš„å †å†…å­˜å¢é•¿æ¯”ä¾‹ï¼Œé»˜è®¤ä¸º100ï¼Œæ„å‘³ç€å½“å †å†…å­˜å¢é•¿åˆ°ä¸Šæ¬¡GCåçš„ä¸¤å€æ—¶è§¦å‘ä¸‹ä¸€æ¬¡GC</li><li><strong>GOMEMLIMIT</strong>: Go 1.19å¼•å…¥ï¼Œé™åˆ¶ç¨‹åºä½¿ç”¨çš„æœ€å¤§å†…å­˜é‡</li><li><strong>GODEBUG=gctrace=1</strong>: æ‰“å°GCç›¸å…³çš„è·Ÿè¸ªä¿¡æ¯</li></ul><pre><code class="hljs bash"><span class="hljs-comment"># è®¾ç½®GOGCä¸º200ï¼Œé™ä½GCé¢‘ç‡ï¼Œé€‚ç”¨äºå†…å­˜å……è¶³çš„åœºæ™¯</span>GOGC=200 ./myapp<span class="hljs-comment"># é™åˆ¶æœ€å¤§å†…å­˜ä½¿ç”¨ä¸º4GB</span>GOMEMLIMIT=4GiB ./myapp<span class="hljs-comment"># å¼€å¯GCè·Ÿè¸ª</span>GODEBUG=gctrace=1 ./myapp</code></pre><h3 id="ğŸš€-å†…å­˜ä¼˜åŒ–å®è·µ"><a class="header-anchor" href="#ğŸš€-å†…å­˜ä¼˜åŒ–å®è·µ"></a>ğŸš€ å†…å­˜ä¼˜åŒ–å®è·µ</h3><h4 id="å¯¹è±¡æ± åŒ–"><a class="header-anchor" href="#å¯¹è±¡æ± åŒ–"></a>å¯¹è±¡æ± åŒ–</h4><p>å¯¹äºé¢‘ç¹åˆ›å»ºå’Œé”€æ¯çš„å¯¹è±¡ï¼Œä½¿ç”¨sync.Poolå¯ä»¥æ˜¾è‘—å‡å°‘GCå‹åŠ›ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">var</span> bufferPool = sync.Pool&#123;    New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;        <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(bytes.Buffer)    &#125;,&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processRequest</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">string</span></span> &#123;    <span class="hljs-comment">// ä»å¯¹è±¡æ± è·å–buffer</span>    buf := bufferPool.Get().(*bytes.Buffer)    buf.Reset()        <span class="hljs-comment">// ä½¿ç”¨buffer</span>    buf.Write(data)    result := process(buf.Bytes())        <span class="hljs-comment">// å½’è¿˜bufferåˆ°å¯¹è±¡æ± </span>    bufferPool.Put(buf)        <span class="hljs-keyword">return</span> result&#125;</code></pre><h4 id="é¢„åˆ†é…å†…å­˜"><a class="header-anchor" href="#é¢„åˆ†é…å†…å­˜"></a>é¢„åˆ†é…å†…å­˜</h4><p>å¯¹äºå·²çŸ¥å¤§å°çš„åˆ‡ç‰‡ï¼Œé¢„åˆ†é…å†…å­˜å¯ä»¥é¿å…å¤šæ¬¡æ‰©å®¹ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä½æ•ˆæ–¹å¼ï¼šå¯èƒ½å¯¼è‡´å¤šæ¬¡æ‰©å®¹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processItems</span><span class="hljs-params">(count <span class="hljs-keyword">int</span>)</span> []<span class="hljs-title">Item</span></span> &#123;    <span class="hljs-keyword">var</span> items []Item    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; count; i++ &#123;        items = <span class="hljs-built_in">append</span>(items, createItem(i))    &#125;    <span class="hljs-keyword">return</span> items&#125;<span class="hljs-comment">// ä¼˜åŒ–æ–¹å¼ï¼šä¸€æ¬¡æ€§åˆ†é…è¶³å¤Ÿçš„å†…å­˜</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processItemsOptimized</span><span class="hljs-params">(count <span class="hljs-keyword">int</span>)</span> []<span class="hljs-title">Item</span></span> &#123;    items := <span class="hljs-built_in">make</span>([]Item, <span class="hljs-number">0</span>, count) <span class="hljs-comment">// é¢„åˆ†é…countä¸ªå…ƒç´ çš„å®¹é‡</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; count; i++ &#123;        items = <span class="hljs-built_in">append</span>(items, createItem(i))    &#125;    <span class="hljs-keyword">return</span> items&#125;</code></pre><h4 id="å‡å°‘ä¸´æ—¶å¯¹è±¡åˆ›å»º"><a class="header-anchor" href="#å‡å°‘ä¸´æ—¶å¯¹è±¡åˆ›å»º"></a>å‡å°‘ä¸´æ—¶å¯¹è±¡åˆ›å»º</h4><p>é¿å…åœ¨çƒ­ç‚¹ä»£ç è·¯å¾„ä¸Šåˆ›å»ºä¸´æ—¶å¯¹è±¡ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä½æ•ˆæ–¹å¼ï¼šæ¯æ¬¡è¿­ä»£åˆ›å»ºæ–°çš„å­—ç¬¦ä¸²</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">concatenateStrings</span><span class="hljs-params">(items []<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;    result := <span class="hljs-string">&quot;&quot;</span>    <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;        result += item <span class="hljs-comment">// åˆ›å»ºä¸´æ—¶å­—ç¬¦ä¸²</span>    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-comment">// ä¼˜åŒ–æ–¹å¼ï¼šä½¿ç”¨strings.Builder</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">concatenateStringsOptimized</span><span class="hljs-params">(items []<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;    <span class="hljs-keyword">var</span> builder strings.Builder    <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;        builder.WriteString(item)    &#125;    <span class="hljs-keyword">return</span> builder.String()&#125;</code></pre><h4 id="å†…å­˜å¯¹é½å’Œç»“æ„ä½“ä¼˜åŒ–"><a class="header-anchor" href="#å†…å­˜å¯¹é½å’Œç»“æ„ä½“ä¼˜åŒ–"></a>å†…å­˜å¯¹é½å’Œç»“æ„ä½“ä¼˜åŒ–</h4><p>åˆç†æ’åˆ—ç»“æ„ä½“å­—æ®µï¼Œå‡å°‘å†…å­˜å¡«å……ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä½æ•ˆç»“æ„ä½“ï¼šæµªè´¹å†…å­˜</span><span class="hljs-keyword">type</span> Inefficient <span class="hljs-keyword">struct</span> &#123;    A <span class="hljs-keyword">byte</span>       <span class="hljs-comment">// 1å­—èŠ‚ï¼Œä½†ä¼šå ç”¨8å­—èŠ‚</span>    B <span class="hljs-keyword">int64</span>      <span class="hljs-comment">// 8å­—èŠ‚</span>    C <span class="hljs-keyword">byte</span>       <span class="hljs-comment">// 1å­—èŠ‚ï¼Œä½†ä¼šå ç”¨8å­—èŠ‚</span>    D <span class="hljs-keyword">int64</span>      <span class="hljs-comment">// 8å­—èŠ‚</span>&#125;<span class="hljs-comment">// æ€»å…±éœ€è¦32å­—èŠ‚</span><span class="hljs-comment">// ä¼˜åŒ–ç»“æ„ä½“ï¼šç›¸ä¼¼å¤§å°çš„å­—æ®µæ”¾ä¸€èµ·</span><span class="hljs-keyword">type</span> Efficient <span class="hljs-keyword">struct</span> &#123;    B <span class="hljs-keyword">int64</span>      <span class="hljs-comment">// 8å­—èŠ‚</span>    D <span class="hljs-keyword">int64</span>      <span class="hljs-comment">// 8å­—èŠ‚</span>    A <span class="hljs-keyword">byte</span>       <span class="hljs-comment">// 1å­—èŠ‚</span>    C <span class="hljs-keyword">byte</span>       <span class="hljs-comment">// 1å­—èŠ‚</span>    <span class="hljs-comment">// å¡«å……6å­—èŠ‚</span>&#125;<span class="hljs-comment">// æ€»å…±éœ€è¦24å­—èŠ‚</span></code></pre><h3 id="ğŸ“ˆ-æ€§èƒ½åˆ†æå·¥å…·"><a class="header-anchor" href="#ğŸ“ˆ-æ€§èƒ½åˆ†æå·¥å…·"></a>ğŸ“ˆ æ€§èƒ½åˆ†æå·¥å…·</h3><h4 id="pprof"><a class="header-anchor" href="#pprof"></a>pprof</h4><p>Goå†…ç½®çš„pprofå·¥å…·æ˜¯åˆ†æå†…å­˜é—®é¢˜çš„åˆ©å™¨ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;net/http&quot;</span>    _ <span class="hljs-string">&quot;net/http/pprof&quot;</span>    <span class="hljs-string">&quot;runtime/pprof&quot;</span>    <span class="hljs-string">&quot;os&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// å¼€å¯HTTPæœåŠ¡ï¼Œæä¾›pprofæ¥å£</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        http.ListenAndServe(<span class="hljs-string">&quot;:6060&quot;</span>, <span class="hljs-literal">nil</span>)    &#125;()        <span class="hljs-comment">// æˆ–è€…å°†å†…å­˜åˆ†æç»“æœå†™å…¥æ–‡ä»¶</span>    f, _ := os.Create(<span class="hljs-string">&quot;mem.pprof&quot;</span>)    <span class="hljs-keyword">defer</span> f.Close()    pprof.WriteHeapProfile(f)        <span class="hljs-comment">// åº”ç”¨ç¨‹åºä»£ç ...</span>&#125;</code></pre><p>ä½¿ç”¨æ–¹å¼ï¼š</p><pre><code class="hljs bash"><span class="hljs-comment"># æŸ¥çœ‹å†…å­˜åˆ†é…æƒ…å†µ</span>go tool pprof http://localhost:6060/debug/pprof/heap<span class="hljs-comment"># åˆ†æå†…å­˜æ–‡ä»¶</span>go tool pprof mem.pprof</code></pre><h4 id="traceå·¥å…·"><a class="header-anchor" href="#traceå·¥å…·"></a>traceå·¥å…·</h4><p>Goçš„traceå·¥å…·å¯ä»¥å¸®åŠ©åˆ†æGCè€—æ—¶å’Œå†…å­˜åˆ†é…ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;runtime/trace&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    f, _ := os.Create(<span class="hljs-string">&quot;trace.out&quot;</span>)    <span class="hljs-keyword">defer</span> f.Close()        trace.Start(f)    <span class="hljs-keyword">defer</span> trace.Stop()        <span class="hljs-comment">// åº”ç”¨ç¨‹åºä»£ç ...</span>&#125;</code></pre><p>ä½¿ç”¨æ–¹å¼ï¼š</p><pre><code class="hljs bash">go tool trace trace.out</code></pre><h3 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h3><p>Goè¯­è¨€çš„å†…å­˜ç®¡ç†ç³»ç»Ÿé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„åˆ†é…å™¨å’Œåƒåœ¾å›æ”¶å™¨ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹èƒ½å¤Ÿæä¾›å‡ºè‰²çš„æ€§èƒ½ã€‚äº†è§£å…¶å·¥ä½œåŸç†æœ‰åŠ©äºæˆ‘ä»¬ç¼–å†™æ›´é«˜æ•ˆçš„ä»£ç ï¼Œé¿å…å¸¸è§çš„å†…å­˜é—®é¢˜ã€‚</p><p>å¯¹äºé«˜æ€§èƒ½åº”ç”¨ï¼Œå¯ä»¥é‡‡ç”¨çš„ä¼˜åŒ–ç­–ç•¥åŒ…æ‹¬ï¼š</p><ul><li>å¯¹è±¡æ± åŒ–ï¼Œå‡å°‘GCå‹åŠ›</li><li>é¢„åˆ†é…å†…å­˜ï¼Œé¿å…é¢‘ç¹æ‰©å®¹</li><li>å‡å°‘ä¸´æ—¶å¯¹è±¡åˆ›å»ºï¼Œç‰¹åˆ«æ˜¯å­—ç¬¦ä¸²æ“ä½œ</li><li>ä¼˜åŒ–ç»“æ„ä½“å†…å­˜å¸ƒå±€ï¼Œæé«˜ç©ºé—´åˆ©ç”¨ç‡</li><li>å®šæœŸä½¿ç”¨pprofå’Œtraceå·¥å…·è¿›è¡Œæ€§èƒ½åˆ†æ</li></ul><p>åˆç†åˆ©ç”¨è¿™äº›çŸ¥è¯†å’Œå·¥å…·ï¼Œå°†å¸®åŠ©ä½ æ„å»ºå‡ºæ—¢é«˜æ•ˆåˆå¯é çš„Goåº”ç”¨ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>æ€§èƒ½ä¼˜åŒ–</tag>
      
      <tag>å†…å­˜ç®¡ç†</tag>
      
      <tag>GC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang æ€§èƒ½ä¼˜åŒ–å®è·µæŒ‡å—</title>
    <link href="/2024/06/25/golang-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/"/>
    <url>/2024/06/25/golang-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/</url>
    
    <content type="html"><![CDATA[<h2 id="âš¡-golang-æ€§èƒ½ä¼˜åŒ–å®è·µæŒ‡å—"><a class="header-anchor" href="#âš¡-golang-æ€§èƒ½ä¼˜åŒ–å®è·µæŒ‡å—"></a>âš¡ golang æ€§èƒ½ä¼˜åŒ–å®è·µæŒ‡å—</h2><p>Goè¯­è¨€ä»¥å…¶é«˜æ€§èƒ½å’Œé«˜æ•ˆç‡è€Œé—»åï¼Œä½†å³ä½¿æ˜¯æœ€é«˜æ•ˆçš„è¯­è¨€ä¹Ÿéœ€è¦å¼€å‘è€…éµå¾ªä¸€äº›æœ€ä½³å®è·µæ¥ç¡®ä¿åº”ç”¨ç¨‹åºè¾¾åˆ°æœ€ä½³æ€§èƒ½ã€‚æœ¬æ–‡å°†ä»‹ç»ä¸€ç³»åˆ—Goè¯­è¨€æ€§èƒ½ä¼˜åŒ–çš„å®ç”¨æŠ€å·§ï¼Œä»å†…å­˜ç®¡ç†åˆ°å¹¶å‘æ§åˆ¶ï¼Œå¸®åŠ©ä½ ç¼–å†™æ›´å¿«ã€æ›´é«˜æ•ˆçš„Goç¨‹åºã€‚</p><h3 id="ğŸ“Š-æ€§èƒ½åˆ†æå·¥å…·"><a class="header-anchor" href="#ğŸ“Š-æ€§èƒ½åˆ†æå·¥å…·"></a>ğŸ“Š æ€§èƒ½åˆ†æå·¥å…·</h3><p>åœ¨å¼€å§‹ä¼˜åŒ–ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£å¦‚ä½•æµ‹é‡å’Œåˆ†æç¨‹åºæ€§èƒ½ã€‚Goæä¾›äº†ä¸€ç³»åˆ—å¼ºå¤§çš„æ€§èƒ½åˆ†æå·¥å…·ï¼š</p><h4 id="1-pprof"><a class="header-anchor" href="#1-pprof"></a>1. pprof</h4><p><code>pprof</code>æ˜¯Goçš„æ€§èƒ½åˆ†æåˆ©å™¨ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆ†æCPUä½¿ç”¨ã€å†…å­˜åˆ†é…ã€é˜»å¡å’Œé”ç«äº‰ç­‰é—®é¢˜ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;net/http&quot;</span>    _ <span class="hljs-string">&quot;net/http/pprof&quot;</span>  <span class="hljs-comment">// å¯¼å…¥pprof</span>    <span class="hljs-string">&quot;log&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// å¯åŠ¨pprofæœåŠ¡</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        log.Println(http.ListenAndServe(<span class="hljs-string">&quot;localhost:6060&quot;</span>, <span class="hljs-literal">nil</span>))    &#125;()        <span class="hljs-comment">// åº”ç”¨ç¨‹åºä»£ç </span>    <span class="hljs-comment">// ...</span>&#125;</code></pre><p>ä½¿ç”¨æ–¹å¼ï¼š</p><pre><code class="hljs bash"><span class="hljs-comment"># CPUæ€§èƒ½åˆ†æ</span>go tool pprof http://localhost:6060/debug/pprof/profile<span class="hljs-comment"># å†…å­˜åˆ†æ</span>go tool pprof http://localhost:6060/debug/pprof/heap<span class="hljs-comment"># é˜»å¡åˆ†æ</span>go tool pprof http://localhost:6060/debug/pprof/block</code></pre><h4 id="2-trace"><a class="header-anchor" href="#2-trace"></a>2. trace</h4><p>Goçš„<code>trace</code>å·¥å…·å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¯è§†åŒ–ç¨‹åºçš„æ‰§è¡Œæƒ…å†µï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;os&quot;</span>    <span class="hljs-string">&quot;runtime/trace&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    f, err := os.Create(<span class="hljs-string">&quot;trace.out&quot;</span>)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-built_in">panic</span>(err)    &#125;    <span class="hljs-keyword">defer</span> f.Close()        err = trace.Start(f)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-built_in">panic</span>(err)    &#125;    <span class="hljs-keyword">defer</span> trace.Stop()        <span class="hljs-comment">// åº”ç”¨ç¨‹åºä»£ç </span>    <span class="hljs-comment">// ...</span>&#125;</code></pre><p>ä½¿ç”¨æ–¹å¼ï¼š</p><pre><code class="hljs bash">go tool trace trace.out</code></pre><h4 id="3-benchmark"><a class="header-anchor" href="#3-benchmark"></a>3. benchmark</h4><p>Goçš„æµ‹è¯•æ¡†æ¶å†…ç½®äº†åŸºå‡†æµ‹è¯•åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æµ‹é‡å‡½æ•°æ€§èƒ½ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// fib_test.go</span><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;testing&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkFibonacci</span><span class="hljs-params">(b *testing.B)</span></span> &#123;    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;        Fibonacci(<span class="hljs-number">20</span>)    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Fibonacci</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">if</span> n &lt;= <span class="hljs-number">1</span> &#123;        <span class="hljs-keyword">return</span> n    &#125;    <span class="hljs-keyword">return</span> Fibonacci(n<span class="hljs-number">-1</span>) + Fibonacci(n<span class="hljs-number">-2</span>)&#125;</code></pre><p>è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼š</p><pre><code class="hljs bash">go <span class="hljs-built_in">test</span> -bench=. -benchmem</code></pre><h3 id="ğŸ§ -å†…å­˜ä¼˜åŒ–"><a class="header-anchor" href="#ğŸ§ -å†…å­˜ä¼˜åŒ–"></a>ğŸ§  å†…å­˜ä¼˜åŒ–</h3><h4 id="1-å‡å°‘å†…å­˜åˆ†é…"><a class="header-anchor" href="#1-å‡å°‘å†…å­˜åˆ†é…"></a>1. å‡å°‘å†…å­˜åˆ†é…</h4><p>Goæ˜¯ä¸€ç§åƒåœ¾å›æ”¶è¯­è¨€ï¼Œå‡å°‘å†…å­˜åˆ†é…å¯ä»¥æ˜¾è‘—æé«˜æ€§èƒ½ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•ï¼šåœ¨å¾ªç¯ä¸­åˆ†é…å†…å­˜</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BadAppend</span><span class="hljs-params">(values []<span class="hljs-keyword">int</span>, size <span class="hljs-keyword">int</span>)</span> []<span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; size; i++ &#123;        values = <span class="hljs-built_in">append</span>(values, i)  <span class="hljs-comment">// å¯èƒ½å¯¼è‡´å¤šæ¬¡æ‰©å®¹å’Œå†…å­˜åˆ†é…</span>    &#125;    <span class="hljs-keyword">return</span> values&#125;<span class="hljs-comment">// å¥½çš„åšæ³•ï¼šé¢„åˆ†é…å†…å­˜</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GoodAppend</span><span class="hljs-params">(values []<span class="hljs-keyword">int</span>, size <span class="hljs-keyword">int</span>)</span> []<span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">if</span> <span class="hljs-built_in">cap</span>(values) &lt; <span class="hljs-built_in">len</span>(values)+size &#123;        <span class="hljs-comment">// é¢„åˆ†é…è¶³å¤Ÿçš„ç©ºé—´</span>        newValues := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-built_in">len</span>(values), <span class="hljs-built_in">len</span>(values)+size)        <span class="hljs-built_in">copy</span>(newValues, values)        values = newValues    &#125;    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; size; i++ &#123;        values = <span class="hljs-built_in">append</span>(values, i)    &#125;    <span class="hljs-keyword">return</span> values&#125;</code></pre><h4 id="2-å¯¹è±¡æ± "><a class="header-anchor" href="#2-å¯¹è±¡æ± "></a>2. å¯¹è±¡æ± </h4><p>å¯¹äºé¢‘ç¹åˆ›å»ºå’Œé”€æ¯çš„ä¸´æ—¶å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨<code>sync.Pool</code>æ¥å‡å°‘GCå‹åŠ›ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;bytes&quot;</span>    <span class="hljs-string">&quot;fmt&quot;</span>    <span class="hljs-string">&quot;sync&quot;</span>)<span class="hljs-keyword">var</span> bufferPool = sync.Pool&#123;    New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;        <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(bytes.Buffer)    &#125;,&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// ä»æ± ä¸­è·å–ä¸€ä¸ªbuffer</span>    buffer := bufferPool.Get().(*bytes.Buffer)    buffer.Reset()  <span class="hljs-comment">// é‡ç½®bufferçŠ¶æ€</span>        <span class="hljs-comment">// ä½¿ç”¨buffer</span>    buffer.WriteString(<span class="hljs-string">&quot;Hello, World!&quot;</span>)    fmt.Println(buffer.String())        <span class="hljs-comment">// å°†bufferæ”¾å›æ± ä¸­</span>    bufferPool.Put(buffer)&#125;</code></pre><h4 id="3-å­—ç¬¦ä¸²æ‹¼æ¥"><a class="header-anchor" href="#3-å­—ç¬¦ä¸²æ‹¼æ¥"></a>3. å­—ç¬¦ä¸²æ‹¼æ¥</h4><p>åœ¨Goä¸­ï¼Œå­—ç¬¦ä¸²æ˜¯ä¸å¯å˜çš„ï¼Œé¢‘ç¹æ‹¼æ¥ä¼šå¯¼è‡´å¤§é‡å†…å­˜åˆ†é…ã€‚ä½¿ç”¨<code>strings.Builder</code>å¯ä»¥æé«˜æ€§èƒ½ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•ï¼šä½¿ç”¨+è¿ç®—ç¬¦æ‹¼æ¥å­—ç¬¦ä¸²</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BadConcat</span><span class="hljs-params">(items []<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;    result := <span class="hljs-string">&quot;&quot;</span>    <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;        result += item  <span class="hljs-comment">// æ¯æ¬¡æ“ä½œéƒ½ä¼šåˆ†é…æ–°å†…å­˜</span>    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-comment">// å¥½çš„åšæ³•ï¼šä½¿ç”¨strings.Builder</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GoodConcat</span><span class="hljs-params">(items []<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;    <span class="hljs-keyword">var</span> builder strings.Builder    <span class="hljs-comment">// é¢„ä¼°å®¹é‡</span>    size := <span class="hljs-number">0</span>    <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;        size += <span class="hljs-built_in">len</span>(item)    &#125;    builder.Grow(size)        <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;        builder.WriteString(item)    &#125;    <span class="hljs-keyword">return</span> builder.String()&#125;</code></pre><h4 id="4-é¿å…ä¸å¿…è¦çš„å†…å­˜æ‹·è´"><a class="header-anchor" href="#4-é¿å…ä¸å¿…è¦çš„å†…å­˜æ‹·è´"></a>4. é¿å…ä¸å¿…è¦çš„å†…å­˜æ‹·è´</h4><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•ï¼šä¸å¿…è¦çš„æ‹·è´</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BadCopy</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span> []<span class="hljs-title">byte</span></span> &#123;    tmp := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">byte</span>, <span class="hljs-built_in">len</span>(data))    <span class="hljs-built_in">copy</span>(tmp, data)    <span class="hljs-keyword">return</span> tmp&#125;<span class="hljs-comment">// å¥½çš„åšæ³•ï¼šä½¿ç”¨åˆ‡ç‰‡å¼•ç”¨</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GoodCopy</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span> []<span class="hljs-title">byte</span></span> &#123;    <span class="hljs-keyword">return</span> data  <span class="hljs-comment">// ç›´æ¥è¿”å›å¼•ç”¨ï¼Œé¿å…æ‹·è´</span>&#125;</code></pre><h3 id="âš™ï¸-CPUä¼˜åŒ–"><a class="header-anchor" href="#âš™ï¸-CPUä¼˜åŒ–"></a>âš™ï¸ CPUä¼˜åŒ–</h3><h4 id="1-é¿å…ä¸å¿…è¦çš„è®¡ç®—"><a class="header-anchor" href="#1-é¿å…ä¸å¿…è¦çš„è®¡ç®—"></a>1. é¿å…ä¸å¿…è¦çš„è®¡ç®—</h4><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•ï¼šåœ¨å¾ªç¯ä¸­é‡å¤è®¡ç®—</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BadCalculate</span><span class="hljs-params">(items []<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    sum := <span class="hljs-number">0</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(items); i++ &#123;        sum += items[i] * <span class="hljs-built_in">len</span>(items)  <span class="hljs-comment">// æ¯æ¬¡å¾ªç¯éƒ½è®¡ç®—len(items)</span>    &#125;    <span class="hljs-keyword">return</span> sum&#125;<span class="hljs-comment">// å¥½çš„åšæ³•ï¼šæå‰è®¡ç®—ä¸å˜é‡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GoodCalculate</span><span class="hljs-params">(items []<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    sum := <span class="hljs-number">0</span>    length := <span class="hljs-built_in">len</span>(items)  <span class="hljs-comment">// åªè®¡ç®—ä¸€æ¬¡</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; length; i++ &#123;        sum += items[i] * length    &#125;    <span class="hljs-keyword">return</span> sum&#125;</code></pre><h4 id="2-ä½¿ç”¨é€‚å½“çš„æ•°æ®ç»“æ„"><a class="header-anchor" href="#2-ä½¿ç”¨é€‚å½“çš„æ•°æ®ç»“æ„"></a>2. ä½¿ç”¨é€‚å½“çš„æ•°æ®ç»“æ„</h4><p>é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„å¯¹æ€§èƒ½æœ‰æ˜¾è‘—å½±å“ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æŸ¥æ‰¾æ“ä½œé¢‘ç¹æ—¶ï¼Œä½¿ç”¨mapæ¯”sliceæ›´é«˜æ•ˆ</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FindInMap</span><span class="hljs-params">(m <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">int</span>, key <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">bool</span>)</span></span> &#123;    val, ok := m[key]  <span class="hljs-comment">// O(1)å¤æ‚åº¦</span>    <span class="hljs-keyword">return</span> val, ok&#125;<span class="hljs-comment">// å¯¹äºå¤§é‡éšæœºæŸ¥æ‰¾æ“ä½œï¼Œsliceæ€§èƒ½è¾ƒå·®</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FindInSlice</span><span class="hljs-params">(s []<span class="hljs-keyword">string</span>, key <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">bool</span>)</span></span> &#123;    <span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> s &#123;  <span class="hljs-comment">// O(n)å¤æ‚åº¦</span>        <span class="hljs-keyword">if</span> v == key &#123;            <span class="hljs-keyword">return</span> i, <span class="hljs-literal">true</span>        &#125;    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>, <span class="hljs-literal">false</span>&#125;</code></pre><h4 id="3-å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€"><a class="header-anchor" href="#3-å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€"></a>3. å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€</h4><p>å¯¹äºé¢‘ç¹è°ƒç”¨çš„å°å‡½æ•°ï¼Œè€ƒè™‘å†…è”æˆ–é¿å…è¿‡åº¦æŠ½è±¡ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä½¿ç”¨å†…è”å‡½æ•°</span><span class="hljs-comment">//go:inline</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">min</span><span class="hljs-params">(a, b <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">if</span> a &lt; b &#123;        <span class="hljs-keyword">return</span> a    &#125;    <span class="hljs-keyword">return</span> b&#125;</code></pre><h3 id="ğŸ”„-å¹¶å‘ä¼˜åŒ–"><a class="header-anchor" href="#ğŸ”„-å¹¶å‘ä¼˜åŒ–"></a>ğŸ”„ å¹¶å‘ä¼˜åŒ–</h3><h4 id="1-åˆç†ä½¿ç”¨goroutine"><a class="header-anchor" href="#1-åˆç†ä½¿ç”¨goroutine"></a>1. åˆç†ä½¿ç”¨goroutine</h4><p>å¹¶ä¸æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½é€‚åˆä½¿ç”¨goroutineï¼Œéœ€è¦è€ƒè™‘ä»»åŠ¡çš„è®¡ç®—å¯†é›†åº¦å’Œå¹¶è¡Œæ€§ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•ï¼šä¸ºæ¯ä¸ªå°ä»»åŠ¡åˆ›å»ºgoroutine</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BadConcurrent</span><span class="hljs-params">(items []<span class="hljs-keyword">int</span>)</span> []<span class="hljs-title">int</span></span> &#123;    results := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-built_in">len</span>(items))    <span class="hljs-keyword">var</span> wg sync.WaitGroup        <span class="hljs-keyword">for</span> i, item := <span class="hljs-keyword">range</span> items &#123;        wg.Add(<span class="hljs-number">1</span>)        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, item <span class="hljs-keyword">int</span>)</span></span> &#123;  <span class="hljs-comment">// åˆ›å»ºå¤§é‡goroutineçš„å¼€é”€å¯èƒ½è¶…è¿‡æ”¶ç›Š</span>            <span class="hljs-keyword">defer</span> wg.Done()            results[i] = item * <span class="hljs-number">2</span>        &#125;(i, item)    &#125;        wg.Wait()    <span class="hljs-keyword">return</span> results&#125;<span class="hljs-comment">// å¥½çš„åšæ³•ï¼šä½¿ç”¨å·¥ä½œæ± æ§åˆ¶goroutineæ•°é‡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GoodConcurrent</span><span class="hljs-params">(items []<span class="hljs-keyword">int</span>)</span> []<span class="hljs-title">int</span></span> &#123;    results := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-built_in">len</span>(items))    <span class="hljs-keyword">var</span> wg sync.WaitGroup        <span class="hljs-comment">// è·å–CPUæ ¸å¿ƒæ•°</span>    numWorkers := runtime.NumCPU()    <span class="hljs-comment">// åˆ›å»ºä»»åŠ¡é€šé“</span>    tasks := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, <span class="hljs-built_in">len</span>(items))        <span class="hljs-comment">// å¯åŠ¨å›ºå®šæ•°é‡çš„worker</span>    <span class="hljs-keyword">for</span> w := <span class="hljs-number">0</span>; w &lt; numWorkers; w++ &#123;        wg.Add(<span class="hljs-number">1</span>)        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;            <span class="hljs-keyword">defer</span> wg.Done()            <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> tasks &#123;                results[i] = items[i] * <span class="hljs-number">2</span>            &#125;        &#125;()    &#125;        <span class="hljs-comment">// å‘é€ä»»åŠ¡</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> items &#123;        tasks &lt;- i    &#125;    <span class="hljs-built_in">close</span>(tasks)        wg.Wait()    <span class="hljs-keyword">return</span> results&#125;</code></pre><h4 id="2-é¿å…é”ç«äº‰"><a class="header-anchor" href="#2-é¿å…é”ç«äº‰"></a>2. é¿å…é”ç«äº‰</h4><p>é”ç«äº‰æ˜¯å¹¶å‘ç¨‹åºæ€§èƒ½ä¸‹é™çš„å¸¸è§åŸå› ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•ï¼šä½¿ç”¨å•ä¸€é”ä¿æŠ¤æ•´ä¸ªæ•°æ®ç»“æ„</span><span class="hljs-keyword">type</span> BadCache <span class="hljs-keyword">struct</span> &#123;    mu    sync.Mutex    items <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *BadCache)</span> <span class="hljs-title">Get</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    c.mu.Lock()    <span class="hljs-keyword">defer</span> c.mu.Unlock()    <span class="hljs-keyword">return</span> c.items[key]&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *BadCache)</span> <span class="hljs-title">Set</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, value <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;    c.mu.Lock()    <span class="hljs-keyword">defer</span> c.mu.Unlock()    c.items[key] = value&#125;<span class="hljs-comment">// å¥½çš„åšæ³•ï¼šä½¿ç”¨åˆ†ç‰‡é”å‡å°‘ç«äº‰</span><span class="hljs-keyword">type</span> GoodCache <span class="hljs-keyword">struct</span> &#123;    shards    [<span class="hljs-number">256</span>]shard    shardMask <span class="hljs-keyword">uint8</span>&#125;<span class="hljs-keyword">type</span> shard <span class="hljs-keyword">struct</span> &#123;    mu    sync.RWMutex    items <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *GoodCache)</span> <span class="hljs-title">getShard</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">shard</span></span> &#123;    <span class="hljs-comment">// ç®€å•çš„å“ˆå¸Œå‡½æ•°</span>    h := <span class="hljs-keyword">uint8</span>(<span class="hljs-number">0</span>)    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(key); i++ &#123;        h += key[i]    &#125;    <span class="hljs-keyword">return</span> &amp;c.shards[h&amp;c.shardMask]&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *GoodCache)</span> <span class="hljs-title">Get</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    shard := c.getShard(key)    shard.mu.RLock()    <span class="hljs-keyword">defer</span> shard.mu.RUnlock()    <span class="hljs-keyword">return</span> shard.items[key]&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *GoodCache)</span> <span class="hljs-title">Set</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, value <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;    shard := c.getShard(key)    shard.mu.Lock()    <span class="hljs-keyword">defer</span> shard.mu.Unlock()    shard.items[key] = value&#125;</code></pre><h4 id="3-ä½¿ç”¨é€‚å½“çš„é€šé“ç¼“å†²åŒºå¤§å°"><a class="header-anchor" href="#3-ä½¿ç”¨é€‚å½“çš„é€šé“ç¼“å†²åŒºå¤§å°"></a>3. ä½¿ç”¨é€‚å½“çš„é€šé“ç¼“å†²åŒºå¤§å°</h4><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•ï¼šæ— ç¼“å†²é€šé“å¯èƒ½å¯¼è‡´å‘é€è€…é˜»å¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BadChannelUsage</span><span class="hljs-params">(items []<span class="hljs-keyword">int</span>)</span> []<span class="hljs-title">int</span></span> &#123;    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)  <span class="hljs-comment">// æ— ç¼“å†²é€šé“</span>    results := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(items))        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;            ch &lt;- item * <span class="hljs-number">2</span>  <span class="hljs-comment">// å¦‚æœæ¥æ”¶è€…ä¸åŠæ—¶æ¥æ”¶ï¼Œå‘é€è€…ä¼šé˜»å¡</span>        &#125;        <span class="hljs-built_in">close</span>(ch)    &#125;()        <span class="hljs-keyword">for</span> item := <span class="hljs-keyword">range</span> ch &#123;        results = <span class="hljs-built_in">append</span>(results, item)    &#125;    <span class="hljs-keyword">return</span> results&#125;<span class="hljs-comment">// å¥½çš„åšæ³•ï¼šä½¿ç”¨åˆé€‚å¤§å°çš„ç¼“å†²åŒº</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GoodChannelUsage</span><span class="hljs-params">(items []<span class="hljs-keyword">int</span>)</span> []<span class="hljs-title">int</span></span> &#123;    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, <span class="hljs-built_in">len</span>(items))  <span class="hljs-comment">// ç¼“å†²åŒºå¤§å°ä¸ä»»åŠ¡æ•°åŒ¹é…</span>    results := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(items))        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;            ch &lt;- item * <span class="hljs-number">2</span>  <span class="hljs-comment">// ä¸ä¼šé˜»å¡ï¼Œç›´åˆ°ç¼“å†²åŒºæ»¡</span>        &#125;        <span class="hljs-built_in">close</span>(ch)    &#125;()        <span class="hljs-keyword">for</span> item := <span class="hljs-keyword">range</span> ch &#123;        results = <span class="hljs-built_in">append</span>(results, item)    &#125;    <span class="hljs-keyword">return</span> results&#125;</code></pre><h3 id="ğŸ”§-ç¼–è¯‘ä¼˜åŒ–"><a class="header-anchor" href="#ğŸ”§-ç¼–è¯‘ä¼˜åŒ–"></a>ğŸ”§ ç¼–è¯‘ä¼˜åŒ–</h3><h4 id="1-ä½¿ç”¨ç¼–è¯‘æ ‡å¿—"><a class="header-anchor" href="#1-ä½¿ç”¨ç¼–è¯‘æ ‡å¿—"></a>1. ä½¿ç”¨ç¼–è¯‘æ ‡å¿—</h4><p>Goç¼–è¯‘å™¨æä¾›äº†å¤šç§ä¼˜åŒ–æ ‡å¿—ï¼š</p><pre><code class="hljs bash"><span class="hljs-comment"># å¯ç”¨å†…è”ä¼˜åŒ–</span>go build -gcflags=<span class="hljs-string">&quot;-l=4&quot;</span><span class="hljs-comment"># ç¦ç”¨è¾¹ç•Œæ£€æŸ¥ï¼ˆå±é™©ï¼Œä½†å¯èƒ½æé«˜æ€§èƒ½ï¼‰</span>go build -gcflags=<span class="hljs-string">&quot;-B&quot;</span><span class="hljs-comment"># å¯ç”¨æ‰€æœ‰ä¼˜åŒ–</span>go build -ldflags=<span class="hljs-string">&quot;-s -w&quot;</span></code></pre><h4 id="2-ä½¿ç”¨æ±‡ç¼–ä¼˜åŒ–å…³é”®è·¯å¾„"><a class="header-anchor" href="#2-ä½¿ç”¨æ±‡ç¼–ä¼˜åŒ–å…³é”®è·¯å¾„"></a>2. ä½¿ç”¨æ±‡ç¼–ä¼˜åŒ–å…³é”®è·¯å¾„</h4><p>å¯¹äºæ€§èƒ½å…³é”®çš„éƒ¨åˆ†ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ±‡ç¼–è¯­è¨€ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// add.go</span><span class="hljs-keyword">package</span> main<span class="hljs-comment">// å£°æ˜æ±‡ç¼–å‡½æ•°</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">asmAdd</span><span class="hljs-params">(a, b <span class="hljs-keyword">int64</span>)</span> <span class="hljs-title">int64</span></span><span class="hljs-comment">// add_amd64.s</span>#include <span class="hljs-string">&quot;textflag.h&quot;</span><span class="hljs-comment">// func asmAdd(a, b int64) int64</span>TEXT Â·asmAdd(SB), NOSPLIT, $<span class="hljs-number">0</span><span class="hljs-number">-24</span>    MOVQ a+<span class="hljs-number">0</span>(FP), AX  <span class="hljs-comment">// åŠ è½½ç¬¬ä¸€ä¸ªå‚æ•°åˆ°AX</span>    MOVQ b+<span class="hljs-number">8</span>(FP), BX  <span class="hljs-comment">// åŠ è½½ç¬¬äºŒä¸ªå‚æ•°åˆ°BX</span>    ADDQ BX, AX       <span class="hljs-comment">// AX += BX</span>    MOVQ AX, ret+<span class="hljs-number">16</span>(FP)  <span class="hljs-comment">// å°†ç»“æœå­˜å‚¨åˆ°è¿”å›å€¼</span>    RET</code></pre><h3 id="ğŸ“-å®é™…æ¡ˆä¾‹åˆ†æ"><a class="header-anchor" href="#ğŸ“-å®é™…æ¡ˆä¾‹åˆ†æ"></a>ğŸ“ å®é™…æ¡ˆä¾‹åˆ†æ</h3><h4 id="æ¡ˆä¾‹1ï¼šä¼˜åŒ–JSONå¤„ç†"><a class="header-anchor" href="#æ¡ˆä¾‹1ï¼šä¼˜åŒ–JSONå¤„ç†"></a>æ¡ˆä¾‹1ï¼šä¼˜åŒ–JSONå¤„ç†</h4><p>JSONå¤„ç†æ˜¯è®¸å¤šWebåº”ç”¨çš„æ€§èƒ½ç“¶é¢ˆï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// åŸå§‹ç‰ˆæœ¬ï¼šä½¿ç”¨æ ‡å‡†encoding/json</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SlowJSONProcess</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span></span> &#123;    <span class="hljs-keyword">var</span> result <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;    err := json.Unmarshal(data, &amp;result)    <span class="hljs-keyword">return</span> result, err&#125;<span class="hljs-comment">// ä¼˜åŒ–ç‰ˆæœ¬1ï¼šä½¿ç”¨é¢„åˆ†é…å†…å­˜</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FasterJSONProcess</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span></span> &#123;    <span class="hljs-comment">// é¢„ä¼°JSONå¯¹è±¡å¤§å°</span>    estimatedSize := <span class="hljs-built_in">len</span>(data) / <span class="hljs-number">2</span>    result := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;, estimatedSize)    err := json.Unmarshal(data, &amp;result)    <span class="hljs-keyword">return</span> result, err&#125;<span class="hljs-comment">// ä¼˜åŒ–ç‰ˆæœ¬2ï¼šä½¿ç”¨æ›´é«˜æ•ˆçš„JSONåº“</span><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/json-iterator/go&quot;</span><span class="hljs-keyword">var</span> jsoniter = jsoniter.ConfigCompatibleWithStandardLibrary<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FastestJSONProcess</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span></span> &#123;    result := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)    err := jsoniter.Unmarshal(data, &amp;result)    <span class="hljs-keyword">return</span> result, err&#125;</code></pre><p>æ€§èƒ½æ¯”è¾ƒï¼š</p><pre><code class="hljs angelscript">BenchmarkSlowJSONProcess<span class="hljs-number">-8</span>     <span class="hljs-number">100000</span>   <span class="hljs-number">15000</span> ns/op   <span class="hljs-number">5024</span> B/op   <span class="hljs-number">78</span> allocs/opBenchmarkFasterJSONProcess<span class="hljs-number">-8</span>   <span class="hljs-number">100000</span>   <span class="hljs-number">14500</span> ns/op   <span class="hljs-number">4800</span> B/op   <span class="hljs-number">76</span> allocs/opBenchmarkFastestJSONProcess<span class="hljs-number">-8</span>  <span class="hljs-number">200000</span>    <span class="hljs-number">7500</span> ns/op   <span class="hljs-number">2416</span> B/op   <span class="hljs-number">32</span> allocs/op</code></pre><h4 id="æ¡ˆä¾‹2ï¼šä¼˜åŒ–HTTPæœåŠ¡å™¨"><a class="header-anchor" href="#æ¡ˆä¾‹2ï¼šä¼˜åŒ–HTTPæœåŠ¡å™¨"></a>æ¡ˆä¾‹2ï¼šä¼˜åŒ–HTTPæœåŠ¡å™¨</h4><pre><code class="hljs go"><span class="hljs-comment">// åŸå§‹ç‰ˆæœ¬ï¼šæ ‡å‡†HTTPæœåŠ¡å™¨</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StandardHTTPServer</span><span class="hljs-params">()</span></span> &#123;    http.HandleFunc(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;        fmt.Fprintf(w, <span class="hljs-string">&quot;Hello, World!&quot;</span>)    &#125;)    http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, <span class="hljs-literal">nil</span>)&#125;<span class="hljs-comment">// ä¼˜åŒ–ç‰ˆæœ¬ï¼šä½¿ç”¨fasthttp</span><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/valyala/fasthttp&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FastHTTPServer</span><span class="hljs-params">()</span></span> &#123;    fasthttp.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx *fasthttp.RequestCtx)</span></span> &#123;        ctx.WriteString(<span class="hljs-string">&quot;Hello, World!&quot;</span>)    &#125;)&#125;</code></pre><p>æ€§èƒ½æ¯”è¾ƒï¼š</p><pre><code class="hljs angelscript">æ ‡å‡†HTTPæœåŠ¡å™¨: ~<span class="hljs-number">20</span>,<span class="hljs-number">000</span> è¯·æ±‚/ç§’FastHTTPæœåŠ¡å™¨: ~<span class="hljs-number">80</span>,<span class="hljs-number">000</span> è¯·æ±‚/ç§’</code></pre><h4 id="æ¡ˆä¾‹3ï¼šä¼˜åŒ–æ•°æ®åº“æ“ä½œ"><a class="header-anchor" href="#æ¡ˆä¾‹3ï¼šä¼˜åŒ–æ•°æ®åº“æ“ä½œ"></a>æ¡ˆä¾‹3ï¼šä¼˜åŒ–æ•°æ®åº“æ“ä½œ</h4><pre><code class="hljs go"><span class="hljs-comment">// åŸå§‹ç‰ˆæœ¬ï¼šæ¯æ¬¡æŸ¥è¯¢å•ç‹¬è¿æ¥</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SlowDBQuery</span><span class="hljs-params">(ids []<span class="hljs-keyword">int</span>)</span> <span class="hljs-params">([]User, error)</span></span> &#123;    <span class="hljs-keyword">var</span> users []User    <span class="hljs-keyword">for</span> _, id := <span class="hljs-keyword">range</span> ids &#123;        db, err := sql.Open(<span class="hljs-string">&quot;mysql&quot;</span>, <span class="hljs-string">&quot;user:password@/dbname&quot;</span>)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err        &#125;        <span class="hljs-keyword">defer</span> db.Close()                <span class="hljs-keyword">var</span> user User        err = db.QueryRow(<span class="hljs-string">&quot;SELECT * FROM users WHERE id = ?&quot;</span>, id).Scan(&amp;user.ID, &amp;user.Name)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err        &#125;        users = <span class="hljs-built_in">append</span>(users, user)    &#125;    <span class="hljs-keyword">return</span> users, <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// ä¼˜åŒ–ç‰ˆæœ¬1ï¼šè¿æ¥æ± </span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FasterDBQuery</span><span class="hljs-params">(ids []<span class="hljs-keyword">int</span>)</span> <span class="hljs-params">([]User, error)</span></span> &#123;    db, err := sql.Open(<span class="hljs-string">&quot;mysql&quot;</span>, <span class="hljs-string">&quot;user:password@/dbname&quot;</span>)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;    <span class="hljs-keyword">defer</span> db.Close()        <span class="hljs-comment">// è®¾ç½®è¿æ¥æ± å‚æ•°</span>    db.SetMaxOpenConns(<span class="hljs-number">10</span>)    db.SetMaxIdleConns(<span class="hljs-number">5</span>)    db.SetConnMaxLifetime(time.Minute * <span class="hljs-number">3</span>)        <span class="hljs-keyword">var</span> users []User    <span class="hljs-keyword">for</span> _, id := <span class="hljs-keyword">range</span> ids &#123;        <span class="hljs-keyword">var</span> user User        err = db.QueryRow(<span class="hljs-string">&quot;SELECT * FROM users WHERE id = ?&quot;</span>, id).Scan(&amp;user.ID, &amp;user.Name)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err        &#125;        users = <span class="hljs-built_in">append</span>(users, user)    &#125;    <span class="hljs-keyword">return</span> users, <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// ä¼˜åŒ–ç‰ˆæœ¬2ï¼šæ‰¹é‡æŸ¥è¯¢</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FastestDBQuery</span><span class="hljs-params">(ids []<span class="hljs-keyword">int</span>)</span> <span class="hljs-params">([]User, error)</span></span> &#123;    db, err := sql.Open(<span class="hljs-string">&quot;mysql&quot;</span>, <span class="hljs-string">&quot;user:password@/dbname&quot;</span>)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;    <span class="hljs-keyword">defer</span> db.Close()        <span class="hljs-comment">// æ„å»ºINæŸ¥è¯¢</span>    query := <span class="hljs-string">&quot;SELECT * FROM users WHERE id IN (&quot;</span>    args := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-built_in">len</span>(ids))    placeholders := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">string</span>, <span class="hljs-built_in">len</span>(ids))        <span class="hljs-keyword">for</span> i, id := <span class="hljs-keyword">range</span> ids &#123;        placeholders[i] = <span class="hljs-string">&quot;?&quot;</span>        args[i] = id    &#125;        query += strings.Join(placeholders, <span class="hljs-string">&quot;,&quot;</span>) + <span class="hljs-string">&quot;)&quot;</span>        <span class="hljs-comment">// æ‰§è¡Œæ‰¹é‡æŸ¥è¯¢</span>    rows, err := db.Query(query, args...)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;    <span class="hljs-keyword">defer</span> rows.Close()        <span class="hljs-keyword">var</span> users []User    <span class="hljs-keyword">for</span> rows.Next() &#123;        <span class="hljs-keyword">var</span> user User        <span class="hljs-keyword">if</span> err := rows.Scan(&amp;user.ID, &amp;user.Name); err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err        &#125;        users = <span class="hljs-built_in">append</span>(users, user)    &#125;        <span class="hljs-keyword">return</span> users, <span class="hljs-literal">nil</span>&#125;</code></pre><h3 id="ğŸ¯-æ€§èƒ½ä¼˜åŒ–çš„æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸ¯-æ€§èƒ½ä¼˜åŒ–çš„æœ€ä½³å®è·µ"></a>ğŸ¯ æ€§èƒ½ä¼˜åŒ–çš„æœ€ä½³å®è·µ</h3><ol><li><strong>å…ˆåˆ†æåä¼˜åŒ–</strong>ï¼šä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·æ‰¾å‡ºçœŸæ­£çš„ç“¶é¢ˆï¼Œé¿å…è¿‡æ—©ä¼˜åŒ–</li><li><strong>è®¾å®šæ˜ç¡®çš„æ€§èƒ½ç›®æ ‡</strong>ï¼šçŸ¥é“ä½ æƒ³è¦è¾¾åˆ°ä»€ä¹ˆæ ·çš„æ€§èƒ½æŒ‡æ ‡</li><li><strong>æµ‹é‡åŸºå‡†</strong>ï¼šåœ¨ä¼˜åŒ–å‰åè¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œç¡®ä¿ä¼˜åŒ–æœ‰æ•ˆ</li><li><strong>æƒè¡¡å–èˆ</strong>ï¼šæ€§èƒ½ä¼˜åŒ–é€šå¸¸ä¼´éšç€ä»£ç å¤æ‚æ€§å¢åŠ ï¼Œéœ€è¦æƒè¡¡</li><li><strong>å…³æ³¨çƒ­ç‚¹</strong>ï¼š80%çš„æ€§èƒ½é—®é¢˜é€šå¸¸å‡ºç°åœ¨20%çš„ä»£ç ä¸­</li><li><strong>é¿å…è¿‡åº¦ä¼˜åŒ–</strong>ï¼šå½“è¾¾åˆ°æ€§èƒ½ç›®æ ‡åï¼Œåœæ­¢ä¼˜åŒ–</li></ol><h3 id="ğŸ“ˆ-æ€»ç»“"><a class="header-anchor" href="#ğŸ“ˆ-æ€»ç»“"></a>ğŸ“ˆ æ€»ç»“</h3><p>Goè¯­è¨€æœ¬èº«å·²ç»éå¸¸é«˜æ•ˆï¼Œä½†é€šè¿‡éµå¾ªæœ¬æ–‡ä»‹ç»çš„æœ€ä½³å®è·µï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æå‡åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚è®°ä½ï¼Œæ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦ä¸æ–­åœ°æµ‹é‡ã€åˆ†æå’Œæ”¹è¿›ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œåº”è¯¥æ ¹æ®å…·ä½“éœ€æ±‚å’Œåœºæ™¯é€‰æ‹©é€‚å½“çš„ä¼˜åŒ–ç­–ç•¥ã€‚</p><p>æœ€åï¼Œå¼•ç”¨Donald Knuthçš„åè¨€ï¼šâ€œè¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºâ€ã€‚åœ¨è¿›è¡Œä»»ä½•ä¼˜åŒ–ä¹‹å‰ï¼Œç¡®ä¿ä½ å·²ç»æ‰¾åˆ°äº†çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆï¼Œå¹¶ä¸”ä¼˜åŒ–çš„æ”¶ç›Šå¤§äºæˆæœ¬ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>å¹¶å‘</tag>
      
      <tag>æ€§èƒ½ä¼˜åŒ–</tag>
      
      <tag>å†…å­˜ç®¡ç†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ</title>
    <link href="/2024/06/10/golang-%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"/>
    <url>/2024/06/10/golang-%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ”„-golang-ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸ”„-golang-ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ"></a>ğŸ”„ golang ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ</h2><p>ä¾èµ–æ³¨å…¥æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå®ƒå…è®¸æˆ‘ä»¬å°†ç»„ä»¶çš„ä¾èµ–å…³ç³»ä»ç»„ä»¶å†…éƒ¨è½¬ç§»åˆ°å¤–éƒ¨ã€‚åœ¨Goè¯­è¨€ä¸­ï¼Œä¾èµ–æ³¨å…¥å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç¼–å†™æ›´åŠ æ¨¡å—åŒ–ã€å¯æµ‹è¯•å’Œå¯ç»´æŠ¤çš„ä»£ç ã€‚æœ¬æ–‡å°†æ¢è®¨Goä¸­ä¾èµ–æ³¨å…¥çš„å„ç§å®ç°æ–¹å¼ã€æœ€ä½³å®è·µä»¥åŠå¸¸è§é™·é˜±ã€‚</p><h3 id="ğŸ“š-ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿ"><a class="header-anchor" href="#ğŸ“š-ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿ"></a>ğŸ“š ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿ</h3><p>ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼Œç®€ç§°DIï¼‰æ˜¯ä¸€ç§æ§åˆ¶åè½¬ï¼ˆInversion of Controlï¼ŒIoCï¼‰æŠ€æœ¯ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š</p><ol><li><strong>ç»„ä»¶ä¸åº”è¯¥è´Ÿè´£åˆ›å»ºæˆ–æŸ¥æ‰¾å…¶ä¾èµ–é¡¹</strong></li><li><strong>ç»„ä»¶åº”è¯¥é€šè¿‡å¤–éƒ¨æ–¹å¼æ¥æ”¶å…¶ä¾èµ–é¡¹</strong></li></ol><p>è¿™ç§æ–¹å¼æœ‰å‡ ä¸ªé‡è¦ä¼˜åŠ¿ï¼š</p><ul><li><strong>è§£è€¦</strong>ï¼šç»„ä»¶ä¸å…¶ä¾èµ–çš„å…·ä½“å®ç°è§£è€¦</li><li><strong>å¯æµ‹è¯•æ€§</strong>ï¼šå¯ä»¥è½»æ¾æ›¿æ¢ä¾èµ–é¡¹ï¼Œä¾¿äºå•å…ƒæµ‹è¯•</li><li><strong>å¯ç»´æŠ¤æ€§</strong>ï¼šä¾èµ–å…³ç³»æ˜ç¡®ï¼Œä»£ç æ›´æ˜“äºç†è§£å’Œç»´æŠ¤</li><li><strong>çµæ´»æ€§</strong>ï¼šå¯ä»¥åœ¨è¿è¡Œæ—¶æ›´æ”¹ä¾èµ–é¡¹çš„å®ç°</li></ul><h3 id="ğŸ› ï¸-Goä¸­çš„ä¾èµ–æ³¨å…¥æ–¹å¼"><a class="header-anchor" href="#ğŸ› ï¸-Goä¸­çš„ä¾èµ–æ³¨å…¥æ–¹å¼"></a>ğŸ› ï¸ Goä¸­çš„ä¾èµ–æ³¨å…¥æ–¹å¼</h3><p>åœ¨Goä¸­ï¼Œæœ‰å¤šç§æ–¹å¼å¯ä»¥å®ç°ä¾èµ–æ³¨å…¥ï¼Œä»ç®€å•çš„æ‰‹åŠ¨æ³¨å…¥åˆ°ä½¿ç”¨ä¸“é—¨çš„ä¾èµ–æ³¨å…¥æ¡†æ¶ã€‚</p><h4 id="1-æ„é€ å‡½æ•°æ³¨å…¥"><a class="header-anchor" href="#1-æ„é€ å‡½æ•°æ³¨å…¥"></a>1. æ„é€ å‡½æ•°æ³¨å…¥</h4><p>æœ€ç®€å•çš„ä¾èµ–æ³¨å…¥æ–¹å¼æ˜¯é€šè¿‡æ„é€ å‡½æ•°ä¼ é€’ä¾èµ–é¡¹ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// UserRepository æ¥å£å®šä¹‰</span><span class="hljs-keyword">type</span> UserRepository <span class="hljs-keyword">interface</span> &#123;    GetByID(id <span class="hljs-keyword">string</span>) (*User, error)    Save(user *User) error&#125;<span class="hljs-comment">// UserService ä¾èµ–äºUserRepository</span><span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span> &#123;    repo UserRepository&#125;<span class="hljs-comment">// NewUserService æ„é€ å‡½æ•°æ¥æ”¶ä¾èµ–é¡¹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserService</span><span class="hljs-params">(repo UserRepository)</span> *<span class="hljs-title">UserService</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;UserService&#123;        repo: repo,    &#125;&#125;<span class="hljs-comment">// GetUser ä½¿ç”¨æ³¨å…¥çš„ä¾èµ–</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span> <span class="hljs-title">GetUser</span><span class="hljs-params">(id <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*User, error)</span></span> &#123;    <span class="hljs-keyword">return</span> s.repo.GetByID(id)&#125;</code></pre><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// åˆ›å»ºå…·ä½“çš„repositoryå®ç°</span>repo := postgres.NewUserRepository(db)<span class="hljs-comment">// å°†repositoryæ³¨å…¥åˆ°serviceä¸­</span>service := NewUserService(repo)<span class="hljs-comment">// ä½¿ç”¨service</span>user, err := service.GetUser(<span class="hljs-string">&quot;123&quot;</span>)</code></pre><p>è¿™ç§æ–¹å¼ç®€å•ç›´æ¥ï¼Œé€‚ç”¨äºä¾èµ–å…³ç³»è¾ƒå°‘çš„åœºæ™¯ã€‚</p><h4 id="2-å­—æ®µæ³¨å…¥"><a class="header-anchor" href="#2-å­—æ®µæ³¨å…¥"></a>2. å­—æ®µæ³¨å…¥</h4><p>å­—æ®µæ³¨å…¥æ˜¯é€šè¿‡ç›´æ¥è®¾ç½®ç»“æ„ä½“å­—æ®µæ¥æ³¨å…¥ä¾èµ–ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span> &#123;    Repo UserRepository    Logger Logger    Config Config&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>service := &amp;UserService&#123;&#125;service.Repo = postgres.NewUserRepository(db)service.Logger = zap.NewLogger()service.Config = config</code></pre><p>è¿™ç§æ–¹å¼çµæ´»ä½†ä¸å¤Ÿæ˜ç¡®ï¼Œå¯èƒ½å¯¼è‡´ä¾èµ–é¡¹æœªå®Œå…¨åˆå§‹åŒ–çš„é—®é¢˜ã€‚</p><h4 id="3-æ–¹æ³•æ³¨å…¥"><a class="header-anchor" href="#3-æ–¹æ³•æ³¨å…¥"></a>3. æ–¹æ³•æ³¨å…¥</h4><p>æ–¹æ³•æ³¨å…¥æ˜¯é€šè¿‡æ–¹æ³•å‚æ•°ä¼ é€’ä¾èµ–é¡¹ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span> <span class="hljs-title">ProcessUser</span><span class="hljs-params">(id <span class="hljs-keyword">string</span>, validator UserValidator)</span> <span class="hljs-params">(*ProcessedUser, error)</span></span> &#123;    user, err := s.repo.GetByID(id)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;        <span class="hljs-keyword">if</span> err := validator.Validate(user); err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;        <span class="hljs-comment">// å¤„ç†ç”¨æˆ·</span>    <span class="hljs-keyword">return</span> &amp;ProcessedUser&#123;...&#125;, <span class="hljs-literal">nil</span>&#125;</code></pre><p>æ–¹æ³•æ³¨å…¥é€‚ç”¨äºä¸´æ—¶ä¾èµ–æˆ–å¯é€‰ä¾èµ–ã€‚</p><h4 id="4-æ¥å£æ³¨å…¥"><a class="header-anchor" href="#4-æ¥å£æ³¨å…¥"></a>4. æ¥å£æ³¨å…¥</h4><p>æ¥å£æ³¨å…¥è¦æ±‚ç»„ä»¶å®ç°ç‰¹å®šæ¥å£æ¥æ¥æ”¶ä¾èµ–ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> RepositoryAware <span class="hljs-keyword">interface</span> &#123;    SetRepository(repo Repository)&#125;<span class="hljs-keyword">type</span> Service <span class="hljs-keyword">struct</span> &#123;    repo Repository&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">SetRepository</span><span class="hljs-params">(repo Repository)</span></span> &#123;    s.repo = repo&#125;</code></pre><p>è¿™ç§æ–¹å¼åœ¨Goä¸­è¾ƒå°‘ä½¿ç”¨ï¼Œæ›´å¸¸è§äºJavaç­‰è¯­è¨€ã€‚</p><h3 id="ğŸ—ï¸-ä¾èµ–æ³¨å…¥å®¹å™¨"><a class="header-anchor" href="#ğŸ—ï¸-ä¾èµ–æ³¨å…¥å®¹å™¨"></a>ğŸ—ï¸ ä¾èµ–æ³¨å…¥å®¹å™¨</h3><p>å½“åº”ç”¨è§„æ¨¡å¢é•¿ï¼Œä¾èµ–å…³ç³»å˜å¾—å¤æ‚æ—¶ï¼Œæ‰‹åŠ¨ç®¡ç†ä¾èµ–æ³¨å…¥ä¼šå˜å¾—ç¹çã€‚è¿™æ—¶ï¼Œä¾èµ–æ³¨å…¥å®¹å™¨ï¼ˆDIå®¹å™¨ï¼‰å¯ä»¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨ç®¡ç†ä¾èµ–å…³ç³»ã€‚</p><h4 id="1-ç®€å•çš„DIå®¹å™¨å®ç°"><a class="header-anchor" href="#1-ç®€å•çš„DIå®¹å™¨å®ç°"></a>1. ç®€å•çš„DIå®¹å™¨å®ç°</h4><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„DIå®¹å™¨å®ç°ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Container <span class="hljs-keyword">struct</span> &#123;    providers <span class="hljs-keyword">map</span>[reflect.Type]<span class="hljs-keyword">interface</span>&#123;&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewContainer</span><span class="hljs-params">()</span> *<span class="hljs-title">Container</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;Container&#123;        providers: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[reflect.Type]<span class="hljs-keyword">interface</span>&#123;&#125;),    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Container)</span> <span class="hljs-title">Register</span><span class="hljs-params">(i <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;    t := reflect.TypeOf(i)    c.providers[t] = i&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Container)</span> <span class="hljs-title">RegisterAs</span><span class="hljs-params">(i <span class="hljs-keyword">interface</span>&#123;&#125;, t reflect.Type)</span></span> &#123;    c.providers[t] = i&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Container)</span> <span class="hljs-title">Get</span><span class="hljs-params">(t reflect.Type)</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-keyword">bool</span>)</span></span> &#123;    provider, ok := c.providers[t]    <span class="hljs-keyword">return</span> provider, ok&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>container := NewContainer()repo := &amp;PostgresUserRepository&#123;&#125;container.RegisterAs(repo, reflect.TypeOf((*UserRepository)(<span class="hljs-literal">nil</span>)).Elem())<span class="hljs-comment">// è·å–ä¾èµ–</span><span class="hljs-keyword">if</span> repo, ok := container.Get(reflect.TypeOf((*UserRepository)(<span class="hljs-literal">nil</span>)).Elem()); ok &#123;    userRepo := repo.(UserRepository)    <span class="hljs-comment">// ä½¿ç”¨userRepo</span>&#125;</code></pre><h4 id="2-ä½¿ç”¨wireæ¡†æ¶"><a class="header-anchor" href="#2-ä½¿ç”¨wireæ¡†æ¶"></a>2. ä½¿ç”¨wireæ¡†æ¶</h4><p>Googleçš„<a href="https://github.com/google/wire">Wire</a>æ˜¯ä¸€ä¸ªç¼–è¯‘æ—¶ä¾èµ–æ³¨å…¥å·¥å…·ï¼Œå®ƒé€šè¿‡ä»£ç ç”Ÿæˆæ¥å®ç°ä¾èµ–æ³¨å…¥ï¼Œé¿å…äº†è¿è¡Œæ—¶åå°„çš„å¼€é”€ã€‚</p><p>Wireä½¿ç”¨ç¤ºä¾‹ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// wire.go</span><span class="hljs-comment">//+build wireinject</span><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;github.com/google/wire&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitializeUserService</span><span class="hljs-params">(db *sql.DB)</span> <span class="hljs-params">(*UserService, error)</span></span> &#123;    wire.Build(        NewUserRepository,        NewUserService,    )    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>&#125;</code></pre><p>è¿è¡Œ<code>wire</code>å‘½ä»¤åï¼Œå®ƒä¼šç”Ÿæˆå®é™…çš„åˆå§‹åŒ–ä»£ç ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// wire_gen.go</span><span class="hljs-comment">// Code generated by Wire. DO NOT EDIT.</span><span class="hljs-keyword">package</span> main<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitializeUserService</span><span class="hljs-params">(db *sql.DB)</span> <span class="hljs-params">(*UserService, error)</span></span> &#123;    userRepository := NewUserRepository(db)    userService := NewUserService(userRepository)    <span class="hljs-keyword">return</span> userService, <span class="hljs-literal">nil</span>&#125;</code></pre><p>Wireçš„ä¼˜åŠ¿åœ¨äºå®ƒæ˜¯ç¼–è¯‘æ—¶å·¥å…·ï¼Œæ²¡æœ‰è¿è¡Œæ—¶å¼€é”€ï¼ŒåŒæ—¶ä¿æŒäº†ä»£ç çš„æ˜ç¡®æ€§ã€‚</p><h4 id="3-ä½¿ç”¨digæ¡†æ¶"><a class="header-anchor" href="#3-ä½¿ç”¨digæ¡†æ¶"></a>3. ä½¿ç”¨digæ¡†æ¶</h4><p><a href="https://github.com/uber-go/dig">dig</a>æ˜¯Uberå¼€å‘çš„ä¾èµ–æ³¨å…¥å®¹å™¨ï¼Œå®ƒä½¿ç”¨åå°„åœ¨è¿è¡Œæ—¶è§£æä¾èµ–å…³ç³»ã€‚</p><p>digä½¿ç”¨ç¤ºä¾‹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;github.com/uber-go/dig&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    container := dig.New()        <span class="hljs-comment">// æ³¨å†Œä¾èµ–</span>    container.Provide(NewConfig)    container.Provide(NewDatabase)    container.Provide(NewUserRepository)    container.Provide(NewUserService)    container.Provide(NewHTTPServer)        <span class="hljs-comment">// å¯åŠ¨åº”ç”¨</span>    err := container.Invoke(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(server *HTTPServer)</span></span> &#123;        server.Start()    &#125;)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-built_in">panic</span>(err)    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConfig</span><span class="hljs-params">()</span> <span class="hljs-params">(*Config, error)</span></span> &#123;    <span class="hljs-comment">// åŠ è½½é…ç½®</span>    <span class="hljs-keyword">return</span> &amp;Config&#123;&#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDatabase</span><span class="hljs-params">(config *Config)</span> <span class="hljs-params">(*Database, error)</span></span> &#123;    <span class="hljs-comment">// ä½¿ç”¨é…ç½®åˆ›å»ºæ•°æ®åº“è¿æ¥</span>    <span class="hljs-keyword">return</span> &amp;Database&#123;&#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserRepository</span><span class="hljs-params">(db *Database)</span> *<span class="hljs-title">UserRepository</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;UserRepository&#123;db: db&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserService</span><span class="hljs-params">(repo *UserRepository)</span> *<span class="hljs-title">UserService</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;UserService&#123;repo: repo&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewHTTPServer</span><span class="hljs-params">(service *UserService)</span> *<span class="hljs-title">HTTPServer</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;HTTPServer&#123;service: service&#125;&#125;</code></pre><p>digçš„ä¼˜åŠ¿æ˜¯ä½¿ç”¨ç®€å•ï¼Œè‡ªåŠ¨è§£æä¾èµ–å…³ç³»ï¼Œä½†æœ‰ä¸€å®šçš„è¿è¡Œæ—¶å¼€é”€ã€‚</p><h3 id="ğŸŒŸ-ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸŒŸ-ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ"></a>ğŸŒŸ ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ</h3><h4 id="1-é¢å‘æ¥å£ç¼–ç¨‹"><a class="header-anchor" href="#1-é¢å‘æ¥å£ç¼–ç¨‹"></a>1. é¢å‘æ¥å£ç¼–ç¨‹</h4><p>ä¾èµ–åº”è¯¥åŸºäºæ¥å£è€Œéå…·ä½“å®ç°ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// å¥½çš„åšæ³•</span><span class="hljs-keyword">type</span> Service <span class="hljs-keyword">struct</span> &#123;    repo Repository&#125;<span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span><span class="hljs-keyword">type</span> Service <span class="hljs-keyword">struct</span> &#123;    repo *PostgresRepository&#125;</code></pre><p>é¢å‘æ¥å£ç¼–ç¨‹ä½¿å¾—ç»„ä»¶æ›´åŠ çµæ´»ï¼Œä¾¿äºæ›¿æ¢å®ç°å’Œæµ‹è¯•ã€‚</p><h4 id="2-ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥"><a class="header-anchor" href="#2-ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥"></a>2. ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥</h4><p>æ„é€ å‡½æ•°æ³¨å…¥æ˜¯æœ€æ˜ç¡®ã€æœ€ç®€å•çš„ä¾èµ–æ³¨å…¥æ–¹å¼ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewService</span><span class="hljs-params">(repo Repository, logger Logger, cache Cache)</span> *<span class="hljs-title">Service</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;Service&#123;        repo:   repo,        logger: logger,        cache:  cache,    &#125;&#125;</code></pre><p>è¿™ç§æ–¹å¼ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„ä¾èµ–éƒ½è¢«æä¾›ï¼Œå¹¶ä¸”ä¾èµ–å…³ç³»æ¸…æ™°å¯è§ã€‚</p><h4 id="3-é¿å…å…¨å±€çŠ¶æ€"><a class="header-anchor" href="#3-é¿å…å…¨å±€çŠ¶æ€"></a>3. é¿å…å…¨å±€çŠ¶æ€</h4><p>é¿å…ä½¿ç”¨å…¨å±€å˜é‡æˆ–å•ä¾‹æ¥ç®¡ç†ä¾èµ–ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span><span class="hljs-keyword">var</span> globalDB *sql.DB<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;    globalDB = connectDB()&#125;<span class="hljs-comment">// å¥½çš„åšæ³•</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewRepository</span><span class="hljs-params">(db *sql.DB)</span> *<span class="hljs-title">Repository</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;Repository&#123;db: db&#125;&#125;</code></pre><p>å…¨å±€çŠ¶æ€ä½¿å¾—ä»£ç éš¾ä»¥æµ‹è¯•å’Œç»´æŠ¤ã€‚</p><h4 id="4-ä¾èµ–é¡¹åˆ†ç»„"><a class="header-anchor" href="#4-ä¾èµ–é¡¹åˆ†ç»„"></a>4. ä¾èµ–é¡¹åˆ†ç»„</h4><p>å½“ä¾èµ–é¡¹è¿‡å¤šæ—¶ï¼Œå¯ä»¥å°†ç›¸å…³ä¾èµ–åˆ†ç»„ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> DatabaseConfig <span class="hljs-keyword">struct</span> &#123;    Host     <span class="hljs-keyword">string</span>    Port     <span class="hljs-keyword">int</span>    Username <span class="hljs-keyword">string</span>    Password <span class="hljs-keyword">string</span>&#125;<span class="hljs-keyword">type</span> ServiceDependencies <span class="hljs-keyword">struct</span> &#123;    Repo   Repository    Logger Logger    Cache  Cache&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewService</span><span class="hljs-params">(deps ServiceDependencies)</span> *<span class="hljs-title">Service</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;Service&#123;        repo:   deps.Repo,        logger: deps.Logger,        cache:  deps.Cache,    &#125;&#125;</code></pre><p>è¿™ç§æ–¹å¼å¯ä»¥å‡å°‘æ„é€ å‡½æ•°çš„å‚æ•°æ•°é‡ï¼Œä½¿ä»£ç æ›´åŠ æ•´æ´ã€‚</p><h4 id="5-ä½¿ç”¨å‡½æ•°é€‰é¡¹æ¨¡å¼"><a class="header-anchor" href="#5-ä½¿ç”¨å‡½æ•°é€‰é¡¹æ¨¡å¼"></a>5. ä½¿ç”¨å‡½æ•°é€‰é¡¹æ¨¡å¼</h4><p>å‡½æ•°é€‰é¡¹æ¨¡å¼å…è®¸å¯é€‰ä¾èµ–å’Œé»˜è®¤å€¼ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> ServiceOption <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*Service)</span></span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithCache</span><span class="hljs-params">(cache Cache)</span> <span class="hljs-title">ServiceOption</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s *Service)</span></span> &#123;        s.cache = cache    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithLogger</span><span class="hljs-params">(logger Logger)</span> <span class="hljs-title">ServiceOption</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s *Service)</span></span> &#123;        s.logger = logger    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewService</span><span class="hljs-params">(repo Repository, options ...ServiceOption)</span> *<span class="hljs-title">Service</span></span> &#123;    s := &amp;Service&#123;        repo:   repo,        logger: defaultLogger(),    &#125;        <span class="hljs-keyword">for</span> _, option := <span class="hljs-keyword">range</span> options &#123;        option(s)    &#125;        <span class="hljs-keyword">return</span> s&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>service := NewService(    repo,    WithCache(redisCache),    WithLogger(zapLogger),)</code></pre><p>è¿™ç§æ¨¡å¼ä½¿å¾—æ„é€ å‡½æ•°æ›´åŠ çµæ´»ï¼ŒåŒæ—¶ä¿æŒäº†å¿…éœ€ä¾èµ–çš„æ˜ç¡®æ€§ã€‚</p><h3 id="ğŸ“Š-ä¾èµ–æ³¨å…¥æ¡†æ¶æ¯”è¾ƒ"><a class="header-anchor" href="#ğŸ“Š-ä¾èµ–æ³¨å…¥æ¡†æ¶æ¯”è¾ƒ"></a>ğŸ“Š ä¾èµ–æ³¨å…¥æ¡†æ¶æ¯”è¾ƒ</h3><table><thead><tr><th>æ¡†æ¶</th><th>ç±»å‹</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>æ‰‹åŠ¨æ³¨å…¥</td><td>æ— æ¡†æ¶</td><td>ç®€å•ç›´æ¥ï¼Œæ— ä¾èµ–ï¼Œæ— è¿è¡Œæ—¶å¼€é”€</td><td>éšç€åº”ç”¨å¢é•¿å˜å¾—ç¹ç</td></tr><tr><td>Wire</td><td>ç¼–è¯‘æ—¶</td><td>æ— è¿è¡Œæ—¶å¼€é”€ï¼Œç±»å‹å®‰å…¨</td><td>éœ€è¦ä»£ç ç”Ÿæˆæ­¥éª¤</td></tr><tr><td>dig</td><td>è¿è¡Œæ—¶</td><td>ä½¿ç”¨ç®€å•ï¼Œè‡ªåŠ¨è§£æä¾èµ–</td><td>æœ‰è¿è¡Œæ—¶åå°„å¼€é”€ï¼Œé”™è¯¯å¯èƒ½åœ¨è¿è¡Œæ—¶æ‰å‘ç°</td></tr><tr><td>fx</td><td>è¿è¡Œæ—¶</td><td>åŸºäºdigï¼Œå¢åŠ äº†ç”Ÿå‘½å‘¨æœŸç®¡ç†</td><td>ä¸digç›¸åŒçš„ç¼ºç‚¹</td></tr></tbody></table><p>é€‰æ‹©å“ªç§æ¡†æ¶å–å†³äºé¡¹ç›®è§„æ¨¡ã€å›¢é˜Ÿåå¥½å’Œæ€§èƒ½éœ€æ±‚ï¼š</p><ul><li><strong>å°å‹é¡¹ç›®</strong>ï¼šæ‰‹åŠ¨æ³¨å…¥é€šå¸¸è¶³å¤Ÿ</li><li><strong>ä¸­å‹é¡¹ç›®</strong>ï¼šWireæä¾›äº†è‰¯å¥½çš„å¹³è¡¡</li><li><strong>å¤§å‹é¡¹ç›®</strong>ï¼šdigæˆ–fxå¯èƒ½æ›´é€‚åˆå¤æ‚çš„ä¾èµ–å›¾</li></ul><h3 id="ğŸ§ª-ä¾èµ–æ³¨å…¥ä¸æµ‹è¯•"><a class="header-anchor" href="#ğŸ§ª-ä¾èµ–æ³¨å…¥ä¸æµ‹è¯•"></a>ğŸ§ª ä¾èµ–æ³¨å…¥ä¸æµ‹è¯•</h3><p>ä¾èµ–æ³¨å…¥çš„ä¸€ä¸ªä¸»è¦ä¼˜åŠ¿æ˜¯æé«˜ä»£ç çš„å¯æµ‹è¯•æ€§ã€‚</p><h4 id="ä½¿ç”¨æ¨¡æ‹Ÿï¼ˆMockï¼‰è¿›è¡Œæµ‹è¯•"><a class="header-anchor" href="#ä½¿ç”¨æ¨¡æ‹Ÿï¼ˆMockï¼‰è¿›è¡Œæµ‹è¯•"></a>ä½¿ç”¨æ¨¡æ‹Ÿï¼ˆMockï¼‰è¿›è¡Œæµ‹è¯•</h4><pre><code class="hljs go"><span class="hljs-comment">// åˆ›å»ºUserRepositoryçš„æ¨¡æ‹Ÿå®ç°</span><span class="hljs-keyword">type</span> MockUserRepository <span class="hljs-keyword">struct</span> &#123;    mock.Mock&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *MockUserRepository)</span> <span class="hljs-title">GetByID</span><span class="hljs-params">(id <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*User, error)</span></span> &#123;    args := m.Called(id)    <span class="hljs-keyword">return</span> args.Get(<span class="hljs-number">0</span>).(*User), args.Error(<span class="hljs-number">1</span>)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *MockUserRepository)</span> <span class="hljs-title">Save</span><span class="hljs-params">(user *User)</span> <span class="hljs-title">error</span></span> &#123;    args := m.Called(user)    <span class="hljs-keyword">return</span> args.Error(<span class="hljs-number">0</span>)&#125;<span class="hljs-comment">// æµ‹è¯•UserService</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestUserService_GetUser</span><span class="hljs-params">(t *testing.T)</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºæ¨¡æ‹Ÿ</span>    mockRepo := <span class="hljs-built_in">new</span>(MockUserRepository)        <span class="hljs-comment">// è®¾ç½®æœŸæœ›</span>    mockRepo.On(<span class="hljs-string">&quot;GetByID&quot;</span>, <span class="hljs-string">&quot;123&quot;</span>).Return(&amp;User&#123;ID: <span class="hljs-string">&quot;123&quot;</span>, Name: <span class="hljs-string">&quot;Test&quot;</span>&#125;, <span class="hljs-literal">nil</span>)        <span class="hljs-comment">// åˆ›å»ºæœåŠ¡å¹¶æ³¨å…¥æ¨¡æ‹Ÿ</span>    service := NewUserService(mockRepo)        <span class="hljs-comment">// è°ƒç”¨è¢«æµ‹è¯•çš„æ–¹æ³•</span>    user, err := service.GetUser(<span class="hljs-string">&quot;123&quot;</span>)        <span class="hljs-comment">// æ–­è¨€</span>    assert.NoError(t, err)    assert.Equal(t, <span class="hljs-string">&quot;123&quot;</span>, user.ID)    assert.Equal(t, <span class="hljs-string">&quot;Test&quot;</span>, user.Name)        <span class="hljs-comment">// éªŒè¯æ¨¡æ‹Ÿçš„è°ƒç”¨</span>    mockRepo.AssertExpectations(t)&#125;</code></pre><h4 id="ä½¿ç”¨æµ‹è¯•å®¹å™¨"><a class="header-anchor" href="#ä½¿ç”¨æµ‹è¯•å®¹å™¨"></a>ä½¿ç”¨æµ‹è¯•å®¹å™¨</h4><p>å¯¹äºéœ€è¦é›†æˆæµ‹è¯•çš„æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ä¸“é—¨çš„æµ‹è¯•å®¹å™¨ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestIntegration</span><span class="hljs-params">(t *testing.T)</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºæµ‹è¯•å®¹å™¨</span>    container := NewContainer()        <span class="hljs-comment">// æ³¨å†Œæµ‹è¯•ä¾èµ–</span>    container.Register(NewTestConfig())    container.Register(NewTestDatabase())    container.RegisterAs(NewMockRepository(), reflect.TypeOf((*Repository)(<span class="hljs-literal">nil</span>)).Elem())        <span class="hljs-comment">// è·å–è¢«æµ‹è¯•çš„æœåŠ¡</span>    <span class="hljs-keyword">var</span> service *Service    <span class="hljs-keyword">if</span> s, ok := container.Get(reflect.TypeOf(&amp;Service&#123;&#125;)); ok &#123;        service = s.(*Service)    &#125; <span class="hljs-keyword">else</span> &#123;        t.Fatal(<span class="hljs-string">&quot;Failed to get service&quot;</span>)    &#125;        <span class="hljs-comment">// æµ‹è¯•æœåŠ¡</span>    result, err := service.DoSomething()    assert.NoError(t, err)    assert.NotNil(t, result)&#125;</code></pre><h3 id="ğŸš«-å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ"><a class="header-anchor" href="#ğŸš«-å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ"></a>ğŸš« å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ</h3><h4 id="1-å¾ªç¯ä¾èµ–"><a class="header-anchor" href="#1-å¾ªç¯ä¾èµ–"></a>1. å¾ªç¯ä¾èµ–</h4><p>å½“Aä¾èµ–Bï¼ŒBåˆä¾èµ–Aæ—¶ï¼Œä¼šäº§ç”Ÿå¾ªç¯ä¾èµ–ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// Aä¾èµ–B</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewA</span><span class="hljs-params">(b *B)</span> *<span class="hljs-title">A</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;A&#123;b: b&#125;&#125;<span class="hljs-comment">// Bä¾èµ–A</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewB</span><span class="hljs-params">(a *A)</span> *<span class="hljs-title">B</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;B&#123;a: a&#125;&#125;</code></pre><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ul><li>é‡æ–°è®¾è®¡ç»„ä»¶ï¼Œæ¶ˆé™¤å¾ªç¯ä¾èµ–</li><li>ä½¿ç”¨æ¥å£æ‰“ç ´å¾ªç¯</li><li>ä½¿ç”¨æ–¹æ³•æ³¨å…¥è€Œéæ„é€ å‡½æ•°æ³¨å…¥</li></ul><h4 id="2-è¿‡åº¦æ³¨å…¥"><a class="header-anchor" href="#2-è¿‡åº¦æ³¨å…¥"></a>2. è¿‡åº¦æ³¨å…¥</h4><p>å°†æ‰€æœ‰ä¸œè¥¿éƒ½æ³¨å…¥å¯èƒ½å¯¼è‡´ç»„ä»¶è¿‡äºå¤æ‚ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewService</span><span class="hljs-params">(</span></span><span class="hljs-function"><span class="hljs-params">    repo Repository,</span></span><span class="hljs-function"><span class="hljs-params">    cache Cache,</span></span><span class="hljs-function"><span class="hljs-params">    logger Logger,</span></span><span class="hljs-function"><span class="hljs-params">    metrics Metrics,</span></span><span class="hljs-function"><span class="hljs-params">    tracer Tracer,</span></span><span class="hljs-function"><span class="hljs-params">    config Config,</span></span><span class="hljs-function"><span class="hljs-params">    // ... æ›´å¤šä¾èµ–</span></span><span class="hljs-function"><span class="hljs-params">)</span> *<span class="hljs-title">Service</span></span> &#123;    <span class="hljs-comment">// ...</span>&#125;</code></pre><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ul><li>ä¾èµ–é¡¹åˆ†ç»„</li><li>ä½¿ç”¨å‡½æ•°é€‰é¡¹æ¨¡å¼</li><li>é‡æ–°è¯„ä¼°è®¾è®¡ï¼Œå¯èƒ½éœ€è¦æ‹†åˆ†ç»„ä»¶</li></ul><h4 id="3-æœåŠ¡å®šä½å™¨åæ¨¡å¼"><a class="header-anchor" href="#3-æœåŠ¡å®šä½å™¨åæ¨¡å¼"></a>3. æœåŠ¡å®šä½å™¨åæ¨¡å¼</h4><p>æœåŠ¡å®šä½å™¨çœ‹èµ·æ¥åƒä¾èµ–æ³¨å…¥ï¼Œä½†å®é™…ä¸Šæ˜¯å…¨å±€çŠ¶æ€çš„å¦ä¸€ç§å½¢å¼ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span><span class="hljs-keyword">type</span> ServiceLocator <span class="hljs-keyword">struct</span> &#123;    services <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#125;<span class="hljs-keyword">var</span> globalLocator = NewServiceLocator()<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetService</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    <span class="hljs-keyword">return</span> globalLocator.Get(name)&#125;<span class="hljs-comment">// åœ¨ä»£ç ä¸­ä½¿ç”¨</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">DoSomething</span><span class="hljs-params">()</span></span> &#123;    repo := GetService(<span class="hljs-string">&quot;repository&quot;</span>).(Repository)    <span class="hljs-comment">// ä½¿ç”¨repo</span>&#125;</code></pre><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ul><li>ä½¿ç”¨çœŸæ­£çš„ä¾èµ–æ³¨å…¥</li><li>æ˜ç¡®å£°æ˜ä¾èµ–å…³ç³»</li></ul><h4 id="4-æ„é€ å‡½æ•°çˆ†ç‚¸"><a class="header-anchor" href="#4-æ„é€ å‡½æ•°çˆ†ç‚¸"></a>4. æ„é€ å‡½æ•°çˆ†ç‚¸</h4><p>éšç€åº”ç”¨å¢é•¿ï¼Œå¯èƒ½ä¼šå‡ºç°å¤§é‡çš„æ„é€ å‡½æ•°å’Œå¤æ‚çš„åˆå§‹åŒ–ä»£ç ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    config := NewConfig()    logger := NewLogger(config)    db := NewDatabase(config)    cache := NewCache(config)    repo := NewRepository(db, cache)    validator := NewValidator()    service := NewService(repo, logger, validator)    handler := NewHandler(service, logger)    server := NewServer(handler, config)    server.Start()&#125;</code></pre><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ul><li>ä½¿ç”¨ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼ˆWireã€digç­‰ï¼‰</li><li>åˆ›å»ºåº”ç”¨åˆå§‹åŒ–æ¨¡å—</li><li>ä½¿ç”¨å·¥å‚æ¨¡å¼</li></ul><h3 id="ğŸ“-å®é™…æ¡ˆä¾‹ï¼šæ„å»ºWebåº”ç”¨"><a class="header-anchor" href="#ğŸ“-å®é™…æ¡ˆä¾‹ï¼šæ„å»ºWebåº”ç”¨"></a>ğŸ“ å®é™…æ¡ˆä¾‹ï¼šæ„å»ºWebåº”ç”¨</h3><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ä¾èµ–æ³¨å…¥æ„å»ºWebåº”ç”¨çš„å®Œæ•´ç¤ºä¾‹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;database/sql&quot;</span>    <span class="hljs-string">&quot;log&quot;</span>    <span class="hljs-string">&quot;net/http&quot;</span>        <span class="hljs-string">&quot;github.com/google/wire&quot;</span>    _ <span class="hljs-string">&quot;github.com/lib/pq&quot;</span>)<span class="hljs-comment">// é…ç½®</span><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;    DBConnectionString <span class="hljs-keyword">string</span>    ServerPort         <span class="hljs-keyword">string</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConfig</span><span class="hljs-params">()</span> *<span class="hljs-title">Config</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;Config&#123;        DBConnectionString: <span class="hljs-string">&quot;postgres://user:pass@localhost/db&quot;</span>,        ServerPort:         <span class="hljs-string">&quot;:8080&quot;</span>,    &#125;&#125;<span class="hljs-comment">// æ•°æ®åº“</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDB</span><span class="hljs-params">(config *Config)</span> <span class="hljs-params">(*sql.DB, error)</span></span> &#123;    db, err := sql.Open(<span class="hljs-string">&quot;postgres&quot;</span>, config.DBConnectionString)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;    <span class="hljs-keyword">if</span> err := db.Ping(); err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;    <span class="hljs-keyword">return</span> db, <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// ä»“åº“</span><span class="hljs-keyword">type</span> UserRepository <span class="hljs-keyword">struct</span> &#123;    db *sql.DB&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserRepository</span><span class="hljs-params">(db *sql.DB)</span> *<span class="hljs-title">UserRepository</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;UserRepository&#123;db: db&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *UserRepository)</span> <span class="hljs-title">GetByID</span><span class="hljs-params">(id <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*User, error)</span></span> &#123;    <span class="hljs-comment">// ä»æ•°æ®åº“è·å–ç”¨æˆ·</span>    <span class="hljs-keyword">return</span> &amp;User&#123;ID: id, Name: <span class="hljs-string">&quot;User &quot;</span> + id&#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// æ¨¡å‹</span><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;    ID   <span class="hljs-keyword">string</span>    Name <span class="hljs-keyword">string</span>&#125;<span class="hljs-comment">// æœåŠ¡</span><span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span> &#123;    repo *UserRepository&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserService</span><span class="hljs-params">(repo *UserRepository)</span> *<span class="hljs-title">UserService</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;UserService&#123;repo: repo&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span> <span class="hljs-title">GetUser</span><span class="hljs-params">(id <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*User, error)</span></span> &#123;    <span class="hljs-keyword">return</span> s.repo.GetByID(id)&#125;<span class="hljs-comment">// å¤„ç†å™¨</span><span class="hljs-keyword">type</span> UserHandler <span class="hljs-keyword">struct</span> &#123;    service *UserService&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserHandler</span><span class="hljs-params">(service *UserService)</span> *<span class="hljs-title">UserHandler</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;UserHandler&#123;service: service&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *UserHandler)</span> <span class="hljs-title">GetUser</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;    id := r.URL.Query().Get(<span class="hljs-string">&quot;id&quot;</span>)    <span class="hljs-keyword">if</span> id == <span class="hljs-string">&quot;&quot;</span> &#123;        http.Error(w, <span class="hljs-string">&quot;Missing id parameter&quot;</span>, http.StatusBadRequest)        <span class="hljs-keyword">return</span>    &#125;        user, err := h.service.GetUser(id)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        http.Error(w, err.Error(), http.StatusInternalServerError)        <span class="hljs-keyword">return</span>    &#125;        w.Header().Set(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>)    w.WriteHeader(http.StatusOK)    w.Write([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">`&#123;&quot;id&quot;:&quot;`</span> + user.ID + <span class="hljs-string">`&quot;,&quot;name&quot;:&quot;`</span> + user.Name + <span class="hljs-string">`&quot;&#125;`</span>))&#125;<span class="hljs-comment">// æœåŠ¡å™¨</span><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;    handler *UserHandler    port    <span class="hljs-keyword">string</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span><span class="hljs-params">(handler *UserHandler, config *Config)</span> *<span class="hljs-title">Server</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;Server&#123;        handler: handler,        port:    config.ServerPort,    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span> <span class="hljs-title">Start</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;    http.HandleFunc(<span class="hljs-string">&quot;/user&quot;</span>, s.handler.GetUser)    <span class="hljs-keyword">return</span> http.ListenAndServe(s.port, <span class="hljs-literal">nil</span>)&#125;<span class="hljs-comment">// ä½¿ç”¨Wireè¿›è¡Œä¾èµ–æ³¨å…¥</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitializeServer</span><span class="hljs-params">()</span> <span class="hljs-params">(*Server, error)</span></span> &#123;    wire.Build(        NewConfig,        NewDB,        NewUserRepository,        NewUserService,        NewUserHandler,        NewServer,    )    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    server, err := InitializeServer()    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;Failed to initialize server: %v&quot;</span>, err)    &#125;        log.Printf(<span class="hljs-string">&quot;Starting server on port %s&quot;</span>, server.port)    <span class="hljs-keyword">if</span> err := server.Start(); err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;Server error: %v&quot;</span>, err)    &#125;&#125;</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†æ„é€ å‡½æ•°æ³¨å…¥å’ŒWireæ¡†æ¶æ¥ç®¡ç†ä¾èµ–å…³ç³»ã€‚æ¯ä¸ªç»„ä»¶éƒ½æ˜ç¡®å£°æ˜äº†å…¶ä¾èµ–ï¼Œä½¿å¾—ä»£ç æ˜“äºç†è§£å’Œæµ‹è¯•ã€‚</p><h3 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h3><p>ä¾èµ–æ³¨å…¥æ˜¯ä¸€ç§å¼ºå¤§çš„è®¾è®¡æ¨¡å¼ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç¼–å†™æ›´åŠ æ¨¡å—åŒ–ã€å¯æµ‹è¯•å’Œå¯ç»´æŠ¤çš„Goä»£ç ã€‚åœ¨Goä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šç§æ–¹å¼å®ç°ä¾èµ–æ³¨å…¥ï¼Œä»ç®€å•çš„æ‰‹åŠ¨æ³¨å…¥åˆ°ä½¿ç”¨ä¸“é—¨çš„æ¡†æ¶å¦‚Wireæˆ–digã€‚</p><p>å…³é”®è¦ç‚¹ï¼š</p><ol><li><strong>é¢å‘æ¥å£ç¼–ç¨‹</strong>ï¼šä¾èµ–äºæŠ½è±¡è€Œéå…·ä½“å®ç°</li><li><strong>ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥</strong>ï¼šæ˜ç¡®å£°æ˜ä¾èµ–å…³ç³»</li><li><strong>é¿å…å…¨å±€çŠ¶æ€</strong>ï¼šä½¿ä»£ç æ›´æ˜“äºæµ‹è¯•</li><li><strong>é€‰æ‹©åˆé€‚çš„å·¥å…·</strong>ï¼šæ ¹æ®é¡¹ç›®è§„æ¨¡å’Œéœ€æ±‚é€‰æ‹©ä¾èµ–æ³¨å…¥æ–¹å¼</li><li><strong>æ³¨æ„å¸¸è§é™·é˜±</strong>ï¼šé¿å…å¾ªç¯ä¾èµ–ã€è¿‡åº¦æ³¨å…¥å’ŒæœåŠ¡å®šä½å™¨åæ¨¡å¼</li></ol><p>é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œæˆ‘ä»¬å¯ä»¥å……åˆ†åˆ©ç”¨ä¾èµ–æ³¨å…¥çš„ä¼˜åŠ¿ï¼Œæ„å»ºå‡ºé«˜è´¨é‡çš„Goåº”ç”¨ç¨‹åºã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>ä¾èµ–æ³¨å…¥</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
      <tag>æ¶æ„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang åå°„æœºåˆ¶è¯¦è§£ä¸å®æˆ˜åº”ç”¨</title>
    <link href="/2024/06/10/golang-%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/"/>
    <url>/2024/06/10/golang-%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ”-golang-åå°„æœºåˆ¶è¯¦è§£ä¸å®æˆ˜åº”ç”¨"><a class="header-anchor" href="#ğŸ”-golang-åå°„æœºåˆ¶è¯¦è§£ä¸å®æˆ˜åº”ç”¨"></a>ğŸ” golang åå°„æœºåˆ¶è¯¦è§£ä¸å®æˆ˜åº”ç”¨</h2><p>åå°„æ˜¯Goè¯­è¨€ä¸­çš„ä¸€ä¸ªå¼ºå¤§ç‰¹æ€§ï¼Œå®ƒå…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶æ£€æŸ¥è‡ªèº«çš„ç»“æ„ï¼Œç‰¹åˆ«æ˜¯ç±»å‹çš„ç»“æ„ã€‚è™½ç„¶åå°„åŠŸèƒ½å¼ºå¤§ï¼Œä½†ä½¿ç”¨ä¸å½“ä¼šå¯¼è‡´ä»£ç éš¾ä»¥ç†è§£å’Œç»´æŠ¤ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Goè¯­è¨€çš„åå°„æœºåˆ¶ï¼Œå¹¶é€šè¿‡å®é™…æ¡ˆä¾‹å±•ç¤ºå…¶åº”ç”¨åœºæ™¯ã€‚</p><h3 id="ğŸ“š-åå°„çš„åŸºæœ¬æ¦‚å¿µ"><a class="header-anchor" href="#ğŸ“š-åå°„çš„åŸºæœ¬æ¦‚å¿µ"></a>ğŸ“š åå°„çš„åŸºæœ¬æ¦‚å¿µ</h3><p>Goè¯­è¨€çš„åå°„åŸºäºä¸¤ä¸ªé‡è¦çš„ç±»å‹ï¼š<code>reflect.Type</code>å’Œ<code>reflect.Value</code>ã€‚å‰è€…è¡¨ç¤ºGoç±»å‹ï¼Œåè€…è¡¨ç¤ºGoå€¼ã€‚åå°„çš„æ ¸å¿ƒæ˜¯ä»æ¥å£å€¼åˆ°åå°„å¯¹è±¡çš„è½¬æ¢ï¼Œä»¥åŠä»åå°„å¯¹è±¡å›åˆ°æ¥å£å€¼çš„è½¬æ¢ã€‚</p><h4 id="åå°„çš„ä¸‰å¤§æ³•åˆ™"><a class="header-anchor" href="#åå°„çš„ä¸‰å¤§æ³•åˆ™"></a>åå°„çš„ä¸‰å¤§æ³•åˆ™</h4><ol><li><strong>ä»æ¥å£å€¼åˆ°åå°„å¯¹è±¡</strong>ï¼šé€šè¿‡<code>reflect.TypeOf()</code>å’Œ<code>reflect.ValueOf()</code>å‡½æ•°</li><li><strong>ä»åå°„å¯¹è±¡åˆ°æ¥å£å€¼</strong>ï¼šé€šè¿‡<code>reflect.Value</code>çš„<code>Interface()</code>æ–¹æ³•</li><li><strong>è¦ä¿®æ”¹åå°„å¯¹è±¡ï¼Œå…¶å€¼å¿…é¡»å¯è®¾ç½®(Settable)</strong>ï¼šåªæœ‰å½“åŸå§‹å€¼æ˜¯å¯å¯»å€çš„ï¼Œå…¶åå°„å€¼æ‰æ˜¯å¯è®¾ç½®çš„</li></ol><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;fmt&quot;</span>    <span class="hljs-string">&quot;reflect&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// æ³•åˆ™1: ä»æ¥å£å€¼åˆ°åå°„å¯¹è±¡</span>    x := <span class="hljs-number">3.14</span>    v := reflect.ValueOf(x)    t := reflect.TypeOf(x)        fmt.Printf(<span class="hljs-string">&quot;ç±»å‹: %s\n&quot;</span>, t)    fmt.Printf(<span class="hljs-string">&quot;å€¼: %v\n&quot;</span>, v)        <span class="hljs-comment">// æ³•åˆ™2: ä»åå°„å¯¹è±¡åˆ°æ¥å£å€¼</span>    i := v.Interface()    fmt.Printf(<span class="hljs-string">&quot;æ¥å£å€¼: %v (%T)\n&quot;</span>, i, i)        <span class="hljs-comment">// æ³•åˆ™3: è¦ä¿®æ”¹åå°„å¯¹è±¡ï¼Œå…¶å€¼å¿…é¡»å¯è®¾ç½®</span>    p := reflect.ValueOf(&amp;x) <span class="hljs-comment">// è·å–xçš„åœ°å€</span>    e := p.Elem()            <span class="hljs-comment">// è§£å¼•ç”¨</span>        <span class="hljs-keyword">if</span> e.CanSet() &#123;        e.SetFloat(<span class="hljs-number">3.1415926</span>)        fmt.Printf(<span class="hljs-string">&quot;ä¿®æ”¹åçš„xå€¼: %v\n&quot;</span>, x)    &#125;&#125;</code></pre><h3 id="ğŸ§©-åå°„çš„å¸¸ç”¨æ“ä½œ"><a class="header-anchor" href="#ğŸ§©-åå°„çš„å¸¸ç”¨æ“ä½œ"></a>ğŸ§© åå°„çš„å¸¸ç”¨æ“ä½œ</h3><h4 id="1-è·å–ç±»å‹ä¿¡æ¯"><a class="header-anchor" href="#1-è·å–ç±»å‹ä¿¡æ¯"></a>1. è·å–ç±»å‹ä¿¡æ¯</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">inspectType</span><span class="hljs-params">(x <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;    t := reflect.TypeOf(x)        fmt.Printf(<span class="hljs-string">&quot;ç±»å‹: %s\n&quot;</span>, t)    fmt.Printf(<span class="hljs-string">&quot;ç§ç±»: %s\n&quot;</span>, t.Kind())        <span class="hljs-comment">// å¦‚æœæ˜¯ç»“æ„ä½“ï¼Œéå†å­—æ®µ</span>    <span class="hljs-keyword">if</span> t.Kind() == reflect.Struct &#123;        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; t.NumField(); i++ &#123;            field := t.Field(i)            fmt.Printf(<span class="hljs-string">&quot;å­—æ®µ #%d: %s (%s) æ ‡ç­¾: %v\n&quot;</span>,                 i, field.Name, field.Type, field.Tag)        &#125;    &#125;        <span class="hljs-comment">// å¦‚æœæœ‰æ–¹æ³•ï¼Œéå†æ–¹æ³•</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; t.NumMethod(); i++ &#123;        method := t.Method(i)        fmt.Printf(<span class="hljs-string">&quot;æ–¹æ³• #%d: %s\n&quot;</span>, i, method.Name)    &#125;&#125;</code></pre><h4 id="2-è·å–å’Œè®¾ç½®å€¼"><a class="header-anchor" href="#2-è·å–å’Œè®¾ç½®å€¼"></a>2. è·å–å’Œè®¾ç½®å€¼</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">manipulateValue</span><span class="hljs-params">(x <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;    v := reflect.ValueOf(x)        <span class="hljs-comment">// å¦‚æœæ˜¯æŒ‡é’ˆï¼Œè·å–å…¶æŒ‡å‘çš„å…ƒç´ </span>    <span class="hljs-keyword">if</span> v.Kind() == reflect.Ptr &#123;        v = v.Elem()    &#125;        <span class="hljs-comment">// æ£€æŸ¥å€¼æ˜¯å¦å¯è®¾ç½®</span>    <span class="hljs-keyword">if</span> !v.CanSet() &#123;        fmt.Println(<span class="hljs-string">&quot;è¯¥å€¼ä¸å¯è®¾ç½®&quot;</span>)        <span class="hljs-keyword">return</span>    &#125;        <span class="hljs-comment">// æ ¹æ®ä¸åŒç±»å‹è®¾ç½®å€¼</span>    <span class="hljs-keyword">switch</span> v.Kind() &#123;    <span class="hljs-keyword">case</span> reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:        v.SetInt(<span class="hljs-number">100</span>)    <span class="hljs-keyword">case</span> reflect.Float32, reflect.Float64:        v.SetFloat(<span class="hljs-number">3.14</span>)    <span class="hljs-keyword">case</span> reflect.String:        v.SetString(<span class="hljs-string">&quot;åå°„ä¿®æ”¹çš„å­—ç¬¦ä¸²&quot;</span>)    <span class="hljs-keyword">case</span> reflect.Bool:        v.SetBool(<span class="hljs-literal">true</span>)    &#125;&#125;</code></pre><h4 id="3-è°ƒç”¨å‡½æ•°å’Œæ–¹æ³•"><a class="header-anchor" href="#3-è°ƒç”¨å‡½æ•°å’Œæ–¹æ³•"></a>3. è°ƒç”¨å‡½æ•°å’Œæ–¹æ³•</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">callFunctionByReflection</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªå‡½æ•°</span>    fn := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(a, b <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123; <span class="hljs-keyword">return</span> a + b &#125;        <span class="hljs-comment">// è·å–å‡½æ•°çš„åå°„å€¼</span>    v := reflect.ValueOf(fn)        <span class="hljs-comment">// å‡†å¤‡å‚æ•°</span>    args := []reflect.Value&#123;        reflect.ValueOf(<span class="hljs-number">10</span>),        reflect.ValueOf(<span class="hljs-number">20</span>),    &#125;        <span class="hljs-comment">// è°ƒç”¨å‡½æ•°</span>    results := v.Call(args)        <span class="hljs-comment">// å¤„ç†è¿”å›å€¼</span>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(results) &gt; <span class="hljs-number">0</span> &#123;        fmt.Printf(<span class="hljs-string">&quot;å‡½æ•°è¿”å›å€¼: %v\n&quot;</span>, results[<span class="hljs-number">0</span>].Interface())    &#125;&#125;</code></pre><h3 id="ğŸš€-åå°„çš„å®é™…åº”ç”¨åœºæ™¯"><a class="header-anchor" href="#ğŸš€-åå°„çš„å®é™…åº”ç”¨åœºæ™¯"></a>ğŸš€ åå°„çš„å®é™…åº”ç”¨åœºæ™¯</h3><h4 id="1-ORMæ¡†æ¶"><a class="header-anchor" href="#1-ORMæ¡†æ¶"></a>1. ORMæ¡†æ¶</h4><p>ORM(å¯¹è±¡å…³ç³»æ˜ å°„)æ¡†æ¶æ˜¯åå°„çš„å…¸å‹åº”ç”¨åœºæ™¯ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–çš„ORMç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨åå°„å°†ç»“æ„ä½“æ˜ å°„åˆ°æ•°æ®åº“è¡¨ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;fmt&quot;</span>    <span class="hljs-string">&quot;reflect&quot;</span>    <span class="hljs-string">&quot;strings&quot;</span>)<span class="hljs-comment">// å®šä¹‰è¡¨ç»“æ„çš„æ ‡ç­¾</span><span class="hljs-keyword">const</span> tagName = <span class="hljs-string">&quot;db&quot;</span><span class="hljs-comment">// æ¨¡æ‹Ÿçš„æ•°æ®åº“è®°å½•</span><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;    ID        <span class="hljs-keyword">int</span>    <span class="hljs-string">`db:&quot;id,primary&quot;`</span>    Username  <span class="hljs-keyword">string</span> <span class="hljs-string">`db:&quot;username&quot;`</span>    Email     <span class="hljs-keyword">string</span> <span class="hljs-string">`db:&quot;email&quot;`</span>    CreatedAt <span class="hljs-keyword">string</span> <span class="hljs-string">`db:&quot;created_at&quot;`</span>&#125;<span class="hljs-comment">// ç”Ÿæˆæ’å…¥SQLè¯­å¥</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Insert</span><span class="hljs-params">(data <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">string</span></span> &#123;    t := reflect.TypeOf(data)    v := reflect.ValueOf(data)        <span class="hljs-comment">// ç¡®ä¿æ˜¯ç»“æ„ä½“</span>    <span class="hljs-keyword">if</span> t.Kind() != reflect.Struct &#123;        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>    &#125;        <span class="hljs-comment">// è·å–è¡¨åï¼ˆä½¿ç”¨ç»“æ„ä½“åç§°çš„å°å†™å½¢å¼ï¼‰</span>    tableName := strings.ToLower(t.Name())        <span class="hljs-keyword">var</span> columns []<span class="hljs-keyword">string</span>    <span class="hljs-keyword">var</span> placeholders []<span class="hljs-keyword">string</span>    <span class="hljs-keyword">var</span> values []<span class="hljs-keyword">interface</span>&#123;&#125;        <span class="hljs-comment">// éå†æ‰€æœ‰å­—æ®µ</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; t.NumField(); i++ &#123;        field := t.Field(i)                <span class="hljs-comment">// è·å–dbæ ‡ç­¾</span>        tag := field.Tag.Get(tagName)        <span class="hljs-keyword">if</span> tag == <span class="hljs-string">&quot;&quot;</span> &#123;            <span class="hljs-keyword">continue</span>        &#125;                <span class="hljs-comment">// è§£ææ ‡ç­¾</span>        parts := strings.Split(tag, <span class="hljs-string">&quot;,&quot;</span>)        columnName := parts[<span class="hljs-number">0</span>]                <span class="hljs-comment">// æ·»åŠ åˆ—åå’Œå ä½ç¬¦</span>        columns = <span class="hljs-built_in">append</span>(columns, columnName)        placeholders = <span class="hljs-built_in">append</span>(placeholders, <span class="hljs-string">&quot;?&quot;</span>)                <span class="hljs-comment">// è·å–å­—æ®µå€¼</span>        fieldValue := v.Field(i).Interface()        values = <span class="hljs-built_in">append</span>(values, fieldValue)    &#125;        <span class="hljs-comment">// æ„å»ºSQLè¯­å¥</span>    sql := fmt.Sprintf(        <span class="hljs-string">&quot;INSERT INTO %s (%s) VALUES (%s)&quot;</span>,        tableName,        strings.Join(columns, <span class="hljs-string">&quot;, &quot;</span>),        strings.Join(placeholders, <span class="hljs-string">&quot;, &quot;</span>),    )        <span class="hljs-comment">// åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ‰§è¡ŒSQLå¹¶ä¼ å…¥values</span>    fmt.Printf(<span class="hljs-string">&quot;SQL: %s\n&quot;</span>, sql)    fmt.Printf(<span class="hljs-string">&quot;Values: %v\n&quot;</span>, values)        <span class="hljs-keyword">return</span> sql&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    user := User&#123;        ID:        <span class="hljs-number">1</span>,        Username:  <span class="hljs-string">&quot;gopher&quot;</span>,        Email:     <span class="hljs-string">&quot;gopher@example.com&quot;</span>,        CreatedAt: <span class="hljs-string">&quot;2024-06-10&quot;</span>,    &#125;        Insert(user)&#125;</code></pre><h4 id="2-JSONåºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a class="header-anchor" href="#2-JSONåºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>2. JSONåºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h4><p>Goçš„<code>encoding/json</code>åŒ…å¤§é‡ä½¿ç”¨åå°„æ¥å®ç°JSONçš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;encoding/json&quot;</span>    <span class="hljs-string">&quot;fmt&quot;</span>    <span class="hljs-string">&quot;reflect&quot;</span>)<span class="hljs-comment">// è‡ªå®šä¹‰JSONç¼–ç å™¨</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">EncodeJSON</span><span class="hljs-params">(v <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, error)</span></span> &#123;    <span class="hljs-comment">// ä½¿ç”¨åå°„è·å–å€¼</span>    rv := reflect.ValueOf(v)        <span class="hljs-comment">// å¦‚æœæ˜¯æŒ‡é’ˆï¼Œè·å–å…¶æŒ‡å‘çš„å…ƒç´ </span>    <span class="hljs-keyword">if</span> rv.Kind() == reflect.Ptr &#123;        rv = rv.Elem()    &#125;        <span class="hljs-comment">// æ ¹æ®ç±»å‹ç”ŸæˆJSON</span>    <span class="hljs-keyword">switch</span> rv.Kind() &#123;    <span class="hljs-keyword">case</span> reflect.Struct:        <span class="hljs-keyword">return</span> encodeStruct(rv)    <span class="hljs-keyword">case</span> reflect.Map:        <span class="hljs-keyword">return</span> encodeMap(rv)    <span class="hljs-keyword">case</span> reflect.Slice, reflect.Array:        <span class="hljs-keyword">return</span> encodeArray(rv)    <span class="hljs-keyword">case</span> reflect.String:        <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;\&quot;%s\&quot;&quot;</span>, rv.String()), <span class="hljs-literal">nil</span>    <span class="hljs-keyword">case</span> reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:        <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;%d&quot;</span>, rv.Int()), <span class="hljs-literal">nil</span>    <span class="hljs-keyword">case</span> reflect.Float32, reflect.Float64:        <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;%g&quot;</span>, rv.Float()), <span class="hljs-literal">nil</span>    <span class="hljs-keyword">case</span> reflect.Bool:        <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;%t&quot;</span>, rv.Bool()), <span class="hljs-literal">nil</span>    <span class="hljs-keyword">default</span>:        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, fmt.Errorf(<span class="hljs-string">&quot;ä¸æ”¯æŒçš„ç±»å‹: %s&quot;</span>, rv.Kind())    &#125;&#125;<span class="hljs-comment">// ç¼–ç ç»“æ„ä½“</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">encodeStruct</span><span class="hljs-params">(v reflect.Value)</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, error)</span></span> &#123;    t := v.Type()    <span class="hljs-keyword">var</span> pairs []<span class="hljs-keyword">string</span>        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; t.NumField(); i++ &#123;        field := t.Field(i)                <span class="hljs-comment">// è·å–jsonæ ‡ç­¾</span>        tag := field.Tag.Get(<span class="hljs-string">&quot;json&quot;</span>)        <span class="hljs-keyword">if</span> tag == <span class="hljs-string">&quot;-&quot;</span> &#123;            <span class="hljs-keyword">continue</span>        &#125;                <span class="hljs-comment">// è§£ææ ‡ç­¾</span>        name := field.Name        <span class="hljs-keyword">if</span> tag != <span class="hljs-string">&quot;&quot;</span> &#123;            parts := strings.Split(tag, <span class="hljs-string">&quot;,&quot;</span>)            <span class="hljs-keyword">if</span> parts[<span class="hljs-number">0</span>] != <span class="hljs-string">&quot;&quot;</span> &#123;                name = parts[<span class="hljs-number">0</span>]            &#125;        &#125;                <span class="hljs-comment">// è·å–å­—æ®µå€¼</span>        val, err := EncodeJSON(v.Field(i).Interface())        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err        &#125;                pairs = <span class="hljs-built_in">append</span>(pairs, fmt.Sprintf(<span class="hljs-string">&quot;\&quot;%s\&quot;:%s&quot;</span>, name, val))    &#125;        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;&quot;</span> + strings.Join(pairs, <span class="hljs-string">&quot;,&quot;</span>) + <span class="hljs-string">&quot;&#125;&quot;</span>, <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// ç¼–ç æ˜ å°„</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">encodeMap</span><span class="hljs-params">(v reflect.Value)</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, error)</span></span> &#123;    <span class="hljs-keyword">var</span> pairs []<span class="hljs-keyword">string</span>    keys := v.MapKeys()        <span class="hljs-keyword">for</span> _, k := <span class="hljs-keyword">range</span> keys &#123;        <span class="hljs-comment">// é”®å¿…é¡»æ˜¯å­—ç¬¦ä¸²</span>        <span class="hljs-keyword">if</span> k.Kind() != reflect.String &#123;            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, fmt.Errorf(<span class="hljs-string">&quot;æ˜ å°„é”®å¿…é¡»æ˜¯å­—ç¬¦ä¸²&quot;</span>)        &#125;                <span class="hljs-comment">// è·å–å€¼</span>        val, err := EncodeJSON(v.MapIndex(k).Interface())        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err        &#125;                pairs = <span class="hljs-built_in">append</span>(pairs, fmt.Sprintf(<span class="hljs-string">&quot;\&quot;%s\&quot;:%s&quot;</span>, k.String(), val))    &#125;        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;&quot;</span> + strings.Join(pairs, <span class="hljs-string">&quot;,&quot;</span>) + <span class="hljs-string">&quot;&#125;&quot;</span>, <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// ç¼–ç æ•°ç»„æˆ–åˆ‡ç‰‡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">encodeArray</span><span class="hljs-params">(v reflect.Value)</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, error)</span></span> &#123;    <span class="hljs-keyword">var</span> elements []<span class="hljs-keyword">string</span>        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; v.Len(); i++ &#123;        val, err := EncodeJSON(v.Index(i).Interface())        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err        &#125;                elements = <span class="hljs-built_in">append</span>(elements, val)    &#125;        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;[&quot;</span> + strings.Join(elements, <span class="hljs-string">&quot;,&quot;</span>) + <span class="hljs-string">&quot;]&quot;</span>, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// ä½¿ç”¨æ ‡å‡†åº“è¿›è¡Œæ¯”è¾ƒ</span>    <span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;        Name    <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span>        Age     <span class="hljs-keyword">int</span>    <span class="hljs-string">`json:&quot;age&quot;`</span>        Address <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;address,omitempty&quot;`</span>    &#125;        p := Person&#123;        Name: <span class="hljs-string">&quot;å¼ ä¸‰&quot;</span>,        Age:  <span class="hljs-number">30</span>,    &#125;        <span class="hljs-comment">// æ ‡å‡†åº“åºåˆ—åŒ–</span>    stdJSON, _ := json.Marshal(p)    fmt.Printf(<span class="hljs-string">&quot;æ ‡å‡†åº“: %s\n&quot;</span>, <span class="hljs-keyword">string</span>(stdJSON))        <span class="hljs-comment">// è‡ªå®šä¹‰åºåˆ—åŒ–</span>    customJSON, _ := EncodeJSON(p)    fmt.Printf(<span class="hljs-string">&quot;è‡ªå®šä¹‰: %s\n&quot;</span>, customJSON)&#125;</code></pre><h4 id="3-ä¾èµ–æ³¨å…¥"><a class="header-anchor" href="#3-ä¾èµ–æ³¨å…¥"></a>3. ä¾èµ–æ³¨å…¥</h4><p>åå°„å¯ä»¥ç”¨äºå®ç°ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼ŒåŠ¨æ€åœ°å°†ä¾èµ–é¡¹æ³¨å…¥åˆ°ç»“æ„ä½“ä¸­ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;fmt&quot;</span>    <span class="hljs-string">&quot;reflect&quot;</span>)<span class="hljs-comment">// æœåŠ¡å®¹å™¨</span><span class="hljs-keyword">type</span> Container <span class="hljs-keyword">struct</span> &#123;    services <span class="hljs-keyword">map</span>[reflect.Type]<span class="hljs-keyword">interface</span>&#123;&#125;&#125;<span class="hljs-comment">// åˆ›å»ºæ–°å®¹å™¨</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewContainer</span><span class="hljs-params">()</span> *<span class="hljs-title">Container</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;Container&#123;        services: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[reflect.Type]<span class="hljs-keyword">interface</span>&#123;&#125;),    &#125;&#125;<span class="hljs-comment">// æ³¨å†ŒæœåŠ¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Container)</span> <span class="hljs-title">Register</span><span class="hljs-params">(service <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;    t := reflect.TypeOf(service)    c.services[t] = service&#125;<span class="hljs-comment">// è§£ææœåŠ¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Container)</span> <span class="hljs-title">Resolve</span><span class="hljs-params">(t reflect.Type)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    <span class="hljs-keyword">return</span> c.services[t]&#125;<span class="hljs-comment">// æ³¨å…¥ä¾èµ–</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Container)</span> <span class="hljs-title">Inject</span><span class="hljs-params">(target <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;    v := reflect.ValueOf(target)        <span class="hljs-comment">// ç¡®ä¿targetæ˜¯æŒ‡é’ˆ</span>    <span class="hljs-keyword">if</span> v.Kind() != reflect.Ptr &#123;        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;ç›®æ ‡å¿…é¡»æ˜¯æŒ‡é’ˆ&quot;</span>)    &#125;        <span class="hljs-comment">// è·å–æŒ‡å‘çš„å…ƒç´ </span>    v = v.Elem()        <span class="hljs-comment">// ç¡®ä¿æ˜¯ç»“æ„ä½“</span>    <span class="hljs-keyword">if</span> v.Kind() != reflect.Struct &#123;        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;ç›®æ ‡å¿…é¡»æ˜¯ç»“æ„ä½“æŒ‡é’ˆ&quot;</span>)    &#125;        t := v.Type()        <span class="hljs-comment">// éå†æ‰€æœ‰å­—æ®µ</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; t.NumField(); i++ &#123;        field := t.Field(i)                <span class="hljs-comment">// æ£€æŸ¥injectæ ‡ç­¾</span>        <span class="hljs-keyword">if</span> _, ok := field.Tag.Lookup(<span class="hljs-string">&quot;inject&quot;</span>); !ok &#123;            <span class="hljs-keyword">continue</span>        &#125;                <span class="hljs-comment">// è·å–å­—æ®µç±»å‹</span>        fieldType := field.Type                <span class="hljs-comment">// ä»å®¹å™¨ä¸­è§£ææœåŠ¡</span>        service := c.Resolve(fieldType)        <span class="hljs-keyword">if</span> service == <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;æ— æ³•è§£æç±»å‹: %s&quot;</span>, fieldType)        &#125;                <span class="hljs-comment">// è®¾ç½®å­—æ®µå€¼</span>        fieldValue := v.Field(i)        <span class="hljs-keyword">if</span> !fieldValue.CanSet() &#123;            <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;æ— æ³•è®¾ç½®å­—æ®µ: %s&quot;</span>, field.Name)        &#125;                fieldValue.Set(reflect.ValueOf(service))    &#125;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// ç¤ºä¾‹æœåŠ¡</span><span class="hljs-keyword">type</span> Logger <span class="hljs-keyword">interface</span> &#123;    Log(message <span class="hljs-keyword">string</span>)&#125;<span class="hljs-keyword">type</span> ConsoleLogger <span class="hljs-keyword">struct</span>&#123;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *ConsoleLogger)</span> <span class="hljs-title">Log</span><span class="hljs-params">(message <span class="hljs-keyword">string</span>)</span></span> &#123;    fmt.Println(<span class="hljs-string">&quot;æ—¥å¿—:&quot;</span>, message)&#125;<span class="hljs-keyword">type</span> Database <span class="hljs-keyword">interface</span> &#123;    Query(sql <span class="hljs-keyword">string</span>) []<span class="hljs-keyword">string</span>&#125;<span class="hljs-keyword">type</span> MySQLDatabase <span class="hljs-keyword">struct</span>&#123;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(db *MySQLDatabase)</span> <span class="hljs-title">Query</span><span class="hljs-params">(sql <span class="hljs-keyword">string</span>)</span> []<span class="hljs-title">string</span></span> &#123;    <span class="hljs-keyword">return</span> []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;ç»“æœ1&quot;</span>, <span class="hljs-string">&quot;ç»“æœ2&quot;</span>&#125;&#125;<span class="hljs-comment">// ä½¿ç”¨æœåŠ¡çš„åº”ç”¨</span><span class="hljs-keyword">type</span> Application <span class="hljs-keyword">struct</span> &#123;    Logger   Logger   <span class="hljs-string">`inject:&quot;&quot;`</span>    Database Database <span class="hljs-string">`inject:&quot;&quot;`</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(app *Application)</span> <span class="hljs-title">Run</span><span class="hljs-params">()</span></span> &#123;    app.Logger.Log(<span class="hljs-string">&quot;åº”ç”¨å¯åŠ¨&quot;</span>)    results := app.Database.Query(<span class="hljs-string">&quot;SELECT * FROM users&quot;</span>)    app.Logger.Log(fmt.Sprintf(<span class="hljs-string">&quot;æŸ¥è¯¢ç»“æœ: %v&quot;</span>, results))&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºå®¹å™¨</span>    container := NewContainer()        <span class="hljs-comment">// æ³¨å†ŒæœåŠ¡</span>    container.Register((*Logger)(&amp;ConsoleLogger&#123;&#125;))    container.Register((*Database)(&amp;MySQLDatabase&#123;&#125;))        <span class="hljs-comment">// åˆ›å»ºåº”ç”¨</span>    app := &amp;Application&#123;&#125;        <span class="hljs-comment">// æ³¨å…¥ä¾èµ–</span>    <span class="hljs-keyword">if</span> err := container.Inject(app); err != <span class="hljs-literal">nil</span> &#123;        fmt.Printf(<span class="hljs-string">&quot;æ³¨å…¥é”™è¯¯: %s\n&quot;</span>, err)        <span class="hljs-keyword">return</span>    &#125;        <span class="hljs-comment">// è¿è¡Œåº”ç”¨</span>    app.Run()&#125;</code></pre><h3 id="âš ï¸-åå°„çš„æ³¨æ„äº‹é¡¹"><a class="header-anchor" href="#âš ï¸-åå°„çš„æ³¨æ„äº‹é¡¹"></a>âš ï¸ åå°„çš„æ³¨æ„äº‹é¡¹</h3><p>è™½ç„¶åå°„åŠŸèƒ½å¼ºå¤§ï¼Œä½†å®ƒä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼š</p><ol><li><strong>æ€§èƒ½å¼€é”€</strong>ï¼šåå°„æ“ä½œæ¯”ç›´æ¥ä»£ç è°ƒç”¨æ…¢å¾ˆå¤šï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥å’Œé—´æ¥è°ƒç”¨</li><li><strong>ä»£ç å¯è¯»æ€§</strong>ï¼šè¿‡åº¦ä½¿ç”¨åå°„ä¼šä½¿ä»£ç éš¾ä»¥ç†è§£å’Œç»´æŠ¤</li><li><strong>ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ä¸§å¤±</strong>ï¼šåå°„é”™è¯¯åªèƒ½åœ¨è¿è¡Œæ—¶å‘ç°ï¼Œæ— æ³•åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥</li><li><strong>å¯èƒ½å¯¼è‡´panic</strong>ï¼šä¸æ­£ç¡®çš„åå°„æ“ä½œå¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒ</li></ol><h3 id="ğŸ¯-åå°„çš„æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸ¯-åå°„çš„æœ€ä½³å®è·µ"></a>ğŸ¯ åå°„çš„æœ€ä½³å®è·µ</h3><ol><li><strong>é¿å…è¿‡åº¦ä½¿ç”¨</strong>ï¼šåªåœ¨çœŸæ­£éœ€è¦çš„åœ°æ–¹ä½¿ç”¨åå°„</li><li><strong>å°è£…åå°„ä»£ç </strong>ï¼šå°†åå°„ç›¸å…³çš„ä»£ç å°è£…åœ¨ä¸“é—¨çš„åŒ…æˆ–å‡½æ•°ä¸­</li><li><strong>æä¾›éåå°„çš„æ›¿ä»£æ–¹æ¡ˆ</strong>ï¼šä¸ºå¸¸è§ç”¨ä¾‹æä¾›ä¸ä½¿ç”¨åå°„çš„API</li><li><strong>å……åˆ†æµ‹è¯•</strong>ï¼šå¯¹ä½¿ç”¨åå°„çš„ä»£ç è¿›è¡Œå…¨é¢æµ‹è¯•ï¼ŒåŒ…æ‹¬è¾¹ç•Œæƒ…å†µ</li><li><strong>æ³¨æ„æ€§èƒ½</strong>ï¼šåœ¨æ€§èƒ½æ•æ„Ÿçš„ä»£ç è·¯å¾„ä¸Šé¿å…ä½¿ç”¨åå°„</li></ol><h3 id="ğŸ”-æ€»ç»“"><a class="header-anchor" href="#ğŸ”-æ€»ç»“"></a>ğŸ” æ€»ç»“</h3><p>Goè¯­è¨€çš„åå°„æœºåˆ¶æä¾›äº†åœ¨è¿è¡Œæ—¶æ£€æŸ¥å’Œæ“ä½œç±»å‹ã€å€¼çš„å¼ºå¤§èƒ½åŠ›ã€‚è™½ç„¶å®ƒä¸åº”è¯¥æˆä¸ºè§£å†³é—®é¢˜çš„é¦–é€‰æ–¹æ³•ï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹ï¼ˆå¦‚ORMã€åºåˆ—åŒ–ã€ä¾èµ–æ³¨å…¥ç­‰ï¼‰ï¼Œåå°„æ˜¯ä¸å¯æˆ–ç¼ºçš„å·¥å…·ã€‚ç†è§£åå°„çš„åŸç†å’Œæœ€ä½³å®è·µï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨é€‚å½“çš„æ—¶å€™åˆç†åœ°ä½¿ç”¨è¿™ä¸€å¼ºå¤§ç‰¹æ€§ã€‚</p><p>è®°ä½Rob Pikeçš„åè¨€ï¼šâ€œåå°„å°±åƒä¸€æŠŠé”‹åˆ©çš„åˆ€ï¼Œç”¨å¾—å¥½å¯ä»¥åˆ›é€ å¥‡è¿¹ï¼Œç”¨ä¸å¥½å¯èƒ½ä¼šä¼¤åˆ°è‡ªå·±ã€‚â€</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>åå°„</tag>
      
      <tag>å…ƒç¼–ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang æ·±å…¥ç†è§£syncåŒ…çš„å¹¶å‘åŸè¯­</title>
    <link href="/2024/05/05/golang-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3sync%E5%8C%85%E7%9A%84%E5%B9%B6%E5%8F%91%E5%8E%9F%E8%AF%AD/"/>
    <url>/2024/05/05/golang-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3sync%E5%8C%85%E7%9A%84%E5%B9%B6%E5%8F%91%E5%8E%9F%E8%AF%AD/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ”„-golang-æ·±å…¥ç†è§£syncåŒ…çš„å¹¶å‘åŸè¯­"><a class="header-anchor" href="#ğŸ”„-golang-æ·±å…¥ç†è§£syncåŒ…çš„å¹¶å‘åŸè¯­"></a>ğŸ”„ golang æ·±å…¥ç†è§£syncåŒ…çš„å¹¶å‘åŸè¯­</h2><p>Goè¯­è¨€çš„å¹¶å‘æ¨¡å‹ä»¥goroutineå’Œchannelä¸ºæ ¸å¿ƒï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æ›´åº•å±‚çš„å¹¶å‘åŸè¯­æ¥è§£å†³ç‰¹å®šé—®é¢˜ã€‚<code>sync</code>åŒ…æä¾›äº†è¿™äº›åŸºç¡€æ„å»ºå—ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿç²¾ç¡®æ§åˆ¶å¹¶å‘è¡Œä¸ºã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨<code>sync</code>åŒ…ä¸­çš„å„ç§å¹¶å‘åŸè¯­ï¼Œåˆ†æå…¶å†…éƒ¨å®ç°åŸç†ï¼Œå¹¶é€šè¿‡å®ä¾‹å±•ç¤ºå…¶æœ€ä½³å®è·µã€‚</p><h3 id="ğŸ“š-syncåŒ…æ¦‚è§ˆ"><a class="header-anchor" href="#ğŸ“š-syncåŒ…æ¦‚è§ˆ"></a>ğŸ“š syncåŒ…æ¦‚è§ˆ</h3><p><code>sync</code>åŒ…æä¾›äº†ä»¥ä¸‹æ ¸å¿ƒå¹¶å‘åŸè¯­ï¼š</p><ol><li><strong>Mutex</strong>ï¼šäº’æ–¥é”ï¼Œç”¨äºä¿æŠ¤å…±äº«èµ„æº</li><li><strong>RWMutex</strong>ï¼šè¯»å†™é”ï¼Œå…è®¸å¤šä¸ªè¯»æ“ä½œå¹¶å‘è¿›è¡Œ</li><li><strong>WaitGroup</strong>ï¼šç­‰å¾…ä¸€ç»„goroutineå®Œæˆ</li><li><strong>Once</strong>ï¼šç¡®ä¿æŸä¸ªæ“ä½œåªæ‰§è¡Œä¸€æ¬¡</li><li><strong>Cond</strong>ï¼šæ¡ä»¶å˜é‡ï¼Œç”¨äºgoroutineä¹‹é—´çš„é€šçŸ¥</li><li><strong>Pool</strong>ï¼šå¯¹è±¡æ± ï¼Œç”¨äºç¼“å­˜ä¸´æ—¶å¯¹è±¡</li><li><strong>Map</strong>ï¼šå¹¶å‘å®‰å…¨çš„map</li><li><strong>atomic</strong>ï¼šåŸå­æ“ä½œï¼ˆè™½ç„¶åœ¨<code>sync/atomic</code>åŒ…ä¸­ï¼‰</li></ol><p>è®©æˆ‘ä»¬é€ä¸€æ·±å…¥äº†è§£è¿™äº›å¹¶å‘åŸè¯­çš„å·¥ä½œåŸç†å’Œä½¿ç”¨åœºæ™¯ã€‚</p><h3 id="ğŸ”’-Mutexï¼šäº’æ–¥é”"><a class="header-anchor" href="#ğŸ”’-Mutexï¼šäº’æ–¥é”"></a>ğŸ”’ Mutexï¼šäº’æ–¥é”</h3><p><code>Mutex</code>ï¼ˆäº’æ–¥é”ï¼‰æ˜¯æœ€åŸºæœ¬çš„åŒæ­¥åŸè¯­ï¼Œç”¨äºä¿æŠ¤å…±äº«èµ„æºä¸è¢«å¹¶å‘è®¿é—®ã€‚</p><h4 id="åŸºæœ¬ç”¨æ³•"><a class="header-anchor" href="#åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h4><pre><code class="hljs go"><span class="hljs-keyword">var</span> mu sync.Mutex<span class="hljs-keyword">var</span> count <span class="hljs-keyword">int</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> &#123;    mu.Lock()    <span class="hljs-keyword">defer</span> mu.Unlock()    count++&#125;</code></pre><h4 id="å†…éƒ¨å®ç°åŸç†"><a class="header-anchor" href="#å†…éƒ¨å®ç°åŸç†"></a>å†…éƒ¨å®ç°åŸç†</h4><p>Go 1.9ä¹‹åï¼Œ<code>Mutex</code>é‡‡ç”¨äº†ä¸€ç§æ··åˆé”çš„å®ç°ï¼Œç»“åˆäº†è‡ªæ—‹é”å’Œé˜»å¡é”çš„ä¼˜ç‚¹ï¼š</p><ol><li><strong>å¿«è·¯å¾„</strong>ï¼šå¦‚æœé”æ²¡æœ‰ç«äº‰ï¼Œç›´æ¥è·å–é”</li><li><strong>æ…¢è·¯å¾„</strong>ï¼šå¦‚æœæœ‰ç«äº‰ï¼Œå…ˆå°è¯•è‡ªæ—‹ç­‰å¾…ï¼Œç„¶åå†é˜»å¡</li></ol><p><code>Mutex</code>çš„å†…éƒ¨ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Mutex <span class="hljs-keyword">struct</span> &#123;    state <span class="hljs-keyword">int32</span>  <span class="hljs-comment">// é”çš„çŠ¶æ€</span>    sema  <span class="hljs-keyword">uint32</span> <span class="hljs-comment">// ä¿¡å·é‡ï¼Œç”¨äºé˜»å¡/å”¤é†’goroutine</span>&#125;</code></pre><p>å…¶ä¸­<code>state</code>å­—æ®µåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li>é”æ˜¯å¦è¢«æŒæœ‰ï¼ˆæœ€ä½ä½ï¼‰</li><li>å”¤é†’æ ‡å¿—ï¼ˆç¬¬2ä½ï¼‰</li><li>ç­‰å¾…é˜Ÿåˆ—ä¸­çš„waiteræ•°é‡ï¼ˆå‰©ä½™ä½ï¼‰</li></ul><h4 id="æ€§èƒ½è€ƒé‡"><a class="header-anchor" href="#æ€§èƒ½è€ƒé‡"></a>æ€§èƒ½è€ƒé‡</h4><ol><li><strong>ä¸´ç•ŒåŒºå¤§å°</strong>ï¼šä¸´ç•ŒåŒºï¼ˆåŠ é”å’Œè§£é”ä¹‹é—´çš„ä»£ç ï¼‰åº”å°½å¯èƒ½å°</li><li><strong>é”ç²’åº¦</strong>ï¼šæ ¹æ®éœ€è¦é€‰æ‹©é€‚å½“çš„é”ç²’åº¦</li><li><strong>é”ç«äº‰</strong>ï¼šé¿å…é«˜é¢‘ç‡çš„é”ç«äº‰</li></ol><h4 id="å¸¸è§é™·é˜±"><a class="header-anchor" href="#å¸¸è§é™·é˜±"></a>å¸¸è§é™·é˜±</h4><ol><li><strong>æ­»é”</strong>ï¼šä¸¤ä¸ªæˆ–å¤šä¸ªgoroutineç›¸äº’ç­‰å¾…å¯¹æ–¹æŒæœ‰çš„é”</li><li><strong>å¿˜è®°è§£é”</strong>ï¼šå¯¼è‡´å…¶ä»–goroutineæ°¸è¿œç­‰å¾…</li><li><strong>é‡å¤è§£é”</strong>ï¼šä¼šå¯¼è‡´panic</li><li><strong>å¤åˆ¶åŒ…å«é”çš„ç»“æ„ä½“</strong>ï¼šé”çš„çŠ¶æ€ä¼šè¢«å¤åˆ¶ï¼Œå¯¼è‡´å¼‚å¸¸è¡Œä¸º</li></ol><pre><code class="hljs go"><span class="hljs-comment">// é”™è¯¯ç¤ºä¾‹ï¼šå¤åˆ¶åŒ…å«é”çš„ç»“æ„ä½“</span><span class="hljs-keyword">type</span> Counter <span class="hljs-keyword">struct</span> &#123;    mu    sync.Mutex    count <span class="hljs-keyword">int</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    c := Counter&#123;&#125;    c.mu.Lock()        <span class="hljs-comment">// å¤åˆ¶äº†é”çš„çŠ¶æ€</span>    c2 := c        <span class="hljs-comment">// è¿™é‡Œä¼šæ­»é”ï¼Œå› ä¸ºc2çš„é”å·²ç»è¢«é”å®šï¼ˆå¤åˆ¶è‡ªcï¼‰</span>    c2.mu.Lock()&#125;</code></pre><h3 id="ğŸ“–-RWMutexï¼šè¯»å†™é”"><a class="header-anchor" href="#ğŸ“–-RWMutexï¼šè¯»å†™é”"></a>ğŸ“– RWMutexï¼šè¯»å†™é”</h3><p><code>RWMutex</code>æ˜¯<code>Mutex</code>çš„ä¸€ä¸ªå˜ç§ï¼Œå®ƒå…è®¸å¤šä¸ªè¯»æ“ä½œå¹¶å‘è¿›è¡Œï¼Œä½†å†™æ“ä½œæ˜¯äº’æ–¥çš„ã€‚</p><h4 id="åŸºæœ¬ç”¨æ³•-2"><a class="header-anchor" href="#åŸºæœ¬ç”¨æ³•-2"></a>åŸºæœ¬ç”¨æ³•</h4><pre><code class="hljs go"><span class="hljs-keyword">var</span> rwmu sync.RWMutex<span class="hljs-keyword">var</span> data <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readData</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;    rwmu.RLock() <span class="hljs-comment">// è¯»é”</span>    <span class="hljs-keyword">defer</span> rwmu.RUnlock()    <span class="hljs-keyword">return</span> data[key]&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">writeData</span><span class="hljs-params">(key, value <span class="hljs-keyword">string</span>)</span></span> &#123;    rwmu.Lock() <span class="hljs-comment">// å†™é”</span>    <span class="hljs-keyword">defer</span> rwmu.Unlock()    data[key] = value&#125;</code></pre><h4 id="å†…éƒ¨å®ç°åŸç†-2"><a class="header-anchor" href="#å†…éƒ¨å®ç°åŸç†-2"></a>å†…éƒ¨å®ç°åŸç†</h4><p><code>RWMutex</code>å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª<code>Mutex</code>å’Œå¤šä¸ªè®¡æ•°å™¨ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> RWMutex <span class="hljs-keyword">struct</span> &#123;    w           Mutex  <span class="hljs-comment">// ç”¨äºå†™é”</span>    writerSem   <span class="hljs-keyword">uint32</span> <span class="hljs-comment">// å†™ç­‰å¾…ä¿¡å·é‡</span>    readerSem   <span class="hljs-keyword">uint32</span> <span class="hljs-comment">// è¯»ç­‰å¾…ä¿¡å·é‡</span>    readerCount <span class="hljs-keyword">int32</span>  <span class="hljs-comment">// è¯»é”è®¡æ•°å™¨</span>    readerWait  <span class="hljs-keyword">int32</span>  <span class="hljs-comment">// ç­‰å¾…é‡Šæ”¾çš„è¯»é”æ•°é‡</span>&#125;</code></pre><p>å·¥ä½œæµç¨‹ï¼š</p><ol><li>è·å–è¯»é”æ—¶ï¼Œ<code>readerCount</code>å¢åŠ </li><li>è·å–å†™é”æ—¶ï¼Œå…ˆè·å–å†…éƒ¨çš„<code>Mutex</code>ï¼Œç„¶åç­‰å¾…æ‰€æœ‰è¯»æ“ä½œå®Œæˆ</li><li>é‡Šæ”¾å†™é”æ—¶ï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…çš„è¯»æ“ä½œ</li></ol><h4 id="ä½¿ç”¨åœºæ™¯"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h4><p><code>RWMutex</code>é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚å¦‚æœè¯»å†™æ¯”ä¾‹æ¥è¿‘1:1ï¼Œæˆ–è€…ä¸´ç•ŒåŒºå¾ˆå°ï¼Œæ™®é€šçš„<code>Mutex</code>å¯èƒ½æ›´é«˜æ•ˆã€‚</p><h4 id="æ€§èƒ½æ¯”è¾ƒ"><a class="header-anchor" href="#æ€§èƒ½æ¯”è¾ƒ"></a>æ€§èƒ½æ¯”è¾ƒ</h4><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„åŸºå‡†æµ‹è¯•ï¼Œæ¯”è¾ƒåœ¨ä¸åŒè¯»å†™æ¯”ä¾‹ä¸‹<code>Mutex</code>å’Œ<code>RWMutex</code>çš„æ€§èƒ½ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkMutex</span><span class="hljs-params">(b *testing.B)</span></span> &#123;    <span class="hljs-keyword">var</span> mu sync.Mutex    b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pb *testing.PB)</span></span> &#123;        <span class="hljs-keyword">for</span> pb.Next() &#123;            mu.Lock()            <span class="hljs-comment">// ä¸´ç•ŒåŒº</span>            mu.Unlock()        &#125;    &#125;)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkRWMutex</span><span class="hljs-params">(b *testing.B)</span></span> &#123;    <span class="hljs-keyword">var</span> mu sync.RWMutex    b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pb *testing.PB)</span></span> &#123;        <span class="hljs-keyword">for</span> pb.Next() &#123;            <span class="hljs-comment">// 90%çš„æ¦‚ç‡æ‰§è¡Œè¯»æ“ä½œ</span>            <span class="hljs-keyword">if</span> rand.Intn(<span class="hljs-number">10</span>) != <span class="hljs-number">0</span> &#123;                mu.RLock()                <span class="hljs-comment">// è¯»ä¸´ç•ŒåŒº</span>                mu.RUnlock()            &#125; <span class="hljs-keyword">else</span> &#123;                mu.Lock()                <span class="hljs-comment">// å†™ä¸´ç•ŒåŒº</span>                mu.Unlock()            &#125;        &#125;    &#125;)&#125;</code></pre><p>åœ¨è¯»å¤šå†™å°‘ï¼ˆå¦‚90%è¯»ï¼Œ10%å†™ï¼‰çš„åœºæ™¯ä¸‹ï¼Œ<code>RWMutex</code>é€šå¸¸èƒ½æä¾›æ›´å¥½çš„æ€§èƒ½ã€‚</p><h3 id="â±ï¸-WaitGroupï¼šç­‰å¾…ç»„"><a class="header-anchor" href="#â±ï¸-WaitGroupï¼šç­‰å¾…ç»„"></a>â±ï¸ WaitGroupï¼šç­‰å¾…ç»„</h3><p><code>WaitGroup</code>ç”¨äºç­‰å¾…ä¸€ç»„goroutineå®Œæˆã€‚å½“ä½ æœ‰å¤šä¸ªå¹¶å‘ä»»åŠ¡ï¼Œéœ€è¦ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆåå†ç»§ç»­æ‰§è¡Œæ—¶ï¼Œ<code>WaitGroup</code>éå¸¸æœ‰ç”¨ã€‚</p><h4 id="åŸºæœ¬ç”¨æ³•-3"><a class="header-anchor" href="#åŸºæœ¬ç”¨æ³•-3"></a>åŸºæœ¬ç”¨æ³•</h4><pre><code class="hljs go"><span class="hljs-keyword">var</span> wg sync.WaitGroup<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker</span><span class="hljs-params">(id <span class="hljs-keyword">int</span>)</span></span> &#123;    <span class="hljs-keyword">defer</span> wg.Done() <span class="hljs-comment">// å®Œæˆæ—¶å‡å°‘è®¡æ•°å™¨</span>    fmt.Printf(<span class="hljs-string">&quot;Worker %d starting\n&quot;</span>, id)    time.Sleep(time.Second)    fmt.Printf(<span class="hljs-string">&quot;Worker %d done\n&quot;</span>, id)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">5</span>; i++ &#123;        wg.Add(<span class="hljs-number">1</span>) <span class="hljs-comment">// å¢åŠ è®¡æ•°å™¨</span>        <span class="hljs-keyword">go</span> worker(i)    &#125;        wg.Wait() <span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰workerå®Œæˆ</span>    fmt.Println(<span class="hljs-string">&quot;All workers done&quot;</span>)&#125;</code></pre><h4 id="å†…éƒ¨å®ç°åŸç†-3"><a class="header-anchor" href="#å†…éƒ¨å®ç°åŸç†-3"></a>å†…éƒ¨å®ç°åŸç†</h4><p><code>WaitGroup</code>å†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ªè®¡æ•°å™¨å’Œä¸€ä¸ªä¿¡å·é‡ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> WaitGroup <span class="hljs-keyword">struct</span> &#123;    noCopy noCopy    state1 [<span class="hljs-number">3</span>]<span class="hljs-keyword">uint32</span> <span class="hljs-comment">// åŒ…å«counterå’Œwaiteræ•°é‡</span>&#125;</code></pre><p>å…¶ä¸­<code>state1</code>åŒ…å«ï¼š</p><ul><li>è®¡æ•°å™¨ï¼šè®°å½•æœªå®Œæˆçš„ä»»åŠ¡æ•°</li><li>ç­‰å¾…è€…è®¡æ•°ï¼šè®°å½•è°ƒç”¨<code>Wait</code>çš„goroutineæ•°</li><li>ä¿¡å·é‡ï¼šç”¨äºé˜»å¡å’Œå”¤é†’ç­‰å¾…çš„goroutine</li></ul><h4 id="å¸¸è§é™·é˜±-2"><a class="header-anchor" href="#å¸¸è§é™·é˜±-2"></a>å¸¸è§é™·é˜±</h4><ol><li><strong>è®¡æ•°å™¨ä¸å¹³è¡¡</strong>ï¼š<code>Add</code>å’Œ<code>Done</code>è°ƒç”¨æ¬¡æ•°ä¸åŒ¹é…</li><li><strong>é‡ç”¨WaitGroup</strong>ï¼šåœ¨<code>Wait</code>è¿”å›åé‡ç”¨åŒä¸€ä¸ª<code>WaitGroup</code></li><li><strong>è´Ÿè®¡æ•°</strong>ï¼šè°ƒç”¨<code>Done</code>çš„æ¬¡æ•°è¶…è¿‡<code>Add</code></li></ol><pre><code class="hljs go"><span class="hljs-comment">// é”™è¯¯ç¤ºä¾‹ï¼šè®¡æ•°å™¨ä¸å¹³è¡¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-keyword">var</span> wg sync.WaitGroup    wg.Add(<span class="hljs-number">1</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-comment">// å¿˜è®°è°ƒç”¨wg.Done()</span>    &#125;()        <span class="hljs-comment">// è¿™é‡Œä¼šæ°¸è¿œé˜»å¡</span>    wg.Wait()&#125;</code></pre><h4 id="æœ€ä½³å®è·µ"><a class="header-anchor" href="#æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h4><ol><li>ç¡®ä¿<code>Add</code>åœ¨å¯åŠ¨goroutineä¹‹å‰è°ƒç”¨</li><li>ä½¿ç”¨<code>defer wg.Done()</code>ç¡®ä¿ä»»åŠ¡å®Œæˆæ—¶å‡å°‘è®¡æ•°å™¨</li><li>ä¸è¦åœ¨goroutineå†…éƒ¨è°ƒç”¨<code>Wait</code></li><li>ä¸è¦å¤åˆ¶<code>WaitGroup</code></li></ol><h3 id="ğŸ”„-Onceï¼šåªæ‰§è¡Œä¸€æ¬¡"><a class="header-anchor" href="#ğŸ”„-Onceï¼šåªæ‰§è¡Œä¸€æ¬¡"></a>ğŸ”„ Onceï¼šåªæ‰§è¡Œä¸€æ¬¡</h3><p><code>Once</code>ç¡®ä¿æŸä¸ªå‡½æ•°åªæ‰§è¡Œä¸€æ¬¡ï¼Œæ— è®ºæœ‰å¤šå°‘ä¸ªgoroutineå¹¶å‘è°ƒç”¨ã€‚</p><h4 id="åŸºæœ¬ç”¨æ³•-4"><a class="header-anchor" href="#åŸºæœ¬ç”¨æ³•-4"></a>åŸºæœ¬ç”¨æ³•</h4><pre><code class="hljs go"><span class="hljs-keyword">var</span> once sync.Once<span class="hljs-keyword">var</span> instance *Singleton<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetInstance</span><span class="hljs-params">()</span> *<span class="hljs-title">Singleton</span></span> &#123;    once.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        instance = &amp;Singleton&#123;&#125;    &#125;)    <span class="hljs-keyword">return</span> instance&#125;</code></pre><h4 id="å†…éƒ¨å®ç°åŸç†-4"><a class="header-anchor" href="#å†…éƒ¨å®ç°åŸç†-4"></a>å†…éƒ¨å®ç°åŸç†</h4><p><code>Once</code>å†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ª<code>Mutex</code>å’Œä¸€ä¸ª<code>done</code>æ ‡å¿—ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Once <span class="hljs-keyword">struct</span> &#123;    done <span class="hljs-keyword">uint32</span>    m    Mutex&#125;</code></pre><p>å·¥ä½œæµç¨‹ï¼š</p><ol><li>æ£€æŸ¥<code>done</code>æ ‡å¿—ï¼Œå¦‚æœå·²ç»æ‰§è¡Œè¿‡ï¼Œç›´æ¥è¿”å›</li><li>å¦åˆ™ï¼Œè·å–é”ï¼Œå†æ¬¡æ£€æŸ¥<code>done</code>æ ‡å¿—ï¼ˆåŒé‡æ£€æŸ¥ï¼‰</li><li>æ‰§è¡Œå‡½æ•°ï¼Œè®¾ç½®<code>done</code>æ ‡å¿—ï¼Œé‡Šæ”¾é”</li></ol><h4 id="ä½¿ç”¨åœºæ™¯-2"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-2"></a>ä½¿ç”¨åœºæ™¯</h4><ol><li><strong>å•ä¾‹æ¨¡å¼</strong>ï¼šç¡®ä¿åªåˆ›å»ºä¸€ä¸ªå®ä¾‹</li><li><strong>å»¶è¿Ÿåˆå§‹åŒ–</strong>ï¼šåªåœ¨éœ€è¦æ—¶åˆå§‹åŒ–èµ„æº</li><li><strong>ä¸€æ¬¡æ€§è®¾ç½®</strong>ï¼šåªæ‰§è¡Œä¸€æ¬¡çš„é…ç½®æˆ–åˆå§‹åŒ–ä»£ç </li></ol><h4 id="æ³¨æ„äº‹é¡¹"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h4><ol><li><code>Once</code>åªä¿è¯å‡½æ•°æ‰§è¡Œä¸€æ¬¡ï¼Œä¸ä¿è¯å¹¶å‘å®‰å…¨</li><li>å¦‚æœ<code>Do</code>ä¸­çš„å‡½æ•°panicï¼Œ<code>Once</code>ä¼šè®¤ä¸ºå‡½æ•°å·²æ‰§è¡Œ</li><li>ä¸è¦åœ¨<code>Do</code>ä¸­è°ƒç”¨åŒä¸€ä¸ª<code>Once</code>çš„<code>Do</code>æ–¹æ³•ï¼Œä¼šå¯¼è‡´æ­»é”</li></ol><h3 id="ğŸ””-Condï¼šæ¡ä»¶å˜é‡"><a class="header-anchor" href="#ğŸ””-Condï¼šæ¡ä»¶å˜é‡"></a>ğŸ”” Condï¼šæ¡ä»¶å˜é‡</h3><p><code>Cond</code>å®ç°äº†ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œå®ƒå…è®¸goroutineç­‰å¾…æˆ–å®£å¸ƒæŸä¸ªäº‹ä»¶çš„å‘ç”Ÿã€‚</p><h4 id="åŸºæœ¬ç”¨æ³•-5"><a class="header-anchor" href="#åŸºæœ¬ç”¨æ³•-5"></a>åŸºæœ¬ç”¨æ³•</h4><pre><code class="hljs go"><span class="hljs-keyword">var</span> mu sync.Mutex<span class="hljs-keyword">var</span> cond = sync.NewCond(&amp;mu)<span class="hljs-keyword">var</span> ready <span class="hljs-keyword">bool</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">consumer</span><span class="hljs-params">()</span></span> &#123;    mu.Lock()    <span class="hljs-keyword">for</span> !ready &#123;        cond.Wait() <span class="hljs-comment">// ç­‰å¾…ä¿¡å·ï¼ŒåŒæ—¶é‡Šæ”¾é”</span>    &#125;    <span class="hljs-comment">// ä½¿ç”¨å…±äº«æ•°æ®</span>    mu.Unlock()&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">producer</span><span class="hljs-params">()</span></span> &#123;    mu.Lock()    <span class="hljs-comment">// ä¿®æ”¹å…±äº«æ•°æ®</span>    ready = <span class="hljs-literal">true</span>    cond.Signal() <span class="hljs-comment">// æˆ– cond.Broadcast()</span>    mu.Unlock()&#125;</code></pre><h4 id="å†…éƒ¨å®ç°åŸç†-5"><a class="header-anchor" href="#å†…éƒ¨å®ç°åŸç†-5"></a>å†…éƒ¨å®ç°åŸç†</h4><p><code>Cond</code>å†…éƒ¨åŒ…å«ä¸€ä¸ª<code>Locker</code>ï¼ˆé€šå¸¸æ˜¯<code>Mutex</code>ï¼‰å’Œä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Cond <span class="hljs-keyword">struct</span> &#123;    noCopy noCopy    L Locker          <span class="hljs-comment">// ä¿æŠ¤å…±äº«æ•°æ®çš„é”</span>    notify  notifyList <span class="hljs-comment">// ç­‰å¾…é˜Ÿåˆ—</span>&#125;</code></pre><p>å·¥ä½œæµç¨‹ï¼š</p><ol><li><code>Wait</code>ï¼šé‡Šæ”¾é”ï¼Œå°†å½“å‰goroutineæ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œé˜»å¡ï¼Œè¢«å”¤é†’åé‡æ–°è·å–é”</li><li><code>Signal</code>ï¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªgoroutine</li><li><code>Broadcast</code>ï¼šå”¤é†’æ‰€æœ‰ç­‰å¾…çš„goroutine</li></ol><h4 id="Signal-vs-Broadcast"><a class="header-anchor" href="#Signal-vs-Broadcast"></a>Signal vs Broadcast</h4><ul><li><code>Signal</code>ï¼šå”¤é†’ä¸€ä¸ªç­‰å¾…çš„goroutineï¼Œé€‚ç”¨äºèµ„æºæœ‰é™çš„æƒ…å†µ</li><li><code>Broadcast</code>ï¼šå”¤é†’æ‰€æœ‰ç­‰å¾…çš„goroutineï¼Œé€‚ç”¨äºçŠ¶æ€å˜åŒ–éœ€è¦é€šçŸ¥æ‰€æœ‰ç­‰å¾…è€…çš„æƒ…å†µ</li></ul><h4 id="ä½¿ç”¨åœºæ™¯-3"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-3"></a>ä½¿ç”¨åœºæ™¯</h4><ol><li><strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼</strong>ï¼šæ¶ˆè´¹è€…ç­‰å¾…ç”Ÿäº§è€…äº§ç”Ÿæ•°æ®</li><li><strong>èµ„æºæ± </strong>ï¼šç­‰å¾…èµ„æºå¯ç”¨</li><li><strong>ä»»åŠ¡é˜Ÿåˆ—</strong>ï¼šç­‰å¾…æ–°ä»»åŠ¡æˆ–é˜Ÿåˆ—éç©º</li></ol><h4 id="å¸¸è§é™·é˜±-3"><a class="header-anchor" href="#å¸¸è§é™·é˜±-3"></a>å¸¸è§é™·é˜±</h4><ol><li><strong>å¿˜è®°æ£€æŸ¥æ¡ä»¶</strong>ï¼š<code>Wait</code>è¿”å›ä¸ä»£è¡¨æ¡ä»¶æ»¡è¶³ï¼Œéœ€è¦åœ¨å¾ªç¯ä¸­æ£€æŸ¥</li><li><strong>å¿˜è®°åŠ é”</strong>ï¼šè°ƒç”¨<code>Wait</code>ã€<code>Signal</code>æˆ–<code>Broadcast</code>å‰å¿…é¡»æŒæœ‰é”</li><li><strong>æ­»é”</strong>ï¼šå¦‚æœæ‰€æœ‰goroutineéƒ½åœ¨ç­‰å¾…ï¼Œæ²¡æœ‰goroutineå‘é€ä¿¡å·</li></ol><h3 id="ğŸŠ-Poolï¼šå¯¹è±¡æ± "><a class="header-anchor" href="#ğŸŠ-Poolï¼šå¯¹è±¡æ± "></a>ğŸŠ Poolï¼šå¯¹è±¡æ± </h3><p><code>Pool</code>ç”¨äºå­˜å‚¨å’Œå¤ç”¨ä¸´æ—¶å¯¹è±¡ï¼Œå‡å°‘å†…å­˜åˆ†é…å’ŒGCå‹åŠ›ã€‚</p><h4 id="åŸºæœ¬ç”¨æ³•-6"><a class="header-anchor" href="#åŸºæœ¬ç”¨æ³•-6"></a>åŸºæœ¬ç”¨æ³•</h4><pre><code class="hljs go"><span class="hljs-keyword">var</span> bufferPool = sync.Pool&#123;    New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;        <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(bytes.Buffer)    &#125;,&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processRequest</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// ä»æ± ä¸­è·å–å¯¹è±¡</span>    buf := bufferPool.Get().(*bytes.Buffer)    buf.Reset() <span class="hljs-comment">// é‡ç½®çŠ¶æ€</span>        <span class="hljs-comment">// ä½¿ç”¨bufå¤„ç†è¯·æ±‚</span>        <span class="hljs-comment">// å°†å¯¹è±¡æ”¾å›æ± ä¸­</span>    bufferPool.Put(buf)&#125;</code></pre><h4 id="å†…éƒ¨å®ç°åŸç†-6"><a class="header-anchor" href="#å†…éƒ¨å®ç°åŸç†-6"></a>å†…éƒ¨å®ç°åŸç†</h4><p><code>Pool</code>ä¸ºæ¯ä¸ªPï¼ˆå¤„ç†å™¨ï¼‰ç»´æŠ¤ä¸€ä¸ªæœ¬åœ°å¯¹è±¡æ± ï¼Œå‡å°‘å¹¶å‘è®¿é—®çš„ç«äº‰ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Pool <span class="hljs-keyword">struct</span> &#123;    noCopy noCopy    local     unsafe.Pointer <span class="hljs-comment">// local fixed-size per-P pool</span>    localSize <span class="hljs-keyword">uintptr</span>        <span class="hljs-comment">// size of the local array</span>    New <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">interface</span></span>&#123;&#125;   <span class="hljs-comment">// åˆ›å»ºæ–°å¯¹è±¡çš„å‡½æ•°</span>&#125;</code></pre><p>å·¥ä½œæµç¨‹ï¼š</p><ol><li><code>Get</code>ï¼šå…ˆä»å½“å‰Pçš„æœ¬åœ°æ± è·å–å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä»å…¶ä»–Pçš„æ± &quot;å·&quot;ä¸€ä¸ªï¼Œå¦‚æœè¿˜æ²¡æœ‰ï¼Œè°ƒç”¨<code>New</code>åˆ›å»º</li><li><code>Put</code>ï¼šå°†å¯¹è±¡æ”¾å…¥å½“å‰Pçš„æœ¬åœ°æ± </li></ol><h4 id="GCè¡Œä¸º"><a class="header-anchor" href="#GCè¡Œä¸º"></a>GCè¡Œä¸º</h4><p>æ¯æ¬¡GCæ—¶ï¼Œ<code>Pool</code>ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šè¢«æ¸…é™¤ã€‚è¿™æ„å‘³ç€ï¼š</p><ol><li><code>Pool</code>ä¸é€‚åˆç”¨ä½œç¼“å­˜ï¼Œå› ä¸ºå¯¹è±¡å¯èƒ½éšæ—¶è¢«GCå›æ”¶</li><li><code>Pool</code>ä¸»è¦ç”¨äºæš‚æ—¶å­˜å‚¨åœ¨åŒä¸€ä¸ªè¯·æ±‚å‘¨æœŸå†…å¤ç”¨çš„å¯¹è±¡</li></ol><h4 id="ä½¿ç”¨åœºæ™¯-4"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-4"></a>ä½¿ç”¨åœºæ™¯</h4><ol><li><strong>ä¸´æ—¶å¯¹è±¡</strong>ï¼šå¦‚<code>bytes.Buffer</code>ã€<code>[]byte</code>ç­‰</li><li><strong>é«˜å¹¶å‘è¯·æ±‚</strong>ï¼šæ¯ä¸ªè¯·æ±‚éœ€è¦ä¸´æ—¶å¯¹è±¡</li><li><strong>åå¤åˆ›å»ºå’Œé”€æ¯çš„å¯¹è±¡</strong>ï¼šå¦‚JSONç¼–è§£ç å™¨</li></ol><h4 id="æ€§èƒ½è€ƒé‡-2"><a class="header-anchor" href="#æ€§èƒ½è€ƒé‡-2"></a>æ€§èƒ½è€ƒé‡</h4><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨å’Œä¸ä½¿ç”¨<code>Pool</code>çš„æ€§èƒ½æ¯”è¾ƒï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkWithoutPool</span><span class="hljs-params">(b *testing.B)</span></span> &#123;    b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pb *testing.PB)</span></span> &#123;        <span class="hljs-keyword">for</span> pb.Next() &#123;            buf := <span class="hljs-built_in">new</span>(bytes.Buffer)            buf.WriteString(<span class="hljs-string">&quot;hello&quot;</span>)        &#125;    &#125;)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkWithPool</span><span class="hljs-params">(b *testing.B)</span></span> &#123;    pool := sync.Pool&#123;        New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;            <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(bytes.Buffer)        &#125;,    &#125;        b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pb *testing.PB)</span></span> &#123;        <span class="hljs-keyword">for</span> pb.Next() &#123;            buf := pool.Get().(*bytes.Buffer)            buf.Reset()            buf.WriteString(<span class="hljs-string">&quot;hello&quot;</span>)            pool.Put(buf)        &#125;    &#125;)&#125;</code></pre><p>åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä½¿ç”¨<code>Pool</code>å¯ä»¥æ˜¾è‘—å‡å°‘å†…å­˜åˆ†é…å’ŒGCå‹åŠ›ã€‚</p><h3 id="ğŸ—ºï¸-Mapï¼šå¹¶å‘å®‰å…¨çš„Map"><a class="header-anchor" href="#ğŸ—ºï¸-Mapï¼šå¹¶å‘å®‰å…¨çš„Map"></a>ğŸ—ºï¸ Mapï¼šå¹¶å‘å®‰å…¨çš„Map</h3><p><code>sync.Map</code>æ˜¯ä¸€ä¸ªå¹¶å‘å®‰å…¨çš„mapï¼Œä¸“ä¸ºç‰¹å®šåœºæ™¯è®¾è®¡ï¼Œå¦‚è¯»å¤šå†™å°‘æˆ–é”®çš„ç”Ÿå‘½å‘¨æœŸä¸mapç›¸åŒã€‚</p><h4 id="åŸºæœ¬ç”¨æ³•-7"><a class="header-anchor" href="#åŸºæœ¬ç”¨æ³•-7"></a>åŸºæœ¬ç”¨æ³•</h4><pre><code class="hljs go"><span class="hljs-keyword">var</span> m sync.Map<span class="hljs-comment">// å­˜å‚¨é”®å€¼å¯¹</span>m.Store(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>)<span class="hljs-comment">// åŠ è½½å€¼</span>value, ok := m.Load(<span class="hljs-string">&quot;key&quot;</span>)<span class="hljs-keyword">if</span> ok &#123;    fmt.Println(value.(<span class="hljs-keyword">string</span>))&#125;<span class="hljs-comment">// åŠ è½½æˆ–å­˜å‚¨</span>value, loaded := m.LoadOrStore(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;new value&quot;</span>)fmt.Println(value, loaded)<span class="hljs-comment">// åˆ é™¤é”®</span>m.Delete(<span class="hljs-string">&quot;key&quot;</span>)<span class="hljs-comment">// éå†</span>m.Range(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(key, value <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span> &#123;    fmt.Println(key, value)    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// ç»§ç»­éå†</span>&#125;)</code></pre><h4 id="å†…éƒ¨å®ç°åŸç†-7"><a class="header-anchor" href="#å†…éƒ¨å®ç°åŸç†-7"></a>å†…éƒ¨å®ç°åŸç†</h4><p><code>sync.Map</code>ä½¿ç”¨äº†ä¸¤ä¸ªå†…éƒ¨mapå’Œä¸€ä¸ªäº’æ–¥é”ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Map <span class="hljs-keyword">struct</span> &#123;    mu Mutex    read atomic.Value <span class="hljs-comment">// readOnlyç»“æ„ä½“ï¼ŒåŒ…å«åªè¯»map</span>    dirty <span class="hljs-keyword">map</span>[<span class="hljs-keyword">interface</span>&#123;&#125;]*entry <span class="hljs-comment">// åŒ…å«æœ€æ–°å†™å…¥çš„map</span>    misses <span class="hljs-keyword">int</span> <span class="hljs-comment">// ä»readä¸­æœªå‘½ä¸­çš„æ¬¡æ•°</span>&#125;</code></pre><p>å·¥ä½œæµç¨‹ï¼š</p><ol><li>è¯»æ“ä½œä¼˜å…ˆä»<code>read</code>mapè¯»å–ï¼Œæ— é”</li><li>å†™æ“ä½œéœ€è¦è·å–é”ï¼Œå†™å…¥<code>dirty</code> map</li><li>å½“<code>misses</code>è¾¾åˆ°é˜ˆå€¼ï¼Œå°†<code>dirty</code>æå‡ä¸º<code>read</code></li></ol><h4 id="ä½¿ç”¨åœºæ™¯-5"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-5"></a>ä½¿ç”¨åœºæ™¯</h4><p><code>sync.Map</code>é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š</p><ol><li><strong>è¯»å¤šå†™å°‘</strong>ï¼šå¤§éƒ¨åˆ†æ“ä½œæ˜¯è¯»å–</li><li><strong>é”®çš„ç”Ÿå‘½å‘¨æœŸé•¿</strong>ï¼šé”®ä¸€æ—¦åˆ›å»ºå¾ˆå°‘åˆ é™¤</li><li><strong>åªå¢ä¸å‡</strong>ï¼šä¸»è¦æ˜¯æ·»åŠ æ–°é”®ï¼Œå¾ˆå°‘åˆ é™¤</li></ol><h4 id="ä¸åŠ é”mapçš„æ¯”è¾ƒ"><a class="header-anchor" href="#ä¸åŠ é”mapçš„æ¯”è¾ƒ"></a>ä¸åŠ é”mapçš„æ¯”è¾ƒ</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkSyncMap</span><span class="hljs-params">(b *testing.B)</span></span> &#123;    <span class="hljs-keyword">var</span> m sync.Map    b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pb *testing.PB)</span></span> &#123;        <span class="hljs-keyword">for</span> pb.Next() &#123;            <span class="hljs-comment">// 90%è¯»ï¼Œ10%å†™</span>            <span class="hljs-keyword">if</span> rand.Intn(<span class="hljs-number">10</span>) != <span class="hljs-number">0</span> &#123;                m.Load(rand.Intn(<span class="hljs-number">100</span>))            &#125; <span class="hljs-keyword">else</span> &#123;                m.Store(rand.Intn(<span class="hljs-number">100</span>), <span class="hljs-number">1</span>)            &#125;        &#125;    &#125;)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkMutexMap</span><span class="hljs-params">(b *testing.B)</span></span> &#123;    <span class="hljs-keyword">var</span> mu sync.RWMutex    m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]<span class="hljs-keyword">int</span>)    b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pb *testing.PB)</span></span> &#123;        <span class="hljs-keyword">for</span> pb.Next() &#123;            <span class="hljs-comment">// 90%è¯»ï¼Œ10%å†™</span>            <span class="hljs-keyword">if</span> rand.Intn(<span class="hljs-number">10</span>) != <span class="hljs-number">0</span> &#123;                mu.RLock()                _ = m[rand.Intn(<span class="hljs-number">100</span>)]                mu.RUnlock()            &#125; <span class="hljs-keyword">else</span> &#123;                mu.Lock()                m[rand.Intn(<span class="hljs-number">100</span>)] = <span class="hljs-number">1</span>                mu.Unlock()            &#125;        &#125;    &#125;)&#125;</code></pre><p>åœ¨è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹ï¼Œ<code>sync.Map</code>é€šå¸¸æ¯”åŠ é”çš„mapæ€§èƒ½æ›´å¥½ã€‚ä½†å¦‚æœå†™æ“ä½œé¢‘ç¹æˆ–è€…æœ‰å¤§é‡çš„åˆ é™¤æ“ä½œï¼Œä¼ ç»Ÿçš„åŠ é”mapå¯èƒ½æ›´åˆé€‚ã€‚</p><h3 id="âš›ï¸-atomicï¼šåŸå­æ“ä½œ"><a class="header-anchor" href="#âš›ï¸-atomicï¼šåŸå­æ“ä½œ"></a>âš›ï¸ atomicï¼šåŸå­æ“ä½œ</h3><p><code>sync/atomic</code>åŒ…æä¾›äº†åº•å±‚çš„åŸå­æ“ä½œï¼Œç”¨äºåœ¨ä¸ä½¿ç”¨é”çš„æƒ…å†µä¸‹å®‰å…¨ä¿®æ”¹å…±äº«å˜é‡ã€‚</p><h4 id="åŸºæœ¬ç”¨æ³•-8"><a class="header-anchor" href="#åŸºæœ¬ç”¨æ³•-8"></a>åŸºæœ¬ç”¨æ³•</h4><pre><code class="hljs go"><span class="hljs-keyword">var</span> counter <span class="hljs-keyword">int64</span><span class="hljs-comment">// åŸå­åŠ æ³•</span>atomic.AddInt64(&amp;counter, <span class="hljs-number">1</span>)<span class="hljs-comment">// åŸå­åŠ è½½</span>value := atomic.LoadInt64(&amp;counter)<span class="hljs-comment">// åŸå­å­˜å‚¨</span>atomic.StoreInt64(&amp;counter, <span class="hljs-number">42</span>)<span class="hljs-comment">// åŸå­äº¤æ¢</span>old := atomic.SwapInt64(&amp;counter, <span class="hljs-number">100</span>)<span class="hljs-comment">// æ¯”è¾ƒå¹¶äº¤æ¢</span>swapped := atomic.CompareAndSwapInt64(&amp;counter, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>)</code></pre><h4 id="å†…éƒ¨å®ç°åŸç†-8"><a class="header-anchor" href="#å†…éƒ¨å®ç°åŸç†-8"></a>å†…éƒ¨å®ç°åŸç†</h4><p>åŸå­æ“ä½œé€šå¸¸æ˜ å°„åˆ°CPUçš„åŸå­æŒ‡ä»¤ï¼Œå¦‚LOCKå‰ç¼€æŒ‡ä»¤ï¼ˆx86ï¼‰æˆ–Load-Link/Store-Conditionalï¼ˆARMï¼‰ã€‚</p><h4 id="ä½¿ç”¨åœºæ™¯-6"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-6"></a>ä½¿ç”¨åœºæ™¯</h4><ol><li><strong>è®¡æ•°å™¨</strong>ï¼šå¦‚è¯·æ±‚è®¡æ•°ã€é”™è¯¯è®¡æ•°</li><li><strong>æ ‡å¿—ä½</strong>ï¼šå¦‚çŠ¶æ€æ ‡å¿—ã€å®Œæˆæ ‡å¿—</li><li><strong>æ— é”æ•°æ®ç»“æ„</strong>ï¼šå®ç°æ— é”é˜Ÿåˆ—ã€æ ˆç­‰</li></ol><h4 id="æ€§èƒ½æ¯”è¾ƒ-2"><a class="header-anchor" href="#æ€§èƒ½æ¯”è¾ƒ-2"></a>æ€§èƒ½æ¯”è¾ƒ</h4><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨åŸå­æ“ä½œå’Œäº’æ–¥é”çš„æ€§èƒ½æ¯”è¾ƒï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkAtomic</span><span class="hljs-params">(b *testing.B)</span></span> &#123;    <span class="hljs-keyword">var</span> counter <span class="hljs-keyword">int64</span>    b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pb *testing.PB)</span></span> &#123;        <span class="hljs-keyword">for</span> pb.Next() &#123;            atomic.AddInt64(&amp;counter, <span class="hljs-number">1</span>)        &#125;    &#125;)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkMutex</span><span class="hljs-params">(b *testing.B)</span></span> &#123;    <span class="hljs-keyword">var</span> counter <span class="hljs-keyword">int64</span>    <span class="hljs-keyword">var</span> mu sync.Mutex    b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pb *testing.PB)</span></span> &#123;        <span class="hljs-keyword">for</span> pb.Next() &#123;            mu.Lock()            counter++            mu.Unlock()        &#125;    &#125;)&#125;</code></pre><p>å¯¹äºç®€å•çš„è®¡æ•°å™¨æ“ä½œï¼ŒåŸå­æ“ä½œé€šå¸¸æ¯”äº’æ–¥é”å¿«å¾ˆå¤šã€‚</p><h3 id="ğŸ”„-atomic-Valueï¼šåŸå­å€¼"><a class="header-anchor" href="#ğŸ”„-atomic-Valueï¼šåŸå­å€¼"></a>ğŸ”„ atomic.Valueï¼šåŸå­å€¼</h3><p><code>atomic.Value</code>æä¾›äº†å¯¹ä»»æ„ç±»å‹çš„åŸå­åŠ è½½å’Œå­˜å‚¨æ“ä½œã€‚</p><h4 id="åŸºæœ¬ç”¨æ³•-9"><a class="header-anchor" href="#åŸºæœ¬ç”¨æ³•-9"></a>åŸºæœ¬ç”¨æ³•</h4><pre><code class="hljs go"><span class="hljs-keyword">var</span> config atomic.Value<span class="hljs-comment">// å­˜å‚¨é…ç½®</span>cfg := &amp;Config&#123;...&#125;config.Store(cfg)<span class="hljs-comment">// åŠ è½½é…ç½®</span>currentCfg := config.Load().(*Config)</code></pre><h4 id="å†…éƒ¨å®ç°åŸç†-9"><a class="header-anchor" href="#å†…éƒ¨å®ç°åŸç†-9"></a>å†…éƒ¨å®ç°åŸç†</h4><p><code>atomic.Value</code>å†…éƒ¨ä½¿ç”¨äº†<code>unsafe.Pointer</code>å’ŒCASæ“ä½œï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Value <span class="hljs-keyword">struct</span> &#123;    v <span class="hljs-keyword">interface</span>&#123;&#125;&#125;</code></pre><p>å­˜å‚¨æ“ä½œä½¿ç”¨CASç¡®ä¿åŸå­æ€§ï¼ŒåŠ è½½æ“ä½œä½¿ç”¨åŸå­åŠ è½½ã€‚</p><h4 id="ä½¿ç”¨åœºæ™¯-7"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-7"></a>ä½¿ç”¨åœºæ™¯</h4><ol><li><strong>é…ç½®æ›´æ–°</strong>ï¼šåŸå­æ›´æ–°é…ç½®ï¼Œè¯»å–ä¸éœ€è¦é”</li><li><strong>ç¼“å­˜</strong>ï¼šåŸå­æ›´æ–°ç¼“å­˜å†…å®¹</li><li><strong>å‘å¸ƒ-è®¢é˜…æ¨¡å¼</strong>ï¼šåŸå­æ›´æ–°æœ€æ–°å€¼</li></ol><h4 id="æ³¨æ„äº‹é¡¹-2"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹-2"></a>æ³¨æ„äº‹é¡¹</h4><ol><li>å­˜å‚¨çš„å€¼ç±»å‹å¿…é¡»ä¸€è‡´</li><li>ä¸èƒ½å­˜å‚¨nil</li><li>ä¸€æ—¦å­˜å‚¨äº†æŸç§ç±»å‹ï¼Œå°±ä¸èƒ½å­˜å‚¨å…¶ä»–ç±»å‹</li></ol><h3 id="ğŸ”’-syncåŒ…çš„æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸ”’-syncåŒ…çš„æœ€ä½³å®è·µ"></a>ğŸ”’ syncåŒ…çš„æœ€ä½³å®è·µ</h3><h4 id="é€‰æ‹©åˆé€‚çš„å¹¶å‘åŸè¯­"><a class="header-anchor" href="#é€‰æ‹©åˆé€‚çš„å¹¶å‘åŸè¯­"></a>é€‰æ‹©åˆé€‚çš„å¹¶å‘åŸè¯­</h4><table><thead><tr><th>åœºæ™¯</th><th>æ¨èçš„å¹¶å‘åŸè¯­</th></tr></thead><tbody><tr><td>ä¿æŠ¤å…±äº«èµ„æº</td><td>Mutex</td></tr><tr><td>è¯»å¤šå†™å°‘</td><td>RWMutex</td></tr><tr><td>ç­‰å¾…å¤šä¸ªgoroutine</td><td>WaitGroup</td></tr><tr><td>ä¸€æ¬¡æ€§åˆå§‹åŒ–</td><td>Once</td></tr><tr><td>æ¡ä»¶ç­‰å¾…</td><td>Cond</td></tr><tr><td>å¯¹è±¡å¤ç”¨</td><td>Pool</td></tr><tr><td>å¹¶å‘å®‰å…¨çš„map</td><td>sync.Mapï¼ˆç‰¹å®šåœºæ™¯ï¼‰</td></tr><tr><td>ç®€å•è®¡æ•°å™¨</td><td>atomic</td></tr><tr><td>åŸå­æ›´æ–°å¤æ‚å€¼</td><td>atomic.Value</td></tr></tbody></table><h4 id="æ€§èƒ½ä¼˜åŒ–æŠ€å·§"><a class="header-anchor" href="#æ€§èƒ½ä¼˜åŒ–æŠ€å·§"></a>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</h4><ol><li><strong>å‡å°‘é”çš„ç²’åº¦</strong>ï¼šåªé”å®šå¿…è¦çš„ä»£ç æ®µ</li><li><strong>åˆ†ç‰‡é”</strong>ï¼šå°†ä¸€ä¸ªå¤§é”åˆ†æˆå¤šä¸ªå°é”ï¼Œå‡å°‘ç«äº‰</li><li><strong>é¿å…åµŒå¥—é”</strong>ï¼šé˜²æ­¢æ­»é”</li><li><strong>ä¼˜å…ˆä½¿ç”¨åŸå­æ“ä½œ</strong>ï¼šé€‚ç”¨äºç®€å•æ“ä½œæ—¶</li><li><strong>ä½¿ç”¨è¯»å†™é”</strong>ï¼šè¯»å¤šå†™å°‘çš„åœºæ™¯</li><li><strong>æ‰¹å¤„ç†</strong>ï¼šå‡å°‘åŠ é”æ¬¡æ•°</li></ol><h4 id="å¸¸è§åæ¨¡å¼"><a class="header-anchor" href="#å¸¸è§åæ¨¡å¼"></a>å¸¸è§åæ¨¡å¼</h4><ol><li><strong>å¤åˆ¶åŒ…å«é”çš„ç»“æ„ä½“</strong></li><li><strong>å¿˜è®°è§£é”</strong></li><li><strong>åœ¨ä¸åŒgoroutineä¸­åŠ é”å’Œè§£é”</strong></li><li><strong>ä½¿ç”¨<code>defer</code>è§£é”åå†æ¬¡ä½¿ç”¨é”</strong></li><li><strong>å¿½ç•¥<code>WaitGroup</code>çš„å¹³è¡¡</strong></li><li><strong>åœ¨<code>sync.Pool</code>ä¸­å­˜å‚¨å¸¦çŠ¶æ€å¯¹è±¡è€Œä¸é‡ç½®</strong></li></ol><h3 id="ğŸ“ˆ-å®é™…æ¡ˆä¾‹åˆ†æ"><a class="header-anchor" href="#ğŸ“ˆ-å®é™…æ¡ˆä¾‹åˆ†æ"></a>ğŸ“ˆ å®é™…æ¡ˆä¾‹åˆ†æ</h3><h4 id="æ¡ˆä¾‹1ï¼šé«˜æ€§èƒ½è®¡æ•°å™¨"><a class="header-anchor" href="#æ¡ˆä¾‹1ï¼šé«˜æ€§èƒ½è®¡æ•°å™¨"></a>æ¡ˆä¾‹1ï¼šé«˜æ€§èƒ½è®¡æ•°å™¨</h4><pre><code class="hljs go"><span class="hljs-keyword">type</span> Counter <span class="hljs-keyword">struct</span> &#123;    value <span class="hljs-keyword">int64</span>&#125;<span class="hljs-comment">// ä½¿ç”¨åŸå­æ“ä½œçš„è®¡æ•°å™¨</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Counter)</span> <span class="hljs-title">Inc</span><span class="hljs-params">()</span></span> &#123;    atomic.AddInt64(&amp;c.value, <span class="hljs-number">1</span>)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Counter)</span> <span class="hljs-title">Value</span><span class="hljs-params">()</span> <span class="hljs-title">int64</span></span> &#123;    <span class="hljs-keyword">return</span> atomic.LoadInt64(&amp;c.value)&#125;</code></pre><h4 id="æ¡ˆä¾‹2ï¼šå¹¶å‘å®‰å…¨çš„é…ç½®ç®¡ç†"><a class="header-anchor" href="#æ¡ˆä¾‹2ï¼šå¹¶å‘å®‰å…¨çš„é…ç½®ç®¡ç†"></a>æ¡ˆä¾‹2ï¼šå¹¶å‘å®‰å…¨çš„é…ç½®ç®¡ç†</h4><pre><code class="hljs go"><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;    <span class="hljs-comment">// é…ç½®å­—æ®µ</span>    DatabaseURL <span class="hljs-keyword">string</span>    APIKeys     <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>    Timeout     time.Duration&#125;<span class="hljs-keyword">type</span> ConfigManager <span class="hljs-keyword">struct</span> &#123;    config atomic.Value&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConfigManager</span><span class="hljs-params">(initialConfig *Config)</span> *<span class="hljs-title">ConfigManager</span></span> &#123;    cm := &amp;ConfigManager&#123;&#125;    cm.config.Store(initialConfig)    <span class="hljs-keyword">return</span> cm&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cm *ConfigManager)</span> <span class="hljs-title">UpdateConfig</span><span class="hljs-params">(newConfig *Config)</span></span> &#123;    cm.config.Store(newConfig)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cm *ConfigManager)</span> <span class="hljs-title">GetConfig</span><span class="hljs-params">()</span> *<span class="hljs-title">Config</span></span> &#123;    <span class="hljs-keyword">return</span> cm.config.Load().(*Config)&#125;</code></pre><h4 id="æ¡ˆä¾‹3ï¼šé«˜æ•ˆçš„è¿æ¥æ± "><a class="header-anchor" href="#æ¡ˆä¾‹3ï¼šé«˜æ•ˆçš„è¿æ¥æ± "></a>æ¡ˆä¾‹3ï¼šé«˜æ•ˆçš„è¿æ¥æ± </h4><pre><code class="hljs go"><span class="hljs-keyword">type</span> Connection <span class="hljs-keyword">struct</span> &#123;    <span class="hljs-comment">// è¿æ¥ç›¸å…³å­—æ®µ</span>&#125;<span class="hljs-keyword">type</span> ConnectionPool <span class="hljs-keyword">struct</span> &#123;    mu    sync.Mutex    cond  *sync.Cond    conns []*Connection    count <span class="hljs-keyword">int</span> <span class="hljs-comment">// å½“å‰å¯ç”¨è¿æ¥æ•°</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConnectionPool</span><span class="hljs-params">(size <span class="hljs-keyword">int</span>)</span> *<span class="hljs-title">ConnectionPool</span></span> &#123;    cp := &amp;ConnectionPool&#123;        conns: <span class="hljs-built_in">make</span>([]*Connection, size),    &#125;    cp.cond = sync.NewCond(&amp;cp.mu)        <span class="hljs-comment">// åˆå§‹åŒ–è¿æ¥</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; size; i++ &#123;        cp.conns[i] = &amp;Connection&#123;&#125;        cp.count++    &#125;        <span class="hljs-keyword">return</span> cp&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cp *ConnectionPool)</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> *<span class="hljs-title">Connection</span></span> &#123;    cp.mu.Lock()    <span class="hljs-keyword">defer</span> cp.mu.Unlock()        <span class="hljs-comment">// ç­‰å¾…å¯ç”¨è¿æ¥</span>    <span class="hljs-keyword">for</span> cp.count == <span class="hljs-number">0</span> &#123;        cp.cond.Wait()    &#125;        cp.count--    conn := cp.conns[cp.count]    <span class="hljs-keyword">return</span> conn&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cp *ConnectionPool)</span> <span class="hljs-title">Put</span><span class="hljs-params">(conn *Connection)</span></span> &#123;    cp.mu.Lock()    <span class="hljs-keyword">defer</span> cp.mu.Unlock()        <span class="hljs-comment">// å½’è¿˜è¿æ¥</span>    cp.conns[cp.count] = conn    cp.count++        <span class="hljs-comment">// é€šçŸ¥ç­‰å¾…è€…</span>    cp.cond.Signal()&#125;</code></pre><h3 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h3><p>Goè¯­è¨€çš„<code>sync</code>åŒ…æä¾›äº†ä¸°å¯Œçš„å¹¶å‘åŸè¯­ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿç²¾ç¡®æ§åˆ¶å¹¶å‘è¡Œä¸ºã€‚æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†<code>sync</code>åŒ…ä¸­çš„å„ç§å¹¶å‘åŸè¯­ï¼ŒåŒ…æ‹¬å®ƒä»¬çš„å·¥ä½œåŸç†ã€ä½¿ç”¨åœºæ™¯å’Œæœ€ä½³å®è·µã€‚</p><p>å…³é”®è¦ç‚¹ï¼š</p><ol><li><strong>é€‰æ‹©åˆé€‚çš„å¹¶å‘åŸè¯­</strong>ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©æœ€åˆé€‚çš„å¹¶å‘æ§åˆ¶æœºåˆ¶</li><li><strong>ç†è§£å†…éƒ¨å®ç°</strong>ï¼šäº†è§£å†…éƒ¨å®ç°æœ‰åŠ©äºæ­£ç¡®ä½¿ç”¨å¹¶é¿å…é™·é˜±</li><li><strong>éµå¾ªæœ€ä½³å®è·µ</strong>ï¼šé¿å…å¸¸è§é”™è¯¯ï¼Œå¦‚æ­»é”ã€ç«æ€æ¡ä»¶ç­‰</li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šåˆç†ä½¿ç”¨å¹¶å‘åŸè¯­å¯ä»¥æ˜¾è‘—æé«˜ç¨‹åºæ€§èƒ½</li></ol><p>è™½ç„¶Goæ¨å´‡&quot;é€šè¿‡é€šä¿¡å…±äº«å†…å­˜ï¼Œè€Œä¸æ˜¯é€šè¿‡å…±äº«å†…å­˜é€šä¿¡&quot;çš„ç†å¿µï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œ<code>sync</code>åŒ…çš„å¹¶å‘åŸè¯­ä»ç„¶æ˜¯ä¸å¯æˆ–ç¼ºçš„å·¥å…·ã€‚æŒæ¡è¿™äº›å·¥å…·ï¼Œå°†å¸®åŠ©ä½ ç¼–å†™æ›´é«˜æ•ˆã€æ›´å¯é çš„å¹¶å‘ç¨‹åºã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>å¹¶å‘</tag>
      
      <tag>sync</tag>
      
      <tag>é”</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang å®ç°ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶</title>
    <link href="/2024/04/15/golang-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84RPC%E6%A1%86%E6%9E%B6/"/>
    <url>/2024/04/15/golang-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84RPC%E6%A1%86%E6%9E%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ”Œ-golang-å®ç°ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶"><a class="header-anchor" href="#ğŸ”Œ-golang-å®ç°ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶"></a>ğŸ”Œ golang å®ç°ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶</h2><p>è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸å¯æˆ–ç¼ºçš„é€šä¿¡æ–¹å¼ï¼Œå®ƒå…è®¸ä¸€ä¸ªç¨‹åºè°ƒç”¨å¦ä¸€ä¸ªåœ°å€ç©ºé—´ï¼ˆé€šå¸¸æ˜¯ç½‘ç»œä¸Šçš„å¦ä¸€å°æœºå™¨ï¼‰çš„è¿‡ç¨‹æˆ–å‡½æ•°ï¼Œå°±åƒè°ƒç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·ã€‚æœ¬æ–‡å°†å¸¦ä½ ä»é›¶å¼€å§‹å®ç°ä¸€ä¸ªç®€å•ä½†åŠŸèƒ½å®Œæ•´çš„Goè¯­è¨€RPCæ¡†æ¶ï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£RPCçš„å·¥ä½œåŸç†ã€‚</p><h3 id="ğŸ“š-RPCåŸºç¡€æ¦‚å¿µ"><a class="header-anchor" href="#ğŸ“š-RPCåŸºç¡€æ¦‚å¿µ"></a>ğŸ“š RPCåŸºç¡€æ¦‚å¿µ</h3><p>åœ¨å¼€å§‹å®ç°ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£RPCçš„åŸºæœ¬æ¦‚å¿µå’Œå·¥ä½œæµç¨‹ï¼š</p><ol><li><strong>å®¢æˆ·ç«¯å­˜æ ¹(Client Stub)</strong>ï¼šåœ¨å®¢æˆ·ç«¯å°è£…è¿œç¨‹è°ƒç”¨çš„ç»†èŠ‚ï¼Œä½¿è¿œç¨‹è°ƒç”¨çœ‹èµ·æ¥åƒæœ¬åœ°è°ƒç”¨</li><li><strong>æœåŠ¡ç«¯å­˜æ ¹(Server Stub)</strong>ï¼šæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè§£ç å‚æ•°ï¼Œè°ƒç”¨æœ¬åœ°æœåŠ¡ï¼Œç„¶åç¼–ç ç»“æœè¿”å›</li><li><strong>åºåˆ—åŒ–/ååºåˆ—åŒ–</strong>ï¼šå°†å‡½æ•°è°ƒç”¨çš„å‚æ•°å’Œè¿”å›å€¼åœ¨ç½‘ç»œä¸Šä¼ è¾“</li><li><strong>ç½‘ç»œä¼ è¾“</strong>ï¼šåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´ä¼ è¾“åºåˆ—åŒ–åçš„æ•°æ®</li></ol><p>ä¸€ä¸ªå…¸å‹çš„RPCè°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p><pre><code class="hljs clean">å®¢æˆ·ç«¯ -&gt; å®¢æˆ·ç«¯å­˜æ ¹ -&gt; åºåˆ—åŒ– -&gt; ç½‘ç»œä¼ è¾“ -&gt; æœåŠ¡ç«¯å­˜æ ¹ -&gt; ååºåˆ—åŒ– -&gt; æœåŠ¡æ‰§è¡Œ -&gt; åºåˆ—åŒ–ç»“æœ -&gt; ç½‘ç»œä¼ è¾“ -&gt; å®¢æˆ·ç«¯å­˜æ ¹ -&gt; ååºåˆ—åŒ– -&gt; å®¢æˆ·ç«¯</code></pre><h3 id="ğŸ¯-è®¾è®¡ç›®æ ‡"><a class="header-anchor" href="#ğŸ¯-è®¾è®¡ç›®æ ‡"></a>ğŸ¯ è®¾è®¡ç›®æ ‡</h3><p>æˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç®€å•ä½†åŠŸèƒ½å®Œæ•´çš„RPCæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p><ol><li>æ”¯æŒæ³¨å†Œå’Œè°ƒç”¨æœåŠ¡æ–¹æ³•</li><li>ä½¿ç”¨JSONä½œä¸ºåºåˆ—åŒ–æ ¼å¼</li><li>åŸºäºTCPçš„ç½‘ç»œä¼ è¾“</li><li>ç®€å•çš„é”™è¯¯å¤„ç†</li><li>æ”¯æŒå¹¶å‘è°ƒç”¨</li></ol><h3 id="ğŸ—ï¸-æ¡†æ¶ç»“æ„è®¾è®¡"><a class="header-anchor" href="#ğŸ—ï¸-æ¡†æ¶ç»“æ„è®¾è®¡"></a>ğŸ—ï¸ æ¡†æ¶ç»“æ„è®¾è®¡</h3><p>æˆ‘ä»¬çš„RPCæ¡†æ¶å°†åŒ…å«ä»¥ä¸‹ä¸»è¦ç»„ä»¶ï¼š</p><ol><li><strong>æœåŠ¡æ³¨å†Œä¸­å¿ƒ</strong>ï¼šç®¡ç†å¯ç”¨çš„æœåŠ¡å’Œæ–¹æ³•</li><li><strong>æœåŠ¡ç«¯</strong>ï¼šæ³¨å†ŒæœåŠ¡å¹¶å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚</li><li><strong>å®¢æˆ·ç«¯</strong>ï¼šå‘é€è¯·æ±‚å¹¶æ¥æ”¶å“åº”</li><li><strong>ç¼–è§£ç å™¨</strong>ï¼šè´Ÿè´£è¯·æ±‚å’Œå“åº”çš„åºåˆ—åŒ–/ååºåˆ—åŒ–</li><li><strong>ä¼ è¾“å±‚</strong>ï¼šå¤„ç†ç½‘ç»œé€šä¿¡</li></ol><h3 id="ğŸ’»-ä»£ç å®ç°"><a class="header-anchor" href="#ğŸ’»-ä»£ç å®ç°"></a>ğŸ’» ä»£ç å®ç°</h3><p>è®©æˆ‘ä»¬å¼€å§‹å®ç°è¿™ä¸ªç®€å•çš„RPCæ¡†æ¶ï¼Œæˆ‘ä»¬å°†å…¶å‘½åä¸º&quot;SimpleRPC&quot;ã€‚</p><h4 id="1-å®šä¹‰æ¶ˆæ¯ç»“æ„"><a class="header-anchor" href="#1-å®šä¹‰æ¶ˆæ¯ç»“æ„"></a>1. å®šä¹‰æ¶ˆæ¯ç»“æ„</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰RPCè¯·æ±‚å’Œå“åº”çš„æ¶ˆæ¯ç»“æ„ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> simplerpc<span class="hljs-keyword">import</span> (<span class="hljs-string">&quot;encoding/json&quot;</span><span class="hljs-string">&quot;errors&quot;</span><span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-string">&quot;io&quot;</span><span class="hljs-string">&quot;log&quot;</span><span class="hljs-string">&quot;net&quot;</span><span class="hljs-string">&quot;reflect&quot;</span><span class="hljs-string">&quot;strings&quot;</span><span class="hljs-string">&quot;sync&quot;</span><span class="hljs-string">&quot;unicode&quot;</span>)<span class="hljs-comment">// è¯·æ±‚ç»“æ„</span><span class="hljs-keyword">type</span> Request <span class="hljs-keyword">struct</span> &#123;ServiceMethod <span class="hljs-keyword">string</span>        <span class="hljs-string">`json:&quot;service_method&quot;`</span> <span class="hljs-comment">// æ ¼å¼: &quot;Service.Method&quot;</span>Args          <span class="hljs-keyword">interface</span>&#123;&#125;   <span class="hljs-string">`json:&quot;args&quot;`</span>           <span class="hljs-comment">// å‚æ•°</span>ReqID         <span class="hljs-keyword">uint64</span>        <span class="hljs-string">`json:&quot;req_id&quot;`</span>         <span class="hljs-comment">// è¯·æ±‚ID</span>&#125;<span class="hljs-comment">// å“åº”ç»“æ„</span><span class="hljs-keyword">type</span> Response <span class="hljs-keyword">struct</span> &#123;ServiceMethod <span class="hljs-keyword">string</span>      <span class="hljs-string">`json:&quot;service_method&quot;`</span> <span class="hljs-comment">// å¯¹åº”è¯·æ±‚çš„ServiceMethod</span>ReqID         <span class="hljs-keyword">uint64</span>      <span class="hljs-string">`json:&quot;req_id&quot;`</span>         <span class="hljs-comment">// å¯¹åº”è¯·æ±‚çš„ID</span>Error         <span class="hljs-keyword">string</span>      <span class="hljs-string">`json:&quot;error&quot;`</span>          <span class="hljs-comment">// é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœè°ƒç”¨æˆåŠŸåˆ™ä¸ºç©º</span>Result        <span class="hljs-keyword">interface</span>&#123;&#125; <span class="hljs-string">`json:&quot;result&quot;`</span>         <span class="hljs-comment">// è°ƒç”¨ç»“æœ</span>&#125;</code></pre><h4 id="2-å®ç°ç¼–è§£ç å™¨"><a class="header-anchor" href="#2-å®ç°ç¼–è§£ç å™¨"></a>2. å®ç°ç¼–è§£ç å™¨</h4><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸ªç®€å•çš„JSONç¼–è§£ç å™¨ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ç¼–è§£ç å™¨æ¥å£</span><span class="hljs-keyword">type</span> Codec <span class="hljs-keyword">interface</span> &#123;ReadRequest() (*Request, error)ReadResponse() (*Response, error)WriteRequest(*Request) errorWriteResponse(*Response) errorClose() error&#125;<span class="hljs-comment">// JSONç¼–è§£ç å™¨</span><span class="hljs-keyword">type</span> JSONCodec <span class="hljs-keyword">struct</span> &#123;conn io.ReadWriteCloserdec  *json.Decoderenc  *json.Encodermu   sync.Mutex&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewJSONCodec</span><span class="hljs-params">(conn io.ReadWriteCloser)</span> *<span class="hljs-title">JSONCodec</span></span> &#123;<span class="hljs-keyword">return</span> &amp;JSONCodec&#123;conn: conn,dec:  json.NewDecoder(conn),enc:  json.NewEncoder(conn),&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *JSONCodec)</span> <span class="hljs-title">ReadRequest</span><span class="hljs-params">()</span> <span class="hljs-params">(*Request, error)</span></span> &#123;<span class="hljs-keyword">var</span> req Request<span class="hljs-keyword">if</span> err := c.dec.Decode(&amp;req); err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err&#125;<span class="hljs-keyword">return</span> &amp;req, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *JSONCodec)</span> <span class="hljs-title">ReadResponse</span><span class="hljs-params">()</span> <span class="hljs-params">(*Response, error)</span></span> &#123;<span class="hljs-keyword">var</span> resp Response<span class="hljs-keyword">if</span> err := c.dec.Decode(&amp;resp); err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err&#125;<span class="hljs-keyword">return</span> &amp;resp, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *JSONCodec)</span> <span class="hljs-title">WriteRequest</span><span class="hljs-params">(req *Request)</span> <span class="hljs-title">error</span></span> &#123;c.mu.Lock()<span class="hljs-keyword">defer</span> c.mu.Unlock()<span class="hljs-keyword">return</span> c.enc.Encode(req)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *JSONCodec)</span> <span class="hljs-title">WriteResponse</span><span class="hljs-params">(resp *Response)</span> <span class="hljs-title">error</span></span> &#123;c.mu.Lock()<span class="hljs-keyword">defer</span> c.mu.Unlock()<span class="hljs-keyword">return</span> c.enc.Encode(resp)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *JSONCodec)</span> <span class="hljs-title">Close</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<span class="hljs-keyword">return</span> c.conn.Close()&#125;</code></pre><h4 id="3-æœåŠ¡æ³¨å†Œä¸æ–¹æ³•è°ƒç”¨"><a class="header-anchor" href="#3-æœåŠ¡æ³¨å†Œä¸æ–¹æ³•è°ƒç”¨"></a>3. æœåŠ¡æ³¨å†Œä¸æ–¹æ³•è°ƒç”¨</h4><p>ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å®ç°æœåŠ¡æ³¨å†Œå’Œæ–¹æ³•è°ƒç”¨çš„æ ¸å¿ƒé€»è¾‘ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æœåŠ¡ç±»å‹</span><span class="hljs-keyword">type</span> Service <span class="hljs-keyword">struct</span> &#123;name   <span class="hljs-keyword">string</span>                 <span class="hljs-comment">// æœåŠ¡åç§°</span>rcvr   reflect.Value          <span class="hljs-comment">// æ¥æ”¶è€…å¯¹è±¡</span>typ    reflect.Type           <span class="hljs-comment">// æ¥æ”¶è€…ç±»å‹</span>method <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*MethodType <span class="hljs-comment">// æ–¹æ³•é›†åˆ</span>&#125;<span class="hljs-comment">// æ–¹æ³•ç±»å‹</span><span class="hljs-keyword">type</span> MethodType <span class="hljs-keyword">struct</span> &#123;method    reflect.Method <span class="hljs-comment">// æ–¹æ³•æœ¬èº«</span>ArgType   reflect.Type   <span class="hljs-comment">// ç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹</span>ReplyType reflect.Type   <span class="hljs-comment">// ç¬¬äºŒä¸ªå‚æ•°ç±»å‹</span>&#125;<span class="hljs-comment">// æœåŠ¡æ³¨å†Œä¸­å¿ƒ</span><span class="hljs-keyword">type</span> Registry <span class="hljs-keyword">struct</span> &#123;mu       sync.RWMutexservices <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*Service&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewRegistry</span><span class="hljs-params">()</span> *<span class="hljs-title">Registry</span></span> &#123;<span class="hljs-keyword">return</span> &amp;Registry&#123;services: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*Service),&#125;&#125;<span class="hljs-comment">// æ³¨å†ŒæœåŠ¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Registry)</span> <span class="hljs-title">Register</span><span class="hljs-params">(rcvr <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;s := <span class="hljs-built_in">new</span>(Service)s.rcvr = reflect.ValueOf(rcvr)s.typ = reflect.TypeOf(rcvr)s.name = reflect.Indirect(s.rcvr).Type().Name()<span class="hljs-keyword">if</span> s.name == <span class="hljs-string">&quot;&quot;</span> &#123;<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;æ— æ³•è·å–æœåŠ¡åç§°&quot;</span>)&#125;s.method = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*MethodType)<span class="hljs-comment">// éå†æ–¹æ³•å¹¶æ³¨å†Œ</span><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; s.typ.NumMethod(); i++ &#123;method := s.typ.Method(i)mtype := method.Type<span class="hljs-comment">// æ–¹æ³•å¿…é¡»æ˜¯å¯¼å‡ºçš„</span><span class="hljs-keyword">if</span> method.PkgPath != <span class="hljs-string">&quot;&quot;</span> &#123;<span class="hljs-keyword">continue</span>&#125;<span class="hljs-comment">// æ–¹æ³•å¿…é¡»æœ‰ä¸‰ä¸ªå‚æ•°: receiver, args, *reply</span><span class="hljs-keyword">if</span> mtype.NumIn() != <span class="hljs-number">3</span> &#123;<span class="hljs-keyword">continue</span>&#125;<span class="hljs-comment">// ç¬¬äºŒä¸ªå‚æ•°å¿…é¡»æ˜¯å¯¼å‡ºçš„æˆ–å†…å»ºç±»å‹</span>argType := mtype.In(<span class="hljs-number">1</span>)<span class="hljs-keyword">if</span> !isExportedOrBuiltin(argType) &#123;<span class="hljs-keyword">continue</span>&#125;<span class="hljs-comment">// ç¬¬ä¸‰ä¸ªå‚æ•°å¿…é¡»æ˜¯æŒ‡é’ˆç±»å‹</span>replyType := mtype.In(<span class="hljs-number">2</span>)<span class="hljs-keyword">if</span> replyType.Kind() != reflect.Ptr &#123;<span class="hljs-keyword">continue</span>&#125;<span class="hljs-comment">// æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªerror</span><span class="hljs-keyword">if</span> mtype.NumOut() != <span class="hljs-number">1</span> &#123;<span class="hljs-keyword">continue</span>&#125;<span class="hljs-keyword">if</span> returnType := mtype.Out(<span class="hljs-number">0</span>); returnType != reflect.TypeOf((*error)(<span class="hljs-literal">nil</span>)).Elem() &#123;<span class="hljs-keyword">continue</span>&#125;s.method[method.Name] = &amp;MethodType&#123;method:    method,ArgType:   argType,ReplyType: replyType,&#125;&#125;<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(s.method) == <span class="hljs-number">0</span> &#123;<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;æœåŠ¡æ²¡æœ‰å¯ç”¨çš„RPCæ–¹æ³•&quot;</span>)&#125;r.mu.Lock()<span class="hljs-keyword">defer</span> r.mu.Unlock()r.services[s.name] = s<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// æŸ¥æ‰¾æœåŠ¡æ–¹æ³•</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Registry)</span> <span class="hljs-title">findMethod</span><span class="hljs-params">(serviceMethod <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(svc *Service, mtype *MethodType, err error)</span></span> &#123;r.mu.RLock()<span class="hljs-keyword">defer</span> r.mu.RUnlock()<span class="hljs-comment">// è§£ææœåŠ¡å’Œæ–¹æ³•å</span>parts := strings.Split(serviceMethod, <span class="hljs-string">&quot;.&quot;</span>)<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) != <span class="hljs-number">2</span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;æœåŠ¡æ–¹æ³•æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º &#x27;Service.Method&#x27;&quot;</span>)&#125;serviceName, methodName := parts[<span class="hljs-number">0</span>], parts[<span class="hljs-number">1</span>]<span class="hljs-comment">// æŸ¥æ‰¾æœåŠ¡</span>service, ok := r.services[serviceName]<span class="hljs-keyword">if</span> !ok &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;æœåŠ¡ %s ä¸å­˜åœ¨&quot;</span>, serviceName)&#125;<span class="hljs-comment">// æŸ¥æ‰¾æ–¹æ³•</span>method, ok := service.method[methodName]<span class="hljs-keyword">if</span> !ok &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;æ–¹æ³• %s åœ¨æœåŠ¡ %s ä¸­ä¸å­˜åœ¨&quot;</span>, methodName, serviceName)&#125;<span class="hljs-keyword">return</span> service, method, <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// è°ƒç”¨æœåŠ¡æ–¹æ³•</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Registry)</span> <span class="hljs-title">call</span><span class="hljs-params">(serviceMethod <span class="hljs-keyword">string</span>, args <span class="hljs-keyword">interface</span>&#123;&#125;, reply <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;service, mtype, err := r.findMethod(serviceMethod)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span> err&#125;<span class="hljs-comment">// å°†å‚æ•°è½¬æ¢ä¸ºæ­£ç¡®çš„ç±»å‹</span>argValue := reflect.ValueOf(args)<span class="hljs-keyword">if</span> argValue.Type() != mtype.ArgType &#123;<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;å‚æ•°ç±»å‹ä¸åŒ¹é…: %v vs %v&quot;</span>, argValue.Type(), mtype.ArgType)&#125;replyValue := reflect.ValueOf(reply)<span class="hljs-keyword">if</span> replyValue.Type() != mtype.ReplyType &#123;<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;å›å¤ç±»å‹ä¸åŒ¹é…: %v vs %v&quot;</span>, replyValue.Type(), mtype.ReplyType)&#125;<span class="hljs-comment">// è°ƒç”¨æ–¹æ³•</span>function := mtype.method.FuncreturnValues := function.Call([]reflect.Value&#123;service.rcvr,argValue,replyValue,&#125;)<span class="hljs-comment">// å¤„ç†é”™è¯¯</span>errInter := returnValues[<span class="hljs-number">0</span>].Interface()<span class="hljs-keyword">if</span> errInter != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span> errInter.(error)&#125;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// åˆ¤æ–­ç±»å‹æ˜¯å¦ä¸ºå¯¼å‡ºæˆ–å†…å»ºç±»å‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isExportedOrBuiltin</span><span class="hljs-params">(t reflect.Type)</span> <span class="hljs-title">bool</span></span> &#123;<span class="hljs-keyword">if</span> t.Kind() == reflect.Ptr &#123;t = t.Elem()&#125;<span class="hljs-comment">// å†…å»ºç±»å‹</span><span class="hljs-keyword">if</span> t.PkgPath() == <span class="hljs-string">&quot;&quot;</span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>&#125;<span class="hljs-comment">// å¯¼å‡ºç±»å‹</span><span class="hljs-keyword">return</span> t.Name() != <span class="hljs-string">&quot;&quot;</span> &amp;&amp; unicode.IsUpper(<span class="hljs-keyword">rune</span>(t.Name()[<span class="hljs-number">0</span>]))&#125;</code></pre><h4 id="4-å®ç°æœåŠ¡ç«¯"><a class="header-anchor" href="#4-å®ç°æœåŠ¡ç«¯"></a>4. å®ç°æœåŠ¡ç«¯</h4><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®ç°RPCæœåŠ¡ç«¯ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æœåŠ¡ç«¯</span><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;registry *Registrymu       sync.Mutexseq      <span class="hljs-keyword">uint64</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span><span class="hljs-params">()</span> *<span class="hljs-title">Server</span></span> &#123;<span class="hljs-keyword">return</span> &amp;Server&#123;registry: NewRegistry(),&#125;&#125;<span class="hljs-comment">// æ³¨å†ŒæœåŠ¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span> <span class="hljs-title">Register</span><span class="hljs-params">(rcvr <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<span class="hljs-keyword">return</span> s.registry.Register(rcvr)&#125;<span class="hljs-comment">// å¯åŠ¨æœåŠ¡ç›‘å¬</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span> <span class="hljs-title">Listen</span><span class="hljs-params">(network, address <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;listener, err := net.Listen(network, address)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span> err&#125;<span class="hljs-keyword">defer</span> listener.Close()log.Printf(<span class="hljs-string">&quot;RPCæœåŠ¡å™¨ç›‘å¬åœ¨ %s\n&quot;</span>, address)<span class="hljs-keyword">for</span> &#123;conn, err := listener.Accept()<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;log.Printf(<span class="hljs-string">&quot;æ¥å—è¿æ¥é”™è¯¯: %v\n&quot;</span>, err)<span class="hljs-keyword">continue</span>&#125;<span class="hljs-keyword">go</span> s.handleConnection(conn)&#125;&#125;<span class="hljs-comment">// å¤„ç†è¿æ¥</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span> <span class="hljs-title">handleConnection</span><span class="hljs-params">(conn net.Conn)</span></span> &#123;<span class="hljs-keyword">defer</span> conn.Close()codec := NewJSONCodec(conn)<span class="hljs-keyword">defer</span> codec.Close()<span class="hljs-keyword">for</span> &#123;req, err := codec.ReadRequest()<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">if</span> err != io.EOF &#123;log.Printf(<span class="hljs-string">&quot;è¯»å–è¯·æ±‚é”™è¯¯: %v\n&quot;</span>, err)&#125;<span class="hljs-keyword">break</span>&#125;<span class="hljs-keyword">go</span> s.handleRequest(codec, req)&#125;&#125;<span class="hljs-comment">// å¤„ç†è¯·æ±‚</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span> <span class="hljs-title">handleRequest</span><span class="hljs-params">(codec *JSONCodec, req *Request)</span></span> &#123;resp := &amp;Response&#123;ServiceMethod: req.ServiceMethod,ReqID:         req.ReqID,&#125;<span class="hljs-comment">// åˆ›å»ºå‚æ•°å’Œå›å¤å€¼</span>service, mtype, err := s.registry.findMethod(req.ServiceMethod)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;resp.Error = err.Error()codec.WriteResponse(resp)<span class="hljs-keyword">return</span>&#125;<span class="hljs-comment">// åˆ›å»ºå‚æ•°å®ä¾‹</span>argv := reflect.New(mtype.ArgType)<span class="hljs-comment">// å°†è¯·æ±‚å‚æ•°è§£ç åˆ°argv</span><span class="hljs-keyword">if</span> req.Args != <span class="hljs-literal">nil</span> &#123;argBytes, err := json.Marshal(req.Args)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;resp.Error = fmt.Sprintf(<span class="hljs-string">&quot;å‚æ•°ç¼–ç é”™è¯¯: %v&quot;</span>, err)codec.WriteResponse(resp)<span class="hljs-keyword">return</span>&#125;<span class="hljs-keyword">if</span> err := json.Unmarshal(argBytes, argv.Interface()); err != <span class="hljs-literal">nil</span> &#123;resp.Error = fmt.Sprintf(<span class="hljs-string">&quot;å‚æ•°è§£ç é”™è¯¯: %v&quot;</span>, err)codec.WriteResponse(resp)<span class="hljs-keyword">return</span>&#125;&#125;<span class="hljs-comment">// åˆ›å»ºå›å¤å®ä¾‹</span>replyv := reflect.New(mtype.ReplyType.Elem())<span class="hljs-comment">// è°ƒç”¨æœåŠ¡æ–¹æ³•</span>function := mtype.method.FuncreturnValues := function.Call([]reflect.Value&#123;service.rcvr,argv.Elem(),replyv,&#125;)<span class="hljs-comment">// å¤„ç†é”™è¯¯</span>errInter := returnValues[<span class="hljs-number">0</span>].Interface()<span class="hljs-keyword">if</span> errInter != <span class="hljs-literal">nil</span> &#123;resp.Error = errInter.(error).Error()&#125; <span class="hljs-keyword">else</span> &#123;resp.Result = replyv.Interface()&#125;<span class="hljs-comment">// å‘é€å“åº”</span><span class="hljs-keyword">if</span> err := codec.WriteResponse(resp); err != <span class="hljs-literal">nil</span> &#123;log.Printf(<span class="hljs-string">&quot;å†™å…¥å“åº”é”™è¯¯: %v\n&quot;</span>, err)&#125;&#125;</code></pre><h4 id="5-å®ç°å®¢æˆ·ç«¯"><a class="header-anchor" href="#5-å®ç°å®¢æˆ·ç«¯"></a>5. å®ç°å®¢æˆ·ç«¯</h4><p>æœ€åï¼Œæˆ‘ä»¬å®ç°RPCå®¢æˆ·ç«¯ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// å®¢æˆ·ç«¯</span><span class="hljs-keyword">type</span> Client <span class="hljs-keyword">struct</span> &#123;codec  Codecmu     sync.Mutexseq    <span class="hljs-keyword">uint64</span>pending <span class="hljs-keyword">map</span>[<span class="hljs-keyword">uint64</span>]*Call&#125;<span class="hljs-comment">// è°ƒç”¨ç»“æ„</span><span class="hljs-keyword">type</span> Call <span class="hljs-keyword">struct</span> &#123;ServiceMethod <span class="hljs-keyword">string</span>      <span class="hljs-comment">// æ ¼å¼: &quot;Service.Method&quot;</span>Args          <span class="hljs-keyword">interface</span>&#123;&#125; <span class="hljs-comment">// å‚æ•°</span>Reply         <span class="hljs-keyword">interface</span>&#123;&#125; <span class="hljs-comment">// å›å¤</span>Error         error       <span class="hljs-comment">// é”™è¯¯</span>Done          <span class="hljs-keyword">chan</span> *Call  <span class="hljs-comment">// è°ƒç”¨å®Œæˆæ—¶çš„ä¿¡å·</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(call *Call)</span> <span class="hljs-title">done</span><span class="hljs-params">()</span></span> &#123;call.Done &lt;- call&#125;<span class="hljs-comment">// åˆ›å»ºæ–°å®¢æˆ·ç«¯</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewClient</span><span class="hljs-params">(conn io.ReadWriteCloser)</span> *<span class="hljs-title">Client</span></span> &#123;client := &amp;Client&#123;codec:   NewJSONCodec(conn),pending: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">uint64</span>]*Call),&#125;<span class="hljs-keyword">go</span> client.receiveResponse()<span class="hljs-keyword">return</span> client&#125;<span class="hljs-comment">// è¿æ¥åˆ°RPCæœåŠ¡å™¨</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Dial</span><span class="hljs-params">(network, address <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Client, error)</span></span> &#123;conn, err := net.Dial(network, address)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err&#125;<span class="hljs-keyword">return</span> NewClient(conn), <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// æ¥æ”¶å“åº”</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span> <span class="hljs-title">receiveResponse</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">for</span> &#123;resp, err := c.codec.ReadResponse()<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">if</span> err != io.EOF &#123;log.Printf(<span class="hljs-string">&quot;è¯»å–å“åº”é”™è¯¯: %v\n&quot;</span>, err)&#125;<span class="hljs-keyword">break</span>&#125;c.mu.Lock()call, ok := c.pending[resp.ReqID]<span class="hljs-built_in">delete</span>(c.pending, resp.ReqID)c.mu.Unlock()<span class="hljs-keyword">if</span> !ok &#123;log.Printf(<span class="hljs-string">&quot;æ‰¾ä¸åˆ°è¯·æ±‚ID: %d\n&quot;</span>, resp.ReqID)<span class="hljs-keyword">continue</span>&#125;<span class="hljs-keyword">if</span> resp.Error != <span class="hljs-string">&quot;&quot;</span> &#123;call.Error = errors.New(resp.Error)&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> resp.Result != <span class="hljs-literal">nil</span> &#123;<span class="hljs-comment">// å°†ç»“æœè§£ç åˆ°reply</span>resultBytes, err := json.Marshal(resp.Result)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;call.Error = fmt.Errorf(<span class="hljs-string">&quot;ç»“æœç¼–ç é”™è¯¯: %v&quot;</span>, err)&#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-keyword">if</span> err := json.Unmarshal(resultBytes, call.Reply); err != <span class="hljs-literal">nil</span> &#123;call.Error = fmt.Errorf(<span class="hljs-string">&quot;ç»“æœè§£ç é”™è¯¯: %v&quot;</span>, err)&#125;&#125;&#125;call.done()&#125;<span class="hljs-comment">// å…³é—­è¿æ¥æ—¶ï¼Œå°†æ‰€æœ‰æŒ‚èµ·çš„è°ƒç”¨æ ‡è®°ä¸ºå¤±è´¥</span>c.mu.Lock()<span class="hljs-keyword">for</span> _, call := <span class="hljs-keyword">range</span> c.pending &#123;call.Error = errors.New(<span class="hljs-string">&quot;è¿æ¥å·²å…³é—­&quot;</span>)call.done()&#125;c.mu.Unlock()&#125;<span class="hljs-comment">// å‘é€è¯·æ±‚</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span> <span class="hljs-title">send</span><span class="hljs-params">(call *Call)</span></span> &#123;c.mu.Lock()<span class="hljs-keyword">defer</span> c.mu.Unlock()<span class="hljs-comment">// åˆ†é…è¯·æ±‚ID</span>c.seq++reqID := c.seq<span class="hljs-comment">// æ³¨å†Œè°ƒç”¨</span>c.pending[reqID] = call<span class="hljs-comment">// åˆ›å»ºå¹¶å‘é€è¯·æ±‚</span>req := &amp;Request&#123;ServiceMethod: call.ServiceMethod,Args:          call.Args,ReqID:         reqID,&#125;<span class="hljs-keyword">if</span> err := c.codec.WriteRequest(req); err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-built_in">delete</span>(c.pending, reqID)call.Error = errcall.done()&#125;&#125;<span class="hljs-comment">// è°ƒç”¨æœåŠ¡æ–¹æ³•</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span> <span class="hljs-title">Call</span><span class="hljs-params">(serviceMethod <span class="hljs-keyword">string</span>, args <span class="hljs-keyword">interface</span>&#123;&#125;, reply <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;call := &amp;Call&#123;ServiceMethod: serviceMethod,Args:          args,Reply:         reply,Done:          <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Call, <span class="hljs-number">1</span>),&#125;c.send(call)<span class="hljs-comment">// ç­‰å¾…è°ƒç”¨å®Œæˆ</span>&lt;-call.Done<span class="hljs-keyword">return</span> call.Error&#125;<span class="hljs-comment">// å¼‚æ­¥è°ƒç”¨æœåŠ¡æ–¹æ³•</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span> <span class="hljs-title">Go</span><span class="hljs-params">(serviceMethod <span class="hljs-keyword">string</span>, args <span class="hljs-keyword">interface</span>&#123;&#125;, reply <span class="hljs-keyword">interface</span>&#123;&#125;)</span> *<span class="hljs-title">Call</span></span> &#123;call := &amp;Call&#123;ServiceMethod: serviceMethod,Args:          args,Reply:         reply,Done:          <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Call, <span class="hljs-number">1</span>),&#125;c.send(call)<span class="hljs-keyword">return</span> call&#125;<span class="hljs-comment">// å…³é—­å®¢æˆ·ç«¯</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span> <span class="hljs-title">Close</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<span class="hljs-keyword">return</span> c.codec.Close()&#125;</code></pre><h3 id="ğŸ§ª-ä½¿ç”¨ç¤ºä¾‹"><a class="header-anchor" href="#ğŸ§ª-ä½¿ç”¨ç¤ºä¾‹"></a>ğŸ§ª ä½¿ç”¨ç¤ºä¾‹</h3><p>ç°åœ¨æˆ‘ä»¬å·²ç»å®ç°äº†ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨å®ƒï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (<span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-string">&quot;log&quot;</span><span class="hljs-string">&quot;simplerpc&quot;</span><span class="hljs-string">&quot;time&quot;</span>)<span class="hljs-comment">// ç®—æœ¯æœåŠ¡</span><span class="hljs-keyword">type</span> Arith <span class="hljs-keyword">struct</span>&#123;&#125;<span class="hljs-comment">// ä¹˜æ³•æ–¹æ³•</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Arith)</span> <span class="hljs-title">Multiply</span><span class="hljs-params">(args Args, reply *<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">error</span></span> &#123;*reply = args.A * args.B<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// é™¤æ³•æ–¹æ³•</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Arith)</span> <span class="hljs-title">Divide</span><span class="hljs-params">(args Args, reply *Quotient)</span> <span class="hljs-title">error</span></span> &#123;<span class="hljs-keyword">if</span> args.B == <span class="hljs-number">0</span> &#123;<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;é™¤æ•°ä¸èƒ½ä¸ºé›¶&quot;</span>)&#125;reply.Quo = args.A / args.Breply.Rem = args.A % args.B<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// å‚æ•°ç»“æ„</span><span class="hljs-keyword">type</span> Args <span class="hljs-keyword">struct</span> &#123;A, B <span class="hljs-keyword">int</span>&#125;<span class="hljs-comment">// å•†å’Œä½™æ•°</span><span class="hljs-keyword">type</span> Quotient <span class="hljs-keyword">struct</span> &#123;Quo, Rem <span class="hljs-keyword">int</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-comment">// å¯åŠ¨æœåŠ¡å™¨</span><span class="hljs-keyword">go</span> startServer()<span class="hljs-comment">// ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨</span>time.Sleep(<span class="hljs-number">1</span> * time.Second)<span class="hljs-comment">// åˆ›å»ºå®¢æˆ·ç«¯</span>client, err := simplerpc.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;localhost:1234&quot;</span>)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;log.Fatal(<span class="hljs-string">&quot;è¿æ¥æœåŠ¡å™¨å¤±è´¥:&quot;</span>, err)&#125;<span class="hljs-keyword">defer</span> client.Close()<span class="hljs-comment">// åŒæ­¥è°ƒç”¨</span>args := &amp;Args&#123;<span class="hljs-number">7</span>, <span class="hljs-number">8</span>&#125;<span class="hljs-keyword">var</span> reply <span class="hljs-keyword">int</span><span class="hljs-keyword">if</span> err := client.Call(<span class="hljs-string">&quot;Arith.Multiply&quot;</span>, args, &amp;reply); err != <span class="hljs-literal">nil</span> &#123;log.Fatal(<span class="hljs-string">&quot;è°ƒç”¨Arith.Multiplyå¤±è´¥:&quot;</span>, err)&#125;fmt.Printf(<span class="hljs-string">&quot;Arith.Multiply: %d * %d = %d\n&quot;</span>, args.A, args.B, reply)<span class="hljs-comment">// å¼‚æ­¥è°ƒç”¨</span>quotient := <span class="hljs-built_in">new</span>(Quotient)divCall := client.Go(<span class="hljs-string">&quot;Arith.Divide&quot;</span>, &amp;Args&#123;<span class="hljs-number">15</span>, <span class="hljs-number">5</span>&#125;, quotient)<span class="hljs-comment">// åšå…¶ä»–äº‹æƒ…...</span><span class="hljs-comment">// ç­‰å¾…è°ƒç”¨å®Œæˆ</span>&lt;-divCall.Done<span class="hljs-keyword">if</span> divCall.Error != <span class="hljs-literal">nil</span> &#123;log.Fatal(<span class="hljs-string">&quot;è°ƒç”¨Arith.Divideå¤±è´¥:&quot;</span>, divCall.Error)&#125;fmt.Printf(<span class="hljs-string">&quot;Arith.Divide: %d / %d = %d ä½™ %d\n&quot;</span>, <span class="hljs-number">15</span>, <span class="hljs-number">5</span>, quotient.Quo, quotient.Rem)<span class="hljs-comment">// æµ‹è¯•é”™è¯¯å¤„ç†</span><span class="hljs-keyword">if</span> err := client.Call(<span class="hljs-string">&quot;Arith.Divide&quot;</span>, &amp;Args&#123;<span class="hljs-number">10</span>, <span class="hljs-number">0</span>&#125;, quotient); err != <span class="hljs-literal">nil</span> &#123;fmt.Println(<span class="hljs-string">&quot;é¢„æœŸçš„é”™è¯¯:&quot;</span>, err)&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startServer</span><span class="hljs-params">()</span></span> &#123;server := simplerpc.NewServer()<span class="hljs-keyword">if</span> err := server.Register(<span class="hljs-built_in">new</span>(Arith)); err != <span class="hljs-literal">nil</span> &#123;log.Fatal(<span class="hljs-string">&quot;æ³¨å†ŒArithæœåŠ¡å¤±è´¥:&quot;</span>, err)&#125;<span class="hljs-keyword">if</span> err := server.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;localhost:1234&quot;</span>); err != <span class="hljs-literal">nil</span> &#123;log.Fatal(<span class="hljs-string">&quot;å¯åŠ¨æœåŠ¡å™¨å¤±è´¥:&quot;</span>, err)&#125;&#125;</code></pre><h3 id="ğŸ”§-æ¡†æ¶ä¼˜åŒ–"><a class="header-anchor" href="#ğŸ”§-æ¡†æ¶ä¼˜åŒ–"></a>ğŸ”§ æ¡†æ¶ä¼˜åŒ–</h3><p>æˆ‘ä»¬çš„RPCæ¡†æ¶è™½ç„¶ç®€å•ï¼Œä½†ä»æœ‰å¾ˆå¤šå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼š</p><h4 id="1-æ”¯æŒå¤šç§ç¼–è§£ç æ ¼å¼"><a class="header-anchor" href="#1-æ”¯æŒå¤šç§ç¼–è§£ç æ ¼å¼"></a>1. æ”¯æŒå¤šç§ç¼–è§£ç æ ¼å¼</h4><p>æˆ‘ä»¬å¯ä»¥æ‰©å±•æ¡†æ¶ï¼Œæ”¯æŒæ›´å¤šçš„ç¼–è§£ç æ ¼å¼ï¼Œå¦‚Protocol Buffersã€MessagePackç­‰ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> CodecType <span class="hljs-keyword">string</span><span class="hljs-keyword">const</span> (JSONCodecType   CodecType = <span class="hljs-string">&quot;json&quot;</span>ProtoCodecType  CodecType = <span class="hljs-string">&quot;proto&quot;</span>MsgPackCodecType CodecType = <span class="hljs-string">&quot;msgpack&quot;</span>)<span class="hljs-comment">// ç¼–è§£ç å™¨å·¥å‚</span><span class="hljs-keyword">type</span> CodecFactory <span class="hljs-keyword">interface</span> &#123;NewCodec(conn io.ReadWriteCloser) Codec&#125;<span class="hljs-comment">// æ³¨å†Œç¼–è§£ç å™¨å·¥å‚</span><span class="hljs-keyword">var</span> codecFactories = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[CodecType]CodecFactory)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RegisterCodecFactory</span><span class="hljs-params">(typ CodecType, factory CodecFactory)</span></span> &#123;codecFactories[typ] = factory&#125;</code></pre><h4 id="2-æ·»åŠ è¶…æ—¶æ§åˆ¶"><a class="header-anchor" href="#2-æ·»åŠ è¶…æ—¶æ§åˆ¶"></a>2. æ·»åŠ è¶…æ—¶æ§åˆ¶</h4><p>ä¸ºäº†æé«˜ç³»ç»Ÿçš„å¯é æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ è¯·æ±‚è¶…æ—¶æ§åˆ¶ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span> <span class="hljs-title">CallWithTimeout</span><span class="hljs-params">(serviceMethod <span class="hljs-keyword">string</span>, args <span class="hljs-keyword">interface</span>&#123;&#125;, reply <span class="hljs-keyword">interface</span>&#123;&#125;, timeout time.Duration)</span> <span class="hljs-title">error</span></span> &#123;call := &amp;Call&#123;ServiceMethod: serviceMethod,Args:          args,Reply:         reply,Done:          <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Call, <span class="hljs-number">1</span>),&#125;c.send(call)<span class="hljs-keyword">select</span> &#123;<span class="hljs-keyword">case</span> &lt;-call.Done:<span class="hljs-keyword">return</span> call.Error<span class="hljs-keyword">case</span> &lt;-time.After(timeout):<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;è°ƒç”¨è¶…æ—¶: %s&quot;</span>, serviceMethod)&#125;&#125;</code></pre><h4 id="3-æ·»åŠ è¿æ¥æ± "><a class="header-anchor" href="#3-æ·»åŠ è¿æ¥æ± "></a>3. æ·»åŠ è¿æ¥æ± </h4><p>å¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªè¿æ¥æ± æ¥å¤ç”¨è¿æ¥ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> ClientPool <span class="hljs-keyword">struct</span> &#123;mu      sync.Mutexclients []*Clientaddr    <span class="hljs-keyword">string</span>network <span class="hljs-keyword">string</span>size    <span class="hljs-keyword">int</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewClientPool</span><span class="hljs-params">(network, addr <span class="hljs-keyword">string</span>, size <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(*ClientPool, error)</span></span> &#123;pool := &amp;ClientPool&#123;network: network,addr:    addr,size:    size,&#125;<span class="hljs-comment">// é¢„åˆ›å»ºè¿æ¥</span><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; size; i++ &#123;client, err := Dial(network, addr)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err&#125;pool.clients = <span class="hljs-built_in">append</span>(pool.clients, client)&#125;<span class="hljs-keyword">return</span> pool, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *ClientPool)</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-params">(*Client, error)</span></span> &#123;p.mu.Lock()<span class="hljs-keyword">defer</span> p.mu.Unlock()<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(p.clients) == <span class="hljs-number">0</span> &#123;<span class="hljs-keyword">return</span> Dial(p.network, p.addr)&#125;<span class="hljs-comment">// å–å‡ºæœ€åä¸€ä¸ªå®¢æˆ·ç«¯</span>client := p.clients[<span class="hljs-built_in">len</span>(p.clients)<span class="hljs-number">-1</span>]p.clients = p.clients[:<span class="hljs-built_in">len</span>(p.clients)<span class="hljs-number">-1</span>]<span class="hljs-keyword">return</span> client, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *ClientPool)</span> <span class="hljs-title">Put</span><span class="hljs-params">(client *Client)</span></span> &#123;p.mu.Lock()<span class="hljs-keyword">defer</span> p.mu.Unlock()<span class="hljs-comment">// å¦‚æœæ± å·²æ»¡ï¼Œå…³é—­å®¢æˆ·ç«¯</span><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(p.clients) &gt;= p.size &#123;client.Close()<span class="hljs-keyword">return</span>&#125;p.clients = <span class="hljs-built_in">append</span>(p.clients, client)&#125;</code></pre><h4 id="4-æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡"><a class="header-anchor" href="#4-æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡"></a>4. æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡</h4><p>åœ¨å®é™…çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬éœ€è¦æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡æœºåˆ¶ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> ServiceDiscovery <span class="hljs-keyword">interface</span> &#123;GetService(name <span class="hljs-keyword">string</span>) ([]<span class="hljs-keyword">string</span>, error) <span class="hljs-comment">// è¿”å›æœåŠ¡åœ°å€åˆ—è¡¨</span>Register(name, addr <span class="hljs-keyword">string</span>) error         <span class="hljs-comment">// æ³¨å†ŒæœåŠ¡</span>Deregister(name, addr <span class="hljs-keyword">string</span>) error       <span class="hljs-comment">// æ³¨é”€æœåŠ¡</span>&#125;<span class="hljs-keyword">type</span> LoadBalancer <span class="hljs-keyword">interface</span> &#123;Select(servers []<span class="hljs-keyword">string</span>) <span class="hljs-keyword">string</span> <span class="hljs-comment">// é€‰æ‹©ä¸€ä¸ªæœåŠ¡å™¨</span>&#125;<span class="hljs-comment">// ç®€å•çš„è½®è¯¢è´Ÿè½½å‡è¡¡å™¨</span><span class="hljs-keyword">type</span> RoundRobinBalancer <span class="hljs-keyword">struct</span> &#123;mu    sync.Mutexindex <span class="hljs-keyword">int</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *RoundRobinBalancer)</span> <span class="hljs-title">Select</span><span class="hljs-params">(servers []<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(servers) == <span class="hljs-number">0</span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>&#125;b.mu.Lock()<span class="hljs-keyword">defer</span> b.mu.Unlock()server := servers[b.index]b.index = (b.index + <span class="hljs-number">1</span>) % <span class="hljs-built_in">len</span>(servers)<span class="hljs-keyword">return</span> server&#125;</code></pre><h3 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h3><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»é›¶å¼€å§‹å®ç°äº†ä¸€ä¸ªç®€å•ä½†åŠŸèƒ½å®Œæ•´çš„RPCæ¡†æ¶ï¼ŒåŒ…æ‹¬ï¼š</p><ol><li><strong>æ¶ˆæ¯ç»“æ„è®¾è®¡</strong>ï¼šå®šä¹‰äº†RPCè¯·æ±‚å’Œå“åº”çš„æ ¼å¼</li><li><strong>ç¼–è§£ç å™¨</strong>ï¼šå®ç°äº†åŸºäºJSONçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</li><li><strong>æœåŠ¡æ³¨å†Œ</strong>ï¼šæ”¯æŒæ³¨å†ŒæœåŠ¡å’Œæ–¹æ³•</li><li><strong>æœåŠ¡è°ƒç”¨</strong>ï¼šé€šè¿‡åå°„æœºåˆ¶è°ƒç”¨æœåŠ¡æ–¹æ³•</li><li><strong>ç½‘ç»œä¼ è¾“</strong>ï¼šåŸºäºTCPçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å®ç°</li><li><strong>é”™è¯¯å¤„ç†</strong>ï¼šåœ¨å„ä¸ªç¯èŠ‚å¤„ç†å¯èƒ½çš„é”™è¯¯</li><li><strong>å¹¶å‘æ”¯æŒ</strong>ï¼šæ”¯æŒå¹¶å‘è°ƒç”¨å’Œå¤„ç†</li></ol><p>è¿™ä¸ªç®€å•çš„RPCæ¡†æ¶å±•ç¤ºäº†RPCçš„åŸºæœ¬å·¥ä½œåŸç†ï¼Œè™½ç„¶å®ƒä¸ç”Ÿäº§çº§çš„RPCæ¡†æ¶ï¼ˆå¦‚gRPCã€Thriftç­‰ï¼‰ç›¸æ¯”è¿˜æœ‰å¾ˆå¤§å·®è·ï¼Œä½†å®ƒåŒ…å«äº†RPCçš„æ ¸å¿ƒæ¦‚å¿µå’Œå®ç°ç»†èŠ‚ã€‚é€šè¿‡ç†è§£è¿™ä¸ªç®€å•çš„å®ç°ï¼Œä½ å¯ä»¥æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨å¤æ‚çš„RPCæ¡†æ¶ã€‚</p><p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå»ºè®®ä½¿ç”¨æˆç†Ÿçš„RPCæ¡†æ¶ï¼Œå¦‚Goæ ‡å‡†åº“çš„<code>net/rpc</code>ã€<code>net/rpc/jsonrpc</code>ï¼Œæˆ–è€…ç¬¬ä¸‰æ–¹æ¡†æ¶å¦‚gRPCã€Thriftç­‰ã€‚è¿™äº›æ¡†æ¶ç»è¿‡äº†å¹¿æ³›çš„æµ‹è¯•å’Œä¼˜åŒ–ï¼Œæä¾›äº†æ›´å¤šçš„åŠŸèƒ½å’Œæ›´å¥½çš„æ€§èƒ½ã€‚</p><p>ä¸è¿‡ï¼Œé€šè¿‡è‡ªå·±å®ç°ä¸€ä¸ªRPCæ¡†æ¶ï¼Œä½ å¯ä»¥æ·±å…¥ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿçš„é€šä¿¡æœºåˆ¶ï¼Œè¿™å¯¹äºè®¾è®¡å’Œä¼˜åŒ–åˆ†å¸ƒå¼ç³»ç»Ÿéå¸¸æœ‰å¸®åŠ©ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
      <tag>RPC</tag>
      
      <tag>ç½‘ç»œç¼–ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang å‡½æ•°å¼ç¼–ç¨‹å®è·µ</title>
    <link href="/2024/04/02/golang-%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5/"/>
    <url>/2024/04/02/golang-%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ§©-golang-å‡½æ•°å¼ç¼–ç¨‹å®è·µ"><a class="header-anchor" href="#ğŸ§©-golang-å‡½æ•°å¼ç¼–ç¨‹å®è·µ"></a>ğŸ§© golang å‡½æ•°å¼ç¼–ç¨‹å®è·µ</h2><p>è™½ç„¶Goè¯­è¨€ä¸»è¦æ˜¯å‘½ä»¤å¼å’Œé¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€ï¼Œä½†å®ƒä¹Ÿæ”¯æŒè®¸å¤šå‡½æ•°å¼ç¼–ç¨‹çš„ç‰¹æ€§å’Œæ¨¡å¼ã€‚å‡½æ•°å¼ç¼–ç¨‹å¼ºè°ƒä½¿ç”¨å‡½æ•°ä½œä¸ºä¸»è¦çš„æ„å»ºå—ï¼Œé¿å…çŠ¶æ€å˜åŒ–å’Œå¯å˜æ•°æ®ã€‚æœ¬æ–‡å°†æ¢è®¨å¦‚ä½•åœ¨Goä¸­åº”ç”¨å‡½æ•°å¼ç¼–ç¨‹çš„æ€æƒ³å’ŒæŠ€æœ¯ï¼Œä»¥ç¼–å†™æ›´ç®€æ´ã€æ›´å¯ç»´æŠ¤çš„ä»£ç ã€‚</p><h3 id="ğŸ“š-å‡½æ•°å¼ç¼–ç¨‹åŸºç¡€"><a class="header-anchor" href="#ğŸ“š-å‡½æ•°å¼ç¼–ç¨‹åŸºç¡€"></a>ğŸ“š å‡½æ•°å¼ç¼–ç¨‹åŸºç¡€</h3><p>å‡½æ•°å¼ç¼–ç¨‹åŸºäºä»¥ä¸‹æ ¸å¿ƒæ¦‚å¿µï¼š</p><ol><li><strong>ä¸€ç­‰å…¬æ°‘å‡½æ•°</strong>ï¼šå‡½æ•°å¯ä»¥ä½œä¸ºå€¼ä¼ é€’ã€èµ‹å€¼ç»™å˜é‡ã€ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶ä»–å‡½æ•°ï¼Œæˆ–ä½œä¸ºè¿”å›å€¼</li><li><strong>çº¯å‡½æ•°</strong>ï¼šå‡½æ•°çš„è¾“å‡ºä»…ç”±è¾“å…¥å†³å®šï¼Œæ²¡æœ‰å‰¯ä½œç”¨</li><li><strong>ä¸å¯å˜æ€§</strong>ï¼šä¸€æ—¦åˆ›å»ºï¼Œæ•°æ®ä¸åº”è¢«ä¿®æ”¹</li><li><strong>é«˜é˜¶å‡½æ•°</strong>ï¼šæ¥å—å‡½æ•°ä½œä¸ºå‚æ•°æˆ–è¿”å›å‡½æ•°çš„å‡½æ•°</li><li><strong>é—­åŒ…</strong>ï¼šæ•è·å¤–éƒ¨ä½œç”¨åŸŸå˜é‡çš„å‡½æ•°</li></ol><p>Goè¯­è¨€åŸç”Ÿæ”¯æŒä¸€ç­‰å…¬æ°‘å‡½æ•°ã€é«˜é˜¶å‡½æ•°å’Œé—­åŒ…ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨Goä¸­åº”ç”¨è®¸å¤šå‡½æ•°å¼ç¼–ç¨‹æŠ€æœ¯ã€‚</p><h3 id="ğŸ§ -é«˜é˜¶å‡½æ•°"><a class="header-anchor" href="#ğŸ§ -é«˜é˜¶å‡½æ•°"></a>ğŸ§  é«˜é˜¶å‡½æ•°</h3><p>é«˜é˜¶å‡½æ•°æ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ï¼Œå®ƒæ¥å—å‡½æ•°ä½œä¸ºå‚æ•°æˆ–è¿”å›å‡½æ•°ä½œä¸ºç»“æœã€‚åœ¨Goä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾å®šä¹‰å’Œä½¿ç”¨é«˜é˜¶å‡½æ•°ã€‚</p><h4 id="å‡½æ•°ä½œä¸ºå‚æ•°"><a class="header-anchor" href="#å‡½æ•°ä½œä¸ºå‚æ•°"></a>å‡½æ•°ä½œä¸ºå‚æ•°</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">applyToEach</span><span class="hljs-params">(numbers []<span class="hljs-keyword">int</span>, f <span class="hljs-keyword">func</span>(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span>) []<span class="hljs-title">int</span></span> &#123;    result := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-built_in">len</span>(numbers))    <span class="hljs-keyword">for</span> i, n := <span class="hljs-keyword">range</span> numbers &#123;        result[i] = f(n)    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">double</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">return</span> n * <span class="hljs-number">2</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">square</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">return</span> n * n&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    numbers := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;        <span class="hljs-comment">// å°†æ¯ä¸ªå…ƒç´ ç¿»å€</span>    doubled := applyToEach(numbers, double)    fmt.Println(doubled) <span class="hljs-comment">// [2 4 6 8 10]</span>        <span class="hljs-comment">// å°†æ¯ä¸ªå…ƒç´ å¹³æ–¹</span>    squared := applyToEach(numbers, square)    fmt.Println(squared) <span class="hljs-comment">// [1 4 9 16 25]</span>&#125;</code></pre><h4 id="å‡½æ•°ä½œä¸ºè¿”å›å€¼"><a class="header-anchor" href="#å‡½æ•°ä½œä¸ºè¿”å›å€¼"></a>å‡½æ•°ä½œä¸ºè¿”å›å€¼</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">multiplier</span><span class="hljs-params">(factor <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;        <span class="hljs-keyword">return</span> n * factor    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    double := multiplier(<span class="hljs-number">2</span>)    triple := multiplier(<span class="hljs-number">3</span>)        fmt.Println(double(<span class="hljs-number">5</span>))  <span class="hljs-comment">// 10</span>    fmt.Println(triple(<span class="hljs-number">5</span>))  <span class="hljs-comment">// 15</span>&#125;</code></pre><h3 id="ğŸ”„-å¸¸ç”¨å‡½æ•°å¼æ“ä½œ"><a class="header-anchor" href="#ğŸ”„-å¸¸ç”¨å‡½æ•°å¼æ“ä½œ"></a>ğŸ”„ å¸¸ç”¨å‡½æ•°å¼æ“ä½œ</h3><p>å‡½æ•°å¼ç¼–ç¨‹ä¸­æœ‰ä¸€äº›å¸¸è§çš„æ“ä½œï¼Œå¦‚mapã€filterå’Œreduceã€‚è™½ç„¶Goæ ‡å‡†åº“æ²¡æœ‰ç›´æ¥æä¾›è¿™äº›å‡½æ•°ï¼Œä½†æˆ‘ä»¬å¯ä»¥è½»æ¾å®ç°å®ƒä»¬ã€‚</p><h4 id="Map"><a class="header-anchor" href="#Map"></a>Map</h4><p>Mapæ“ä½œå°†ä¸€ä¸ªå‡½æ•°åº”ç”¨äºé›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„é›†åˆã€‚</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Map</span><span class="hljs-params">(vs []<span class="hljs-keyword">int</span>, f <span class="hljs-keyword">func</span>(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span>) []<span class="hljs-title">int</span></span> &#123;    result := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-built_in">len</span>(vs))    <span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> vs &#123;        result[i] = f(v)    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-comment">// æ³›å‹ç‰ˆæœ¬ï¼ˆGo 1.18+ï¼‰</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MapGeneric</span>[<span class="hljs-title">T</span>, <span class="hljs-title">U</span> <span class="hljs-title">any</span>]<span class="hljs-params">(vs []T, f <span class="hljs-keyword">func</span>(T)</span> <span class="hljs-title">U</span>) []<span class="hljs-title">U</span></span> &#123;    result := <span class="hljs-built_in">make</span>([]U, <span class="hljs-built_in">len</span>(vs))    <span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> vs &#123;        result[i] = f(v)    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    numbers := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;        squared := Map(numbers, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;        <span class="hljs-keyword">return</span> n * n    &#125;)        fmt.Println(squared) <span class="hljs-comment">// [1 4 9 16 25]</span>        <span class="hljs-comment">// ä½¿ç”¨æ³›å‹ç‰ˆæœ¬</span>    doubled := MapGeneric(numbers, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;        <span class="hljs-keyword">return</span> n * <span class="hljs-number">2</span>    &#125;)        fmt.Println(doubled) <span class="hljs-comment">// [2 4 6 8 10]</span>        <span class="hljs-comment">// å°†intè½¬æ¢ä¸ºstring</span>    strNumbers := MapGeneric(numbers, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">string</span></span> &#123;        <span class="hljs-keyword">return</span> strconv.Itoa(n)    &#125;)        fmt.Println(strNumbers) <span class="hljs-comment">// [&quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; &quot;5&quot;]</span>&#125;</code></pre><h4 id="Filter"><a class="header-anchor" href="#Filter"></a>Filter</h4><p>Filteræ“ä½œä»é›†åˆä¸­é€‰æ‹©æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„å…ƒç´ ã€‚</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Filter</span><span class="hljs-params">(vs []<span class="hljs-keyword">int</span>, f <span class="hljs-keyword">func</span>(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span>) []<span class="hljs-title">int</span></span> &#123;    result := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">0</span>)    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> vs &#123;        <span class="hljs-keyword">if</span> f(v) &#123;            result = <span class="hljs-built_in">append</span>(result, v)        &#125;    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-comment">// æ³›å‹ç‰ˆæœ¬ï¼ˆGo 1.18+ï¼‰</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FilterGeneric</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">(vs []T, f <span class="hljs-keyword">func</span>(T)</span> <span class="hljs-title">bool</span>) []<span class="hljs-title">T</span></span> &#123;    result := <span class="hljs-built_in">make</span>([]T, <span class="hljs-number">0</span>)    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> vs &#123;        <span class="hljs-keyword">if</span> f(v) &#123;            result = <span class="hljs-built_in">append</span>(result, v)        &#125;    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    numbers := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>&#125;        <span class="hljs-comment">// ç­›é€‰å¶æ•°</span>    evens := Filter(numbers, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123;        <span class="hljs-keyword">return</span> n%<span class="hljs-number">2</span> == <span class="hljs-number">0</span>    &#125;)        fmt.Println(evens) <span class="hljs-comment">// [2 4 6 8 10]</span>        <span class="hljs-comment">// ç­›é€‰å¤§äº5çš„æ•°</span>    greaterThanFive := FilterGeneric(numbers, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123;        <span class="hljs-keyword">return</span> n &gt; <span class="hljs-number">5</span>    &#125;)        fmt.Println(greaterThanFive) <span class="hljs-comment">// [6 7 8 9 10]</span>&#125;</code></pre><h4 id="Reduce"><a class="header-anchor" href="#Reduce"></a>Reduce</h4><p>Reduceæ“ä½œå°†é›†åˆä¸­çš„å…ƒç´ ç»„åˆæˆå•ä¸ªå€¼ã€‚</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Reduce</span><span class="hljs-params">(vs []<span class="hljs-keyword">int</span>, f <span class="hljs-keyword">func</span>(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span>, <span class="hljs-title">initial</span> <span class="hljs-title">int</span>) <span class="hljs-title">int</span></span> &#123;    result := initial    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> vs &#123;        result = f(result, v)    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-comment">// æ³›å‹ç‰ˆæœ¬ï¼ˆGo 1.18+ï¼‰</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ReduceGeneric</span>[<span class="hljs-title">T</span>, <span class="hljs-title">U</span> <span class="hljs-title">any</span>]<span class="hljs-params">(vs []T, f <span class="hljs-keyword">func</span>(U, T)</span> <span class="hljs-title">U</span>, <span class="hljs-title">initial</span> <span class="hljs-title">U</span>) <span class="hljs-title">U</span></span> &#123;    result := initial    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> vs &#123;        result = f(result, v)    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    numbers := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;        <span class="hljs-comment">// è®¡ç®—æ€»å’Œ</span>    sum := Reduce(numbers, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(acc, n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;        <span class="hljs-keyword">return</span> acc + n    &#125;, <span class="hljs-number">0</span>)        fmt.Println(sum) <span class="hljs-comment">// 15</span>        <span class="hljs-comment">// è®¡ç®—ä¹˜ç§¯</span>    product := ReduceGeneric(numbers, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(acc, n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;        <span class="hljs-keyword">return</span> acc * n    &#125;, <span class="hljs-number">1</span>)        fmt.Println(product) <span class="hljs-comment">// 120</span>        <span class="hljs-comment">// å°†æ•°å­—æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span>    str := ReduceGeneric(numbers, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(acc <span class="hljs-keyword">string</span>, n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">string</span></span> &#123;        <span class="hljs-keyword">if</span> acc == <span class="hljs-string">&quot;&quot;</span> &#123;            <span class="hljs-keyword">return</span> strconv.Itoa(n)        &#125;        <span class="hljs-keyword">return</span> acc + <span class="hljs-string">&quot;, &quot;</span> + strconv.Itoa(n)    &#125;, <span class="hljs-string">&quot;&quot;</span>)        fmt.Println(str) <span class="hljs-comment">// &quot;1, 2, 3, 4, 5&quot;</span>&#125;</code></pre><h3 id="ğŸ“¦-é—­åŒ…ä¸æŸ¯é‡ŒåŒ–"><a class="header-anchor" href="#ğŸ“¦-é—­åŒ…ä¸æŸ¯é‡ŒåŒ–"></a>ğŸ“¦ é—­åŒ…ä¸æŸ¯é‡ŒåŒ–</h3><p>é—­åŒ…æ˜¯å¼•ç”¨äº†å¤–éƒ¨ä½œç”¨åŸŸå˜é‡çš„å‡½æ•°ã€‚åœ¨Goä¸­ï¼Œé—­åŒ…å¯ä»¥æ•è·å¹¶ä½¿ç”¨å®šä¹‰å®ƒä»¬çš„å‡½æ•°ä¸­çš„å˜é‡ã€‚</p><h4 id="ç®€å•é—­åŒ…"><a class="header-anchor" href="#ç®€å•é—­åŒ…"></a>ç®€å•é—­åŒ…</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">adder</span><span class="hljs-params">()</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    sum := <span class="hljs-number">0</span>    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(x <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;        sum += x        <span class="hljs-keyword">return</span> sum    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    pos, neg := adder(), adder()        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;        fmt.Println(pos(i), neg(<span class="hljs-number">-2</span>*i))    &#125;    <span class="hljs-comment">// è¾“å‡ºï¼š</span>    <span class="hljs-comment">// 0 0</span>    <span class="hljs-comment">// 1 -2</span>    <span class="hljs-comment">// 3 -6</span>    <span class="hljs-comment">// 6 -12</span>    <span class="hljs-comment">// 10 -20</span>    <span class="hljs-comment">// 15 -30</span>    <span class="hljs-comment">// 21 -42</span>    <span class="hljs-comment">// 28 -56</span>    <span class="hljs-comment">// 36 -72</span>    <span class="hljs-comment">// 45 -90</span>&#125;</code></pre><h4 id="æŸ¯é‡ŒåŒ–"><a class="header-anchor" href="#æŸ¯é‡ŒåŒ–"></a>æŸ¯é‡ŒåŒ–</h4><p>æŸ¯é‡ŒåŒ–æ˜¯å°†æ¥å—å¤šä¸ªå‚æ•°çš„å‡½æ•°è½¬æ¢ä¸ºä¸€ç³»åˆ—æ¥å—å•ä¸ªå‚æ•°çš„å‡½æ•°çš„æŠ€æœ¯ã€‚</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">curry</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span>) <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(a <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(b <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;            <span class="hljs-keyword">return</span> f(a, b)        &#125;    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">(a, b <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">return</span> a + b&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    curriedAdd := curry(add)    add5 := curriedAdd(<span class="hljs-number">5</span>)    add10 := curriedAdd(<span class="hljs-number">10</span>)        fmt.Println(add5(<span class="hljs-number">3</span>))  <span class="hljs-comment">// 8</span>    fmt.Println(add10(<span class="hljs-number">3</span>)) <span class="hljs-comment">// 13</span>&#125;</code></pre><h3 id="ğŸ§¬-å‡½æ•°ç»„åˆ"><a class="header-anchor" href="#ğŸ§¬-å‡½æ•°ç»„åˆ"></a>ğŸ§¬ å‡½æ•°ç»„åˆ</h3><p>å‡½æ•°ç»„åˆæ˜¯å°†å¤šä¸ªå‡½æ•°ç»„åˆæˆä¸€ä¸ªæ–°å‡½æ•°çš„æŠ€æœ¯ã€‚</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">compose</span><span class="hljs-params">(f, g <span class="hljs-keyword">func</span>(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span>) <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(x <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;        <span class="hljs-keyword">return</span> f(g(x))    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">double</span><span class="hljs-params">(x <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">return</span> x * <span class="hljs-number">2</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">square</span><span class="hljs-params">(x <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">return</span> x * x&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// å…ˆå¹³æ–¹å†ç¿»å€</span>    squareThenDouble := compose(double, square)        <span class="hljs-comment">// å…ˆç¿»å€å†å¹³æ–¹</span>    doubleThenSquare := compose(square, double)        fmt.Println(squareThenDouble(<span class="hljs-number">3</span>)) <span class="hljs-comment">// double(square(3)) = double(9) = 18</span>    fmt.Println(doubleThenSquare(<span class="hljs-number">3</span>)) <span class="hljs-comment">// square(double(3)) = square(6) = 36</span>&#125;</code></pre><h3 id="ğŸ”„-ç®¡é“æ¨¡å¼"><a class="header-anchor" href="#ğŸ”„-ç®¡é“æ¨¡å¼"></a>ğŸ”„ ç®¡é“æ¨¡å¼</h3><p>ç®¡é“æ¨¡å¼æ˜¯ä¸€ç§å‡½æ•°å¼ç¼–ç¨‹æŠ€æœ¯ï¼Œå®ƒå°†æ•°æ®é€šè¿‡ä¸€ç³»åˆ—è½¬æ¢å‡½æ•°&quot;ç®¡é“&quot;ä¼ é€’ã€‚</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">pipeline</span><span class="hljs-params">(input <span class="hljs-keyword">int</span>, transforms ...<span class="hljs-keyword">func</span>(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span>) <span class="hljs-title">int</span></span> &#123;    result := input    <span class="hljs-keyword">for</span> _, transform := <span class="hljs-keyword">range</span> transforms &#123;        result = transform(result)    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// å®šä¹‰ä¸€äº›è½¬æ¢å‡½æ•°</span>    add1 := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(x <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123; <span class="hljs-keyword">return</span> x + <span class="hljs-number">1</span> &#125;    double := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(x <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123; <span class="hljs-keyword">return</span> x * <span class="hljs-number">2</span> &#125;    square := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(x <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123; <span class="hljs-keyword">return</span> x * x &#125;        <span class="hljs-comment">// åˆ›å»ºç®¡é“ï¼šå…ˆåŠ 1ï¼Œå†ç¿»å€ï¼Œæœ€åå¹³æ–¹</span>    result := pipeline(<span class="hljs-number">3</span>, add1, double, square)    fmt.Println(result) <span class="hljs-comment">// square(double(add1(3))) = square(double(4)) = square(8) = 64</span>&#125;</code></pre><h3 id="ğŸ§©-Optionæ¨¡å¼"><a class="header-anchor" href="#ğŸ§©-Optionæ¨¡å¼"></a>ğŸ§© Optionæ¨¡å¼</h3><p>Optionæ¨¡å¼æ˜¯ä¸€ç§å‡½æ•°å¼æ–¹æ³•ï¼Œç”¨äºé…ç½®å¯¹è±¡æˆ–å‡½æ•°ã€‚å®ƒä½¿ç”¨é«˜é˜¶å‡½æ•°æ¥è®¾ç½®é€‰é¡¹ã€‚</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;    host    <span class="hljs-keyword">string</span>    port    <span class="hljs-keyword">int</span>    timeout time.Duration    maxConn <span class="hljs-keyword">int</span>&#125;<span class="hljs-keyword">type</span> ServerOption <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*Server)</span></span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithHost</span><span class="hljs-params">(host <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">ServerOption</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s *Server)</span></span> &#123;        s.host = host    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithPort</span><span class="hljs-params">(port <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">ServerOption</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s *Server)</span></span> &#123;        s.port = port    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithTimeout</span><span class="hljs-params">(timeout time.Duration)</span> <span class="hljs-title">ServerOption</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s *Server)</span></span> &#123;        s.timeout = timeout    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithMaxConn</span><span class="hljs-params">(maxConn <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">ServerOption</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s *Server)</span></span> &#123;        s.maxConn = maxConn    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span><span class="hljs-params">(options ...ServerOption)</span> *<span class="hljs-title">Server</span></span> &#123;    <span class="hljs-comment">// é»˜è®¤å€¼</span>    server := &amp;Server&#123;        host:    <span class="hljs-string">&quot;localhost&quot;</span>,        port:    <span class="hljs-number">8080</span>,        timeout: <span class="hljs-number">30</span> * time.Second,        maxConn: <span class="hljs-number">100</span>,    &#125;        <span class="hljs-comment">// åº”ç”¨é€‰é¡¹</span>    <span class="hljs-keyword">for</span> _, option := <span class="hljs-keyword">range</span> options &#123;        option(server)    &#125;        <span class="hljs-keyword">return</span> server&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// ä½¿ç”¨é»˜è®¤å€¼åˆ›å»ºæœåŠ¡å™¨</span>    server1 := NewServer()        <span class="hljs-comment">// è‡ªå®šä¹‰æœåŠ¡å™¨é…ç½®</span>    server2 := NewServer(        WithHost(<span class="hljs-string">&quot;example.com&quot;</span>),        WithPort(<span class="hljs-number">9000</span>),        WithTimeout(<span class="hljs-number">60</span> * time.Second),    )        fmt.Printf(<span class="hljs-string">&quot;Server 1: %+v\n&quot;</span>, server1)    fmt.Printf(<span class="hljs-string">&quot;Server 2: %+v\n&quot;</span>, server2)&#125;</code></pre><h3 id="ğŸ”-æƒ°æ€§æ±‚å€¼"><a class="header-anchor" href="#ğŸ”-æƒ°æ€§æ±‚å€¼"></a>ğŸ” æƒ°æ€§æ±‚å€¼</h3><p>æƒ°æ€§æ±‚å€¼æ˜¯ä¸€ç§å»¶è¿Ÿè®¡ç®—ç»“æœç›´åˆ°éœ€è¦æ—¶æ‰æ‰§è¡Œçš„æŠ€æœ¯ã€‚åœ¨Goä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é—­åŒ…å’Œé€šé“æ¥å®ç°æƒ°æ€§æ±‚å€¼ã€‚</p><h4 id="ä½¿ç”¨é—­åŒ…å®ç°æƒ°æ€§æ±‚å€¼"><a class="header-anchor" href="#ä½¿ç”¨é—­åŒ…å®ç°æƒ°æ€§æ±‚å€¼"></a>ä½¿ç”¨é—­åŒ…å®ç°æƒ°æ€§æ±‚å€¼</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">lazyEval</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>()</span> <span class="hljs-title">int</span>) <span class="hljs-title">func</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">var</span> result <span class="hljs-keyword">int</span>    <span class="hljs-keyword">var</span> computed <span class="hljs-keyword">bool</span>        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;        <span class="hljs-keyword">if</span> !computed &#123;            result = f()            computed = <span class="hljs-literal">true</span>        &#125;        <span class="hljs-keyword">return</span> result    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">expensiveComputation</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;    fmt.Println(<span class="hljs-string">&quot;Performing expensive computation...&quot;</span>)    time.Sleep(<span class="hljs-number">2</span> * time.Second)    <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    lazy := lazyEval(expensiveComputation)        fmt.Println(<span class="hljs-string">&quot;Lazy function created, but not executed yet&quot;</span>)        <span class="hljs-comment">// åªæœ‰åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ‰ä¼šæ‰§è¡ŒexpensiveComputation</span>    fmt.Println(<span class="hljs-string">&quot;First call:&quot;</span>, lazy())    fmt.Println(<span class="hljs-string">&quot;Second call:&quot;</span>, lazy())    fmt.Println(<span class="hljs-string">&quot;Third call:&quot;</span>, lazy())&#125;</code></pre><h4 id="ä½¿ç”¨é€šé“å®ç°æ— é™åºåˆ—"><a class="header-anchor" href="#ä½¿ç”¨é€šé“å®ç°æ— é™åºåˆ—"></a>ä½¿ç”¨é€šé“å®ç°æ— é™åºåˆ—</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fibonacci</span><span class="hljs-params">()</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        a, b := <span class="hljs-number">0</span>, <span class="hljs-number">1</span>        <span class="hljs-keyword">for</span> &#123;            c &lt;- a            a, b = b, a+b        &#125;    &#125;()    <span class="hljs-keyword">return</span> c&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    fib := fibonacci()        <span class="hljs-comment">// è·å–å‰10ä¸ªæ–æ³¢é‚£å¥‘æ•°</span>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;        fmt.Println(&lt;-fib)    &#125;&#125;</code></pre><h3 id="ğŸ›¡ï¸-é”™è¯¯å¤„ç†æ¨¡å¼"><a class="header-anchor" href="#ğŸ›¡ï¸-é”™è¯¯å¤„ç†æ¨¡å¼"></a>ğŸ›¡ï¸ é”™è¯¯å¤„ç†æ¨¡å¼</h3><p>å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„é”™è¯¯å¤„ç†é€šå¸¸ä½¿ç”¨ç‰¹æ®Šç±»å‹ï¼ˆå¦‚Maybeæˆ–Eitherï¼‰æ¥è¡¨ç¤ºå¯èƒ½çš„é”™è¯¯ã€‚åœ¨Goä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿè¿™äº›æ¨¡å¼ã€‚</p><h4 id="Resultç±»å‹"><a class="header-anchor" href="#Resultç±»å‹"></a>Resultç±»å‹</h4><pre><code class="hljs go"><span class="hljs-keyword">type</span> Result <span class="hljs-keyword">struct</span> &#123;    Value <span class="hljs-keyword">interface</span>&#123;&#125;    Error error&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SafeDivide</span><span class="hljs-params">(a, b <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">Result</span></span> &#123;    <span class="hljs-keyword">if</span> b == <span class="hljs-number">0</span> &#123;        <span class="hljs-keyword">return</span> Result&#123;Error: errors.New(<span class="hljs-string">&quot;division by zero&quot;</span>)&#125;    &#125;    <span class="hljs-keyword">return</span> Result&#123;Value: a / b&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Process</span><span class="hljs-params">(r Result, f <span class="hljs-keyword">func</span>(<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">Result</span>) <span class="hljs-title">Result</span></span> &#123;    <span class="hljs-keyword">if</span> r.Error != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> r    &#125;    <span class="hljs-keyword">return</span> f(r.Value)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// æˆåŠŸçš„è®¡ç®—</span>    result1 := SafeDivide(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>)    result1 = Process(result1, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(v <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">Result</span></span> &#123;        <span class="hljs-keyword">return</span> Result&#123;Value: v.(<span class="hljs-keyword">int</span>) * <span class="hljs-number">2</span>&#125;    &#125;)        <span class="hljs-comment">// å¤±è´¥çš„è®¡ç®—</span>    result2 := SafeDivide(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>)    result2 = Process(result2, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(v <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">Result</span></span> &#123;        <span class="hljs-keyword">return</span> Result&#123;Value: v.(<span class="hljs-keyword">int</span>) * <span class="hljs-number">2</span>&#125;    &#125;)        fmt.Printf(<span class="hljs-string">&quot;Result 1: %+v\n&quot;</span>, result1) <span class="hljs-comment">// Result 1: &#123;Value:10 Error:&lt;nil&gt;&#125;</span>    fmt.Printf(<span class="hljs-string">&quot;Result 2: %+v\n&quot;</span>, result2) <span class="hljs-comment">// Result 2: &#123;Value:&lt;nil&gt; Error:division by zero&#125;</span>&#125;</code></pre><h4 id="ä½¿ç”¨æ³›å‹å®ç°Maybeæ¨¡å¼ï¼ˆGo-1-18-ï¼‰"><a class="header-anchor" href="#ä½¿ç”¨æ³›å‹å®ç°Maybeæ¨¡å¼ï¼ˆGo-1-18-ï¼‰"></a>ä½¿ç”¨æ³›å‹å®ç°Maybeæ¨¡å¼ï¼ˆGo 1.18+ï¼‰</h4><pre><code class="hljs go"><span class="hljs-keyword">type</span> Maybe[T any] <span class="hljs-keyword">struct</span> &#123;    value *T&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Just</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">(value T)</span> <span class="hljs-title">Maybe</span>[<span class="hljs-title">T</span>]</span> &#123;    <span class="hljs-keyword">return</span> Maybe[T]&#123;value: &amp;value&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Nothing</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">()</span> <span class="hljs-title">Maybe</span>[<span class="hljs-title">T</span>]</span> &#123;    <span class="hljs-keyword">return</span> Maybe[T]&#123;value: <span class="hljs-literal">nil</span>&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m Maybe[T])</span> <span class="hljs-title">IsJust</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span> &#123;    <span class="hljs-keyword">return</span> m.value != <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m Maybe[T])</span> <span class="hljs-title">IsNothing</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span> &#123;    <span class="hljs-keyword">return</span> m.value == <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m Maybe[T])</span> <span class="hljs-title">GetOrElse</span><span class="hljs-params">(defaultValue T)</span> <span class="hljs-title">T</span></span> &#123;    <span class="hljs-keyword">if</span> m.IsJust() &#123;        <span class="hljs-keyword">return</span> *m.value    &#125;    <span class="hljs-keyword">return</span> defaultValue&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m Maybe[T])</span> <span class="hljs-title">Map</span>[<span class="hljs-title">U</span> <span class="hljs-title">any</span>]<span class="hljs-params">(f <span class="hljs-keyword">func</span>(T)</span> <span class="hljs-title">U</span>) <span class="hljs-title">Maybe</span>[<span class="hljs-title">U</span>]</span> &#123;    <span class="hljs-keyword">if</span> m.IsNothing() &#123;        <span class="hljs-keyword">return</span> Nothing[U]()    &#125;    <span class="hljs-keyword">return</span> Just(f(*m.value))&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m Maybe[T])</span> <span class="hljs-title">FlatMap</span>[<span class="hljs-title">U</span> <span class="hljs-title">any</span>]<span class="hljs-params">(f <span class="hljs-keyword">func</span>(T)</span> <span class="hljs-title">Maybe</span>[<span class="hljs-title">U</span>]) <span class="hljs-title">Maybe</span>[<span class="hljs-title">U</span>]</span> &#123;    <span class="hljs-keyword">if</span> m.IsNothing() &#123;        <span class="hljs-keyword">return</span> Nothing[U]()    &#125;    <span class="hljs-keyword">return</span> f(*m.value)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SafeDivide</span><span class="hljs-params">(a, b <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">Maybe</span>[<span class="hljs-title">int</span>]</span> &#123;    <span class="hljs-keyword">if</span> b == <span class="hljs-number">0</span> &#123;        <span class="hljs-keyword">return</span> Nothing[<span class="hljs-keyword">int</span>]()    &#125;    <span class="hljs-keyword">return</span> Just(a / b)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// æˆåŠŸçš„è®¡ç®—</span>    result1 := SafeDivide(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>).        Map(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(v <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123; <span class="hljs-keyword">return</span> v * <span class="hljs-number">2</span> &#125;).        Map(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(v <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123; <span class="hljs-keyword">return</span> v + <span class="hljs-number">1</span> &#125;)        <span class="hljs-comment">// å¤±è´¥çš„è®¡ç®—</span>    result2 := SafeDivide(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>).        Map(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(v <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123; <span class="hljs-keyword">return</span> v * <span class="hljs-number">2</span> &#125;).        Map(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(v <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123; <span class="hljs-keyword">return</span> v + <span class="hljs-number">1</span> &#125;)        fmt.Println(<span class="hljs-string">&quot;Result 1:&quot;</span>, result1.GetOrElse(<span class="hljs-number">0</span>)) <span class="hljs-comment">// Result 1: 11</span>    fmt.Println(<span class="hljs-string">&quot;Result 2:&quot;</span>, result2.GetOrElse(<span class="hljs-number">0</span>)) <span class="hljs-comment">// Result 2: 0</span>&#125;</code></pre><h3 id="ğŸ§ª-å®é™…åº”ç”¨æ¡ˆä¾‹"><a class="header-anchor" href="#ğŸ§ª-å®é™…åº”ç”¨æ¡ˆä¾‹"></a>ğŸ§ª å®é™…åº”ç”¨æ¡ˆä¾‹</h3><p>è®©æˆ‘ä»¬çœ‹ä¸€äº›åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨å‡½æ•°å¼ç¼–ç¨‹çš„ä¾‹å­ã€‚</p><h4 id="æ•°æ®å¤„ç†ç®¡é“"><a class="header-anchor" href="#æ•°æ®å¤„ç†ç®¡é“"></a>æ•°æ®å¤„ç†ç®¡é“</h4><pre><code class="hljs go"><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;    ID       <span class="hljs-keyword">int</span>    Name     <span class="hljs-keyword">string</span>    Email    <span class="hljs-keyword">string</span>    Age      <span class="hljs-keyword">int</span>    IsActive <span class="hljs-keyword">bool</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    users := []User&#123;        &#123;<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Alice&quot;</span>, <span class="hljs-string">&quot;alice@example.com&quot;</span>, <span class="hljs-number">25</span>, <span class="hljs-literal">true</span>&#125;,        &#123;<span class="hljs-number">2</span>, <span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-string">&quot;bob@example.com&quot;</span>, <span class="hljs-number">30</span>, <span class="hljs-literal">false</span>&#125;,        &#123;<span class="hljs-number">3</span>, <span class="hljs-string">&quot;Charlie&quot;</span>, <span class="hljs-string">&quot;charlie@example.com&quot;</span>, <span class="hljs-number">35</span>, <span class="hljs-literal">true</span>&#125;,        &#123;<span class="hljs-number">4</span>, <span class="hljs-string">&quot;Dave&quot;</span>, <span class="hljs-string">&quot;dave@example.com&quot;</span>, <span class="hljs-number">40</span>, <span class="hljs-literal">true</span>&#125;,        &#123;<span class="hljs-number">5</span>, <span class="hljs-string">&quot;Eve&quot;</span>, <span class="hljs-string">&quot;eve@example.com&quot;</span>, <span class="hljs-number">45</span>, <span class="hljs-literal">false</span>&#125;,    &#125;        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ•°æ®å¤„ç†ç®¡é“ï¼š</span>    <span class="hljs-comment">// 1. ç­›é€‰æ´»è·ƒç”¨æˆ·</span>    <span class="hljs-comment">// 2. ç­›é€‰å¹´é¾„å¤§äº30çš„ç”¨æˆ·</span>    <span class="hljs-comment">// 3. æå–ç”¨æˆ·å</span>    <span class="hljs-comment">// 4. å°†ç”¨æˆ·åè½¬æ¢ä¸ºå¤§å†™</span>        activeUsers := FilterGeneric(users, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(u User)</span> <span class="hljs-title">bool</span></span> &#123;        <span class="hljs-keyword">return</span> u.IsActive    &#125;)        olderUsers := FilterGeneric(activeUsers, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(u User)</span> <span class="hljs-title">bool</span></span> &#123;        <span class="hljs-keyword">return</span> u.Age &gt; <span class="hljs-number">30</span>    &#125;)        names := MapGeneric(olderUsers, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(u User)</span> <span class="hljs-title">string</span></span> &#123;        <span class="hljs-keyword">return</span> u.Name    &#125;)        upperNames := MapGeneric(names, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;        <span class="hljs-keyword">return</span> strings.ToUpper(name)    &#125;)        fmt.Println(upperNames) <span class="hljs-comment">// [CHARLIE DAVE]</span>        <span class="hljs-comment">// ä½¿ç”¨ç®¡é“æ¨¡å¼ç®€åŒ–ä¸Šè¿°ä»£ç </span>    result := Pipe(users,        FilterUsers(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(u User)</span> <span class="hljs-title">bool</span></span> &#123; <span class="hljs-keyword">return</span> u.IsActive &#125;),        FilterUsers(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(u User)</span> <span class="hljs-title">bool</span></span> &#123; <span class="hljs-keyword">return</span> u.Age &gt; <span class="hljs-number">30</span> &#125;),        MapToStrings(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(u User)</span> <span class="hljs-title">string</span></span> &#123; <span class="hljs-keyword">return</span> u.Name &#125;),        MapStrings(strings.ToUpper),    )        fmt.Println(result) <span class="hljs-comment">// [CHARLIE DAVE]</span>&#125;<span class="hljs-comment">// ç®¡é“å‡½æ•°</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Pipe</span><span class="hljs-params">(input <span class="hljs-keyword">interface</span>&#123;&#125;, transforms ...<span class="hljs-keyword">func</span>(<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125;) <span class="hljs-keyword">interface</span>&#123;&#125; &#123;    result := input    <span class="hljs-keyword">for</span> _, transform := <span class="hljs-keyword">range</span> transforms &#123;        result = transform(result)    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FilterUsers</span><span class="hljs-params">(predicate <span class="hljs-keyword">func</span>(User)</span> <span class="hljs-title">bool</span>) <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(input <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;        users := input.([]User)        <span class="hljs-keyword">return</span> FilterGeneric(users, predicate)    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MapToStrings</span><span class="hljs-params">(mapper <span class="hljs-keyword">func</span>(User)</span> <span class="hljs-title">string</span>) <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(input <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;        users := input.([]User)        <span class="hljs-keyword">return</span> MapGeneric(users, mapper)    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MapStrings</span><span class="hljs-params">(mapper <span class="hljs-keyword">func</span>(<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span>) <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(input <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;        strings := input.([]<span class="hljs-keyword">string</span>)        <span class="hljs-keyword">return</span> MapGeneric(strings, mapper)    &#125;&#125;</code></pre><h4 id="Webä¸­é—´ä»¶"><a class="header-anchor" href="#Webä¸­é—´ä»¶"></a>Webä¸­é—´ä»¶</h4><p>å‡½æ•°å¼ç¼–ç¨‹éå¸¸é€‚åˆå®ç°Webä¸­é—´ä»¶ã€‚</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Handler <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(http.ResponseWriter, *http.Request)</span></span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Middleware</span><span class="hljs-params">(h Handler, middlewares ...<span class="hljs-keyword">func</span>(Handler)</span> <span class="hljs-title">Handler</span>) <span class="hljs-title">Handler</span></span> &#123;    <span class="hljs-keyword">for</span> _, middleware := <span class="hljs-keyword">range</span> middlewares &#123;        h = middleware(h)    &#125;    <span class="hljs-keyword">return</span> h&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Logging</span><span class="hljs-params">(next Handler)</span> <span class="hljs-title">Handler</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;        start := time.Now()        next(w, r)        log.Printf(<span class="hljs-string">&quot;%s %s %v&quot;</span>, r.Method, r.URL.Path, time.Since(start))    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Auth</span><span class="hljs-params">(next Handler)</span> <span class="hljs-title">Handler</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;        token := r.Header.Get(<span class="hljs-string">&quot;Authorization&quot;</span>)        <span class="hljs-keyword">if</span> token == <span class="hljs-string">&quot;&quot;</span> &#123;            http.Error(w, <span class="hljs-string">&quot;Unauthorized&quot;</span>, http.StatusUnauthorized)            <span class="hljs-keyword">return</span>        &#125;        next(w, r)    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HelloHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;    fmt.Fprintln(w, <span class="hljs-string">&quot;Hello, world!&quot;</span>)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    handler := Middleware(HelloHandler, Logging, Auth)    http.HandleFunc(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;        handler(w, r)    &#125;)    http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, <span class="hljs-literal">nil</span>)&#125;</code></pre><h3 id="ğŸ“-æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹"><a class="header-anchor" href="#ğŸ“-æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹"></a>ğŸ“ æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹</h3><p>åœ¨Goä¸­åº”ç”¨å‡½æ•°å¼ç¼–ç¨‹æ—¶ï¼Œæœ‰ä¸€äº›æœ€ä½³å®è·µå’Œæ³¨æ„äº‹é¡¹ï¼š</p><h4 id="ä¼˜ç‚¹"><a class="header-anchor" href="#ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><ol><li><strong>ä»£ç ç®€æ´</strong>ï¼šå‡½æ•°å¼ç¼–ç¨‹å¯ä»¥å‡å°‘æ ·æ¿ä»£ç ï¼Œä½¿é€»è¾‘æ›´æ¸…æ™°</li><li><strong>å¯ç»„åˆæ€§</strong>ï¼šå‡½æ•°å¯ä»¥è½»æ¾ç»„åˆï¼Œåˆ›å»ºæ›´å¤æ‚çš„è¡Œä¸º</li><li><strong>å¯æµ‹è¯•æ€§</strong>ï¼šçº¯å‡½æ•°æ˜“äºæµ‹è¯•ï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰å‰¯ä½œç”¨</li><li><strong>å¹¶å‘å®‰å…¨</strong>ï¼šä¸å¯å˜æ•°æ®å’Œçº¯å‡½æ•°å¤©ç„¶å¹¶å‘å®‰å…¨</li></ol><h4 id="ç¼ºç‚¹"><a class="header-anchor" href="#ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><ol><li><strong>æ€§èƒ½å¼€é”€</strong>ï¼šè¿‡åº¦ä½¿ç”¨é—­åŒ…å’Œé«˜é˜¶å‡½æ•°å¯èƒ½å¯¼è‡´é¢å¤–çš„å†…å­˜åˆ†é…å’Œæ€§èƒ½å¼€é”€</li><li><strong>å¯è¯»æ€§</strong>ï¼šå¯¹ä¸ç†Ÿæ‚‰å‡½æ•°å¼ç¼–ç¨‹çš„å¼€å‘è€…æ¥è¯´ï¼Œä»£ç å¯èƒ½éš¾ä»¥ç†è§£</li><li><strong>Goçš„é™åˆ¶</strong>ï¼šGoä¸æ˜¯ä¸“ä¸ºå‡½æ•°å¼ç¼–ç¨‹è®¾è®¡çš„ï¼Œç¼ºå°‘ä¸€äº›å‡½æ•°å¼è¯­è¨€çš„ç‰¹æ€§</li></ol><h4 id="æœ€ä½³å®è·µ"><a class="header-anchor" href="#æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h4><ol><li><strong>å¹³è¡¡ä½¿ç”¨</strong>ï¼šå°†å‡½æ•°å¼ç¼–ç¨‹ä¸Goçš„å…¶ä»–èŒƒå¼ç»“åˆä½¿ç”¨</li><li><strong>ä¿æŒç®€å•</strong>ï¼šé¿å…è¿‡åº¦å¤æ‚çš„å‡½æ•°ç»„åˆ</li><li><strong>è€ƒè™‘æ€§èƒ½</strong>ï¼šåœ¨æ€§èƒ½å…³é”®çš„è·¯å¾„ä¸Šè°¨æ…ä½¿ç”¨é«˜é˜¶å‡½æ•°</li><li><strong>åˆ©ç”¨æ³›å‹</strong>ï¼šåœ¨Go 1.18+ä¸­ï¼Œåˆ©ç”¨æ³›å‹ä½¿å‡½æ•°å¼ä»£ç æ›´ç±»å‹å®‰å…¨</li></ol><h3 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h3><p>è™½ç„¶Goä¸æ˜¯ä¸€é—¨å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ï¼Œä½†å®ƒæä¾›äº†è¶³å¤Ÿçš„ç‰¹æ€§æ¥æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹é£æ ¼ã€‚é€šè¿‡åˆç†ä½¿ç”¨é«˜é˜¶å‡½æ•°ã€é—­åŒ…ã€ä¸å¯å˜æ•°æ®å’Œç»„åˆï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Goä¸­å®ç°è®¸å¤šå‡½æ•°å¼ç¼–ç¨‹çš„æ¨¡å¼å’ŒæŠ€æœ¯ã€‚</p><p>å‡½æ•°å¼ç¼–ç¨‹å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç¼–å†™æ›´ç®€æ´ã€æ›´å¯ç»´æŠ¤ã€æ›´æ˜“äºæµ‹è¯•çš„ä»£ç ã€‚ç„¶è€Œï¼Œé‡è¦çš„æ˜¯è¦å¹³è¡¡ä½¿ç”¨å‡½æ•°å¼é£æ ¼å’ŒGoçš„å…¶ä»–èŒƒå¼ï¼Œä»¥å……åˆ†åˆ©ç”¨è¯­è¨€çš„ä¼˜åŠ¿ã€‚</p><p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå‡½æ•°å¼ç¼–ç¨‹ç‰¹åˆ«é€‚åˆäºæ•°æ®è½¬æ¢ã€é”™è¯¯å¤„ç†ã€é…ç½®ç®¡ç†å’Œä¸­é—´ä»¶ç­‰åœºæ™¯ã€‚é€šè¿‡æŒæ¡æœ¬æ–‡ä»‹ç»çš„å‡½æ•°å¼ç¼–ç¨‹æŠ€æœ¯ï¼Œä½ å¯ä»¥åœ¨Goé¡¹ç›®ä¸­åº”ç”¨è¿™äº›å¼ºå¤§çš„æ¦‚å¿µï¼Œæé«˜ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>å‡½æ•°å¼ç¼–ç¨‹</tag>
      
      <tag>é«˜é˜¶å‡½æ•°</tag>
      
      <tag>é—­åŒ…</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang ä½¿ç”¨wireè¿›è¡Œä¾èµ–æ³¨å…¥</title>
    <link href="/2024/03/28/golang-%E4%BD%BF%E7%94%A8wire%E8%BF%9B%E8%A1%8C%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/"/>
    <url>/2024/03/28/golang-%E4%BD%BF%E7%94%A8wire%E8%BF%9B%E8%A1%8C%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ”Œ-golang-ä½¿ç”¨wireè¿›è¡Œä¾èµ–æ³¨å…¥"><a class="header-anchor" href="#ğŸ”Œ-golang-ä½¿ç”¨wireè¿›è¡Œä¾èµ–æ³¨å…¥"></a>ğŸ”Œ golang ä½¿ç”¨wireè¿›è¡Œä¾èµ–æ³¨å…¥</h2><p>ä¾èµ–æ³¨å…¥(Dependency Injectionï¼Œç®€ç§°DI)æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬ç¼–å†™æ›´åŠ æ¨¡å—åŒ–ã€å¯æµ‹è¯•å’Œå¯ç»´æŠ¤çš„ä»£ç ã€‚åœ¨Goè¯­è¨€ä¸­ï¼ŒGoogleå¼€æºçš„<a href="https://github.com/google/wire">Wire</a>åº“æä¾›äº†ä¸€ç§ç¼–è¯‘æ—¶ä¾èµ–æ³¨å…¥çš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆä¾èµ–å…³ç³»ä»£ç ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨Wireè¿›è¡Œä¾èµ–æ³¨å…¥ã€‚</p><h3 id="ğŸ“š-ä¾èµ–æ³¨å…¥åŸºç¡€"><a class="header-anchor" href="#ğŸ“š-ä¾èµ–æ³¨å…¥åŸºç¡€"></a>ğŸ“š ä¾èµ–æ³¨å…¥åŸºç¡€</h3><p>åœ¨æ·±å…¥Wireä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ã€‚</p><p>ä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>ä¸€ä¸ªå¯¹è±¡ä¸åº”è¯¥è´Ÿè´£åˆ›å»ºå®ƒæ‰€ä¾èµ–çš„å¯¹è±¡ï¼Œè€Œåº”è¯¥ä»å¤–éƒ¨æ¥æ”¶å®ƒä»¬</strong>ã€‚æ¯”å¦‚ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸ä½¿ç”¨ä¾èµ–æ³¨å…¥</span><span class="hljs-keyword">type</span> Service <span class="hljs-keyword">struct</span> &#123;    repository *Repository&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewService</span><span class="hljs-params">()</span> *<span class="hljs-title">Service</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;Service&#123;        repository: NewRepository(), <span class="hljs-comment">// Serviceè‡ªå·±åˆ›å»ºäº†Repository</span>    &#125;&#125;<span class="hljs-comment">// ä½¿ç”¨ä¾èµ–æ³¨å…¥</span><span class="hljs-keyword">type</span> Service <span class="hljs-keyword">struct</span> &#123;    repository *Repository&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewService</span><span class="hljs-params">(repository *Repository)</span> *<span class="hljs-title">Service</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;Service&#123;        repository: repository, <span class="hljs-comment">// Repositoryä»å¤–éƒ¨æ³¨å…¥</span>    &#125;&#125;</code></pre><p>ä¾èµ–æ³¨å…¥çš„å¥½å¤„åŒ…æ‹¬ï¼š</p><ul><li>ä»£ç è§£è€¦ï¼Œæé«˜å¯ç»´æŠ¤æ€§</li><li>ä¾¿äºå•å…ƒæµ‹è¯•ï¼Œå¯ä»¥è½»æ¾æ³¨å…¥mockå¯¹è±¡</li><li>æé«˜ä»£ç å¯è¯»æ€§ï¼Œä¾èµ–å…³ç³»ä¸€ç›®äº†ç„¶</li></ul><h3 id="ğŸ› ï¸-Wire-ä»‹ç»"><a class="header-anchor" href="#ğŸ› ï¸-Wire-ä»‹ç»"></a>ğŸ› ï¸ Wire ä»‹ç»</h3><p>Wireæ˜¯Googleå¼€å‘çš„ä¸€ä¸ªä¾èµ–æ³¨å…¥å·¥å…·ï¼Œå®ƒé€šè¿‡ä»£ç ç”Ÿæˆçš„æ–¹å¼æ¥å¤„ç†ä¾èµ–æ³¨å…¥ï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶ä½¿ç”¨åå°„ã€‚è¿™å¸¦æ¥äº†å‡ ä¸ªé‡è¦ä¼˜åŠ¿ï¼š</p><ol><li><strong>ç¼–è¯‘æ—¶æ£€æŸ¥</strong>ï¼šä¾èµ–å…³ç³»åœ¨ç¼–è¯‘æ—¶éªŒè¯ï¼Œä¸ä¼šæœ‰è¿è¡Œæ—¶é”™è¯¯</li><li><strong>æ— åå°„å¼€é”€</strong>ï¼šç”Ÿæˆçš„ä»£ç ä¸ä½¿ç”¨åå°„ï¼Œæ€§èƒ½ä¸æ‰‹å†™ä»£ç ç›¸å½“</li><li><strong>æ˜“äºè°ƒè¯•</strong>ï¼šç”Ÿæˆçš„ä»£ç æ¸…æ™°æ˜“è¯»ï¼Œä¾¿äºç†è§£å’Œè°ƒè¯•</li></ol><h3 id="ğŸš€-å®‰è£…Wire"><a class="header-anchor" href="#ğŸš€-å®‰è£…Wire"></a>ğŸš€ å®‰è£…Wire</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…Wireå·¥å…·ï¼š</p><pre><code class="hljs bash">go install github.com/google/wire/cmd/wire@latest</code></pre><h3 id="ğŸ”-Wireçš„åŸºæœ¬ä½¿ç”¨"><a class="header-anchor" href="#ğŸ”-Wireçš„åŸºæœ¬ä½¿ç”¨"></a>ğŸ” Wireçš„åŸºæœ¬ä½¿ç”¨</h3><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥äº†è§£Wireçš„ä½¿ç”¨æ–¹æ³•ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š</p><ol><li>ä¸€ä¸ªæ•°æ®åº“è¿æ¥</li><li>ä¸€ä¸ªç”¨æˆ·ä»“åº“</li><li>ä¸€ä¸ªç”¨æˆ·æœåŠ¡</li></ol><p>ä¸ä½¿ç”¨Wireçš„è¯ï¼Œæˆ‘ä»¬çš„ä»£ç å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-comment">// DBè¡¨ç¤ºæ•°æ®åº“è¿æ¥</span><span class="hljs-keyword">type</span> DB <span class="hljs-keyword">struct</span> &#123;    ConnectionString <span class="hljs-keyword">string</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDB</span><span class="hljs-params">()</span> *<span class="hljs-title">DB</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;DB&#123;ConnectionString: <span class="hljs-string">&quot;user:password@tcp(localhost:3306)/mydb&quot;</span>&#125;&#125;<span class="hljs-comment">// UserRepositoryå¤„ç†ç”¨æˆ·æ•°æ®å­˜å‚¨</span><span class="hljs-keyword">type</span> UserRepository <span class="hljs-keyword">struct</span> &#123;    db *DB&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserRepository</span><span class="hljs-params">(db *DB)</span> *<span class="hljs-title">UserRepository</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;UserRepository&#123;db: db&#125;&#125;<span class="hljs-comment">// UserServiceæä¾›ç”¨æˆ·ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘</span><span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span> &#123;    repo *UserRepository&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserService</span><span class="hljs-params">(repo *UserRepository)</span> *<span class="hljs-title">UserService</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;UserService&#123;repo: repo&#125;&#125;<span class="hljs-comment">// Appæ˜¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åº</span><span class="hljs-keyword">type</span> App <span class="hljs-keyword">struct</span> &#123;    userService *UserService&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewApp</span><span class="hljs-params">(userService *UserService)</span> *<span class="hljs-title">App</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;App&#123;userService: userService&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// æ‰‹åŠ¨è£…é…ä¾èµ–</span>    db := NewDB()    userRepo := NewUserRepository(db)    userService := NewUserService(userRepo)    app := NewApp(userService)        fmt.Printf(<span class="hljs-string">&quot;App created: %v\n&quot;</span>, app)&#125;</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºäº†æ‰€æœ‰ç»„ä»¶å¹¶å°†å®ƒä»¬è¿æ¥èµ·æ¥ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨Wireæ¥è‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹ã€‚</p><h3 id="âš¡-ä½¿ç”¨Wireé‡æ„"><a class="header-anchor" href="#âš¡-ä½¿ç”¨Wireé‡æ„"></a>âš¡ ä½¿ç”¨Wireé‡æ„</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨ç›¸åŒåŒ…ä¸­åˆ›å»ºä¸€ä¸ª<code>wire.go</code>æ–‡ä»¶:</p><pre><code class="hljs go"><span class="hljs-comment">//+build wireinject</span><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/google/wire&quot;</span><span class="hljs-comment">// InitializeApp æ˜¯æˆ‘ä»¬çš„ä¾èµ–æ³¨å…¥å‡½æ•°</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitializeApp</span><span class="hljs-params">()</span> *<span class="hljs-title">App</span></span> &#123;    wire.Build(NewDB, NewUserRepository, NewUserService, NewApp)    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> <span class="hljs-comment">// è¿”å›å€¼ä¼šè¢«Wireç”Ÿæˆçš„ä»£ç æ›¿æ¢</span>&#125;</code></pre><p>æ³¨æ„æ–‡ä»¶é¡¶éƒ¨çš„<code>//+build wireinject</code>æ ‡è®°ã€‚è¿™å‘Šè¯‰Goç¼–è¯‘å™¨åœ¨æ­£å¸¸æ„å»ºæ—¶å¿½ç•¥è¿™ä¸ªæ–‡ä»¶ï¼Œä½†Wireå·¥å…·ä¼šä½¿ç”¨å®ƒæ¥ç”Ÿæˆä¾èµ–æ³¨å…¥ä»£ç ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿è¡ŒWireå·¥å…·æ¥ç”Ÿæˆä»£ç ï¼š</p><pre><code class="hljs bash">wire</code></pre><p>Wireä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª<code>wire_gen.go</code>æ–‡ä»¶ï¼Œå†…å®¹ç±»ä¼¼ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// Code generated by Wire. DO NOT EDIT.</span><span class="hljs-comment">//go:build !wireinject</span><span class="hljs-comment">// +build !wireinject</span><span class="hljs-keyword">package</span> main<span class="hljs-comment">// InitializeApp æ˜¯æˆ‘ä»¬çš„ä¾èµ–æ³¨å…¥å‡½æ•°</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitializeApp</span><span class="hljs-params">()</span> *<span class="hljs-title">App</span></span> &#123;    db := NewDB()    userRepository := NewUserRepository(db)    userService := NewUserService(userRepository)    app := NewApp(userService)    <span class="hljs-keyword">return</span> app&#125;</code></pre><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>main.go</code>ä¸­çš„<code>main</code>å‡½æ•°ï¼Œä½¿ç”¨ç”Ÿæˆçš„<code>InitializeApp</code>å‡½æ•°ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    app := InitializeApp()    fmt.Printf(<span class="hljs-string">&quot;App created: %v\n&quot;</span>, app)&#125;</code></pre><p>è¿™å°±æ˜¯Wireçš„åŸºæœ¬ç”¨æ³• - å®ƒè‡ªåŠ¨ç¡®å®šåˆ›å»ºå¯¹è±¡çš„æ­£ç¡®é¡ºåºï¼Œå¹¶ç”Ÿæˆå¿…è¦çš„ä»£ç ã€‚</p><h3 id="ğŸ§©-Wireçš„é«˜çº§åŠŸèƒ½"><a class="header-anchor" href="#ğŸ§©-Wireçš„é«˜çº§åŠŸèƒ½"></a>ğŸ§© Wireçš„é«˜çº§åŠŸèƒ½</h3><h4 id="1-Provider-Sets"><a class="header-anchor" href="#1-Provider-Sets"></a>1. Provider Sets</h4><p>åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œä¾èµ–å…³ç³»å¯èƒ½éå¸¸å¤æ‚ã€‚Wireæä¾›äº†<code>ProviderSet</code>æ¥ç»„ç»‡å’Œé‡ç”¨ä¾èµ–æä¾›è€…ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">var</span> DBSet = wire.NewSet(NewDB)<span class="hljs-keyword">var</span> RepositorySet = wire.NewSet(NewUserRepository)<span class="hljs-keyword">var</span> ServiceSet = wire.NewSet(NewUserService)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitializeApp</span><span class="hljs-params">()</span> *<span class="hljs-title">App</span></span> &#123;    wire.Build(DBSet, RepositorySet, ServiceSet, NewApp)    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><p>è¿™ç§æ–¹å¼æœ‰åŠ©äºæ¨¡å—åŒ–ä¾èµ–é…ç½®ï¼Œç‰¹åˆ«æ˜¯åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ã€‚</p><h4 id="2-æ¥å£ç»‘å®š"><a class="header-anchor" href="#2-æ¥å£ç»‘å®š"></a>2. æ¥å£ç»‘å®š</h4><p>Wireæ”¯æŒå°†å…·ä½“å®ç°ç»‘å®šåˆ°æ¥å£ä¸Šï¼Œè¿™å¯¹äºéµå¾ªä¾èµ–å€’ç½®åŸåˆ™éå¸¸æœ‰ç”¨ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> UserRepositoryInterface <span class="hljs-keyword">interface</span> &#123;    FindByID(id <span class="hljs-keyword">int</span>) <span class="hljs-keyword">string</span>&#125;<span class="hljs-comment">// ç¡®ä¿UserRepositoryå®ç°äº†æ¥å£</span><span class="hljs-keyword">var</span> _ UserRepositoryInterface = (*UserRepository)(<span class="hljs-literal">nil</span>)<span class="hljs-keyword">var</span> RepositorySet = wire.NewSet(    NewUserRepository,    <span class="hljs-comment">// å°†UserRepositoryç»‘å®šåˆ°UserRepositoryInterface</span>    wire.Bind(<span class="hljs-built_in">new</span>(UserRepositoryInterface), <span class="hljs-built_in">new</span>(*UserRepository)),)</code></pre><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨UserServiceä¸­ä¾èµ–æ¥å£è€Œä¸æ˜¯å…·ä½“å®ç°ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span> &#123;    repo UserRepositoryInterface&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserService</span><span class="hljs-params">(repo UserRepositoryInterface)</span> *<span class="hljs-title">UserService</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;UserService&#123;repo: repo&#125;&#125;</code></pre><h4 id="3-å€¼æä¾›è€…"><a class="header-anchor" href="#3-å€¼æä¾›è€…"></a>3. å€¼æä¾›è€…</h4><p>é™¤äº†æ„é€ å‡½æ•°å¤–ï¼ŒWireè¿˜æ”¯æŒæä¾›å¸¸é‡æˆ–é…ç½®å€¼ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ProvideConnectionString</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user:password@tcp(localhost:3306)/mydb&quot;</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDB</span><span class="hljs-params">(connectionString <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">DB</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;DB&#123;ConnectionString: connectionString&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitializeApp</span><span class="hljs-params">()</span> *<span class="hljs-title">App</span></span> &#123;    wire.Build(        ProvideConnectionString,        NewDB,        <span class="hljs-comment">// ...å…¶ä»–æä¾›è€…</span>    )    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="4-æ¸…ç†å‡½æ•°"><a class="header-anchor" href="#4-æ¸…ç†å‡½æ•°"></a>4. æ¸…ç†å‡½æ•°</h4><p>æŸäº›èµ„æºåœ¨åº”ç”¨ç¨‹åºå…³é—­æ—¶éœ€è¦é‡Šæ”¾ã€‚Wireæ”¯æŒè¿”å›æ¸…ç†å‡½æ•°ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDB</span><span class="hljs-params">()</span> <span class="hljs-params">(*DB, <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;    db := &amp;DB&#123;ConnectionString: <span class="hljs-string">&quot;...&quot;</span>&#125;        <span class="hljs-comment">// è¿”å›æ¸…ç†å‡½æ•°</span>    cleanup := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        fmt.Println(<span class="hljs-string">&quot;Closing database connection...&quot;</span>)        <span class="hljs-comment">// å…³é—­è¿æ¥çš„ä»£ç </span>    &#125;        <span class="hljs-keyword">return</span> db, cleanup, <span class="hljs-literal">nil</span>&#125;</code></pre><p>Wireä¼šè‡ªåŠ¨æ”¶é›†å’Œè°ƒç”¨è¿™äº›æ¸…ç†å‡½æ•°ã€‚</p><h3 id="ğŸ“-Wireåœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨"><a class="header-anchor" href="#ğŸ“-Wireåœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨"></a>ğŸ“ Wireåœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨</h3><p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæŒ‰ç…§ä»¥ä¸‹æ–¹å¼ç»„ç»‡ä»£ç ï¼š</p><ol><li><strong>åˆ†å±‚ç»“æ„</strong>ï¼šå°†ä»£ç åˆ†ä¸ºæ•°æ®è®¿é—®å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚å’Œè¡¨ç¤ºå±‚</li><li><strong>æ¯å±‚å®šä¹‰è‡ªå·±çš„Provider Set</strong>ï¼šä¾¿äºæ¨¡å—åŒ–å’Œæ›¿æ¢</li><li><strong>åœ¨å…¥å£ç‚¹ç»„åˆProvider Sets</strong>ï¼šé€šå¸¸æ˜¯<code>main</code>åŒ…æˆ–å‘½ä»¤åŒ…</li></ol><p>ä¾‹å¦‚ï¼Œä¸€ä¸ªå…¸å‹çš„Webåº”ç”¨ä¾èµ–å›¾å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p><pre><code class="hljs">App â”œâ”€â”€ HTTPæœåŠ¡å™¨ â”‚    â””â”€â”€ è·¯ç”±å™¨ â”‚         â””â”€â”€ æ§åˆ¶å™¨ â”‚              â””â”€â”€ æœåŠ¡ â”‚                   â””â”€â”€ ä»“åº“ â”‚                        â””â”€â”€ æ•°æ®åº“ â””â”€â”€ é…ç½®</code></pre><p>ä½¿ç”¨Wireï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾ç®¡ç†è¿™äº›ä¾èµ–ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// config/wire.go</span><span class="hljs-keyword">package</span> config<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/google/wire&quot;</span><span class="hljs-keyword">var</span> ConfigSet = wire.NewSet(    ProvideConfig,    ProvideDBConfig,    <span class="hljs-comment">// ...å…¶ä»–é…ç½®æä¾›è€…</span>)<span class="hljs-comment">// repository/wire.go</span><span class="hljs-keyword">package</span> repository<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/google/wire&quot;</span><span class="hljs-keyword">var</span> RepositorySet = wire.NewSet(    NewUserRepository,    NewProductRepository,    <span class="hljs-comment">// ...å…¶ä»–ä»“åº“</span>)<span class="hljs-comment">// service/wire.go</span><span class="hljs-keyword">package</span> service<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/google/wire&quot;</span><span class="hljs-keyword">var</span> ServiceSet = wire.NewSet(    NewUserService,    NewProductService,    <span class="hljs-comment">// ...å…¶ä»–æœåŠ¡</span>)<span class="hljs-comment">// main.go æˆ– cmd/server/main.go</span><span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;myapp/config&quot;</span>    <span class="hljs-string">&quot;myapp/repository&quot;</span>    <span class="hljs-string">&quot;myapp/service&quot;</span>    <span class="hljs-comment">// ...</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitializeApp</span><span class="hljs-params">()</span> *<span class="hljs-title">App</span></span> &#123;    wire.Build(        config.ConfigSet,        repository.RepositorySet,        service.ServiceSet,        <span class="hljs-comment">// ...</span>        NewApp,    )    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h3 id="ğŸ”§-æµ‹è¯•ä¸­çš„ä¾èµ–æ³¨å…¥"><a class="header-anchor" href="#ğŸ”§-æµ‹è¯•ä¸­çš„ä¾èµ–æ³¨å…¥"></a>ğŸ”§ æµ‹è¯•ä¸­çš„ä¾èµ–æ³¨å…¥</h3><p>Wireçš„ä¸€ä¸ªä¸»è¦ä¼˜åŠ¿æ˜¯ä¾¿äºæµ‹è¯•ã€‚æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°æ³¨å…¥mockå¯¹è±¡ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestUserService</span><span class="hljs-params">(t *testing.T)</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºä»“åº“çš„mock</span>    mockRepo := &amp;MockUserRepository&#123;&#125;    mockRepo.On(<span class="hljs-string">&quot;FindByID&quot;</span>, <span class="hljs-number">1</span>).Return(<span class="hljs-string">&quot;test user&quot;</span>)        <span class="hljs-comment">// æ³¨å…¥mockåˆ°æœåŠ¡</span>    service := NewUserService(mockRepo)        <span class="hljs-comment">// æµ‹è¯•æœåŠ¡</span>    result := service.GetUserByID(<span class="hljs-number">1</span>)    assert.Equal(t, <span class="hljs-string">&quot;test user&quot;</span>, result)&#125;</code></pre><h3 id="ğŸ‘-æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸ‘-æœ€ä½³å®è·µ"></a>ğŸ‘ æœ€ä½³å®è·µ</h3><ol><li><strong>ä¿æŒæä¾›è€…å‡½æ•°ç®€å•</strong>ï¼šæ¯ä¸ªå‡½æ•°åªè´Ÿè´£åˆ›å»ºä¸€ä¸ªç»„ä»¶</li><li><strong>ä½¿ç”¨æ¥å£è€Œéå…·ä½“ç±»å‹</strong>ï¼šéµå¾ªä¾èµ–å€’ç½®åŸåˆ™</li><li><strong>æ¨¡å—åŒ–Provider Sets</strong>ï¼šæŒ‰åŠŸèƒ½æˆ–æ¨¡å—ç»„ç»‡ä¾èµ–</li><li><strong>å¤„ç†é”™è¯¯</strong>ï¼šæä¾›è€…å‡½æ•°åº”è¿”å›é”™è¯¯ï¼Œè€Œä¸æ˜¯åœ¨å†…éƒ¨å¤„ç†</li><li><strong>é¿å…å…¨å±€çŠ¶æ€</strong>ï¼šæ‰€æœ‰ä¾èµ–éƒ½åº”é€šè¿‡å‚æ•°ä¼ é€’</li><li><strong>æä¾›æ¸…æ™°çš„æ–‡æ¡£</strong>ï¼šè¯´æ˜æ¯ä¸ªç»„ä»¶çš„ä½œç”¨å’Œä¾èµ–å…³ç³»</li></ol><h3 id="ğŸ“‹-æ€»ç»“"><a class="header-anchor" href="#ğŸ“‹-æ€»ç»“"></a>ğŸ“‹ æ€»ç»“</h3><p>Wireæä¾›äº†ä¸€ç§ç¼–è¯‘æ—¶ä¾èµ–æ³¨å…¥çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒæ—¢ä¿æŒäº†Goè¯­è¨€çš„ç®€æ´æ€§ï¼Œåˆè§£å†³äº†å¤§å‹åº”ç”¨ä¸­çš„ä¾èµ–ç®¡ç†é—®é¢˜ã€‚ä½¿ç”¨Wireï¼Œæˆ‘ä»¬å¯ä»¥ï¼š</p><ul><li>è‡ªåŠ¨ç®¡ç†å¤æ‚çš„ä¾èµ–å…³ç³»</li><li>ç¼–å†™æ›´æ¨¡å—åŒ–ã€å¯æµ‹è¯•çš„ä»£ç </li><li>é¿å…è¿è¡Œæ—¶åå°„å¸¦æ¥çš„æ€§èƒ½å¼€é”€</li><li>åœ¨ç¼–è¯‘æ—¶æ•è·ä¾èµ–é…ç½®é”™è¯¯</li></ul><p>éšç€åº”ç”¨ç¨‹åºè§„æ¨¡çš„å¢é•¿ï¼Œä¾èµ–æ³¨å…¥å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚Wireæ˜¯Goè¯­è¨€ç”Ÿæ€ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå®è´µå·¥å…·ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ„å»ºæ›´åŠ å¥å£®å’Œå¯ç»´æŠ¤çš„åº”ç”¨ç¨‹åºã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>wire</tag>
      
      <tag>ä¾èµ–æ³¨å…¥</tag>
      
      <tag>DI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang åˆ‡ç‰‡åº•å±‚åŸç†ä¸ä¼˜åŒ–æŠ€å·§</title>
    <link href="/2024/03/15/golang-%E5%88%87%E7%89%87%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E4%B8%8E%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7/"/>
    <url>/2024/03/15/golang-%E5%88%87%E7%89%87%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E4%B8%8E%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ”ª-golang-åˆ‡ç‰‡åº•å±‚åŸç†ä¸ä¼˜åŒ–æŠ€å·§"><a class="header-anchor" href="#ğŸ”ª-golang-åˆ‡ç‰‡åº•å±‚åŸç†ä¸ä¼˜åŒ–æŠ€å·§"></a>ğŸ”ª golang åˆ‡ç‰‡åº•å±‚åŸç†ä¸ä¼˜åŒ–æŠ€å·§</h2><p>åˆ‡ç‰‡ï¼ˆsliceï¼‰æ˜¯ Go è¯­è¨€ä¸­æœ€å¸¸ç”¨çš„æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œå®ƒæä¾›äº†æ¯”æ•°ç»„æ›´çµæ´»çš„æ“ä½œæ–¹å¼ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨åˆ‡ç‰‡çš„åº•å±‚å®ç°åŸç†ï¼Œä»¥åŠå¦‚ä½•ä¼˜åŒ–åˆ‡ç‰‡æ“ä½œä»¥æé«˜ç¨‹åºæ€§èƒ½ã€‚</p><h3 id="ğŸ§©-åˆ‡ç‰‡çš„åº•å±‚ç»“æ„"><a class="header-anchor" href="#ğŸ§©-åˆ‡ç‰‡çš„åº•å±‚ç»“æ„"></a>ğŸ§© åˆ‡ç‰‡çš„åº•å±‚ç»“æ„</h3><p>åˆ‡ç‰‡æœ¬è´¨ä¸Šæ˜¯å¯¹åº•å±‚æ•°ç»„çš„å¼•ç”¨ï¼Œå®ƒç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> slice <span class="hljs-keyword">struct</span> &#123;    array unsafe.Pointer <span class="hljs-comment">// æŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆ</span>    <span class="hljs-built_in">len</span>   <span class="hljs-keyword">int</span>            <span class="hljs-comment">// åˆ‡ç‰‡çš„é•¿åº¦</span>    <span class="hljs-built_in">cap</span>   <span class="hljs-keyword">int</span>            <span class="hljs-comment">// åˆ‡ç‰‡çš„å®¹é‡</span>&#125;</code></pre><p>è¿™ä¸ªç»“æ„åœ¨è¿è¡Œæ—¶åŒ…ä¸­å®šä¹‰ï¼Œè™½ç„¶æˆ‘ä»¬åœ¨æ—¥å¸¸ç¼–ç ä¸­ä¸ä¼šç›´æ¥ä½¿ç”¨å®ƒï¼Œä½†ç†è§£è¿™ä¸ªç»“æ„å¯¹ä¼˜åŒ–åˆ‡ç‰‡æ“ä½œéå¸¸é‡è¦ã€‚</p><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º3çš„åˆ‡ç‰‡</span>    s1 := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;    fmt.Printf(<span class="hljs-string">&quot;s1: %v, len: %d, cap: %d\n&quot;</span>, s1, <span class="hljs-built_in">len</span>(s1), <span class="hljs-built_in">cap</span>(s1))        <span class="hljs-comment">// æˆªå–ä¸€ä¸ªæ–°åˆ‡ç‰‡</span>    s2 := s1[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>]    fmt.Printf(<span class="hljs-string">&quot;s2: %v, len: %d, cap: %d\n&quot;</span>, s2, <span class="hljs-built_in">len</span>(s2), <span class="hljs-built_in">cap</span>(s2))        <span class="hljs-comment">// ä¿®æ”¹s2ï¼Œè§‚å¯Ÿs1çš„å˜åŒ–</span>    s2[<span class="hljs-number">0</span>] = <span class="hljs-number">22</span>    fmt.Printf(<span class="hljs-string">&quot;s1: %v\n&quot;</span>, s1)    fmt.Printf(<span class="hljs-string">&quot;s2: %v\n&quot;</span>, s2)&#125;</code></pre><p>è¾“å‡ºç»“æœï¼š</p><pre><code class="hljs yaml"><span class="hljs-attr">s1:</span> [<span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span>]<span class="hljs-string">,</span> <span class="hljs-attr">len:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span> <span class="hljs-attr">cap:</span> <span class="hljs-number">3</span><span class="hljs-attr">s2:</span> [<span class="hljs-number">2</span> <span class="hljs-number">3</span>]<span class="hljs-string">,</span> <span class="hljs-attr">len:</span> <span class="hljs-number">2</span><span class="hljs-string">,</span> <span class="hljs-attr">cap:</span> <span class="hljs-number">2</span><span class="hljs-attr">s1:</span> [<span class="hljs-number">1</span> <span class="hljs-number">22</span> <span class="hljs-number">3</span>]<span class="hljs-attr">s2:</span> [<span class="hljs-number">22</span> <span class="hljs-number">3</span>]</code></pre><p>è¿™ä¸ªä¾‹å­å±•ç¤ºäº†é‡è¦çš„ä¸€ç‚¹ï¼š<strong>åˆ‡ç‰‡ä¹‹é—´å…±äº«åº•å±‚æ•°ç»„</strong>ï¼Œä¿®æ”¹ä¸€ä¸ªåˆ‡ç‰‡ä¼šå½±å“åˆ°å…¶ä»–å…±äº«åŒä¸€åº•å±‚æ•°ç»„çš„åˆ‡ç‰‡ã€‚</p><h3 id="ğŸš€-åˆ‡ç‰‡æ‰©å®¹æœºåˆ¶"><a class="header-anchor" href="#ğŸš€-åˆ‡ç‰‡æ‰©å®¹æœºåˆ¶"></a>ğŸš€ åˆ‡ç‰‡æ‰©å®¹æœºåˆ¶</h3><p>å½“åˆ‡ç‰‡çš„å®¹é‡ä¸è¶³ä»¥å®¹çº³æ›´å¤šå…ƒç´ æ—¶ï¼ŒGo ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ã€æ›´å¤§çš„åº•å±‚æ•°ç»„ï¼Œå¹¶å°†åŸåˆ‡ç‰‡çš„å†…å®¹å¤åˆ¶è¿‡å»ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºæ‰©å®¹ã€‚</p><p>ä» Go 1.18 å¼€å§‹ï¼Œåˆ‡ç‰‡æ‰©å®¹ç­–ç•¥å¦‚ä¸‹ï¼š</p><ul><li>å¦‚æœæ–°å®¹é‡ï¼ˆæ‰€éœ€çš„æœ€å°å®¹é‡ï¼‰å¤§äºå½“å‰å®¹é‡çš„ä¸¤å€ï¼Œåˆ™ç›´æ¥ä½¿ç”¨æ–°å®¹é‡</li><li>å¦‚æœå½“å‰å®¹é‡å°äº 256ï¼Œåˆ™æ–°å®¹é‡ä¸ºå½“å‰å®¹é‡çš„ 2 å€</li><li>å¦‚æœå½“å‰å®¹é‡å¤§äºç­‰äº 256ï¼Œåˆ™æ–°å®¹é‡ä¸ºå½“å‰å®¹é‡çš„ 1.25 å€ï¼Œç›´åˆ°æ»¡è¶³æ‰€éœ€å®¹é‡</li></ul><p>ä»¥ä¸‹ä»£ç æ¼”ç¤ºäº†åˆ‡ç‰‡æ‰©å®¹è¿‡ç¨‹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (<span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-string">&quot;reflect&quot;</span><span class="hljs-string">&quot;unsafe&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;s := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">0</span>)<span class="hljs-comment">// è·å–åˆ‡ç‰‡çš„å†…éƒ¨æ•°ç»„åœ°å€</span>getPointer := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s []<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">uintptr</span></span> &#123;<span class="hljs-keyword">return</span> reflect.ValueOf(s).Pointer()&#125;fmt.Printf(<span class="hljs-string">&quot;åˆå§‹ï¼š%p, å†…éƒ¨åœ°å€ï¼š%x\n&quot;</span>, &amp;s, getPointer(s))<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;s = <span class="hljs-built_in">append</span>(s, i)fmt.Printf(<span class="hljs-string">&quot;append %d å: len=%d, cap=%d, å†…éƒ¨åœ°å€ï¼š%x\n&quot;</span>, i, <span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s), getPointer(s))&#125;&#125;</code></pre><p>è¾“å‡ºç±»ä¼¼ï¼š</p><pre><code class="hljs routeros">åˆå§‹ï¼š0xc000012028, å†…éƒ¨åœ°å€ï¼š0append 0 å: <span class="hljs-attribute">len</span>=1, <span class="hljs-attribute">cap</span>=1, å†…éƒ¨åœ°å€ï¼šc0000180f0append 1 å: <span class="hljs-attribute">len</span>=2, <span class="hljs-attribute">cap</span>=2, å†…éƒ¨åœ°å€ï¼šc000018100append 2 å: <span class="hljs-attribute">len</span>=3, <span class="hljs-attribute">cap</span>=4, å†…éƒ¨åœ°å€ï¼šc000018120append 3 å: <span class="hljs-attribute">len</span>=4, <span class="hljs-attribute">cap</span>=4, å†…éƒ¨åœ°å€ï¼šc000018120append 4 å: <span class="hljs-attribute">len</span>=5, <span class="hljs-attribute">cap</span>=8, å†…éƒ¨åœ°å€ï¼šc000018180append 5 å: <span class="hljs-attribute">len</span>=6, <span class="hljs-attribute">cap</span>=8, å†…éƒ¨åœ°å€ï¼šc000018180append 6 å: <span class="hljs-attribute">len</span>=7, <span class="hljs-attribute">cap</span>=8, å†…éƒ¨åœ°å€ï¼šc000018180append 7 å: <span class="hljs-attribute">len</span>=8, <span class="hljs-attribute">cap</span>=8, å†…éƒ¨åœ°å€ï¼šc000018180append 8 å: <span class="hljs-attribute">len</span>=9, <span class="hljs-attribute">cap</span>=16, å†…éƒ¨åœ°å€ï¼šc000046000append 9 å: <span class="hljs-attribute">len</span>=10, <span class="hljs-attribute">cap</span>=16, å†…éƒ¨åœ°å€ï¼šc000046000</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“å®¹é‡ä¸è¶³æ—¶ï¼Œå†…éƒ¨åœ°å€ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¡¨æ˜åº•å±‚æ•°ç»„è¢«é‡æ–°åˆ†é…ã€‚</p><h3 id="âš™ï¸-åˆ‡ç‰‡æ“ä½œæ€§èƒ½ä¼˜åŒ–æŠ€å·§"><a class="header-anchor" href="#âš™ï¸-åˆ‡ç‰‡æ“ä½œæ€§èƒ½ä¼˜åŒ–æŠ€å·§"></a>âš™ï¸ åˆ‡ç‰‡æ“ä½œæ€§èƒ½ä¼˜åŒ–æŠ€å·§</h3><h4 id="1-é¢„åˆ†é…å†…å­˜"><a class="header-anchor" href="#1-é¢„åˆ†é…å†…å­˜"></a>1. é¢„åˆ†é…å†…å­˜</h4><p>å½“ä½ çŸ¥é“åˆ‡ç‰‡çš„å¤§è‡´å¤§å°æ—¶ï¼Œä½¿ç”¨ <code>make()</code> é¢„å…ˆåˆ†é…å®¹é‡å¯ä»¥é¿å…å¤šæ¬¡æ‰©å®¹ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä½æ•ˆæ–¹å¼ - å¯èƒ½å¯¼è‡´å¤šæ¬¡æ‰©å®¹</span>s := []<span class="hljs-keyword">int</span>&#123;&#125;<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++ &#123;    s = <span class="hljs-built_in">append</span>(s, i)&#125;<span class="hljs-comment">// é«˜æ•ˆæ–¹å¼ - ä¸€æ¬¡æ€§åˆ†é…è¶³å¤Ÿå®¹é‡</span>s := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10000</span>)<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++ &#123;    s = <span class="hljs-built_in">append</span>(s, i)&#125;</code></pre><h4 id="2-è°¨æ…ä½¿ç”¨-append-è¿”å›å€¼"><a class="header-anchor" href="#2-è°¨æ…ä½¿ç”¨-append-è¿”å›å€¼"></a>2. è°¨æ…ä½¿ç”¨ append è¿”å›å€¼</h4><p><code>append</code> å‡½æ•°å¯èƒ½ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘æ–°åº•å±‚æ•°ç»„çš„åˆ‡ç‰‡ï¼Œæ€»æ˜¯ä½¿ç”¨è¿”å›å€¼è€Œä¸æ˜¯åŸåˆ‡ç‰‡ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æ­£ç¡®çš„æ–¹å¼</span>s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">100</span>)<span class="hljs-comment">// é”™è¯¯çš„æ–¹å¼ - sä¸ä¼šåŒ…å«æ–°æ·»åŠ çš„å…ƒç´ </span><span class="hljs-built_in">append</span>(s, <span class="hljs-number">100</span>)</code></pre><h4 id="3-åˆç†ä½¿ç”¨-copy-å‡½æ•°"><a class="header-anchor" href="#3-åˆç†ä½¿ç”¨-copy-å‡½æ•°"></a>3. åˆç†ä½¿ç”¨ copy å‡½æ•°</h4><p><code>copy</code> å‡½æ•°å¯ä»¥æœ‰æ•ˆé¿å…åˆ‡ç‰‡ä¹‹é—´çš„æ„å¤–å…±äº«ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// åˆ›å»ºs1çš„å®Œæ•´å‰¯æœ¬ï¼Œä¸¤ä¸ªåˆ‡ç‰‡ä¸å…±äº«åº•å±‚æ•°ç»„</span>s2 := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-built_in">len</span>(s1))<span class="hljs-built_in">copy</span>(s2, s1)</code></pre><h4 id="4-é¿å…åœ¨å¾ªç¯ä¸­åå¤æ‰©å®¹"><a class="header-anchor" href="#4-é¿å…åœ¨å¾ªç¯ä¸­åå¤æ‰©å®¹"></a>4. é¿å…åœ¨å¾ªç¯ä¸­åå¤æ‰©å®¹</h4><pre><code class="hljs go"><span class="hljs-comment">// ä½æ•ˆ - bytes.Bufferä¼šåœ¨å†…éƒ¨å¤šæ¬¡æ‰©å®¹</span><span class="hljs-keyword">var</span> b bytes.Buffer<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;    fmt.Fprintf(&amp;b, <span class="hljs-string">&quot;ç¬¬%dè¡Œ\n&quot;</span>, i)&#125;<span class="hljs-comment">// é«˜æ•ˆ - é¢„ä¼°å¤§å°å¹¶ä¸€æ¬¡æ€§åˆ†é…</span><span class="hljs-keyword">var</span> b bytes.Bufferb.Grow(<span class="hljs-number">1000</span>) <span class="hljs-comment">// é¢„åˆ†é…è¶³å¤Ÿç©ºé—´</span><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;    fmt.Fprintf(&amp;b, <span class="hljs-string">&quot;ç¬¬%dè¡Œ\n&quot;</span>, i)&#125;</code></pre><h4 id="5-ä½¿ç”¨-clear-å‡½æ•°æ¸…ç©ºåˆ‡ç‰‡ï¼ˆGo-1-21-ï¼‰"><a class="header-anchor" href="#5-ä½¿ç”¨-clear-å‡½æ•°æ¸…ç©ºåˆ‡ç‰‡ï¼ˆGo-1-21-ï¼‰"></a>5. ä½¿ç”¨ clear å‡½æ•°æ¸…ç©ºåˆ‡ç‰‡ï¼ˆGo 1.21+ï¼‰</h4><p>ä» Go 1.21 å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>clear</code> å‡½æ•°å¿«é€Ÿæ¸…ç©ºåˆ‡ç‰‡ï¼š</p><pre><code class="hljs go">s := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;clear(s) <span class="hljs-comment">// å°†åˆ‡ç‰‡æ‰€æœ‰å…ƒç´ ç½®ä¸ºé›¶å€¼ï¼Œä¿æŒé•¿åº¦ä¸å˜</span>fmt.Println(s) <span class="hljs-comment">// [0 0 0 0 0]</span></code></pre><h3 id="ğŸ“ˆ-åˆ‡ç‰‡æ“ä½œçš„æ€§èƒ½å¯¹æ¯”"><a class="header-anchor" href="#ğŸ“ˆ-åˆ‡ç‰‡æ“ä½œçš„æ€§èƒ½å¯¹æ¯”"></a>ğŸ“ˆ åˆ‡ç‰‡æ“ä½œçš„æ€§èƒ½å¯¹æ¯”</h3><p>ä»¥ä¸‹æ˜¯å¸¸è§åˆ‡ç‰‡æ“ä½œçš„æ€§èƒ½å¯¹æ¯”ï¼š</p><table><thead><tr><th>æ“ä½œ</th><th>æ—¶é—´å¤æ‚åº¦</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>è®¿é—®å…ƒç´ </td><td>O(1)</td><td>éšæœºè®¿é—®ï¼Œæ€§èƒ½æä½³</td></tr><tr><td>append ä¸æ‰©å®¹</td><td>O(1)</td><td>æ·»åŠ å•ä¸ªå…ƒç´ ï¼Œæ— éœ€æ‰©å®¹</td></tr><tr><td>append æ‰©å®¹</td><td>O(n)</td><td>éœ€è¦å¤åˆ¶æ‰€æœ‰å…ƒç´ åˆ°æ–°æ•°ç»„</td></tr><tr><td>åˆ é™¤å…ƒç´ </td><td>O(n)</td><td>éœ€è¦ç§»åŠ¨åˆ é™¤ä½ç½®åçš„æ‰€æœ‰å…ƒç´ </td></tr><tr><td>æ’å…¥å…ƒç´ </td><td>O(n)</td><td>éœ€è¦ç§»åŠ¨æ’å…¥ä½ç½®åçš„æ‰€æœ‰å…ƒç´ </td></tr></tbody></table><h3 id="ğŸ§ -å¸¸è§é™·é˜±å’Œæ³¨æ„äº‹é¡¹"><a class="header-anchor" href="#ğŸ§ -å¸¸è§é™·é˜±å’Œæ³¨æ„äº‹é¡¹"></a>ğŸ§  å¸¸è§é™·é˜±å’Œæ³¨æ„äº‹é¡¹</h3><ol><li><strong>åˆ‡ç‰‡ä½œä¸ºå‡½æ•°å‚æ•°</strong></li></ol><p>åˆ‡ç‰‡ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’æ—¶æ˜¯æŒ‰å€¼ä¼ é€’çš„ï¼Œä½†ç”±äºåˆ‡ç‰‡åŒ…å«æŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆï¼Œå› æ­¤å‡½æ•°å†…éƒ¨å¯¹åˆ‡ç‰‡å…ƒç´ çš„ä¿®æ”¹ä¼šå½±å“åŸåˆ‡ç‰‡ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">modifySlice</span><span class="hljs-params">(s []<span class="hljs-keyword">int</span>)</span></span> &#123;    s[<span class="hljs-number">0</span>] = <span class="hljs-number">999</span> <span class="hljs-comment">// åŸåˆ‡ç‰‡çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¹Ÿä¼šè¢«ä¿®æ”¹</span>    s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">1000</span>) <span class="hljs-comment">// è¿™é‡Œå¯èƒ½åˆ›å»ºæ–°æ•°ç»„ï¼Œä¸å½±å“åŸåˆ‡ç‰‡é•¿åº¦</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    s := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;    modifySlice(s)    fmt.Println(s) <span class="hljs-comment">// è¾“å‡º [999 2 3]ï¼Œè€Œä¸æ˜¯ [999 2 3 1000]</span>&#125;</code></pre><ol start="2"><li><strong>nilåˆ‡ç‰‡ä¸ç©ºåˆ‡ç‰‡</strong></li></ol><pre><code class="hljs go"><span class="hljs-keyword">var</span> nilSlice []<span class="hljs-keyword">int</span>          <span class="hljs-comment">// nilåˆ‡ç‰‡ï¼Œlen=0, cap=0, æŒ‡é’ˆä¸ºnil</span>emptySlice := []<span class="hljs-keyword">int</span>&#123;&#125;       <span class="hljs-comment">// ç©ºåˆ‡ç‰‡ï¼Œlen=0, cap=0, æŒ‡é’ˆä¸ä¸ºnil</span>makeSlice := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// ç©ºåˆ‡ç‰‡ï¼Œlen=0, cap=0, æŒ‡é’ˆä¸ä¸ºnil</span>fmt.Println(nilSlice == <span class="hljs-literal">nil</span>)   <span class="hljs-comment">// true</span>fmt.Println(emptySlice == <span class="hljs-literal">nil</span>) <span class="hljs-comment">// false</span>fmt.Println(makeSlice == <span class="hljs-literal">nil</span>)  <span class="hljs-comment">// false</span></code></pre><p>è™½ç„¶åœ¨åŠŸèƒ½ä¸Šå‡ ä¹ä¸€æ ·ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼ˆå¦‚JSONåºåˆ—åŒ–ï¼‰è¡¨ç°ä¸åŒã€‚</p><h3 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h3><p>ç†è§£åˆ‡ç‰‡çš„åº•å±‚åŸç†æ˜¯ç¼–å†™é«˜æ•ˆGoç¨‹åºçš„å…³é”®ã€‚è®°ä½ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>åˆ‡ç‰‡æ˜¯å¯¹æ•°ç»„çš„å¼•ç”¨ï¼Œå¤šä¸ªåˆ‡ç‰‡å¯èƒ½å…±äº«åŒä¸€æ•°ç»„</li><li>é¢„å…ˆåˆ†é…è¶³å¤Ÿçš„å®¹é‡å¯ä»¥é¿å…é¢‘ç¹æ‰©å®¹</li><li>åˆ é™¤æˆ–æ’å…¥æ“ä½œå¯èƒ½å¯¼è‡´æ€§èƒ½ç“¶é¢ˆ</li><li>åˆ‡ç‰‡ä½œä¸ºå‡½æ•°å‚æ•°æ—¶ï¼Œéœ€è¦æ³¨æ„appendæ“ä½œå¸¦æ¥çš„å½±å“</li></ol><p>é€šè¿‡åˆç†ä½¿ç”¨è¿™äº›æŠ€å·§ï¼Œä½ å¯ä»¥å……åˆ†åˆ©ç”¨Goåˆ‡ç‰‡çš„ä¼˜åŠ¿ï¼ŒåŒæ—¶é¿å…å¸¸è§çš„æ€§èƒ½é™·é˜±ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>slice</tag>
      
      <tag>æ€§èƒ½ä¼˜åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang å¹¶å‘å®‰å…¨çš„mapå®ç°è¯¦è§£</title>
    <link href="/2024/03/05/golang-%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8%E7%9A%84map%E5%AE%9E%E7%8E%B0%E8%AF%A6%E8%A7%A3/"/>
    <url>/2024/03/05/golang-%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8%E7%9A%84map%E5%AE%9E%E7%8E%B0%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ”-golang-ä¸­å¹¶å‘å®‰å…¨çš„mapå®ç°è¯¦è§£"><a class="header-anchor" href="#ğŸ”-golang-ä¸­å¹¶å‘å®‰å…¨çš„mapå®ç°è¯¦è§£"></a>ğŸ” golang ä¸­å¹¶å‘å®‰å…¨çš„mapå®ç°è¯¦è§£</h2><p>åœ¨Goè¯­è¨€ä¸­ï¼Œå†…ç½®çš„<code>map</code>ç±»å‹ä¸æ˜¯å¹¶å‘å®‰å…¨çš„ã€‚å¦‚æœåœ¨å¤šä¸ªgoroutineä¸­åŒæ—¶è¯»å†™ä¸€ä¸ªmapï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚æœ¬æ–‡å°†ä»‹ç»å‡ ç§å®ç°å¹¶å‘å®‰å…¨mapçš„æ–¹æ³•ã€‚</p><h3 id="æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨-sync-Mutex-ä¿æŠ¤æ™®é€šmap"><a class="header-anchor" href="#æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨-sync-Mutex-ä¿æŠ¤æ™®é€šmap"></a>æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ sync.Mutex ä¿æŠ¤æ™®é€šmap</h3><p>æœ€ç®€å•ç›´æ¥çš„æ–¹æ³•æ˜¯ä½¿ç”¨äº’æ–¥é”æ¥ä¿æŠ¤å¯¹æ™®é€šmapçš„è®¿é—®ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (<span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-string">&quot;sync&quot;</span>)<span class="hljs-keyword">type</span> SafeMap <span class="hljs-keyword">struct</span> &#123;sync.Mutexdata <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewSafeMap</span><span class="hljs-params">()</span> *<span class="hljs-title">SafeMap</span></span> &#123;<span class="hljs-keyword">return</span> &amp;SafeMap&#123;data: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;),&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *SafeMap)</span> <span class="hljs-title">Set</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, value <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;m.Lock()<span class="hljs-keyword">defer</span> m.Unlock()m.data[key] = value&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *SafeMap)</span> <span class="hljs-title">Get</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-keyword">bool</span>)</span></span> &#123;m.Lock()<span class="hljs-keyword">defer</span> m.Unlock()value, ok := m.data[key]<span class="hljs-keyword">return</span> value, ok&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *SafeMap)</span> <span class="hljs-title">Delete</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span></span> &#123;m.Lock()<span class="hljs-keyword">defer</span> m.Unlock()<span class="hljs-built_in">delete</span>(m.data, key)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *SafeMap)</span> <span class="hljs-title">Range</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>(key <span class="hljs-keyword">string</span>, value <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span>)</span> &#123;m.Lock()<span class="hljs-keyword">defer</span> m.Unlock()<span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> m.data &#123;<span class="hljs-keyword">if</span> !f(k, v) &#123;<span class="hljs-keyword">break</span>&#125;&#125;&#125;</code></pre><p>è¿™ç§æ–¹æ³•ç®€å•æ˜“æ‡‚ï¼Œä½†å½“mapæ•°æ®é‡å¤§æˆ–è®¿é—®é¢‘ç¹æ—¶ï¼Œä½¿ç”¨å•ä¸€é”ä¼šå¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚</p><h3 id="æ–¹æ¡ˆäºŒï¼šä½¿ç”¨-sync-Map"><a class="header-anchor" href="#æ–¹æ¡ˆäºŒï¼šä½¿ç”¨-sync-Map"></a>æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ sync.Map</h3><p>ä»Go 1.9å¼€å§‹ï¼Œæ ‡å‡†åº“æä¾›äº†<code>sync.Map</code>ç±»å‹ï¼Œä¸“ä¸ºå¹¶å‘å®‰å…¨è€Œè®¾è®¡ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (<span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-string">&quot;sync&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">var</span> m sync.Map<span class="hljs-comment">// å†™å…¥</span>m.Store(<span class="hljs-string">&quot;key1&quot;</span>, <span class="hljs-string">&quot;value1&quot;</span>)m.Store(<span class="hljs-string">&quot;key2&quot;</span>, <span class="hljs-number">100</span>)<span class="hljs-comment">// è¯»å–</span>value, ok := m.Load(<span class="hljs-string">&quot;key1&quot;</span>)<span class="hljs-keyword">if</span> ok &#123;fmt.Println(<span class="hljs-string">&quot;key1:&quot;</span>, value)&#125;<span class="hljs-comment">// LoadOrStoreè¿”å›ç°æœ‰å€¼æˆ–å­˜å‚¨æ–°å€¼</span>actual, loaded := m.LoadOrStore(<span class="hljs-string">&quot;key2&quot;</span>, <span class="hljs-number">200</span>)fmt.Println(<span class="hljs-string">&quot;key2:&quot;</span>, actual, <span class="hljs-string">&quot;å·²å­˜åœ¨:&quot;</span>, loaded)<span class="hljs-comment">// éå†</span>m.Range(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(key, value <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span> &#123;fmt.Printf(<span class="hljs-string">&quot;%v: %v\n&quot;</span>, key, value)<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// è¿”å›falseä¼šä¸­æ–­éå†</span>&#125;)<span class="hljs-comment">// åˆ é™¤</span>m.Delete(<span class="hljs-string">&quot;key1&quot;</span>)&#125;</code></pre><p><code>sync.Map</code>æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>æ— éœ€åˆå§‹åŒ–ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨</li><li>é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯</li><li>ç©ºé—´æ¢æ—¶é—´çš„è®¾è®¡ï¼Œå†…éƒ¨ä½¿ç”¨äº†ä¸¤ä¸ªmapå’Œè‡ªæ—‹é”</li><li>å¯¹å¤§å¤šæ•°ä½¿ç”¨åœºæ™¯è¿›è¡Œäº†ä¼˜åŒ–</li></ul><h3 id="æ–¹æ¡ˆä¸‰ï¼šåˆ†ç‰‡é”-Sharded-Map"><a class="header-anchor" href="#æ–¹æ¡ˆä¸‰ï¼šåˆ†ç‰‡é”-Sharded-Map"></a>æ–¹æ¡ˆä¸‰ï¼šåˆ†ç‰‡é”(Sharded Map)</h3><p>å¯¹äºå†™å…¥é¢‘ç¹çš„åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨åˆ†ç‰‡é”ç­–ç•¥æ¥å‡å°‘é”ç«äº‰ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (<span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-string">&quot;hash/fnv&quot;</span><span class="hljs-string">&quot;sync&quot;</span>)<span class="hljs-keyword">const</span> shardCount = <span class="hljs-number">32</span><span class="hljs-keyword">type</span> ShardedMap <span class="hljs-keyword">struct</span> &#123;shards []*mapShard&#125;<span class="hljs-keyword">type</span> mapShard <span class="hljs-keyword">struct</span> &#123;sync.RWMutexdata <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewShardedMap</span><span class="hljs-params">()</span> *<span class="hljs-title">ShardedMap</span></span> &#123;m := &amp;ShardedMap&#123;shards: <span class="hljs-built_in">make</span>([]*mapShard, shardCount),&#125;<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; shardCount; i++ &#123;m.shards[i] = &amp;mapShard&#123;data: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;),&#125;&#125;<span class="hljs-keyword">return</span> m&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *ShardedMap)</span> <span class="hljs-title">getShard</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">mapShard</span></span> &#123;h := fnv.New32()h.Write([]<span class="hljs-keyword">byte</span>(key))<span class="hljs-keyword">return</span> m.shards[h.Sum32()%shardCount]&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *ShardedMap)</span> <span class="hljs-title">Set</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, value <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;shard := m.getShard(key)shard.Lock()<span class="hljs-keyword">defer</span> shard.Unlock()shard.data[key] = value&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *ShardedMap)</span> <span class="hljs-title">Get</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-keyword">bool</span>)</span></span> &#123;shard := m.getShard(key)shard.RLock()<span class="hljs-keyword">defer</span> shard.RUnlock()val, ok := shard.data[key]<span class="hljs-keyword">return</span> val, ok&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *ShardedMap)</span> <span class="hljs-title">Delete</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span></span> &#123;shard := m.getShard(key)shard.Lock()<span class="hljs-keyword">defer</span> shard.Unlock()<span class="hljs-built_in">delete</span>(shard.data, key)&#125;</code></pre><p>åˆ†ç‰‡é”çš„ä¼˜ç‚¹æ˜¯å¤§å¤§å‡å°‘äº†é”ç«äº‰ï¼Œé€‚ç”¨äºé«˜å¹¶å‘è¯»å†™åœºæ™¯ã€‚</p><h3 id="ğŸ“Š-æ€§èƒ½å¯¹æ¯”"><a class="header-anchor" href="#ğŸ“Š-æ€§èƒ½å¯¹æ¯”"></a>ğŸ“Š æ€§èƒ½å¯¹æ¯”</h3><p>ä¸åŒå¹¶å‘å®‰å…¨mapå®ç°çš„æ€§èƒ½å¯¹æ¯”ï¼š</p><table><thead><tr><th>å®ç°æ–¹å¼</th><th>è¯»æ€§èƒ½</th><th>å†™æ€§èƒ½</th><th>å†…å­˜å ç”¨</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>Mutex+Map</td><td>ä¸­</td><td>ä½</td><td>ä½</td><td>ç®€å•åœºæ™¯ï¼Œæ•°æ®é‡å°</td></tr><tr><td>sync.Map</td><td>é«˜</td><td>ä¸­</td><td>é«˜</td><td>è¯»å¤šå†™å°‘ï¼Œå¤§é‡é”®é‡å¤è¯»å†™</td></tr><tr><td>åˆ†ç‰‡é”Map</td><td>é«˜</td><td>é«˜</td><td>ä¸­</td><td>è¯»å†™éƒ½å¾ˆé¢‘ç¹ï¼Œå¤§è§„æ¨¡æ•°æ®</td></tr></tbody></table><h3 id="ğŸš€-å®é™…ä½¿ç”¨å»ºè®®"><a class="header-anchor" href="#ğŸš€-å®é™…ä½¿ç”¨å»ºè®®"></a>ğŸš€ å®é™…ä½¿ç”¨å»ºè®®</h3><ol><li><strong>ç®€å•åœºæ™¯</strong>: å¯¹äºç®€å•åº”ç”¨æˆ–åŸå‹ï¼Œä½¿ç”¨<code>Mutex+Map</code>å³å¯</li><li><strong>ä¸€èˆ¬åº”ç”¨</strong>: é»˜è®¤é¦–é€‰<code>sync.Map</code>ï¼Œå®ƒæ˜¯æ ‡å‡†åº“æä¾›çš„å¹¶å‘å®‰å…¨å®ç°</li><li><strong>é«˜æ€§èƒ½éœ€æ±‚</strong>: å¦‚æœç»è¿‡æ€§èƒ½æµ‹è¯•å‘ç°<code>sync.Map</code>æˆä¸ºç“¶é¢ˆï¼Œè€ƒè™‘ä½¿ç”¨åˆ†ç‰‡é”æ–¹æ¡ˆ</li><li><strong>ç‰¹æ®Šåœºæ™¯</strong>: é’ˆå¯¹ç‰¹å®šæ•°æ®è®¿é—®æ¨¡å¼ï¼Œå¯èƒ½éœ€è¦è‡ªå®šä¹‰å®ç°</li></ol><h3 id="ğŸ“-ç»“è®º"><a class="header-anchor" href="#ğŸ“-ç»“è®º"></a>ğŸ“ ç»“è®º</h3><p>Golangæä¾›äº†å¤šç§æ–¹å¼å®ç°å¹¶å‘å®‰å…¨çš„mapï¼Œé€‰æ‹©å“ªç§å–å†³äºä½ çš„å…·ä½“éœ€æ±‚å’Œä½¿ç”¨åœºæ™¯ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ ‡å‡†åº“çš„<code>sync.Map</code>æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ï¼Œä½†å¯¹äºç‰¹å®šçš„é«˜æ€§èƒ½éœ€æ±‚ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘è‡ªå®šä¹‰å®ç°ã€‚</p><p>è®°ä½ï¼Œè¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºã€‚å§‹ç»ˆå…ˆä½¿ç”¨æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œç„¶åé€šè¿‡åŸºå‡†æµ‹è¯•æ¥ç¡®å®šç“¶é¢ˆæ‰€åœ¨ï¼Œå†æœ‰é’ˆå¯¹æ€§åœ°è¿›è¡Œä¼˜åŒ–ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>å¹¶å‘</tag>
      
      <tag>map</tag>
      
      <tag>sync</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang æ³›å‹ä½¿ç”¨æŠ€å·§ä¸æœ€ä½³å®è·µ</title>
    <link href="/2024/02/28/golang-%E6%B3%9B%E5%9E%8B%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"/>
    <url>/2024/02/28/golang-%E6%B3%9B%E5%9E%8B%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="golang-æ³›å‹ä½¿ç”¨æŠ€å·§ä¸æœ€ä½³å®è·µ"><a class="header-anchor" href="#golang-æ³›å‹ä½¿ç”¨æŠ€å·§ä¸æœ€ä½³å®è·µ"></a>golang æ³›å‹ä½¿ç”¨æŠ€å·§ä¸æœ€ä½³å®è·µ</h2><h3 id="ğŸ”-æ³›å‹ç®€ä»‹"><a class="header-anchor" href="#ğŸ”-æ³›å‹ç®€ä»‹"></a>ğŸ” æ³›å‹ç®€ä»‹</h3><p>Goè¯­è¨€åœ¨ç»å†äº†é•¿æ—¶é—´çš„è®¨è®ºå’Œè®¾è®¡åï¼Œç»ˆäºåœ¨1.18ç‰ˆæœ¬ä¸­å¼•å…¥äº†æœŸå¾…å·²ä¹…çš„æ³›å‹ç‰¹æ€§ã€‚æ³›å‹çš„åŠ å…¥ä½¿å¾—Goèƒ½å¤Ÿç¼–å†™æ›´åŠ çµæ´»ã€å¯å¤ç”¨çš„ä»£ç ï¼ŒåŒæ—¶ä¿æŒç±»å‹å®‰å…¨ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»Goæ³›å‹çš„ä½¿ç”¨æŠ€å·§å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°åˆ©ç”¨è¿™ä¸€å¼ºå¤§ç‰¹æ€§ã€‚</p><h3 id="ğŸ§©-æ³›å‹çš„åŸºæœ¬è¯­æ³•"><a class="header-anchor" href="#ğŸ§©-æ³›å‹çš„åŸºæœ¬è¯­æ³•"></a>ğŸ§© æ³›å‹çš„åŸºæœ¬è¯­æ³•</h3><p>Goè¯­è¨€çš„æ³›å‹é€šè¿‡ç±»å‹å‚æ•°ï¼ˆType Parametersï¼‰æ¥å®ç°ã€‚ç±»å‹å‚æ•°ä½¿ç”¨æ–¹æ‹¬å· <code>[]</code> å£°æ˜ï¼Œæ”¾åœ¨å‡½æ•°åæˆ–ç±»å‹åä¹‹åã€‚</p><h4 id="åŸºæœ¬å‡½æ•°æ³›å‹"><a class="header-anchor" href="#åŸºæœ¬å‡½æ•°æ³›å‹"></a>åŸºæœ¬å‡½æ•°æ³›å‹</h4><pre><code class="hljs go"><span class="hljs-comment">// æ³›å‹å‡½æ•°ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Max</span>[<span class="hljs-title">T</span> <span class="hljs-title">constraints</span>.<span class="hljs-title">Ordered</span>]<span class="hljs-params">(a, b T)</span> <span class="hljs-title">T</span></span> &#123;    <span class="hljs-keyword">if</span> a &gt; b &#123;        <span class="hljs-keyword">return</span> a    &#125;    <span class="hljs-keyword">return</span> b&#125;</code></pre><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>T</code> æ˜¯ç±»å‹å‚æ•°ï¼Œ<code>constraints.Ordered</code> æ˜¯ç±»å‹çº¦æŸï¼Œè¡¨ç¤º <code>T</code> å¿…é¡»æ˜¯å¯æ¯”è¾ƒå¤§å°çš„ç±»å‹ï¼Œå¦‚æ•´æ•°ã€æµ®ç‚¹æ•°æˆ–å­—ç¬¦ä¸²ç­‰ã€‚</p><h4 id="æ³›å‹ç±»å‹"><a class="header-anchor" href="#æ³›å‹ç±»å‹"></a>æ³›å‹ç±»å‹</h4><pre><code class="hljs go"><span class="hljs-comment">// æ³›å‹ç±»å‹ç¤ºä¾‹</span><span class="hljs-keyword">type</span> Stack[T any] <span class="hljs-keyword">struct</span> &#123;    items []T&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Stack[T])</span> <span class="hljs-title">Push</span><span class="hljs-params">(item T)</span></span> &#123;    s.items = <span class="hljs-built_in">append</span>(s.items, item)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Stack[T])</span> <span class="hljs-title">Pop</span><span class="hljs-params">()</span> <span class="hljs-params">(T, <span class="hljs-keyword">bool</span>)</span></span> &#123;    <span class="hljs-keyword">var</span> zero T    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(s.items) == <span class="hljs-number">0</span> &#123;        <span class="hljs-keyword">return</span> zero, <span class="hljs-literal">false</span>    &#125;        n := <span class="hljs-built_in">len</span>(s.items) - <span class="hljs-number">1</span>    item := s.items[n]    s.items = s.items[:n]    <span class="hljs-keyword">return</span> item, <span class="hljs-literal">true</span>&#125;</code></pre><p>è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªæ³›å‹æ ˆï¼Œå¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„å…ƒç´ ã€‚</p><h3 id="ğŸ“-ç±»å‹çº¦æŸè¯¦è§£"><a class="header-anchor" href="#ğŸ“-ç±»å‹çº¦æŸè¯¦è§£"></a>ğŸ“ ç±»å‹çº¦æŸè¯¦è§£</h3><p>ç±»å‹çº¦æŸæŒ‡å®šäº†ç±»å‹å‚æ•°å¯ä»¥æ¥å—çš„ç±»å‹é›†åˆã€‚Goæä¾›äº†ä»¥ä¸‹å‡ ç§æ–¹å¼å®šä¹‰ç±»å‹çº¦æŸï¼š</p><h4 id="1-ä½¿ç”¨-any-å’Œ-comparable"><a class="header-anchor" href="#1-ä½¿ç”¨-any-å’Œ-comparable"></a>1. ä½¿ç”¨ <code>any</code> å’Œ <code>comparable</code></h4><ul><li><code>any</code>ï¼šæ¥å—ä»»ä½•ç±»å‹ï¼ˆå®é™…ä¸Šæ˜¯ <code>interface&#123;&#125;</code> çš„åˆ«åï¼‰</li><li><code>comparable</code>ï¼šæ¥å—å¯æ¯”è¾ƒç±»å‹ï¼ˆå¯ç”¨ <code>==</code> å’Œ <code>!=</code> æ“ä½œç¬¦æ¯”è¾ƒçš„ç±»å‹ï¼‰</li></ul><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Equal</span>[<span class="hljs-title">T</span> <span class="hljs-title">comparable</span>]<span class="hljs-params">(a, b T)</span> <span class="hljs-title">bool</span></span> &#123;    <span class="hljs-keyword">return</span> a == b&#125;</code></pre><h4 id="2-ä½¿ç”¨-constraints-åŒ…"><a class="header-anchor" href="#2-ä½¿ç”¨-constraints-åŒ…"></a>2. ä½¿ç”¨ <code>constraints</code> åŒ…</h4><p>Goæ ‡å‡†åº“æä¾›äº† <code>golang.org/x/exp/constraints</code> åŒ…ï¼Œå…¶ä¸­åŒ…å«äº†å¸¸ç”¨çš„ç±»å‹çº¦æŸï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;golang.org/x/exp/constraints&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Sum</span>[<span class="hljs-title">T</span> <span class="hljs-title">constraints</span>.<span class="hljs-title">Integer</span>]<span class="hljs-params">(values []T)</span> <span class="hljs-title">T</span></span> &#123;    <span class="hljs-keyword">var</span> result T    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> values &#123;        result += v    &#125;    <span class="hljs-keyword">return</span> result&#125;</code></pre><p>å¸¸ç”¨çº¦æŸåŒ…æ‹¬ï¼š</p><ul><li><code>constraints.Integer</code>ï¼šæ•´æ•°ç±»å‹</li><li><code>constraints.Float</code>ï¼šæµ®ç‚¹æ•°ç±»å‹</li><li><code>constraints.Ordered</code>ï¼šå¯æ’åºç±»å‹ï¼ˆæ”¯æŒ <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code> æ“ä½œï¼‰</li></ul><h4 id="3-è‡ªå®šä¹‰ç±»å‹çº¦æŸ"><a class="header-anchor" href="#3-è‡ªå®šä¹‰ç±»å‹çº¦æŸ"></a>3. è‡ªå®šä¹‰ç±»å‹çº¦æŸ</h4><p>å¯ä»¥ä½¿ç”¨æ¥å£å®šä¹‰è‡ªå®šä¹‰ç±»å‹çº¦æŸï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Number <span class="hljs-keyword">interface</span> &#123;    ~<span class="hljs-keyword">int</span> | ~<span class="hljs-keyword">int32</span> | ~<span class="hljs-keyword">int64</span> | ~<span class="hljs-keyword">float32</span> | ~<span class="hljs-keyword">float64</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Average</span>[<span class="hljs-title">T</span> <span class="hljs-title">Number</span>]<span class="hljs-params">(values []T)</span> <span class="hljs-title">float64</span></span> &#123;    <span class="hljs-keyword">var</span> sum T    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> values &#123;        sum += v    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-keyword">float64</span>(sum) / <span class="hljs-keyword">float64</span>(<span class="hljs-built_in">len</span>(values))&#125;</code></pre><p>è¿™é‡Œçš„ <code>~</code> å‰ç¼€è¡¨ç¤ºåŒ…æ‹¬è¯¥ç±»å‹åŠå…¶æ´¾ç”Ÿç±»å‹ã€‚</p><h3 id="ğŸ’¡-æ³›å‹ä½¿ç”¨æŠ€å·§"><a class="header-anchor" href="#ğŸ’¡-æ³›å‹ä½¿ç”¨æŠ€å·§"></a>ğŸ’¡ æ³›å‹ä½¿ç”¨æŠ€å·§</h3><h4 id="1-æ³›å‹å®¹å™¨"><a class="header-anchor" href="#1-æ³›å‹å®¹å™¨"></a>1. æ³›å‹å®¹å™¨</h4><p>æ³›å‹æœ€å¸¸è§çš„åº”ç”¨æ˜¯åˆ›å»ºé€šç”¨å®¹å™¨ç±»å‹ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æ³›å‹æ˜ å°„</span><span class="hljs-keyword">type</span> SafeMap[K comparable, V any] <span class="hljs-keyword">struct</span> &#123;    mu sync.RWMutex    data <span class="hljs-keyword">map</span>[K]V&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *SafeMap[K, V])</span> <span class="hljs-title">Get</span><span class="hljs-params">(key K)</span> <span class="hljs-params">(V, <span class="hljs-keyword">bool</span>)</span></span> &#123;    m.mu.RLock()    <span class="hljs-keyword">defer</span> m.mu.RUnlock()    val, ok := m.data[key]    <span class="hljs-keyword">return</span> val, ok&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *SafeMap[K, V])</span> <span class="hljs-title">Set</span><span class="hljs-params">(key K, value V)</span></span> &#123;    m.mu.Lock()    <span class="hljs-keyword">defer</span> m.mu.Unlock()    m.data[key] = value&#125;</code></pre><h4 id="2-æ³›å‹ç®—æ³•"><a class="header-anchor" href="#2-æ³›å‹ç®—æ³•"></a>2. æ³›å‹ç®—æ³•</h4><p>æ³›å‹ä½¿å¾—ç¼–å†™é€šç”¨ç®—æ³•å˜å¾—æ›´åŠ ç®€å•ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æ³›å‹æ’åº</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Sort</span>[<span class="hljs-title">T</span> <span class="hljs-title">constraints</span>.<span class="hljs-title">Ordered</span>]<span class="hljs-params">(slice []T)</span></span> &#123;    sort.Slice(slice, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123;        <span class="hljs-keyword">return</span> slice[i] &lt; slice[j]    &#125;)&#125;<span class="hljs-comment">// æ³›å‹äºŒåˆ†æŸ¥æ‰¾</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BinarySearch</span>[<span class="hljs-title">T</span> <span class="hljs-title">constraints</span>.<span class="hljs-title">Ordered</span>]<span class="hljs-params">(slice []T, target T)</span> <span class="hljs-title">int</span></span> &#123;    left, right := <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(slice)<span class="hljs-number">-1</span>        <span class="hljs-keyword">for</span> left &lt;= right &#123;        mid := (left + right) / <span class="hljs-number">2</span>                <span class="hljs-keyword">if</span> slice[mid] == target &#123;            <span class="hljs-keyword">return</span> mid        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> slice[mid] &lt; target &#123;            left = mid + <span class="hljs-number">1</span>        &#125; <span class="hljs-keyword">else</span> &#123;            right = mid - <span class="hljs-number">1</span>        &#125;    &#125;        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>&#125;</code></pre><h4 id="3-æ³›å‹å·¥å…·å‡½æ•°"><a class="header-anchor" href="#3-æ³›å‹å·¥å…·å‡½æ•°"></a>3. æ³›å‹å·¥å…·å‡½æ•°</h4><pre><code class="hljs go"><span class="hljs-comment">// æ˜ å°„å‡½æ•°</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Map</span>[<span class="hljs-title">T</span>, <span class="hljs-title">U</span> <span class="hljs-title">any</span>]<span class="hljs-params">(slice []T, f <span class="hljs-keyword">func</span>(T)</span> <span class="hljs-title">U</span>) []<span class="hljs-title">U</span></span> &#123;    result := <span class="hljs-built_in">make</span>([]U, <span class="hljs-built_in">len</span>(slice))    <span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> slice &#123;        result[i] = f(v)    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-comment">// è¿‡æ»¤å‡½æ•°</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Filter</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">(slice []T, f <span class="hljs-keyword">func</span>(T)</span> <span class="hljs-title">bool</span>) []<span class="hljs-title">T</span></span> &#123;    <span class="hljs-keyword">var</span> result []T    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> slice &#123;        <span class="hljs-keyword">if</span> f(v) &#123;            result = <span class="hljs-built_in">append</span>(result, v)        &#125;    &#125;    <span class="hljs-keyword">return</span> result&#125;<span class="hljs-comment">// å½’çº¦å‡½æ•°</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Reduce</span>[<span class="hljs-title">T</span>, <span class="hljs-title">U</span> <span class="hljs-title">any</span>]<span class="hljs-params">(slice []T, initial U, f <span class="hljs-keyword">func</span>(U, T)</span> <span class="hljs-title">U</span>) <span class="hljs-title">U</span></span> &#123;    result := initial    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> slice &#123;        result = f(result, v)    &#125;    <span class="hljs-keyword">return</span> result&#125;</code></pre><h3 id="ğŸš€-å®é™…åº”ç”¨æ¡ˆä¾‹"><a class="header-anchor" href="#ğŸš€-å®é™…åº”ç”¨æ¡ˆä¾‹"></a>ğŸš€ å®é™…åº”ç”¨æ¡ˆä¾‹</h3><h4 id="1-é€šç”¨ç»“æœåŒ…è£…å™¨"><a class="header-anchor" href="#1-é€šç”¨ç»“æœåŒ…è£…å™¨"></a>1. é€šç”¨ç»“æœåŒ…è£…å™¨</h4><pre><code class="hljs go"><span class="hljs-comment">// Result æ˜¯ä¸€ä¸ªæ³›å‹ç»“æœåŒ…è£…å™¨</span><span class="hljs-keyword">type</span> Result[T any] <span class="hljs-keyword">struct</span> &#123;    Data  T    Error error&#125;<span class="hljs-comment">// NewResult åˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æœ</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewResult</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">(data T, err error)</span> <span class="hljs-title">Result</span>[<span class="hljs-title">T</span>]</span> &#123;    <span class="hljs-keyword">return</span> Result[T]&#123;Data: data, Error: err&#125;&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUser</span><span class="hljs-params">(id <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Result</span>[<span class="hljs-title">User</span>]</span> &#123;    user, err := db.FindUser(id)    <span class="hljs-keyword">return</span> NewResult(user, err)&#125;<span class="hljs-comment">// å®¢æˆ·ç«¯ä»£ç </span>result := GetUser(<span class="hljs-string">&quot;123&quot;</span>)<span class="hljs-keyword">if</span> result.Error != <span class="hljs-literal">nil</span> &#123;    <span class="hljs-comment">// å¤„ç†é”™è¯¯</span>&#125; <span class="hljs-keyword">else</span> &#123;    user := result.Data    <span class="hljs-comment">// ä½¿ç”¨ç”¨æˆ·æ•°æ®</span>&#125;</code></pre><h4 id="2-æ³›å‹ç¼“å­˜"><a class="header-anchor" href="#2-æ³›å‹ç¼“å­˜"></a>2. æ³›å‹ç¼“å­˜</h4><pre><code class="hljs go"><span class="hljs-comment">// ç®€å•çš„æ³›å‹ç¼“å­˜</span><span class="hljs-keyword">type</span> Cache[K comparable, V any] <span class="hljs-keyword">struct</span> &#123;    mu    sync.RWMutex    items <span class="hljs-keyword">map</span>[K]cacheItem[V]&#125;<span class="hljs-keyword">type</span> cacheItem[V any] <span class="hljs-keyword">struct</span> &#123;    value      V    expiration time.Time&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewCache</span>[<span class="hljs-title">K</span> <span class="hljs-title">comparable</span>, <span class="hljs-title">V</span> <span class="hljs-title">any</span>]<span class="hljs-params">()</span> *<span class="hljs-title">Cache</span>[<span class="hljs-title">K</span>, <span class="hljs-title">V</span>]</span> &#123;    <span class="hljs-keyword">return</span> &amp;Cache[K, V]&#123;        items: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[K]cacheItem[V]),    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cache[K, V])</span> <span class="hljs-title">Set</span><span class="hljs-params">(key K, value V, duration time.Duration)</span></span> &#123;    c.mu.Lock()    <span class="hljs-keyword">defer</span> c.mu.Unlock()        c.items[key] = cacheItem[V]&#123;        value:      value,        expiration: time.Now().Add(duration),    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cache[K, V])</span> <span class="hljs-title">Get</span><span class="hljs-params">(key K)</span> <span class="hljs-params">(V, <span class="hljs-keyword">bool</span>)</span></span> &#123;    c.mu.RLock()    <span class="hljs-keyword">defer</span> c.mu.RUnlock()        <span class="hljs-keyword">var</span> zero V    item, found := c.items[key]    <span class="hljs-keyword">if</span> !found &#123;        <span class="hljs-keyword">return</span> zero, <span class="hljs-literal">false</span>    &#125;        <span class="hljs-keyword">if</span> time.Now().After(item.expiration) &#123;        <span class="hljs-keyword">return</span> zero, <span class="hljs-literal">false</span>    &#125;        <span class="hljs-keyword">return</span> item.value, <span class="hljs-literal">true</span>&#125;</code></pre><h4 id="3-æ³›å‹æ•°æ®ä»“åº“"><a class="header-anchor" href="#3-æ³›å‹æ•°æ®ä»“åº“"></a>3. æ³›å‹æ•°æ®ä»“åº“</h4><pre><code class="hljs go"><span class="hljs-comment">// å®ä½“æ¥å£</span><span class="hljs-keyword">type</span> Entity <span class="hljs-keyword">interface</span> &#123;    GetID() <span class="hljs-keyword">string</span>&#125;<span class="hljs-comment">// æ³›å‹ä»“åº“</span><span class="hljs-keyword">type</span> Repository[T Entity] <span class="hljs-keyword">interface</span> &#123;    Find(id <span class="hljs-keyword">string</span>) (T, error)    FindAll() ([]T, error)    Save(entity T) error    Delete(id <span class="hljs-keyword">string</span>) error&#125;<span class="hljs-comment">// å†…å­˜ä»“åº“å®ç°</span><span class="hljs-keyword">type</span> MemoryRepository[T Entity] <span class="hljs-keyword">struct</span> &#123;    items <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]T    mu    sync.RWMutex&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMemoryRepository</span>[<span class="hljs-title">T</span> <span class="hljs-title">Entity</span>]<span class="hljs-params">()</span> *<span class="hljs-title">MemoryRepository</span>[<span class="hljs-title">T</span>]</span> &#123;    <span class="hljs-keyword">return</span> &amp;MemoryRepository[T]&#123;        items: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]T),    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *MemoryRepository[T])</span> <span class="hljs-title">Find</span><span class="hljs-params">(id <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(T, error)</span></span> &#123;    r.mu.RLock()    <span class="hljs-keyword">defer</span> r.mu.RUnlock()        <span class="hljs-keyword">var</span> zero T    entity, found := r.items[id]    <span class="hljs-keyword">if</span> !found &#123;        <span class="hljs-keyword">return</span> zero, errors.New(<span class="hljs-string">&quot;entity not found&quot;</span>)    &#125;        <span class="hljs-keyword">return</span> entity, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *MemoryRepository[T])</span> <span class="hljs-title">Save</span><span class="hljs-params">(entity T)</span> <span class="hljs-title">error</span></span> &#123;    r.mu.Lock()    <span class="hljs-keyword">defer</span> r.mu.Unlock()        r.items[entity.GetID()] = entity    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;    ID   <span class="hljs-keyword">string</span>    Name <span class="hljs-keyword">string</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u User)</span> <span class="hljs-title">GetID</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;    <span class="hljs-keyword">return</span> u.ID&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    repo := NewMemoryRepository[User]()        <span class="hljs-comment">// ä¿å­˜ç”¨æˆ·</span>    user := User&#123;ID: <span class="hljs-string">&quot;1&quot;</span>, Name: <span class="hljs-string">&quot;Alice&quot;</span>&#125;    repo.Save(user)        <span class="hljs-comment">// æŸ¥æ‰¾ç”¨æˆ·</span>    found, err := repo.Find(<span class="hljs-string">&quot;1&quot;</span>)    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;        fmt.Println(<span class="hljs-string">&quot;Found user:&quot;</span>, found.Name)    &#125;&#125;</code></pre><h3 id="âš ï¸-æ³›å‹çš„æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ"><a class="header-anchor" href="#âš ï¸-æ³›å‹çš„æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ"></a>âš ï¸ æ³›å‹çš„æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ</h3><h4 id="1-ä¸è¦è¿‡åº¦ä½¿ç”¨æ³›å‹"><a class="header-anchor" href="#1-ä¸è¦è¿‡åº¦ä½¿ç”¨æ³›å‹"></a>1. ä¸è¦è¿‡åº¦ä½¿ç”¨æ³›å‹</h4><p>æ³›å‹æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œä½†å¹¶éæ‰€æœ‰åœºæ™¯éƒ½éœ€è¦ä½¿ç”¨æ³›å‹ã€‚å½“ä»£ç åªéœ€è¦å¤„ç†å°‘æ•°å‡ ç§ç±»å‹æ—¶ï¼Œä½¿ç”¨æ¥å£æˆ–å…·ä½“ç±»å‹å¯èƒ½æ›´ç®€å•æ˜äº†ã€‚ä»…åœ¨ç¡®å®éœ€è¦è·¨å¤šç§ç±»å‹å¤ç”¨ä»£ç æ—¶ä½¿ç”¨æ³›å‹ã€‚</p><h4 id="2-æä¾›æ¸…æ™°çš„ç±»å‹çº¦æŸ"><a class="header-anchor" href="#2-æä¾›æ¸…æ™°çš„ç±»å‹çº¦æŸ"></a>2. æä¾›æ¸…æ™°çš„ç±»å‹çº¦æŸ</h4><p>ä¸ºæ³›å‹å‡½æ•°å’Œç±»å‹æä¾›æ˜ç¡®çš„ç±»å‹çº¦æŸï¼Œè¿™ä¸ä»…å¯ä»¥æ•è·ç±»å‹é”™è¯¯ï¼Œè¿˜èƒ½æé«˜ä»£ç çš„å¯è¯»æ€§ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•ï¼šçº¦æŸå¤ªå®½æ³›</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Process</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">(data T)</span></span> &#123;&#125;<span class="hljs-comment">// å¥½çš„åšæ³•ï¼šæ˜ç¡®çš„çº¦æŸ</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Process</span>[<span class="hljs-title">T</span> <span class="hljs-title">Number</span>]<span class="hljs-params">(data T)</span></span> &#123;&#125;</code></pre><h4 id="3-è€ƒè™‘é›¶å€¼å’Œç±»å‹å®‰å…¨"><a class="header-anchor" href="#3-è€ƒè™‘é›¶å€¼å’Œç±»å‹å®‰å…¨"></a>3. è€ƒè™‘é›¶å€¼å’Œç±»å‹å®‰å…¨</h4><p>å¤„ç†æ³›å‹æ—¶ï¼Œéœ€è¦æ³¨æ„é›¶å€¼é—®é¢˜ã€‚å¯¹äºæŒ‡é’ˆç±»å‹å’Œå€¼ç±»å‹ï¼Œé›¶å€¼çš„è¡Œä¸ºå¯èƒ½ä¸åŒã€‚</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetDefault</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">()</span> <span class="hljs-title">T</span></span> &#123;    <span class="hljs-keyword">var</span> zero T    <span class="hljs-keyword">return</span> zero&#125;<span class="hljs-comment">// å½“Tä¸ºintæ—¶ï¼Œè¿”å›0</span><span class="hljs-comment">// å½“Tä¸ºstringæ—¶ï¼Œè¿”å›&quot;&quot;</span><span class="hljs-comment">// å½“Tä¸ºstructæ—¶ï¼Œè¿”å›æ‰€æœ‰å­—æ®µéƒ½æ˜¯é›¶å€¼çš„ç»“æ„ä½“</span><span class="hljs-comment">// å½“Tä¸ºæŒ‡é’ˆç±»å‹æ—¶ï¼Œè¿”å›nil</span></code></pre><h4 id="4-åˆ©ç”¨ç±»å‹æ¨å¯¼ç®€åŒ–è°ƒç”¨"><a class="header-anchor" href="#4-åˆ©ç”¨ç±»å‹æ¨å¯¼ç®€åŒ–è°ƒç”¨"></a>4. åˆ©ç”¨ç±»å‹æ¨å¯¼ç®€åŒ–è°ƒç”¨</h4><p>Goç¼–è¯‘å™¨å¯ä»¥ä»å‡½æ•°å‚æ•°æ¨å¯¼ç±»å‹å‚æ•°ï¼Œåˆ©ç”¨è¿™ä¸€ç‚¹å¯ä»¥ç®€åŒ–æ³›å‹å‡½æ•°çš„è°ƒç”¨ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¿…è¿™æ ·è°ƒç”¨</span>result := Max[<span class="hljs-keyword">int</span>](<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)<span class="hljs-comment">// å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œè®©ç¼–è¯‘å™¨æ¨å¯¼ç±»å‹</span>result := Max(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)</code></pre><p>ä½†æ³¨æ„ï¼Œå¦‚æœæ²¡æœ‰å‡½æ•°å‚æ•°ï¼Œåˆ™å¿…é¡»æ˜¾å¼æŒ‡å®šç±»å‹å‚æ•°ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// å¿…é¡»æŒ‡å®šç±»å‹å‚æ•°</span>s := NewStack[<span class="hljs-keyword">int</span>]()</code></pre><h4 id="5-é¿å…æ³›å‹æ–¹æ³•ä¸­çš„ç±»å‹æ–­è¨€"><a class="header-anchor" href="#5-é¿å…æ³›å‹æ–¹æ³•ä¸­çš„ç±»å‹æ–­è¨€"></a>5. é¿å…æ³›å‹æ–¹æ³•ä¸­çš„ç±»å‹æ–­è¨€</h4><p>åœ¨æ³›å‹æ–¹æ³•ä¸­ä½¿ç”¨ç±»å‹æ–­è¨€å¯èƒ½ä¼šå¯¼è‡´ç±»å‹å®‰å…¨é—®é¢˜ã€‚å¦‚æœéœ€è¦å¯¹ä¸åŒç±»å‹æ‰§è¡Œä¸åŒæ“ä½œï¼Œè€ƒè™‘ä½¿ç”¨æ¥å£æˆ–å‡½æ•°å‚æ•°ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Process</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">(data T)</span></span> &#123;    <span class="hljs-keyword">switch</span> v := data.(<span class="hljs-keyword">type</span>) &#123; <span class="hljs-comment">// ç¼–è¯‘é”™è¯¯ï¼šæ— æ³•åœ¨æ³›å‹ä¸­ä½¿ç”¨ç±»å‹æ–­è¨€</span>    <span class="hljs-keyword">case</span> <span class="hljs-keyword">int</span>:        <span class="hljs-comment">// å¤„ç†int</span>    <span class="hljs-keyword">case</span> <span class="hljs-keyword">string</span>:        <span class="hljs-comment">// å¤„ç†string</span>    &#125;&#125;<span class="hljs-comment">// å¥½çš„åšæ³•ï¼šä½¿ç”¨å‡½æ•°å‚æ•°</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Process</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">(data T, handler <span class="hljs-keyword">func</span>(T)</span>)</span> &#123;    handler(data)&#125;</code></pre><h3 id="ğŸ”„-ä¸å…¶ä»–è¯­è¨€æ³›å‹çš„æ¯”è¾ƒ"><a class="header-anchor" href="#ğŸ”„-ä¸å…¶ä»–è¯­è¨€æ³›å‹çš„æ¯”è¾ƒ"></a>ğŸ”„ ä¸å…¶ä»–è¯­è¨€æ³›å‹çš„æ¯”è¾ƒ</h3><p>Goçš„æ³›å‹è®¾è®¡ç›¸å¯¹ç®€æ´ï¼Œä¸å…¶ä»–è¯­è¨€å¦‚C++ã€Javaæˆ–Rustçš„æ³›å‹ç›¸æ¯”æœ‰ä¸€äº›åŒºåˆ«ï¼š</p><ol><li><p><strong>æ²¡æœ‰é«˜çº§æ³›å‹ç‰¹æ€§</strong>ï¼šGoæ²¡æœ‰æä¾›è¯¸å¦‚Rustçš„ç‰¹è´¨ç•Œé™æˆ–C++æ¨¡æ¿ç‰¹åŒ–ç­‰é«˜çº§æ³›å‹ç‰¹æ€§ã€‚</p></li><li><p><strong>ç±»å‹æ“¦é™¤</strong>ï¼šä¸Javaç±»ä¼¼ï¼ŒGoåœ¨è¿è¡Œæ—¶æ‰§è¡Œç±»å‹æ“¦é™¤ï¼Œè¿™æ„å‘³ç€æ³›å‹ç±»å‹çš„ç±»å‹ä¿¡æ¯åœ¨è¿è¡Œæ—¶æ˜¯ä¸å¯ç”¨çš„ã€‚</p></li><li><p><strong>ç»Ÿä¸€è¯­æ³•</strong>ï¼šä¸åƒC++æœ‰æ¨¡æ¿å’Œæ³›å‹ä¸¤ç§æœºåˆ¶ï¼ŒGoåªæœ‰ä¸€ç§æ³›å‹æœºåˆ¶ï¼Œä½¿è¯­è¨€ä¿æŒç®€æ´ã€‚</p></li><li><p><strong>æ˜¾å¼ç±»å‹çº¦æŸ</strong>ï¼šGoè¦æ±‚æ˜¾å¼å£°æ˜ç±»å‹çº¦æŸï¼Œè€Œä¸æ˜¯åƒä¸€äº›è¯­è¨€é‚£æ ·éšå¼æ¨å¯¼ã€‚</p></li></ol><h3 id="ğŸ“š-æ€»ç»“"><a class="header-anchor" href="#ğŸ“š-æ€»ç»“"></a>ğŸ“š æ€»ç»“</h3><p>Goè¯­è¨€çš„æ³›å‹ä¸ºä»£ç å¤ç”¨å’Œç±»å‹å®‰å…¨æä¾›äº†å¼ºå¤§çš„å·¥å…·ã€‚é€šè¿‡åˆç†ä½¿ç”¨æ³›å‹ï¼Œå¯ä»¥ç¼–å†™æ›´åŠ çµæ´»ã€å¯ç»´æŠ¤çš„ä»£ç ã€‚å…³é”®è¦ç‚¹ï¼š</p><ol><li><strong>é€‚åº¦ä½¿ç”¨æ³›å‹</strong>ï¼šåªåœ¨çœŸæ­£éœ€è¦æ—¶ä½¿ç”¨æ³›å‹</li><li><strong>æ˜ç¡®ç±»å‹çº¦æŸ</strong>ï¼šæä¾›æ¸…æ™°çš„ç±»å‹çº¦æŸä»¥æé«˜ä»£ç å¯è¯»æ€§å’Œå®‰å…¨æ€§</li><li><strong>æ³¨æ„é›¶å€¼å¤„ç†</strong>ï¼šç‰¹åˆ«æ˜¯å¯¹äºä¸åŒç±»å‹çš„é›¶å€¼è¡Œä¸º</li><li><strong>åˆ©ç”¨ç±»å‹æ¨å¯¼</strong>ï¼šç®€åŒ–æ³›å‹å‡½æ•°çš„è°ƒç”¨</li><li><strong>ä¿æŒç®€å•</strong>ï¼šé¿å…è¿‡åº¦å¤æ‚çš„æ³›å‹è®¾è®¡</li></ol><p>éšç€Goç”Ÿæ€ç³»ç»Ÿçš„ä¸æ–­å‘å±•ï¼Œæˆ‘ä»¬å¯ä»¥æœŸå¾…çœ‹åˆ°æ›´å¤šåŸºäºæ³›å‹çš„åº“å’Œè®¾è®¡æ¨¡å¼æ¶Œç°ã€‚æŒæ¡æ³›å‹ä½¿ç”¨æŠ€å·§å°†å¸®åŠ©ä½ æˆä¸ºæ›´é«˜æ•ˆçš„Goå¼€å‘è€…ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>æ³›å‹</tag>
      
      <tag>ç±»å‹å‚æ•°</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang å¾®æœåŠ¡æ¡†æ¶é€‰å‹ä¸å®è·µ</title>
    <link href="/2024/02/15/golang-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6%E9%80%89%E5%9E%8B%E4%B8%8E%E5%AE%9E%E8%B7%B5/"/>
    <url>/2024/02/15/golang-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6%E9%80%89%E5%9E%8B%E4%B8%8E%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ—ï¸-golang-å¾®æœåŠ¡æ¡†æ¶é€‰å‹ä¸å®è·µ"><a class="header-anchor" href="#ğŸ—ï¸-golang-å¾®æœåŠ¡æ¡†æ¶é€‰å‹ä¸å®è·µ"></a>ğŸ—ï¸ golang å¾®æœåŠ¡æ¡†æ¶é€‰å‹ä¸å®è·µ</h2><p>Goè¯­è¨€å‡­å€Ÿå…¶ç®€æ´çš„è¯­æ³•ã€å‡ºè‰²çš„å¹¶å‘æ”¯æŒå’Œä¼˜ç§€çš„æ€§èƒ½ï¼Œå·²æˆä¸ºæ„å»ºå¾®æœåŠ¡çš„ç†æƒ³é€‰æ‹©ã€‚æœ¬æ–‡å°†å¯¹å½“å‰æµè¡Œçš„Goå¾®æœåŠ¡æ¡†æ¶è¿›è¡Œå¯¹æ¯”ï¼Œå¹¶åˆ†äº«å®è·µç»éªŒï¼Œå¸®åŠ©ä½ ä¸ºé¡¹ç›®é€‰æ‹©åˆé€‚çš„æ¡†æ¶ã€‚</p><h3 id="ğŸ“Š-ä¸»æµGoå¾®æœåŠ¡æ¡†æ¶å¯¹æ¯”"><a class="header-anchor" href="#ğŸ“Š-ä¸»æµGoå¾®æœåŠ¡æ¡†æ¶å¯¹æ¯”"></a>ğŸ“Š ä¸»æµGoå¾®æœåŠ¡æ¡†æ¶å¯¹æ¯”</h3><h4 id="1-Go-kit"><a class="header-anchor" href="#1-Go-kit"></a>1. Go-kit</h4><p><a href="https://github.com/go-kit/kit">Go-kit</a> æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºå¾®æœåŠ¡çš„ç¼–ç¨‹å·¥å…·åŒ…ï¼Œéµå¾ª&quot;å°è€Œç¾&quot;çš„è®¾è®¡å“²å­¦ã€‚</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒä¸­é—´ä»¶ã€æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ç­‰</li><li>ä¸å¤šç§ä¼ è¾“åè®®å…¼å®¹(HTTP, gRPC, AMQPç­‰)</li><li>å¼ºå¤§çš„å¯æ‰©å±•æ€§å’Œå¯æµ‹è¯•æ€§</li><li>æä¾›äº†å®Œå–„çš„ç›‘æ§å’Œå¯è§‚æµ‹æ€§æ”¯æŒ</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>å­¦ä¹ æ›²çº¿è¾ƒé™¡å³­</li><li>ä»£ç é‡è¾ƒå¤§ï¼Œéœ€è¦ç¼–å†™å¤§é‡æ ·æ¿ä»£ç </li><li>å¯¹äºç®€å•æœåŠ¡å¯èƒ½è¿‡äºå¤æ‚</li></ul><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> å¤§å‹ã€å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¯¹å¯é æ€§å’Œå¯è§‚æµ‹æ€§æœ‰é«˜è¦æ±‚çš„ä¼ä¸šçº§åº”ç”¨ã€‚</p><p>ä»£ç ç¤ºä¾‹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> (  <span class="hljs-string">&quot;context&quot;</span>  <span class="hljs-string">&quot;github.com/go-kit/kit/endpoint&quot;</span>  httptransport <span class="hljs-string">&quot;github.com/go-kit/kit/transport/http&quot;</span>)<span class="hljs-comment">// 1. å®šä¹‰æœåŠ¡æ¥å£</span><span class="hljs-keyword">type</span> StringService <span class="hljs-keyword">interface</span> &#123;  Uppercase(<span class="hljs-keyword">string</span>) (<span class="hljs-keyword">string</span>, error)&#125;<span class="hljs-comment">// 2. åˆ›å»ºå…·ä½“å®ç°</span><span class="hljs-keyword">type</span> stringService <span class="hljs-keyword">struct</span>&#123;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(stringService)</span> <span class="hljs-title">Uppercase</span><span class="hljs-params">(s <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, error)</span></span> &#123;  <span class="hljs-keyword">return</span> strings.ToUpper(s), <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// 3. åˆ›å»ºendpoint</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">makeUppercaseEndpoint</span><span class="hljs-params">(svc StringService)</span> <span class="hljs-title">endpoint</span>.<span class="hljs-title">Endpoint</span></span> &#123;  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, request <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span></span> &#123;    req := request.(uppercaseRequest)    v, err := svc.Uppercase(req.S)    <span class="hljs-keyword">return</span> uppercaseResponse&#123;v, err&#125;, <span class="hljs-literal">nil</span>  &#125;&#125;<span class="hljs-comment">// 4. å®šä¹‰è¯·æ±‚å’Œå“åº”ç»“æ„</span><span class="hljs-keyword">type</span> uppercaseRequest <span class="hljs-keyword">struct</span> &#123;  S <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;s&quot;`</span>&#125;<span class="hljs-keyword">type</span> uppercaseResponse <span class="hljs-keyword">struct</span> &#123;  V   <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;v&quot;`</span>  Err error  <span class="hljs-string">`json:&quot;-&quot;`</span>&#125;</code></pre><h4 id="2-Go-Micro"><a class="header-anchor" href="#2-Go-Micro"></a>2. Go Micro</h4><p><a href="https://go-micro.dev/">Go Micro</a> æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„å¾®æœåŠ¡å¼€å‘æ¡†æ¶ï¼Œæä¾›äº†æ„å»ºå’Œç®¡ç†å¾®æœåŠ¡æ‰€éœ€çš„å…¨éƒ¨å·¥å…·ã€‚</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>æä¾›äº†å®Œæ•´çš„å¾®æœåŠ¡ç”Ÿæ€ç³»ç»Ÿ</li><li>å†…ç½®æœåŠ¡æ³¨å†Œä¸å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æ¶ˆæ¯ç¼–ç ç­‰åŠŸèƒ½</li><li>æ’ä»¶åŒ–æ¶æ„ï¼Œé«˜åº¦å¯æ‰©å±•</li><li>æ”¯æŒå¼‚æ­¥é€šä¿¡å’Œäº‹ä»¶é©±åŠ¨æ¶æ„</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>æ¡†æ¶è¾ƒé‡</li><li>ç‰ˆæœ¬æ›´è¿­è¾ƒå¿«ï¼ŒAPIç¨³å®šæ€§æœ‰æ—¶ä¸å¤Ÿç†æƒ³</li><li>ç¤¾åŒºç›¸å¯¹è¾ƒå°</li></ul><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> éœ€è¦å¿«é€Ÿå¼€å‘å¹¶æ‹¥æœ‰å®Œæ•´å¾®æœåŠ¡ç”Ÿæ€çš„é¡¹ç›®ï¼Œç‰¹åˆ«æ˜¯éœ€è¦å¯æ’æ‹”ç»„ä»¶çš„åº”ç”¨ã€‚</p><p>ä»£ç ç¤ºä¾‹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> (  <span class="hljs-string">&quot;context&quot;</span>  <span class="hljs-string">&quot;github.com/go-micro/v4&quot;</span>  <span class="hljs-string">&quot;github.com/go-micro/v4/server&quot;</span>)<span class="hljs-comment">// å®šä¹‰è¯·æ±‚å’Œå“åº”</span><span class="hljs-keyword">type</span> Request <span class="hljs-keyword">struct</span> &#123;  Name <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span>&#125;<span class="hljs-keyword">type</span> Response <span class="hljs-keyword">struct</span> &#123;  Greeting <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;greeting&quot;`</span>&#125;<span class="hljs-comment">// å®ç°æœåŠ¡</span><span class="hljs-keyword">type</span> GreeterHandler <span class="hljs-keyword">struct</span>&#123;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *GreeterHandler)</span> <span class="hljs-title">Hello</span><span class="hljs-params">(ctx context.Context, req *Request, rsp *Response)</span> <span class="hljs-title">error</span></span> &#123;  rsp.Greeting = <span class="hljs-string">&quot;Hello, &quot;</span> + req.Name  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;  <span class="hljs-comment">// åˆ›å»ºæœåŠ¡</span>  service := micro.NewService(    micro.Name(<span class="hljs-string">&quot;greeter&quot;</span>),    micro.Version(<span class="hljs-string">&quot;latest&quot;</span>),  )    <span class="hljs-comment">// åˆå§‹åŒ–æœåŠ¡</span>  service.Init()    <span class="hljs-comment">// æ³¨å†Œå¤„ç†ç¨‹åº</span>  <span class="hljs-keyword">if</span> err := micro.RegisterHandler(service.Server(), <span class="hljs-built_in">new</span>(GreeterHandler)); err != <span class="hljs-literal">nil</span> &#123;    log.Fatal(err)  &#125;    <span class="hljs-comment">// è¿è¡ŒæœåŠ¡</span>  <span class="hljs-keyword">if</span> err := service.Run(); err != <span class="hljs-literal">nil</span> &#123;    log.Fatal(err)  &#125;&#125;</code></pre><h4 id="3-gRPC-æ ‡å‡†åº“"><a class="header-anchor" href="#3-gRPC-æ ‡å‡†åº“"></a>3. gRPC + æ ‡å‡†åº“</h4><p>ä½¿ç”¨gRPCå’ŒGoæ ‡å‡†åº“æ„å»ºå¾®æœåŠ¡æ˜¯ä¸€ç§è½»é‡çº§ä½†åŠŸèƒ½å¼ºå¤§çš„æ–¹æ¡ˆã€‚</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>é«˜æ€§èƒ½çš„RPCé€šä¿¡</li><li>å¼ºç±»å‹APIå®šä¹‰ï¼ˆä½¿ç”¨Protocol Buffersï¼‰</li><li>æ”¯æŒå¤šç§è¯­è¨€</li><li>ç”Ÿæ€ç³»ç»Ÿæ—¥ç›Šå¼ºå¤§</li><li>è½»é‡çº§ï¼Œå‡ ä¹æ²¡æœ‰é¢å¤–ä¾èµ–</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>éœ€è¦è‡ªè¡Œå®ç°æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½</li><li>éœ€è¦å­¦ä¹ Protocol Buffersè¯­æ³•</li><li>å®¢æˆ·ç«¯éœ€è¦Protocol Buffersæ”¯æŒ</li></ul><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼Œæˆ–éœ€è¦è·¨è¯­è¨€æ”¯æŒçš„å¾®æœåŠ¡ç³»ç»Ÿã€‚</p><p>ä»£ç ç¤ºä¾‹(å…ˆå®šä¹‰protoæ–‡ä»¶)ï¼š</p><pre><code class="hljs protobuf"><span class="hljs-comment">// greeter.proto</span>syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<span class="hljs-keyword">package</span> greeter;<span class="hljs-class"><span class="hljs-keyword">service</span> <span class="hljs-title">Greeter</span> </span>&#123;  <span class="hljs-function"><span class="hljs-keyword">rpc</span> Hello(HelloRequest) <span class="hljs-keyword">returns</span> (HelloResponse) </span>&#123;&#125;&#125;<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">HelloRequest</span> </span>&#123;  <span class="hljs-built_in">string</span> name = <span class="hljs-number">1</span>;&#125;<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">HelloResponse</span> </span>&#123;  <span class="hljs-built_in">string</span> greeting = <span class="hljs-number">1</span>;&#125;</code></pre><p>Goä»£ç å®ç°ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// æœåŠ¡ç«¯</span><span class="hljs-keyword">import</span> (  <span class="hljs-string">&quot;context&quot;</span>  <span class="hljs-string">&quot;google.golang.org/grpc&quot;</span>  pb <span class="hljs-string">&quot;myproject/proto/greeter&quot;</span>)<span class="hljs-keyword">type</span> server <span class="hljs-keyword">struct</span> &#123;  pb.UnimplementedGreeterServer&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *server)</span> <span class="hljs-title">Hello</span><span class="hljs-params">(ctx context.Context, req *pb.HelloRequest)</span> <span class="hljs-params">(*pb.HelloResponse, error)</span></span> &#123;  <span class="hljs-keyword">return</span> &amp;pb.HelloResponse&#123;Greeting: <span class="hljs-string">&quot;Hello, &quot;</span> + req.Name&#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;  lis, err := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;:50051&quot;</span>)  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;    log.Fatalf(<span class="hljs-string">&quot;failed to listen: %v&quot;</span>, err)  &#125;  s := grpc.NewServer()  pb.RegisterGreeterServer(s, &amp;server&#123;&#125;)  <span class="hljs-keyword">if</span> err := s.Serve(lis); err != <span class="hljs-literal">nil</span> &#123;    log.Fatalf(<span class="hljs-string">&quot;failed to serve: %v&quot;</span>, err)  &#125;&#125;</code></pre><h4 id="4-Gin-gRPC"><a class="header-anchor" href="#4-Gin-gRPC"></a>4. Gin + gRPC</h4><p>å°†Ginä½œä¸ºHTTPå±‚ä¸gRPCæœåŠ¡ç»“åˆä½¿ç”¨ï¼Œæ˜¯ä¸€ç§çµæ´»ä¸”å¼ºå¤§çš„æ–¹æ¡ˆã€‚</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>ç»“åˆäº†Ginçš„é«˜æ€§èƒ½HTTPè·¯ç”±å’Œä¸­é—´ä»¶ç”Ÿæ€</li><li>ä¸gRPCçš„é«˜æ•ˆé€šä¿¡</li><li>å¯ä»¥åŒæ—¶æ”¯æŒHTTPå’ŒRPCæ¥å£</li><li>ä¿æŒä»£ç çš„ç®€æ´å’Œé«˜æ•ˆ</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>éœ€è¦ç»´æŠ¤ä¸¤å¥—APIï¼ˆHTTPå’ŒgRPCï¼‰</li><li>é›†æˆéœ€è¦ä¸€å®šçš„å·¥ä½œé‡</li></ul><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> éœ€è¦åŒæ—¶æä¾›HTTPå’ŒRPCæ¥å£çš„æœåŠ¡ï¼Œæˆ–ä»ç°æœ‰REST APIè¿ç§»åˆ°gRPCã€‚</p><p>ä»£ç ç¤ºä¾‹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> (  <span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span>  <span class="hljs-string">&quot;google.golang.org/grpc&quot;</span>  pb <span class="hljs-string">&quot;myproject/proto/greeter&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;  <span class="hljs-comment">// å¯åŠ¨gRPCæœåŠ¡å™¨</span>  <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;    lis, err := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;:50051&quot;</span>)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;      log.Fatalf(<span class="hljs-string">&quot;failed to listen: %v&quot;</span>, err)    &#125;    s := grpc.NewServer()    pb.RegisterGreeterServer(s, &amp;server&#123;&#125;)    <span class="hljs-keyword">if</span> err := s.Serve(lis); err != <span class="hljs-literal">nil</span> &#123;      log.Fatalf(<span class="hljs-string">&quot;failed to serve: %v&quot;</span>, err)    &#125;  &#125;()    <span class="hljs-comment">// è®¾ç½®Gin HTTPæœåŠ¡å™¨</span>  r := gin.Default()  r.GET(<span class="hljs-string">&quot;/hello/:name&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;    name := c.Param(<span class="hljs-string">&quot;name&quot;</span>)        <span class="hljs-comment">// è¿æ¥åˆ°gRPCæœåŠ¡</span>    conn, err := grpc.Dial(<span class="hljs-string">&quot;localhost:50051&quot;</span>, grpc.WithInsecure())    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;      c.JSON(<span class="hljs-number">500</span>, gin.H&#123;<span class="hljs-string">&quot;error&quot;</span>: err.Error()&#125;)      <span class="hljs-keyword">return</span>    &#125;    <span class="hljs-keyword">defer</span> conn.Close()        client := pb.NewGreeterClient(conn)    resp, err := client.Hello(c.Request.Context(), &amp;pb.HelloRequest&#123;Name: name&#125;)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;      c.JSON(<span class="hljs-number">500</span>, gin.H&#123;<span class="hljs-string">&quot;error&quot;</span>: err.Error()&#125;)      <span class="hljs-keyword">return</span>    &#125;        c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<span class="hljs-string">&quot;greeting&quot;</span>: resp.Greeting&#125;)  &#125;)    r.Run(<span class="hljs-string">&quot;:8080&quot;</span>)&#125;</code></pre><h4 id="5-Kratos"><a class="header-anchor" href="#5-Kratos"></a>5. Kratos</h4><p><a href="https://github.com/go-kratos/kratos">Kratos</a> æ˜¯å“”å“©å“”å“©å¼€æºçš„ä¸€å¥—Goå¾®æœåŠ¡æ¡†æ¶ï¼Œæä¾›å…¨æ ˆè§£å†³æ–¹æ¡ˆã€‚</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>å…¨åŠŸèƒ½æ¡†æ¶ï¼Œæä¾›å®Œæ•´çš„å¾®æœåŠ¡è§£å†³æ–¹æ¡ˆ</li><li>é«˜æ€§èƒ½ã€å¯é æ€§å’Œå¯æ‰©å±•æ€§</li><li>å†…ç½®ä¸°å¯Œçš„ä¸­é—´ä»¶</li><li>æ”¯æŒHTTP/gRPCåŒåè®®</li><li>å›½å†…è¾ƒå¥½çš„ç¤¾åŒºæ”¯æŒ</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>æ–‡æ¡£ç›¸å¯¹è¾ƒå°‘ï¼ˆå°¤å…¶æ˜¯è‹±æ–‡æ–‡æ¡£ï¼‰</li><li>å­¦ä¹ æ›²çº¿ä¸­ç­‰</li></ul><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> ä¸­å¤§å‹å¾®æœåŠ¡ç³»ç»Ÿï¼Œç‰¹åˆ«æ˜¯å›½å†…å›¢é˜Ÿå¼€å‘çš„é¡¹ç›®ã€‚</p><p>ä»£ç ç¤ºä¾‹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> (  <span class="hljs-string">&quot;github.com/go-kratos/kratos/v2&quot;</span>  <span class="hljs-string">&quot;github.com/go-kratos/kratos/v2/transport/http&quot;</span>  <span class="hljs-string">&quot;github.com/go-kratos/kratos/v2/transport/grpc&quot;</span>)<span class="hljs-comment">// æœåŠ¡å®ç°</span><span class="hljs-keyword">type</span> GreeterService <span class="hljs-keyword">struct</span> &#123;  pb.UnimplementedGreeterServer&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *GreeterService)</span> <span class="hljs-title">Hello</span><span class="hljs-params">(ctx context.Context, req *pb.HelloRequest)</span> <span class="hljs-params">(*pb.HelloResponse, error)</span></span> &#123;  <span class="hljs-keyword">return</span> &amp;pb.HelloResponse&#123;Greeting: <span class="hljs-string">&quot;Hello, &quot;</span> + req.Name&#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;  <span class="hljs-comment">// HTTPæœåŠ¡</span>  httpSrv := http.NewServer(    http.Address(<span class="hljs-string">&quot;:8000&quot;</span>),  )    <span class="hljs-comment">// gRPCæœåŠ¡</span>  grpcSrv := grpc.NewServer(    grpc.Address(<span class="hljs-string">&quot;:9000&quot;</span>),  )    <span class="hljs-comment">// æ³¨å†ŒæœåŠ¡</span>  greeter := &amp;GreeterService&#123;&#125;  pb.RegisterGreeterServer(grpcSrv, greeter)  pb.RegisterGreeterHTTPServer(httpSrv, greeter)    <span class="hljs-comment">// åˆ›å»ºKratosåº”ç”¨</span>  app := kratos.New(    kratos.Name(<span class="hljs-string">&quot;greeter&quot;</span>),    kratos.Server(httpSrv, grpcSrv),  )    <span class="hljs-comment">// å¯åŠ¨åº”ç”¨</span>  <span class="hljs-keyword">if</span> err := app.Run(); err != <span class="hljs-literal">nil</span> &#123;    log.Fatal(err)  &#125;&#125;</code></pre><h3 id="ğŸŒŸ-å¾®æœåŠ¡æ¶æ„å…³é”®ç»„ä»¶"><a class="header-anchor" href="#ğŸŒŸ-å¾®æœåŠ¡æ¶æ„å…³é”®ç»„ä»¶"></a>ğŸŒŸ å¾®æœåŠ¡æ¶æ„å…³é”®ç»„ä»¶</h3><p>æ— è®ºé€‰æ‹©å“ªä¸ªæ¡†æ¶ï¼Œå¾®æœåŠ¡æ¶æ„éƒ½éœ€è¦å¤„ç†ä»¥ä¸‹å…³é”®ç»„ä»¶ï¼š</p><h4 id="1-æœåŠ¡æ³¨å†Œä¸å‘ç°"><a class="header-anchor" href="#1-æœåŠ¡æ³¨å†Œä¸å‘ç°"></a>1. æœåŠ¡æ³¨å†Œä¸å‘ç°</h4><p>æœåŠ¡éœ€è¦åœ¨å¯åŠ¨æ—¶æ³¨å†Œè‡ªå·±ï¼Œå¹¶èƒ½å¤Ÿå‘ç°å’Œè¿æ¥å…¶ä»–æœåŠ¡ã€‚å¸¸ç”¨é€‰é¡¹ï¼š</p><ul><li><strong>Consul</strong>ï¼šåŠŸèƒ½å®Œæ•´çš„æœåŠ¡ç½‘æ ¼è§£å†³æ–¹æ¡ˆ</li><li><strong>etcd</strong>ï¼šåˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ï¼Œé€‚åˆæœåŠ¡å‘ç°</li><li><strong>Nacos</strong>ï¼šé˜¿é‡Œå¼€æºçš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®å’ŒæœåŠ¡ç®¡ç†å¹³å°</li></ul><p>ç¤ºä¾‹ï¼ˆä½¿ç”¨Consulï¼‰ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/hashicorp/consul/api&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">registerService</span><span class="hljs-params">()</span></span> &#123;  config := api.DefaultConfig()  client, err := api.NewClient(config)  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;    log.Fatal(err)  &#125;    registration := &amp;api.AgentServiceRegistration&#123;    ID:      <span class="hljs-string">&quot;greeter-1&quot;</span>,    Name:    <span class="hljs-string">&quot;greeter&quot;</span>,    Port:    <span class="hljs-number">8080</span>,    Address: <span class="hljs-string">&quot;127.0.0.1&quot;</span>,    Check: &amp;api.AgentServiceCheck&#123;      HTTP:     <span class="hljs-string">&quot;http://127.0.0.1:8080/health&quot;</span>,      Interval: <span class="hljs-string">&quot;10s&quot;</span>,    &#125;,  &#125;    <span class="hljs-keyword">if</span> err := client.Agent().ServiceRegister(registration); err != <span class="hljs-literal">nil</span> &#123;    log.Fatal(err)  &#125;&#125;</code></pre><h4 id="2-APIç½‘å…³"><a class="header-anchor" href="#2-APIç½‘å…³"></a>2. APIç½‘å…³</h4><p>APIç½‘å…³ä½œä¸ºå®¢æˆ·ç«¯å’Œå¾®æœåŠ¡ä¹‹é—´çš„å…¥å£ç‚¹ï¼Œå¤„ç†è·¨åˆ‡é¢å…³æ³¨ç‚¹å¦‚è®¤è¯ã€è·¯ç”±å’Œè´Ÿè½½å‡è¡¡ã€‚å¸¸ç”¨é€‰é¡¹ï¼š</p><ul><li><strong>Traefik</strong>ï¼šç°ä»£HTTPåå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨</li><li><strong>Kong</strong>ï¼šäº‘åŸç”ŸAPIç½‘å…³</li><li><strong>API Gateway + gRPC-Gateway</strong>ï¼šå°†gRPCæœåŠ¡æš´éœ²ä¸ºRESTful API</li></ul><h4 id="3-æ–­è·¯å™¨å’Œé‡è¯•æœºåˆ¶"><a class="header-anchor" href="#3-æ–­è·¯å™¨å’Œé‡è¯•æœºåˆ¶"></a>3. æ–­è·¯å™¨å’Œé‡è¯•æœºåˆ¶</h4><p>é˜²æ­¢çº§è”æ•…éšœå¹¶å¢å¼ºç³»ç»Ÿå¼¹æ€§ã€‚å¸¸ç”¨é€‰é¡¹ï¼š</p><ul><li><strong>Hystrix</strong>ï¼šNetflixå¼€æºçš„å»¶è¿Ÿå’Œå®¹é”™åº“</li><li><strong>resilience4j</strong>ï¼šä¸“ä¸ºå‡½æ•°å¼ç¼–ç¨‹è®¾è®¡çš„å®¹é”™åº“</li><li><strong>è‡ªå®šä¹‰å®ç°</strong>ï¼šåŸºäºç®€å•çŠ¶æ€æœºçš„æ–­è·¯å™¨</li></ul><p>ç¤ºä¾‹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/sony/gobreaker&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createCircuitBreaker</span><span class="hljs-params">()</span> *<span class="hljs-title">gobreaker</span>.<span class="hljs-title">CircuitBreaker</span></span> &#123;  <span class="hljs-keyword">return</span> gobreaker.NewCircuitBreaker(gobreaker.Settings&#123;    Name:        <span class="hljs-string">&quot;HTTP-SERVICE&quot;</span>,    MaxRequests: <span class="hljs-number">3</span>,    Interval:    <span class="hljs-number">5</span> * time.Second,    Timeout:     <span class="hljs-number">30</span> * time.Second,    ReadyToTrip: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(counts gobreaker.Counts)</span> <span class="hljs-title">bool</span></span> &#123;      failureRatio := <span class="hljs-keyword">float64</span>(counts.TotalFailures) / <span class="hljs-keyword">float64</span>(counts.Requests)      <span class="hljs-keyword">return</span> counts.Requests &gt;= <span class="hljs-number">3</span> &amp;&amp; failureRatio &gt;= <span class="hljs-number">0.6</span>    &#125;,  &#125;)&#125;<span class="hljs-comment">// ä½¿ç”¨æ–­è·¯å™¨</span>cb := createCircuitBreaker()response, err := cb.Execute(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span></span> &#123;  <span class="hljs-keyword">return</span> http.Get(<span class="hljs-string">&quot;https://api.example.com/data&quot;</span>)&#125;)</code></pre><h4 id="4-åˆ†å¸ƒå¼è¿½è¸ª"><a class="header-anchor" href="#4-åˆ†å¸ƒå¼è¿½è¸ª"></a>4. åˆ†å¸ƒå¼è¿½è¸ª</h4><p>è¿½è¸ªè¯·æ±‚åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„å®Œæ•´æµç¨‹ï¼Œä¾¿äºè°ƒè¯•å’Œæ€§èƒ½åˆ†æã€‚å¸¸ç”¨é€‰é¡¹ï¼š</p><ul><li><strong>Jaeger</strong>ï¼šUberå¼€æºçš„ç«¯åˆ°ç«¯åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ</li><li><strong>Zipkin</strong>ï¼šTwitterå¼€æºçš„åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ</li><li><strong>OpenTelemetry</strong>ï¼šç”¨äºåˆ†å¸ƒå¼è¿½è¸ªçš„æ ‡å‡†åŒ–æ¡†æ¶</li></ul><p>ç¤ºä¾‹ï¼ˆä½¿ç”¨OpenTelemetryï¼‰ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> (  <span class="hljs-string">&quot;go.opentelemetry.io/otel&quot;</span>  <span class="hljs-string">&quot;go.opentelemetry.io/otel/trace&quot;</span>  <span class="hljs-string">&quot;go.opentelemetry.io/otel/exporters/jaeger&quot;</span>  sdktrace <span class="hljs-string">&quot;go.opentelemetry.io/otel/sdk/trace&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initTracer</span><span class="hljs-params">()</span> <span class="hljs-params">(<span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;  exporter, err := jaeger.New(    jaeger.WithCollectorEndpoint(jaeger.WithEndpoint(<span class="hljs-string">&quot;http://localhost:14268/api/traces&quot;</span>)),  )  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err  &#125;    tp := sdktrace.NewTracerProvider(    sdktrace.WithSampler(sdktrace.AlwaysSample()),    sdktrace.WithBatcher(exporter),  )  otel.SetTracerProvider(tp)    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;    _ = tp.Shutdown(context.Background())  &#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// ä½¿ç”¨è¿½è¸ª</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handleRequest</span><span class="hljs-params">(ctx context.Context, req <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;  tracer := otel.Tracer(<span class="hljs-string">&quot;service-name&quot;</span>)  ctx, span := tracer.Start(ctx, <span class="hljs-string">&quot;handleRequest&quot;</span>)  <span class="hljs-keyword">defer</span> span.End()    <span class="hljs-comment">// ä¸šåŠ¡é€»è¾‘...</span>  result := process(ctx, req)    span.SetAttributes(attribute.String(<span class="hljs-string">&quot;result&quot;</span>, result))&#125;</code></pre><h3 id="ğŸ’¡-æ¡†æ¶é€‰å‹å»ºè®®"><a class="header-anchor" href="#ğŸ’¡-æ¡†æ¶é€‰å‹å»ºè®®"></a>ğŸ’¡ æ¡†æ¶é€‰å‹å»ºè®®</h3><ol><li><strong>è€ƒè™‘å›¢é˜Ÿç»éªŒ</strong>ï¼šé€‰æ‹©å›¢é˜Ÿç†Ÿæ‚‰çš„æŠ€æœ¯æ ˆï¼Œé™ä½å­¦ä¹ æˆæœ¬</li><li><strong>è¯„ä¼°é¡¹ç›®å¤æ‚åº¦</strong>ï¼šç®€å•é¡¹ç›®å¯ä»¥ç”¨è½»é‡çº§æ¡†æ¶ï¼Œå¤æ‚é¡¹ç›®éœ€è¦æ›´å¤šæ”¯æŒ</li><li><strong>æ€§èƒ½éœ€æ±‚</strong>ï¼šå¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ï¼Œè€ƒè™‘gRPCæˆ–é«˜æ€§èƒ½æ¡†æ¶</li><li><strong>ç”Ÿæ€ç³»ç»Ÿ</strong>ï¼šè€ƒè™‘ç¤¾åŒºæ”¯æŒã€ä¸­é—´ä»¶å’Œæ’ä»¶çš„ä¸°å¯Œç¨‹åº¦</li><li><strong>é•¿æœŸç»´æŠ¤</strong>ï¼šè¯„ä¼°æ¡†æ¶çš„æ´»è·ƒåº¦å’Œç»´æŠ¤çŠ¶å†µ</li><li><strong>å¯è§‚æµ‹æ€§</strong>ï¼šç¡®ä¿æ¡†æ¶æ”¯æŒç›‘æ§ã€æ—¥å¿—å’Œè¿½è¸ªåŠŸèƒ½</li></ol><p>æŒ‰é¡¹ç›®ç±»å‹çš„å»ºè®®ï¼š</p><table><thead><tr><th>é¡¹ç›®ç±»å‹</th><th>æ¨èæ¡†æ¶</th></tr></thead><tbody><tr><td>ç®€å•APIæœåŠ¡</td><td>Gin + gRPC</td></tr><tr><td>ä¼ä¸šçº§å¾®æœåŠ¡</td><td>Go-kit æˆ– Kratos</td></tr><tr><td>å†…éƒ¨ç³»ç»Ÿé›†æˆ</td><td>Go Micro</td></tr><tr><td>é«˜æ€§èƒ½æœåŠ¡</td><td>çº¯gRPC</td></tr><tr><td>æ¸è¿›å¼å¾®æœåŠ¡è¿ç§»</td><td>Gin + gRPC</td></tr></tbody></table><h3 id="ğŸ”-å®è·µç»éªŒåˆ†äº«"><a class="header-anchor" href="#ğŸ”-å®è·µç»éªŒåˆ†äº«"></a>ğŸ” å®è·µç»éªŒåˆ†äº«</h3><h4 id="æ¡ˆä¾‹ç ”ç©¶ï¼šä»å•ä½“åº”ç”¨è¿ç§»åˆ°å¾®æœåŠ¡"><a class="header-anchor" href="#æ¡ˆä¾‹ç ”ç©¶ï¼šä»å•ä½“åº”ç”¨è¿ç§»åˆ°å¾®æœåŠ¡"></a>æ¡ˆä¾‹ç ”ç©¶ï¼šä»å•ä½“åº”ç”¨è¿ç§»åˆ°å¾®æœåŠ¡</h4><ol><li><p><strong>è¯†åˆ«æœåŠ¡è¾¹ç•Œ</strong></p><ul><li>æŒ‰ä¸šåŠ¡åŠŸèƒ½åˆ’åˆ†æœåŠ¡</li><li>ç¡®ä¿æœåŠ¡ä¹‹é—´ä½è€¦åˆã€é«˜å†…èš</li><li>ä»éæ ¸å¿ƒã€å˜åŒ–é¢‘ç‡é«˜çš„æ¨¡å—å¼€å§‹åˆ‡åˆ†</li></ul></li><li><p><strong>æ•°æ®ç®¡ç†ç­–ç•¥</strong></p><ul><li>å®æ–½æ•°æ®åº“æŒ‰æœåŠ¡æ‹†åˆ†</li><li>å¯¹å…±äº«æ•°æ®å®æ–½æœ‰æ•ˆçš„ä¸€è‡´æ€§ç­–ç•¥</li><li>å®ç°è·¨æœåŠ¡æ•°æ®æŸ¥è¯¢çš„è¡¥å¿æœºåˆ¶</li></ul></li><li><p><strong>APIç‰ˆæœ¬ç®¡ç†</strong></p><ul><li>ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶</li><li>ç»´æŠ¤å‘åå…¼å®¹æ€§</li><li>å®æ–½APIç½‘å…³è¿›è¡Œç‰ˆæœ¬è·¯ç”±</li></ul></li><li><p><strong>æµ‹è¯•ç­–ç•¥</strong></p><ul><li>å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒä¸šåŠ¡é€»è¾‘</li><li>é›†æˆæµ‹è¯•éªŒè¯æœåŠ¡é—´é€šä¿¡</li><li>å¥‘çº¦æµ‹è¯•ç¡®ä¿æ¥å£ä¸€è‡´æ€§</li></ul></li></ol><h4 id="å¾®æœåŠ¡å¼€å‘çš„æœ€ä½³å®è·µ"><a class="header-anchor" href="#å¾®æœåŠ¡å¼€å‘çš„æœ€ä½³å®è·µ"></a>å¾®æœåŠ¡å¼€å‘çš„æœ€ä½³å®è·µ</h4><ol><li><p><strong>è®¾è®¡åŸåˆ™</strong></p><ul><li>æ¯ä¸ªæœåŠ¡ä¸“æ³¨äºå•ä¸€è´£ä»»</li><li>æœåŠ¡ä¹‹é—´é€šè¿‡æ˜ç¡®çš„APIé€šä¿¡</li><li>é¿å…å…±äº«æ•°æ®åº“ï¼Œå¼ºè°ƒAPIçº§åˆ«çš„é›†æˆ</li><li>å®ç°ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•èƒ½åŠ›</li></ul></li><li><p><strong>ä»£ç ç»„ç»‡</strong></p><ul><li>æŒ‰é¢†åŸŸè€ŒéæŠ€æœ¯å±‚é¢ç»„ç»‡ä»£ç </li><li>é‡‡ç”¨å…­è¾¹å½¢æ¶æ„/æ´‹è‘±æ¶æ„åˆ†ç¦»ä¸šåŠ¡é€»è¾‘å’ŒæŠ€æœ¯ç»†èŠ‚</li><li>ä½¿ç”¨ä¾èµ–æ³¨å…¥å®ç°ç»„ä»¶è§£è€¦</li></ul></li><li><p><strong>é”™è¯¯å¤„ç†</strong></p><ul><li>ç»Ÿä¸€é”™è¯¯ç å’Œé”™è¯¯è¿”å›æ ¼å¼</li><li>å®ç°ä¼˜é›…çš„æœåŠ¡é™çº§ç­–ç•¥</li><li>æ—¥å¿—è®°å½•åŒ…å«è¶³å¤Ÿä¸Šä¸‹æ–‡ä¿¡æ¯</li></ul></li><li><p><strong>ç›‘æ§ä¸å¯è§‚æµ‹æ€§</strong></p><ul><li>å®ç°å¥åº·æ£€æŸ¥API</li><li>æ”¶é›†å…³é”®æŒ‡æ ‡ï¼ˆè¯·æ±‚ç‡ã€é”™è¯¯ç‡ã€å»¶è¿Ÿï¼‰</li><li>å®æ–½é›†ä¸­å¼æ—¥å¿—å’Œåˆ†å¸ƒå¼è¿½è¸ª</li></ul></li></ol><h3 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h3><p>é€‰æ‹©åˆé€‚çš„Goå¾®æœåŠ¡æ¡†æ¶éœ€è¦ç»¼åˆè€ƒè™‘é¡¹ç›®éœ€æ±‚ã€å›¢é˜Ÿç»éªŒå’Œé•¿æœŸç»´æŠ¤æˆæœ¬ã€‚æ²¡æœ‰&quot;æœ€å¥½&quot;çš„æ¡†æ¶ï¼Œåªæœ‰&quot;æœ€é€‚åˆ&quot;çš„æ–¹æ¡ˆã€‚</p><ul><li><strong>å¯¹äºå°å‹é¡¹ç›®</strong>ï¼šè½»é‡çº§æ–¹æ¡ˆå¦‚gin+gRPCè¶³å¤Ÿåº”å¯¹</li><li><strong>å¯¹äºä¸­å¤§å‹é¡¹ç›®</strong>ï¼šå¯ä»¥è€ƒè™‘Kratosæˆ–Go-kitç­‰åŠŸèƒ½å®Œæ•´çš„æ¡†æ¶</li><li><strong>å¯¹äºç‰¹å®šéœ€æ±‚</strong>ï¼šå¦‚æ€§èƒ½å…³é”®å‹åº”ç”¨ï¼Œçº¯gRPCæ˜¯è‰¯å¥½é€‰æ‹©</li></ul><p>å¾®æœåŠ¡æ¶æ„æœ¬èº«æ¯”æ¡†æ¶é€‰æ‹©æ›´ä¸ºé‡è¦ã€‚æ— è®ºé€‰æ‹©å“ªä¸ªæ¡†æ¶ï¼Œéƒ½éœ€è¦è§£å†³æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€ç›‘æ§å’Œå¼¹æ€§ç­‰å…±æ€§é—®é¢˜ã€‚é€šè¿‡æ·±å…¥ç†è§£å¾®æœåŠ¡æ¶æ„åŸåˆ™ï¼Œåˆç†é€‰å‹å¹¶éµå¾ªæœ€ä½³å®è·µï¼Œæ‰èƒ½æ„å»ºå‡ºå¥å£®ã€å¯æ‰©å±•çš„å¾®æœåŠ¡ç³»ç»Ÿã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
      <category>å¾®æœåŠ¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
      <tag>æ¡†æ¶</tag>
      
      <tag>gRPC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golangå¾®æœåŠ¡æ¡†æ¶é€‰å‹ä¸å®è·µ</title>
    <link href="/2024/02/15/golang%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6%E9%80%89%E5%9E%8B%E4%B8%8E%E5%AE%9E%E8%B7%B5/"/>
    <url>/2024/02/15/golang%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6%E9%80%89%E5%9E%8B%E4%B8%8E%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="golangå¾®æœåŠ¡æ¡†æ¶é€‰å‹ä¸å®è·µ"><a class="header-anchor" href="#golangå¾®æœåŠ¡æ¡†æ¶é€‰å‹ä¸å®è·µ"></a>golangå¾®æœåŠ¡æ¡†æ¶é€‰å‹ä¸å®è·µ</h2><h3 id="ğŸ”-å¾®æœåŠ¡æ¶æ„çš„ä»·å€¼ä¸æŒ‘æˆ˜"><a class="header-anchor" href="#ğŸ”-å¾®æœåŠ¡æ¶æ„çš„ä»·å€¼ä¸æŒ‘æˆ˜"></a>ğŸ” å¾®æœåŠ¡æ¶æ„çš„ä»·å€¼ä¸æŒ‘æˆ˜</h3><p>å¾®æœåŠ¡æ¶æ„ä½œä¸ºç°ä»£åº”ç”¨å¼€å‘çš„ä¸»æµèŒƒå¼ï¼Œé€šè¿‡å°†å¤æ‚ç³»ç»Ÿæ‹†åˆ†ä¸ºä¸€ç³»åˆ—å°å‹ã€æ¾è€¦åˆã€å¯ç‹¬ç«‹éƒ¨ç½²çš„æœåŠ¡ï¼Œå¸¦æ¥äº†æ˜¾è‘—çš„æ•æ·æ€§å’Œå¯ä¼¸ç¼©æ€§æå‡ã€‚Goè¯­è¨€å‡­å€Ÿå…¶å‡ºè‰²çš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€ä½èµ„æºå ç”¨å’Œé«˜æ€§èƒ½ç‰¹æ€§ï¼Œæˆä¸ºå®ç°å¾®æœåŠ¡çš„ç†æƒ³é€‰æ‹©ã€‚</p><p>ç„¶è€Œï¼Œå¾®æœåŠ¡æ¶æ„ä¹Ÿå¸¦æ¥äº†è¯¸å¤šæŒ‘æˆ˜ï¼ŒåŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€ç†”æ–­é™çº§ã€åˆ†å¸ƒå¼è·Ÿè¸ªç­‰ã€‚ä¸ºäº†åº”å¯¹è¿™äº›æŒ‘æˆ˜ï¼Œå¤šç§Goå¾®æœåŠ¡æ¡†æ¶åº”è¿è€Œç”Ÿã€‚æœ¬æ–‡å°†å¯¹ä¸»æµæ¡†æ¶è¿›è¡Œåˆ†ææ¯”è¾ƒï¼Œå¹¶æä¾›é€‰å‹å»ºè®®å’Œå®è·µæ¡ˆä¾‹ã€‚</p><h3 id="ğŸ› ï¸-ä¸»æµGoå¾®æœåŠ¡æ¡†æ¶å¯¹æ¯”"><a class="header-anchor" href="#ğŸ› ï¸-ä¸»æµGoå¾®æœåŠ¡æ¡†æ¶å¯¹æ¯”"></a>ğŸ› ï¸ ä¸»æµGoå¾®æœåŠ¡æ¡†æ¶å¯¹æ¯”</h3><h4 id="1-Go-kit"><a class="header-anchor" href="#1-Go-kit"></a>1. Go-kit</h4><p><strong>ä¼˜åŠ¿ï¼š</strong></p><ul><li>æ¨¡å—åŒ–è®¾è®¡ï¼Œæä¾›äº†ä¸­é—´ä»¶ã€æ—¥å¿—ã€æŒ‡æ ‡ç­‰ç»„ä»¶</li><li>ä¸é™åˆ¶åº•å±‚ä¼ è¾“åè®®ï¼Œæ”¯æŒHTTPã€gRPCç­‰</li><li>å…·æœ‰è‰¯å¥½çš„å¯æµ‹è¯•æ€§</li><li>æä¾›äº†æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€ç†”æ–­å™¨ç­‰åŠŸèƒ½</li></ul><p><strong>åŠ£åŠ¿ï¼š</strong></p><ul><li>å­¦ä¹ æ›²çº¿è¾ƒé™¡å³­</li><li>éœ€è¦ç¼–å†™è¾ƒå¤šæ ·æ¿ä»£ç </li><li>å¯¹æ–°æ‰‹ä¸å¤Ÿå‹å¥½</li><li>è¾ƒä¸ºåº•å±‚ï¼Œéœ€è¦å¼€å‘è€…è‡ªè¡Œç»„è£…å„ç§ç»„ä»¶</li></ul><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p><ul><li>å¤§å‹å¤æ‚ä¼ä¸šçº§åº”ç”¨</li><li>éœ€è¦é«˜åº¦å®šåˆ¶åŒ–çš„åœºæ™¯</li><li>å·²æœ‰ç»éªŒä¸°å¯Œçš„Goå¼€å‘å›¢é˜Ÿ</li></ul><pre><code class="hljs go"><span class="hljs-comment">// Go-kit æœåŠ¡å®šä¹‰ç¤ºä¾‹</span><span class="hljs-keyword">type</span> Service <span class="hljs-keyword">interface</span> &#123;    GetUser(ctx context.Context, id <span class="hljs-keyword">string</span>) (User, error)&#125;<span class="hljs-comment">// ç«¯ç‚¹å®šä¹‰</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">makeGetUserEndpoint</span><span class="hljs-params">(svc Service)</span> <span class="hljs-title">endpoint</span>.<span class="hljs-title">Endpoint</span></span> &#123;    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, request <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span></span> &#123;        req := request.(getUserRequest)        user, err := svc.GetUser(ctx, req.ID)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-keyword">return</span> getUserResponse&#123;&#125;, err        &#125;        <span class="hljs-keyword">return</span> getUserResponse&#123;User: user&#125;, <span class="hljs-literal">nil</span>    &#125;&#125;</code></pre><h4 id="2-go-micro"><a class="header-anchor" href="#2-go-micro"></a>2. go-micro</h4><p><strong>ä¼˜åŠ¿ï¼š</strong></p><ul><li>æä¾›äº†å®Œæ•´çš„å¾®æœåŠ¡ç”Ÿæ€ç³»ç»Ÿ</li><li>å†…ç½®æœåŠ¡å‘ç°ã€æ¶ˆæ¯ç¼–ç ã€è´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½</li><li>æ’ä»¶åŒ–æ¶æ„ï¼Œå¯æ‰©å±•æ€§å¼º</li><li>æ›´ç®€æ´çš„APIå’Œè¾ƒå°‘çš„æ ·æ¿ä»£ç </li></ul><p><strong>åŠ£åŠ¿ï¼š</strong></p><ul><li>æ–‡æ¡£ç›¸å¯¹ä¸å¤Ÿå®Œå–„</li><li>ç¤¾åŒºæ´»è·ƒåº¦è¿‘æœŸæœ‰æ‰€ä¸‹é™</li><li>v2ç‰ˆæœ¬æ”¹åŠ¨è¾ƒå¤§ï¼Œè¿ç§»æˆæœ¬é«˜</li></ul><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p><ul><li>ä¸­å°å‹å¾®æœåŠ¡é¡¹ç›®</li><li>éœ€è¦å¿«é€Ÿå¼€å‘å’Œéƒ¨ç½²çš„åœºæ™¯</li><li>éœ€è¦å®Œæ•´å¾®æœåŠ¡åŠŸèƒ½é›†çš„é¡¹ç›®</li></ul><pre><code class="hljs go"><span class="hljs-comment">// go-micro æœåŠ¡å®šä¹‰ç¤ºä¾‹</span><span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span>&#123;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span> <span class="hljs-title">GetUser</span><span class="hljs-params">(ctx context.Context, req *proto.GetUserRequest, rsp *proto.GetUserResponse)</span> <span class="hljs-title">error</span></span> &#123;    user, err := repository.GetUser(req.Id)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> err    &#125;    rsp.User = &amp;proto.User&#123;        Id:   user.ID,        Name: user.Name,    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    service := micro.NewService(        micro.Name(<span class="hljs-string">&quot;user.service&quot;</span>),        micro.Version(<span class="hljs-string">&quot;latest&quot;</span>),    )    service.Init()        proto.RegisterUserServiceHandler(service.Server(), <span class="hljs-built_in">new</span>(UserService))        <span class="hljs-keyword">if</span> err := service.Run(); err != <span class="hljs-literal">nil</span> &#123;        log.Fatal(err)    &#125;&#125;</code></pre><h4 id="3-Gin-gRPC"><a class="header-anchor" href="#3-Gin-gRPC"></a>3. Gin + gRPC</h4><p><strong>ä¼˜åŠ¿ï¼š</strong></p><ul><li>Ginæä¾›é«˜æ€§èƒ½çš„HTTP APIå¤„ç†</li><li>gRPCæä¾›é«˜æ•ˆçš„æœåŠ¡é—´é€šä¿¡</li><li>ç»„åˆä½¿ç”¨çµæ´»æ€§é«˜</li><li>Ginçš„æ˜“ç”¨æ€§å’ŒgRPCçš„æ€§èƒ½ä¼˜åŠ¿äº’è¡¥</li></ul><p><strong>åŠ£åŠ¿ï¼š</strong></p><ul><li>éœ€è¦è‡ªè¡Œæ•´åˆå¤šä¸ªç»„ä»¶</li><li>ç¼ºä¹ç»Ÿä¸€çš„å¾®æœåŠ¡æ²»ç†åŠŸèƒ½</li><li>éœ€è¦æ›´å¤šæ‰‹åŠ¨é…ç½®</li></ul><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p><ul><li>éœ€è¦åŒæ—¶æä¾›REST APIå’ŒRPCæœåŠ¡çš„åœºæ™¯</li><li>å¯¹æ€§èƒ½è¦æ±‚é«˜çš„æœåŠ¡</li><li>å¸Œæœ›ä¿æŒæŠ€æœ¯æ ˆç®€å•çš„å›¢é˜Ÿ</li></ul><pre><code class="hljs go"><span class="hljs-comment">// gRPC æœåŠ¡å®šä¹‰</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *userServer)</span> <span class="hljs-title">GetUser</span><span class="hljs-params">(ctx context.Context, req *pb.GetUserRequest)</span> <span class="hljs-params">(*pb.GetUserResponse, error)</span></span> &#123;    user, err := s.repo.GetUser(req.Id)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, status.Errorf(codes.NotFound, <span class="hljs-string">&quot;ç”¨æˆ·æœªæ‰¾åˆ°: %v&quot;</span>, err)    &#125;    <span class="hljs-keyword">return</span> &amp;pb.GetUserResponse&#123;        User: &amp;pb.User&#123;            Id:   user.ID,            Name: user.Name,        &#125;,    &#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// Gin HTTP API</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setupRouter</span><span class="hljs-params">()</span> *<span class="hljs-title">gin</span>.<span class="hljs-title">Engine</span></span> &#123;    r := gin.Default()    r.GET(<span class="hljs-string">&quot;/users/:id&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;        id := c.Param(<span class="hljs-string">&quot;id&quot;</span>)        user, err := userService.GetUser(id)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            c.JSON(http.StatusNotFound, gin.H&#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;ç”¨æˆ·æœªæ‰¾åˆ°&quot;</span>&#125;)            <span class="hljs-keyword">return</span>        &#125;        c.JSON(http.StatusOK, user)    &#125;)    <span class="hljs-keyword">return</span> r&#125;</code></pre><h4 id="4-Kratos"><a class="header-anchor" href="#4-Kratos"></a>4. Kratos</h4><p><strong>ä¼˜åŠ¿ï¼š</strong></p><ul><li>å“”å“©å“”å“©å¼€æºçš„å®Œæ•´å¾®æœåŠ¡æ¡†æ¶</li><li>é›†æˆäº†gRPCå’ŒHTTPåŒåè®®æ”¯æŒ</li><li>å†…ç½®å¾®æœåŠ¡æ²»ç†åŠŸèƒ½ï¼ˆç†”æ–­ã€é™æµã€è¿½è¸ªç­‰ï¼‰</li><li>æä¾›äº†ä¸°å¯Œçš„ä¸­é—´ä»¶å’Œå·¥å…·é“¾</li></ul><p><strong>åŠ£åŠ¿ï¼š</strong></p><ul><li>ä¸­æ–‡æ–‡æ¡£ä¸ºä¸»ï¼Œå›½é™…åŒ–ç¨‹åº¦ä¸é«˜</li><li>å­¦ä¹ æ›²çº¿ç›¸å¯¹è¾ƒé«˜</li><li>æ¡†æ¶è¾ƒä¸ºé‡é‡çº§</li></ul><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p><ul><li>éœ€è¦å®Œæ•´å¾®æœåŠ¡æ²»ç†èƒ½åŠ›çš„ä¸­å¤§å‹é¡¹ç›®</li><li>å›½å†…å›¢é˜Ÿæ›´å®¹æ˜“ä¸Šæ‰‹</li><li>éœ€è¦åŒåè®®æ”¯æŒçš„åœºæ™¯</li></ul><pre><code class="hljs go"><span class="hljs-comment">// Kratos æœåŠ¡å®šä¹‰ç¤ºä¾‹</span><span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span> &#123;    pb.UnimplementedUserServer    uc *biz.UserUsecase&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserService</span><span class="hljs-params">(uc *biz.UserUsecase)</span> *<span class="hljs-title">UserService</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;UserService&#123;uc: uc&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span> <span class="hljs-title">GetUser</span><span class="hljs-params">(ctx context.Context, req *pb.GetUserRequest)</span> <span class="hljs-params">(*pb.GetUserResponse, error)</span></span> &#123;    user, err := s.uc.GetUser(ctx, req.Id)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;    <span class="hljs-keyword">return</span> &amp;pb.GetUserResponse&#123;        User: &amp;pb.User&#123;            Id:   user.ID,            Name: user.Name,        &#125;,    &#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// å¯åŠ¨æœåŠ¡</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    app, err := kratos.New(        kratos.Name(<span class="hljs-string">&quot;user.service&quot;</span>),        kratos.Version(<span class="hljs-string">&quot;1.0.0&quot;</span>),        kratos.Server(            grpcSrv,            httpSrv,        ),    )    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        log.Fatal(err)    &#125;        <span class="hljs-keyword">if</span> err := app.Run(); err != <span class="hljs-literal">nil</span> &#123;        log.Fatal(err)    &#125;&#125;</code></pre><h4 id="5-Kitex"><a class="header-anchor" href="#5-Kitex"></a>5. Kitex</h4><p><strong>ä¼˜åŠ¿ï¼š</strong></p><ul><li>å­—èŠ‚è·³åŠ¨å¼€æºçš„é«˜æ€§èƒ½RPCæ¡†æ¶</li><li>ä¸“æ³¨äºæè‡´æ€§èƒ½ï¼Œé€‚åˆå¤§è§„æ¨¡æœåŠ¡</li><li>å†…ç½®è´Ÿè½½å‡è¡¡ã€ç†”æ–­ã€é™æµç­‰åŠŸèƒ½</li><li>ä¸ Thrift åè®®æ— ç¼é›†æˆ</li></ul><p><strong>åŠ£åŠ¿ï¼š</strong></p><ul><li>ä¸»è¦èšç„¦äºRPCå±‚é¢ï¼Œä¸æ˜¯å®Œæ•´çš„å¾®æœåŠ¡æ¡†æ¶</li><li>éœ€è¦ä¸å…¶ä»–ç»„ä»¶ç»“åˆä½¿ç”¨</li><li>ç”Ÿæ€ç›¸å¯¹è¾ƒæ–°</li></ul><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p><ul><li>å¯¹æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯</li><li>å¤§è§„æ¨¡å¾®æœåŠ¡é›†ç¾¤</li><li>å·²æœ‰ Thrift ä½¿ç”¨ç»éªŒçš„å›¢é˜Ÿ</li></ul><pre><code class="hljs go"><span class="hljs-comment">// Kitex æœåŠ¡å®šä¹‰ç¤ºä¾‹</span><span class="hljs-keyword">type</span> UserServiceImpl <span class="hljs-keyword">struct</span>&#123;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserServiceImpl)</span> <span class="hljs-title">GetUser</span><span class="hljs-params">(ctx context.Context, req *api.GetUserRequest)</span> <span class="hljs-params">(*api.GetUserResponse, error)</span></span> &#123;    <span class="hljs-comment">// å®ç°è·å–ç”¨æˆ·é€»è¾‘</span>    <span class="hljs-keyword">return</span> &amp;api.GetUserResponse&#123;        User: &amp;api.User&#123;            Id:   req.Id,            Name: <span class="hljs-string">&quot;æµ‹è¯•ç”¨æˆ·&quot;</span>,        &#125;,    &#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    svr := userservice.NewServer(<span class="hljs-built_in">new</span>(UserServiceImpl))        err := svr.Run()    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        log.Fatal(err)    &#125;&#125;</code></pre><h3 id="ğŸ§ª-é€‰å‹è€ƒè™‘å› ç´ "><a class="header-anchor" href="#ğŸ§ª-é€‰å‹è€ƒè™‘å› ç´ "></a>ğŸ§ª é€‰å‹è€ƒè™‘å› ç´ </h3><p>åœ¨é€‰æ‹©Goå¾®æœåŠ¡æ¡†æ¶æ—¶ï¼Œåº”è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š</p><ol><li><p><strong>å›¢é˜ŸæŠ€æœ¯æ ˆå’Œç»éªŒ</strong>ï¼šé€‰æ‹©ä¸å›¢é˜ŸæŠ€æœ¯æ ˆç›¸ç¬¦ã€å­¦ä¹ æˆæœ¬é€‚ä¸­çš„æ¡†æ¶ã€‚</p></li><li><p><strong>æ€§èƒ½éœ€æ±‚</strong>ï¼šå¦‚æœæ€§èƒ½æ˜¯é¦–è¦è€ƒè™‘å› ç´ ï¼ŒKitexæˆ–gRPCæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚</p></li><li><p><strong>åŠŸèƒ½å®Œæ•´æ€§</strong>ï¼šå¦‚æœéœ€è¦å®Œæ•´çš„å¾®æœåŠ¡æ²»ç†åŠŸèƒ½ï¼ŒGo-kitæˆ–Kratosæ›´é€‚åˆã€‚</p></li><li><p><strong>ç¤¾åŒºæ´»è·ƒåº¦å’Œç”Ÿæ€</strong>ï¼šè€ƒè™‘æ¡†æ¶çš„ç¤¾åŒºæ”¯æŒå’Œé•¿æœŸç»´æŠ¤èƒ½åŠ›ã€‚</p></li><li><p><strong>é¡¹ç›®è§„æ¨¡å’Œå¤æ‚åº¦</strong>ï¼šå¤§å‹å¤æ‚é¡¹ç›®å¯èƒ½éœ€è¦åŠŸèƒ½æ›´å®Œæ•´çš„æ¡†æ¶ï¼Œè€Œå°å‹é¡¹ç›®å¯èƒ½é€‰æ‹©æ›´è½»é‡çº§çš„è§£å†³æ–¹æ¡ˆã€‚</p></li><li><p><strong>å¯æ‰©å±•æ€§</strong>ï¼šè€ƒè™‘æ¡†æ¶æ˜¯å¦æ”¯æŒæ’ä»¶åŒ–å’Œè‡ªå®šä¹‰æ‰©å±•ã€‚</p></li><li><p><strong>éƒ¨ç½²ç¯å¢ƒ</strong>ï¼šå¦‚æœé‡‡ç”¨Kubernetesç­‰å®¹å™¨ç¼–æ’å¹³å°ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘æ¡†æ¶å¯¹è¿™äº›ç¯å¢ƒçš„æ”¯æŒç¨‹åº¦ã€‚</p></li></ol><h3 id="ğŸ“Š-é€‰å‹å†³ç­–è¡¨"><a class="header-anchor" href="#ğŸ“Š-é€‰å‹å†³ç­–è¡¨"></a>ğŸ“Š é€‰å‹å†³ç­–è¡¨</h3><table><thead><tr><th>æ¡†æ¶</th><th>æ€§èƒ½</th><th>æ˜“ç”¨æ€§</th><th>åŠŸèƒ½å®Œæ•´æ€§</th><th>ç¤¾åŒºæ´»è·ƒåº¦</th><th>å­¦ä¹ æ›²çº¿</th><th>æœ€é€‚åˆåœºæ™¯</th></tr></thead><tbody><tr><td>Go-kit</td><td>â­â­â­â­</td><td>â­â­</td><td>â­â­â­â­â­</td><td>â­â­â­â­</td><td>é«˜</td><td>å¤§å‹ä¼ä¸šçº§åº”ç”¨</td></tr><tr><td>go-micro</td><td>â­â­â­</td><td>â­â­â­â­</td><td>â­â­â­â­</td><td>â­â­â­</td><td>ä¸­</td><td>ä¸­å°å‹é¡¹ç›®</td></tr><tr><td>Gin+gRPC</td><td>â­â­â­â­â­</td><td>â­â­â­â­â­</td><td>â­â­â­</td><td>â­â­â­â­â­</td><td>ä½</td><td>çµæ´»æ€§è¦æ±‚é«˜çš„é¡¹ç›®</td></tr><tr><td>Kratos</td><td>â­â­â­â­</td><td>â­â­â­â­</td><td>â­â­â­â­â­</td><td>â­â­â­</td><td>ä¸­é«˜</td><td>å®Œæ•´å¾®æœåŠ¡æ²»ç†éœ€æ±‚</td></tr><tr><td>Kitex</td><td>â­â­â­â­â­</td><td>â­â­â­</td><td>â­â­â­</td><td>â­â­â­</td><td>ä¸­</td><td>é«˜æ€§èƒ½RPCåœºæ™¯</td></tr></tbody></table><h3 id="ğŸ’¡-å®è·µæ¡ˆä¾‹ï¼šæ„å»ºç”¨æˆ·æœåŠ¡å¾®æœåŠ¡"><a class="header-anchor" href="#ğŸ’¡-å®è·µæ¡ˆä¾‹ï¼šæ„å»ºç”¨æˆ·æœåŠ¡å¾®æœåŠ¡"></a>ğŸ’¡ å®è·µæ¡ˆä¾‹ï¼šæ„å»ºç”¨æˆ·æœåŠ¡å¾®æœåŠ¡</h3><p>ä¸‹é¢ä»¥æ„å»ºä¸€ä¸ªç®€å•çš„ç”¨æˆ·æœåŠ¡ä¸ºä¾‹ï¼Œå±•ç¤ºä½¿ç”¨gRPC + Ginçš„å¾®æœåŠ¡å®è·µã€‚</p><h4 id="1-é¡¹ç›®ç»“æ„"><a class="header-anchor" href="#1-é¡¹ç›®ç»“æ„"></a>1. é¡¹ç›®ç»“æ„</h4><pre><code class="hljs routeros">/user-service  /api    /proto          # Protoæ–‡ä»¶å®šä¹‰  /cmd              # å…¥å£ç‚¹  /internal    /handler        # HTTPå¤„ç†å™¨    /repository     # æ•°æ®è®¿é—®å±‚    <span class="hljs-built_in">/service </span>       # ä¸šåŠ¡é€»è¾‘å±‚  /pkg    <span class="hljs-built_in">/config </span>        # é…ç½®ç®¡ç†    <span class="hljs-built_in">/discovery </span>     # æœåŠ¡å‘ç°    /middleware     # ä¸­é—´ä»¶    /logger         # æ—¥å¿—ç»„ä»¶  go.mod  Dockerfile</code></pre><h4 id="2-Protoå®šä¹‰"><a class="header-anchor" href="#2-Protoå®šä¹‰"></a>2. Protoå®šä¹‰</h4><pre><code class="hljs protobuf">syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<span class="hljs-keyword">package</span> user;<span class="hljs-keyword">option</span> go_package = <span class="hljs-string">&quot;userservice/api/proto&quot;</span>;<span class="hljs-class"><span class="hljs-keyword">service</span> <span class="hljs-title">UserService</span> </span>&#123;  <span class="hljs-function"><span class="hljs-keyword">rpc</span> GetUser(GetUserRequest) <span class="hljs-keyword">returns</span> (GetUserResponse)</span>;  <span class="hljs-function"><span class="hljs-keyword">rpc</span> CreateUser(CreateUserRequest) <span class="hljs-keyword">returns</span> (CreateUserResponse)</span>;  <span class="hljs-function"><span class="hljs-keyword">rpc</span> ListUsers(ListUsersRequest) <span class="hljs-keyword">returns</span> (ListUsersResponse)</span>;&#125;<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">User</span> </span>&#123;  <span class="hljs-built_in">string</span> id = <span class="hljs-number">1</span>;  <span class="hljs-built_in">string</span> name = <span class="hljs-number">2</span>;  <span class="hljs-built_in">string</span> email = <span class="hljs-number">3</span>;  <span class="hljs-built_in">int32</span> age = <span class="hljs-number">4</span>;&#125;<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">GetUserRequest</span> </span>&#123;  <span class="hljs-built_in">string</span> id = <span class="hljs-number">1</span>;&#125;<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">GetUserResponse</span> </span>&#123;  User user = <span class="hljs-number">1</span>;&#125;<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">CreateUserRequest</span> </span>&#123;  <span class="hljs-built_in">string</span> name = <span class="hljs-number">1</span>;  <span class="hljs-built_in">string</span> email = <span class="hljs-number">2</span>;  <span class="hljs-built_in">int32</span> age = <span class="hljs-number">3</span>;&#125;<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">CreateUserResponse</span> </span>&#123;  User user = <span class="hljs-number">1</span>;&#125;<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">ListUsersRequest</span> </span>&#123;  <span class="hljs-built_in">int32</span> page = <span class="hljs-number">1</span>;  <span class="hljs-built_in">int32</span> page_size = <span class="hljs-number">2</span>;&#125;<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">ListUsersResponse</span> </span>&#123;  <span class="hljs-keyword">repeated</span> User users = <span class="hljs-number">1</span>;  <span class="hljs-built_in">int32</span> total = <span class="hljs-number">2</span>;&#125;</code></pre><h4 id="3-æœåŠ¡å®ç°"><a class="header-anchor" href="#3-æœåŠ¡å®ç°"></a>3. æœåŠ¡å®ç°</h4><pre><code class="hljs go"><span class="hljs-comment">// internal/service/user.go</span><span class="hljs-keyword">package</span> service<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;context&quot;</span>    <span class="hljs-string">&quot;github.com/google/uuid&quot;</span>    <span class="hljs-string">&quot;userservice/api/proto&quot;</span>    <span class="hljs-string">&quot;userservice/internal/repository&quot;</span>)<span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span> &#123;    proto.UnimplementedUserServiceServer    repo repository.UserRepository&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserService</span><span class="hljs-params">(repo repository.UserRepository)</span> *<span class="hljs-title">UserService</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;UserService&#123;repo: repo&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span> <span class="hljs-title">GetUser</span><span class="hljs-params">(ctx context.Context, req *proto.GetUserRequest)</span> <span class="hljs-params">(*proto.GetUserResponse, error)</span></span> &#123;    user, err := s.repo.GetByID(ctx, req.Id)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;    <span class="hljs-keyword">return</span> &amp;proto.GetUserResponse&#123;        User: &amp;proto.User&#123;            Id:    user.ID,            Name:  user.Name,            Email: user.Email,            Age:   user.Age,        &#125;,    &#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span> <span class="hljs-title">CreateUser</span><span class="hljs-params">(ctx context.Context, req *proto.CreateUserRequest)</span> <span class="hljs-params">(*proto.CreateUserResponse, error)</span></span> &#123;    user := &amp;repository.User&#123;        ID:    uuid.New().String(),        Name:  req.Name,        Email: req.Email,        Age:   req.Age,    &#125;        err := s.repo.Create(ctx, user)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;        <span class="hljs-keyword">return</span> &amp;proto.CreateUserResponse&#123;        User: &amp;proto.User&#123;            Id:    user.ID,            Name:  user.Name,            Email: user.Email,            Age:   user.Age,        &#125;,    &#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span> <span class="hljs-title">ListUsers</span><span class="hljs-params">(ctx context.Context, req *proto.ListUsersRequest)</span> <span class="hljs-params">(*proto.ListUsersResponse, error)</span></span> &#123;    users, total, err := s.repo.List(ctx, req.Page, req.PageSize)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;        <span class="hljs-keyword">var</span> protoUsers []*proto.User    <span class="hljs-keyword">for</span> _, user := <span class="hljs-keyword">range</span> users &#123;        protoUsers = <span class="hljs-built_in">append</span>(protoUsers, &amp;proto.User&#123;            Id:    user.ID,            Name:  user.Name,            Email: user.Email,            Age:   user.Age,        &#125;)    &#125;        <span class="hljs-keyword">return</span> &amp;proto.ListUsersResponse&#123;        Users: protoUsers,        Total: total,    &#125;, <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="4-HTTPå¤„ç†å™¨"><a class="header-anchor" href="#4-HTTPå¤„ç†å™¨"></a>4. HTTPå¤„ç†å™¨</h4><pre><code class="hljs go"><span class="hljs-comment">// internal/handler/user.go</span><span class="hljs-keyword">package</span> handler<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span>    <span class="hljs-string">&quot;net/http&quot;</span>    <span class="hljs-string">&quot;strconv&quot;</span>    <span class="hljs-string">&quot;userservice/internal/service&quot;</span>)<span class="hljs-keyword">type</span> UserHandler <span class="hljs-keyword">struct</span> &#123;    userService *service.UserService&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserHandler</span><span class="hljs-params">(userService *service.UserService)</span> *<span class="hljs-title">UserHandler</span></span> &#123;    <span class="hljs-keyword">return</span> &amp;UserHandler&#123;userService: userService&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *UserHandler)</span> <span class="hljs-title">GetUser</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;    id := c.Param(<span class="hljs-string">&quot;id&quot;</span>)    req := &amp;proto.GetUserRequest&#123;Id: id&#125;        resp, err := h.userService.GetUser(c, req)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="hljs-string">&quot;error&quot;</span>: err.Error()&#125;)        <span class="hljs-keyword">return</span>    &#125;        c.JSON(http.StatusOK, resp.User)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *UserHandler)</span> <span class="hljs-title">CreateUser</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;    <span class="hljs-keyword">var</span> req <span class="hljs-keyword">struct</span> &#123;        Name  <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;name&quot; binding:&quot;required&quot;`</span>        Email <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;email&quot; binding:&quot;required,email&quot;`</span>        Age   <span class="hljs-keyword">int32</span>  <span class="hljs-string">`json:&quot;age&quot; binding:&quot;required,min=0&quot;`</span>    &#125;        <span class="hljs-keyword">if</span> err := c.ShouldBindJSON(&amp;req); err != <span class="hljs-literal">nil</span> &#123;        c.JSON(http.StatusBadRequest, gin.H&#123;<span class="hljs-string">&quot;error&quot;</span>: err.Error()&#125;)        <span class="hljs-keyword">return</span>    &#125;        protoReq := &amp;proto.CreateUserRequest&#123;        Name:  req.Name,        Email: req.Email,        Age:   req.Age,    &#125;        resp, err := h.userService.CreateUser(c, protoReq)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="hljs-string">&quot;error&quot;</span>: err.Error()&#125;)        <span class="hljs-keyword">return</span>    &#125;        c.JSON(http.StatusCreated, resp.User)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *UserHandler)</span> <span class="hljs-title">ListUsers</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;    pageStr := c.DefaultQuery(<span class="hljs-string">&quot;page&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)    pageSizeStr := c.DefaultQuery(<span class="hljs-string">&quot;page_size&quot;</span>, <span class="hljs-string">&quot;10&quot;</span>)        page, _ := strconv.Atoi(pageStr)    pageSize, _ := strconv.Atoi(pageSizeStr)        req := &amp;proto.ListUsersRequest&#123;        Page:     <span class="hljs-keyword">int32</span>(page),        PageSize: <span class="hljs-keyword">int32</span>(pageSize),    &#125;        resp, err := h.userService.ListUsers(c, req)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="hljs-string">&quot;error&quot;</span>: err.Error()&#125;)        <span class="hljs-keyword">return</span>    &#125;        c.JSON(http.StatusOK, gin.H&#123;        <span class="hljs-string">&quot;users&quot;</span>: resp.Users,        <span class="hljs-string">&quot;total&quot;</span>: resp.Total,    &#125;)&#125;</code></pre><h4 id="5-ä¸»å‡½æ•°"><a class="header-anchor" href="#5-ä¸»å‡½æ•°"></a>5. ä¸»å‡½æ•°</h4><pre><code class="hljs go"><span class="hljs-comment">// cmd/main.go</span><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;context&quot;</span>    <span class="hljs-string">&quot;log&quot;</span>    <span class="hljs-string">&quot;net&quot;</span>    <span class="hljs-string">&quot;net/http&quot;</span>    <span class="hljs-string">&quot;os&quot;</span>    <span class="hljs-string">&quot;os/signal&quot;</span>    <span class="hljs-string">&quot;syscall&quot;</span>    <span class="hljs-string">&quot;time&quot;</span>        <span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span>    <span class="hljs-string">&quot;google.golang.org/grpc&quot;</span>    <span class="hljs-string">&quot;userservice/api/proto&quot;</span>    <span class="hljs-string">&quot;userservice/internal/handler&quot;</span>    <span class="hljs-string">&quot;userservice/internal/repository&quot;</span>    <span class="hljs-string">&quot;userservice/internal/service&quot;</span>    <span class="hljs-string">&quot;userservice/pkg/config&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åŠ è½½é…ç½®</span>    cfg, err := config.Load()    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;æ— æ³•åŠ è½½é…ç½®: %v&quot;</span>, err)    &#125;        <span class="hljs-comment">// åˆå§‹åŒ–ä»“åº“</span>    repo := repository.NewUserRepository()        <span class="hljs-comment">// åˆ›å»ºæœåŠ¡</span>    userService := service.NewUserService(repo)        <span class="hljs-comment">// å¯åŠ¨gRPCæœåŠ¡</span>    <span class="hljs-keyword">go</span> startGRPCServer(cfg.GRPCPort, userService)        <span class="hljs-comment">// å¯åŠ¨HTTPæœåŠ¡</span>    startHTTPServer(cfg.HTTPPort, userService)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startGRPCServer</span><span class="hljs-params">(port <span class="hljs-keyword">string</span>, userService *service.UserService)</span></span> &#123;    lis, err := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;:&quot;</span>+port)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;æ— æ³•ç›‘å¬ç«¯å£ %s: %v&quot;</span>, port, err)    &#125;        grpcServer := grpc.NewServer()    proto.RegisterUserServiceServer(grpcServer, userService)        log.Printf(<span class="hljs-string">&quot;gRPCæœåŠ¡å¯åŠ¨åœ¨ç«¯å£ %s&quot;</span>, port)    <span class="hljs-keyword">if</span> err := grpcServer.Serve(lis); err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;æ— æ³•å¯åŠ¨gRPCæœåŠ¡: %v&quot;</span>, err)    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startHTTPServer</span><span class="hljs-params">(port <span class="hljs-keyword">string</span>, userService *service.UserService)</span></span> &#123;    router := gin.Default()        <span class="hljs-comment">// æ·»åŠ ä¸­é—´ä»¶</span>    router.Use(gin.Recovery())    router.Use(gin.Logger())        <span class="hljs-comment">// åˆå§‹åŒ–å¤„ç†å™¨</span>    userHandler := handler.NewUserHandler(userService)        <span class="hljs-comment">// æ³¨å†Œè·¯ç”±</span>    v1 := router.Group(<span class="hljs-string">&quot;/api/v1&quot;</span>)    &#123;        users := v1.Group(<span class="hljs-string">&quot;/users&quot;</span>)        &#123;            users.GET(<span class="hljs-string">&quot;/:id&quot;</span>, userHandler.GetUser)            users.POST(<span class="hljs-string">&quot;/&quot;</span>, userHandler.CreateUser)            users.GET(<span class="hljs-string">&quot;/&quot;</span>, userHandler.ListUsers)        &#125;    &#125;        <span class="hljs-comment">// åˆ›å»ºHTTPæœåŠ¡å™¨</span>    srv := &amp;http.Server&#123;        Addr:    <span class="hljs-string">&quot;:&quot;</span> + port,        Handler: router,    &#125;        <span class="hljs-comment">// ä¼˜é›…å…³é—­</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        log.Printf(<span class="hljs-string">&quot;HTTPæœåŠ¡å¯åŠ¨åœ¨ç«¯å£ %s&quot;</span>, port)        <span class="hljs-keyword">if</span> err := srv.ListenAndServe(); err != <span class="hljs-literal">nil</span> &amp;&amp; err != http.ErrServerClosed &#123;            log.Fatalf(<span class="hljs-string">&quot;HTTPæœåŠ¡å¯åŠ¨å¤±è´¥: %v&quot;</span>, err)        &#125;    &#125;()        <span class="hljs-comment">// ç­‰å¾…ä¸­æ–­ä¿¡å·</span>    quit := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">1</span>)    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)    &lt;-quit    log.Println(<span class="hljs-string">&quot;æ­£åœ¨å…³é—­æœåŠ¡å™¨...&quot;</span>)        ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">5</span>*time.Second)    <span class="hljs-keyword">defer</span> cancel()        <span class="hljs-keyword">if</span> err := srv.Shutdown(ctx); err != <span class="hljs-literal">nil</span> &#123;        log.Fatalf(<span class="hljs-string">&quot;æœåŠ¡å™¨å…³é—­: %v&quot;</span>, err)    &#125;        log.Println(<span class="hljs-string">&quot;æœåŠ¡å™¨å·²ä¼˜é›…å…³é—­&quot;</span>)&#125;</code></pre><h3 id="ğŸ§©-å¾®æœåŠ¡æ¶æ„ä¸­çš„å¸¸è§ç»„ä»¶"><a class="header-anchor" href="#ğŸ§©-å¾®æœåŠ¡æ¶æ„ä¸­çš„å¸¸è§ç»„ä»¶"></a>ğŸ§© å¾®æœåŠ¡æ¶æ„ä¸­çš„å¸¸è§ç»„ä»¶</h3><p>åœ¨å®é™…å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œé™¤äº†æ ¸å¿ƒæœåŠ¡æ¡†æ¶å¤–ï¼Œè¿˜éœ€è¦è€ƒè™‘ä»¥ä¸‹ç»„ä»¶ï¼š</p><ol><li><strong>APIç½‘å…³</strong>ï¼šKong, Traefik, APISIX</li><li><strong>æœåŠ¡å‘ç°</strong>ï¼šConsul, etcd, Nacos</li><li><strong>é…ç½®ä¸­å¿ƒ</strong>ï¼šApollo, Nacos, etcd</li><li><strong>åˆ†å¸ƒå¼è·Ÿè¸ª</strong>ï¼šJaeger, Zipkin, SkyWalking</li><li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šKafka, RabbitMQ, NATS</li><li><strong>ç†”æ–­é™æµ</strong>ï¼šSentinel, Hystrix, Resilience4j</li><li><strong>ç›‘æ§å‘Šè­¦</strong>ï¼šPrometheus, Grafana, AlertManager</li></ol><h3 id="ğŸ-æ€»ç»“"><a class="header-anchor" href="#ğŸ-æ€»ç»“"></a>ğŸ æ€»ç»“</h3><p>é€‰æ‹©é€‚åˆçš„Goå¾®æœåŠ¡æ¡†æ¶éœ€è¦è€ƒè™‘å›¢é˜ŸæŠ€æœ¯æ ˆã€é¡¹ç›®éœ€æ±‚ã€æ€§èƒ½è¦æ±‚ç­‰å¤šæ–¹é¢å› ç´ ã€‚å¯¹äºå¤§å¤šæ•°é¡¹ç›®è€Œè¨€ï¼Œæ²¡æœ‰å®Œç¾çš„æ¡†æ¶ï¼Œåªæœ‰æœ€é€‚åˆçš„é€‰æ‹©ã€‚</p><ul><li>å¯¹äºè¿½æ±‚æè‡´æ€§èƒ½çš„åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘Kitexæˆ–çº¯gRPCæ–¹æ¡ˆ</li><li>å¯¹äºéœ€è¦å®Œæ•´å¾®æœåŠ¡æ²»ç†åŠŸèƒ½çš„å¤æ‚ç³»ç»Ÿï¼Œå¯ä»¥é€‰æ‹©Go-kitæˆ–Kratos</li><li>å¯¹äºå¿«é€Ÿå¼€å‘å’Œç®€å•é¡¹ç›®ï¼Œå¯ä»¥é‡‡ç”¨Gin+gRPCæˆ–go-micro</li></ul><p>æ— è®ºé€‰æ‹©å“ªç§æ¡†æ¶ï¼Œå¾®æœåŠ¡æ¶æ„çš„æˆåŠŸå®æ–½è¿˜éœ€è¦æ³¨é‡æœåŠ¡è¾¹ç•Œçš„åˆç†åˆ’åˆ†ã€å›¢é˜Ÿåä½œæµç¨‹çš„ä¼˜åŒ–ã€ä»¥åŠDevOpsæ–‡åŒ–çš„å»ºè®¾ã€‚åœ¨å®è·µä¸­æŒç»­æ¼”è¿›å’Œä¼˜åŒ–ï¼Œæ‰èƒ½çœŸæ­£å‘æŒ¥å¾®æœåŠ¡æ¶æ„çš„ä¼˜åŠ¿ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
      <category>å¾®æœåŠ¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
      <tag>æ¡†æ¶</tag>
      
      <tag>gRPC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kubernetes podèµ„æºç®¡ç†ä¸è°ƒåº¦ç­–ç•¥</title>
    <link href="/2024/02/08/kubernetes-pod%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E4%B8%8E%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5/"/>
    <url>/2024/02/08/kubernetes-pod%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E4%B8%8E%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ¯-kubernetes-podèµ„æºç®¡ç†ä¸è°ƒåº¦ç­–ç•¥è¯¦è§£"><a class="header-anchor" href="#ğŸ¯-kubernetes-podèµ„æºç®¡ç†ä¸è°ƒåº¦ç­–ç•¥è¯¦è§£"></a>ğŸ¯ kubernetes podèµ„æºç®¡ç†ä¸è°ƒåº¦ç­–ç•¥è¯¦è§£</h2><p>Kubernetesä½œä¸ºç›®å‰æœ€æµè¡Œçš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€å°±æ˜¯é«˜æ•ˆåœ°ç®¡ç†å’Œè°ƒåº¦Podèµ„æºã€‚åˆç†çš„èµ„æºç®¡ç†å’Œè°ƒåº¦ç­–ç•¥èƒ½å¤Ÿæé«˜é›†ç¾¤èµ„æºåˆ©ç”¨ç‡ï¼Œç¡®ä¿åº”ç”¨ç¨‹åºç¨³å®šè¿è¡Œã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Kubernetesä¸­Podçš„èµ„æºç®¡ç†ä¸è°ƒåº¦ç­–ç•¥ã€‚</p><h3 id="ğŸ“Š-Podèµ„æºç®¡ç†åŸºç¡€"><a class="header-anchor" href="#ğŸ“Š-Podèµ„æºç®¡ç†åŸºç¡€"></a>ğŸ“Š Podèµ„æºç®¡ç†åŸºç¡€</h3><h4 id="èµ„æºè¯·æ±‚ä¸é™åˆ¶"><a class="header-anchor" href="#èµ„æºè¯·æ±‚ä¸é™åˆ¶"></a>èµ„æºè¯·æ±‚ä¸é™åˆ¶</h4><p>Kubernetesçš„èµ„æºç®¡ç†ä¸»è¦é€šè¿‡ä¸¤ä¸ªæ¦‚å¿µå®ç°ï¼šèµ„æºè¯·æ±‚(requests)å’Œèµ„æºé™åˆ¶(limits)ã€‚</p><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">resource-demo</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">containers:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span>    <span class="hljs-attr">resources:</span>      <span class="hljs-attr">requests:</span>        <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;64Mi&quot;</span>        <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;250m&quot;</span>      <span class="hljs-attr">limits:</span>        <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;128Mi&quot;</span>        <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;500m&quot;</span></code></pre><ul><li><strong>requests</strong>ï¼šå®¹å™¨éœ€è¦çš„æœ€å°èµ„æºé‡ï¼ŒScheduleræ ¹æ®è¿™ä¸ªå€¼æ¥å†³å®šå°†Podè°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹</li><li><strong>limits</strong>ï¼šå®¹å™¨å¯ä»¥ä½¿ç”¨çš„æœ€å¤§èµ„æºé‡ï¼Œè¶…è¿‡è¿™ä¸ªé™åˆ¶å¯èƒ½ä¼šè¢«ç»ˆæ­¢æˆ–é™æµ</li></ul><p>å½“Podçš„èµ„æºç”¨é‡è¶…è¿‡limitsæ—¶ï¼š</p><ul><li>å¯¹äºCPUï¼šå®¹å™¨ä¼šè¢«é™æµï¼Œä½†ä¸ä¼šè¢«ç»ˆæ­¢</li><li>å¯¹äºå†…å­˜ï¼šå¦‚æœå®¹å™¨æŒç»­ä½¿ç”¨è¶…è¿‡é™åˆ¶çš„å†…å­˜ï¼Œå¯èƒ½ä¼šè¢«OOM Killerç»ˆæ­¢</li></ul><h4 id="QoSç±»åˆ«"><a class="header-anchor" href="#QoSç±»åˆ«"></a>QoSç±»åˆ«</h4><p>åŸºäºrequestså’Œlimitsçš„è®¾ç½®ï¼ŒKuberneteså°†Podåˆ†ä¸ºä¸‰ä¸ªQoS(Quality of Service)ç±»åˆ«ï¼š</p><ol><li><strong>Guaranteed</strong>ï¼šæ¯ä¸ªå®¹å™¨åŒæ—¶è®¾ç½®äº†requestså’Œlimitsï¼Œä¸”requestsç­‰äºlimits<pre><code class="hljs yaml"><span class="hljs-attr">resources:</span></li></ol><p><span class="hljs-attr">requests:</span><br><span class="hljs-attr">memory:</span> <span class="hljs-string">â€œ128Miâ€</span><br><span class="hljs-attr">cpu:</span> <span class="hljs-string">â€œ500mâ€</span><br><span class="hljs-attr">limits:</span><br><span class="hljs-attr">memory:</span> <span class="hljs-string">â€œ128Miâ€</span><br><span class="hljs-attr">cpu:</span> <span class="hljs-string">â€œ500mâ€</span></code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="2"><li><strong>Burstable</strong>ï¼šè‡³å°‘ä¸€ä¸ªå®¹å™¨è®¾ç½®äº†requestsï¼Œä½†ä¸æ»¡è¶³Guaranteedçš„æ¡ä»¶<pre><code class="hljs yaml"><span class="hljs-attr">resources:</span></li></ol><p><span class="hljs-attr">requests:</span><br><span class="hljs-attr">memory:</span> <span class="hljs-string">â€œ64Miâ€</span><br><span class="hljs-attr">cpu:</span> <span class="hljs-string">â€œ250mâ€</span><br><span class="hljs-attr">limits:</span><br><span class="hljs-attr">memory:</span> <span class="hljs-string">â€œ128Miâ€</span><br><span class="hljs-attr">cpu:</span> <span class="hljs-string">â€œ500mâ€</span></code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="3"><li><strong>BestEffort</strong>ï¼šæ²¡æœ‰ä»»ä½•å®¹å™¨è®¾ç½®requestsæˆ–limits</li></ol><p>QoSç±»åˆ«å†³å®šäº†Podåœ¨èµ„æºç´§å¼ æ—¶è¢«é©±é€çš„ä¼˜å…ˆçº§ï¼šBestEffort &gt; Burstable &gt; Guaranteedã€‚</p><h3 id="ğŸ§©-Podè°ƒåº¦ç­–ç•¥"><a class="header-anchor" href="#ğŸ§©-Podè°ƒåº¦ç­–ç•¥"></a>ğŸ§© Podè°ƒåº¦ç­–ç•¥</h3><h4 id="è°ƒåº¦è¿‡ç¨‹"><a class="header-anchor" href="#è°ƒåº¦è¿‡ç¨‹"></a>è°ƒåº¦è¿‡ç¨‹</h4><p>Kubernetesçš„è°ƒåº¦è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªé˜¶æ®µï¼š</p><ol><li><strong>è¿‡æ»¤(Filtering)</strong>ï¼šç­›é€‰å‡ºæ»¡è¶³Podèµ„æºéœ€æ±‚çš„èŠ‚ç‚¹</li><li><strong>è¯„åˆ†(Scoring)</strong>ï¼šä¸ºè¿‡æ»¤åçš„èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†ï¼Œé€‰æ‹©æœ€ä½³èŠ‚ç‚¹</li></ol><h4 id="è°ƒåº¦å™¨å¦‚ä½•å·¥ä½œ"><a class="header-anchor" href="#è°ƒåº¦å™¨å¦‚ä½•å·¥ä½œ"></a>è°ƒåº¦å™¨å¦‚ä½•å·¥ä½œ</h4><ol><li>è·å–å¾…è°ƒåº¦çš„Pod</li><li>è·å–æ‰€æœ‰å¯ç”¨èŠ‚ç‚¹</li><li>è¿‡æ»¤ä¸æ»¡è¶³Podè¦æ±‚çš„èŠ‚ç‚¹</li><li>å¯¹å‰©ä½™èŠ‚ç‚¹è¯„åˆ†</li><li>é€‰æ‹©å¾—åˆ†æœ€é«˜çš„èŠ‚ç‚¹</li><li>å°†Podç»‘å®šåˆ°é€‰ä¸­çš„èŠ‚ç‚¹</li></ol><h4 id="èŠ‚ç‚¹é€‰æ‹©å™¨"><a class="header-anchor" href="#èŠ‚ç‚¹é€‰æ‹©å™¨"></a>èŠ‚ç‚¹é€‰æ‹©å™¨</h4><p>é€šè¿‡nodeSelectorå¯ä»¥æŒ‡å®šPodåªèƒ½è¿è¡Œåœ¨ç‰¹å®šæ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šï¼š</p><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">nodeSelector:</span>    <span class="hljs-attr">disktype:</span> <span class="hljs-string">ssd</span>  <span class="hljs-attr">containers:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span></code></pre><h4 id="èŠ‚ç‚¹äº²å’Œæ€§"><a class="header-anchor" href="#èŠ‚ç‚¹äº²å’Œæ€§"></a>èŠ‚ç‚¹äº²å’Œæ€§</h4><p>ç›¸æ¯”nodeSelectorï¼ŒnodeAffinityæä¾›äº†æ›´çµæ´»çš„èŠ‚ç‚¹é€‰æ‹©æœºåˆ¶ï¼š</p><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-affinity</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">affinity:</span>    <span class="hljs-attr">nodeAffinity:</span>      <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span>        <span class="hljs-attr">nodeSelectorTerms:</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">matchExpressions:</span>          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">kubernetes.io/e2e-az-name</span>            <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>            <span class="hljs-attr">values:</span>            <span class="hljs-bullet">-</span> <span class="hljs-string">e2e-az1</span>            <span class="hljs-bullet">-</span> <span class="hljs-string">e2e-az2</span>      <span class="hljs-attr">preferredDuringSchedulingIgnoredDuringExecution:</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">weight:</span> <span class="hljs-number">1</span>        <span class="hljs-attr">preference:</span>          <span class="hljs-attr">matchExpressions:</span>          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">another-node-label-key</span>            <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>            <span class="hljs-attr">values:</span>            <span class="hljs-bullet">-</span> <span class="hljs-string">another-node-label-value</span>  <span class="hljs-attr">containers:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span></code></pre><p>nodeAffinityæœ‰ä¸¤ç§ç±»å‹ï¼š</p><ul><li><strong>requiredDuringSchedulingIgnoredDuringExecution</strong>ï¼šç¡¬æ€§è§„åˆ™ï¼Œå¿…é¡»æ»¡è¶³æ‰èƒ½è°ƒåº¦</li><li><strong>preferredDuringSchedulingIgnoredDuringExecution</strong>ï¼šè½¯æ€§è§„åˆ™ï¼Œä¼˜å…ˆè€ƒè™‘ä½†ä¸å¼ºåˆ¶è¦æ±‚</li></ul><h4 id="Podäº²å’Œæ€§ä¸åäº²å’Œæ€§"><a class="header-anchor" href="#Podäº²å’Œæ€§ä¸åäº²å’Œæ€§"></a>Podäº²å’Œæ€§ä¸åäº²å’Œæ€§</h4><p>Podäº²å’Œæ€§(podAffinity)å’Œåäº²å’Œæ€§(podAntiAffinity)å…è®¸æ ¹æ®å·²ç»åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„Podæ ‡ç­¾æ¥çº¦æŸPodçš„è°ƒåº¦ï¼š</p><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">redis-pod</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">affinity:</span>    <span class="hljs-attr">podAffinity:</span>      <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">labelSelector:</span>          <span class="hljs-attr">matchExpressions:</span>          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">app</span>            <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>            <span class="hljs-attr">values:</span>            <span class="hljs-bullet">-</span> <span class="hljs-string">web</span>        <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">&quot;kubernetes.io/hostname&quot;</span>    <span class="hljs-attr">podAntiAffinity:</span>      <span class="hljs-attr">preferredDuringSchedulingIgnoredDuringExecution:</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">weight:</span> <span class="hljs-number">100</span>        <span class="hljs-attr">podAffinityTerm:</span>          <span class="hljs-attr">labelSelector:</span>            <span class="hljs-attr">matchExpressions:</span>            <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">app</span>              <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>              <span class="hljs-attr">values:</span>              <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span>          <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">kubernetes.io/hostname</span>  <span class="hljs-attr">containers:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">redis</span>    <span class="hljs-attr">image:</span> <span class="hljs-string">redis</span></code></pre><ul><li><strong>podAffinity</strong>ï¼šä¸ç‰¹å®šæ ‡ç­¾çš„Podè°ƒåº¦åœ¨åŒä¸€ä½ç½®</li><li><strong>podAntiAffinity</strong>ï¼šé¿å…ä¸ç‰¹å®šæ ‡ç­¾çš„Podè°ƒåº¦åœ¨åŒä¸€ä½ç½®</li></ul><h4 id="æ±¡ç‚¹-Taints-å’Œå®¹å¿-Tolerations"><a class="header-anchor" href="#æ±¡ç‚¹-Taints-å’Œå®¹å¿-Tolerations"></a>æ±¡ç‚¹(Taints)å’Œå®¹å¿(Tolerations)</h4><p>æ±¡ç‚¹å…è®¸èŠ‚ç‚¹æ’æ–¥ä¸€ç»„Podï¼Œè€Œå®¹å¿å…è®¸Podè°ƒåº¦åˆ°å¸¦æœ‰åŒ¹é…æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šã€‚</p><p>ä¸ºèŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹ï¼š</p><pre><code class="hljs bash">kubectl taint nodes node1 key=value:NoSchedule</code></pre><p>åœ¨Podå®šä¹‰ä¸­æ·»åŠ å®¹å¿ï¼š</p><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-toleration</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">tolerations:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;key&quot;</span>    <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Equal&quot;</span>    <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;value&quot;</span>    <span class="hljs-attr">effect:</span> <span class="hljs-string">&quot;NoSchedule&quot;</span>  <span class="hljs-attr">containers:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span></code></pre><p>æ±¡ç‚¹æ•ˆæœåŒ…æ‹¬ï¼š</p><ul><li><strong>NoSchedule</strong>ï¼šä¸å…è®¸è°ƒåº¦æ–°Podï¼ˆé™¤éæœ‰å®¹å¿ï¼‰</li><li><strong>PreferNoSchedule</strong>ï¼šå°½é‡é¿å…è°ƒåº¦æ–°Pod</li><li><strong>NoExecute</strong>ï¼šé©±é€æ²¡æœ‰åŒ¹é…å®¹å¿çš„ç°æœ‰Pod</li></ul><h3 id="ğŸ”-èµ„æºåˆ†é…é«˜çº§ç‰¹æ€§"><a class="header-anchor" href="#ğŸ”-èµ„æºåˆ†é…é«˜çº§ç‰¹æ€§"></a>ğŸ” èµ„æºåˆ†é…é«˜çº§ç‰¹æ€§</h3><h4 id="Resource-Quota"><a class="header-anchor" href="#Resource-Quota"></a>Resource Quota</h4><p>ResourceQuotaç”¨äºé™åˆ¶å‘½åç©ºé—´å†…çš„èµ„æºæ€»é‡ï¼š</p><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">ResourceQuota</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">compute-resources</span>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">hard:</span>    <span class="hljs-attr">pods:</span> <span class="hljs-string">&quot;10&quot;</span>    <span class="hljs-attr">requests.cpu:</span> <span class="hljs-string">&quot;4&quot;</span>    <span class="hljs-attr">requests.memory:</span> <span class="hljs-string">4Gi</span>    <span class="hljs-attr">limits.cpu:</span> <span class="hljs-string">&quot;8&quot;</span>    <span class="hljs-attr">limits.memory:</span> <span class="hljs-string">8Gi</span></code></pre><h4 id="Limit-Range"><a class="header-anchor" href="#Limit-Range"></a>Limit Range</h4><p>LimitRangeä¸ºå‘½åç©ºé—´ä¸­çš„Podå’Œå®¹å™¨è®¾ç½®é»˜è®¤èµ„æºé™åˆ¶ï¼š</p><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">LimitRange</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">limit-range</span>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">limits:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">default:</span>      <span class="hljs-attr">cpu:</span> <span class="hljs-string">500m</span>      <span class="hljs-attr">memory:</span> <span class="hljs-string">512Mi</span>    <span class="hljs-attr">defaultRequest:</span>      <span class="hljs-attr">cpu:</span> <span class="hljs-string">200m</span>      <span class="hljs-attr">memory:</span> <span class="hljs-string">256Mi</span>    <span class="hljs-attr">type:</span> <span class="hljs-string">Container</span></code></pre><h4 id="å‚ç›´Podè‡ªåŠ¨ä¼¸ç¼©-VPA"><a class="header-anchor" href="#å‚ç›´Podè‡ªåŠ¨ä¼¸ç¼©-VPA"></a>å‚ç›´Podè‡ªåŠ¨ä¼¸ç¼©(VPA)</h4><p>VPAå¯ä»¥è‡ªåŠ¨è°ƒæ•´Podçš„CPUå’Œå†…å­˜è¯·æ±‚ï¼š</p><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">autoscaling.k8s.io/v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">VerticalPodAutoscaler</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-app-vpa</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">targetRef:</span>    <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">&quot;apps/v1&quot;</span>    <span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>    <span class="hljs-attr">name:</span> <span class="hljs-string">my-app</span>  <span class="hljs-attr">updatePolicy:</span>    <span class="hljs-attr">updateMode:</span> <span class="hljs-string">&quot;Auto&quot;</span>  <span class="hljs-attr">resourcePolicy:</span>    <span class="hljs-attr">containerPolicies:</span>    <span class="hljs-bullet">-</span> <span class="hljs-attr">containerName:</span> <span class="hljs-string">&#x27;*&#x27;</span>      <span class="hljs-attr">minAllowed:</span>        <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span>        <span class="hljs-attr">memory:</span> <span class="hljs-string">50Mi</span>      <span class="hljs-attr">maxAllowed:</span>        <span class="hljs-attr">cpu:</span> <span class="hljs-number">1</span>        <span class="hljs-attr">memory:</span> <span class="hljs-string">500Mi</span></code></pre><h3 id="ğŸš€-å®é™…åº”ç”¨ä¸­çš„æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸš€-å®é™…åº”ç”¨ä¸­çš„æœ€ä½³å®è·µ"></a>ğŸš€ å®é™…åº”ç”¨ä¸­çš„æœ€ä½³å®è·µ</h3><h4 id="1-åˆç†è®¾ç½®èµ„æºè¯·æ±‚å’Œé™åˆ¶"><a class="header-anchor" href="#1-åˆç†è®¾ç½®èµ„æºè¯·æ±‚å’Œé™åˆ¶"></a>1. åˆç†è®¾ç½®èµ„æºè¯·æ±‚å’Œé™åˆ¶</h4><ul><li>åŸºäºåº”ç”¨å®é™…éœ€æ±‚è®¾ç½®requestså’Œlimits</li><li>ç›‘æ§åº”ç”¨å®é™…èµ„æºä½¿ç”¨æƒ…å†µï¼Œé€æ­¥è°ƒæ•´</li><li>å¯¹å…³é”®åº”ç”¨è®¾ç½®ä¸ºGuaranteed QoSç±»åˆ«</li></ul><pre><code class="hljs yaml"><span class="hljs-attr">resources:</span>  <span class="hljs-attr">requests:</span>    <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;1Gi&quot;</span>    <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;500m&quot;</span>  <span class="hljs-attr">limits:</span>    <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;1Gi&quot;</span>    <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;500m&quot;</span></code></pre><h4 id="2-ä½¿ç”¨èŠ‚ç‚¹äº²å’Œæ€§å®ç°é«˜å¯ç”¨"><a class="header-anchor" href="#2-ä½¿ç”¨èŠ‚ç‚¹äº²å’Œæ€§å®ç°é«˜å¯ç”¨"></a>2. ä½¿ç”¨èŠ‚ç‚¹äº²å’Œæ€§å®ç°é«˜å¯ç”¨</h4><p>ç¡®ä¿Podåˆ†å¸ƒåœ¨ä¸åŒå¯ç”¨åŒºï¼Œæé«˜ç³»ç»Ÿå¯ç”¨æ€§ï¼š</p><pre><code class="hljs yaml"><span class="hljs-attr">affinity:</span>  <span class="hljs-attr">podAntiAffinity:</span>    <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span>    <span class="hljs-bullet">-</span> <span class="hljs-attr">labelSelector:</span>        <span class="hljs-attr">matchExpressions:</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">app</span>          <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>          <span class="hljs-attr">values:</span>          <span class="hljs-bullet">-</span> <span class="hljs-string">web</span>      <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">&quot;topology.kubernetes.io/zone&quot;</span></code></pre><h4 id="3-åˆ©ç”¨æ±¡ç‚¹å’Œå®¹å¿åˆ†ç¦»å·¥ä½œè´Ÿè½½"><a class="header-anchor" href="#3-åˆ©ç”¨æ±¡ç‚¹å’Œå®¹å¿åˆ†ç¦»å·¥ä½œè´Ÿè½½"></a>3. åˆ©ç”¨æ±¡ç‚¹å’Œå®¹å¿åˆ†ç¦»å·¥ä½œè´Ÿè½½</h4><p>ä½¿ç”¨æ±¡ç‚¹å°†ç‰¹å®šå·¥ä½œè´Ÿè½½(å¦‚æ—¥å¿—æ”¶é›†ã€ç›‘æ§)é™åˆ¶åœ¨ä¸“ç”¨èŠ‚ç‚¹ï¼š</p><pre><code class="hljs bash"><span class="hljs-comment"># ä¸ºç‰¹å®šèŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹</span>kubectl taint nodes monitoring-node dedicated=monitoring:NoSchedule<span class="hljs-comment"># åœ¨ç›‘æ§Podä¸­æ·»åŠ åŒ¹é…çš„å®¹å¿</span>tolerations:- key: <span class="hljs-string">&quot;dedicated&quot;</span>  operator: <span class="hljs-string">&quot;Equal&quot;</span>  value: <span class="hljs-string">&quot;monitoring&quot;</span>  effect: <span class="hljs-string">&quot;NoSchedule&quot;</span></code></pre><h4 id="4-è®¾ç½®Podä¸­æ–­é¢„ç®—-PDB"><a class="header-anchor" href="#4-è®¾ç½®Podä¸­æ–­é¢„ç®—-PDB"></a>4. è®¾ç½®Podä¸­æ–­é¢„ç®—(PDB)</h4><p>ç¡®ä¿åœ¨èŠ‚ç‚¹ç»´æŠ¤æ—¶åº”ç”¨ä¿æŒæœ€å°å¯ç”¨å®ä¾‹ï¼š</p><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">policy/v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">PodDisruptionBudget</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">web-pdb</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">minAvailable:</span> <span class="hljs-number">2</span>  <span class="hljs-attr">selector:</span>    <span class="hljs-attr">matchLabels:</span>      <span class="hljs-attr">app:</span> <span class="hljs-string">web</span></code></pre><h4 id="5-é€‚å½“ä½¿ç”¨ä¼˜å…ˆçº§å’ŒæŠ¢å "><a class="header-anchor" href="#5-é€‚å½“ä½¿ç”¨ä¼˜å…ˆçº§å’ŒæŠ¢å "></a>5. é€‚å½“ä½¿ç”¨ä¼˜å…ˆçº§å’ŒæŠ¢å </h4><p>ä¸ºå…³é”®åº”ç”¨è®¾ç½®æ›´é«˜ä¼˜å…ˆçº§ï¼š</p><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">scheduling.k8s.io/v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">PriorityClass</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">high-priority</span><span class="hljs-attr">value:</span> <span class="hljs-number">1000000</span><span class="hljs-attr">globalDefault:</span> <span class="hljs-literal">false</span><span class="hljs-attr">description:</span> <span class="hljs-string">&quot;é«˜ä¼˜å…ˆçº§Pod&quot;</span><span class="hljs-meta">---</span><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><span class="hljs-attr">metadata:</span>  <span class="hljs-attr">name:</span> <span class="hljs-string">critical-app</span><span class="hljs-attr">spec:</span>  <span class="hljs-attr">priorityClassName:</span> <span class="hljs-string">high-priority</span>  <span class="hljs-attr">containers:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>    <span class="hljs-attr">image:</span> <span class="hljs-string">critical-app</span></code></pre><h3 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h3><p>Kubernetesçš„èµ„æºç®¡ç†ä¸è°ƒåº¦ç­–ç•¥æ˜¯ä¸€ä¸ªå¤æ‚è€Œå¼ºå¤§çš„ç³»ç»Ÿï¼Œé€šè¿‡åˆç†é…ç½®ï¼š</p><ol><li><strong>èµ„æºè¯·æ±‚å’Œé™åˆ¶</strong>å¯ä»¥ç¡®ä¿Podè·å¾—æ‰€éœ€èµ„æº</li><li><strong>QoSç±»åˆ«</strong>æä¾›äº†èµ„æºå‹åŠ›ä¸‹çš„ä¼˜å…ˆçº§ä¿éšœ</li><li><strong>äº²å’Œæ€§è§„åˆ™</strong>èƒ½å¤Ÿä¼˜åŒ–Podçš„å¸ƒå±€å’Œé«˜å¯ç”¨</li><li><strong>æ±¡ç‚¹å’Œå®¹å¿</strong>å¯ä»¥å®ç°ä¸“ç”¨èŠ‚ç‚¹å’Œæ··åˆå·¥ä½œè´Ÿè½½</li><li><strong>ResourceQuotaå’ŒLimitRange</strong>å¸®åŠ©ç®¡ç†å¤šç§Ÿæˆ·ç¯å¢ƒ</li></ol><p>æŒæ¡è¿™äº›ç­–ç•¥ï¼Œå¯ä»¥æ„å»ºæ›´åŠ ç¨³å®šã€é«˜æ•ˆçš„Kubernetesé›†ç¾¤ï¼Œä¸ºåº”ç”¨æä¾›æ›´å¥½çš„è¿è¡Œç¯å¢ƒã€‚éšç€Kubernetesçš„å‘å±•ï¼Œè°ƒåº¦å™¨ä¹Ÿåœ¨ä¸æ–­ä¼˜åŒ–ï¼Œæä¾›æ›´å¤šçµæ´»çš„è°ƒåº¦ç­–ç•¥ï¼Œæ»¡è¶³æ›´å¤æ‚çš„ä¸šåŠ¡éœ€æ±‚ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>å®¹å™¨æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kubernetes</tag>
      
      <tag>pod</tag>
      
      <tag>èµ„æºç®¡ç†</tag>
      
      <tag>è°ƒåº¦ç­–ç•¥</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang é«˜çº§å¹¶å‘æ¨¡å¼è¯¦è§£</title>
    <link href="/2024/01/30/golang-%E9%AB%98%E7%BA%A7%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3/"/>
    <url>/2024/01/30/golang-%E9%AB%98%E7%BA%A7%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ”„-golang-é«˜çº§å¹¶å‘æ¨¡å¼è¯¦è§£"><a class="header-anchor" href="#ğŸ”„-golang-é«˜çº§å¹¶å‘æ¨¡å¼è¯¦è§£"></a>ğŸ”„ golang é«˜çº§å¹¶å‘æ¨¡å¼è¯¦è§£</h2><p>Goè¯­è¨€å› å…¶å‡ºè‰²çš„å¹¶å‘æ”¯æŒè€Œå¹¿å—æ¬¢è¿ï¼Œé€šè¿‡goroutineå’Œchannelï¼ŒGoæä¾›äº†ä¸€ç§ç®€æ´è€Œå¼ºå¤§çš„å¹¶å‘ç¼–ç¨‹æ¨¡å‹ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦ä½¿ç”¨ä¸€äº›é«˜çº§å¹¶å‘æ¨¡å¼æ¥è§£å†³å¤æ‚çš„å¹¶å‘é—®é¢˜ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»Goè¯­è¨€ä¸­å¸¸ç”¨çš„é«˜çº§å¹¶å‘æ¨¡å¼ï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°æŒæ¡Goçš„å¹¶å‘ç¼–ç¨‹ã€‚</p><h3 id="ğŸ“š-åŸºç¡€å›é¡¾"><a class="header-anchor" href="#ğŸ“š-åŸºç¡€å›é¡¾"></a>ğŸ“š åŸºç¡€å›é¡¾</h3><p>åœ¨æ·±å…¥é«˜çº§å¹¶å‘æ¨¡å¼ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç®€è¦å›é¡¾Goå¹¶å‘çš„åŸºç¡€æ¦‚å¿µï¼š</p><h4 id="Goroutine"><a class="header-anchor" href="#Goroutine"></a>Goroutine</h4><p>Goroutineæ˜¯Goè¯­è¨€ä¸­çš„è½»é‡çº§çº¿ç¨‹ï¼Œç”±Goè¿è¡Œæ—¶ç®¡ç†ã€‚åˆ›å»ºä¸€ä¸ªgoroutineéå¸¸ç®€å•ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åœ¨æ–°çš„goroutineä¸­æ‰§è¡Œçš„ä»£ç </span>    fmt.Println(<span class="hljs-string">&quot;Hello from goroutine!&quot;</span>)&#125;()</code></pre><h4 id="Channel"><a class="header-anchor" href="#Channel"></a>Channel</h4><p>Channelæ˜¯goroutineä¹‹é—´é€šä¿¡çš„ç®¡é“ï¼Œç”¨äºåœ¨goroutineä¹‹é—´ä¼ é€’æ•°æ®ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ— ç¼“å†²channel</span>ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)<span class="hljs-comment">// å‘é€æ•°æ®</span><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;    ch &lt;- <span class="hljs-number">42</span>&#125;()<span class="hljs-comment">// æ¥æ”¶æ•°æ®</span>value := &lt;-chfmt.Println(value) <span class="hljs-comment">// è¾“å‡º: 42</span></code></pre><h4 id="Selectè¯­å¥"><a class="header-anchor" href="#Selectè¯­å¥"></a>Selectè¯­å¥</h4><p>Selectè¯­å¥ç”¨äºåŒæ—¶ç›‘å¬å¤šä¸ªchannelçš„æ“ä½œï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">select</span> &#123;<span class="hljs-keyword">case</span> v := &lt;-ch1:    fmt.Println(<span class="hljs-string">&quot;Received from ch1:&quot;</span>, v)<span class="hljs-keyword">case</span> ch2 &lt;- <span class="hljs-number">42</span>:    fmt.Println(<span class="hljs-string">&quot;Sent to ch2&quot;</span>)<span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">1</span> * time.Second):    fmt.Println(<span class="hljs-string">&quot;Timeout&quot;</span>)&#125;</code></pre><h3 id="ğŸš€-Worker-Poolæ¨¡å¼"><a class="header-anchor" href="#ğŸš€-Worker-Poolæ¨¡å¼"></a>ğŸš€ Worker Poolæ¨¡å¼</h3><p>Worker Poolï¼ˆå·¥ä½œæ± ï¼‰æ˜¯ä¸€ç§å¸¸è§çš„å¹¶å‘æ¨¡å¼ï¼Œç”¨äºé™åˆ¶å¹¶å‘æ‰§è¡Œçš„goroutineæ•°é‡ï¼Œé¿å…èµ„æºè€—å°½ã€‚</p><h4 id="å®ç°åŸç†"><a class="header-anchor" href="#å®ç°åŸç†"></a>å®ç°åŸç†</h4><ol><li>åˆ›å»ºå›ºå®šæ•°é‡çš„worker goroutine</li><li>è¿™äº›workerä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œ</li><li>å½“æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œå…³é—­ç»“æœchannel</li></ol><h4 id="ç¤ºä¾‹ä»£ç "><a class="header-anchor" href="#ç¤ºä¾‹ä»£ç "></a>ç¤ºä¾‹ä»£ç </h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WorkerPool</span><span class="hljs-params">(numWorkers <span class="hljs-keyword">int</span>, tasks []Task, timeout time.Duration)</span> <span class="hljs-params">([]Result, error)</span></span> &#123;    tasksCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Task, <span class="hljs-built_in">len</span>(tasks))    resultsCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result, <span class="hljs-built_in">len</span>(tasks))        <span class="hljs-comment">// å¯åŠ¨å›ºå®šæ•°é‡çš„worker</span>    <span class="hljs-keyword">var</span> wg sync.WaitGroup    wg.Add(numWorkers)    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; numWorkers; i++ &#123;        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(workerID <span class="hljs-keyword">int</span>)</span></span> &#123;            <span class="hljs-keyword">defer</span> wg.Done()            <span class="hljs-keyword">for</span> task := <span class="hljs-keyword">range</span> tasksCh &#123;                result := process(workerID, task)                resultsCh &lt;- result            &#125;        &#125;(i)    &#125;        <span class="hljs-comment">// å‘é€ä»»åŠ¡åˆ°ä»»åŠ¡channel</span>    <span class="hljs-keyword">for</span> _, task := <span class="hljs-keyword">range</span> tasks &#123;        tasksCh &lt;- task    &#125;    <span class="hljs-built_in">close</span>(tasksCh) <span class="hljs-comment">// å…³é—­ä»»åŠ¡channelï¼Œè¡¨ç¤ºæ²¡æœ‰æ›´å¤šä»»åŠ¡</span>        <span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰workerå®Œæˆå¹¶å…³é—­ç»“æœchannel</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        wg.Wait()        <span class="hljs-built_in">close</span>(resultsCh)    &#125;()        <span class="hljs-comment">// æ”¶é›†ç»“æœ</span>    <span class="hljs-keyword">var</span> results []Result    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultsCh &#123;        results = <span class="hljs-built_in">append</span>(results, result)    &#125;        <span class="hljs-keyword">return</span> results, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">process</span><span class="hljs-params">(workerID <span class="hljs-keyword">int</span>, task Task)</span> <span class="hljs-title">Result</span></span> &#123;    fmt.Printf(<span class="hljs-string">&quot;Worker %d processing task %v\n&quot;</span>, workerID, task)    <span class="hljs-comment">// å¤„ç†ä»»åŠ¡çš„é€»è¾‘</span>    time.Sleep(<span class="hljs-number">100</span> * time.Millisecond) <span class="hljs-comment">// æ¨¡æ‹Ÿå¤„ç†æ—¶é—´</span>    <span class="hljs-keyword">return</span> Result&#123;TaskID: task.ID, WorkerID: workerID&#125;&#125;</code></pre><h4 id="å¸¦è¶…æ—¶çš„Worker-Pool"><a class="header-anchor" href="#å¸¦è¶…æ—¶çš„Worker-Pool"></a>å¸¦è¶…æ—¶çš„Worker Pool</h4><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦ä¸ºWorker Poolæ·»åŠ è¶…æ—¶æœºåˆ¶ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WorkerPoolWithTimeout</span><span class="hljs-params">(numWorkers <span class="hljs-keyword">int</span>, tasks []Task, timeout time.Duration)</span> <span class="hljs-params">([]Result, error)</span></span> &#123;    tasksCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Task, <span class="hljs-built_in">len</span>(tasks))    resultsCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result, <span class="hljs-built_in">len</span>(tasks))        ctx, cancel := context.WithTimeout(context.Background(), timeout)    <span class="hljs-keyword">defer</span> cancel()        <span class="hljs-comment">// å¯åŠ¨å›ºå®šæ•°é‡çš„worker</span>    <span class="hljs-keyword">var</span> wg sync.WaitGroup    wg.Add(numWorkers)    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; numWorkers; i++ &#123;        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(workerID <span class="hljs-keyword">int</span>)</span></span> &#123;            <span class="hljs-keyword">defer</span> wg.Done()            <span class="hljs-keyword">for</span> &#123;                <span class="hljs-keyword">select</span> &#123;                <span class="hljs-keyword">case</span> task, ok := &lt;-tasksCh:                    <span class="hljs-keyword">if</span> !ok &#123;                        <span class="hljs-keyword">return</span> <span class="hljs-comment">// tasksChå·²å…³é—­ï¼Œé€€å‡º</span>                    &#125;                    result := process(workerID, task)                                        <span class="hljs-comment">// å‘é€ç»“æœï¼Œä½†éœ€è¦å¤„ç†ctxå–æ¶ˆçš„æƒ…å†µ</span>                    <span class="hljs-keyword">select</span> &#123;                    <span class="hljs-keyword">case</span> resultsCh &lt;- result:                        <span class="hljs-comment">// ç»“æœæˆåŠŸå‘é€</span>                    <span class="hljs-keyword">case</span> &lt;-ctx.Done():                        <span class="hljs-keyword">return</span> <span class="hljs-comment">// ä¸Šä¸‹æ–‡å·²å–æ¶ˆï¼Œé€€å‡º</span>                    &#125;                                    <span class="hljs-keyword">case</span> &lt;-ctx.Done():                    <span class="hljs-keyword">return</span> <span class="hljs-comment">// ä¸Šä¸‹æ–‡å·²å–æ¶ˆï¼Œé€€å‡º</span>                &#125;            &#125;        &#125;(i)    &#125;        <span class="hljs-comment">// å‘é€ä»»åŠ¡åˆ°ä»»åŠ¡channel</span>    <span class="hljs-keyword">for</span> _, task := <span class="hljs-keyword">range</span> tasks &#123;        <span class="hljs-keyword">select</span> &#123;        <span class="hljs-keyword">case</span> tasksCh &lt;- task:            <span class="hljs-comment">// ä»»åŠ¡æˆåŠŸå‘é€</span>        <span class="hljs-keyword">case</span> &lt;-ctx.Done():            <span class="hljs-built_in">close</span>(tasksCh) <span class="hljs-comment">// å…³é—­channelï¼Œè®©workeré€€å‡º</span>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, ctx.Err()        &#125;    &#125;    <span class="hljs-built_in">close</span>(tasksCh) <span class="hljs-comment">// å…³é—­ä»»åŠ¡channelï¼Œè¡¨ç¤ºæ²¡æœ‰æ›´å¤šä»»åŠ¡</span>        <span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰workerå®Œæˆæˆ–è¶…æ—¶</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        wg.Wait()        <span class="hljs-built_in">close</span>(resultsCh)    &#125;()        <span class="hljs-comment">// æ”¶é›†ç»“æœ</span>    <span class="hljs-keyword">var</span> results []Result    <span class="hljs-keyword">for</span> &#123;        <span class="hljs-keyword">select</span> &#123;        <span class="hljs-keyword">case</span> result, ok := &lt;-resultsCh:            <span class="hljs-keyword">if</span> !ok &#123;                <span class="hljs-comment">// resultsChå·²å…³é—­ï¼Œæ‰€æœ‰ç»“æœå·²æ”¶é›†</span>                <span class="hljs-keyword">return</span> results, <span class="hljs-literal">nil</span>            &#125;            results = <span class="hljs-built_in">append</span>(results, result)        <span class="hljs-keyword">case</span> &lt;-ctx.Done():            <span class="hljs-keyword">return</span> results, ctx.Err()        &#125;    &#125;&#125;</code></pre><h3 id="ğŸ”„-Pipelineæ¨¡å¼"><a class="header-anchor" href="#ğŸ”„-Pipelineæ¨¡å¼"></a>ğŸ”„ Pipelineæ¨¡å¼</h3><p>Pipelineï¼ˆç®¡é“ï¼‰æ¨¡å¼æ˜¯ä¸€ç§å°†æ•°æ®ä»ä¸€ä¸ªå¤„ç†é˜¶æ®µä¼ é€’åˆ°ä¸‹ä¸€ä¸ªå¤„ç†é˜¶æ®µçš„å¹¶å‘æ¨¡å¼ã€‚æ¯ä¸ªé˜¶æ®µå¯ä»¥ç”±ä¸€ä¸ªæˆ–å¤šä¸ªgoroutineç»„æˆï¼Œé€šè¿‡channelè¿æ¥å„ä¸ªé˜¶æ®µã€‚</p><h4 id="å®ç°åŸç†-2"><a class="header-anchor" href="#å®ç°åŸç†-2"></a>å®ç°åŸç†</h4><ol><li>æ¯ä¸ªå¤„ç†é˜¶æ®µæ¥æ”¶ä¸Šä¸€é˜¶æ®µçš„è¾“å‡ºä½œä¸ºè¾“å…¥</li><li>æ¯ä¸ªé˜¶æ®µå¹¶è¡Œå¤„ç†æ•°æ®ï¼Œå¹¶å°†ç»“æœå‘é€åˆ°ä¸‹ä¸€é˜¶æ®µ</li><li>å½“ç¬¬ä¸€ä¸ªé˜¶æ®µå®Œæˆæ—¶ï¼Œå®ƒä¼šå…³é—­è¾“å‡ºchannelï¼Œè§¦å‘ä¸‹ä¸€é˜¶æ®µçš„ç»“æŸï¼Œä»¥æ­¤ç±»æ¨</li></ol><h4 id="ç¤ºä¾‹ä»£ç -2"><a class="header-anchor" href="#ç¤ºä¾‹ä»£ç -2"></a>ç¤ºä¾‹ä»£ç </h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generator</span><span class="hljs-params">(nums ...<span class="hljs-keyword">int</span>)</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(out)        <span class="hljs-keyword">for</span> _, n := <span class="hljs-keyword">range</span> nums &#123;            out &lt;- n        &#125;    &#125;()    <span class="hljs-keyword">return</span> out&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">square</span><span class="hljs-params">(in &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(out)        <span class="hljs-keyword">for</span> n := <span class="hljs-keyword">range</span> in &#123;            out &lt;- n * n        &#125;    &#125;()    <span class="hljs-keyword">return</span> out&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">filter</span><span class="hljs-params">(in &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, f <span class="hljs-keyword">func</span>(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span>) &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(out)        <span class="hljs-keyword">for</span> n := <span class="hljs-keyword">range</span> in &#123;            <span class="hljs-keyword">if</span> f(n) &#123;                out &lt;- n            &#125;        &#125;    &#125;()    <span class="hljs-keyword">return</span> out&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªåŒ…å«1-10çš„æ•°å­—ç”Ÿæˆå™¨</span>    nums := generator(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>)        <span class="hljs-comment">// å¯¹æ•°å­—è¿›è¡Œå¹³æ–¹</span>    squares := square(nums)        <span class="hljs-comment">// è¿‡æ»¤å‡ºå¤§äº30çš„ç»“æœ</span>    results := filter(squares, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123;        <span class="hljs-keyword">return</span> n &gt; <span class="hljs-number">30</span>    &#125;)        <span class="hljs-comment">// æ‰“å°ç»“æœ</span>    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> results &#123;        fmt.Println(result)    &#125;&#125;</code></pre><h4 id="å¸¦é”™è¯¯å¤„ç†çš„Pipeline"><a class="header-anchor" href="#å¸¦é”™è¯¯å¤„ç†çš„Pipeline"></a>å¸¦é”™è¯¯å¤„ç†çš„Pipeline</h4><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒPipelineçš„å„ä¸ªé˜¶æ®µå¯èƒ½ä¼šäº§ç”Ÿé”™è¯¯ï¼Œæˆ‘ä»¬éœ€è¦å¦¥å–„å¤„ç†è¿™äº›é”™è¯¯ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Result <span class="hljs-keyword">struct</span> &#123;    Value <span class="hljs-keyword">int</span>    Err   error&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generatorWithError</span><span class="hljs-params">(nums ...<span class="hljs-keyword">int</span>)</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">Result</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(out)        <span class="hljs-keyword">for</span> _, n := <span class="hljs-keyword">range</span> nums &#123;            <span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">0</span> &#123;                out &lt;- Result&#123;Err: fmt.Errorf(<span class="hljs-string">&quot;negative number: %d&quot;</span>, n)&#125;                <span class="hljs-keyword">return</span>            &#125;            out &lt;- Result&#123;Value: n&#125;        &#125;    &#125;()    <span class="hljs-keyword">return</span> out&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">squareWithError</span><span class="hljs-params">(in &lt;-<span class="hljs-keyword">chan</span> Result)</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">Result</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(out)        <span class="hljs-keyword">for</span> r := <span class="hljs-keyword">range</span> in &#123;            <span class="hljs-keyword">if</span> r.Err != <span class="hljs-literal">nil</span> &#123;                out &lt;- r <span class="hljs-comment">// ä¼ é€’é”™è¯¯</span>                <span class="hljs-keyword">continue</span>            &#125;                        <span class="hljs-comment">// å¤„ç†å€¼</span>            <span class="hljs-keyword">if</span> r.Value &gt; <span class="hljs-number">100</span> &#123;                out &lt;- Result&#123;Err: fmt.Errorf(<span class="hljs-string">&quot;value too large: %d&quot;</span>, r.Value)&#125;                <span class="hljs-keyword">continue</span>            &#125;            out &lt;- Result&#123;Value: r.Value * r.Value&#125;        &#125;    &#125;()    <span class="hljs-keyword">return</span> out&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    results := squareWithError(generatorWithError(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">-3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>))        <span class="hljs-keyword">for</span> r := <span class="hljs-keyword">range</span> results &#123;        <span class="hljs-keyword">if</span> r.Err != <span class="hljs-literal">nil</span> &#123;            fmt.Println(<span class="hljs-string">&quot;Error:&quot;</span>, r.Err)            <span class="hljs-keyword">break</span>        &#125;        fmt.Println(<span class="hljs-string">&quot;Result:&quot;</span>, r.Value)    &#125;&#125;</code></pre><h3 id="ğŸ”€-Fan-Out-Fan-Inæ¨¡å¼"><a class="header-anchor" href="#ğŸ”€-Fan-Out-Fan-Inæ¨¡å¼"></a>ğŸ”€ Fan-Out, Fan-Inæ¨¡å¼</h3><p>Fan-Out, Fan-Inæ˜¯ä¸€ç§å°†å·¥ä½œåˆ†æ•£åˆ°å¤šä¸ªgoroutineï¼ˆFan-Outï¼‰ï¼Œç„¶åæ”¶é›†ç»“æœï¼ˆFan-Inï¼‰çš„å¹¶å‘æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼ç‰¹åˆ«é€‚åˆCPUå¯†é›†å‹ä»»åŠ¡ã€‚</p><h4 id="å®ç°åŸç†-3"><a class="header-anchor" href="#å®ç°åŸç†-3"></a>å®ç°åŸç†</h4><ol><li><strong>Fan-Out</strong>ï¼šå°†è¾“å…¥æ•°æ®åˆ†é…ç»™å¤šä¸ªgoroutineå¤„ç†</li><li><strong>Fan-In</strong>ï¼šå°†å¤šä¸ªgoroutineçš„è¾“å‡ºåˆå¹¶åˆ°ä¸€ä¸ªchannel</li></ol><h4 id="ç¤ºä¾‹ä»£ç -3"><a class="header-anchor" href="#ç¤ºä¾‹ä»£ç -3"></a>ç¤ºä¾‹ä»£ç </h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fanOut</span><span class="hljs-params">(in &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, n <span class="hljs-keyword">int</span>, f <span class="hljs-keyword">func</span>(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span>) []&lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºnä¸ªè¾“å‡ºchannel</span>    outs := <span class="hljs-built_in">make</span>([]&lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, n)    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;        outs[i] = processChannel(in, f)    &#125;    <span class="hljs-keyword">return</span> outs&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processChannel</span><span class="hljs-params">(in &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, f <span class="hljs-keyword">func</span>(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span>) &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(out)        <span class="hljs-keyword">for</span> v := <span class="hljs-keyword">range</span> in &#123;            out &lt;- f(v)        &#125;    &#125;()    <span class="hljs-keyword">return</span> out&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fanIn</span><span class="hljs-params">(channels []&lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">var</span> wg sync.WaitGroup        <span class="hljs-comment">// ä¸ºæ¯ä¸ªè¾“å…¥channelå¯åŠ¨ä¸€ä¸ªgoroutine</span>    wg.Add(<span class="hljs-built_in">len</span>(channels))    <span class="hljs-keyword">for</span> _, ch := <span class="hljs-keyword">range</span> channels &#123;        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span></span> &#123;            <span class="hljs-keyword">defer</span> wg.Done()            <span class="hljs-keyword">for</span> v := <span class="hljs-keyword">range</span> c &#123;                out &lt;- v            &#125;        &#125;(ch)    &#125;        <span class="hljs-comment">// å½“æ‰€æœ‰è¾“å…¥channelå…³é—­åï¼Œå…³é—­è¾“å‡ºchannel</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        wg.Wait()        <span class="hljs-built_in">close</span>(out)    &#125;()        <span class="hljs-keyword">return</span> out&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºè¾“å…¥channel</span>    in := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(in)        <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10</span>; i++ &#123;            in &lt;- i        &#125;    &#125;()        <span class="hljs-comment">// å®šä¹‰å¤„ç†å‡½æ•°ï¼ˆè®¡ç®—å¹³æ–¹ï¼‰</span>    square := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(x <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;        time.Sleep(<span class="hljs-number">100</span> * time.Millisecond) <span class="hljs-comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span>        <span class="hljs-keyword">return</span> x * x    &#125;        <span class="hljs-comment">// Fan-Outåˆ°4ä¸ªgoroutine</span>    channels := fanOut(in, <span class="hljs-number">4</span>, square)        <span class="hljs-comment">// Fan-Inç»“æœ</span>    out := fanIn(channels)        <span class="hljs-comment">// æ‰“å°ç»“æœ</span>    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> out &#123;        fmt.Println(result)    &#125;&#125;</code></pre><h4 id="ä½¿ç”¨contextæ§åˆ¶Fan-Out-Fan-In"><a class="header-anchor" href="#ä½¿ç”¨contextæ§åˆ¶Fan-Out-Fan-In"></a>ä½¿ç”¨contextæ§åˆ¶Fan-Out, Fan-In</h4><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å–æ¶ˆæˆ–è®¾ç½®è¶…æ—¶ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fanOutWithContext</span><span class="hljs-params">(ctx context.Context, in &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, n <span class="hljs-keyword">int</span>, f <span class="hljs-keyword">func</span>(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span>) []&lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    outs := <span class="hljs-built_in">make</span>([]&lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, n)    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;        outs[i] = processChannelWithContext(ctx, in, f)    &#125;    <span class="hljs-keyword">return</span> outs&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processChannelWithContext</span><span class="hljs-params">(ctx context.Context, in &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, f <span class="hljs-keyword">func</span>(<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span>) &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(out)        <span class="hljs-keyword">for</span> &#123;            <span class="hljs-keyword">select</span> &#123;            <span class="hljs-keyword">case</span> v, ok := &lt;-in:                <span class="hljs-keyword">if</span> !ok &#123;                    <span class="hljs-keyword">return</span>                &#125;                result := f(v)                <span class="hljs-keyword">select</span> &#123;                <span class="hljs-keyword">case</span> out &lt;- result:                    <span class="hljs-comment">// æˆåŠŸå‘é€</span>                <span class="hljs-keyword">case</span> &lt;-ctx.Done():                    <span class="hljs-keyword">return</span>                &#125;            <span class="hljs-keyword">case</span> &lt;-ctx.Done():                <span class="hljs-keyword">return</span>            &#125;        &#125;    &#125;()    <span class="hljs-keyword">return</span> out&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fanInWithContext</span><span class="hljs-params">(ctx context.Context, channels []&lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;    out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">var</span> wg sync.WaitGroup        <span class="hljs-comment">// ä¸ºæ¯ä¸ªè¾“å…¥channelå¯åŠ¨ä¸€ä¸ªgoroutine</span>    wg.Add(<span class="hljs-built_in">len</span>(channels))    <span class="hljs-keyword">for</span> _, ch := <span class="hljs-keyword">range</span> channels &#123;        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span></span> &#123;            <span class="hljs-keyword">defer</span> wg.Done()            <span class="hljs-keyword">for</span> &#123;                <span class="hljs-keyword">select</span> &#123;                <span class="hljs-keyword">case</span> v, ok := &lt;-c:                    <span class="hljs-keyword">if</span> !ok &#123;                        <span class="hljs-keyword">return</span>                    &#125;                    <span class="hljs-keyword">select</span> &#123;                    <span class="hljs-keyword">case</span> out &lt;- v:                        <span class="hljs-comment">// æˆåŠŸå‘é€</span>                    <span class="hljs-keyword">case</span> &lt;-ctx.Done():                        <span class="hljs-keyword">return</span>                    &#125;                <span class="hljs-keyword">case</span> &lt;-ctx.Done():                    <span class="hljs-keyword">return</span>                &#125;            &#125;        &#125;(ch)    &#125;        <span class="hljs-comment">// å½“æ‰€æœ‰è¾“å…¥channelå…³é—­æˆ–ä¸Šä¸‹æ–‡å–æ¶ˆæ—¶ï¼Œå…³é—­è¾“å‡ºchannel</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        wg.Wait()        <span class="hljs-built_in">close</span>(out)    &#125;()        <span class="hljs-keyword">return</span> out&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºå¸¦è¶…æ—¶çš„ä¸Šä¸‹æ–‡</span>    ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">2</span>*time.Second)    <span class="hljs-keyword">defer</span> cancel()        <span class="hljs-comment">// åˆ›å»ºè¾“å…¥channel</span>    in := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(in)        <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10</span>; i++ &#123;            <span class="hljs-keyword">select</span> &#123;            <span class="hljs-keyword">case</span> in &lt;- i:                <span class="hljs-comment">// æˆåŠŸå‘é€</span>            <span class="hljs-keyword">case</span> &lt;-ctx.Done():                <span class="hljs-keyword">return</span>            &#125;        &#125;    &#125;()        <span class="hljs-comment">// å®šä¹‰å¤„ç†å‡½æ•°</span>    square := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(x <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;        time.Sleep(<span class="hljs-number">100</span> * time.Millisecond) <span class="hljs-comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span>        <span class="hljs-keyword">return</span> x * x    &#125;        <span class="hljs-comment">// Fan-Outåˆ°4ä¸ªgoroutine</span>    channels := fanOutWithContext(ctx, in, <span class="hljs-number">4</span>, square)        <span class="hljs-comment">// Fan-Inç»“æœ</span>    out := fanInWithContext(ctx, channels)        <span class="hljs-comment">// æ‰“å°ç»“æœ</span>    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> out &#123;        fmt.Println(result)    &#125;&#125;</code></pre><h3 id="ğŸ”’-å¹¶å‘æ§åˆ¶æ¨¡å¼"><a class="header-anchor" href="#ğŸ”’-å¹¶å‘æ§åˆ¶æ¨¡å¼"></a>ğŸ”’ å¹¶å‘æ§åˆ¶æ¨¡å¼</h3><p>åœ¨å¤„ç†å¹¶å‘æ—¶ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦æ§åˆ¶goroutineçš„è¡Œä¸ºï¼Œä¾‹å¦‚é™åˆ¶å¹¶å‘æ•°é‡ã€ç­‰å¾…æ‰€æœ‰goroutineå®Œæˆç­‰ã€‚</p><h4 id="ä½¿ç”¨semaphoreé™åˆ¶å¹¶å‘æ•°é‡"><a class="header-anchor" href="#ä½¿ç”¨semaphoreé™åˆ¶å¹¶å‘æ•°é‡"></a>ä½¿ç”¨semaphoreé™åˆ¶å¹¶å‘æ•°é‡</h4><p>è™½ç„¶Worker Poolä¹Ÿå¯ä»¥é™åˆ¶å¹¶å‘æ•°é‡ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬éœ€è¦æ›´çµæ´»çš„æ–¹å¼ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;golang.org/x/sync/semaphore&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">limitConcurrency</span><span class="hljs-params">(urls []<span class="hljs-keyword">string</span>, concurrencyLimit <span class="hljs-keyword">int64</span>)</span> []<span class="hljs-title">Result</span></span> &#123;    sem := semaphore.NewWeighted(concurrencyLimit)    ctx := context.Background()        <span class="hljs-keyword">var</span> results []Result    <span class="hljs-keyword">var</span> mu sync.Mutex <span class="hljs-comment">// ä¿æŠ¤results</span>        <span class="hljs-keyword">var</span> wg sync.WaitGroup    <span class="hljs-keyword">for</span> _, url := <span class="hljs-keyword">range</span> urls &#123;        wg.Add(<span class="hljs-number">1</span>)        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(url <span class="hljs-keyword">string</span>)</span></span> &#123;            <span class="hljs-keyword">defer</span> wg.Done()                        <span class="hljs-comment">// è·å–ä¿¡å·é‡</span>            <span class="hljs-keyword">if</span> err := sem.Acquire(ctx, <span class="hljs-number">1</span>); err != <span class="hljs-literal">nil</span> &#123;                fmt.Printf(<span class="hljs-string">&quot;Failed to acquire semaphore: %v\n&quot;</span>, err)                <span class="hljs-keyword">return</span>            &#125;            <span class="hljs-keyword">defer</span> sem.Release(<span class="hljs-number">1</span>)                        <span class="hljs-comment">// æ‰§è¡ŒHTTPè¯·æ±‚</span>            result := fetchURL(url)                        <span class="hljs-comment">// å®‰å…¨åœ°æ·»åŠ ç»“æœ</span>            mu.Lock()            results = <span class="hljs-built_in">append</span>(results, result)            mu.Unlock()        &#125;(url)    &#125;        wg.Wait()    <span class="hljs-keyword">return</span> results&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fetchURL</span><span class="hljs-params">(url <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Result</span></span> &#123;    <span class="hljs-comment">// æ¨¡æ‹ŸHTTPè¯·æ±‚</span>    time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)    <span class="hljs-keyword">return</span> Result&#123;URL: url, Status: <span class="hljs-string">&quot;OK&quot;</span>&#125;&#125;</code></pre><h4 id="ä½¿ç”¨errgroupè¿›è¡Œé”™è¯¯å¤„ç†å’Œå–æ¶ˆ"><a class="header-anchor" href="#ä½¿ç”¨errgroupè¿›è¡Œé”™è¯¯å¤„ç†å’Œå–æ¶ˆ"></a>ä½¿ç”¨errgroupè¿›è¡Œé”™è¯¯å¤„ç†å’Œå–æ¶ˆ</h4><p><code>golang.org/x/sync/errgroup</code>åŒ…æä¾›äº†ä¸€ç§ä¼˜é›…çš„æ–¹å¼æ¥å¤„ç†goroutineç»„ä¸­çš„é”™è¯¯ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;golang.org/x/sync/errgroup&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fetchAllURLs</span><span class="hljs-params">(urls []<span class="hljs-keyword">string</span>)</span> <span class="hljs-params">([]Result, error)</span></span> &#123;    <span class="hljs-keyword">var</span> results []Result    <span class="hljs-keyword">var</span> mu sync.Mutex        g, ctx := errgroup.WithContext(context.Background())        <span class="hljs-keyword">for</span> _, url := <span class="hljs-keyword">range</span> urls &#123;        url := url <span class="hljs-comment">// åˆ›å»ºå‰¯æœ¬ï¼Œé¿å…é—­åŒ…é—®é¢˜</span>        g.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;            result, err := fetchURLWithContext(ctx, url)            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;                <span class="hljs-keyword">return</span> err <span class="hljs-comment">// è¿”å›é”™è¯¯ä¼šå¯¼è‡´å…¶ä»–goroutineè¢«å–æ¶ˆ</span>            &#125;                        mu.Lock()            results = <span class="hljs-built_in">append</span>(results, result)            mu.Unlock()                        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>        &#125;)    &#125;        <span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰goroutineå®Œæˆæˆ–æœ‰ä¸€ä¸ªè¿”å›é”™è¯¯</span>    <span class="hljs-keyword">if</span> err := g.Wait(); err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;        <span class="hljs-keyword">return</span> results, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fetchURLWithContext</span><span class="hljs-params">(ctx context.Context, url <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(Result, error)</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¯å–æ¶ˆçš„HTTPè¯·æ±‚</span>    req, err := http.NewRequestWithContext(ctx, <span class="hljs-string">&quot;GET&quot;</span>, url, <span class="hljs-literal">nil</span>)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> Result&#123;&#125;, err    &#125;        resp, err := http.DefaultClient.Do(req)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> Result&#123;&#125;, err    &#125;    <span class="hljs-keyword">defer</span> resp.Body.Close()        <span class="hljs-comment">// å¤„ç†å“åº”...</span>    <span class="hljs-keyword">return</span> Result&#123;URL: url, Status: resp.Status&#125;, <span class="hljs-literal">nil</span>&#125;</code></pre><h3 id="ğŸ”-è¶…æ—¶å’Œå–æ¶ˆæ¨¡å¼"><a class="header-anchor" href="#ğŸ”-è¶…æ—¶å’Œå–æ¶ˆæ¨¡å¼"></a>ğŸ” è¶…æ—¶å’Œå–æ¶ˆæ¨¡å¼</h3><p>åœ¨å¹¶å‘ç¨‹åºä¸­ï¼Œåˆç†å¤„ç†è¶…æ—¶å’Œå–æ¶ˆæ“ä½œæ˜¯éå¸¸é‡è¦çš„ï¼Œå¯ä»¥é¿å…èµ„æºæ³„éœ²ã€‚</p><h4 id="è¶…æ—¶æ¨¡å¼"><a class="header-anchor" href="#è¶…æ—¶æ¨¡å¼"></a>è¶…æ—¶æ¨¡å¼</h4><p>ä½¿ç”¨<code>context.WithTimeout</code>æˆ–<code>time.After</code>å®ç°è¶…æ—¶æ§åˆ¶ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">operationWithTimeout</span><span class="hljs-params">(timeout time.Duration)</span> <span class="hljs-params">(Result, error)</span></span> &#123;    ctx, cancel := context.WithTimeout(context.Background(), timeout)    <span class="hljs-keyword">defer</span> cancel()        resultCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result, <span class="hljs-number">1</span>)    errCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> error, <span class="hljs-number">1</span>)        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        result, err := performOperation()        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            errCh &lt;- err            <span class="hljs-keyword">return</span>        &#125;        resultCh &lt;- result    &#125;()        <span class="hljs-keyword">select</span> &#123;    <span class="hljs-keyword">case</span> result := &lt;-resultCh:        <span class="hljs-keyword">return</span> result, <span class="hljs-literal">nil</span>    <span class="hljs-keyword">case</span> err := &lt;-errCh:        <span class="hljs-keyword">return</span> Result&#123;&#125;, err    <span class="hljs-keyword">case</span> &lt;-ctx.Done():        <span class="hljs-keyword">return</span> Result&#123;&#125;, ctx.Err()    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">performOperation</span><span class="hljs-params">()</span> <span class="hljs-params">(Result, error)</span></span> &#123;    <span class="hljs-comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span>    time.Sleep(<span class="hljs-number">200</span> * time.Millisecond)    <span class="hljs-keyword">return</span> Result&#123;Value: <span class="hljs-number">42</span>&#125;, <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="å–æ¶ˆæ¨¡å¼"><a class="header-anchor" href="#å–æ¶ˆæ¨¡å¼"></a>å–æ¶ˆæ¨¡å¼</h4><p>ä½¿ç”¨<code>context.WithCancel</code>å®ç°å–æ¶ˆæ“ä½œï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">operationWithCancel</span><span class="hljs-params">()</span></span> &#123;    ctx, cancel := context.WithCancel(context.Background())        <span class="hljs-comment">// å¯åŠ¨å·¥ä½œgoroutine</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">for</span> &#123;            <span class="hljs-keyword">select</span> &#123;            <span class="hljs-keyword">case</span> &lt;-ctx.Done():                fmt.Println(<span class="hljs-string">&quot;Worker: Received cancel signal, stopping&quot;</span>)                <span class="hljs-keyword">return</span>            <span class="hljs-keyword">default</span>:                fmt.Println(<span class="hljs-string">&quot;Worker: Working...&quot;</span>)                time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)            &#125;        &#125;    &#125;()        <span class="hljs-comment">// è®©å·¥ä½œgoroutineè¿è¡Œä¸€æ®µæ—¶é—´</span>    time.Sleep(<span class="hljs-number">500</span> * time.Millisecond)        <span class="hljs-comment">// å‘é€å–æ¶ˆä¿¡å·</span>    fmt.Println(<span class="hljs-string">&quot;Main: Sending cancel signal&quot;</span>)    cancel()        <span class="hljs-comment">// ç»™å·¥ä½œgoroutineæ—¶é—´é€€å‡º</span>    time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)    fmt.Println(<span class="hljs-string">&quot;Main: Done&quot;</span>)&#125;</code></pre><h3 id="ğŸ”„-ä¼˜é›…é€€å‡ºæ¨¡å¼"><a class="header-anchor" href="#ğŸ”„-ä¼˜é›…é€€å‡ºæ¨¡å¼"></a>ğŸ”„ ä¼˜é›…é€€å‡ºæ¨¡å¼</h3><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œç‰¹åˆ«æ˜¯æœåŠ¡å™¨ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ç¨‹åºå¯ä»¥ä¼˜é›…åœ°é€€å‡ºï¼Œä¸ä¼šä¸¢å¤±æ•°æ®æˆ–ç•™ä¸‹èµ„æºæ³„éœ²ã€‚</p><h4 id="ä½¿ç”¨ä¿¡å·å¤„ç†å®ç°ä¼˜é›…é€€å‡º"><a class="header-anchor" href="#ä½¿ç”¨ä¿¡å·å¤„ç†å®ç°ä¼˜é›…é€€å‡º"></a>ä½¿ç”¨ä¿¡å·å¤„ç†å®ç°ä¼˜é›…é€€å‡º</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªç”¨äºæ¥æ”¶ç³»ç»Ÿä¿¡å·çš„channel</span>    sigs := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">1</span>)    signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM)        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªç”¨äºé€šçŸ¥ç¨‹åºé€€å‡ºçš„channel</span>    done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">bool</span>, <span class="hljs-number">1</span>)        <span class="hljs-comment">// å¯åŠ¨æœåŠ¡</span>    server := startServer()        <span class="hljs-comment">// å¤„ç†ä¿¡å·</span>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        sig := &lt;-sigs        fmt.Printf(<span class="hljs-string">&quot;Received signal: %s\n&quot;</span>, sig)                <span class="hljs-comment">// ä¼˜é›…å…³é—­æœåŠ¡</span>        fmt.Println(<span class="hljs-string">&quot;Shutting down server...&quot;</span>)        ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">30</span>*time.Second)        <span class="hljs-keyword">defer</span> cancel()                <span class="hljs-keyword">if</span> err := server.Shutdown(ctx); err != <span class="hljs-literal">nil</span> &#123;            fmt.Printf(<span class="hljs-string">&quot;Server shutdown error: %v\n&quot;</span>, err)        &#125;                done &lt;- <span class="hljs-literal">true</span>    &#125;()        fmt.Println(<span class="hljs-string">&quot;Server started, press CTRL+C to stop&quot;</span>)    &lt;-done    fmt.Println(<span class="hljs-string">&quot;Server stopped&quot;</span>)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startServer</span><span class="hljs-params">()</span> *<span class="hljs-title">http</span>.<span class="hljs-title">Server</span></span> &#123;    router := http.NewServeMux()    router.HandleFunc(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;        time.Sleep(<span class="hljs-number">100</span> * time.Millisecond) <span class="hljs-comment">// æ¨¡æ‹Ÿå¤„ç†æ—¶é—´</span>        fmt.Fprintf(w, <span class="hljs-string">&quot;Hello, World!&quot;</span>)    &#125;)        server := &amp;http.Server&#123;        Addr:    <span class="hljs-string">&quot;:8080&quot;</span>,        Handler: router,    &#125;        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">if</span> err := server.ListenAndServe(); err != http.ErrServerClosed &#123;            fmt.Printf(<span class="hljs-string">&quot;Server error: %v\n&quot;</span>, err)        &#125;    &#125;()        <span class="hljs-keyword">return</span> server&#125;</code></pre><h3 id="ğŸ“Š-å¹¶å‘æ¨¡å¼æ€§èƒ½å¯¹æ¯”"><a class="header-anchor" href="#ğŸ“Š-å¹¶å‘æ¨¡å¼æ€§èƒ½å¯¹æ¯”"></a>ğŸ“Š å¹¶å‘æ¨¡å¼æ€§èƒ½å¯¹æ¯”</h3><p>ä¸åŒçš„å¹¶å‘æ¨¡å¼é€‚ç”¨äºä¸åŒçš„åœºæ™¯ï¼Œä¸‹é¢æ˜¯ä¸€äº›å¸¸è§å¹¶å‘æ¨¡å¼çš„æ€§èƒ½å¯¹æ¯”ï¼š</p><table><thead><tr><th>å¹¶å‘æ¨¡å¼</th><th>CPUå¯†é›†å‹ä»»åŠ¡</th><th>IOå¯†é›†å‹ä»»åŠ¡</th><th>å†…å­˜å ç”¨</th><th>å®ç°å¤æ‚åº¦</th></tr></thead><tbody><tr><td>å•goroutine</td><td>ä½</td><td>ä½</td><td>ä½</td><td>ä½</td></tr><tr><td>æ— é™åˆ¶goroutine</td><td>é«˜ï¼ˆç›´åˆ°CPUé¥±å’Œï¼‰</td><td>ä¸­ï¼ˆå¯èƒ½å—ç³»ç»Ÿé™åˆ¶ï¼‰</td><td>é«˜</td><td>ä½</td></tr><tr><td>Worker Pool</td><td>ä¸­ï¼ˆå¯æ§ï¼‰</td><td>é«˜</td><td>ä¸­</td><td>ä¸­</td></tr><tr><td>Pipeline</td><td>ä¸­</td><td>é«˜</td><td>ä¸­</td><td>ä¸­</td></tr><tr><td>Fan-Out, Fan-In</td><td>é«˜</td><td>é«˜</td><td>ä¸­</td><td>é«˜</td></tr></tbody></table><h3 id="ğŸ§ª-å¹¶å‘æ¨¡å¼æµ‹è¯•æŠ€å·§"><a class="header-anchor" href="#ğŸ§ª-å¹¶å‘æ¨¡å¼æµ‹è¯•æŠ€å·§"></a>ğŸ§ª å¹¶å‘æ¨¡å¼æµ‹è¯•æŠ€å·§</h3><p>æµ‹è¯•å¹¶å‘ä»£ç æ˜¯ä¸€é¡¹æŒ‘æˆ˜ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›æœ‰ç”¨çš„æŠ€å·§ï¼š</p><h4 id="ä½¿ç”¨race-detector"><a class="header-anchor" href="#ä½¿ç”¨race-detector"></a>ä½¿ç”¨race detector</h4><p>Goå†…ç½®äº†race detectorï¼Œå¯ä»¥å¸®åŠ©æ£€æµ‹æ•°æ®ç«äº‰ï¼š</p><pre><code class="hljs bash">go <span class="hljs-built_in">test</span> -race ./...</code></pre><h4 id="ä½¿ç”¨è¶…æ—¶æ§åˆ¶æµ‹è¯•"><a class="header-anchor" href="#ä½¿ç”¨è¶…æ—¶æ§åˆ¶æµ‹è¯•"></a>ä½¿ç”¨è¶…æ—¶æ§åˆ¶æµ‹è¯•</h4><p>é¿å…æµ‹è¯•å› ä¸ºæ­»é”æˆ–å…¶ä»–å¹¶å‘é—®é¢˜è€Œæ— é™æŒ‚èµ·ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestWorkerPool</span><span class="hljs-params">(t *testing.T)</span></span> &#123;    t.Parallel() <span class="hljs-comment">// å…è®¸å¹¶è¡Œæµ‹è¯•</span>        <span class="hljs-comment">// è®¾ç½®æµ‹è¯•è¶…æ—¶</span>    ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">5</span>*time.Second)    <span class="hljs-keyword">defer</span> cancel()        done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-comment">// æ‰§è¡Œæµ‹è¯•é€»è¾‘</span>        results, err := WorkerPool(<span class="hljs-number">5</span>, generateTasks(<span class="hljs-number">100</span>), <span class="hljs-number">3</span>*time.Second)        assert.NoError(t, err)        assert.Len(t, results, <span class="hljs-number">100</span>)                <span class="hljs-built_in">close</span>(done)    &#125;()        <span class="hljs-keyword">select</span> &#123;    <span class="hljs-keyword">case</span> &lt;-done:        <span class="hljs-comment">// æµ‹è¯•æˆåŠŸå®Œæˆ</span>    <span class="hljs-keyword">case</span> &lt;-ctx.Done():        t.Fatal(<span class="hljs-string">&quot;Test timed out&quot;</span>)    &#125;&#125;</code></pre><h4 id="ä½¿ç”¨deterministicæµ‹è¯•"><a class="header-anchor" href="#ä½¿ç”¨deterministicæµ‹è¯•"></a>ä½¿ç”¨deterministicæµ‹è¯•</h4><p>å¯¹äºå¹¶å‘ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨ç¡®å®šæ€§æµ‹è¯•æ–¹æ³•ï¼Œä¾‹å¦‚ä½¿ç”¨channelæ¥æ§åˆ¶goroutineçš„æ‰§è¡Œé¡ºåºï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestPipeline</span><span class="hljs-params">(t *testing.T)</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºæ§åˆ¶channel</span>    proceed := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå—æ§çš„ç”Ÿæˆå™¨</span>    gen := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;        out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;            <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(out)            <span class="hljs-comment">// ç­‰å¾…ä¿¡å·å†ç»§ç»­</span>            &lt;-proceed            out &lt;- <span class="hljs-number">1</span>            &lt;-proceed            out &lt;- <span class="hljs-number">2</span>            &lt;-proceed            out &lt;- <span class="hljs-number">3</span>        &#125;()        <span class="hljs-keyword">return</span> out    &#125;        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå—æ§çš„å¤„ç†å™¨</span>    process := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(in &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;        out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;            <span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(out)            <span class="hljs-keyword">for</span> n := <span class="hljs-keyword">range</span> in &#123;                <span class="hljs-comment">// ç­‰å¾…ä¿¡å·å†ç»§ç»­</span>                &lt;-proceed                out &lt;- n * <span class="hljs-number">2</span>            &#125;        &#125;()        <span class="hljs-keyword">return</span> out    &#125;        <span class="hljs-comment">// å¯åŠ¨pipeline</span>    nums := gen()    doubled := process(nums)        <span class="hljs-comment">// æ§åˆ¶æ‰§è¡Œé¡ºåºå¹¶éªŒè¯ç»“æœ</span>    proceed &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// è®©ç”Ÿæˆå™¨äº§ç”Ÿ1</span>    proceed &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// è®©å¤„ç†å™¨å¤„ç†1</span>    assert.Equal(t, <span class="hljs-number">2</span>, &lt;-doubled)        proceed &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// è®©ç”Ÿæˆå™¨äº§ç”Ÿ2</span>    proceed &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// è®©å¤„ç†å™¨å¤„ç†2</span>    assert.Equal(t, <span class="hljs-number">4</span>, &lt;-doubled)        proceed &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// è®©ç”Ÿæˆå™¨äº§ç”Ÿ3</span>    proceed &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// è®©å¤„ç†å™¨å¤„ç†3</span>    assert.Equal(t, <span class="hljs-number">6</span>, &lt;-doubled)&#125;</code></pre><h3 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h3><p>Goè¯­è¨€æä¾›äº†å¼ºå¤§è€Œçµæ´»çš„å¹¶å‘åŸè¯­ï¼Œä½¿å¾—å®ç°å„ç§å¹¶å‘æ¨¡å¼å˜å¾—ç›¸å¯¹ç®€å•ã€‚æœ¬æ–‡ä»‹ç»çš„é«˜çº§å¹¶å‘æ¨¡å¼å¯ä»¥å¸®åŠ©ä½ è§£å†³å®é™…å¼€å‘ä¸­çš„å¤æ‚å¹¶å‘é—®é¢˜ï¼š</p><ol><li><strong>Worker Poolæ¨¡å¼</strong>ï¼šé™åˆ¶å¹¶å‘æ•°é‡ï¼Œé¿å…èµ„æºè€—å°½</li><li><strong>Pipelineæ¨¡å¼</strong>ï¼šå°†æ•°æ®å¤„ç†åˆ†ä¸ºå¤šä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µå¹¶è¡Œæ‰§è¡Œ</li><li><strong>Fan-Out, Fan-Inæ¨¡å¼</strong>ï¼šå°†å·¥ä½œåˆ†æ•£åˆ°å¤šä¸ªgoroutineï¼Œç„¶åæ”¶é›†ç»“æœ</li><li><strong>å¹¶å‘æ§åˆ¶æ¨¡å¼</strong>ï¼šä½¿ç”¨semaphoreæˆ–errgroupæ§åˆ¶goroutineçš„è¡Œä¸º</li><li><strong>è¶…æ—¶å’Œå–æ¶ˆæ¨¡å¼</strong>ï¼šä¼˜é›…åœ°å¤„ç†è¶…æ—¶å’Œå–æ¶ˆæ“ä½œ</li><li><strong>ä¼˜é›…é€€å‡ºæ¨¡å¼</strong>ï¼šç¡®ä¿ç¨‹åºå¯ä»¥å®‰å…¨åœ°é€€å‡ºï¼Œä¸ä¼šä¸¢å¤±æ•°æ®æˆ–ç•™ä¸‹èµ„æºæ³„éœ²</li></ol><p>é€‰æ‹©åˆé€‚çš„å¹¶å‘æ¨¡å¼å–å†³äºä½ çš„å…·ä½“éœ€æ±‚ï¼Œå¦‚ä»»åŠ¡ç±»å‹ï¼ˆCPUå¯†é›†å‹æˆ–IOå¯†é›†å‹ï¼‰ã€å†…å­˜é™åˆ¶ã€é”™è¯¯å¤„ç†ç­–ç•¥ç­‰ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ å¯èƒ½éœ€è¦ç»„åˆå¤šç§æ¨¡å¼æ¥æ„å»ºé«˜æ•ˆã€å¯é çš„å¹¶å‘ç³»ç»Ÿã€‚</p><p>è®°ä½ï¼Œå¹¶å‘ç¼–ç¨‹è™½ç„¶å¼ºå¤§ï¼Œä½†ä¹Ÿå……æ»¡æŒ‘æˆ˜ã€‚å§‹ç»ˆå…³æ³¨æ•°æ®ç«äº‰ã€æ­»é”ã€èµ„æºæ³„éœ²ç­‰é—®é¢˜ï¼Œå¹¶ä½¿ç”¨Goæä¾›çš„å·¥å…·ï¼ˆå¦‚race detectorï¼‰æ¥å¸®åŠ©æ£€æµ‹è¿™äº›é—®é¢˜ã€‚é€šè¿‡å®è·µå’Œç»éªŒç§¯ç´¯ï¼Œä½ å°†èƒ½å¤Ÿç†Ÿç»ƒæŒæ¡è¿™äº›é«˜çº§å¹¶å‘æ¨¡å¼ï¼Œç¼–å†™å‡ºé«˜æ•ˆã€å¥å£®çš„Goç¨‹åºã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>å¹¶å‘</tag>
      
      <tag>goroutine</tag>
      
      <tag>channel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang ç°ä»£åŒ–é”™è¯¯å¤„ç†æœ€ä½³å®è·µ</title>
    <link href="/2024/01/22/golang-%E7%8E%B0%E4%BB%A3%E5%8C%96%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"/>
    <url>/2024/01/22/golang-%E7%8E%B0%E4%BB%A3%E5%8C%96%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ”-golang-ç°ä»£åŒ–é”™è¯¯å¤„ç†æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸ”-golang-ç°ä»£åŒ–é”™è¯¯å¤„ç†æœ€ä½³å®è·µ"></a>ğŸ” golang ç°ä»£åŒ–é”™è¯¯å¤„ç†æœ€ä½³å®è·µ</h2><p>Goè¯­è¨€çš„é”™è¯¯å¤„ç†ä¸€ç›´æ˜¯å¼€å‘è€…å…³æ³¨çš„ç„¦ç‚¹ï¼Œéšç€è¯­è¨€çš„å‘å±•ï¼Œé”™è¯¯å¤„ç†çš„æœ€ä½³å®è·µä¹Ÿåœ¨ä¸æ–­æ¼”è¿›ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Goè¯­è¨€ä¸­ç°ä»£åŒ–çš„é”™è¯¯å¤„ç†æ–¹æ³•ï¼ŒåŒ…æ‹¬é”™è¯¯åˆ›å»ºã€é”™è¯¯åŒ…è£…ã€é”™è¯¯ç±»å‹æ–­è¨€ã€è‡ªå®šä¹‰é”™è¯¯ç­‰é«˜çº§æŠ€å·§ã€‚</p><h3 id="ğŸ“Œ-Goé”™è¯¯å¤„ç†çš„åŸºæœ¬åŸåˆ™"><a class="header-anchor" href="#ğŸ“Œ-Goé”™è¯¯å¤„ç†çš„åŸºæœ¬åŸåˆ™"></a>ğŸ“Œ Goé”™è¯¯å¤„ç†çš„åŸºæœ¬åŸåˆ™</h3><p>Goè¯­è¨€é‡‡ç”¨æ˜¾å¼çš„é”™è¯¯å¤„ç†æ–¹å¼ï¼Œé€šè¿‡è¿”å›å€¼è€Œéå¼‚å¸¸æ¥è¡¨ç¤ºé”™è¯¯ã€‚è¿™ç§è®¾è®¡æœ‰å‡ ä¸ªæ ¸å¿ƒåŸåˆ™ï¼š</p><ol><li><strong>æ˜¾å¼å¤„ç†</strong>ï¼šé”™è¯¯å¿…é¡»è¢«æ˜¾å¼æ£€æŸ¥å’Œå¤„ç†</li><li><strong>é”™è¯¯å³å€¼</strong>ï¼šé”™è¯¯æ˜¯æ™®é€šçš„å€¼ï¼Œå¯ä»¥åƒå…¶ä»–å€¼ä¸€æ ·ä¼ é€’å’Œæ“ä½œ</li><li><strong>ä¸Šä¸‹æ–‡ä¼ é€’</strong>ï¼šé”™è¯¯åº”è¯¥æºå¸¦è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯</li><li><strong>é”™è¯¯å†³ç­–</strong>ï¼šè°ƒç”¨è€…å†³å®šå¦‚ä½•å¤„ç†é”™è¯¯</li></ol><h3 id="ğŸ§©-åŸºç¡€é”™è¯¯å¤„ç†æ¨¡å¼"><a class="header-anchor" href="#ğŸ§©-åŸºç¡€é”™è¯¯å¤„ç†æ¨¡å¼"></a>ğŸ§© åŸºç¡€é”™è¯¯å¤„ç†æ¨¡å¼</h3><h4 id="1-åŸºæœ¬çš„é”™è¯¯æ£€æŸ¥"><a class="header-anchor" href="#1-åŸºæœ¬çš„é”™è¯¯æ£€æŸ¥"></a>1. åŸºæœ¬çš„é”™è¯¯æ£€æŸ¥</h4><p>æœ€åŸºæœ¬çš„é”™è¯¯å¤„ç†æ¨¡å¼æ˜¯æ£€æŸ¥å‡½æ•°è¿”å›çš„é”™è¯¯ï¼š</p><pre><code class="hljs go">file, err := os.Open(<span class="hljs-string">&quot;file.txt&quot;</span>)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;    <span class="hljs-comment">// å¤„ç†é”™è¯¯</span>    <span class="hljs-keyword">return</span> err&#125;<span class="hljs-comment">// ä½¿ç”¨file</span></code></pre><h4 id="2-ä½¿ç”¨errorsåŒ…åˆ›å»ºç®€å•é”™è¯¯"><a class="header-anchor" href="#2-ä½¿ç”¨errorsåŒ…åˆ›å»ºç®€å•é”™è¯¯"></a>2. ä½¿ç”¨errorsåŒ…åˆ›å»ºç®€å•é”™è¯¯</h4><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;errors&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">validateAge</span><span class="hljs-params">(age <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-keyword">if</span> age &lt; <span class="hljs-number">0</span> &#123;        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;å¹´é¾„ä¸èƒ½ä¸ºè´Ÿæ•°&quot;</span>)    &#125;    <span class="hljs-keyword">if</span> age &gt; <span class="hljs-number">150</span> &#123;        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;å¹´é¾„ä¸åˆç†&quot;</span>)    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="3-ä½¿ç”¨fmt-Errorfåˆ›å»ºæ ¼å¼åŒ–é”™è¯¯"><a class="header-anchor" href="#3-ä½¿ç”¨fmt-Errorfåˆ›å»ºæ ¼å¼åŒ–é”™è¯¯"></a>3. ä½¿ç”¨fmt.Errorfåˆ›å»ºæ ¼å¼åŒ–é”™è¯¯</h4><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">validateAge</span><span class="hljs-params">(age <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-keyword">if</span> age &lt; <span class="hljs-number">0</span> &#123;        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;æ— æ•ˆçš„å¹´é¾„: %d (ä¸èƒ½ä¸ºè´Ÿæ•°)&quot;</span>, age)    &#125;    <span class="hljs-keyword">if</span> age &gt; <span class="hljs-number">150</span> &#123;        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;æ— æ•ˆçš„å¹´é¾„: %d (è¶…è¿‡åˆç†èŒƒå›´)&quot;</span>, age)    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h3 id="ğŸ”„-Go-1-13åçš„é”™è¯¯åŒ…è£…"><a class="header-anchor" href="#ğŸ”„-Go-1-13åçš„é”™è¯¯åŒ…è£…"></a>ğŸ”„ Go 1.13åçš„é”™è¯¯åŒ…è£…</h3><p>Go 1.13å¼•å…¥äº†é”™è¯¯åŒ…è£…çš„æ¦‚å¿µï¼Œå…è®¸åœ¨ä¸ä¸¢å¤±åŸå§‹é”™è¯¯çš„æƒ…å†µä¸‹æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p><h4 id="1-ä½¿ç”¨fmt-Errorfå’Œ-wåŠ¨è¯åŒ…è£…é”™è¯¯"><a class="header-anchor" href="#1-ä½¿ç”¨fmt-Errorfå’Œ-wåŠ¨è¯åŒ…è£…é”™è¯¯"></a>1. ä½¿ç”¨fmt.Errorfå’Œ%wåŠ¨è¯åŒ…è£…é”™è¯¯</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readConfig</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, error)</span></span> &#123;    data, err := os.ReadFile(path)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;è¯»å–é…ç½®æ–‡ä»¶ %s å¤±è´¥: %w&quot;</span>, path, err)    &#125;    <span class="hljs-keyword">return</span> data, <span class="hljs-literal">nil</span>&#125;</code></pre><p>ä½¿ç”¨<code>%w</code>åŠ¨è¯åŒ…è£…é”™è¯¯åï¼Œå¯ä»¥é€šè¿‡<code>errors.Unwrap</code>å‡½æ•°è·å–åŸå§‹é”™è¯¯ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processConfig</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;    data, err := readConfig(<span class="hljs-string">&quot;config.json&quot;</span>)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-comment">// å¯ä»¥è·å–å¹¶æ£€æŸ¥åŸå§‹é”™è¯¯</span>        <span class="hljs-keyword">if</span> originalErr := errors.Unwrap(err); originalErr != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-comment">// å¤„ç†åŸå§‹é”™è¯¯</span>        &#125;        <span class="hljs-keyword">return</span> err    &#125;    <span class="hljs-comment">// å¤„ç†é…ç½®æ•°æ®</span>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="2-ä½¿ç”¨errors-Isæ£€æŸ¥é”™è¯¯ç±»å‹"><a class="header-anchor" href="#2-ä½¿ç”¨errors-Isæ£€æŸ¥é”™è¯¯ç±»å‹"></a>2. ä½¿ç”¨errors.Isæ£€æŸ¥é”™è¯¯ç±»å‹</h4><p><code>errors.Is</code>å‡½æ•°å¯ä»¥æ£€æŸ¥é”™è¯¯é“¾ä¸­æ˜¯å¦åŒ…å«ç‰¹å®šçš„é”™è¯¯ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processFile</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;    data, err := os.ReadFile(path)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">if</span> errors.Is(err, os.ErrNotExist) &#123;            <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;æ–‡ä»¶ %s ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º&quot;</span>, path)        &#125;        <span class="hljs-keyword">if</span> errors.Is(err, os.ErrPermission) &#123;            <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;æ²¡æœ‰æƒé™è¯»å–æ–‡ä»¶ %sï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®&quot;</span>, path)        &#125;        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;è¯»å–æ–‡ä»¶å¤±è´¥: %w&quot;</span>, err)    &#125;    <span class="hljs-comment">// å¤„ç†æ–‡ä»¶æ•°æ®</span>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="3-ä½¿ç”¨errors-Asè¿›è¡Œé”™è¯¯ç±»å‹è½¬æ¢"><a class="header-anchor" href="#3-ä½¿ç”¨errors-Asè¿›è¡Œé”™è¯¯ç±»å‹è½¬æ¢"></a>3. ä½¿ç”¨errors.Asè¿›è¡Œé”™è¯¯ç±»å‹è½¬æ¢</h4><p><code>errors.As</code>å‡½æ•°å¯ä»¥å°†é”™è¯¯è½¬æ¢ä¸ºç‰¹å®šç±»å‹ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handleDatabaseError</span><span class="hljs-params">(err error)</span></span> &#123;    <span class="hljs-keyword">var</span> sqlErr *mysql.MySQLError    <span class="hljs-keyword">if</span> errors.As(err, &amp;sqlErr) &#123;        <span class="hljs-keyword">switch</span> sqlErr.Number &#123;        <span class="hljs-keyword">case</span> <span class="hljs-number">1062</span>:            fmt.Println(<span class="hljs-string">&quot;æ•°æ®é‡å¤ï¼Œè¯·æ£€æŸ¥è¾“å…¥&quot;</span>)        <span class="hljs-keyword">case</span> <span class="hljs-number">1064</span>:            fmt.Println(<span class="hljs-string">&quot;SQLè¯­æ³•é”™è¯¯&quot;</span>)        <span class="hljs-keyword">default</span>:            fmt.Printf(<span class="hljs-string">&quot;æ•°æ®åº“é”™è¯¯: %v\n&quot;</span>, sqlErr)        &#125;        <span class="hljs-keyword">return</span>    &#125;    fmt.Printf(<span class="hljs-string">&quot;æœªçŸ¥é”™è¯¯: %v\n&quot;</span>, err)&#125;</code></pre><h3 id="ğŸ—ï¸-è‡ªå®šä¹‰é”™è¯¯ç±»å‹"><a class="header-anchor" href="#ğŸ—ï¸-è‡ªå®šä¹‰é”™è¯¯ç±»å‹"></a>ğŸ—ï¸ è‡ªå®šä¹‰é”™è¯¯ç±»å‹</h3><p>è‡ªå®šä¹‰é”™è¯¯ç±»å‹å¯ä»¥æºå¸¦æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä½¿é”™è¯¯å¤„ç†æ›´åŠ çµæ´»å’Œå¼ºå¤§ã€‚</p><h4 id="1-åŸºæœ¬çš„è‡ªå®šä¹‰é”™è¯¯ç±»å‹"><a class="header-anchor" href="#1-åŸºæœ¬çš„è‡ªå®šä¹‰é”™è¯¯ç±»å‹"></a>1. åŸºæœ¬çš„è‡ªå®šä¹‰é”™è¯¯ç±»å‹</h4><pre><code class="hljs go"><span class="hljs-keyword">type</span> ValidationError <span class="hljs-keyword">struct</span> &#123;    Field <span class="hljs-keyword">string</span>    Value <span class="hljs-keyword">interface</span>&#123;&#125;    Reason <span class="hljs-keyword">string</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *ValidationError)</span> <span class="hljs-title">Error</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;å­—æ®µ %s çš„å€¼ %v æ— æ•ˆ: %s&quot;</span>, e.Field, e.Value, e.Reason)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">validateUser</span><span class="hljs-params">(user User)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(user.Name) &lt; <span class="hljs-number">2</span> &#123;        <span class="hljs-keyword">return</span> &amp;ValidationError&#123;            Field: <span class="hljs-string">&quot;name&quot;</span>,            Value: user.Name,            Reason: <span class="hljs-string">&quot;åç§°é•¿åº¦ä¸èƒ½å°‘äº2ä¸ªå­—ç¬¦&quot;</span>,        &#125;    &#125;    <span class="hljs-keyword">if</span> user.Age &lt; <span class="hljs-number">0</span> || user.Age &gt; <span class="hljs-number">150</span> &#123;        <span class="hljs-keyword">return</span> &amp;ValidationError&#123;            Field: <span class="hljs-string">&quot;age&quot;</span>,            Value: user.Age,            Reason: <span class="hljs-string">&quot;å¹´é¾„å¿…é¡»åœ¨0åˆ°150ä¹‹é—´&quot;</span>,        &#125;    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="2-æ”¯æŒé”™è¯¯åŒ…è£…çš„è‡ªå®šä¹‰é”™è¯¯"><a class="header-anchor" href="#2-æ”¯æŒé”™è¯¯åŒ…è£…çš„è‡ªå®šä¹‰é”™è¯¯"></a>2. æ”¯æŒé”™è¯¯åŒ…è£…çš„è‡ªå®šä¹‰é”™è¯¯</h4><pre><code class="hljs go"><span class="hljs-keyword">type</span> QueryError <span class="hljs-keyword">struct</span> &#123;    Query <span class="hljs-keyword">string</span>    Err   error&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *QueryError)</span> <span class="hljs-title">Error</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;æ‰§è¡ŒæŸ¥è¯¢ %q å¤±è´¥: %v&quot;</span>, e.Query, e.Err)&#125;<span class="hljs-comment">// å®ç°Unwrapæ–¹æ³•ä»¥æ”¯æŒerrors.Iså’Œerrors.As</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *QueryError)</span> <span class="hljs-title">Unwrap</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-keyword">return</span> e.Err&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">executeQuery</span><span class="hljs-params">(query <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">([]Result, error)</span></span> &#123;    results, err := db.Query(query)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, &amp;QueryError&#123;            Query: query,            Err:   err,        &#125;    &#125;    <span class="hljs-keyword">return</span> results, <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="3-å®ç°Iså’ŒAsæ–¹æ³•è‡ªå®šä¹‰é”™è¯¯æ¯”è¾ƒè¡Œä¸º"><a class="header-anchor" href="#3-å®ç°Iså’ŒAsæ–¹æ³•è‡ªå®šä¹‰é”™è¯¯æ¯”è¾ƒè¡Œä¸º"></a>3. å®ç°Iså’ŒAsæ–¹æ³•è‡ªå®šä¹‰é”™è¯¯æ¯”è¾ƒè¡Œä¸º</h4><pre><code class="hljs go"><span class="hljs-keyword">type</span> NotFoundError <span class="hljs-keyword">struct</span> &#123;    Type <span class="hljs-keyword">string</span>    ID   <span class="hljs-keyword">string</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *NotFoundError)</span> <span class="hljs-title">Error</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;%s with ID %s not found&quot;</span>, e.Type, e.ID)&#125;<span class="hljs-comment">// è‡ªå®šä¹‰Isæ–¹æ³•ä»¥æ”¯æŒç‰¹å®šçš„é”™è¯¯æ¯”è¾ƒé€»è¾‘</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *NotFoundError)</span> <span class="hljs-title">Is</span><span class="hljs-params">(target error)</span> <span class="hljs-title">bool</span></span> &#123;    t, ok := target.(*NotFoundError)    <span class="hljs-keyword">if</span> !ok &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>    &#125;    <span class="hljs-keyword">return</span> (t.Type == <span class="hljs-string">&quot;&quot;</span> || t.Type == e.Type) &amp;&amp;           (t.ID == <span class="hljs-string">&quot;&quot;</span> || t.ID == e.ID)&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findUser</span><span class="hljs-params">(id <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*User, error)</span></span> &#123;    user, err := db.GetUser(id)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">if</span> db.IsNotFound(err) &#123;            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, &amp;NotFoundError&#123;Type: <span class="hljs-string">&quot;user&quot;</span>, ID: id&#125;        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: %w&quot;</span>, err)    &#125;    <span class="hljs-keyword">return</span> user, <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// é”™è¯¯æ£€æŸ¥</span>err := findUser(<span class="hljs-string">&quot;123&quot;</span>)<span class="hljs-keyword">if</span> errors.Is(err, &amp;NotFoundError&#123;Type: <span class="hljs-string">&quot;user&quot;</span>&#125;) &#123;    <span class="hljs-comment">// å¤„ç†ç”¨æˆ·æœªæ‰¾åˆ°çš„æƒ…å†µ</span>&#125;</code></pre><h3 id="ğŸ”„-é”™è¯¯å¤„ç†æ¨¡å¼"><a class="header-anchor" href="#ğŸ”„-é”™è¯¯å¤„ç†æ¨¡å¼"></a>ğŸ”„ é”™è¯¯å¤„ç†æ¨¡å¼</h3><h4 id="1-å“¨å…µé”™è¯¯ï¼ˆSentinel-Errorsï¼‰"><a class="header-anchor" href="#1-å“¨å…µé”™è¯¯ï¼ˆSentinel-Errorsï¼‰"></a>1. å“¨å…µé”™è¯¯ï¼ˆSentinel Errorsï¼‰</h4><p>å®šä¹‰ç‰¹å®šçš„é”™è¯¯å€¼ä½œä¸ºå…¬å…±APIçš„ä¸€éƒ¨åˆ†ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> mypackage<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;errors&quot;</span><span class="hljs-comment">// å¯¼å‡ºçš„é”™è¯¯å€¼</span><span class="hljs-keyword">var</span> (    ErrNotFound = errors.New(<span class="hljs-string">&quot;èµ„æºæœªæ‰¾åˆ°&quot;</span>)    ErrPermission = errors.New(<span class="hljs-string">&quot;æƒé™ä¸è¶³&quot;</span>)    ErrTimeout = errors.New(<span class="hljs-string">&quot;æ“ä½œè¶…æ—¶&quot;</span>))<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FindResource</span><span class="hljs-params">(id <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Resource, error)</span></span> &#123;    <span class="hljs-comment">// ...</span>    <span class="hljs-keyword">if</span> resourceNotExist &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, ErrNotFound    &#125;    <span class="hljs-comment">// ...</span>&#125;<span class="hljs-comment">// è°ƒç”¨æ–¹</span>res, err := mypackage.FindResource(<span class="hljs-string">&quot;123&quot;</span>)<span class="hljs-keyword">if</span> err == mypackage.ErrNotFound &#123;    <span class="hljs-comment">// å¤„ç†èµ„æºæœªæ‰¾åˆ°çš„æƒ…å†µ</span>&#125;</code></pre><p>å“¨å…µé”™è¯¯çš„ä¼˜ç‚¹æ˜¯ç®€å•æ˜äº†ï¼Œä½†ç¼ºç‚¹æ˜¯ä¸èƒ½æºå¸¦é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¸”ä¼šåˆ›å»ºåŒ…ä¹‹é—´çš„ä¾èµ–ã€‚</p><h4 id="2-é”™è¯¯ç±»å‹ï¼ˆError-Typesï¼‰"><a class="header-anchor" href="#2-é”™è¯¯ç±»å‹ï¼ˆError-Typesï¼‰"></a>2. é”™è¯¯ç±»å‹ï¼ˆError Typesï¼‰</h4><p>å®šä¹‰å®ç°äº†Erroræ¥å£çš„è‡ªå®šä¹‰ç±»å‹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> NotFoundError <span class="hljs-keyword">struct</span> &#123;    Resource <span class="hljs-keyword">string</span>    ID       <span class="hljs-keyword">string</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *NotFoundError)</span> <span class="hljs-title">Error</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;%s with ID %s not found&quot;</span>, e.Resource, e.ID)&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FindResource</span><span class="hljs-params">(id <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Resource, error)</span></span> &#123;    <span class="hljs-comment">// ...</span>    <span class="hljs-keyword">if</span> resourceNotExist &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, &amp;NotFoundError&#123;Resource: <span class="hljs-string">&quot;user&quot;</span>, ID: id&#125;    &#125;    <span class="hljs-comment">// ...</span>&#125;<span class="hljs-comment">// è°ƒç”¨æ–¹</span>res, err := FindResource(<span class="hljs-string">&quot;123&quot;</span>)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;    <span class="hljs-keyword">if</span> nfErr, ok := err.(*NotFoundError); ok &#123;        fmt.Printf(<span class="hljs-string">&quot;æœªæ‰¾åˆ°%s: %s\n&quot;</span>, nfErr.Resource, nfErr.ID)        <span class="hljs-keyword">return</span>    &#125;    <span class="hljs-comment">// å¤„ç†å…¶ä»–é”™è¯¯</span>&#125;</code></pre><p>åœ¨Go 1.13åï¼Œå¯ä»¥ä½¿ç”¨<code>errors.As</code>ç®€åŒ–ç±»å‹æ–­è¨€ï¼š</p><pre><code class="hljs go">res, err := FindResource(<span class="hljs-string">&quot;123&quot;</span>)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;    <span class="hljs-keyword">var</span> nfErr *NotFoundError    <span class="hljs-keyword">if</span> errors.As(err, &amp;nfErr) &#123;        fmt.Printf(<span class="hljs-string">&quot;æœªæ‰¾åˆ°%s: %s\n&quot;</span>, nfErr.Resource, nfErr.ID)        <span class="hljs-keyword">return</span>    &#125;    <span class="hljs-comment">// å¤„ç†å…¶ä»–é”™è¯¯</span>&#125;</code></pre><h4 id="3-ä¸é€æ˜é”™è¯¯å¤„ç†ï¼ˆOpaque-Errorsï¼‰"><a class="header-anchor" href="#3-ä¸é€æ˜é”™è¯¯å¤„ç†ï¼ˆOpaque-Errorsï¼‰"></a>3. ä¸é€æ˜é”™è¯¯å¤„ç†ï¼ˆOpaque Errorsï¼‰</h4><p>åªæš´éœ²è¡Œä¸ºè€Œä¸æš´éœ²å†…éƒ¨ç»“æ„ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">package</span> data<span class="hljs-comment">// IsNotFoundæŠ¥å‘Šé”™è¯¯æ˜¯å¦è¡¨ç¤ºèµ„æºæœªæ‰¾åˆ°</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">IsNotFound</span><span class="hljs-params">(err error)</span> <span class="hljs-title">bool</span></span> &#123;    <span class="hljs-comment">// å†…éƒ¨å®ç°å¯èƒ½ä½¿ç”¨ç±»å‹æ–­è¨€ã€errors.Isç­‰</span>    <span class="hljs-comment">// ä½†è°ƒç”¨æ–¹ä¸éœ€è¦çŸ¥é“è¿™äº›ç»†èŠ‚</span>    <span class="hljs-keyword">return</span> checkIfNotFound(err)&#125;<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUser</span><span class="hljs-params">(id <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*User, error)</span></span> &#123;    <span class="hljs-comment">// ...</span>&#125;<span class="hljs-comment">// è°ƒç”¨æ–¹</span>user, err := data.GetUser(<span class="hljs-string">&quot;123&quot;</span>)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;    <span class="hljs-keyword">if</span> data.IsNotFound(err) &#123;        <span class="hljs-comment">// å¤„ç†æœªæ‰¾åˆ°çš„æƒ…å†µ</span>    &#125; <span class="hljs-keyword">else</span> &#123;        <span class="hljs-comment">// å¤„ç†å…¶ä»–é”™è¯¯</span>    &#125;&#125;</code></pre><p>è¿™ç§æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯å®ç°ç»†èŠ‚å¯ä»¥éšæ—¶æ”¹å˜è€Œä¸å½±å“è°ƒç”¨æ–¹ï¼Œæä¾›äº†æ›´å¥½çš„APIç¨³å®šæ€§ã€‚</p><h3 id="ğŸš€-é«˜çº§é”™è¯¯å¤„ç†æŠ€å·§"><a class="header-anchor" href="#ğŸš€-é«˜çº§é”™è¯¯å¤„ç†æŠ€å·§"></a>ğŸš€ é«˜çº§é”™è¯¯å¤„ç†æŠ€å·§</h3><h4 id="1-é”™è¯¯ç»„åˆï¼ˆError-Groupsï¼‰"><a class="header-anchor" href="#1-é”™è¯¯ç»„åˆï¼ˆError-Groupsï¼‰"></a>1. é”™è¯¯ç»„åˆï¼ˆError Groupsï¼‰</h4><p>å½“éœ€è¦å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæ“ä½œå¹¶æ”¶é›†æ‰€æœ‰é”™è¯¯æ—¶ï¼Œå¯ä»¥ä½¿ç”¨<code>golang.org/x/sync/errgroup</code>åŒ…ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> (    <span class="hljs-string">&quot;context&quot;</span>    <span class="hljs-string">&quot;golang.org/x/sync/errgroup&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fetchAllData</span><span class="hljs-params">(ctx context.Context, ids []<span class="hljs-keyword">string</span>)</span> <span class="hljs-params">([]Data, error)</span></span> &#123;    g, ctx := errgroup.WithContext(ctx)    results := <span class="hljs-built_in">make</span>([]Data, <span class="hljs-built_in">len</span>(ids))        <span class="hljs-keyword">for</span> i, id := <span class="hljs-keyword">range</span> ids &#123;        i, id := i, id <span class="hljs-comment">// åˆ›å»ºå±€éƒ¨å˜é‡é¿å…é—­åŒ…é—®é¢˜</span>        g.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;            data, err := fetchData(ctx, id)            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;                <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;è·å–ID %s çš„æ•°æ®å¤±è´¥: %w&quot;</span>, id, err)            &#125;            results[i] = data            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>        &#125;)    &#125;        <span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰goroutineå®Œæˆæˆ–æœ‰ä¸€ä¸ªè¿”å›é”™è¯¯</span>    <span class="hljs-keyword">if</span> err := g.Wait(); err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;        <span class="hljs-keyword">return</span> results, <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="2-é”™è¯¯å¤„ç†ä¸­é—´ä»¶"><a class="header-anchor" href="#2-é”™è¯¯å¤„ç†ä¸­é—´ä»¶"></a>2. é”™è¯¯å¤„ç†ä¸­é—´ä»¶</h4><p>åœ¨WebæœåŠ¡æˆ–APIä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶ç»Ÿä¸€å¤„ç†é”™è¯¯ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">errorMiddleware</span><span class="hljs-params">(next http.Handler)</span> <span class="hljs-title">http</span>.<span class="hljs-title">Handler</span></span> &#123;    <span class="hljs-keyword">return</span> http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;        <span class="hljs-comment">// åˆ›å»ºè‡ªå®šä¹‰çš„ResponseWriteræ¥æ•è·é”™è¯¯</span>        rw := &amp;responseWriter&#123;ResponseWriter: w&#125;                <span class="hljs-comment">// è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨</span>        next.ServeHTTP(rw, r)                <span class="hljs-comment">// å¤„ç†æ•è·çš„é”™è¯¯</span>        <span class="hljs-keyword">if</span> rw.err != <span class="hljs-literal">nil</span> &#123;            handleError(w, rw.err)        &#125;    &#125;)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handleError</span><span class="hljs-params">(w http.ResponseWriter, err error)</span></span> &#123;    <span class="hljs-keyword">var</span> status <span class="hljs-keyword">int</span>    <span class="hljs-keyword">var</span> message <span class="hljs-keyword">string</span>        <span class="hljs-comment">// æ ¹æ®é”™è¯¯ç±»å‹ç¡®å®šHTTPçŠ¶æ€ç å’Œé”™è¯¯æ¶ˆæ¯</span>    <span class="hljs-keyword">var</span> nfErr *NotFoundError    <span class="hljs-keyword">if</span> errors.As(err, &amp;nfErr) &#123;        status = http.StatusNotFound        message = nfErr.Error()    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> errors.Is(err, ErrPermission) &#123;        status = http.StatusForbidden        message = <span class="hljs-string">&quot;æƒé™ä¸è¶³&quot;</span>    &#125; <span class="hljs-keyword">else</span> &#123;        status = http.StatusInternalServerError        message = <span class="hljs-string">&quot;æœåŠ¡å™¨å†…éƒ¨é”™è¯¯&quot;</span>        <span class="hljs-comment">// è®°å½•æœªé¢„æœŸçš„é”™è¯¯</span>        log.Printf(<span class="hljs-string">&quot;æœªå¤„ç†çš„é”™è¯¯: %v&quot;</span>, err)    &#125;        <span class="hljs-comment">// è¿”å›JSONé”™è¯¯å“åº”</span>    w.Header().Set(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>)    w.WriteHeader(status)    json.NewEncoder(w).Encode(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;error&quot;</span>: message&#125;)&#125;</code></pre><h4 id="3-ç»“æ„åŒ–é”™è¯¯æ—¥å¿—"><a class="header-anchor" href="#3-ç»“æ„åŒ–é”™è¯¯æ—¥å¿—"></a>3. ç»“æ„åŒ–é”™è¯¯æ—¥å¿—</h4><p>è®°å½•ç»“æ„åŒ–çš„é”™è¯¯æ—¥å¿—å¯ä»¥å¸®åŠ©æ›´å¥½åœ°ç†è§£å’Œåˆ†æé”™è¯¯ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">logError</span><span class="hljs-params">(err error)</span></span> &#123;    <span class="hljs-comment">// åŸºæœ¬é”™è¯¯ä¿¡æ¯</span>    fields := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;        <span class="hljs-string">&quot;error&quot;</span>: err.Error(),        <span class="hljs-string">&quot;stack&quot;</span>: getStackTrace(), <span class="hljs-comment">// è·å–å †æ ˆä¿¡æ¯çš„å‡½æ•°</span>        <span class="hljs-string">&quot;time&quot;</span>:  time.Now(),    &#125;        <span class="hljs-comment">// æå–é¢å¤–çš„é”™è¯¯ä¸Šä¸‹æ–‡</span>    <span class="hljs-keyword">var</span> validationErr *ValidationError    <span class="hljs-keyword">if</span> errors.As(err, &amp;validationErr) &#123;        fields[<span class="hljs-string">&quot;field&quot;</span>] = validationErr.Field        fields[<span class="hljs-string">&quot;value&quot;</span>] = validationErr.Value        fields[<span class="hljs-string">&quot;reason&quot;</span>] = validationErr.Reason    &#125;        <span class="hljs-comment">// è®°å½•ç»“æ„åŒ–æ—¥å¿—</span>    logger.WithFields(fields).Error(<span class="hljs-string">&quot;å‘ç”Ÿé”™è¯¯&quot;</span>)&#125;</code></pre><h4 id="4-ä½¿ç”¨pkg-errorsåŒ…å¢å¼ºé”™è¯¯å¤„ç†"><a class="header-anchor" href="#4-ä½¿ç”¨pkg-errorsåŒ…å¢å¼ºé”™è¯¯å¤„ç†"></a>4. ä½¿ç”¨pkg/errorsåŒ…å¢å¼ºé”™è¯¯å¤„ç†</h4><p><a href="https://github.com/pkg/errors">github.com/pkg/errors</a>åŒ…æä¾›äº†æ›´ä¸°å¯Œçš„é”™è¯¯å¤„ç†åŠŸèƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨Go 1.13ä¹‹å‰ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/pkg/errors&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readConfig</span><span class="hljs-params">()</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, error)</span></span> &#123;    data, err := ioutil.ReadFile(<span class="hljs-string">&quot;config.json&quot;</span>)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-comment">// åŒ…è£…é”™è¯¯å¹¶æ·»åŠ å †æ ˆä¿¡æ¯</span>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.Wrap(err, <span class="hljs-string">&quot;è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥&quot;</span>)    &#125;    <span class="hljs-keyword">return</span> data, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">parseConfig</span><span class="hljs-params">()</span> <span class="hljs-params">(*Config, error)</span></span> &#123;    data, err := readConfig()    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-comment">// æ·»åŠ æ›´å¤šä¸Šä¸‹æ–‡ä½†ä¸æ·»åŠ æ–°çš„å †æ ˆ</span>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.WithMessage(err, <span class="hljs-string">&quot;è§£æé…ç½®å¤±è´¥&quot;</span>)    &#125;        <span class="hljs-keyword">var</span> config Config    <span class="hljs-keyword">if</span> err := json.Unmarshal(data, &amp;config); err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.Wrap(err, <span class="hljs-string">&quot;JSONè§£æå¤±è´¥&quot;</span>)    &#125;    <span class="hljs-keyword">return</span> &amp;config, <span class="hljs-literal">nil</span>&#125;<span class="hljs-comment">// æ‰“å°è¯¦ç»†é”™è¯¯ä¿¡æ¯</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printError</span><span class="hljs-params">(err error)</span></span> &#123;    fmt.Printf(<span class="hljs-string">&quot;é”™è¯¯: %v\n&quot;</span>, err)    fmt.Printf(<span class="hljs-string">&quot;å †æ ˆè·Ÿè¸ª:\n%+v\n&quot;</span>, err)&#125;</code></pre><p>æ³¨æ„ï¼šåœ¨Go 1.13åŠä»¥åï¼Œæ ‡å‡†åº“çš„errorsåŒ…å·²ç»æä¾›äº†ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†pkg/errorsä»ç„¶æä¾›äº†ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œå¦‚å †æ ˆè·Ÿè¸ªã€‚</p><h3 id="ğŸ“Š-é”™è¯¯å¤„ç†æœ€ä½³å®è·µæ€»ç»“"><a class="header-anchor" href="#ğŸ“Š-é”™è¯¯å¤„ç†æœ€ä½³å®è·µæ€»ç»“"></a>ğŸ“Š é”™è¯¯å¤„ç†æœ€ä½³å®è·µæ€»ç»“</h3><ol><li><strong>æ·»åŠ ä¸Šä¸‹æ–‡</strong>ï¼šæ€»æ˜¯åœ¨é”™è¯¯ä¼ é€’è¿‡ç¨‹ä¸­æ·»åŠ æœ‰ç”¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯<pre><code class="hljs go"><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123; <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;å¤„ç†ç”¨æˆ· %s çš„è¯·æ±‚æ—¶å¤±è´¥: %w&quot;</span>, userID, err)</li></ol><p>&#125;</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="2"><li><p><strong>å†³å®šé”™è¯¯å¤„ç†çº§åˆ«</strong>ï¼šåœ¨é€‚å½“çš„æŠ½è±¡çº§åˆ«å¤„ç†é”™è¯¯</p><ul><li>ä½çº§åº“åº”è¯¥è¿”å›å…·ä½“çš„é”™è¯¯ç±»å‹</li><li>åº”ç”¨å±‚å¯ä»¥å†³å®šå¦‚ä½•å¤„ç†å’Œå‘ˆç°é”™è¯¯</li></ul></li><li><p><strong>é¿å…è¿‡åº¦åŒ…è£…</strong>ï¼šä¸è¦åœ¨æ¯ä¸€å±‚éƒ½æ·»åŠ å†—ä½™çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span></li></ol><p><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">â€œreadConfig failed: %wâ€</span>, fmt.Errorf(<span class="hljs-string">â€œloadFile failed: %wâ€</span>, err))<br>&#125;</p><p><span class="hljs-comment">// å¥½çš„åšæ³•</span><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">â€œè¯»å–é…ç½®æ–‡ä»¶ %s å¤±è´¥: %wâ€</span>, filename, err)<br>&#125;</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="4"><li><strong>ä½¿ç”¨é”™è¯¯ç±»å‹è€Œéå­—ç¬¦ä¸²æ¯”è¾ƒ</strong>ï¼šé¿å…é€šè¿‡å­—ç¬¦ä¸²åŒ¹é…æ¥æ£€æŸ¥é”™è¯¯<pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span></li></ol><p><span class="hljs-keyword">if</span> strings.Contains(err.Error(), <span class="hljs-string">â€œnot foundâ€</span>) &#123;<br><span class="hljs-comment">// å¤„ç†æœªæ‰¾åˆ°çš„æƒ…å†µ</span><br>&#125;</p><p><span class="hljs-comment">// å¥½çš„åšæ³•</span><br><span class="hljs-keyword">if</span> <a href="http://errors.Is">errors.Is</a>(err, os.ErrNotExist) || data.IsNotFound(err) &#123;<br><span class="hljs-comment">// å¤„ç†æœªæ‰¾åˆ°çš„æƒ…å†µ</span><br>&#125;</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="5"><li><p><strong>åŒºåˆ†é¢„æœŸé”™è¯¯å’Œå¼‚å¸¸</strong>ï¼š</p><ul><li>é¢„æœŸé”™è¯¯æ˜¯ç¨‹åºæ­£å¸¸æµç¨‹çš„ä¸€éƒ¨åˆ†ï¼ˆå¦‚æ–‡ä»¶ä¸å­˜åœ¨ï¼‰</li><li>å¼‚å¸¸æ˜¯æ„å¤–æƒ…å†µï¼ˆå¦‚ç£ç›˜æ•…éšœï¼‰</li><li>å¯¹é¢„æœŸé”™è¯¯è¿›è¡Œé€‚å½“å¤„ç†ï¼Œå¯¹å¼‚å¸¸å¯èƒ½éœ€è¦ç»ˆæ­¢ç¨‹åºæˆ–é‡è¯•</li></ul></li><li><p><strong>ä¿æŒé”™è¯¯å¤„ç†çš„ä¸€è‡´æ€§</strong>ï¼šåœ¨æ•´ä¸ªä»£ç åº“ä¸­ä½¿ç”¨ä¸€è‡´çš„é”™è¯¯å¤„ç†æ¨¡å¼</p></li><li><p><strong>è®°å½•è¶³å¤Ÿçš„é”™è¯¯ä¿¡æ¯</strong>ï¼šç¡®ä¿æ—¥å¿—ä¸­åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯ä»¥ä¾¿è°ƒè¯•</p><pre><code class="hljs go"><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123; log.WithFields(log.Fields&#123;     <span class="hljs-string">&quot;user_id&quot;</span>: userID,     <span class="hljs-string">&quot;request_id&quot;</span>: requestID,     <span class="hljs-string">&quot;error&quot;</span>: err, &#125;).Error(<span class="hljs-string">&quot;å¤„ç†ç”¨æˆ·è¯·æ±‚å¤±è´¥&quot;</span>) <span class="hljs-keyword">return</span> err</li></ol><p>&#125;</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="8"><li><strong>ä¸è¦å¿½ç•¥é”™è¯¯</strong>ï¼šé™¤éä½ æœ‰å……åˆ†çš„ç†ç”±<pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span></li></ol><p>file.Close() <span class="hljs-comment">// å¿½ç•¥å¯èƒ½çš„é”™è¯¯</span></p><p><span class="hljs-comment">// å¥½çš„åšæ³•</span><br><span class="hljs-keyword">if</span> err := file.Close(); err != <span class="hljs-literal">nil</span> &#123;<br>log.Printf(<span class="hljs-string">â€œå…³é—­æ–‡ä»¶å¤±è´¥: %vâ€</span>, err)<br>&#125;</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="9"><li><strong>ä½¿ç”¨deferå¤„ç†èµ„æºæ¸…ç†</strong>ï¼šç¡®ä¿å³ä½¿å‘ç”Ÿé”™è¯¯ä¹Ÿèƒ½é‡Šæ”¾èµ„æº<pre><code class="hljs go">file, err := os.Open(<span class="hljs-string">&quot;file.txt&quot;</span>)</li></ol><p><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> err := file.Close(); err != <span class="hljs-literal">nil</span> &#123;<br>log.Printf(<span class="hljs-string">â€œå…³é—­æ–‡ä»¶å¤±è´¥: %vâ€</span>, err)<br>&#125;<br>&#125;()</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="10"><li><strong>è€ƒè™‘ä½¿ç”¨å‡½æ•°é€‰é¡¹å¤„ç†å¤šä¸ªé”™è¯¯æƒ…å†µ</strong>ï¼š<pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">validateUser</span><span class="hljs-params">(user User)</span> <span class="hljs-title">error</span></span> &#123;<span class="hljs-keyword">var</span> errs []error<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(user.Name) &lt; <span class="hljs-number">2</span> &#123;    errs = <span class="hljs-built_in">append</span>(errs, fmt.Errorf(<span class="hljs-string">&quot;åç§°é•¿åº¦ä¸èƒ½å°‘äº2ä¸ªå­—ç¬¦&quot;</span>))&#125;<span class="hljs-keyword">if</span> user.Age &lt; <span class="hljs-number">0</span> || user.Age &gt; <span class="hljs-number">150</span> &#123;    errs = <span class="hljs-built_in">append</span>(errs, fmt.Errorf(<span class="hljs-string">&quot;å¹´é¾„å¿…é¡»åœ¨0åˆ°150ä¹‹é—´&quot;</span>))&#125;<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(user.Email) == <span class="hljs-number">0</span> &#123;    errs = <span class="hljs-built_in">append</span>(errs, fmt.Errorf(<span class="hljs-string">&quot;é‚®ç®±ä¸èƒ½ä¸ºç©º&quot;</span>))&#125;<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(errs) &gt; <span class="hljs-number">0</span> &#123;    <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;ç”¨æˆ·éªŒè¯å¤±è´¥: %v&quot;</span>, errs)&#125;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span></li></ol><p>&#125;</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><h3 id="ğŸ”®-Goé”™è¯¯å¤„ç†çš„æœªæ¥"><a class="header-anchor" href="#ğŸ”®-Goé”™è¯¯å¤„ç†çš„æœªæ¥"></a>ğŸ”® Goé”™è¯¯å¤„ç†çš„æœªæ¥</h3><p>Goå›¢é˜Ÿä¸€ç›´åœ¨æ¢ç´¢æ”¹è¿›é”™è¯¯å¤„ç†çš„æ–¹æ³•ã€‚è™½ç„¶Go 2å¯èƒ½ä¼šå¼•å…¥ä¸€äº›è¯­æ³•ç³–æ¥ç®€åŒ–é”™è¯¯å¤„ç†ï¼Œä½†æ ¸å¿ƒç†å¿µå¯èƒ½ä¿æŒä¸å˜ï¼šé”™è¯¯æ˜¯å€¼ï¼Œåº”è¯¥è¢«æ˜¾å¼å¤„ç†ã€‚</p><p>ç›®å‰çš„ä¸€äº›å®éªŒæ€§ææ¡ˆåŒ…æ‹¬ï¼š</p><ol><li><strong>tryææ¡ˆ</strong>ï¼šç®€åŒ–å¸¸è§çš„é”™è¯¯æ£€æŸ¥æ¨¡å¼<pre><code class="hljs go"><span class="hljs-comment">// å½“å‰å†™æ³•</span></li></ol><p>value, err := doSomething()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;</p><p><span class="hljs-comment">// tryææ¡ˆå†™æ³•</span><br>value := try(doSomething())</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><ol start="2"><li><strong>æ”¹è¿›çš„é”™è¯¯æ£€æŸ¥</strong>ï¼šæ›´ç®€æ´çš„é”™è¯¯å¤„ç†è¯­æ³•<pre><code class="hljs go"><span class="hljs-comment">// å¯èƒ½çš„æœªæ¥è¯­æ³•</span></li></ol><p><span class="hljs-keyword">if</span> value, err := doSomething(); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">â€œfailed: %wâ€</span>, err)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// ä½¿ç”¨value</span><br>&#125;</code></pre>:hexoPostRenderEscapeâ€“&gt;</p><p>æ— è®ºè¯­æ³•å¦‚ä½•å˜åŒ–ï¼Œç†è§£é”™è¯¯å¤„ç†çš„æ ¸å¿ƒåŸåˆ™å’Œæœ€ä½³å®è·µå°†å§‹ç»ˆæ˜¯ç¼–å†™é«˜è´¨é‡Goä»£ç çš„å…³é”®ã€‚</p><h3 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h3><p>Goè¯­è¨€çš„é”™è¯¯å¤„ç†è™½ç„¶çœ‹èµ·æ¥æœ‰äº›å†—é•¿ï¼Œä½†å®ƒçš„æ˜¾å¼æ€§å’Œçµæ´»æ€§ä½¿å¾—é”™è¯¯å¤„ç†å˜å¾—æ¸…æ™°å’Œå¯æ§ã€‚é€šè¿‡åˆç†ä½¿ç”¨é”™è¯¯åŒ…è£…ã€è‡ªå®šä¹‰é”™è¯¯ç±»å‹å’Œç°ä»£åŒ–çš„é”™è¯¯æ£€æŸ¥æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºå‡ºæ—¢å¥å£®åˆæ˜“äºç»´æŠ¤çš„ç³»ç»Ÿã€‚</p><p>å…³é”®è¦ç‚¹ï¼š</p><ul><li>ä½¿ç”¨<code>fmt.Errorf</code>å’Œ<code>%w</code>åŒ…è£…é”™è¯¯å¹¶æ·»åŠ ä¸Šä¸‹æ–‡</li><li>ä½¿ç”¨<code>errors.Is</code>å’Œ<code>errors.As</code>è¿›è¡Œé”™è¯¯æ£€æŸ¥å’Œç±»å‹è½¬æ¢</li><li>è®¾è®¡è‰¯å¥½çš„è‡ªå®šä¹‰é”™è¯¯ç±»å‹ä»¥æºå¸¦æ›´å¤šä¿¡æ¯</li><li>é€‰æ‹©é€‚åˆé¡¹ç›®çš„é”™è¯¯å¤„ç†æ¨¡å¼ï¼ˆå“¨å…µé”™è¯¯ã€é”™è¯¯ç±»å‹æˆ–ä¸é€æ˜é”™è¯¯ï¼‰</li><li>åœ¨é€‚å½“çš„æŠ½è±¡çº§åˆ«å¤„ç†é”™è¯¯</li><li>ä¿æŒé”™è¯¯å¤„ç†çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§</li></ul><p>é€šè¿‡éµå¾ªè¿™äº›ç°ä»£åŒ–çš„é”™è¯¯å¤„ç†æœ€ä½³å®è·µï¼Œä½ å¯ä»¥ç¼–å†™å‡ºæ›´åŠ å¥å£®ã€å¯ç»´æŠ¤ä¸”ç”¨æˆ·å‹å¥½çš„Goç¨‹åºã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>é”™è¯¯å¤„ç†</tag>
      
      <tag>æœ€ä½³å®è·µ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang contextåŒ…è¯¦è§£ä¸å®è·µ</title>
    <link href="/2024/01/10/golang-context%E5%8C%85%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%AE%9E%E8%B7%B5/"/>
    <url>/2024/01/10/golang-context%E5%8C%85%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="ğŸ”„-golang-contextåŒ…è¯¦è§£ä¸å®è·µ"><a class="header-anchor" href="#ğŸ”„-golang-contextåŒ…è¯¦è§£ä¸å®è·µ"></a>ğŸ”„ golang contextåŒ…è¯¦è§£ä¸å®è·µ</h2><p>åœ¨Goè¯­è¨€çš„å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œ<code>context</code>åŒ…æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å·¥å…·ï¼Œå®ƒæä¾›äº†ä¸€ç§ä¼˜é›…çš„æ–¹å¼æ¥åœ¨goroutineä¹‹é—´ä¼ é€’æˆªæ­¢æ—¥æœŸã€å–æ¶ˆä¿¡å·å’Œå…¶ä»–è¯·æ±‚èŒƒå›´çš„å€¼ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨<code>context</code>åŒ…çš„è®¾è®¡ç†å¿µã€æ ¸å¿ƒAPIä»¥åŠå®é™…åº”ç”¨åœºæ™¯ã€‚</p><h3 id="ğŸ“š-ContextåŒ…çš„è®¾è®¡ç†å¿µ"><a class="header-anchor" href="#ğŸ“š-ContextåŒ…çš„è®¾è®¡ç†å¿µ"></a>ğŸ“š ContextåŒ…çš„è®¾è®¡ç†å¿µ</h3><p><code>context</code>åŒ…çš„æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯æä¾›ä¸€ç§åœ¨APIè¾¹ç•Œå’Œè¿›ç¨‹ä¹‹é—´ä¼ é€’æˆªæ­¢æ—¶é—´ã€å–æ¶ˆä¿¡å·ä»¥åŠè¯·æ±‚èŒƒå›´å€¼çš„æ ‡å‡†æ–¹å¼ã€‚å®ƒä¸»è¦è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š</p><ol><li><strong>å–æ¶ˆä¼ æ’­</strong>ï¼šå½“ä¸€ä¸ªè¯·æ±‚è¢«å–æ¶ˆæˆ–è¶…æ—¶æ—¶ï¼Œæ‰€æœ‰ä¸ºè¯¥è¯·æ±‚å·¥ä½œçš„goroutineéƒ½åº”è¯¥å¿«é€Ÿé€€å‡ºï¼Œä»¥é‡Šæ”¾ç³»ç»Ÿèµ„æºã€‚</li><li><strong>å€¼ä¼ é€’</strong>ï¼šè¯·æ±‚èŒƒå›´çš„å€¼éœ€è¦åœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­ä¼ é€’ï¼Œè€Œä¸å¿…æ˜¾å¼åœ°å°†è¿™äº›å€¼ä½œä¸ºå‡½æ•°å‚æ•°ã€‚</li><li><strong>æˆªæ­¢æ—¶é—´</strong>ï¼šæ“ä½œéœ€è¦åœ¨ç‰¹å®šæ—¶é—´å†…å®Œæˆï¼Œè¶…è¿‡è¯¥æ—¶é—´åº”è¢«å–æ¶ˆã€‚</li></ol><h3 id="ğŸ§©-Contextæ¥å£"><a class="header-anchor" href="#ğŸ§©-Contextæ¥å£"></a>ğŸ§© Contextæ¥å£</h3><p><code>Context</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Context <span class="hljs-keyword">interface</span> &#123;    Deadline() (deadline time.Time, ok <span class="hljs-keyword">bool</span>)    Done() &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;    Err() error    Value(key <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-keyword">interface</span>&#123;&#125;&#125;</code></pre><p>è¿™å››ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ï¼š</p><ul><li><code>Deadline()</code>ï¼šè¿”å›å½“å‰Contextçš„æˆªæ­¢æ—¶é—´ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚</li><li><code>Done()</code>ï¼šè¿”å›ä¸€ä¸ªé€šé“ï¼Œå½“Contextè¢«å–æ¶ˆæ—¶ï¼Œè¿™ä¸ªé€šé“ä¼šè¢«å…³é—­ã€‚</li><li><code>Err()</code>ï¼šå¦‚æœContextå·²è¢«å–æ¶ˆï¼Œè¿”å›å–æ¶ˆçš„åŸå› ï¼›å¦åˆ™è¿”å›nilã€‚</li><li><code>Value(key interface&#123;&#125;)</code>ï¼šè¿”å›ä¸keyå…³è”çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›nilã€‚</li></ul><h3 id="ğŸŒ²-Contextæ ‘"><a class="header-anchor" href="#ğŸŒ²-Contextæ ‘"></a>ğŸŒ² Contextæ ‘</h3><p>Contextå½¢æˆä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼Œå¯ä»¥ä»ä¸€ä¸ªçˆ¶Contextæ´¾ç”Ÿå‡ºå¤šä¸ªå­Contextã€‚å½“çˆ¶Contextè¢«å–æ¶ˆæ—¶ï¼Œæ‰€æœ‰æ´¾ç”Ÿè‡ªå®ƒçš„å­Contextä¹Ÿä¼šè¢«å–æ¶ˆã€‚</p><pre><code class="hljs reasonml">       background           <span class="hljs-pattern-match">|</span><span class="hljs-pattern-match">       <span class="hljs-keyword">with</span><span class="hljs-constructor">Cancel</span></span><span class="hljs-pattern-match">      <span class="hljs-operator">/</span>          \</span><span class="hljs-pattern-match"><span class="hljs-keyword">with</span><span class="hljs-constructor">Deadline</span>    <span class="hljs-keyword">with</span><span class="hljs-constructor">Value</span></span><span class="hljs-pattern-match">     |              |</span><span class="hljs-pattern-match"> <span class="hljs-keyword">with</span><span class="hljs-constructor">Value</span>      <span class="hljs-keyword">with</span><span class="hljs-constructor">Timeout</span></span></code></pre><h3 id="ğŸ› ï¸-Contextåˆ›å»ºå‡½æ•°"><a class="header-anchor" href="#ğŸ› ï¸-Contextåˆ›å»ºå‡½æ•°"></a>ğŸ› ï¸ Contextåˆ›å»ºå‡½æ•°</h3><p><code>context</code>åŒ…æä¾›äº†å‡ ä¸ªåˆ›å»ºContextçš„å‡½æ•°ï¼š</p><h4 id="1-Backgroundå’ŒTODO"><a class="header-anchor" href="#1-Backgroundå’ŒTODO"></a>1. Backgroundå’ŒTODO</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Background</span><span class="hljs-params">()</span> <span class="hljs-title">Context</span></span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TODO</span><span class="hljs-params">()</span> <span class="hljs-title">Context</span></span></code></pre><p>è¿™ä¸¤ä¸ªå‡½æ•°è¿”å›énilçš„ç©ºContextï¼š</p><ul><li><code>Background()</code>ï¼šä¸»è¦ç”¨äºmainå‡½æ•°ã€åˆå§‹åŒ–å’Œæµ‹è¯•ï¼Œä½œä¸ºæ‰€æœ‰Contextæ ‘çš„æ ¹ã€‚</li><li><code>TODO()</code>ï¼šå½“ä¸ç¡®å®šåº”è¯¥ä½¿ç”¨å“ªä¸ªContextæˆ–è€…å½“å‰å‡½æ•°è¿˜æ²¡æœ‰å¯ç”¨çš„Contextæ—¶ä½¿ç”¨ã€‚</li></ul><h4 id="2-WithCancel"><a class="header-anchor" href="#2-WithCancel"></a>2. WithCancel</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithCancel</span><span class="hljs-params">(parent Context)</span> <span class="hljs-params">(ctx Context, cancel CancelFunc)</span></span></code></pre><p><code>WithCancel</code>è¿”å›ä¸€ä¸ªæ–°çš„Contextå’Œä¸€ä¸ªå–æ¶ˆå‡½æ•°ã€‚å½“è°ƒç”¨å–æ¶ˆå‡½æ•°æˆ–çˆ¶Contextè¢«å–æ¶ˆæ—¶ï¼Œè¿™ä¸ªæ–°Contextçš„Doneé€šé“ä¼šè¢«å…³é—­ã€‚</p><pre><code class="hljs go">ctx, cancel := context.WithCancel(context.Background())<span class="hljs-keyword">defer</span> cancel() <span class="hljs-comment">// ç¡®ä¿æ‰€æœ‰è·¯å¾„éƒ½ä¼šè°ƒç”¨cancel</span><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åœ¨æ–°çš„goroutineä¸­ä½¿ç”¨ctx</span>    <span class="hljs-keyword">for</span> &#123;        <span class="hljs-keyword">select</span> &#123;        <span class="hljs-keyword">case</span> &lt;-ctx.Done():            <span class="hljs-comment">// ctxè¢«å–æ¶ˆäº†ï¼Œé€€å‡ºgoroutine</span>            fmt.Println(<span class="hljs-string">&quot;Cancelled:&quot;</span>, ctx.Err())            <span class="hljs-keyword">return</span>        <span class="hljs-keyword">default</span>:            <span class="hljs-comment">// ç»§ç»­å·¥ä½œ</span>            time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)            fmt.Println(<span class="hljs-string">&quot;Working...&quot;</span>)        &#125;    &#125;&#125;()<span class="hljs-comment">// ä¸»goroutineå·¥ä½œä¸€æ®µæ—¶é—´åå–æ¶ˆctx</span>time.Sleep(<span class="hljs-number">2</span> * time.Second)cancel()time.Sleep(<span class="hljs-number">1</span> * time.Second) <span class="hljs-comment">// ç»™å­goroutineæ—¶é—´é€€å‡º</span></code></pre><h4 id="3-WithDeadlineå’ŒWithTimeout"><a class="header-anchor" href="#3-WithDeadlineå’ŒWithTimeout"></a>3. WithDeadlineå’ŒWithTimeout</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithDeadline</span><span class="hljs-params">(parent Context, d time.Time)</span> <span class="hljs-params">(Context, CancelFunc)</span></span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithTimeout</span><span class="hljs-params">(parent Context, timeout time.Duration)</span> <span class="hljs-params">(Context, CancelFunc)</span></span></code></pre><p>è¿™ä¸¤ä¸ªå‡½æ•°è¿”å›çš„Contextä¼šåœ¨æŒ‡å®šçš„æˆªæ­¢æ—¶é—´æˆ–è¶…æ—¶æ—¶é—´åˆ°è¾¾æ—¶è‡ªåŠ¨å–æ¶ˆã€‚<code>WithTimeout</code>å®é™…ä¸Šæ˜¯<code>WithDeadline</code>çš„ç®€åŒ–ç‰ˆï¼Œå®ƒä½¿ç”¨<code>time.Now().Add(timeout)</code>ä½œä¸ºæˆªæ­¢æ—¶é—´ã€‚</p><pre><code class="hljs go"><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ª2ç§’åä¼šè‡ªåŠ¨å–æ¶ˆçš„Context</span>ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">2</span>*time.Second)<span class="hljs-keyword">defer</span> cancel() <span class="hljs-comment">// å³ä½¿è¶…æ—¶ï¼Œä¹Ÿæœ€å¥½è°ƒç”¨cancelé‡Šæ”¾èµ„æº</span><span class="hljs-comment">// ä½¿ç”¨ctxåšä¸€äº›å¯èƒ½è€—æ—¶çš„æ“ä½œ</span><span class="hljs-keyword">select</span> &#123;<span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">3</span> * time.Second):    fmt.Println(<span class="hljs-string">&quot;æ“ä½œå®Œæˆ&quot;</span>)<span class="hljs-keyword">case</span> &lt;-ctx.Done():    fmt.Println(<span class="hljs-string">&quot;æ“ä½œè¢«å–æ¶ˆ:&quot;</span>, ctx.Err())&#125;</code></pre><h4 id="4-WithValue"><a class="header-anchor" href="#4-WithValue"></a>4. WithValue</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithValue</span><span class="hljs-params">(parent Context, key, val <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">Context</span></span></code></pre><p><code>WithValue</code>è¿”å›ä¸€ä¸ªæ–°çš„Contextï¼Œå®ƒæºå¸¦äº†ç»™å®šçš„é”®å€¼å¯¹ã€‚è¿™ä¸ªé”®å€¼å¯¹å¯¹æ´¾ç”Ÿçš„æ‰€æœ‰å­Contextå¯è§ã€‚</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> contextKey <span class="hljs-keyword">string</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¸¦æœ‰å€¼çš„Context</span>    ctx := context.WithValue(context.Background(), contextKey(<span class="hljs-string">&quot;user&quot;</span>), <span class="hljs-string">&quot;alice&quot;</span>)        <span class="hljs-comment">// åœ¨å¦ä¸€ä¸ªå‡½æ•°ä¸­ä½¿ç”¨è¿™ä¸ªå€¼</span>    processRequest(ctx)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processRequest</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;    <span class="hljs-comment">// è·å–Contextä¸­çš„å€¼</span>    user, ok := ctx.Value(contextKey(<span class="hljs-string">&quot;user&quot;</span>)).(<span class="hljs-keyword">string</span>)    <span class="hljs-keyword">if</span> !ok &#123;        fmt.Println(<span class="hljs-string">&quot;æœªæ‰¾åˆ°ç”¨æˆ·&quot;</span>)        <span class="hljs-keyword">return</span>    &#125;    fmt.Println(<span class="hljs-string">&quot;å¤„ç†ç”¨æˆ·è¯·æ±‚:&quot;</span>, user)&#125;</code></pre><h3 id="ğŸš€-Contextçš„æœ€ä½³å®è·µ"><a class="header-anchor" href="#ğŸš€-Contextçš„æœ€ä½³å®è·µ"></a>ğŸš€ Contextçš„æœ€ä½³å®è·µ</h3><h4 id="1-å°†Contextä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’"><a class="header-anchor" href="#1-å°†Contextä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’"></a>1. å°†Contextä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’</h4><p>æŒ‰ç…§Goçš„æƒ¯ä¾‹ï¼ŒContextåº”è¯¥ä½œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ï¼Œé€šå¸¸å‘½åä¸º<code>ctx</code>ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DoSomething</span><span class="hljs-params">(ctx context.Context, arg Arg)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-comment">// ...ä½¿ç”¨ctx...</span>&#125;</code></pre><h4 id="2-ä¸è¦å°†Contextå­˜å‚¨åœ¨ç»“æ„ä½“ä¸­"><a class="header-anchor" href="#2-ä¸è¦å°†Contextå­˜å‚¨åœ¨ç»“æ„ä½“ä¸­"></a>2. ä¸è¦å°†Contextå­˜å‚¨åœ¨ç»“æ„ä½“ä¸­</h4><p>Contextåº”è¯¥ä½œä¸ºå‡½æ•°å‚æ•°æ˜¾å¼ä¼ é€’ï¼Œè€Œä¸æ˜¯å­˜å‚¨åœ¨ç»“æ„ä½“ä¸­ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span><span class="hljs-keyword">type</span> Service <span class="hljs-keyword">struct</span> &#123;    ctx context.Context    <span class="hljs-comment">// ...</span>&#125;<span class="hljs-comment">// å¥½çš„åšæ³•</span><span class="hljs-keyword">type</span> Service <span class="hljs-keyword">struct</span> &#123;    <span class="hljs-comment">// ...æ²¡æœ‰ctxå­—æ®µ</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">DoSomething</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-comment">// ...ä½¿ç”¨ctx...</span>&#125;</code></pre><h4 id="3-ä¼ é€’Contextæ—¶ä¸è¦ä½¿ç”¨nil"><a class="header-anchor" href="#3-ä¼ é€’Contextæ—¶ä¸è¦ä½¿ç”¨nil"></a>3. ä¼ é€’Contextæ—¶ä¸è¦ä½¿ç”¨nil</h4><p>è™½ç„¶è®¸å¤šå‡½æ•°ä¼šæ¥å—nil Contextï¼Œä½†æœ€å¥½å§‹ç»ˆä¼ é€’ä¸€ä¸ªæœ‰æ•ˆçš„Contextã€‚å¦‚æœä¸ç¡®å®šä½¿ç”¨å“ªä¸ªContextï¼Œå¯ä»¥ä½¿ç”¨<code>context.TODO()</code>ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span>DoSomething(<span class="hljs-literal">nil</span>, arg)<span class="hljs-comment">// å¥½çš„åšæ³•</span>DoSomething(context.TODO(), arg)</code></pre><h4 id="4-Contextçš„é”®åº”è¯¥æ˜¯éå¯¼å‡ºçš„"><a class="header-anchor" href="#4-Contextçš„é”®åº”è¯¥æ˜¯éå¯¼å‡ºçš„"></a>4. Contextçš„é”®åº”è¯¥æ˜¯éå¯¼å‡ºçš„</h4><p>å½“ä½¿ç”¨<code>WithValue</code>æ—¶ï¼Œé”®åº”è¯¥æ˜¯éå¯¼å‡ºçš„ï¼Œä»¥é¿å…ä¸åŒåŒ…ä¹‹é—´çš„å†²çªï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªéå¯¼å‡ºçš„ç±»å‹ä½œä¸ºé”®</span><span class="hljs-keyword">type</span> contextKey <span class="hljs-keyword">string</span><span class="hljs-comment">// å®šä¹‰å¸¸é‡ä½œä¸ºå…·ä½“çš„é”®</span><span class="hljs-keyword">const</span> userKey contextKey = <span class="hljs-string">&quot;user&quot;</span><span class="hljs-comment">// ä½¿ç”¨é”®å­˜å‚¨å’Œè·å–å€¼</span>ctx := context.WithValue(context.Background(), userKey, <span class="hljs-string">&quot;alice&quot;</span>)user := ctx.Value(userKey).(<span class="hljs-keyword">string</span>)</code></pre><h4 id="5-ä¸è¦å°†Contextç”¨äºå¯é€‰å‚æ•°"><a class="header-anchor" href="#5-ä¸è¦å°†Contextç”¨äºå¯é€‰å‚æ•°"></a>5. ä¸è¦å°†Contextç”¨äºå¯é€‰å‚æ•°</h4><p>Contextä¸åº”è¯¥ç”¨æ¥ä¼ é€’å¯é€‰å‚æ•°ï¼Œè€Œåº”è¯¥ç”¨äºä¼ é€’è¯·æ±‚èŒƒå›´çš„å€¼ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span>ctx := context.WithValue(context.Background(), <span class="hljs-string">&quot;timeout&quot;</span>, <span class="hljs-number">2</span>*time.Second)<span class="hljs-comment">// å¥½çš„åšæ³•</span>ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">2</span>*time.Second)<span class="hljs-keyword">defer</span> cancel()</code></pre><h3 id="ğŸ”-Contextåœ¨å®é™…åº”ç”¨ä¸­çš„ä½¿ç”¨"><a class="header-anchor" href="#ğŸ”-Contextåœ¨å®é™…åº”ç”¨ä¸­çš„ä½¿ç”¨"></a>ğŸ” Contextåœ¨å®é™…åº”ç”¨ä¸­çš„ä½¿ç”¨</h3><h4 id="1-HTTPæœåŠ¡å™¨ä¸­çš„è¯·æ±‚å–æ¶ˆ"><a class="header-anchor" href="#1-HTTPæœåŠ¡å™¨ä¸­çš„è¯·æ±‚å–æ¶ˆ"></a>1. HTTPæœåŠ¡å™¨ä¸­çš„è¯·æ±‚å–æ¶ˆ</h4><p>åœ¨HTTPæœåŠ¡å™¨ä¸­ï¼Œå½“å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ï¼ŒæœåŠ¡å™¨åº”è¯¥åœæ­¢ä¸ºè¯¥è¯·æ±‚å·¥ä½œï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handleRequest</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;    <span class="hljs-comment">// ä»è¯·æ±‚ä¸­è·å–Context</span>    ctx := r.Context()        <span class="hljs-comment">// å¯åŠ¨ä¸€ä¸ªgoroutineæ‰§è¡Œè€—æ—¶æ“ä½œ</span>    resultCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">string</span>, <span class="hljs-number">1</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        result, err := doSlowOperation(ctx)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            <span class="hljs-comment">// å¤„ç†é”™è¯¯</span>            resultCh &lt;- <span class="hljs-string">&quot;æ“ä½œå¤±è´¥&quot;</span>            <span class="hljs-keyword">return</span>        &#125;        resultCh &lt;- result    &#125;()        <span class="hljs-comment">// ç­‰å¾…æ“ä½œå®Œæˆæˆ–Contextå–æ¶ˆ</span>    <span class="hljs-keyword">select</span> &#123;    <span class="hljs-keyword">case</span> result := &lt;-resultCh:        fmt.Fprintln(w, <span class="hljs-string">&quot;ç»“æœ:&quot;</span>, result)    <span class="hljs-keyword">case</span> &lt;-ctx.Done():        fmt.Println(<span class="hljs-string">&quot;è¯·æ±‚è¢«å–æ¶ˆ&quot;</span>)        http.Error(w, <span class="hljs-string">&quot;è¯·æ±‚è¢«å–æ¶ˆ&quot;</span>, http.StatusRequestTimeout)    &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doSlowOperation</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, error)</span></span> &#123;    <span class="hljs-comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œï¼Œä½†ä¼šæ£€æŸ¥ctxæ˜¯å¦è¢«å–æ¶ˆ</span>    <span class="hljs-keyword">select</span> &#123;    <span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">2</span> * time.Second):        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;æ“ä½œæˆåŠŸ&quot;</span>, <span class="hljs-literal">nil</span>    <span class="hljs-keyword">case</span> &lt;-ctx.Done():        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, ctx.Err()    &#125;&#125;</code></pre><h4 id="2-æ•°æ®åº“æŸ¥è¯¢è¶…æ—¶"><a class="header-anchor" href="#2-æ•°æ®åº“æŸ¥è¯¢è¶…æ—¶"></a>2. æ•°æ®åº“æŸ¥è¯¢è¶…æ—¶</h4><p>ä½¿ç”¨Contextæ§åˆ¶æ•°æ®åº“æŸ¥è¯¢çš„è¶…æ—¶ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">queryWithTimeout</span><span class="hljs-params">(ctx context.Context, query <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">([]Result, error)</span></span> &#123;    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ª5ç§’è¶…æ—¶çš„Context</span>    ctx, cancel := context.WithTimeout(ctx, <span class="hljs-number">5</span>*time.Second)    <span class="hljs-keyword">defer</span> cancel()        <span class="hljs-comment">// æ‰§è¡ŒæŸ¥è¯¢ï¼Œä¼ é€’ctxä»¥ä¾¿åœ¨è¶…æ—¶æ—¶å–æ¶ˆæŸ¥è¯¢</span>    <span class="hljs-keyword">return</span> db.QueryContext(ctx, query)&#125;</code></pre><h4 id="3-é“¾å¼è°ƒç”¨ä¸­ä¼ é€’å–æ¶ˆä¿¡å·"><a class="header-anchor" href="#3-é“¾å¼è°ƒç”¨ä¸­ä¼ é€’å–æ¶ˆä¿¡å·"></a>3. é“¾å¼è°ƒç”¨ä¸­ä¼ é€’å–æ¶ˆä¿¡å·</h4><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚å¯èƒ½ä¼šè§¦å‘å¤šä¸ªæœåŠ¡ä¹‹é—´çš„è°ƒç”¨é“¾ã€‚ä½¿ç”¨Contextå¯ä»¥ç¡®ä¿å½“æœ€åˆçš„è¯·æ±‚è¢«å–æ¶ˆæ—¶ï¼Œæ•´ä¸ªè°ƒç”¨é“¾éƒ½ä¼šè¢«å–æ¶ˆï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handleUserRequest</span><span class="hljs-params">(ctx context.Context, userID <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*UserData, error)</span></span> &#123;    <span class="hljs-comment">// è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯</span>    user, err := getUserInfo(ctx, userID)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;        <span class="hljs-comment">// å¹¶è¡Œè·å–ç”¨æˆ·è®¢å•å’Œæ”¯ä»˜ä¿¡æ¯</span>    <span class="hljs-keyword">var</span> wg sync.WaitGroup    <span class="hljs-keyword">var</span> orders []Order    <span class="hljs-keyword">var</span> payments []Payment    <span class="hljs-keyword">var</span> orderErr, paymentErr error        wg.Add(<span class="hljs-number">2</span>)    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> wg.Done()        orders, orderErr = getOrders(ctx, userID)    &#125;()        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;        <span class="hljs-keyword">defer</span> wg.Done()        payments, paymentErr = getPayments(ctx, userID)    &#125;()        wg.Wait()        <span class="hljs-keyword">if</span> orderErr != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, orderErr    &#125;    <span class="hljs-keyword">if</span> paymentErr != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, paymentErr    &#125;        <span class="hljs-comment">// ç»„åˆæ•°æ®è¿”å›</span>    <span class="hljs-keyword">return</span> &amp;UserData&#123;        User:     user,        Orders:   orders,        Payments: payments,    &#125;, <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getUserInfo</span><span class="hljs-params">(ctx context.Context, userID <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*User, error)</span></span> &#123;    <span class="hljs-comment">// è°ƒç”¨ç”¨æˆ·æœåŠ¡APIï¼Œä¼ é€’ctx</span>    req, err := http.NewRequestWithContext(ctx, <span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;/api/users/&quot;</span>+userID, <span class="hljs-literal">nil</span>)    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err    &#125;    <span class="hljs-comment">// ...æ‰§è¡Œè¯·æ±‚å¹¶è¿”å›ç»“æœ</span>&#125;<span class="hljs-comment">// getOrderså’ŒgetPaymentsç±»ä¼¼ï¼Œéƒ½æ¥æ”¶å¹¶ä½¿ç”¨ctx</span></code></pre><h4 id="4-ä½¿ç”¨Contextä¼ é€’è¯·æ±‚èŒƒå›´çš„å€¼"><a class="header-anchor" href="#4-ä½¿ç”¨Contextä¼ é€’è¯·æ±‚èŒƒå›´çš„å€¼"></a>4. ä½¿ç”¨Contextä¼ é€’è¯·æ±‚èŒƒå›´çš„å€¼</h4><p>åœ¨Webåº”ç”¨ä¸­ï¼Œå¯ä»¥ä½¿ç”¨Contextä¼ é€’ç”¨æˆ·è®¤è¯ä¿¡æ¯ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">authMiddleware</span><span class="hljs-params">(next http.Handler)</span> <span class="hljs-title">http</span>.<span class="hljs-title">Handler</span></span> &#123;    <span class="hljs-keyword">return</span> http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;        <span class="hljs-comment">// ä»è¯·æ±‚ä¸­è·å–è®¤è¯ä¿¡æ¯</span>        token := r.Header.Get(<span class="hljs-string">&quot;Authorization&quot;</span>)                <span class="hljs-comment">// éªŒè¯token</span>        user, err := validateToken(token)        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;            http.Error(w, <span class="hljs-string">&quot;æœªæˆæƒ&quot;</span>, http.StatusUnauthorized)            <span class="hljs-keyword">return</span>        &#125;                <span class="hljs-comment">// å°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°Contextä¸­</span>        ctx := context.WithValue(r.Context(), userKey, user)                <span class="hljs-comment">// ä½¿ç”¨æ–°çš„Contextè°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨</span>        next.ServeHTTP(w, r.WithContext(ctx))    &#125;)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handleUserProfile</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;    <span class="hljs-comment">// ä»Contextä¸­è·å–ç”¨æˆ·ä¿¡æ¯</span>    user, ok := r.Context().Value(userKey).(*User)    <span class="hljs-keyword">if</span> !ok &#123;        http.Error(w, <span class="hljs-string">&quot;æœªæˆæƒ&quot;</span>, http.StatusUnauthorized)        <span class="hljs-keyword">return</span>    &#125;        <span class="hljs-comment">// ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯å¤„ç†è¯·æ±‚</span>    fmt.Fprintf(w, <span class="hljs-string">&quot;æ¬¢è¿, %s!&quot;</span>, user.Name)&#125;</code></pre><h3 id="âš ï¸-Contextçš„å¸¸è§é™·é˜±"><a class="header-anchor" href="#âš ï¸-Contextçš„å¸¸è§é™·é˜±"></a>âš ï¸ Contextçš„å¸¸è§é™·é˜±</h3><h4 id="1-å¿˜è®°è°ƒç”¨cancelå‡½æ•°"><a class="header-anchor" href="#1-å¿˜è®°è°ƒç”¨cancelå‡½æ•°"></a>1. å¿˜è®°è°ƒç”¨cancelå‡½æ•°</h4><p>å½“ä½¿ç”¨<code>WithCancel</code>ã€<code>WithTimeout</code>æˆ–<code>WithDeadline</code>æ—¶ï¼Œå³ä½¿Contextè‡ªåŠ¨å–æ¶ˆï¼Œä¹Ÿåº”è¯¥è°ƒç”¨è¿”å›çš„cancelå‡½æ•°ï¼Œä»¥é‡Šæ”¾èµ„æºï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span>ctx, _ := context.WithTimeout(context.Background(), <span class="hljs-number">2</span>*time.Second)<span class="hljs-comment">// å¥½çš„åšæ³•</span>ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">2</span>*time.Second)<span class="hljs-keyword">defer</span> cancel() <span class="hljs-comment">// ç¡®ä¿åœ¨å‡½æ•°è¿”å›æ—¶è°ƒç”¨cancel</span></code></pre><h4 id="2-åœ¨Contextä¸­å­˜å‚¨ä¸åº”è¯¥å­˜å‚¨çš„å€¼"><a class="header-anchor" href="#2-åœ¨Contextä¸­å­˜å‚¨ä¸åº”è¯¥å­˜å‚¨çš„å€¼"></a>2. åœ¨Contextä¸­å­˜å‚¨ä¸åº”è¯¥å­˜å‚¨çš„å€¼</h4><p>Contextåº”è¯¥åªç”¨äºä¼ é€’è¯·æ±‚èŒƒå›´çš„å€¼ï¼Œè€Œä¸æ˜¯ç”¨äºä¼ é€’å‡½æ•°å‚æ•°ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span>ctx := context.WithValue(context.Background(), <span class="hljs-string">&quot;db&quot;</span>, database)<span class="hljs-comment">// å¥½çš„åšæ³•</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DoSomething</span><span class="hljs-params">(ctx context.Context, db *Database)</span></span> &#123;    <span class="hljs-comment">// ...</span>&#125;</code></pre><h4 id="3-ä½¿ç”¨ä¸å®‰å…¨çš„ç±»å‹ä½œä¸ºContexté”®"><a class="header-anchor" href="#3-ä½¿ç”¨ä¸å®‰å…¨çš„ç±»å‹ä½œä¸ºContexté”®"></a>3. ä½¿ç”¨ä¸å®‰å…¨çš„ç±»å‹ä½œä¸ºContexté”®</h4><p>ä½¿ç”¨åŸºæœ¬ç±»å‹ï¼ˆå¦‚å­—ç¬¦ä¸²æˆ–æ•´æ•°ï¼‰ä½œä¸ºContexté”®å¯èƒ½å¯¼è‡´å†²çªã€‚åº”è¯¥ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span>ctx := context.WithValue(context.Background(), <span class="hljs-string">&quot;user&quot;</span>, user)<span class="hljs-comment">// å¥½çš„åšæ³•</span><span class="hljs-keyword">type</span> contextKey <span class="hljs-keyword">string</span><span class="hljs-keyword">const</span> userKey contextKey = <span class="hljs-string">&quot;user&quot;</span>ctx := context.WithValue(context.Background(), userKey, user)</code></pre><h4 id="4-å¿½ç•¥Contextå–æ¶ˆ"><a class="header-anchor" href="#4-å¿½ç•¥Contextå–æ¶ˆ"></a>4. å¿½ç•¥Contextå–æ¶ˆ</h4><p>å½“ä½¿ç”¨Contextæ—¶ï¼Œåº”è¯¥å®šæœŸæ£€æŸ¥å®ƒæ˜¯å¦å·²è¢«å–æ¶ˆï¼š</p><pre><code class="hljs go"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">longRunningOperation</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;        <span class="hljs-comment">// è€—æ—¶æ“ä½œï¼Œæ²¡æœ‰æ£€æŸ¥ctxæ˜¯å¦å–æ¶ˆ</span>        time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)    &#125;&#125;<span class="hljs-comment">// å¥½çš„åšæ³•</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">longRunningOperation</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-title">error</span></span> &#123;    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;        <span class="hljs-keyword">select</span> &#123;        <span class="hljs-keyword">case</span> &lt;-ctx.Done():            <span class="hljs-keyword">return</span> ctx.Err()        <span class="hljs-keyword">default</span>:            <span class="hljs-comment">// æ‰§è¡Œä¸€å°éƒ¨åˆ†å·¥ä½œ</span>            time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)        &#125;    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h3 id="ğŸ“-æ€»ç»“"><a class="header-anchor" href="#ğŸ“-æ€»ç»“"></a>ğŸ“ æ€»ç»“</h3><p><code>context</code>åŒ…æ˜¯Goè¯­è¨€ä¸­å¤„ç†è¯·æ±‚èŒƒå›´å€¼ã€å–æ¶ˆä¿¡å·å’Œæˆªæ­¢æ—¶é—´çš„æ ‡å‡†æ–¹å¼ã€‚æ­£ç¡®ä½¿ç”¨Contextå¯ä»¥å¸®åŠ©ä½ ç¼–å†™æ›´åŠ å¥å£®å’Œå¯ç»´æŠ¤çš„å¹¶å‘ä»£ç ã€‚</p><p>ä¸»è¦è¦ç‚¹ï¼š</p><ol><li>Contextå½¢æˆä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼Œçˆ¶Contextå–æ¶ˆæ—¶ï¼Œæ‰€æœ‰å­Contextä¹Ÿä¼šå–æ¶ˆã€‚</li><li>ä½¿ç”¨<code>WithCancel</code>ã€<code>WithTimeout</code>å’Œ<code>WithDeadline</code>æ¥æ§åˆ¶æ“ä½œçš„ç”Ÿå‘½å‘¨æœŸã€‚</li><li>ä½¿ç”¨<code>WithValue</code>ä¼ é€’è¯·æ±‚èŒƒå›´çš„å€¼ï¼Œä½†è¦å°å¿ƒä½¿ç”¨ã€‚</li><li>éµå¾ªå°†Contextä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’çš„æƒ¯ä¾‹ã€‚</li><li>ä¸è¦å°†Contextå­˜å‚¨åœ¨ç»“æ„ä½“ä¸­ï¼Œè€Œæ˜¯æ˜¾å¼ä¼ é€’ã€‚</li><li>æ€»æ˜¯è°ƒç”¨cancelå‡½æ•°ï¼Œå³ä½¿Contextä¼šè‡ªåŠ¨å–æ¶ˆã€‚</li></ol><p>é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œä½ å¯ä»¥å……åˆ†åˆ©ç”¨<code>context</code>åŒ…æä¾›çš„åŠŸèƒ½ï¼Œç¼–å†™å‡ºæ›´åŠ ä¼˜é›…å’Œå¥å£®çš„Goç¨‹åºã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>context</tag>
      
      <tag>å¹¶å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>laf cloud äº‘å¼€å‘ yyds</title>
    <link href="/2022/10/30/laf%20cloud%20%E4%BA%91%E5%BC%80%E5%8F%91%20yyds/"/>
    <url>/2022/10/30/laf%20cloud%20%E4%BA%91%E5%BC%80%E5%8F%91%20yyds/</url>
    
    <content type="html"><![CDATA[<h3 id="åˆè¡·"><a class="header-anchor" href="#åˆè¡·"></a>åˆè¡·</h3><p>è…¾è®¯å¼€å§‹å¯¹ä¸ªäººå¼€å‘è€…äº‘å¼€å‘æœåŠ¡æ”¶è´¹ï¼Œè‡ªè´¹å¦‚ä¸‹</p><p><a href="https://imgse.com/i/xIXe9P"><img src="https://s1.ax1x.com/2022/10/30/xIXe9P.png" alt="xIXe9P.png"></a></p><p>å®è¯è¯´æœ¬äººå°±æ˜¯æç‚¹éç›ˆåˆ©çš„å°ä¸œè¥¿ï¼Œè¿™ä¸ªèµ„è´¹å®åœ¨æ˜¯å¤ªå¤šäº†ç‚¹ğŸ˜”ã€‚</p><h3 id="æ¶¦"><a class="header-anchor" href="#æ¶¦"></a>æ¶¦</h3><ul><li>laf cloud éå¸¸é¦™ä¸”å…è´¹å“ˆå“ˆğŸ˜ğŸ˜</li></ul><p><a href="https://imgse.com/i/xIXGhq"><img src="https://s1.ax1x.com/2022/10/30/xIXGhq.png" alt="xIXGhq.png"></a></p><p>æ³¨å†Œè´¦å·å°±å¯ä»¥å¼€å§‹äº†ï¼Œç™»å½•è´¦å·åˆ°åå°åˆ›å»ºç¬¬ä¸€ä¸ªåº”ç”¨å§ğŸ˜</p><p><a href="https://imgse.com/i/xIXfDe"><img src="https://s1.ax1x.com/2022/10/30/xIXfDe.png" alt="xIXfDe.png"></a></p><ul><li>äº‘å‡½æ•°ã€äº‘æ•°æ®åº“ã€ossé½æ´»ğŸ˜¬ğŸ˜¬ğŸ˜¬</li></ul><p><a href="https://imgse.com/i/xIXbgf"><img src="https://s1.ax1x.com/2022/10/30/xIXbgf.png" alt="xIXbgf.png"></a></p><h3 id="lafå®˜æ–¹"><a class="header-anchor" href="#lafå®˜æ–¹"></a>lafå®˜æ–¹</h3><p>å®˜æ–¹æ–‡æ¡£éå¸¸ç»™åŠ›ï¼Œè¿˜æœ‰é¢„è§ˆå›¾å’Œä»£ç èŒƒä¾‹</p><p>è¿˜ç­‰ä»€ä¹ˆï¼Œå¼ºçƒˆå®‰åˆ©ï¼ï¼ï¼ğŸ‘‰ğŸ‘‰ğŸ‘‰  <a href="https://docs.lafyun.com/">laf äº‘å¼€å‘</a></p>]]></content>
    
    
    <categories>
      
      <category>äº‘å¼€å‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>äº‘å¼€å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>office wopi</title>
    <link href="/2020/10/15/Ms%20office%20online%20%20wopi/"/>
    <url>/2020/10/15/Ms%20office%20online%20%20wopi/</url>
    
    <content type="html"><![CDATA[<h3 id="PHPå®ç°-MS-WOPI-host-ç®€å•å®ç°officeæ–‡æ¡£æŸ¥çœ‹-ç¼–è¾‘"><a class="header-anchor" href="#PHPå®ç°-MS-WOPI-host-ç®€å•å®ç°officeæ–‡æ¡£æŸ¥çœ‹-ç¼–è¾‘"></a>PHPå®ç° MS-WOPI host ç®€å•å®ç°officeæ–‡æ¡£æŸ¥çœ‹/ç¼–è¾‘</h3><p>æœ€è¿‘è°ƒç ”ä¸€æ¬¾åœ¨çº¿officeé¢„è§ˆã€ç¼–è¾‘çš„æ–¹æ¡ˆï¼Œçœ‹äº†æ¯•å‡officeã€å“æ­£officeã€å†°è“officeè¿™äº›æ”¶è´¹çš„æ–¹æ¡ˆï¼Œæ•´ä½“ä¸Šå¯ä»¥æ»¡è¶³éœ€æ±‚ï¼Œä¸è¿‡å„æœ‰ä¼˜ç¼ºç‚¹ã€‚æœ€åæ‰¾åˆ°å¾®è½¯å®˜æ–¹å‡ºå“çš„office online serverï¼ˆåŸæ¥å« office web appsï¼‰ï¼Œæœ€é‡è¦çš„ä¸€ç‚¹æ˜¯å®ƒå®Œå…¨å…è´¹ ğŸ¤£ã€‚</p><h4 id="office-online-server-éƒ¨ç½²"><a class="header-anchor" href="#office-online-server-éƒ¨ç½²"></a>office online server éƒ¨ç½²</h4><p>office online server çš„éƒ¨ç½²è¿˜ç®—æ¯”è¾ƒç¹çï¼Œä¸»è¦åŸå› ä¹Ÿæ˜¯å®ƒæ”¯æŒwindowsæœåŠ¡å™¨ï¼Œå¹³å¸¸å¤§å®¶ç”¨çš„æœ€å¤šçš„è¿˜æ˜¯Linuxï¼Œæ‰€ä»¥å¤šwindowsçš„ç†Ÿæ‚‰ç¨‹åº¦å°±æ²¡æœ‰è¿™ä¹ˆå¾—å¿ƒåº”æ‰‹äº†ã€‚</p><h5 id="å‡†å¤‡å·¥ä½œ"><a class="header-anchor" href="#å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h5><ol><li>å¿…é¡»å‡†å¤‡2å°æœåŠ¡å™¨ï¼Œå› ä¸ºOfficeOnlineä¸ä¼šåœ¨åŒ…å« Active Directory åŸŸæœåŠ¡ (AD DS) çš„æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚</li><li>åŸŸæ§æœåŠ¡å¯ä»¥ä½¿ç”¨Windows Server 2016 æ ¸å¿ƒç‰ˆ(æ— GUIç‰ˆ)ï¼Œä½†æ˜¯Office Online Server 2017 ä»…æ”¯æŒ Windows Server 2016 çš„â€œå«æ¡Œé¢ä½“éªŒçš„æœåŠ¡å™¨â€å®‰è£…é€‰é¡¹(å¦‚æœè‡ªè¡Œå®‰è£…çš„è¯)ã€‚</li><li>Office Server 2017çš„æœåŠ¡å™¨å°½å¯èƒ½å¹²å‡€ï¼Œæœ€å¥½æ˜¯ç»™ä¸€å°å…¨æ–°çš„æœåŠ¡å™¨ã€‚</li><li>ä¸ºä¿è¯å®‰å…¨æ€§ï¼Œç”Ÿäº§ç¯å¢ƒä¸­è¯·å›ºå®šæš´éœ²éœ€è¦ä½¿ç”¨åˆ°çš„ç«¯å£ã€‚</li><li><strong>è¯·å‹¿åœ¨è¿è¡Œ Office Online Server</strong> çš„æœåŠ¡å™¨ä¸Šå®‰è£…ä»»ä½•å…¶ä»–æœåŠ¡å™¨åº”ç”¨ç¨‹åºã€‚åŒ…æ‹¬ Exchange Serverã€SharePoint Serverã€Skype for Business Server å’Œ SQL Serverã€‚å¦‚æœæœåŠ¡å™¨ä¸è¶³ï¼Œåˆ™å¯ä»¥åœ¨è¿™äº›æœåŠ¡å™¨çš„å…¶ä¸­ä¸€å°çš„è™šæ‹Ÿæœºä¸Šè¿è¡Œ Office Online Serverã€‚</li><li><strong>ä¸è¦åœ¨ç«¯å£ 80ã€443 æˆ– 809 ä¸Šå®‰è£…ä¾èµ– Web æœåŠ¡å™¨ (IIS) è§’è‰²çš„ä»»ä½•æœåŠ¡æˆ–è§’è‰²</strong>ï¼Œå› ä¸º Office Online Server ä¼šå®šæœŸåˆ é™¤è¿™äº›ç«¯å£ä¸Šçš„ Web åº”ç”¨ç¨‹åºã€‚</li><li><strong>ä¸è¦å®‰è£…ä»»ä½•ç‰ˆæœ¬çš„ Office</strong>ã€‚å¦‚æœå·²ç»å®‰è£…ï¼Œåœ¨å®‰è£… Office Online Server ä¹‹å‰å¿…é¡»å°†å…¶å¸è½½ã€‚</li><li><strong>Office Onlineä¸ä¼šåŠ è½½IPåœ°å€çš„Docæº, è¯»å–çš„åœ°å€å¿…é¡»æ˜¯å¸¦åŸŸåçš„</strong>. ä¾‹å¦‚<a href="http://1.2.3.4/t.docx%E6%98%AF%E4%BC%9A%E6%8A%A5Error%E7%9A%84">http://1.2.3.4/t.docxæ˜¯ä¼šæŠ¥Errorçš„</a></li></ol><p>å…·ä½“çš„å®‰è£…æ­¥éª¤è¿™è¾¹å°±ä¸åšèµ˜è¿°äº†ï¼Œç½‘ä¸Šçš„æ¡ˆä¾‹å¾ˆå¤šã€‚ä¾‹å¦‚ï¼š<a href="https://blog.csdn.net/q386815991/article/details/81705128">https://blog.csdn.net/q386815991/article/details/81705128</a></p><p><strong>æ³¨æ„ï¼š</strong></p><p>å®‰è£…å¾€æˆååœ¨æµè§ˆå™¨ä¸­è¾“å…¥åœ°å€ <code>http://servername/hosting/discovery</code> ï¼Œæ˜¾ç¤ºå¦‚ä¸‹åˆ™è¯´æ˜å®‰è£…æˆåŠŸ</p><p><a href="https://imgchr.com/i/BkjDOS"><img src="https://s1.ax1x.com/2020/10/23/BkjDOS.md.png" alt="BkjDOS.md.png"></a></p><pre><code class="hljs shell">ä¸è¿‡æœ‰å¯èƒ½ä¼šæŠ¥é”™æ˜¾ç¤ºerrorï¼Œå¯èƒ½æ˜¯åœ¨éƒ¨ç½²åœºçš„æ—¶å€™æ²¡æœ‰è®¾ç½®-OpenFromUrlEnabled:$trueï¼Œåœ¨powershellä¸­æ‰§è¡Œï¼šSet-OfficeWebAppsFarm -OpenFromUrlEnabled:$trueéƒ¨ç½²åœºçš„å‘½ä»¤å¯ä»¥æ”¹ä¸ºï¼šNew-OfficeWebAppsFarm -InternalURL &quot;http://servername&quot; -AllowHttp -EditingEnabled -OpenFromUrlEnabled:$true</code></pre><h5 id="æµ‹è¯•ç»“æœ"><a class="header-anchor" href="#æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h5><p>ç„¶åè¾“å…¥ <code>http://servername/op/generate.aspx</code><br><a href="https://imgchr.com/i/Bkz3LT"><img src="https://s1.ax1x.com/2020/10/23/Bkz3LT.md.png" alt="Bkz3LT.md.png"></a></p><p>è¾“å…¥ä¸€ä¸ªæ–‡æ¡£é“¾æ¥ï¼Œç”Ÿæˆcreate linkï¼Œç”¨æµè§ˆå™¨æ‰“å¼€å³å¯é¢„è§ˆä½ çš„æ–‡æ¡£äº†ã€‚</p><p><a href="https://imgchr.com/i/BkzT0S"><img src="https://s1.ax1x.com/2020/10/23/BkzT0S.md.png" alt="BkzT0S.md.png"></a></p><h4 id="wopi-host-å®ç°"><a class="header-anchor" href="#wopi-host-å®ç°"></a>wopi host å®ç°</h4><blockquote><p>Web Application Open Platform Interface (WOPI). WOPIä¸ºåŸºäºWebçš„æœåŠ¡æä¾›äº†ä¸€ç§æŸ¥çœ‹å’Œç¼–è¾‘OfficeWebAppsä¸­æ–‡æ¡£çš„æ–¹æ³•ï¼Œæ‚¨å¯ä»¥ä»Officeæ–‡æ¡£ä¸­è·å¾—æ‰€æœ‰é«˜ä¿çœŸå’Œä¸°å¯Œçš„æ–‡æ¡£ã€‚</p></blockquote><p>å®¢æˆ·ç«¯å¦‚ä½•ä½¿ç”¨WOPIçš„ä¸€ä¸ªä¾‹å­æ˜¯ä¸ºç‰¹å®šç±»å‹çš„æ–‡ä»¶æä¾›åŸºäºæµè§ˆå™¨çš„æŸ¥çœ‹å™¨ã€‚è¯¥å®¢æˆ·ç«¯ä½¿ç”¨WOPIè·å–æ–‡ä»¶çš„å†…å®¹ï¼Œä»¥ä¾¿å°†è¯¥å†…å®¹ä»¥æµè§ˆå™¨ä¸­çš„ç½‘é¡µå½¢å¼å‘ˆç°ç»™ç”¨æˆ·ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†å¦‚ä½•å·¥ä½œçš„ç¤ºä¾‹ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/badbe607395f32d1ca972769269c562d6b0.jpg" alt=""></p><p>å›¾1 ä½¿ç”¨WOPIä¸ºç‰¹å®šç±»å‹çš„æ–‡ä»¶æä¾›åŸºäºæµè§ˆå™¨çš„æŸ¥çœ‹å™¨</p><p>ä¸Šå›¾ä¸­äº¤äº’è¿‡ç¨‹ä¸­ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„ç»†èŠ‚æ˜¯ï¼ŒWOPIæœåŠ¡å™¨æä¾›äº†â€œè°ƒç”¨WOPIå®¢æˆ·ç«¯æ‰€éœ€çš„ä¿¡æ¯â€ã€‚WOPIå®¢æˆ·ç«¯æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œé€šè¿‡è¯¥æœºåˆ¶ï¼ŒWOPIæœåŠ¡å™¨å¯ä»¥å‘ç°WOPIå®¢æˆ·ç«¯çš„èƒ½åŠ›ï¼Œä»¥åŠè°ƒç”¨è¿™äº›åŠŸèƒ½çš„æ–¹æ³•ã€‚(æ­£å¦‚<a href="https://my.oschina.net/tita/blog/2963590">éƒ¨ç½² Office Online Server</a>ä¸­æ‰€è®²åˆ°çš„â€¦/hosting/discovery)ä¸‹å›¾æè¿°äº†è¿™ç§äº¤äº’ï¼š</p><p><img src="https://oscimg.oschina.net/oscnet/ac043e78db209eb5e0aa385dcfd0477ebce.jpg" alt=""></p><p>å›¾2 WOPI å‘ç°</p><blockquote><p>ç®€å•çš„è¯´æˆ‘ä»¬è¦å®ç°æ–‡ä»¶çš„ç¼–è¾‘éœ€è¦å®ç°ä¸‰ä¸ªæ¥å£ï¼š</p></blockquote><p>GET api/wopi/files/{name} <br><br>GET api/wopi/files/{name}/contents<br><br>POST api/wopi/files/{name}/contents</p><h5 id="æ¥å£å®ç°"><a class="header-anchor" href="#æ¥å£å®ç°"></a>æ¥å£å®ç°</h5><ul><li>è·å–æ–‡ä»¶ä¿¡æ¯ CheckFileInfo</li></ul><pre><code class="hljs oxygene">http:<span class="hljs-comment">//server/&lt;...&gt;/wopi*/files/&lt;id&gt;?access_token=&lt;token&gt; </span>get <span class="hljs-function"><span class="hljs-keyword">method</span></span></code></pre><p>php codeï¼š</p><pre><code class="hljs php"><span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CheckFileInfo</span>(<span class="hljs-params">$fileName, $GUID</span>)</span><span class="hljs-function">    </span>&#123;        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_SERVER[<span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>])) &#123;            $FileInfoDto = <span class="hljs-keyword">array</span>(                <span class="hljs-string">&#x27;BaseFileName&#x27;</span> =&gt; $fileName,                <span class="hljs-string">&#x27;OwnerId&#x27;</span> =&gt; <span class="hljs-string">&#x27;admin&#x27;</span>,                <span class="hljs-comment">// &#x27;ReadOnly&#x27; =&gt; true,</span>                <span class="hljs-string">&#x27;SHA256&#x27;</span> =&gt; base64_encode(hash_file(<span class="hljs-string">&#x27;sha256&#x27;</span>, $_SERVER[<span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>] . <span class="hljs-string">&#x27;/&#x27;</span> . $fileName, <span class="hljs-literal">true</span>)),                <span class="hljs-string">&#x27;Size&#x27;</span> =&gt; filesize($_SERVER[<span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>] . <span class="hljs-string">&#x27;/&#x27;</span> . $fileName),                <span class="hljs-string">&#x27;Version&#x27;</span> =&gt; <span class="hljs-number">1</span>,                <span class="hljs-string">&#x27;UserCanWrite&#x27;</span> =&gt; <span class="hljs-literal">true</span> <span class="hljs-comment">//æ³¨æ„è¿™ä¸ªå‚æ•°ï¼Œä¸ºtrueæ—¶æ‰æœ‰ç¼–è¾‘å½“å‰æ–‡æ¡£çš„æƒé™</span>            );            $jsonString = json_encode($FileInfoDto);            header(<span class="hljs-string">&#x27;Content-Type: application/json&#x27;</span>);            <span class="hljs-keyword">echo</span> $jsonString;        &#125;        <span class="hljs-keyword">else</span> <span class="hljs-keyword">die</span>();    &#125;</code></pre><ul><li>è·å–æ–‡ä»¶æµ  GetFile</li></ul><pre><code class="hljs oxygene">http:<span class="hljs-comment">//server/&lt;...&gt;/wopi*/files/&lt;id&gt;/contents?access_token=&lt;token&gt;</span>get <span class="hljs-function"><span class="hljs-keyword">method</span></span></code></pre><p>php codeï¼š</p><pre><code class="hljs php"><span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GetFile</span>(<span class="hljs-params">$fileName</span>)</span><span class="hljs-function">  </span>&#123;      <span class="hljs-keyword">if</span> (file_exists($_SERVER[<span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>] . <span class="hljs-string">&#x27;/&#x27;</span> . $fileName)) &#123;          header(<span class="hljs-string">&#x27;Content-Description: File Transfer&#x27;</span>);          header(<span class="hljs-string">&#x27;Content-Type: application/octet-stream&#x27;</span>);          header(<span class="hljs-string">&#x27;Content-Disposition: attachment; filename=&#x27;</span> . basename($_SERVER[<span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>] . <span class="hljs-string">&#x27;/&#x27;</span> . $fileName));          header(<span class="hljs-string">&#x27;Expires: 0&#x27;</span>);          header(<span class="hljs-string">&#x27;Cache-Control: must-revalidate&#x27;</span>);          header(<span class="hljs-string">&#x27;Pragma: public&#x27;</span>);          header(<span class="hljs-string">&#x27;Content-Length: &#x27;</span> . filesize($_SERVER[<span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>] . <span class="hljs-string">&#x27;/&#x27;</span> . $fileName));          readfile($_SERVER[<span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>] . <span class="hljs-string">&#x27;/&#x27;</span> . $fileName);          <span class="hljs-keyword">exit</span>;      &#125;  &#125;</code></pre><ul><li>ä¿å­˜æ–‡ä»¶ PutFile urlå’ŒGetFileä¸€æ ·ï¼Œä½†æ˜¯è¯·æ±‚æ–¹æ³•ï¼ˆrequest methodï¼‰ä¸åŒ</li></ul><pre><code class="hljs oxygene">http:<span class="hljs-comment">//server/&lt;...&gt;/wopi*/files/&lt;id&gt;/contents?access_token=&lt;token&gt;</span>post <span class="hljs-function"><span class="hljs-keyword">method</span></span><span class="hljs-function"></span><span class="hljs-function"><span class="hljs-title">wopi</span> <span class="hljs-title">client</span> è·å–æµè§ˆå™¨ç¼–è¾‘çš„æ–‡æ¡£çš„å†…å®¹ï¼Œå°†äºŒè¿›åˆ¶æµå‘é€ç»™è¯¥<span class="hljs-title">PutFile</span>æœåŠ¡ï¼Œå› æ­¤å®ç°çš„æ—¶å€™ï¼Œä¿å­˜è¯¥äºŒè¿›åˆ¶æµå°±è¡Œäº†</span></code></pre><p>å®ç°æ€è·¯å¤§è‡´å¦‚ä¸Šï¼Œè¿™æ ·å°±å¯ä»¥å¯¹officeæ–‡æ¡£è¿›è¡Œåœ¨çº¿ç¼–è¾‘å’Œé¢„è§ˆäº†ã€‚</p><p><a href="https://imgchr.com/i/BA95Ox"><img src="https://s1.ax1x.com/2020/10/23/BA95Ox.md.png" alt="BA95Ox.md.png"></a></p><p>æœ€åå®‰å…¨æ–¹é¢ï¼Œå¯ä»¥åšé™åˆ¶ç™½åå•ï¼ŒæŒ‡å®šoffice online server èƒ½å¤Ÿè®¿é—®çš„åŸŸå</p><pre><code class="hljs css"><span class="hljs-selector-tag">New-OfficeWebAppsHost</span> <span class="hljs-selector-tag">-domain</span> &quot;<span class="hljs-selector-tag">test</span><span class="hljs-selector-class">.wopi</span><span class="hljs-selector-class">.com</span>&quot;  é™åˆ¶åªèƒ½è®¿é—®<span class="hljs-selector-tag">test</span><span class="hljs-selector-class">.wopi</span><span class="hljs-selector-class">.com</span> è¿™ä¸ªåŸŸåå®ç°çš„<span class="hljs-selector-tag">wopi</span>æœåŠ¡</code></pre>]]></content>
    
    
    <categories>
      
      <category>php</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åœ¨çº¿office</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PHP çš„å‡ ç§å¼‚æ­¥æ‰§è¡Œæ–¹å¼</title>
    <link href="/2020/07/07/php-%E7%9A%84%E5%87%A0%E7%A7%8D%E5%BC%82%E6%AD%A5%E6%89%A7%E8%A1%8C%E6%96%B9%E5%BC%8F/"/>
    <url>/2020/07/07/php-%E7%9A%84%E5%87%A0%E7%A7%8D%E5%BC%82%E6%AD%A5%E6%89%A7%E8%A1%8C%E6%96%B9%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<p><strong>æœ‰æ—¶å€™ä¸€äº›ä»»åŠ¡çš„æ‰§è¡Œç”¨æˆ·æ ¹æœ¬ä¸å…³å¿ƒæ‰§è¡Œç»“æœï¼Œä½†æ˜¯éœ€è¦ç”¨æˆ·ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆåæ‰èƒ½å…³é—­å®¢æˆ·ç«¯ï¼Œåœ¨phpå•çº¿ç¨‹çš„æœºåˆ¶ä¸‹ï¼Œä»»åŠ¡æ‰§è¡Œåˆ°ä¸€éƒ¨åˆ†è¢«å…³é—­çš„æƒ…å†µéå¸¸ä¸å‹å¥½ã€‚</strong></p><h3 id="ajax"><a class="header-anchor" href="#ajax"></a>ajax</h3><p>åœ¨å‰ç«¯ç¼–ç¨‹ä¸­å°±çŸ¥é“ajaxå¯ä»¥è¿›è¡Œå¼‚æ­¥æ‰§è¡Œã€‚</p><pre><code class="hljs php">$.get(<span class="hljs-string">&quot;doAsync.php&quot;</span>, &#123; name: <span class="hljs-string">&#x27;raykaeso&#x27;</span>,job:<span class="hljs-string">&#x27;PHP Programmer&#x27;</span>&#125; );</code></pre><h3 id="ä½¿ç”¨popenï¼Œæ‰§è¡Œæœ¬åœ°æ–‡ä»¶"><a class="header-anchor" href="#ä½¿ç”¨popenï¼Œæ‰§è¡Œæœ¬åœ°æ–‡ä»¶"></a>ä½¿ç”¨popenï¼Œæ‰§è¡Œæœ¬åœ°æ–‡ä»¶</h3><pre><code class="hljs php">pclose(popen(<span class="hljs-string">&#x27;php /var/www/doAsync.php &amp;&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>));</code></pre><h3 id="ä½¿ç”¨curlè¶…æ—¶"><a class="header-anchor" href="#ä½¿ç”¨curlè¶…æ—¶"></a>ä½¿ç”¨curlè¶…æ—¶</h3><p>è®¾ç½®curlçš„è¶…æ—¶æ—¶é—´ CURLOPT_TIMEOUT ä¸º1 ï¼ˆæœ€å°ä¸º1ï¼‰ï¼Œå› æ­¤å®¢æˆ·ç«¯éœ€è¦ç­‰å¾…1ç§’ï¼Œcurlè¯·æ±‚åœ°å€å¿…é¡»ä¸ºç»å¯¹è·¯å¾„</p><pre><code class="hljs php">$param = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;name&#x27;</span>=&gt;<span class="hljs-string">&#x27;raykaeso&#x27;</span>,<span class="hljs-string">&#x27;job&#x27;</span>=&gt;<span class="hljs-string">&#x27;PHP Programmer&#x27;</span>);$ch = curl_init();curl_setopt($ch, CURLOPT_URL,<span class="hljs-string">&quot;http://www.example.com/doAsync.php&quot;</span>);curl_setopt($ch, CURLOPT_POST, <span class="hljs-number">1</span>);curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($param)); <span class="hljs-comment">//å°†æ•°ç»„è½¬æ¢ä¸ºURLè¯·æ±‚å­—ç¬¦ä¸²</span>curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);curl_setopt($ch, CURLOPT_HEADER, <span class="hljs-literal">false</span>);curl_setopt($ch, CURLOPT_TIMEOUT, <span class="hljs-number">1</span>);curl_exec($ch);curl_close($ch);</code></pre><h3 id="ä½¿ç”¨shell-execå‘½ä»¤"><a class="header-anchor" href="#ä½¿ç”¨shell-execå‘½ä»¤"></a>ä½¿ç”¨shell_execå‘½ä»¤</h3><pre><code class="hljs php">shell_exec(<span class="hljs-string">&quot;/use/local/php/bin/php /www/test.php  &gt; /dev/null 2&gt;&amp;1 &amp;&quot;</span>);</code></pre><p>shellä¸­å¯èƒ½ç»å¸¸èƒ½çœ‹åˆ°ï¼š&gt;/dev/null 2&gt;&amp;1 å‘½ä»¤çš„ç»“æœå¯ä»¥é€šè¿‡%&gt;çš„å½¢å¼æ¥å®šä¹‰è¾“å‡º /dev/null ä»£è¡¨ç©ºè®¾å¤‡æ–‡ä»¶ ä¸é˜»å¡å¯ä»¥å°†å‘½ä»¤è¾“å‡ºçš„å†…å®¹å†™å…¥ç³»ç»Ÿçš„ä¸€ä¸ªå›æ”¶ç«™æ–‡ä»¶ï¼Œè¿™æ ·ç¨‹åºå°±ä¸ä¼šé˜»å¡ æ­¤ç§æ–¹æ³•å¯åˆ›å»ºç‹¬ç«‹Apacheæˆ–nginxç­‰HTTPæœåŠ¡ä¹‹å¤–çš„phpè¿›ç¨‹ï¼Œä¸å½±å“HTTPæ¥æ”¶å…¶ä»–è¯·æ±‚ã€‚ ç¼ºç‚¹ï¼šåœ¨å¹¶å‘å¤„ç†æ—¶ä¼šåˆ›å»ºå¤§é‡çš„phpè¿›ç¨‹</p>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¼‚æ­¥</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golangåŸºç¡€  æµç¨‹æ§åˆ¶ä¸­ä¸€äº›æœ‰è¶£çš„ç‰¹æ€§</title>
    <link href="/2020/06/04/golang%E5%9F%BA%E7%A1%80-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E4%B8%AD%E4%B8%80%E4%BA%9B%E6%9C%89%E8%B6%A3%E7%9A%84%E7%89%B9%E6%80%A7/"/>
    <url>/2020/06/04/golang%E5%9F%BA%E7%A1%80-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E4%B8%AD%E4%B8%80%E4%BA%9B%E6%9C%89%E8%B6%A3%E7%9A%84%E7%89%B9%E6%80%A7/</url>
    
    <content type="html"><![CDATA[<h4 id="æœ€è¿‘åœ¨çœ‹golangåŸºç¡€ï¼Œåœ¨æµç¨‹æ§åˆ¶è¿™éƒ¨åˆ†çœ‹åˆ°äº†ä¸€äº›golangç‰¹æœ‰çš„å¥½ç”¨çš„åˆæœ‰ç‚¹é«˜å¤§ä¸Šç‰¹æ€§ï¼Œè®°å½•ä¸€ä¸‹ã€‚"><a class="header-anchor" href="#æœ€è¿‘åœ¨çœ‹golangåŸºç¡€ï¼Œåœ¨æµç¨‹æ§åˆ¶è¿™éƒ¨åˆ†çœ‹åˆ°äº†ä¸€äº›golangç‰¹æœ‰çš„å¥½ç”¨çš„åˆæœ‰ç‚¹é«˜å¤§ä¸Šç‰¹æ€§ï¼Œè®°å½•ä¸€ä¸‹ã€‚"></a>æœ€è¿‘åœ¨çœ‹golangåŸºç¡€ï¼Œåœ¨æµç¨‹æ§åˆ¶è¿™éƒ¨åˆ†çœ‹åˆ°äº†ä¸€äº›golangç‰¹æœ‰çš„å¥½ç”¨çš„åˆæœ‰ç‚¹é«˜å¤§ä¸Šç‰¹æ€§ï¼Œè®°å½•ä¸€ä¸‹ã€‚</h4><blockquote><p>å¤šä¸ªè¿”å›å€¼</p></blockquote><p>ç›´æ¥çœ‹ä»£ç </p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-comment">//è¿”å› A+B å’Œ A*B</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SumAndProduct</span><span class="hljs-params">(A, B <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>)</span></span> &#123;    <span class="hljs-keyword">return</span> A+B, A*B&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;    x := <span class="hljs-number">3</span>    y := <span class="hljs-number">4</span>    xPLUSy, xTIMESy := SumAndProduct(x, y)    fmt.Printf(<span class="hljs-string">&quot;%d + %d = %d\n&quot;</span>, x, y, xPLUSy)    fmt.Printf(<span class="hljs-string">&quot;%d * %d = %d\n&quot;</span>, x, y, xTIMESy)&#125;</code></pre><p>ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›´æ¥è¿”å›äº†ä¸¤ä¸ªå‚æ•°ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘½åè¿”å›å‚æ•°çš„å˜é‡ï¼Œè¿™ä¸ªä¾‹å­é‡Œé¢åªæ˜¯ç”¨äº†ä¸¤ä¸ªç±»å‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ”¹æˆå¦‚ä¸‹è¿™æ ·çš„å®šä¹‰ï¼Œç„¶åè¿”å›çš„æ—¶å€™ä¸ç”¨å¸¦ä¸Šå˜é‡åï¼Œå› ä¸ºç›´æ¥åœ¨å‡½æ•°é‡Œé¢åˆå§‹åŒ–äº†ã€‚ä½†å¦‚æœä½ çš„å‡½æ•°æ˜¯å¯¼å‡ºçš„(é¦–å­—æ¯å¤§å†™)ï¼Œå®˜æ–¹å»ºè®®ï¼šæœ€å¥½å‘½åè¿”å›å€¼ï¼Œå› ä¸ºä¸å‘½åè¿”å›å€¼ï¼Œè™½ç„¶ä½¿å¾—ä»£ç æ›´åŠ ç®€æ´äº†ï¼Œä½†æ˜¯ä¼šé€ æˆç”Ÿæˆçš„æ–‡æ¡£å¯è¯»æ€§å·®ã€‚</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SumAndProduct</span><span class="hljs-params">(A, B <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(add <span class="hljs-keyword">int</span>, Multiplied <span class="hljs-keyword">int</span>)</span></span> &#123;    add = A+B    Multiplied = A*B    <span class="hljs-keyword">return</span>&#125;</code></pre><blockquote><p>å˜å‚</p></blockquote><p>Goå‡½æ•°æ”¯æŒå˜å‚ã€‚æ¥å—å˜å‚çš„å‡½æ•°æ˜¯æœ‰ç€ä¸å®šæ•°é‡çš„å‚æ•°çš„ã€‚ä¸ºäº†åšåˆ°è¿™ç‚¹ï¼Œé¦–å…ˆéœ€è¦å®šä¹‰å‡½æ•°ä½¿å…¶æ¥å—å˜å‚ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">myfunc</span><span class="hljs-params">(arg ...<span class="hljs-keyword">int</span>)</span></span> &#123;&#125;</code></pre><p>arg â€¦intå‘Šè¯‰Goè¿™ä¸ªå‡½æ•°æ¥å—ä¸å®šæ•°é‡çš„å‚æ•°ã€‚æ³¨æ„ï¼Œè¿™äº›å‚æ•°çš„ç±»å‹å…¨éƒ¨æ˜¯intã€‚åœ¨å‡½æ•°ä½“ä¸­ï¼Œå˜é‡argæ˜¯ä¸€ä¸ªintçš„sliceï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">for</span> _, n := <span class="hljs-keyword">range</span> arg &#123;    fmt.Printf(<span class="hljs-string">&quot;And the number is: %d\n&quot;</span>, n)&#125;</code></pre><blockquote><p>defer</p></blockquote><p>Goè¯­è¨€ä¸­æœ‰ç§ä¸é”™çš„è®¾è®¡ï¼Œå³å»¶è¿Ÿï¼ˆdeferï¼‰è¯­å¥ï¼Œä½ å¯ä»¥åœ¨å‡½æ•°ä¸­æ·»åŠ å¤šä¸ªdeferè¯­å¥ã€‚å½“å‡½æ•°æ‰§è¡Œåˆ°æœ€åæ—¶ï¼Œè¿™äº›deferè¯­å¥ä¼šæŒ‰ç…§é€†åºæ‰§è¡Œï¼Œæœ€åè¯¥å‡½æ•°è¿”å›ã€‚ç‰¹åˆ«æ˜¯å½“ä½ åœ¨è¿›è¡Œä¸€äº›æ‰“å¼€èµ„æºçš„æ“ä½œæ—¶ï¼Œé‡åˆ°é”™è¯¯éœ€è¦æå‰è¿”å›ï¼Œåœ¨è¿”å›å‰ä½ éœ€è¦å…³é—­ç›¸åº”çš„èµ„æºï¼Œä¸ç„¶å¾ˆå®¹æ˜“é€ æˆèµ„æºæ³„éœ²ç­‰é—®é¢˜ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬ä¸€èˆ¬å†™æ‰“å¼€ä¸€ä¸ªèµ„æºæ˜¯è¿™æ ·æ“ä½œçš„ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ReadWrite</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span> &#123;    file.Open(<span class="hljs-string">&quot;file&quot;</span>)<span class="hljs-comment">// åšä¸€äº›å·¥ä½œ</span>    <span class="hljs-keyword">if</span> failureX &#123;        file.Close()        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>    &#125;    <span class="hljs-keyword">if</span> failureY &#123;        file.Close()        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>    &#125;    file.Close()    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>&#125;</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ä¸Šé¢æœ‰å¾ˆå¤šé‡å¤çš„ä»£ç ï¼ŒGoçš„deferæœ‰æ•ˆè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ä½¿ç”¨å®ƒåï¼Œä¸ä½†ä»£ç é‡å‡å°‘äº†å¾ˆå¤šï¼Œè€Œä¸”ç¨‹åºå˜å¾—æ›´ä¼˜é›…ã€‚åœ¨deferåæŒ‡å®šçš„å‡½æ•°ä¼šåœ¨å‡½æ•°é€€å‡ºå‰è°ƒç”¨ã€‚</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ReadWrite</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span> &#123;    file.Open(<span class="hljs-string">&quot;file&quot;</span>)    <span class="hljs-keyword">defer</span> file.Close()    <span class="hljs-keyword">if</span> failureX &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>    &#125;    <span class="hljs-keyword">if</span> failureY &#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>&#125;</code></pre><p>å¦‚æœæœ‰å¾ˆå¤šè°ƒç”¨deferï¼Œé‚£ä¹ˆdeferæ˜¯é‡‡ç”¨åè¿›å…ˆå‡ºæ¨¡å¼ï¼Œæ‰€ä»¥å¦‚ä¸‹ä»£ç ä¼šè¾“å‡º4 3 2 1 0</p><pre><code class="hljs go"><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;    <span class="hljs-keyword">defer</span> fmt.Printf(<span class="hljs-string">&quot;%d &quot;</span>, i)&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golangåŸºç¡€</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>çº¦ç‘Ÿå¤«ç¯é—®é¢˜è¯¦è§£</title>
    <link href="/2020/05/25/%E7%BA%A6%E7%91%9F%E5%A4%AB%E7%8E%AF%E9%97%AE%E9%A2%98%E8%AF%A6%E8%A7%A3/"/>
    <url>/2020/05/25/%E7%BA%A6%E7%91%9F%E5%A4%AB%E7%8E%AF%E9%97%AE%E9%A2%98%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h2 id="1-é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯çº¦ç‘Ÿå¤«ç¯é—®é¢˜ï¼š-br"><a class="header-anchor" href="#1-é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯çº¦ç‘Ÿå¤«ç¯é—®é¢˜ï¼š-br"></a>1.é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯çº¦ç‘Ÿå¤«ç¯é—®é¢˜ï¼š<br></h2><p>è®²ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„æ•…äº‹ï¼šçº¦ç‘Ÿå¤«æ˜¯çŠ¹å¤ªå†›é˜Ÿçš„ä¸€ä¸ªå°†å†›ï¼Œåœ¨åæŠ—ç½—é©¬çš„èµ·ä¹‰ä¸­ï¼Œä»–æ‰€ç‡é¢†çš„å†›é˜Ÿè¢«å‡»æºƒï¼Œåªå‰©ä¸‹æ®‹ä½™çš„éƒ¨é˜Ÿ40ä½™äººï¼Œä»–ä»¬éƒ½æ˜¯å®æ­»ä¸å±ˆçš„äººï¼Œæ‰€ä»¥ä¸æ„¿æŠ•é™åšå›å¾’ã€‚ä¸€ç¾¤äººè¡¨å†³è¯´è¦æ­»ï¼Œæ‰€ä»¥ç”¨ä¸€ç§ç­–ç•¥æ¥å…ˆåæ€æ­»æ‰€æœ‰äººã€‚<br>äºæ˜¯çº¦ç‘Ÿå¤«å»ºè®®ï¼šæ¯æ¬¡ç”±å…¶ä»–ä¸¤äººä¸€èµ·æ€æ­»ä¸€ä¸ªäººï¼Œè€Œè¢«æ€çš„äººçš„å…ˆåé¡ºåºæ˜¯ç”±æŠ½ç­¾å†³å®šçš„ï¼Œçº¦ç‘Ÿå¤«æœ‰é¢„è°‹åœ°æŠ½åˆ°äº†æœ€åä¸€ç­¾ï¼Œåœ¨æ€äº†é™¤äº†ä»–å’Œå‰©ä½™é‚£ä¸ªäººä¹‹å¤–çš„æœ€åä¸€äººï¼Œä»–åŠæœäº†å¦å¤–ä¸€ä¸ªæ²¡æ­»çš„äººæŠ•é™äº†ç½—é©¬ã€‚</p><p>æˆ‘ä»¬è¿™ä¸ªè§„åˆ™æ˜¯è¿™ä¹ˆå®šçš„ï¼š<br>åœ¨ä¸€é—´æˆ¿é—´æ€»å…±æœ‰nä¸ªäººï¼ˆä¸‹æ ‡0ï½n-1ï¼‰ï¼Œåªèƒ½æœ‰æœ€åä¸€ä¸ªäººæ´»å‘½ã€‚</p><p>æŒ‰ç…§å¦‚ä¸‹è§„åˆ™å»æ€äººï¼š</p><ul><li><pre><code>    æ‰€æœ‰äººå›´æˆä¸€åœˆ</code></pre></li><li><pre><code>    é¡ºæ—¶é’ˆæŠ¥æ•°ï¼Œæ¯æ¬¡æŠ¥åˆ°qçš„äººå°†è¢«æ€æ‰</code></pre></li><li><pre><code>    è¢«æ€æ‰çš„äººå°†ä»æˆ¿é—´å†…è¢«ç§»èµ°</code></pre></li><li><pre><code>    ç„¶åä»è¢«æ€æ‰çš„ä¸‹ä¸€ä¸ªäººé‡æ–°æŠ¥æ•°ï¼Œç»§ç»­æŠ¥qï¼Œå†æ¸…é™¤ï¼Œç›´åˆ°å‰©ä½™ä¸€äºº</code></pre></li></ul><p>ä½ è¦åšçš„æ˜¯ï¼šå½“ä½ åœ¨è¿™ä¸€ç¾¤äººä¹‹é—´æ—¶ï¼Œä½ å¿…é¡»é€‰æ‹©ä¸€ä¸ªä½ç½®ä»¥ä½¿å¾—ä½ å˜æˆé‚£å‰©ä½™çš„æœ€åä¸€äººï¼Œä¹Ÿå°±æ˜¯æ´»ä¸‹æ¥ã€‚</p><h2 id="2-è¿™å°±æ˜¯çº¦ç‘Ÿå¤«ç¯é—®é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¯´ä¸ªç‰¹ä¾‹åˆæ­¥äº†è§£ä¸‹è¿™ç§é—®é¢˜çš„æ±‚è§£æ€è·¯ï¼š-br"><a class="header-anchor" href="#2-è¿™å°±æ˜¯çº¦ç‘Ÿå¤«ç¯é—®é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¯´ä¸ªç‰¹ä¾‹åˆæ­¥äº†è§£ä¸‹è¿™ç§é—®é¢˜çš„æ±‚è§£æ€è·¯ï¼š-br"></a>2.è¿™å°±æ˜¯çº¦ç‘Ÿå¤«ç¯é—®é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¯´ä¸ªç‰¹ä¾‹åˆæ­¥äº†è§£ä¸‹è¿™ç§é—®é¢˜çš„æ±‚è§£æ€è·¯ï¼š<br></h2><p>ç‰¹ä¾‹ï¼š2ï¼Œå½“q = 2æ—¶å€™ï¼Œæ˜¯ä¸€ä¸ªç‰¹ä¾‹ï¼Œèƒ½å¿«é€Ÿæ±‚è§£<br>ç‰¹ä¾‹è¿˜åˆ†ä¸¤ç§</p><p>1.æ€è·¯ï¼šæ³¨æ„è¿™é‡Œçš„å‰ææ˜¯n = 2^k(ä¹Ÿå°±æ˜¯2çš„å¹‚æ¬¡ä¸ªäººï¼Œå…¶ä»–æ•°å¦å¤–è®¨è®º)</p><p>å¦‚æœåªæœ‰2ä¸ªäººï¼Œæ˜¾ç„¶å‰©ä½™çš„ä¸º1å·</p><p>å¦‚æœæœ‰4ä¸ªäººï¼Œç¬¬ä¸€è½®é™¤æ‰2,4ï¼Œå‰©ä¸‹1,3ï¼Œ3æ­»ï¼Œç•™ä¸‹1</p><p>å¦‚æœæ˜¯8ä¸ªäººï¼Œå…ˆé™¤å»2,4,6,8,ä¹‹å3,7ï¼Œå‰©ä¸‹1,5ï¼Œé™¤å»5ï¼Œåˆå‰©ä¸‹1äº†</p><p>å®šä¹‰J(n)ä¸ºnä¸ªäººæ„æˆçš„çº¦ç‘Ÿå¤«ç¯æœ€åç»“æœï¼Œåˆ™æœ‰j(2^k) = 1</p><p>J(n) = 2^k â€“ 2^k-1 = 2^k-1                  n=2^k</p><p>J(n) = 2^k-1 â€“ 2^k-2 = 2^k-2                n=2^k-1</p><p>â€¦â€¦â€¦</p><p>J(2^2) = 2^2 â€“ 2^1 = 2^1                    n=2^2</p><p>é€’æ¨å¾—åˆ°å¦‚ä¸Šç»“æœï¼Œèµ·å§‹æˆ‘ä»¬ä»”ç»†åˆ†æä¹Ÿå°±æ˜¯æ¯æ¬¡é™¤å»ä¸€åŠçš„å…ƒç´ ï¼Œç„¶åå‰©ä½™çš„ä¸€åŠç»§ç»­é‡å¤ä¹‹å‰çš„ç­–ç•¥ï¼Œå†é™¤å»ä¸€åŠã€‚ï¼ˆå¯æƒ³åˆ°é€’å½’ï¼‰</p><p>ç»“åˆï¼šJ(2) = 1 æˆ‘çŸ¥é“ä¸¤ä¸ªæ•°ï¼Œä»1å¼€å§‹ï¼Œè‚¯å®šæ˜¯2å…ˆæ­»ï¼Œå‰©ä¸‹1.</p><p>å¾—åˆ°ï¼šj(2^k) = 1</p><h3 id="2-butå½“n-ä¸ç­‰äº-2-kæ—¶å€™ï¼Œæ¯”å¦‚9-11è¿™ç§ï¼š-br"><a class="header-anchor" href="#2-butå½“n-ä¸ç­‰äº-2-kæ—¶å€™ï¼Œæ¯”å¦‚9-11è¿™ç§ï¼š-br"></a>2.butå½“n ä¸ç­‰äº 2^kæ—¶å€™ï¼Œæ¯”å¦‚9,11è¿™ç§ï¼š<br></h3><p>n ä¸ç­‰äº 2^kæ—¶ï¼Œå°±ä¸å­˜åœ¨è¿™æ ·çš„easyçš„è§„å¾‹äº†ï¼Œé‡æ–°åˆ†æï¼š</p><p>å‡è®¾n = 9ï¼Œè¿™æ—¶å€™å¦‚å›¾ä¸‹ï¼š<br><img src="https://blog.wenboo.top/wp-content/uploads/2018/05/20180525233715_81402.png" alt=""></p><p>èƒ½çœ‹å‡ºæ¥ï¼Œæˆ‘ä»¬å¹²æ‰ç¬¬ä¸€ä¸ªäººä¹Ÿå°±æ˜¯2ï¼Œä¹‹åå°±åªå‰©ä¸‹8ä¸ªäººäº†ï¼Œåˆå›åˆ°J(2^k)ä¸Šäº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦çš„æ˜¯æ‰¾åˆ°å½“å‰çš„1å·å…ƒç´ ã€‚<br>è§å›¾ä¸‹ï¼š</p><p><img src="https://blog.wenboo.top/wp-content/uploads/2018/05/20180525234057_58484.png" alt=""></p><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬ä»3å·å¼€å§‹ï¼Œå°±æˆäº†å¦å¤–ä¸€ä¸ªè§„æ¨¡å°1çš„çº¦ç‘Ÿå¤«é—®é¢˜ï¼ˆæ°å¥½ä¸º2^kçš„ç‰¹ä¾‹ï¼‰ã€‚<br>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ3å·çœ‹æˆæ–°çš„çº¦ç‘Ÿå¤«é—®é¢˜ä¸­çš„1å·ä½ç½®ï¼š<br>J(8) = J(2^3) = 1ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„1ä»£è¡¨çš„å°±æ˜¯ä¸Šä¸€ä¸ªé—®é¢˜ä¸­çš„3å·</p><p>Soï¼šJ(9) = 3<br>ç­”æ¡ˆä¸º3å·</p><h4 id="åŒç†å¯çŸ¥æ‰€æœ‰çš„é2-kçš„æ•°éƒ½æ˜¯è¿™æ ·ï¼š-br"><a class="header-anchor" href="#åŒç†å¯çŸ¥æ‰€æœ‰çš„é2-kçš„æ•°éƒ½æ˜¯è¿™æ ·ï¼š-br"></a>åŒç†å¯çŸ¥æ‰€æœ‰çš„é2^kçš„æ•°éƒ½æ˜¯è¿™æ ·ï¼š<br></h4><p>å‡è®¾n = 2^k + tï¼Œtå¯ä»¥éšæ„å–ï¼Œæ¯”å¦‚1ï¼Œ2ï¼Œ3â€¦â€¦.</p><p>å‡è®¾n = 11ï¼Œè¿™æ—¶å€™n = 2^3 + 3ï¼Œä¹Ÿå°±æ˜¯è¯´t = 3ï¼Œæ‰€ä»¥å¼€å§‹å‰”é™¤å…ƒç´ ç›´åˆ°å…¶æˆä¸º2^ké—®é¢˜çš„çº¦ç‘Ÿå¤«é—®é¢˜ã€‚<br>Soï¼Œæˆ‘ä»¬åœ¨å‰”é™¤äº†tï¼ˆ3ï¼‰ä¸ªå…ƒç´ ä¹‹åï¼ˆåˆ†åˆ«æ˜¯2,4,6ï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬å®šæ ¼åœ¨2t+1ï¼ˆ7ï¼‰å¤„ï¼Œå¹¶ä¸”å°†2t+1ï¼ˆ7ï¼‰ä½œä¸ºæ–°çš„ä¸€å·ï¼Œè€Œä¸”è¿™æ—¶å€™çš„çº¦ç‘Ÿå¤«ç¯åªå‰©ä¸‹2<sup>3ï¼Œä¹Ÿå°±æ˜¯J(2</sup>3 + 3) = 2*3 + 1 = 7ï¼Œç­”æ¡ˆä¸º7</p><p>æ€»ç»“ä¸€ä¸‹è¿™ä¸ªè§„å¾‹ï¼š<br>J(2^k + t) = 2t+1</p><h2 id="3-è¯´å®Œäº†ç‰¹ä¾‹ï¼Œç°åœ¨è¯´è¯´q-ä¸ç­‰äº2çš„æƒ…å†µä¸‹ï¼š-br"><a class="header-anchor" href="#3-è¯´å®Œäº†ç‰¹ä¾‹ï¼Œç°åœ¨è¯´è¯´q-ä¸ç­‰äº2çš„æƒ…å†µä¸‹ï¼š-br"></a>3.è¯´å®Œäº†ç‰¹ä¾‹ï¼Œç°åœ¨è¯´è¯´q ä¸ç­‰äº2çš„æƒ…å†µä¸‹ï¼š<br></h2><p>å½“q â‰  2ï¼š</p><p>æˆ‘ä»¬å‡å®šï¼š<br>â€“ n â€” näººæ„æˆçš„çº¦ç‘Ÿå¤«ç¯<br>â€“ q â€” æ¯æ¬¡ç§»é™¤ç¬¬qä¸ªäºº<br>çº¦å®šï¼š<br>â€“ Jq(n)è¡¨ç¤ºnäººæ„æˆçš„çº¦ç‘Ÿå¤«ç¯ï¼Œæ¯æ¬¡ç§»é™¤ç¬¬qä¸ªäººçš„è§£<br>â€“ nä¸ªäººçš„ç¼–å·ä»0å¼€å§‹è‡³n-1</p><p>æˆ‘ä»¬æ²¿ç”¨ä¹‹å‰ç‰¹ä¾‹çš„æ€æƒ³ï¼šèƒ½ä¸èƒ½ç”±Jq(n+1)çš„é—®é¢˜ç¼©å°æˆä¸ºJ(n)çš„é—®é¢˜ï¼ˆè¿™é‡Œçš„næ˜¯n+1è§„æ¨¡çš„çº¦ç‘Ÿå¤«é—®é¢˜æ¶ˆé™¤ä¸€ä¸ªå…ƒç´ ä¹‹åçš„ç­”æ¡ˆï¼‰ï¼ŒJq(n)æ˜¯åœ¨Jq(n+1)åŸºç¡€ä¸Šç§»é™¤ä¸€ä¸ªäººä¹‹åçš„è§£ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬èƒ½ç”±Jq(n)å¾—åˆ°Jq(n+1)ã€‚</p><p>è§„å¾‹ï¼šJq(n+1) = ( Jq(n) + q ) / (n+1)<br>è¯¦ç»†æ¨å¯¼è¿‡ç¨‹è§ï¼š<a href="https://blog.csdn.net/wusuopubupt/article/details/18214999">è¿™ç¯‡åšæ–‡</a></p><p>å¤§è‡´æ˜¯å¦‚ä¸‹è¿™æ ·ï¼š</p><p>0 1 2 3 4 5 â€¦â€¦  n-1       æ€»å…±näºº<br>è®¾ç¬¬qä¸ªäººä¹Ÿå°±æ˜¯ä¸‹æ ‡ä¸ºq-1çš„é‚£ä½ï¼Œæ€æ­»ï¼š</p><p>å‰©ä¸‹n-1ä¸ªäººï¼Œå¦‚ä¸‹ï¼š<br>q q+1 q+2 â€¦â€¦ n-2  n-1   0  1  2   â€¦â€¦  q-2     (è¿™é‡Œæ˜¯é™¤å»q-1è¿™ä½å…„å°çš„å‰©ä½™n-1äºº)</p><p>è¿™æ—¶ï¼Œåˆæ¥é‡å¤æˆ‘ä»¬çš„è€å¥—è·¯ï¼šå°†æ–°çš„è¢«æ€çš„åä¸€ä¸ªäººä½œä¸ºæ–°çš„0å·ï¼Œäºæ˜¯æ–°çš„å¦‚ä¸‹ï¼š<br>0  1  2   â€¦â€¦     â€¦â€¦â€¦.     â€¦â€¦â€¦  n-2</p><p>å…¶å®å°±æ˜¯ä»qå¼€å§‹ï¼Œåˆ°ä¹‹å‰æœ€å¤§æ•°n-1ï¼Œæ¯ä¸ªæ•°éƒ½å‡å»q,ä»0å¼€å§‹ä¹‹åæ¥ç€n-1è¿™ä¸ªæ–°çš„å€¼æ¯æ¬¡å¾€ååŠ 1ï¼Œç›´åˆ°åŠ åˆ°n-1ï¼ˆè¿™ä¸ªä¸‹æ ‡ï¼‰</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><p>J4(9) :<br>0 1 2 3 4 5 6 7 8    æ¶ˆå»3â€“&gt;    0 1 2 4 5 6 7 8( 0 1 2)<br>å¯¹åº”çš„æ–°å€¼ï¼š          0 1 2 3 4  5 6 7</p><p>å…¶ä¸­ï¼šq=4ï¼Œä»3ä¹‹åç¬¬ä¸€ä¸ªæ•°4å¼€å§‹ï¼šæ¯ä¸ªæ•°5-q=1,6-q=2,7-q=3ï¼Œ8-q=4ï¼Œå› ä¸ºæ˜¯ä¸ªç¯ï¼Œ0-q=-4,1-q=-3 â€¦.ç›´åˆ°åŠ åˆ°n-1=7</p><p>è¿™å°±ç›¸å½“äºä¸€ä¸ªé™å®šèŒƒå›´å†…çš„æ•°çš„ç›¸å¯¹ä½ç½®ï¼Œ-1ä»£è¡¨çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰çš„8<br>ï¼ˆ-2å°±ä»£è¡¨7,-3ä»£è¡¨6,-4ä»£è¡¨5â€¦â€¦-9ä»£è¡¨0ï¼Œä»åé¢å¼€å§‹æ•°è¿‡æ¥ç¬¬9ä½ï¼‰</p><p>å¤§è‡´è¿‡ç¨‹å¦‚å›¾ä¸‹ï¼š<br><img src="https://blog.wenboo.top/wp-content/uploads/2018/05/20180525233911_38244.png" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p><p>é‚£ä¹ˆæˆ‘ä»¬çŸ¥é“æ˜¯è¿™ä¹ˆå¾—åˆ°çš„æ–°çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆä¹Ÿå¾ˆå®¹æ˜“çŸ¥é“æ€ä¹ˆåæ¨äº†ï¼š<br>åè§‚å¦‚ä¸Šçš„å˜åŒ–æƒ…å†µï¼Œéƒ½æ˜¯å‡å»ä¸€ä¸ªqï¼Œæ‰€ä»¥ï¼š<br>å˜å›å»çš„å…¬å¼å¦‚ä¸‹ï¼šold = (new + q) % n<br>è¿™é‡Œçš„oldå’ŒnewæŒ‡çš„æ˜¯ä¸‹æ ‡ï¼ŒnæŒ‡çš„æ˜¯æ€»å…±æœ‰å¤šå°‘äºº</p><p>çŸ¥é“äº†æ€ä¹ˆæ¨å‡ºä¹‹å‰çš„ä¸‹æ ‡ï¼Œé‚£ä¹ˆä¹Ÿå°±å¯ä»¥ä¸€æ­¥æ­¥é€’æ¨å›å»å¾—åˆ°å¼€å§‹çš„é˜Ÿåˆ—æˆ–è€…ä»å°æ¨åˆ°å¤§å¾—åˆ°æœ€åå‰©ä½™çš„ç»“æœã€‚</p><h2 id="æœ€åå†åšä¸€é“å®é™…ç‚¹çš„ä¾‹å­ï¼Œæ±‚J2-4"><a class="header-anchor" href="#æœ€åå†åšä¸€é“å®é™…ç‚¹çš„ä¾‹å­ï¼Œæ±‚J2-4"></a>æœ€åå†åšä¸€é“å®é™…ç‚¹çš„ä¾‹å­ï¼Œæ±‚J2(4):</h2><p>J2(1) = 0<br>J2(2) = (J2(1) + 2) % 2 = 0<br>J2(3) = (J2(2) + 2) % 3 = 2<br>J2(4) = (J2(3) + 2) % 4 = 0<br>â€¦â€¦â€¦<br>è¿™æ ·ä¸€æ­¥æ­¥æ±‚å°±èƒ½å¾—åˆ°æ‰€æœ‰çš„ç»™å‡ºnå’Œqæ¡ä»¶çš„ç­”æ¡ˆäº†ã€‚</p><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;iostream&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">yuesefu</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n,<span class="hljs-keyword">int</span> m)</span></span>&#123;        <span class="hljs-keyword">if</span>(n == <span class="hljs-number">1</span>)&#123;                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">//è¿™é‡Œè¿”å›ä¸‹æ ‡,ä»0å¼€å§‹ï¼Œåªæœ‰ä¸€ä¸ªå…ƒç´ å°±æ˜¯å‰©ä½™çš„å…ƒç´ 0</span>        &#125;        <span class="hljs-keyword">else</span>&#123;                <span class="hljs-keyword">return</span> (yuesefu(n<span class="hljs-number">-1</span>,m) + m) % n; <span class="hljs-comment">//æˆ‘ä»¬ä¼ å…¥çš„næ˜¯æ€»å…±å¤šå°‘ä¸ªæ•°</span>        &#125;&#125;<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>&#123;        <span class="hljs-keyword">int</span> a,b;        <span class="hljs-built_in">cin</span>&gt;&gt;a&gt;&gt;b;        <span class="hljs-built_in">cout</span>&lt;&lt;yuesefu(a,b)&lt;&lt;<span class="hljs-built_in">endl</span>;        <span class="hljs-comment">//æˆ–è€…ï¼Œç›´æ¥å¾ªç¯è¿­ä»£ï¼Œæ±‚å‡ºæ¥çš„resultå¦‚ä¸Š</span>        <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">2</span>;i &lt;= a;i++)&#123;                result = (result+b) %i;        &#125;        <span class="hljs-built_in">cout</span>&lt;&lt;â€œresult = â€œ&lt;&lt;result&lt;&lt;<span class="hljs-built_in">endl</span>;        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•</category>
      
    </categories>
    
    
    <tags>
      
      <tag>çº¦ç‘Ÿå¤«ç¯</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¦‚ä½•ç†è§£IOå¯†é›†å‹å’Œè®¡ç®—å¯†é›†å‹ä¸šåŠ¡</title>
    <link href="/2020/01/29/%E8%BD%AC%EF%BC%9A%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3io%E5%AF%86%E9%9B%86%E5%9E%8B%E5%92%8C%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B%E4%B8%9A%E5%8A%A1/"/>
    <url>/2020/01/29/%E8%BD%AC%EF%BC%9A%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3io%E5%AF%86%E9%9B%86%E5%9E%8B%E5%92%8C%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B%E4%B8%9A%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<h4 id="åŸºç¡€çŸ¥è¯†"><a class="header-anchor" href="#åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h4><p><strong>é¦–å…ˆè¯´æ˜ï¼ŒIOå¯†é›† ä¸ è®¡ç®—å¯†é›† ä¸ºä¸¤ä¸ªç›¸å¯¹æ¦‚å¿µï¼Œè¿™ä¸ªå¾—ä»å†¯Â·è¯ºä¾æ›¼è®¡ç®—æœºç»“æ„ä½“ç³»è¯´èµ·ã€‚</strong> <img src="https://s1.ax1x.com/2018/09/29/iln211.png" alt="iln211.png"></p><p>è¿ç®—å™¨ä¸æ§åˆ¶å™¨ åˆè¢«ç§°ä¸ºä¸­å¤®å¤„ç†å™¨ï¼Œå³ CPU ( Center Process Unit )</p><p><a href="https://imgchr.com/i/ilnR6x"><img src="https://s1.ax1x.com/2018/09/29/ilnR6x.md.png" alt="ilnR6x.md.png"></a></p><h5 id="å­˜å‚¨å™¨åˆå¯åˆ†ä¸º-å†…å­˜ä¸å¤–å­˜"><a class="header-anchor" href="#å­˜å‚¨å™¨åˆå¯åˆ†ä¸º-å†…å­˜ä¸å¤–å­˜"></a>å­˜å‚¨å™¨åˆå¯åˆ†ä¸º å†…å­˜ä¸å¤–å­˜</h5><p>CPU, å­˜å‚¨å™¨, è¾“å…¥(I)ã€è¾“å‡º(O)è®¾å¤‡ç­‰æ¥å£è®¾å¤‡å‡é€šè¿‡ ç³»ç»Ÿæ€»çº¿ è¿æ¥åœ¨ä¸€èµ·ã€‚ å•¥æ˜¯ç³»ç»Ÿæ€»çº¿ï¼Ÿå¤§å­¦å­¦ä¹ çš„æ—¶å€™ï¼Œéƒ½ä¼šæåˆ°è¿™ä¸ªåè¯ï¼Œä»¿ä½›å®ƒå°±æ˜¯ä¸ªæ¦‚å¿µè€Œå·²ï¼Œå…¶å®ï¼Œç³»ç»Ÿæ€»çº¿(Bus)ï¼Œå°±å¯ä»¥ç²—ç•¥åœ°ç†è§£ä¸ºæ€»çº¿å°±æ˜¯ä¸»æ¿å¥½äº†ã€‚ åœ¨æ€»çº¿ä¸Šä¸€èˆ¬æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„å•å…ƒä¸å¸¸åœ¨è®¡ç®—æœºåŸç†ä¸­æåŠåˆ°ï¼Œå°±æ˜¯å—ã€åŒ—æ¡¥èŠ¯ç‰‡ï¼ˆå³DIYæ—¶å¸¸æåŠçš„èŠ¯ç‰‡ç»„ï¼‰ï¼Œå…·ä½“çš„å†…å®¹å¯ä»¥ç™¾ç§‘ä¸€ä¸‹ã€‚ åŒ—æ¡¥èŠ¯ç‰‡ï¼Œç¦»CPUæœ€è¿‘ï¼Œä¸€èˆ¬éƒ½è´´æœ‰æ•£çƒ­ç‰‡ï¼Œä¹Ÿç§°ä¸ºä¸»æ¡¥èŠ¯ç‰‡(Host Bridge)ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒèŠ¯ç‰‡ç»„çš„å‘½åå°±æ˜¯ä»¥åŒ—æ¡¥èŠ¯ç‰‡çš„åç§°æ¥å‘½åçš„ã€‚ä¸»è¦è´Ÿè´£æ€»çº¿ä¸Šçš„é«˜é€Ÿè®¾å¤‡æ¯”å¦‚AGPã€PCI-eã€å†…å­˜ç­‰ä¸CPUçš„æ•°æ®é«˜é€Ÿäº¤æ¢ã€‚ å—æ¡¥èŠ¯ç‰‡ï¼Œç›¸å¯¹åŒ—æ¡¥èŠ¯ç‰‡ï¼Œç¦»CPUè¾ƒè¿œï¼Œä¸€èˆ¬ä¸ä¼šè´´æ•£çƒ­ç‰‡ã€‚ä¸»è¦è´Ÿè´£ä¸­ä½é€Ÿå¤–éƒ¨è®¾å¤‡æ¯”å¦‚USBã€PCIã€IDEã€Sataã€ç½‘å¡ç­‰ï¼ŒèŠ¯ç‰‡ä¸­é›†æˆäº†ä¸­æ–­æ§åˆ¶å™¨ã€DMAæ§åˆ¶å™¨ã€‚ ç”±æ­¤å¯è§ï¼Œè´Ÿè´£ç»™CPUæä¾›æ•°æ®çš„åœ¨æ€»çº¿ä¸Šï¼Œè¿˜æœ‰ä¸¤ä¸ªç®¡å®¶ï¼Œä¸€ä¸ªå¤§å†…æ€»ç®¡(åŒ—æ¡¥)ï¼Œä¸€ä¸ªå¤–æŒæŸœ(å—æ¡¥)ã€‚ å¥½çš„ï¼Œå¼¯å­ç»•å›æ¥ï¼Œè¯´æ­£é¢˜ å¦‚ä½•åˆ¤å®š <strong>å¾…å®Œæˆâ€¦</strong></p><h5 id="å¦‚ä½•ä¼˜åŒ–"><a class="header-anchor" href="#å¦‚ä½•ä¼˜åŒ–"></a>å¦‚ä½•ä¼˜åŒ–</h5><p>è¯è¯´ï¼Œç½‘å¡ã€ç¡¬ç›˜éƒ½ç”±å—æ¡¥èŠ¯ç‰‡æ§åˆ¶ï¼Œå¹¶å±äºä¸­ã€ä½é€Ÿè®¾å¤‡ï¼Œæ‰€ä»¥ï¼Œåœ¨æœåŠ¡å™¨ä¸Šè¿›è¡Œç½‘ç»œé€šè®¯ã€ç½‘ç»œä¼ è¾“ã€ç£ç›˜è¯»å†™å‡å—å—æ¡¥æ§åˆ¶ï¼Œæ­¤ç±»å³ä¸ºIOæ“ä½œã€‚IOå¯†é›†å‹æœåŠ¡/ä¸šåŠ¡å³æ˜¯ä»¥ç½‘ç»œè¯·æ±‚å‹åŠ›å¤§ã€ç£ç›˜è¯»å†™é¢‘ç¹çš„æ“ä½œç±»å‹ï¼Œå½“è¿›è¡Œè¿™äº›IOå¯†é›†å‹æ“ä½œæ—¶ï¼ŒCPUçš„è´Ÿè½½ç›¸å¯¹è¾ƒä½(ç°ä»£è®¡ç®—æœºå‡é›†æˆäº†å¯¹ç¡¬ä»¶è®¿é—®æ§åˆ¶çš„æ“ä½œé€»è¾‘ï¼Œä½¿å¾—CPUä»è¿™äº›æ“ä½œä¸­è§£æ”¾å‡ºæ¥ï¼Œæé«˜æ ¸å¿ƒèµ„æºçš„åˆ©ç”¨ç‡)ã€‚ è®¡ç®—å¯†é›†å‹ï¼Œå¯ä»¥ç†è§£ä¸ºåœ¨åŒ—æ¡¥èŠ¯ç‰‡ä¸CPUä¹‹é—´çš„é€šè®¯è¾ƒé«˜çš„æœåŠ¡/ä¸šåŠ¡ï¼Œå¾€å¾€è¿™ç±»æ“ä½œå¸¸è§çš„éƒ½æ˜¯ä»¥è®¡ç®—ä¸ºä¸»çš„ï¼Œè€Œè®¡ç®—åˆæ˜¯CPU/GPUçš„ä¸“é•¿ï¼Œæ²¡å¬è¯´è¿‡å“ªä¸ªç¡¬ç›˜å¯ä»¥è¿›è¡Œè®¡ç®—(å½“ç„¶ï¼Œå£°å¡æˆ–ç¡¬è§£å‹å¡åº”è¯¥å±äºä¾‹å¤–äº†ï¼Œåœ¨å—æ¡¥å°†åª’ä½“çš„æ•°æ®æµé€šè¿‡æ€»çº¿ä¼ é€’ç»™å£°å¡æˆ–æ˜¯ç¡¬è§£å‹å¡ï¼Œè€Œå£°å¡å’Œç¡¬è§£å‹å¡é€šè¿‡çƒ§å½•åœ¨å¡ä¸Šçš„è§£ç å™¨è¿›è¡Œç¡¬ä»¶çº§åˆ«çš„ç¼–ç å¤„ç†ï¼Œæœ€ç»ˆæ€»å¤„ç†åçš„æ•°æ®æµé€šè¿‡å¡ä¸Šçš„æ¥å£ä¼ ç»™è¾“å‡ºè®¾å¤‡ï¼Œæ¯”å¦‚å£°å¡ä¼ é€’ç»™éŸ³ç®±)ã€‚ å¯¹äºæœåŠ¡å™¨ï¼Œé€šè¿‡å¼€å‘çš„æœåŠ¡æˆ–æ˜¯ä¸šåŠ¡ï¼Œå¯ä»¥åœ¨é¡¹ç›®ä¹‹åˆå°±æ ¹æ®éœ€æ±‚æ¥å¯¹èµ„æºè¿›è¡Œé¢„å…ˆä¼°ç®—ï¼Œå¤§è‡´å±äºIOå¯†é›†å‹è¿˜æ˜¯è®¡ç®—å¯†é›†å‹çš„ä¸šåŠ¡ï¼Œå¹¶è¿›è¡Œé¡¹ç›®å‰æœŸçš„èµ„æºé¢„ç®—ç­‰å·¥ä½œçš„å¼€å±•ï¼Œä¹ŸåŒ…æ‹¬å‰æœŸçš„è®¾è®¡å’ŒåæœŸçš„ä¼˜åŒ–ã€‚ 1. é¡¹ç›®ç«‹é¡¹è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®éœ€æ±‚å¯¹åº”çš„èµ„æºè´Ÿè½½ç±»å‹ï¼Œæå‡ºå¯¹æœåŠ¡èµ„æºçš„éœ€æ±‚é…ç½® IOå¯†é›†å‹çš„éœ€æ±‚ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœæ˜¯ç£ç›˜è¯»å†™é¢‘ç¹ï¼Œé€šè¿‡å¯¹ç£ç›˜è¿›è¡Œå‡çº§ï¼Œæé«˜ç£ç›˜çš„å“åº”é€Ÿåº¦å’Œä¼ è¾“æ•ˆç‡æˆ–é€šè¿‡è´Ÿè½½æŠ€æœ¯ï¼Œå°†æ–‡ä»¶è¯»å†™åˆ†æ•£åˆ°å¤šå°æœåŠ¡å™¨ä¸­ï¼›å¦‚æœæ˜¯ç½‘ç»œè¯·æ±‚è´Ÿè½½è¾ƒé«˜ï¼Œå¯ä»¥é€šè¿‡è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œæ°´å¹³æ‰©å±•æœåŠ¡ï¼Œæé«˜è´Ÿè½½èƒ½åŠ›ï¼›æˆ–ä½¿ç”¨ä»£ç†ç¼“å­˜æœåŠ¡å™¨ï¼Œé™ä½æ ¸å¿ƒæœåŠ¡çš„è´Ÿè½½å‹åŠ›ã€‚ è®¡ç®—å¯†é›†å‹çš„éœ€æ±‚ï¼Œé¦–å…ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨è®¡ç®—èƒ½åŠ›æ›´å¥½çš„CPUï¼Œç„¶åè€ƒè™‘é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æˆ–å…¶å®ƒé™ç»´ç®—æ³•ï¼Œå°†è®¡ç®—åˆ†æ•£çš„ä¸åŒçš„è®¡ç®—ç»“ç‚¹ï¼Œè¿›è¡Œå¤„ç†ã€‚ 2. é¡¹ç›®å¼€å‘æ—¶ï¼Œè¿›è¡Œåˆç†çš„è§„åˆ’å’Œä¸šåŠ¡å¼€å‘ å¯¹äºIOå¯†é›†å‹çš„éœ€æ±‚ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå°±è¦è€ƒè™‘å°½å¯èƒ½å‡å°‘IOå¼€é”€ï¼Œå¯¹ç£ç›˜è¯»å†™é¢‘ç¹çš„ä¸šåŠ¡ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡å†…å­˜ç¼“å­˜å°†çƒ­æ•°æ®ç¼“å­˜èµ·æ¥ï¼Œå‡å°‘ç£ç›˜çš„è¯·æ±‚ã€‚ å¯¹äºè®¡ç®—å¯†é›†å‹çš„éœ€æ±‚ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ³¨æ„è®¡ç®—ç®—æ³•çš„ä¼˜åŒ–åŠç»“æœé‡ç”¨ï¼Œå¹¶å°½å¯èƒ½è¿›è¡Œé™ç»´å¤„ç†ï¼Œæ¯”å¦‚é€šè¿‡æŸç§ç®—æ³•å°†åŸä¸šåŠ¡éœ€æ±‚çš„è®¡ç®—åˆ†æ•£æˆå¯æ‹†åˆ†çš„é€»è¾‘ï¼Œå¹¶åˆ†æ•£è®¡ç®—è¿›è¡Œç»“æœæ±‚è§£ï¼Œæœ€åè¿›è¡Œç»„åˆ(å¾ˆåƒç°åœ¨å¤§æ•°æ®å¤„ç†é‡Œçš„ä¸€äº›æ¨¡å¼ï¼Œå¯ä»¥å‚è€ƒ)ï¼Œæˆ–é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å°†å¤§é‡çš„è®¡ç®—è¯·æ±‚åˆ†å‘åˆ°å…¶å®ƒçš„è®¡ç®—ç»“ç‚¹ä¸Šå»ã€‚ 3. é¡¹ç›®ä¸Šçº¿åï¼Œå¯¹æœåŠ¡èµ„æºè°ƒé…è¿›å¾—åˆç†çš„ä¼˜åŒ– ä¸Šçº¿åå¯¹æœåŠ¡èµ„æºéœ€è¦æŒç»­ç›‘æ§å¹¶æ ¹æ®ä¸šåŠ¡æ¨å¹¿å’Œå®é™…æƒ…å†µè¿›è¡Œä¼˜åŒ–å¤„ç†ã€‚ æ€è·¯ä¸Šè‡´ä¸Šä¹ŸåŒä¸Šè¿°æƒ…å†µã€‚ æ€»ç»“ å¾…å¤„ç†çš„æ•°æ®ç¦»CPUè¶Šè¿‘ï¼Œå¤„ç†è¶Šå¿«ã€‚ å¯åŠ¨çº¿ç¨‹æ•° = [ ä»»åŠ¡æ‰§è¡Œæ—¶é—´ / ( ä»»åŠ¡æ‰§è¡Œæ—¶é—´ - IOç­‰å¾…æ—¶é—´ ) ] x CPUå†…æ ¸æ•° æœ€ä½³å¯åŠ¨çº¿ç¨‹æ•° å’Œ CPUå†…æ ¸æ•°é‡ æˆæ­£æ¯”ï¼Œå’ŒIOé˜»å¡æ—¶é—´æˆåæ¯”ã€‚ å¦‚æœCPUè®¡ç®—å‹ä»»åŠ¡ï¼Œé‚£ä¹ˆçº¿ç¨‹æ•°æœ€å¤šä¸è¶…è¿‡CPUå†…æ ¸æ•°ï¼Œå› ä¸ºå¯åŠ¨å†å¤šçº¿ç¨‹ï¼ŒCPUä¹Ÿæ¥ä¸åŠè°ƒåº¦ï¼› ç›¸åå¦‚æœæ˜¯ä»»åŠ¡éœ€è¦ç­‰å¾…ç£ç›˜æ“ä½œï¼ˆå³IOå¯†é›†å‹ï¼‰ï¼Œç½‘ç»œå“åº”ï¼Œé‚£ä¹ˆå¤šå¯åŠ¨çº¿ç¨‹æœ‰åŠ©äºæé«˜ä»»åŠ¡å¹¶å‘åº¦ï¼Œæé«˜ç³»ç»Ÿååèƒ½åŠ›ï¼Œæ”¹å–„ç³»ç»Ÿæ€§èƒ½ã€‚</p><p>æ–‡ç« æ¥æºï¼š<a href="http://ju.outofmemory.cn/entry/214931" title="http://ju.outofmemory.cn/entry/214931">http://ju.outofmemory.cn/entry/214931</a></p>]]></content>
    
    
    <categories>
      
      <category>ä¸šåŠ¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ä¸šåŠ¡</tag>
      
      <tag>IO</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang mainå‡½æ•°å¼•å…¥åŒ…åˆå§‹åŒ–æµç¨‹</title>
    <link href="/2019/12/04/golang-main%E5%87%BD%E6%95%B0%E5%BC%95%E5%85%A5%E5%8C%85%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B/"/>
    <url>/2019/12/04/golang-main%E5%87%BD%E6%95%B0%E5%BC%95%E5%85%A5%E5%8C%85%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h4 id="mainå‡½æ•°å’Œinitå‡½æ•°"><a class="header-anchor" href="#mainå‡½æ•°å’Œinitå‡½æ•°"></a>mainå‡½æ•°å’Œinitå‡½æ•°</h4><p>mainå‡½æ•°å’Œinitå‡½æ•° Goé‡Œé¢æœ‰ä¸¤ä¸ªä¿ç•™çš„å‡½æ•°ï¼šinitå‡½æ•°ï¼ˆèƒ½å¤Ÿåº”ç”¨äºæ‰€æœ‰çš„packageï¼‰å’Œmainå‡½æ•°ï¼ˆåªèƒ½åº”ç”¨äºpackage mainï¼‰ã€‚è¿™ä¸¤ä¸ªå‡½æ•°åœ¨å®šä¹‰æ—¶ä¸èƒ½æœ‰ä»»ä½•çš„å‚æ•°å’Œè¿”å›å€¼ã€‚è™½ç„¶ä¸€ä¸ªpackageé‡Œé¢å¯ä»¥å†™ä»»æ„å¤šä¸ªinitå‡½æ•°ï¼Œä½†è¿™æ— è®ºæ˜¯å¯¹äºå¯è¯»æ€§è¿˜æ˜¯ä»¥åçš„å¯ç»´æŠ¤æ€§æ¥è¯´ï¼Œæˆ‘ä»¬éƒ½å¼ºçƒˆå»ºè®®ç”¨æˆ·åœ¨ä¸€ä¸ªpackageä¸­æ¯ä¸ªæ–‡ä»¶åªå†™ä¸€ä¸ªinitå‡½æ•°ã€‚ Goç¨‹åºä¼šè‡ªåŠ¨è°ƒç”¨init()å’Œmain()ï¼Œæ‰€ä»¥ä½ ä¸éœ€è¦åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°ã€‚æ¯ä¸ªpackageä¸­çš„initå‡½æ•°éƒ½æ˜¯å¯é€‰çš„ï¼Œä½†package mainå°±å¿…é¡»åŒ…å«ä¸€ä¸ªmainå‡½æ•°ã€‚ ç¨‹åºçš„åˆå§‹åŒ–å’Œæ‰§è¡Œéƒ½èµ·å§‹äºmainåŒ…ã€‚å¦‚æœmainåŒ…è¿˜å¯¼å…¥äº†å…¶å®ƒçš„åŒ…ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨ç¼–è¯‘æ—¶å°†å®ƒä»¬ä¾æ¬¡å¯¼å…¥ã€‚æœ‰æ—¶ä¸€ä¸ªåŒ…ä¼šè¢«å¤šä¸ªåŒ…åŒæ—¶å¯¼å…¥ï¼Œé‚£ä¹ˆå®ƒåªä¼šè¢«å¯¼å…¥ä¸€æ¬¡ï¼ˆä¾‹å¦‚å¾ˆå¤šåŒ…å¯èƒ½éƒ½ä¼šç”¨åˆ°fmtåŒ…ï¼Œä½†å®ƒåªä¼šè¢«å¯¼å…¥ä¸€æ¬¡ï¼Œå› ä¸ºæ²¡æœ‰å¿…è¦å¯¼å…¥å¤šæ¬¡ï¼‰ã€‚å½“ä¸€ä¸ªåŒ…è¢«å¯¼å…¥æ—¶ï¼Œå¦‚æœè¯¥åŒ…è¿˜å¯¼å…¥äº†å…¶å®ƒçš„åŒ…ï¼Œé‚£ä¹ˆä¼šå…ˆå°†å…¶å®ƒåŒ…å¯¼å…¥è¿›æ¥ï¼Œç„¶åå†å¯¹è¿™äº›åŒ…ä¸­çš„åŒ…çº§å¸¸é‡å’Œå˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œæ¥ç€æ‰§è¡Œinitå‡½æ•°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œä¾æ¬¡ç±»æ¨ã€‚ç­‰æ‰€æœ‰è¢«å¯¼å…¥çš„åŒ…éƒ½åŠ è½½å®Œæ¯•äº†ï¼Œå°±ä¼šå¼€å§‹å¯¹mainåŒ…ä¸­çš„åŒ…çº§å¸¸é‡å’Œå˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶åæ‰§è¡ŒmainåŒ…ä¸­çš„initå‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ï¼Œæœ€åæ‰§è¡Œmainå‡½æ•°ã€‚ä¸‹å›¾è¯¦ç»†åœ°è§£é‡Šäº†æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ï¼š <a href="https://raw.githubusercontent.com/astaxie/build-web-application-with-golang/master/zh/images/2.3.init.png" title="æµç¨‹å›¾"><img src="https://raw.githubusercontent.com/astaxie/build-web-application-with-golang/master/zh/images/2.3.init.png" alt="æµç¨‹å›¾" title="æµç¨‹å›¾"></a></p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>å‡½æ•°</tag>
      
      <tag>init</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>tomcatéƒ¨ç½²war</title>
    <link href="/2019/11/16/tomcat%E9%83%A8%E7%BD%B2war/"/>
    <url>/2019/11/16/tomcat%E9%83%A8%E7%BD%B2war/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åšGoogle assistant actionsä¸­çš„Implement Report State api è°ƒè¯•å·¥å…·ï¼ˆ<a href="https://github.com/actions-on-google/smart-home-dashboard" title="github">github</a>ï¼‰å®˜æ–¹åªç»™äº†javaç¯å¢ƒçš„tool,è®°å½•ä¸€ä¸‹æ­å»ºjava webç¯å¢ƒã€‚</p><h3 id="å®‰è£…javaç¯å¢ƒ"><a class="header-anchor" href="#å®‰è£…javaç¯å¢ƒ"></a>å®‰è£…javaç¯å¢ƒ</h3><p>å»å®˜ç½‘ä¸‹è½½jdkæœ€æ–°ç‰ˆï¼Œ<a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk11-downloads-5066655.html" title="ä¸‹è½½åœ°å€">ä¸‹è½½åœ°å€</a>ã€‚ æ–°å»ºæ–‡ä»¶ï¼š<code>mkdir java_eno</code>ï¼Œå°†ä¸‹è½½å¥½çš„jdkæ–‡ä»¶è§£å‹åˆ°æ­¤ã€‚ é…ç½®ç¯å¢ƒå˜é‡ï¼š</p><pre><code class="hljs shell">export JAVA_HOME=/root/javaeno/jdk-11.0.1export JAVA_BIN=/root/javaeno/jdk-11.0.1/binexport PATH=$PATH:$JAVA_HOME/binexport CLASSPATH=:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jarexport JAVA_HOME JAVA_BIN PATH CLASSPATHSPH</code></pre><h3 id="å®‰è£…tomcat"><a class="header-anchor" href="#å®‰è£…tomcat"></a>å®‰è£…tomcat</h3><p>å®˜æ–¹ä¸‹è½½tomcat <a href="http://tomcat.apache.org/" title="ä¸‹è½½åœ°å€">ä¸‹è½½åœ°å€</a>è§£å‹ï¼Œå¹¶è¿›å…¥ç›®å½•ã€‚ å°†dash.waré¡¹ç›®æ–‡ä»¶æ‹·è´åˆ°webappsæ–‡ä»¶å¤¹ä¸‹ï¼Œé…ç½®./conf/server.xmlåœ¨Hostæ ‡ç­¾å†…æ·»åŠ ä»¥ä¸‹è¯­å¥ã€‚</p><pre><code class="hljs markup">&lt;Context path&#x3D;&quot;&#x2F;&quot; docBase&#x3D;&quot;dash&quot; debug&#x3D;&quot;0&quot; reloadable&#x3D;&quot;true&quot; privileged&#x3D;&quot;true&quot;&#x2F;&gt;</code></pre><p>å¯åŠ¨tomcatè¿›ç¨‹</p><pre><code class="hljs shell">cd ../binsh startup.sh</code></pre><p>å‡ºç°è¿™æ ·ç•Œé¢è¯´æ˜æˆåŠŸ</p><pre><code class="hljs shell">Using CATALINA_BASE:   /root/javaeno/apache-tomcat-9.0.13Using CATALINA_HOME:   /root/javaeno/apache-tomcat-9.0.13Using CATALINA_TMPDIR: /root/javaeno/apache-tomcat-9.0.13/tempUsing JRE_HOME:        /root/javaeno/jdk-11.0.1Using CLASSPATH:       /root/javaeno/apache-tomcat-9.0.13/bin/bootstrap.jar:/root/javaeno/apache-tomcat-9.0.13/bin/tomcat-juli.jarTomcat started.</code></pre><p><a href="https://imgchr.com/i/ixrywT"><img src="https://s1.ax1x.com/2018/11/16/ixrywT.md.png" alt="ixrywT.md.png"></a></p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>tomcat</tag>
      
      <tag>war</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å½“æˆ‘ä»¬åœ¨è°ˆè®ºé«˜å¹¶å‘çš„æ—¶å€™ç©¶ç«Ÿåœ¨è°ˆä»€ä¹ˆ?</title>
    <link href="/2019/08/08/%E5%BD%93%E6%88%91%E4%BB%AC%E5%9C%A8%E8%B0%88%E8%AE%BA%E9%AB%98%E5%B9%B6%E5%8F%91%E7%9A%84%E6%97%B6%E5%80%99%E7%A9%B6%E7%AB%9F%E5%9C%A8%E8%B0%88%E4%BB%80%E4%B9%88/"/>
    <url>/2019/08/08/%E5%BD%93%E6%88%91%E4%BB%AC%E5%9C%A8%E8%B0%88%E8%AE%BA%E9%AB%98%E5%B9%B6%E5%8F%91%E7%9A%84%E6%97%B6%E5%80%99%E7%A9%B6%E7%AB%9F%E5%9C%A8%E8%B0%88%E4%BB%80%E4%B9%88/</url>
    
    <content type="html"><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯é«˜å¹¶å‘"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯é«˜å¹¶å‘"></a>ä»€ä¹ˆæ˜¯é«˜å¹¶å‘?</h3><pre><code class="hljs reasonml">é«˜å¹¶å‘æ˜¯äº’è”ç½‘åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„çš„æ€§èƒ½æŒ‡æ ‡ä¹‹ä¸€,å®ƒé€šå¸¸æ˜¯æŒ‡å•ä½æ—¶é—´å†…ç³»ç»Ÿèƒ½å¤ŸåŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°,ç®€å•ç‚¹è¯´ï¼Œå°±æ˜¯<span class="hljs-constructor">QPS(Queries <span class="hljs-params">per</span> <span class="hljs-params">second</span>)</span>ã€‚</code></pre><p>é‚£ä¹ˆæˆ‘ä»¬åœ¨è°ˆè®ºé«˜å¹¶å‘çš„æ—¶å€™ï¼Œç©¶ç«Ÿåœ¨è°ˆäº›ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ</p><h3 id="é«˜å¹¶å‘ç©¶ç«Ÿæ˜¯ä»€ä¹ˆ"><a class="header-anchor" href="#é«˜å¹¶å‘ç©¶ç«Ÿæ˜¯ä»€ä¹ˆ"></a>é«˜å¹¶å‘ç©¶ç«Ÿæ˜¯ä»€ä¹ˆ?</h3><p>è¿™é‡Œå…ˆç»™å‡ºç»“è®º:<br><code>é«˜å¹¶å‘</code> çš„åŸºæœ¬è¡¨ç°ä¸ºå•ä½æ—¶é—´å†…ç³»ç»Ÿèƒ½å¤ŸåŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°,<br><code>é«˜å¹¶å‘</code> çš„æ ¸å¿ƒæ˜¯å¯¹CPUèµ„æºçš„<strong>æœ‰æ•ˆå‹æ¦¨</strong>ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªå«åš <code>MD5ç©·ä¸¾</code> çš„åº”ç”¨ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½ä¼šæºå¸¦ä¸€ä¸ªmd5åŠ å¯†å­—ç¬¦ä¸²ï¼Œæœ€ç»ˆç³»ç»Ÿç©·ä¸¾å‡ºæ‰€æœ‰çš„ç»“æœï¼Œå¹¶è¿”å›åŸå§‹å­—ç¬¦ä¸²ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯æˆ–è€…è¯´åº”ç”¨ä¸šåŠ¡æ˜¯å±äº <code>CPUå¯†é›†å‹</code> è€Œä¸æ˜¯ <code>IOå¯†é›†å‹</code> ã€‚è¿™ä¸ªæ—¶å€™CPUä¸€ç›´åœ¨åšæœ‰æ•ˆè®¡ç®—ï¼Œç”šè‡³å¯ä»¥æŠŠCPUåˆ©ç”¨ç‡è·‘æ»¡ï¼Œè¿™æ—¶æˆ‘ä»¬è°ˆè®ºé«˜å¹¶å‘å¹¶æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚(å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ æœºå™¨ä¹Ÿå°±æ˜¯åŠ CPUæ¥æé«˜å¹¶å‘èƒ½åŠ›, è¿™ä¸ªæ˜¯ä¸€ä¸ªæ­£å¸¸çŒ¿éƒ½çŸ¥é“åºŸè¯æ–¹æ¡ˆï¼Œè°ˆè®ºåŠ æœºå™¨æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œæ²¡æœ‰ä»»ä½•é«˜å¹¶å‘æ˜¯åŠ æœºå™¨è§£å†³ä¸äº†ï¼Œå¦‚æœæœ‰, é‚£è¯´æ˜ä½ åŠ çš„æœºå™¨è¿˜ä¸å¤Ÿå¤š!ğŸ¶) <strong>å¯¹äºå¤§å¤šæ•°äº’è”ç½‘åº”ç”¨æ¥è¯´, CPUä¸æ˜¯ä¹Ÿä¸åº”è¯¥æ˜¯ç³»ç»Ÿçš„ç“¶é¢ˆï¼Œç³»ç»Ÿçš„å¤§éƒ¨åˆ†æ—¶é—´çš„çŠ¶å†µéƒ½æ˜¯CPUåœ¨ç­‰I/O (ç¡¬ç›˜/å†…å­˜/ç½‘ç»œ) çš„è¯»/å†™æ“ä½œå®Œæˆã€‚</strong> è¿™ä¸ªæ—¶å€™å°±å¯èƒ½æœ‰äººä¼šè¯´ï¼Œæˆ‘çœ‹ç³»ç»Ÿç›‘æ§çš„æ—¶å€™ï¼Œå†…å­˜å’Œç½‘ç»œéƒ½å¾ˆæ­£å¸¸ï¼Œä½†æ˜¯CPUåˆ©ç”¨ç‡å´è·‘æ»¡äº†è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p><pre><code class="hljs angelscript">è¿™æ˜¯ä¸€ä¸ªå¥½é—®é¢˜,åæ–‡æˆ‘ä¼šç»™å‡ºå®é™…çš„ä¾‹å­ï¼Œå†æ¬¡å¼ºè°ƒä¸Šæ–‡è¯´çš„ <span class="hljs-string">&#x27;æœ‰æ•ˆå‹æ¦¨&#x27;</span> è¿™<span class="hljs-number">4</span>ä¸ªå­—,è¿™<span class="hljs-number">4</span>ä¸ªå­—ä¼šå›´ç»•æœ¬æ–‡çš„å…¨éƒ¨å†…å®¹ï¼</code></pre><h3 id="æ§åˆ¶å˜é‡æ³•"><a class="header-anchor" href="#æ§åˆ¶å˜é‡æ³•"></a>æ§åˆ¶å˜é‡æ³•</h3><p>ä¸‡äº‹ä¸‡ç‰©éƒ½æ˜¯äº’ç›¸è”ç³»çš„ï¼Œå½“æˆ‘ä»¬åœ¨è°ˆè®ºé«˜å¹¶å‘çš„æ—¶å€™ï¼Œç³»ç»Ÿçš„æ¯ä¸ªç¯èŠ‚åº”è¯¥éƒ½æ˜¯éœ€è¦ä¸ä¹‹ç›¸åŒ¹é…çš„ã€‚æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹ä¸€ä¸ªç»å…¸C/Sçš„HTTPè¯·æ±‚æµç¨‹ã€‚ <img src="https://blog.wenboo.top/wp-content/uploads/2019/08/df5c480709f7ce803a381bf1d5a3b9e1.png" alt=""> å¦‚å›¾ä¸­çš„åºå·æ‰€ç¤º:<br>1 æˆ‘ä»¬ä¼šç»è¿‡DNSæœåŠ¡å™¨çš„è§£æï¼Œè¯·æ±‚åˆ°è¾¾è´Ÿè½½å‡è¡¡é›†ç¾¤<br>2 è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ä¼šæ ¹æ®é…ç½®çš„è§„åˆ™ï¼Œæƒ³è¯·æ±‚åˆ†æ‘Šåˆ°æœåŠ¡å±‚ã€‚æœåŠ¡å±‚ä¹Ÿæ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡æ ¸å¿ƒå±‚ï¼Œè¿™é‡Œå¯èƒ½ä¹Ÿä¼šæœ‰ä¸€äº›PRCã€MQçš„ä¸€äº›è°ƒç”¨ç­‰ç­‰<br>3 å†ç»è¿‡ç¼“å­˜å±‚<br>4 æœ€åæŒä¹…åŒ–æ•°æ®<br>5 è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯ è¦è¾¾åˆ°é«˜å¹¶å‘ï¼Œæˆ‘ä»¬éœ€è¦ è´Ÿè½½å‡è¡¡ã€æœåŠ¡å±‚ã€ç¼“å­˜å±‚ã€æŒä¹…å±‚ éƒ½æ˜¯é«˜å¯ç”¨ã€é«˜æ€§èƒ½çš„ï¼Œç”šè‡³åœ¨ç¬¬5æ­¥ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ å‹ç¼©é™æ€æ–‡ä»¶ã€HTTP2æ¨é€é™æ€æ–‡ä»¶ã€CDNæ¥åšä¼˜åŒ–ï¼Œè¿™é‡Œçš„æ¯ä¸€å±‚æˆ‘ä»¬éƒ½å¯ä»¥å†™å‡ æœ¬ä¹¦æ¥è°ˆä¼˜åŒ–ã€‚ æœ¬æ–‡ä¸»è¦è®¨è®ºæœåŠ¡å±‚è¿™ä¸€å—ï¼Œå³å›¾çº¢çº¿åœˆå‡ºæ¥çš„é‚£éƒ¨åˆ†ã€‚ä¸å†è€ƒè™‘è®²è¿°æ•°æ®åº“ã€ç¼“å­˜ç›¸å…³çš„å½±å“ã€‚<br>é«˜ä¸­çš„çŸ¥è¯†å‘Šè¯‰æˆ‘ä»¬ï¼Œè¿™ä¸ªå« <code>æ§åˆ¶å˜é‡æ³•</code> ã€‚</p><h3 id="å†è°ˆå¹¶å‘"><a class="header-anchor" href="#å†è°ˆå¹¶å‘"></a>å†è°ˆå¹¶å‘</h3><ul><li>ç½‘ç»œç¼–ç¨‹æ¨¡å‹çš„æ¼”å˜å†å² <img src="https://blog.wenboo.top/wp-content/uploads/2019/08/063de84c2e50c3d6f254dae32e872ea6.png" alt=""></li></ul><p>å¹¶å‘é—®é¢˜ä¸€ç›´æ˜¯æœåŠ¡ç«¯ç¼–ç¨‹ä¸­çš„é‡ç‚¹å’Œéš¾ç‚¹é—®é¢˜ï¼Œä¸ºäº†ä¼˜ç³»ç»Ÿçš„å¹¶å‘é‡ï¼Œä»æœ€åˆçš„Forkè¿›ç¨‹å¼€å§‹ï¼Œåˆ°è¿›ç¨‹æ± /çº¿ç¨‹æ± , å†åˆ°epolläº‹ä»¶é©±åŠ¨(Nginxã€node.jsåäººç±»å›è°ƒ), å†åˆ°åç¨‹ã€‚<br>ä»ä¸Šä¸­å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºï¼Œæ•´ä¸ªæ¼”å˜çš„è¿‡ç¨‹ï¼Œå°±æ˜¯å¯¹CPUæœ‰æ•ˆæ€§èƒ½å‹æ¦¨çš„è¿‡ç¨‹ã€‚<br>ä»€ä¹ˆ? ä¸æ˜æ˜¾?</p><ul><li>é‚£æˆ‘ä»¬å†è°ˆè°ˆä¸Šä¸‹æ–‡åˆ‡æ¢</li></ul><p>åœ¨è°ˆè®ºä¸Šä¸‹æ–‡åˆ‡æ¢ä¹‹å‰ï¼Œæˆ‘ä»¬å†æ˜ç¡®ä¸¤ä¸ªåè¯çš„æ¦‚å¿µã€‚<br><strong>å¹¶è¡Œï¼šä¸¤ä¸ªäº‹ä»¶åŒä¸€æ—¶åˆ»å®Œæˆã€‚</strong><br><strong>å¹¶å‘ï¼šä¸¤ä¸ªäº‹ä»¶åœ¨åŒä¸€æ—¶é—´æ®µå†…äº¤æ›¿å‘ç”Ÿ, ä»å®è§‚ä¸Šçœ‹ï¼Œä¸¤ä¸ªäº‹ä»¶éƒ½å‘ç”Ÿäº†</strong>ã€‚ çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè°ƒåº¦çš„æœ€å°å•ä½ï¼Œè¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚ç”±äºCPUæ˜¯ä¸²è¡Œçš„, å› æ­¤å¯¹äºå•æ ¸CPUæ¥è¯´, åŒä¸€æ—¶åˆ»ä¸€å®šæ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å ç”¨CPUèµ„æºçš„ã€‚å› æ­¤ï¼ŒLinuxä½œä¸ºä¸€ä¸ªå¤šä»»åŠ¡(è¿›ç¨‹)ç³»ç»Ÿï¼Œä¼šé¢‘ç¹çš„å‘ç”Ÿè¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢ã€‚ åœ¨æ¯ä¸ªä»»åŠ¡è¿è¡Œå‰ï¼ŒCPUéƒ½éœ€è¦çŸ¥é“ä»å“ªé‡ŒåŠ è½½ï¼Œä»å“ªé‡Œè¿è¡Œï¼Œè¿™äº›ä¿¡æ¯ä¿å­˜åœ¨ <code>CPUå¯„å­˜å™¨</code> å’Œæ“ä½œç³»ç»Ÿçš„ <code>ç¨‹åºè®¡æ•°å™¨</code> é‡Œé¢ï¼Œè¿™ä¸¤æ ·ä¸œè¥¿å°±å«åš <code>CPUä¸Šä¸‹æ–‡</code> ã€‚<br>è¿›ç¨‹æ˜¯ç”±å†…æ ¸æ¥ç®¡ç†å’Œè°ƒåº¦çš„ï¼Œè¿›ç¨‹çš„åˆ‡æ¢åªèƒ½å‘ç”Ÿåœ¨å†…æ ¸æ€ï¼Œå› æ­¤ è™šæ‹Ÿå†…å­˜ã€æ ˆã€å…¨å±€å˜é‡ç­‰ç”¨æˆ·ç©ºé—´çš„èµ„æºï¼Œä»¥åŠå†…æ ¸å †æ ˆã€å¯„å­˜å™¨ç­‰å†…æ ¸ç©ºé—´çš„çŠ¶æ€, å°±å«åš <code>è¿›ç¨‹ä¸Šä¸‹æ–‡</code> ã€‚<br>å‰é¢è¯´è¿‡, çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè°ƒåº¦çš„æœ€å°å•ä½ã€‚åŒæ—¶çº¿ç¨‹ä¼šå…±äº«çˆ¶è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å’Œå…¨å±€å˜é‡ç­‰èµ„æºï¼Œå› æ­¤ çˆ¶è¿›ç¨‹çš„èµ„æºåŠ ä¸Šçº¿ä¸Šè‡ªå·±çš„ç§æœ‰æ•°æ®å°±å«åš <code>çº¿ç¨‹çš„ä¸Šä¸‹æ–‡</code> ã€‚ å¯¹äºçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¥è¯´ï¼Œå¦‚æœæ˜¯åŒä¸€è¿›ç¨‹çš„çº¿ç¨‹ï¼Œå› ä¸ºæœ‰èµ„æºå…±äº«ï¼Œæ‰€ä»¥ä¼šæ¯”å¤šè¿›ç¨‹é—´çš„åˆ‡æ¢æ¶ˆè€—æ›´å°‘çš„èµ„æºã€‚ ç°åœ¨å°±æ›´å®¹æ˜“è§£é‡Šäº†ï¼Œè¿›ç¨‹å’Œçº¿ç¨‹çš„åˆ‡æ¢ï¼Œä¼šäº§ç”Ÿ <code>CPUä¸Šä¸‹æ–‡</code> åˆ‡æ¢å’Œ <code>è¿›ç¨‹/çº¿ç¨‹ä¸Šä¸‹æ–‡</code> çš„åˆ‡æ¢ã€‚è€Œè¿™äº› <code>ä¸Šä¸‹æ–‡åˆ‡æ¢</code> , éƒ½æ˜¯ä¼šæ¶ˆè€—é¢å¤–çš„CPUçš„èµ„æºçš„ã€‚</p><ul><li>è¿›ä¸€æ­¥è°ˆè°ˆåç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢</li></ul><p>é‚£ä¹ˆåç¨‹å°±ä¸éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢äº†å—ï¼Ÿéœ€è¦ï¼Œä½†æ˜¯<strong>ä¸ä¼šäº§ç”Ÿ</strong> <code>CPUä¸Šä¸‹æ–‡åˆ‡æ¢</code> å’Œ <code>è¿›ç¨‹/çº¿ç¨‹ä¸Šä¸‹æ–‡</code> çš„åˆ‡æ¢, å› ä¸ºè¿™äº›åˆ‡æ¢éƒ½æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œå³ç”¨æˆ·æ€ä¸­çš„åˆ‡æ¢ï¼Œ<strong>ä½ ç”šè‡³å¯ä»¥ç®€å•çš„ç†è§£ä¸º</strong>ï¼Œ <code>åç¨‹ä¸Šä¸‹æ–‡</code> ä¹‹é—´çš„åˆ‡æ¢ï¼Œå°±æ˜¯ç§»åŠ¨äº†ä¸€ä¸‹ä½ ç¨‹åºé‡Œé¢çš„æŒ‡é’ˆï¼ŒCPUèµ„æºä¾æ—§å±äºå½“å‰çº¿ç¨‹ã€‚<br>éœ€è¦æ·±åˆ»ç†è§£çš„ï¼Œå¯ä»¥å†æ·±å…¥çœ‹çœ‹Goçš„ <code>GMPæ¨¡å‹</code> ã€‚<br>æœ€ç»ˆçš„æ•ˆæœå°±æ˜¯åç¨‹<strong>è¿›ä¸€æ­¥å‹æ¦¨äº†CPUçš„æœ‰æ•ˆåˆ©ç”¨ç‡</strong>ã€‚</p><h3 id="å›åˆ°å¼€å§‹çš„é‚£ä¸ªé—®é¢˜"><a class="header-anchor" href="#å›åˆ°å¼€å§‹çš„é‚£ä¸ªé—®é¢˜"></a>å›åˆ°å¼€å§‹çš„é‚£ä¸ªé—®é¢˜</h3><pre><code class="hljs x86asm">è¿™ä¸ªæ—¶å€™å°±å¯èƒ½æœ‰äººä¼šè¯´ï¼Œæˆ‘çœ‹ç³»ç»Ÿç›‘æ§çš„æ—¶å€™ï¼Œå†…å­˜å’Œç½‘ç»œéƒ½å¾ˆæ­£å¸¸ï¼Œä½†æ˜¯<span class="hljs-meta">CPU</span>åˆ©ç”¨ç‡å´è·‘æ»¡äº†è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</code></pre><p>æ³¨æ„æœ¬ç¯‡æ–‡ç« åœ¨è°ˆåˆ°CPUåˆ©ç”¨ç‡çš„æ—¶å€™ï¼Œä¸€å®šä¼šåŠ ä¸Š <code>æœ‰æ•ˆ</code> ä¸¤å­—ä½œä¸ºå®šè¯­ï¼ŒCPUåˆ©ç”¨ç‡è·‘æ»¡ï¼Œå¾ˆå¤šæ—¶å€™å…¶å®æ˜¯åšäº†å¾ˆå¤šä½æ•ˆçš„è®¡ç®—ã€‚<br>ä»¥&quot;ä¸–ç•Œä¸Šæœ€å¥½çš„è¯­è¨€&quot;ä¸ºä¾‹ï¼Œå…¸å‹PHP-FPMçš„CGIæ¨¡å¼ï¼Œæ¯ä¸€ä¸ªHTTPè¯·æ±‚:<br>éƒ½ä¼šè¯»å–æ¡†æ¶çš„æ•°ç™¾ä¸ªphpæ–‡ä»¶ï¼Œ<br>éƒ½ä¼šé‡æ–°å»ºç«‹/é‡Šæ”¾ä¸€éMYSQL/REIDS/MQè¿æ¥ï¼Œ<br>éƒ½ä¼šé‡æ–°åŠ¨æ€è§£é‡Šç¼–è¯‘æ‰§è¡ŒPHPæ–‡ä»¶ï¼Œ<br>éƒ½ä¼šåœ¨ä¸åŒçš„php-fpmè¿›ç¨‹ç›´æ¥ä¸åœçš„åˆ‡æ¢åˆ‡æ¢å†åˆ‡æ¢ã€‚ phpçš„è¿™ç§<strong>CGIè¿è¡Œæ¨¡å¼</strong>ï¼Œæ ¹æœ¬ä¸Šå°±å†³å®šäº†å®ƒåœ¨é«˜å¹¶å‘ä¸Šçš„<strong>ç¾éš¾æ€§è¡¨ç°</strong>ã€‚ æ‰¾åˆ°é—®é¢˜ï¼Œå¾€å¾€æ¯”è§£å†³é—®é¢˜æ›´éš¾ã€‚å½“æˆ‘ä»¬ç†è§£äº† <code>å½“æˆ‘ä»¬åœ¨è°ˆè®ºé«˜å¹¶å‘ç©¶ç«Ÿåœ¨è°ˆä»€ä¹ˆ</code> ä¹‹å, æˆ‘ä»¬ä¼šå‘ç°é«˜å¹¶å‘å’Œé«˜æ€§èƒ½å¹¶ä¸æ˜¯ç¼–ç¨‹è¯­è¨€é™åˆ¶äº†ä½ ï¼Œé™åˆ¶ä½ çš„åªæ˜¯ä½ çš„æ€æƒ³ã€‚ æ‰¾åˆ°é—®é¢˜, è§£å†³é—®é¢˜ï¼å½“æˆ‘ä»¬èƒ½æœ‰æ•ˆå‹æ¦¨CPUæ€§èƒ½ä¹‹å, èƒ½è¾¾åˆ°ä»€ä¹ˆæ ·çš„æ•ˆæœ? ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ php+swooleçš„HTTPæœåŠ¡ ä¸ Javaé«˜æ€§èƒ½çš„å¼‚æ­¥æ¡†æ¶nettyçš„HTTPæœåŠ¡ä¹‹é—´çš„æ€§èƒ½å·®å¼‚å¯¹æ¯”ã€‚</p><h3 id="æ€§èƒ½å¯¹æ¯”å‰çš„å‡†å¤‡"><a class="header-anchor" href="#æ€§èƒ½å¯¹æ¯”å‰çš„å‡†å¤‡"></a>æ€§èƒ½å¯¹æ¯”å‰çš„å‡†å¤‡</h3><ul><li><a href="https://github.com/swoole/swoole-src/blob/master/README-CN.md">swooleæ˜¯ä»€ä¹ˆ</a></li></ul><pre><code class="hljs mathematica">Swooleæ˜¯ä¸€ä¸ªä¸ºPHPç”¨<span class="hljs-keyword">C</span>å’Œ<span class="hljs-keyword">C</span>++ç¼–å†™çš„åŸºäºäº‹ä»¶çš„é«˜æ€§èƒ½å¼‚æ­¥&amp;åç¨‹å¹¶è¡Œç½‘ç»œé€šä¿¡å¼•æ“</code></pre><ul><li><a href="https://github.com/netty/netty">Nettyæ˜¯ä»€ä¹ˆ</a></li></ul><pre><code class="hljs mipsasm">Nettyæ˜¯ç”±<span class="hljs-keyword">JBOSSæä¾›çš„ä¸€ä¸ªjavaå¼€æºæ¡†æ¶ã€‚ </span>Nettyæä¾›å¼‚æ­¥çš„ã€äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶å’Œå·¥å…·ï¼Œç”¨ä»¥å¿«é€Ÿå¼€å‘é«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç¨‹åºã€‚</code></pre><ul><li>å•æœºèƒ½å¤Ÿè¾¾åˆ°çš„æœ€å¤§HTTPè¿æ¥æ•°æ˜¯å¤šå°‘ï¼Ÿ</li></ul><p>å›å¿†ä¸€ä¸‹è®¡ç®—æœºç½‘ç»œçš„ç›¸å…³çŸ¥è¯†ï¼ŒHTTPåè®®æ˜¯åº”ç”¨å±‚åè®®ï¼Œåœ¨ä¼ è¾“å±‚ï¼Œæ¯ä¸ªTCPè¿æ¥å»ºç«‹ä¹‹å‰éƒ½ä¼šè¿›è¡Œä¸‰æ¬¡æ¡æ‰‹ã€‚<br>æ¯ä¸ªTCPè¿æ¥ç”± <code>æœ¬åœ°ip</code> , <code>æœ¬åœ°ç«¯å£</code> , <code>è¿œç«¯ip</code> , <code>è¿œç«¯ç«¯å£</code> , å››ä¸ªå±æ€§æ ‡è¯†ã€‚<br>TCPåè®®æŠ¥æ–‡å¤´å¦‚ä¸‹(å›¾ç‰‡æ¥è‡ª[ç»´åŸºç™¾ç§‘] <img src="https://blog.wenboo.top/wp-content/uploads/2019/08/ee29546d5bf6d0b6d707993895dc0e1f.png" alt=""> æœ¬åœ°ç«¯å£ç”±16ä½ç»„æˆ, å› æ­¤æœ¬åœ°ç«¯å£çš„æœ€å¤šæ•°é‡ä¸º 2^16 = 65535ä¸ªã€‚<br>è¿œç«¯ç«¯å£ç”±16ä½ç»„æˆ, å› æ­¤è¿œç«¯ç«¯å£çš„æœ€å¤šæ•°é‡ä¸º 2^16 = 65535ä¸ªã€‚<br>åŒæ—¶ï¼Œåœ¨linuxåº•å±‚çš„ç½‘ç»œç¼–ç¨‹æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªTCPè¿æ¥ï¼Œæ“ä½œç³»ç»Ÿéƒ½ä¼šç»´æŠ¤ä¸€ä¸ªFile descriptor(fd)æ–‡ä»¶æ¥ä¸ä¹‹å¯¹åº”ï¼Œè€Œfdçš„æ•°é‡é™åˆ¶ï¼Œå¯ä»¥ç”±ulimit -n å‘½ä»¤æŸ¥çœ‹å’Œä¿®æ”¹ï¼Œæµ‹è¯•ä¹‹å‰æˆ‘ä»¬å¯ä»¥æ‰§è¡Œå‘½ä»¤: ulimit -n 65536ä¿®æ”¹è¿™ä¸ªé™åˆ¶ä¸º65535ã€‚ å› æ­¤ï¼Œåœ¨ä¸è€ƒè™‘ç¡¬ä»¶èµ„æºé™åˆ¶çš„æƒ…å†µä¸‹ï¼Œ<br>æœ¬åœ°çš„æœ€å¤§HTTPè¿æ¥æ•°ä¸ºï¼š æœ¬åœ°æœ€å¤§ç«¯å£æ•°65535 * æœ¬åœ°ipæ•°1 = 65535 ä¸ªã€‚<br>è¿œç«¯çš„æœ€å¤§HTTPè¿æ¥æ•°ä¸ºï¼šè¿œç«¯æœ€å¤§ç«¯å£æ•°65535 * è¿œç«¯(å®¢æˆ·ç«¯)ipæ•°+âˆ = æ— é™åˆ¶ ã€‚<br>PS: å®é™…ä¸Šæ“ä½œç³»ç»Ÿä¼šæœ‰ä¸€äº›ä¿ç•™ç«¯å£å ç”¨, å› æ­¤æœ¬åœ°çš„è¿æ¥æ•°å®é™…ä¹Ÿæ˜¯è¾¾ä¸åˆ°ç†è®ºå€¼çš„ã€‚</p><h3 id="æ€§èƒ½å¯¹æ¯”"><a class="header-anchor" href="#æ€§èƒ½å¯¹æ¯”"></a>æ€§èƒ½å¯¹æ¯”</h3><ul><li>æµ‹è¯•èµ„æº</li></ul><p>å„ä¸€å°dockerå®¹å™¨, 1Gå†…å­˜+2æ ¸CPU, å¦‚å›¾æ‰€ç¤º: <img src="https://blog.wenboo.top/wp-content/uploads/2019/08/68912769c79112a6a52b5d16053b1230.png" alt=""> docker-composeç¼–æ’å¦‚ä¸‹:</p><pre><code class="hljs java"># java8version: <span class="hljs-string">&quot;2.2&quot;</span>services:  java8:    container_name: <span class="hljs-string">&quot;java8&quot;</span>    hostname: <span class="hljs-string">&quot;java8&quot;</span>    image: <span class="hljs-string">&quot;java:8&quot;</span>    volumes:      - /home/cg/MyApp:/MyApp    ports:      - <span class="hljs-string">&quot;5555:8080&quot;</span>    environment:      - TZ=Asia/Shanghai    working_dir: /MyApp    cpus: <span class="hljs-number">2</span>    cpuset: <span class="hljs-number">0</span>,<span class="hljs-number">1</span>    mem_limit: <span class="hljs-number">1024</span>m    memswap_limit: <span class="hljs-number">1024</span>m    mem_reservation: <span class="hljs-number">1024</span>m    tty: <span class="hljs-keyword">true</span># php7-swversion: <span class="hljs-string">&quot;2.2&quot;</span>services:  php7-sw:    container_name: <span class="hljs-string">&quot;php7-sw&quot;</span>    hostname: <span class="hljs-string">&quot;php7-sw&quot;</span>    image: <span class="hljs-string">&quot;mileschou/swoole:7.1&quot;</span>    volumes:      - /home/cg/MyApp:/MyApp    ports:      - <span class="hljs-string">&quot;5551:8080&quot;</span>    environment:      - TZ=Asia/Shanghai    working_dir: /MyApp    cpus: <span class="hljs-number">2</span>    cpuset: <span class="hljs-number">0</span>,<span class="hljs-number">1</span>    mem_limit: <span class="hljs-number">1024</span>m    memswap_limit: <span class="hljs-number">1024</span>m    mem_reservation: <span class="hljs-number">1024</span>m    tty: <span class="hljs-keyword">true</span></code></pre><ul><li>phpä»£ç </li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-keyword">use</span> <span class="hljs-title">Swoole</span>\<span class="hljs-title">Server</span>;<span class="hljs-keyword">use</span> <span class="hljs-title">Swoole</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Response</span>;$http = <span class="hljs-keyword">new</span> swoole_http_server(<span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-number">8080</span>);$http-&gt;set([    <span class="hljs-string">&#x27;worker_num&#x27;</span> =&gt; <span class="hljs-number">2</span>]);$http-&gt;on(<span class="hljs-string">&quot;request&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$request, Response $response</span>) </span>&#123;    <span class="hljs-comment">//go(function () use ($response) &#123;</span>        <span class="hljs-comment">// Swoole\Coroutine::sleep(0.01);</span>        $response-&gt;end(<span class="hljs-string">&#x27;Hello World&#x27;</span>);    <span class="hljs-comment">//&#125;);</span>&#125;);$http-&gt;on(<span class="hljs-string">&quot;start&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Server $server</span>) </span>&#123;    go(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) <span class="hljs-title">use</span> (<span class="hljs-params">$server</span>) </span>&#123;        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;server listen on 0.0.0.0:8080 \n&quot;</span>;    &#125;);&#125;);$http-&gt;start();</code></pre><ul><li>Javaå…³é”®ä»£ç </li></ul><p>æºä»£ç æ¥è‡ª, <a href="https://github.com/netty/netty/tree/4.1/example/src/main/java/io/netty/example/http/helloworld"></a><a href="https://github.com/netty/netty">https://github.com/netty/netty</a></p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">// Configure SSL.</span>        <span class="hljs-keyword">final</span> SslContext sslCtx;        <span class="hljs-keyword">if</span> (SSL) &#123;            SelfSignedCertificate ssc = <span class="hljs-keyword">new</span> SelfSignedCertificate();            sslCtx = SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey()).build();        &#125; <span class="hljs-keyword">else</span> &#123;            sslCtx = <span class="hljs-keyword">null</span>;        &#125;        <span class="hljs-comment">// Configure the server.</span>        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(<span class="hljs-number">2</span>);        EventLoopGroup workerGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();        <span class="hljs-keyword">try</span> &#123;            ServerBootstrap b = <span class="hljs-keyword">new</span> ServerBootstrap();            b.option(ChannelOption.SO_BACKLOG, <span class="hljs-number">1024</span>);            b.group(bossGroup, workerGroup)             .channel(NioServerSocketChannel.class)             .handler(<span class="hljs-keyword">new</span> LoggingHandler(LogLevel.INFO))             .childHandler(<span class="hljs-keyword">new</span> HttpHelloWorldServerInitializer(sslCtx));            Channel ch = b.bind(PORT).sync().channel();            System.err.println(<span class="hljs-string">&quot;Open your web browser and navigate to &quot;</span> +                    (SSL? <span class="hljs-string">&quot;https&quot;</span> : <span class="hljs-string">&quot;http&quot;</span>) + <span class="hljs-string">&quot;://127.0.0.1:&quot;</span> + PORT + <span class="hljs-string">&#x27;/&#x27;</span>);            ch.closeFuture().sync();        &#125; <span class="hljs-keyword">finally</span> &#123;            bossGroup.shutdownGracefully();            workerGroup.shutdownGracefully();        &#125;    &#125;</code></pre><p>å› ä¸ºæˆ‘åªç»™äº†ä¸¤ä¸ªæ ¸å¿ƒçš„CPUèµ„æºï¼Œæ‰€ä»¥ä¸¤ä¸ªæœåŠ¡å‡åªå¼€å¯è¿ä¸ªworkè¿›ç¨‹å³å¯ã€‚<br>5551ç«¯å£è¡¨ç¤ºPHPæœåŠ¡ã€‚<br>5555ç«¯å£è¡¨ç¤ºJavaæœåŠ¡ã€‚</p><ul><li><strong>å‹æµ‹å·¥å…·ç»“æœå¯¹æ¯”ï¼šApacheBench (ab)</strong></li></ul><p>abå‘½ä»¤: docker run --rm jordi/ab -k -c 1000 -n 1000000 <a href="http://10.234.3.32/">http://10.234.3.32</a>:5555/<br>åœ¨å¹¶å‘1000è¿›è¡Œ100ä¸‡æ¬¡Httpè¯·æ±‚çš„åŸºå‡†æµ‹è¯•ä¸­, Java + netty å‹æµ‹ç»“æœ:</p><p><img src="https://blog.wenboo.top/wp-content/uploads/2019/08/5cddd35457798b40a264e8fa287897cb.png" alt=""> <img src="https://blog.wenboo.top/wp-content/uploads/2019/08/48abd33b72ae27cdb16ccf5959855f6c.png" alt=""> PHP + swoole å‹æµ‹ç»“æœ: <img src="https://blog.wenboo.top/wp-content/uploads/2019/08/4ed68e6f88d7fd8990319a8676cf2d59.png" alt=""> <img src="https://blog.wenboo.top/wp-content/uploads/2019/08/16433ba6d6323592e0fbb98dd422ba55.png" alt=""></p><table><thead><tr><th>æœåŠ¡</th><th>QPS</th><th>å“åº”æ—¶é—´ms(max, min)</th><th>å†…å­˜(MB)</th></tr></thead><tbody><tr><td>Java + netty</td><td>84042.11</td><td>(11, 25)</td><td>600+</td></tr><tr><td>php + swoole</td><td>87222.98</td><td>(9, 25)</td><td>30+</td></tr></tbody></table><p>ps: ä¸Šå›¾é€‰æ‹©çš„æ˜¯ä¸‰æ¬¡å‹æµ‹ä¸‹çš„æœ€ä½³ç»“æœã€‚ æ€»çš„æ¥è¯´ï¼Œæ€§èƒ½å·®å¼‚å¹¶ä¸å¤§ï¼ŒPHP+swooleçš„æœåŠ¡ç”šè‡³æ¯”Java+nettyçš„æœåŠ¡è¿˜è¦ç¨å¾®å¥½ä¸€ç‚¹ï¼Œç‰¹åˆ«æ˜¯åœ¨å†…å­˜å ç”¨æ–¹é¢ï¼Œjavaç”¨äº†600MB, phpåªç”¨äº†30MBã€‚<br>è¿™èƒ½è¯´æ˜ä»€ä¹ˆå‘¢ï¼Ÿ<br>æ²¡æœ‰IOé˜»å¡æ“ä½œ, ä¸ä¼šå‘ç”Ÿåç¨‹åˆ‡æ¢ã€‚<br>è¿™ä¸ªä»…ä»…åªèƒ½è¯´æ˜ å¤šçº¿ç¨‹+epollçš„æ¨¡å¼ä¸‹, æœ‰æ•ˆçš„å‹æ¦¨CPUæ€§èƒ½ï¼Œä½ ç”šè‡³ç”¨PHPéƒ½èƒ½å†™å‡ºé«˜å¹¶å‘å’Œé«˜æ€§èƒ½çš„æœåŠ¡ã€‚</p><h3 id="æ€§èƒ½å¯¹æ¯”â€”â€”è§è¯å¥‡è¿¹çš„æ—¶åˆ»"><a class="header-anchor" href="#æ€§èƒ½å¯¹æ¯”â€”â€”è§è¯å¥‡è¿¹çš„æ—¶åˆ»"></a>æ€§èƒ½å¯¹æ¯”â€”â€”è§è¯å¥‡è¿¹çš„æ—¶åˆ»</h3><p>ä¸Šé¢ä»£ç å…¶å®å¹¶æ²¡æœ‰å±•ç°å‡ºåç¨‹çš„ä¼˜ç§€æ€§èƒ½ï¼Œå› ä¸ºæ•´ä¸ªè¯·æ±‚æ²¡æœ‰é˜»å¡æ“ä½œ, ä½†å¾€å¾€æˆ‘ä»¬çš„åº”ç”¨ä¼šä¼´éšç€ä¾‹å¦‚ æ–‡æ¡£è¯»å–ã€DBè¿æ¥/æŸ¥è¯¢ ç­‰å„ç§é˜»å¡æ“ä½œ, ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹åŠ ä¸Šé˜»å¡æ“ä½œå, å‹æµ‹ç»“æœå¦‚ä½•ã€‚<br>Javaå’ŒPHPä»£ç ä¸­, æˆ‘éƒ½åˆ†åˆ«åŠ ä¸Š <code>sleep(0.01) //ç§’</code> çš„ä»£ç ï¼Œæ¨¡æ‹Ÿ0.01ç§’çš„ç³»ç»Ÿè°ƒç”¨é˜»å¡ã€‚<br>ä»£ç å°±ä¸å†é‡å¤è´´ä¸Šæ¥äº†ã€‚ å¸¦IOé˜»å¡æ“ä½œçš„ Java + netty å‹æµ‹ç»“æœ:</p><p><img src="https://blog.wenboo.top/wp-content/uploads/2019/08/ae6764e385f1a3e730049d1e74fa38e3.png" alt=""> å¤§æ¦‚10åˆ†é’Ÿæ‰èƒ½è·‘å®Œæ‰€æœ‰å‹æµ‹ã€‚ã€‚ã€‚ å¸¦IOé˜»å¡æ“ä½œçš„ PHP + swoole å‹æµ‹ç»“æœ: <img src="https://blog.wenboo.top/wp-content/uploads/2019/08/517f4f7aad9edb3d98160d6f8322a3ff.png" alt=""></p><table><thead><tr><th>æœåŠ¡</th><th>QPS</th><th>å“åº”æ—¶é—´ms(max, min)</th><th>å†…å­˜(MB)</th></tr></thead><tbody><tr><td>Java + netty</td><td>1562.69</td><td>(52, 160)</td><td>100+</td></tr><tr><td>php + swoole</td><td>9745.20</td><td>(9, 25)</td><td>30+</td></tr></tbody></table><p>ä»ç»“æœä¸­å¯ä»¥çœ‹å‡º, åŸºäºåç¨‹çš„php+ swooleæœåŠ¡æ¯” Java + nettyæœåŠ¡çš„QPSé«˜äº†6å€ã€‚ å½“ç„¶ï¼Œè¿™ä¸¤ä¸ªæµ‹è¯•ä»£ç éƒ½æ˜¯å®˜æ–¹demoä¸­çš„æºä»£ç ï¼Œè‚¯å®šè¿˜æœ‰å¾ˆå¤šå¯ä»¥ä¼˜åŒ–çš„é…ç½®ï¼Œä¼˜åŒ–ä¹‹åï¼Œç»“æœè‚¯å®šä¹Ÿä¼šå¥½å¾ˆå¤šã€‚ å¯ä»¥å†æ€è€ƒä¸‹ï¼Œä¸ºä»€ä¹ˆå®˜æ–¹é»˜è®¤çº¿ç¨‹/è¿›ç¨‹æ•°é‡ä¸è®¾ç½®çš„æ›´å¤šä¸€ç‚¹å‘¢ï¼Ÿ<br>è¿›ç¨‹/çº¿ç¨‹æ•°é‡å¯ä¸æ˜¯è¶Šå¤šè¶Šå¥½å“¦ï¼Œå‰é¢æˆ‘ä»¬å·²ç»è®¨è®ºè¿‡äº†ï¼Œåœ¨è¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢çš„æ—¶å€™ï¼Œä¼šäº§ç”Ÿé¢å¤–çš„CPUèµ„æºèŠ±é”€ï¼Œç‰¹åˆ«æ˜¯åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´åˆ‡æ¢çš„æ—¶å€™ï¼ <strong>å¯¹äºè¿™äº›å‹æµ‹ç»“æœæ¥è¯´ï¼Œæˆ‘å¹¶ä¸æ˜¯é’ˆå¯¹Java, æˆ‘æ˜¯æŒ‡ åªè¦æ˜ç™½äº†é«˜å¹¶å‘çš„æ ¸å¿ƒæ˜¯ä»€ä¹ˆ, æ‰¾åˆ°è¿™ä¸ªç›®æ ‡ï¼Œæ— è®ºç”¨ä»€ä¹ˆç¼–ç¨‹è¯­è¨€ï¼Œåªè¦é’ˆå¯¹CPUåˆ©ç”¨ç‡åšæœ‰æ•ˆçš„ä¼˜åŒ–(è¿æ¥æ± ã€å®ˆæŠ¤è¿›ç¨‹ã€å¤šçº¿ç¨‹ã€åç¨‹ã€selectè½®è¯¢ã€epolläº‹ä»¶é©±åŠ¨)ï¼Œä½ ä¹Ÿèƒ½æ­å»ºå‡ºä¸€ä¸ªé«˜å¹¶å‘å’Œé«˜æ€§èƒ½çš„ç³»ç»Ÿã€‚</strong> æ–‡ç« è½¬è‡ªï¼š<a href="https://segmentfault.com/a/1190000019360335" title="https://segmentfault.com/a/1190000019360335">https://segmentfault.com/a/1190000019360335</a></p>]]></content>
    
    
    <categories>
      
      <category>project</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é«˜å¹¶å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>python  uWSGIã€WSGIå’Œuwsgi</title>
    <link href="/2019/07/18/python-uwsgi%E3%80%81wsgi%E5%92%8Cuwsgi/"/>
    <url>/2019/07/18/python-uwsgi%E3%80%81wsgi%E5%92%8Cuwsgi/</url>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨ç†è§£äº†PHPçš„è¿è¡Œæ–¹å¼å’Œ<strong>php-fpmã€fastcgiã€cgi</strong>ç­‰è¿™äº›æ¦‚å¿µä¹‹åï¼Œåœ¨å­¦ä¹ pythonæ—¶ä¹Ÿä¼šæƒ³èµ·ï¼ŒPythonä½œä¸ºå’ŒPHPä¸€æ ·çš„ä¸éœ€è¦ç¼–è¯‘çš„<strong>åŠ¨æ€è§£é‡Šå‹è¯­è¨€</strong>åœ¨å·¥ä½œæ—¶çš„æ–¹å¼ï¼Œæ˜¯ä¸æ˜¯æœ‰ç±»ä¼¼äºå’ŒPHPé‚£äº›è½¯ä»¶å’Œåè®®å‘¢ï¼ä¸‹é¢å†…å®¹æ¥å­¦ä¹ ä¸€ä¸‹Pythonä¸­çš„uWSGIã€WSGIå’Œuwsgiã€‚</p><p><strong>é¦–å…ˆæ¥çœ‹å‡ å¼ å›¾ç‰‡ï¼š</strong> <img src="https://blog.wenboo.top/wp-content/uploads/2019/07/cd4b873f4d5447c91bd4d97d10f28b0d.png" alt=""> <img src="https://blog.wenboo.top/wp-content/uploads/2019/07/967ecfd077e1c4077f8b210de5da49ea.png" alt=""> å›¾ç‰‡æ¥è‡ªï¼š<a href="https://www.cnblogs.com/wspblog/p/8575101.html" title="https://www.cnblogs.com/wspblog/p/8575101.html">https://www.cnblogs.com/wspblog/p/8575101.html</a></p><h3 id="WSGI-Web-Server-Gateway-Interface"><a class="header-anchor" href="#WSGI-Web-Server-Gateway-Interface"></a>WSGI(Web Server Gateway Interface)</h3><p>ä»å­—é¢ä¸Šæˆ‘çŸ¥é“è¿™ä¸ªä¸œè¥¿å«åš<strong>webæœåŠ¡å™¨ç½‘å…³æ¥å£</strong>ï¼Œè”æƒ³åˆ°PHPçš„php-cgiæ˜¯ä¸€ç§webæœåŠ¡å™¨å’Œåº”ç”¨ç¨‹åºè¿›è¡Œäº¤äº’çš„åè®®æˆ–æ¥å£ï¼ŒWSGIæˆ‘æŠŠå®ƒç†è§£ä¸ºpythonç‰ˆçš„fastcigï¼Œå®ƒå®ç°äº†æ ‡å‡†çš„CGIåè®®ã€‚<strong>WSGIæ˜¯Web æœåŠ¡å™¨(uWSGI)ä¸ Web åº”ç”¨ç¨‹åºæˆ–åº”ç”¨æ¡†æ¶(Django)ä¹‹é—´çš„ä¸€ç§ä½çº§åˆ«çš„æ¥å£</strong>ã€‚</p><h3 id="uWSGI"><a class="header-anchor" href="#uWSGI"></a>uWSGI</h3><p>å®ƒå’Œnginxã€Apacheä¸€æ ·æ˜¯ä¸€ä¸ªwebæœåŠ¡å™¨ï¼Œå¹¶ä¸”å®ƒèƒ½å¤Ÿå°†HTTPåè®®è½¬æ¢æˆå…¶ä»–åè®®ï¼Œæ¯”å¦‚è½¬æ¢æˆWSGIå’Œpythonåº”ç”¨ç¨‹åºäº¤äº’ã€‚ä½†æ˜¯æœ‰ä¸ªç–‘é—®ï¼ŸuWSGIå·²ç»æ˜¯webæœåŠ¡å™¨äº†ä¸ºä»€ä¹ˆæˆ‘ä»¬å¸¸è§çš„æ¶æ„è¿˜éœ€è¦Apacheå’Œnginxè¿™ç±»çš„æœåŠ¡å™¨è½¯ä»¶å‚ä¸ï¼Œå› ä¸ºuWSGIè¿è¡Œæ•ˆç‡å¤ªä½ï¼Œæ€§èƒ½å·®ç›´æ¥ä½¿ç”¨uWSGIæ¥æ­å»ºwebæœåŠ¡å™¨æ‰›ä¸äº†å¹¶å‘ï¼Œè€Œä¸”åƒnginxè¿™ç±»webæœåŠ¡å™¨æ”¯æŒåå‘ä»£ç†ï¼Œåšè´Ÿè½½å‡è¡¡æ°´å¹³æ‹“å±•éå¸¸æ–¹ä¾¿ã€‚</p><h3 id="uwsgi"><a class="header-anchor" href="#uwsgi"></a>uwsgi</h3><p>ä¸WSGIä¸€æ ·ï¼Œæ˜¯uWSGIæœåŠ¡å™¨çš„ç‹¬å é€šä¿¡åè®®ï¼Œç”¨äºå®šä¹‰ä¼ è¾“ä¿¡æ¯çš„ç±»å‹(type of information)ã€‚æ¯ä¸€ä¸ªuwsgi packetå‰4byteä¸ºä¼ è¾“ä¿¡æ¯ç±»å‹çš„æè¿°ï¼Œä¸WSGIåè®®æ˜¯ä¸¤ç§ä¸œè¥¿ï¼Œæ®è¯´è¯¥åè®®æ˜¯fcgiåè®®çš„10å€å¿«ã€‚</p><h3 id="Djangoã€Tornado"><a class="header-anchor" href="#Djangoã€Tornado"></a>Djangoã€Tornado</h3><p>è¿™äº›éƒ½æ˜¯<strong>python</strong>çš„webå¼€å‘æ¡†æ¶ï¼Œå®ƒä»¬ä¹‹æ‰€ä»¥èƒ½å¤Ÿç›´æ¥æ¥æ”¶HTTPåè®®ï¼Œæ˜¯å› ä¸ºå†…ç½®äº†è½»é‡çº§çš„webæœåŠ¡å™¨ï¼Œä½†æ˜¯æ€§èƒ½å’Œå®‰å…¨æ–¹é¢ä¸èƒ½å¤Ÿä¿è¯ï¼Œå®˜æ–¹å»ºè®®ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>python</tag>
      
      <tag>uWSGI</tag>
      
      <tag>WSGI</tag>
      
      <tag>uwsgi</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CGIã€FastCGIå’ŒPHP-FPMå…³ç³»å›¾è§£</title>
    <link href="/2019/07/18/cgi%E3%80%81fastcgi%E5%92%8Cphp-fpm%E5%85%B3%E7%B3%BB%E5%9B%BE%E8%A7%A3/"/>
    <url>/2019/07/18/cgi%E3%80%81fastcgi%E5%92%8Cphp-fpm%E5%85%B3%E7%B3%BB%E5%9B%BE%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<p>åœ¨æ­å»º LAMP/LNMP æœåŠ¡å™¨æ—¶ï¼Œä¼šç»å¸¸é‡åˆ° PHP-FPMã€FastCGIå’ŒCGI è¿™å‡ ä¸ªæ¦‚å¿µã€‚å¦‚æœå¯¹å®ƒä»¬ä¸€çŸ¥åŠè§£ï¼Œå¾ˆéš¾æ­å»ºå‡ºé«˜æ€§èƒ½çš„æœåŠ¡å™¨ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä»¥å›¾å½¢æ–¹å¼ï¼Œè§£é‡Šè¿™äº›æ¦‚å¿µä¹‹é—´çš„å…³ç³»ã€‚</p><h2 id="åŸºç¡€"><a class="header-anchor" href="#åŸºç¡€"></a>åŸºç¡€</h2><p>åœ¨æ•´ä¸ªç½‘ç«™æ¶æ„ä¸­ï¼ŒWeb Serverï¼ˆå¦‚Apacheï¼‰åªæ˜¯å†…å®¹çš„åˆ†å‘è€…ã€‚ä¸¾ä¸ªæ —å­ï¼Œå¦‚æœå®¢æˆ·ç«¯è¯·æ±‚çš„æ˜¯ index.htmlï¼Œé‚£ä¹ˆWeb Serverä¼šå»æ–‡ä»¶ç³»ç»Ÿä¸­æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶ï¼Œå‘é€ç»™æµè§ˆå™¨ï¼Œè¿™é‡Œåˆ†å‘çš„æ˜¯é™æ€æ•°æ®ã€‚ <a href="https://www.awaimai.com/wp-content/uploads/2018/03/html.png"><img src="https://www.awaimai.com/wp-content/uploads/2018/03/html.png" alt=""></a> å¦‚æœè¯·æ±‚çš„æ˜¯ index.phpï¼Œæ ¹æ®é…ç½®æ–‡ä»¶ï¼ŒWeb ServerçŸ¥é“è¿™ä¸ªä¸æ˜¯é™æ€æ–‡ä»¶ï¼Œéœ€è¦å»æ‰¾ PHP è§£æå™¨æ¥å¤„ç†ï¼Œé‚£ä¹ˆä»–ä¼šæŠŠè¿™ä¸ªè¯·æ±‚ç®€å•å¤„ç†ï¼Œç„¶åäº¤ç»™PHPè§£æå™¨ã€‚ <a href="https://www.awaimai.com/wp-content/uploads/2018/03/cgi.png"><img src="https://www.awaimai.com/wp-content/uploads/2018/03/cgi.png" alt=""></a> å½“Web Serveræ”¶åˆ° index.php è¿™ä¸ªè¯·æ±‚åï¼Œä¼šå¯åŠ¨å¯¹åº”çš„ CGI ç¨‹åºï¼Œè¿™é‡Œå°±æ˜¯PHPçš„è§£æå™¨ã€‚æ¥ä¸‹æ¥PHPè§£æå™¨ä¼šè§£æphp.iniæ–‡ä»¶ï¼Œåˆå§‹åŒ–æ‰§è¡Œç¯å¢ƒï¼Œç„¶åå¤„ç†è¯·æ±‚ï¼Œå†ä»¥è§„å®šCGIè§„å®šçš„æ ¼å¼è¿”å›å¤„ç†åçš„ç»“æœï¼Œé€€å‡ºè¿›ç¨‹ï¼ŒWeb serverå†æŠŠç»“æœè¿”å›ç»™æµè§ˆå™¨ã€‚è¿™å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„åŠ¨æ€PHP Webè®¿é—®æµç¨‹ï¼Œæ¥ä¸‹æ¥å†å¼•å‡ºè¿™äº›æ¦‚å¿µï¼Œå°±å¥½ç†è§£å¤šäº†ï¼Œ</p><ul><li>**CGIï¼š**æ˜¯ Web Server ä¸ Web Application ä¹‹é—´æ•°æ®äº¤æ¢çš„ä¸€ç§åè®®ã€‚</li><li>**FastCGIï¼š**åŒ CGIï¼Œæ˜¯ä¸€ç§é€šä¿¡åè®®ï¼Œä½†æ¯” CGI åœ¨æ•ˆç‡ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–ã€‚åŒæ ·ï¼ŒSCGI åè®®ä¸ FastCGI ç±»ä¼¼ã€‚</li><li>**PHP-CGIï¼š**æ˜¯ PHP ï¼ˆWeb Applicationï¼‰å¯¹ Web Server æä¾›çš„ CGI åè®®çš„æ¥å£ç¨‹åºã€‚</li><li>**PHP-FPMï¼š**æ˜¯ PHPï¼ˆWeb Applicationï¼‰å¯¹ Web Server æä¾›çš„ FastCGI åè®®çš„æ¥å£ç¨‹åºï¼Œé¢å¤–è¿˜æä¾›äº†ç›¸å¯¹æ™ºèƒ½ä¸€äº›ä»»åŠ¡ç®¡ç†ã€‚</li></ul><p>WEB ä¸­ï¼Œ</p><ul><li>Web Server ä¸€èˆ¬æŒ‡Apacheã€Nginxã€IISã€Lighttpdã€Tomcatç­‰æœåŠ¡å™¨ï¼Œ</li><li>Web Application ä¸€èˆ¬æŒ‡PHPã€Javaã€Asp.netç­‰åº”ç”¨ç¨‹åºã€‚</li></ul><h2 id="Moduleæ–¹å¼"><a class="header-anchor" href="#Moduleæ–¹å¼"></a>Moduleæ–¹å¼</h2><p>åœ¨äº†è§£ CGI ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹Web server ä¼ é€’æ•°æ®çš„å¦å¤–ä¸€ç§æ–¹æ³•ï¼š<strong>PHP ModuleåŠ è½½æ–¹å¼</strong>ã€‚ä»¥ Apache ä¸ºä¾‹ï¼Œåœ¨PHP Moduleæ–¹å¼ä¸­ï¼Œæ˜¯ä¸æ˜¯åœ¨ Apache çš„é…ç½®æ–‡ä»¶ httpd.conf ä¸­åŠ ä¸Šè¿™æ ·å‡ å¥ï¼š</p><p># åŠ å…¥ä»¥ä¸‹2å¥LoadModule php5_module D:/php/php5apache2_2.dll<br>AddType application/x-httpd-php .php</p><h1>ä¿®æ”¹å¦‚ä¸‹å†…å®¹</h1><p>DirectoryIndex index.php index.html</p><p>ä¸Šé¢æ˜¯ Windows ä¸‹å®‰è£…phpå’Œapacheç¯å¢ƒåæ‰‹åŠ¨é…ç½®ï¼Œåœ¨linuxä¸‹æºç å®‰è£…å¤§è‡´æ˜¯è¿™æ ·é…ç½®çš„ï¼š</p><p># ./configure --with-mysql=/usr/local --with-apache=/usr/local/apache --enable-track-vars</p><p>æ‰€ä»¥ï¼Œè¿™ç§æ–¹å¼ï¼Œä»–ä»¬çš„å…±åŒæœ¬è´¨éƒ½æ˜¯ç”¨ LoadModule æ¥åŠ è½½ php5_moduleï¼Œå°±æ˜¯<strong>æŠŠphpä½œä¸ºapacheçš„ä¸€ä¸ªå­æ¨¡å—æ¥è¿è¡Œ</strong>ã€‚å½“é€šè¿‡webè®¿é—®phpæ–‡ä»¶æ—¶ï¼Œapacheå°±ä¼šè°ƒç”¨php5_moduleæ¥è§£æphpä»£ç ã€‚ é‚£ä¹ˆphp5_moduleæ˜¯æ€ä¹ˆæ¥å°†æ•°æ®ä¼ ç»™phpè§£æå™¨æ¥è§£æphpä»£ç çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡sapiã€‚ æˆ‘ä»¬å†æ¥çœ‹ä¸€å¼ å›¾ï¼Œè¯¦ç»†çš„è¯´è¯´apache ä¸ php ä¸ sapiçš„å…³ç³»ï¼š <img src="https://www.awaimai.com/wp-content/uploads/2018/03/1417244404_9526.png" alt="mode_php" title="mode_phpæ¨¡å¼"> ä»ä¸Šé¢å›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹å‡ºäº†sapiå°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªä¸­é—´è¿‡ç¨‹ï¼ŒSAPIæä¾›äº†ä¸€ä¸ªå’Œå¤–éƒ¨é€šä¿¡çš„æ¥å£ï¼Œæœ‰ç‚¹ç±»ä¼¼äºsocketï¼Œä½¿å¾—PHPå¯ä»¥å’Œå…¶ä»–åº”ç”¨è¿›è¡Œäº¤äº’æ•°æ®ï¼ˆapacheï¼Œnginxç­‰ï¼‰ã€‚phpé»˜è®¤æä¾›äº†å¾ˆå¤šç§SAPIï¼Œå¸¸è§çš„æä¾›ç»™apacheå’Œnginxçš„php5_moduleã€CGIã€FastCGIï¼Œç»™IISçš„ISAPIï¼Œä»¥åŠShellçš„CLIã€‚ æ‰€ä»¥ï¼Œä»¥ä¸Šçš„apacheè°ƒç”¨phpæ‰§è¡Œçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>apache -&gt; httpd -&gt; php5_module -&gt; sapi -&gt; php</p><p>å¥½äº†ã€‚apacheä¸phpé€šè¿‡php5_moduleçš„æ–¹å¼å°±ææ¸…æ¥šäº†å§ï¼ è¿™ç§æ¨¡å¼å°†phpæ¨¡å—å®‰è£…åˆ°apacheä¸­ï¼Œæ‰€ä»¥æ¯ä¸€æ¬¡apacheç»“æŸè¯·æ±‚ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€æ¡è¿›ç¨‹ï¼Œè¿™ä¸ªè¿›ç¨‹å°±å®Œæ•´çš„åŒ…æ‹¬phpçš„å„ç§è¿ç®—è®¡ç®—ç­‰æ“ä½œã€‚ åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬å¾ˆæ¸…æ™°çš„å¯ä»¥çœ‹åˆ°ï¼Œapacheæ¯æ¥æ”¶ä¸€ä¸ªè¯·æ±‚ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªè¿›ç¨‹æ¥è¿æ¥phpé€šè¿‡sapiæ¥å®Œæˆè¯·æ±‚ï¼Œå¯æƒ³è€ŒçŸ¥ï¼Œå¦‚æœä¸€æ—¦ç”¨æˆ·è¿‡å¤šï¼Œå¹¶å‘æ•°è¿‡å¤šï¼ŒæœåŠ¡å™¨å°±ä¼šæ‰¿å—ä¸ä½äº†ã€‚ è€Œä¸”ï¼ŒæŠŠmod_phpç¼–è¿›apacheæ—¶ï¼Œå‡ºé—®é¢˜æ—¶å¾ˆéš¾å®šä½æ˜¯phpçš„é—®é¢˜è¿˜æ˜¯apacheçš„é—®é¢˜ã€‚</p><h2 id="CGI"><a class="header-anchor" href="#CGI"></a>CGI</h2><p>CGIï¼ˆ<strong>Common Gateway Interface</strong>ï¼‰å…¨ç§°æ˜¯â€œ<strong>é€šç”¨ç½‘å…³æ¥å£</strong>â€ï¼ŒWEB æœåŠ¡å™¨ä¸PHPåº”ç”¨è¿›è¡Œâ€œäº¤è°ˆâ€çš„ä¸€ç§å·¥å…·ï¼Œå…¶ç¨‹åºé¡»è¿è¡Œåœ¨ç½‘ç»œæœåŠ¡å™¨ä¸Šã€‚CGIå¯ä»¥ç”¨ä»»ä½•ä¸€ç§è¯­è¨€ç¼–å†™ï¼Œåªè¦è¿™ç§è¯­è¨€å…·æœ‰æ ‡å‡†è¾“å…¥ã€è¾“å‡ºå’Œç¯å¢ƒå˜é‡ã€‚å¦‚phpã€perlã€tclç­‰ã€‚ WEBæœåŠ¡å™¨ä¼šä¼ å“ªäº›æ•°æ®ç»™PHPè§£æå™¨å‘¢ï¼Ÿ<strong>URLã€æŸ¥è¯¢å­—ç¬¦ä¸²ã€POSTæ•°æ®ã€HTTP header</strong>éƒ½ä¼šæœ‰ã€‚æ‰€ä»¥ï¼ŒCGIå°±æ˜¯è§„å®šè¦ä¼ å“ªäº›æ•°æ®ï¼Œä»¥ä»€ä¹ˆæ ·çš„æ ¼å¼ä¼ é€’ç»™åæ–¹å¤„ç†è¿™ä¸ªè¯·æ±‚çš„åè®®ã€‚ä»”ç»†æƒ³æƒ³ï¼Œä½ åœ¨PHPä»£ç ä¸­ä½¿ç”¨çš„ç”¨æˆ·ä»å“ªé‡Œæ¥çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼ŒCGIå°±æ˜¯ä¸“é—¨ç”¨æ¥å’Œ web æœåŠ¡å™¨æ‰“äº¤é“çš„ã€‚webæœåŠ¡å™¨æ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼Œå°±ä¼šæŠŠè¯·æ±‚æäº¤ç»™cgiç¨‹åºï¼ˆå¦‚php-cgiï¼‰ï¼Œcgiç¨‹åºæ ¹æ®è¯·æ±‚æäº¤çš„å‚æ•°ä½œåº”å¤„ç†ï¼ˆè§£æphpï¼‰ï¼Œç„¶åè¾“å‡ºæ ‡å‡†çš„htmlè¯­å¥ï¼Œè¿”å›ç»™webæœæœåŠ¡å™¨ï¼ŒWEBæœåŠ¡å™¨å†è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™å°±æ˜¯æ™®é€šcgiçš„å·¥ä½œåŸç†ã€‚ CGIçš„å¥½å¤„å°±æ˜¯å®Œå…¨ç‹¬ç«‹äºä»»ä½•æœåŠ¡å™¨ï¼Œä»…ä»…æ˜¯åšä¸ºä¸­é—´åˆ†å­ã€‚æä¾›æ¥å£ç»™apacheå’Œphpã€‚ä»–ä»¬é€šè¿‡cgiæ­çº¿æ¥å®Œæˆæ•°æ®ä¼ é€’ã€‚è¿™æ ·åšçš„å¥½å¤„äº†å°½é‡å‡å°‘2ä¸ªçš„å…³è”ï¼Œä½¿ä»–ä»¬2å˜å¾—æ›´ç‹¬ç«‹ã€‚ ä½†æ˜¯CGIæœ‰ä¸ªè›‹ç–¼çš„åœ°æ–¹ï¼Œå°±æ˜¯æ¯ä¸€æ¬¡webè¯·æ±‚éƒ½ä¼šæœ‰å¯åŠ¨å’Œé€€å‡ºè¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯æœ€ä¸ºäººè¯Ÿç—…çš„<strong>fork-and-execute</strong>æ¨¡å¼ï¼Œè¿™æ ·ä¸€åœ¨å¤§è§„æ¨¡å¹¶å‘ä¸‹ï¼Œå°±æ­»ç¿˜ç¿˜äº†ã€‚</p><h2 id="FastCGIä»‹ç»"><a class="header-anchor" href="#FastCGIä»‹ç»"></a>FastCGIä»‹ç»</h2><h3 id="FastCGIç®€å•ä»‹ç»"><a class="header-anchor" href="#FastCGIç®€å•ä»‹ç»"></a>FastCGIç®€å•ä»‹ç»</h3><p>ä»æ ¹æœ¬ä¸Šæ¥è¯´ï¼ŒFastCGIæ˜¯ç”¨æ¥æé«˜CGIç¨‹åºæ€§èƒ½çš„ã€‚ç±»ä¼¼äºCGIï¼Œ<strong>FastCGIä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ç§åè®®</strong>ã€‚ FastCGIåƒæ˜¯ä¸€ä¸ª<strong>å¸¸é©»(long-live)å‹çš„CGI</strong>ï¼Œå®ƒå¯ä»¥ä¸€ç›´æ‰§è¡Œç€ï¼Œåªè¦æ¿€æ´»åï¼Œä¸ä¼šæ¯æ¬¡éƒ½è¦èŠ±è´¹æ—¶é—´å»forkä¸€æ¬¡ã€‚å®ƒè¿˜æ”¯æŒåˆ†å¸ƒå¼çš„è¿ç®—, å³ FastCGI ç¨‹åºå¯ä»¥åœ¨ç½‘ç«™æœåŠ¡å™¨ä»¥å¤–çš„ä¸»æœºä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”æ¥å—æ¥è‡ªå…¶å®ƒç½‘ç«™æœåŠ¡å™¨æ¥çš„è¯·æ±‚ã€‚ FastCGIæ˜¯è¯­è¨€æ— å…³çš„ã€å¯ä¼¸ç¼©æ¶æ„çš„CGIå¼€æ”¾æ‰©å±•ï¼Œå…¶ä¸»è¦è¡Œä¸ºæ˜¯å°†CGIè§£é‡Šå™¨è¿›ç¨‹ä¿æŒåœ¨å†…å­˜ä¸­ï¼Œå¹¶å› æ­¤è·å¾—è¾ƒé«˜çš„æ€§èƒ½ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒCGIè§£é‡Šå™¨çš„åå¤åŠ è½½æ˜¯CGIæ€§èƒ½ä½ä¸‹çš„ä¸»è¦åŸå› ï¼Œå¦‚æœCGIè§£é‡Šå™¨ä¿æŒåœ¨å†…å­˜ä¸­ï¼Œå¹¶æ¥å—FastCGIè¿›ç¨‹ç®¡ç†å™¨è°ƒåº¦ï¼Œåˆ™å¯ä»¥æä¾›è‰¯å¥½çš„æ€§èƒ½ã€ä¼¸ç¼©æ€§ã€Fail- Overç‰¹æ€§ç­‰ç­‰ã€‚</p><h3 id="FastCGIçš„å·¥ä½œåŸç†"><a class="header-anchor" href="#FastCGIçš„å·¥ä½œåŸç†"></a>FastCGIçš„å·¥ä½œåŸç†</h3><p>FastCGIæ¥å£æ–¹å¼é‡‡ç”¨C/Sç»“æ„ï¼Œå¯ä»¥å°†HTTPæœåŠ¡å™¨å’Œè„šæœ¬è§£ææœåŠ¡å™¨åˆ†å¼€ï¼ŒåŒæ—¶åœ¨è„šæœ¬è§£ææœåŠ¡å™¨ä¸Šå¯åŠ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªè„šæœ¬è§£æå®ˆæŠ¤è¿›ç¨‹ã€‚å½“HTTPæœåŠ¡å™¨æ¯æ¬¡é‡åˆ°åŠ¨æ€ç¨‹åºæ—¶ï¼Œå¯ä»¥å°†å…¶ç›´æ¥äº¤ä»˜ç»™FastCGIè¿›ç¨‹æ¥æ‰§è¡Œï¼Œç„¶åå°†å¾—åˆ°çš„ç»“æœè¿”å›ç»™æµè§ˆå™¨ã€‚è¿™ç§æ–¹å¼å¯ä»¥è®©HTTPæœåŠ¡å™¨ä¸“ä¸€åœ°å¤„ç†é™æ€è¯·æ±‚ï¼Œæˆ–è€…å°†åŠ¨æ€è„šæœ¬æœåŠ¡å™¨çš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜äº†æ•´ä¸ªåº”ç”¨ç³»ç»Ÿçš„æ€§èƒ½ã€‚ <a href="https://www.awaimai.com/wp-content/uploads/2018/03/fastcgi.png"><img src="https://www.awaimai.com/wp-content/uploads/2018/03/fastcgi.png" alt="fastcgi"></a></p><ol><li>Web Serverå¯åŠ¨æ—¶è½½å…¥FastCGIè¿›ç¨‹ç®¡ç†å™¨ï¼ˆApache Moduleæˆ–IIS ISAPIç­‰)</li><li>FastCGIè¿›ç¨‹ç®¡ç†å™¨è‡ªèº«åˆå§‹åŒ–ï¼Œå¯åŠ¨å¤šä¸ªCGIè§£é‡Šå™¨è¿›ç¨‹(å¯å»ºå¤šä¸ªphp-cgi)ï¼Œå¹¶ç­‰å¾…æ¥è‡ªWeb Serverçš„è¿æ¥ã€‚</li><li>å½“å®¢æˆ·ç«¯è¯·æ±‚åˆ°è¾¾Web Serveræ—¶ï¼ŒFastCGIè¿›ç¨‹ç®¡ç†å™¨é€‰æ‹©å¹¶è¿æ¥åˆ°ä¸€ä¸ªCGIè§£é‡Šå™¨ã€‚Web serverå°†CGIç¯å¢ƒå˜é‡å’Œæ ‡å‡†è¾“å…¥å‘é€åˆ°FastCGIå­è¿›ç¨‹php-cgiã€‚</li><li>FastCGIå­è¿›ç¨‹å®Œæˆå¤„ç†åï¼Œå°†æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯ä¿¡æ¯ä»åŒä¸€è¿æ¥è¿”å›Web Serverã€‚å½“FastCGIå­è¿›ç¨‹å…³é—­è¿æ¥æ—¶ï¼Œè¯·æ±‚ä¾¿å‘Šå¤„ç†å®Œæˆã€‚FastCGIå­è¿›ç¨‹æ¥ç€ç­‰å¾…ï¼Œå¹¶å¤„ç†æ¥è‡ªFastCGIè¿›ç¨‹ç®¡ç†å™¨(è¿è¡Œåœ¨Web Serverä¸­)çš„ä¸‹ä¸€ä¸ªè¿æ¥ã€‚ åœ¨CGIæ¨¡å¼ä¸­ï¼Œphp-cgiåœ¨æ­¤ä¾¿é€€å‡ºäº†ã€‚</li></ol><p>FastCGIä¸CGIç‰¹ç‚¹ï¼š</p><ol><li>å¯¹äºCGIæ¥è¯´ï¼Œæ¯ä¸€ä¸ªWebè¯·æ±‚PHPéƒ½å¿…é¡»é‡æ–°è§£æphp.iniã€é‡æ–°è½½å…¥å…¨éƒ¨æ‰©å±•ï¼Œå¹¶é‡æ–°åˆå§‹åŒ–å…¨éƒ¨æ•°æ®ç»“æ„ã€‚è€Œä½¿ç”¨FastCGIï¼Œæ‰€æœ‰è¿™äº›éƒ½åªåœ¨è¿›ç¨‹å¯åŠ¨æ—¶å‘ç”Ÿä¸€æ¬¡ã€‚ä¸€ä¸ªé¢å¤–çš„å¥½å¤„æ˜¯ï¼ŒæŒç»­æ•°æ®åº“è¿æ¥(Persistent database connection)å¯ä»¥å·¥ä½œã€‚</li><li>ç”±äºFastCGIæ˜¯å¤šè¿›ç¨‹ï¼Œæ‰€ä»¥æ¯”CGIå¤šçº¿ç¨‹æ¶ˆè€—æ›´å¤šçš„æœåŠ¡å™¨å†…å­˜ï¼Œphp-cgiè§£é‡Šå™¨æ¯è¿›ç¨‹æ¶ˆè€—7è‡³25å…†å†…å­˜ï¼Œå°†è¿™ä¸ªæ•°å­—ä¹˜ä»¥50æˆ–100å°±æ˜¯å¾ˆå¤§çš„å†…å­˜æ•°ã€‚</li></ol><h2 id="PHP-FPMä»‹ç»"><a class="header-anchor" href="#PHP-FPMä»‹ç»"></a>PHP-FPMä»‹ç»</h2><p>è¦äº†è§£PHP-FPMï¼Œå°±å¾—å…ˆè¯´è¯´PHP-CGIã€‚ <strong>PHP-CGIå°±æ˜¯PHPå®ç°çš„è‡ªå¸¦çš„FastCGIç®¡ç†å™¨</strong>ã€‚ è™½ç„¶æ˜¯phpå®˜æ–¹å‡ºå“ï¼Œä½†æ˜¯è¿™ä¸«çš„å´ä¸€ç‚¹ä¹Ÿä¸ç»™åŠ›ï¼Œæ€§èƒ½å¤ªå·®ï¼Œè€Œä¸”ä¹Ÿå¾ˆéº»çƒ¦ä¸äººæ€§åŒ–ï¼Œä¸»è¦ä½“ç°åœ¨ï¼š</p><ol><li>php-cgiå˜æ›´php.inié…ç½®åï¼Œéœ€é‡å¯php-cgiæ‰èƒ½è®©æ–°çš„php-iniç”Ÿæ•ˆï¼Œä¸å¯ä»¥å¹³æ»‘é‡å¯ã€‚</li><li>ç›´æ¥æ€æ­»php-cgiè¿›ç¨‹ï¼Œphpå°±ä¸èƒ½è¿è¡Œäº†ã€‚</li></ol><p>ä¸Šé¢2ä¸ªé—®é¢˜ï¼Œä¸€ç›´è®©å¾ˆå¤šäººç—…å¢äº†å¾ˆä¹…ï¼Œæ‰€ä»¥å¾ˆå¤šäººä¸€ç›´è¿˜æ˜¯åœ¨ç”¨ Module æ–¹å¼ã€‚ ç›´åˆ° 2004å¹´ä¸€ä¸ªå« Andrei Nigmatulinçš„å±Œä¸å‘æ˜äº†PHP-FPM ï¼Œè¿™ç¥å™¨çš„å‡ºç°å°±å½»åº•æ‰“ç ´äº†è¿™ç§å±€é¢ï¼Œè¿™æ˜¯ä¸€ä¸ªPHPä¸“ç”¨çš„ fastcgi ç®¡ç†å™¨ï¼Œå®ƒå¾ˆçˆ½çš„å…‹æœäº†ä¸Šé¢2ä¸ªé—®é¢˜ï¼Œè€Œä¸”ï¼Œè¿˜è¡¨ç°åœ¨å…¶ä»–æ–¹é¢æ›´è¡¨ç°å¼ºåŠ²ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼ŒPHP-FPM æ˜¯å¯¹äº FastCGI åè®®çš„å…·ä½“å®ç°ï¼Œä»–è´Ÿè´£ç®¡ç†ä¸€ä¸ªè¿›ç¨‹æ± ï¼Œæ¥å¤„ç†æ¥è‡ªWebæœåŠ¡å™¨çš„è¯·æ±‚ã€‚<strong>ç›®å‰ï¼ŒPHP5.3ç‰ˆæœ¬ä¹‹åï¼ŒPHP-FPMæ˜¯å†…ç½®äºPHPçš„</strong>ã€‚ å› ä¸ºPHP-CGIåªæ˜¯ä¸ªCGIç¨‹åºï¼Œä»–è‡ªå·±æœ¬èº«åªèƒ½è§£æè¯·æ±‚ï¼Œè¿”å›ç»“æœï¼Œä¸ä¼šè¿›ç¨‹ç®¡ç†ã€‚æ‰€ä»¥å°±å‡ºç°äº†ä¸€äº›èƒ½å¤Ÿè°ƒåº¦ php-cgi è¿›ç¨‹çš„ç¨‹åºï¼Œæ¯”å¦‚è¯´ç”±lighthttpdåˆ†ç¦»å‡ºæ¥çš„spawn-fcgiã€‚åŒæ ·ï¼ŒPHP-FPMä¹Ÿæ˜¯ç”¨äºè°ƒåº¦ç®¡ç†PHPè§£æå™¨php-cgiçš„ç®¡ç†ç¨‹åºã€‚ PHP-FPMé€šè¿‡ç”Ÿæˆæ–°çš„å­è¿›ç¨‹å¯ä»¥å®ç°php.iniä¿®æ”¹åçš„å¹³æ»‘é‡å¯ã€‚</p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h2><p>æœ€åï¼Œæˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼Œè¿™äº›æŠ€æœ¯ç»è¿‡ä¸æ–­çš„å‡çº§ï¼Œå¯ä»¥è§£å†³ä»€ä¹ˆé—®é¢˜ï¼ˆä¸ç„¶ä¹Ÿä¸ä¼šå‡çº§å˜›ï¼‰ã€‚ <a href="https://www.awaimai.com/wp-content/uploads/2018/03/update.png"><img src="https://www.awaimai.com/wp-content/uploads/2018/03/update.png" alt=""></a> æ‰€ä»¥ï¼Œå¦‚æœè¦æ­å»ºä¸€ä¸ªé«˜æ€§èƒ½çš„PHP WEBæœåŠ¡å™¨ï¼Œç›®å‰æœ€ä½³çš„æ–¹å¼æ˜¯<strong>Apache/Nginx</strong> + <strong>FastCGI</strong> + **PHP-FPM(+PHP-CGI)**æ–¹å¼äº†ï¼Œä¸è¦å†ä½¿ç”¨ ModuleåŠ è½½æˆ–è€… CGI æ–¹å¼å•¦ï¼šï¼‰</p><p>æ–‡ç« è½¬è‡ªï¼š<a href="https://www.awaimai.com/371.html" title="æ­ªéº¦åšå®¢ https://www.awaimai.com/371.html">æ­ªéº¦åšå®¢ https://www.awaimai.com/371.html</a></p>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fastcgi</tag>
      
      <tag>php-fpm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis åº”ç”¨-é™æµ</title>
    <link href="/2019/07/16/redis-%E5%BA%94%E7%94%A8-%E9%99%90%E6%B5%81/"/>
    <url>/2019/07/16/redis-%E5%BA%94%E7%94%A8-%E9%99%90%E6%B5%81/</url>
    
    <content type="html"><![CDATA[<p>åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æœ‰ä¸‰æŠŠåˆ©å™¨ä¿æŠ¤ç³»ç»Ÿï¼šç¼“å­˜ã€é™çº§ã€å’Œé™æµã€‚ç¼“å­˜çš„ç›®çš„æ˜¯æå‡ç³»ç»Ÿçš„è®¿é—®ä½ é€Ÿåº¦å’Œå¢å¤§ç³»ç»Ÿèƒ½å¤„ç†çš„å®¹é‡ï¼›é™çº§æ˜¯å½“æœåŠ¡å‡ºé—®é¢˜æˆ–å½±å“åˆ°æ ¸å¿ƒæµç¨‹çš„æ€§èƒ½åˆ™éœ€è¦æš‚æ—¶å±è”½æ‰ã€‚è€Œæœ‰äº›åœºæ™¯åˆ™éœ€è¦é™åˆ¶å¹¶å‘è¯·æ±‚é‡ï¼Œå¦‚ç§’æ€ã€æŠ¢è´­ã€å‘å¸–ã€è¯„è®ºã€æ¶æ„çˆ¬è™«ç­‰ã€‚ é™æµç®—æ³•<br>å¸¸è§çš„é™æµç®—æ³•æœ‰ï¼šè®¡æ•°å™¨ï¼Œæ¼æ¡¶ã€ä»¤ç‰Œæ¡¶ã€‚</p><h3 id="è®¡æ•°å™¨"><a class="header-anchor" href="#è®¡æ•°å™¨"></a>è®¡æ•°å™¨</h3><p>é¡¾åæ€ä¹‰å°±æ˜¯æ¥ä¸€ä¸ªè®°ä¸€ä¸ªï¼Œç„¶ååˆ¤æ–­åœ¨æœ‰é™æ—¶é—´çª—å£å†…çš„æ•°é‡æ˜¯å¦è¶…è¿‡é™åˆ¶å³å¯</p><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isActionAllowed</span>(<span class="hljs-params">$userId, $action, $period, $maxCount</span>) </span><span class="hljs-function"></span>&#123;    $redis = <span class="hljs-keyword">new</span> Redis();    $redis-&gt;connect(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">6379</span>);    $key = sprintf(<span class="hljs-string">&#x27;hist:%s:%s&#x27;</span>, $userId, $action);    $now = msectime();   <span class="hljs-comment"># æ¯«ç§’æ—¶é—´æˆ³</span>    $pipe=$redis-&gt;multi(Redis::PIPELINE); <span class="hljs-comment">//ä½¿ç”¨ç®¡é“æå‡æ€§èƒ½</span>    $pipe-&gt;zadd($key, $now, $now); <span class="hljs-comment">//value å’Œ score éƒ½ä½¿ç”¨æ¯«ç§’æ—¶é—´æˆ³</span>    $pipe-&gt;zremrangebyscore($key, <span class="hljs-number">0</span>, $now - $period); <span class="hljs-comment">//ç§»é™¤æ—¶é—´çª—å£ä¹‹å‰çš„è¡Œä¸ºè®°å½•ï¼Œå‰©ä¸‹çš„éƒ½æ˜¯æ—¶é—´çª—å£å†…çš„</span>    $pipe-&gt;zcard($key);  <span class="hljs-comment">//è·å–çª—å£å†…çš„è¡Œä¸ºæ•°é‡</span>    $pipe-&gt;expire($key, $period + <span class="hljs-number">1</span>);  <span class="hljs-comment">//å¤šåŠ ä¸€ç§’è¿‡æœŸæ—¶é—´</span>    $replies = $pipe-&gt;exec();    <span class="hljs-keyword">return</span> $replies[<span class="hljs-number">2</span>] &lt;= $maxCount;&#125;<span class="hljs-keyword">for</span> ($i=<span class="hljs-number">0</span>; $i&lt;<span class="hljs-number">20</span>; $i++)&#123;    var_dump(isActionAllowed(<span class="hljs-string">&quot;110&quot;</span>, <span class="hljs-string">&quot;reply&quot;</span>, <span class="hljs-number">60</span>*<span class="hljs-number">1000</span>, <span class="hljs-number">5</span>)); <span class="hljs-comment">//æ‰§è¡Œå¯ä»¥å‘ç°åªæœ‰å‰5æ¬¡æ˜¯é€šè¿‡çš„</span>&#125;<span class="hljs-comment">//è¿”å›å½“å‰çš„æ¯«ç§’æ—¶é—´æˆ³</span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">msectime</span>(<span class="hljs-params"></span>) </span>&#123;    <span class="hljs-keyword">list</span>($msec, $sec) = explode(<span class="hljs-string">&#x27; &#x27;</span>, microtime());    $msectime = (<span class="hljs-keyword">float</span>)sprintf(<span class="hljs-string">&#x27;%.0f&#x27;</span>, (floatval($msec) + floatval($sec)) * <span class="hljs-number">1000</span>);    <span class="hljs-keyword">return</span> $msectime; &#125;</code></pre><h3 id="æ¼æ¡¶"><a class="header-anchor" href="#æ¼æ¡¶"></a>æ¼æ¡¶</h3><p>æ¼æ¡¶ (Leaky Bucket) ç®—æ³•æ€è·¯å¾ˆç®€å•ï¼Œæ°´ (è¯·æ±‚) å…ˆè¿›å…¥åˆ°æ¼æ¡¶é‡Œï¼Œæ¼æ¡¶ä»¥ä¸€å®šçš„é€Ÿåº¦å‡ºæ°´ (æ¥å£æœ‰å“åº”é€Ÿç‡), å½“æ°´æµå…¥é€Ÿåº¦è¿‡å¤§ä¼šç›´æ¥æº¢å‡º (è®¿é—®é¢‘ç‡è¶…è¿‡æ¥å£å“åº”é€Ÿç‡), ç„¶åå°±æ‹’ç»è¯·æ±‚ï¼Œå¯ä»¥çœ‹å‡ºæ¼æ¡¶ç®—æ³•èƒ½å¼ºè¡Œé™åˆ¶æ•°æ®çš„ä¼ è¾“é€Ÿç‡ã€‚ç¤ºæ„å›¾å¦‚ä¸‹:<br><a href="https://cdn.learnku.com/uploads/images/201907/05/4878/lIhEKQ2rsK.jpeg!large"></a><a href="https://cdn.learnku.com/uploads/images/201907/05/4878/lIhEKQ2rsK.jpeg!large"><img src="https://cdn.learnku.com/uploads/images/201907/05/4878/lIhEKQ2rsK.jpeg!large" alt="image"></a> å…·ä½“ä»£ç å®ç°å¦‚ä¸‹</p><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Funnel</span> </span>&#123;    <span class="hljs-keyword">private</span> $capacity;    <span class="hljs-keyword">private</span> $leakingRate;    <span class="hljs-keyword">private</span> $leftQuote;    <span class="hljs-keyword">private</span> $leakingTs;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">$capacity, $leakingRate</span>)</span><span class="hljs-function">    </span>&#123;        <span class="hljs-keyword">$this</span>-&gt;capacity = $capacity;    <span class="hljs-comment">//æ¼æ–—å®¹é‡</span>        <span class="hljs-keyword">$this</span>-&gt;leakingRate = $leakingRate;<span class="hljs-comment">//æ¼æ–—æµæ°´é€Ÿç‡</span>        <span class="hljs-keyword">$this</span>-&gt;leftQuote = $capacity; <span class="hljs-comment">//æ¼æ–—å‰©ä½™ç©ºé—´</span>        <span class="hljs-keyword">$this</span>-&gt;leakingTs = time(); <span class="hljs-comment">//ä¸Šä¸€æ¬¡æ¼æ°´æ—¶é—´</span>    &#125;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeSpace</span>(<span class="hljs-params"></span>)</span><span class="hljs-function">    </span>&#123;        $now = time();        $deltaTs = $now-<span class="hljs-keyword">$this</span>-&gt;leakingTs; <span class="hljs-comment">//è·ç¦»ä¸Šä¸€æ¬¡æ¼æ°´è¿‡å»äº†å¤šä¹…</span>        $deltaQuota = $deltaTs * <span class="hljs-keyword">$this</span>-&gt;leakingRate; <span class="hljs-comment">//å¯è…¾å‡ºçš„ç©ºé—´</span>        <span class="hljs-keyword">if</span>($deltaQuota &lt; <span class="hljs-number">1</span>) &#123;              <span class="hljs-keyword">return</span>;        &#125;        <span class="hljs-keyword">$this</span>-&gt;leftQuote += $deltaQuota;   <span class="hljs-comment">//å¢åŠ å‰©ä½™ç©ºé—´</span>        <span class="hljs-keyword">$this</span>-&gt;leakingTs = time();         <span class="hljs-comment">//è®°å½•æ¼æ°´æ—¶é—´</span>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;leftQuota &gt; <span class="hljs-keyword">$this</span>-&gt;capacaty)&#123;            <span class="hljs-keyword">$this</span>-&gt;leftQuote = <span class="hljs-keyword">$this</span>-&gt;capacity;        &#125;    &#125;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">watering</span>(<span class="hljs-params">$quota</span>)</span><span class="hljs-function">    </span>&#123;        <span class="hljs-keyword">$this</span>-&gt;makeSpace(); <span class="hljs-comment">//æ¼æ°´æ“ä½œ</span>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;leftQuote &gt;= $quota) &#123;            <span class="hljs-keyword">$this</span>-&gt;leftQuote -= $quota;            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;    &#125;&#125;$funnels = [];<span class="hljs-keyword">global</span> $funnel;<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isActionAllowed</span>(<span class="hljs-params">$userId, $action, $capacity, $leakingRate</span>)</span><span class="hljs-function"></span>&#123;    $key = sprintf(<span class="hljs-string">&quot;%s:%s&quot;</span>, $userId, $action);    $funnel = $GLOBALS[<span class="hljs-string">&#x27;funnel&#x27;</span>][$key] ?? <span class="hljs-string">&#x27;&#x27;</span>;    <span class="hljs-keyword">if</span> (!$funnel) &#123;        $funnel  = <span class="hljs-keyword">new</span> Funnel($capacity, $leakingRate);        $GLOBALS[<span class="hljs-string">&#x27;funnel&#x27;</span>][$key] = $funnel;    &#125;    <span class="hljs-keyword">return</span> $funnel-&gt;watering(<span class="hljs-number">1</span>);&#125;<span class="hljs-keyword">for</span> ($i=<span class="hljs-number">0</span>; $i&lt;<span class="hljs-number">20</span>; $i++)&#123;    var_dump(isActionAllowed(<span class="hljs-string">&quot;110&quot;</span>, <span class="hljs-string">&quot;reply&quot;</span>, <span class="hljs-number">15</span>, <span class="hljs-number">0.5</span>)); <span class="hljs-comment">//æ‰§è¡Œå¯ä»¥å‘ç°åªæœ‰å‰15æ¬¡æ˜¯é€šè¿‡çš„</span>&#125;</code></pre><p>æ ¸å¿ƒé€»è¾‘å°±æ˜¯ makeSpaceï¼Œåœ¨æ¯æ¬¡çŒæ°´å‰è°ƒç”¨ä»¥è§¦å‘æ¼æ°´ï¼Œç»™æ¼æ–—è…¾å‡ºç©ºé—´ã€‚<br>funnels æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Redis ä¸­çš„ hash ç»“æ„æ¥å­˜å‚¨å¯¹åº”å­—æ®µï¼ŒçŒæ°´æ—¶å°†å­—æ®µå–å‡ºè¿›è¡Œé€»è¾‘è¿ç®—åå†å­˜å…¥ hash ç»“æ„ä¸­å³å¯å®Œæˆä¸€æ¬¡è¡Œä¸ºé¢‘åº¦çš„æ£€æµ‹ã€‚ä½†è¿™æœ‰ä¸ªé—®é¢˜å°±æ˜¯æ•´ä¸ªè¿‡ç¨‹çš„åŸå­æ€§æ— æ³•ä¿è¯ï¼Œæ„å‘³ç€è¦ç”¨é”æ¥æ§åˆ¶ï¼Œä½†å¦‚æœåŠ é”å¤±è´¥ï¼Œå°±è¦é‡è¯•æˆ–è€…æ”¾å¼ƒï¼Œè¿™å›å¯¼è‡´æ€§èƒ½ä¸‹é™å’Œå½±å“ç”¨æˆ·ä½“éªŒï¼ŒåŒæ—¶ä»£ç å¤æ‚åº¦ä¹Ÿå‡é«˜äº†ï¼Œæ­¤æ—¶ Redis æä¾›äº†ä¸€ä¸ªæ’ä»¶ï¼ŒRedis-Cell å‡ºç°äº†ã€‚</p><h5 id="Redis-Cell"><a class="header-anchor" href="#Redis-Cell"></a>Redis-Cell</h5><p>Redis 4.0 æä¾›äº†ä¸€ä¸ªé™æµ Redis æ¨¡å—ï¼Œåç§°ä¸º redis-cellï¼Œè¯¥æ¨¡å—æä¾›æ¼æ–—ç®—æ³•ï¼Œå¹¶æä¾›åŸå­çš„é™æµæŒ‡ä»¤ã€‚ è¯¥æ¨¡å—åªæœ‰ä¸€æ¡æŒ‡ä»¤ cl.throttleï¼Œå…¶å‚æ•°å’Œè¿”å›å€¼æ¯”è¾ƒå¤æ‚ã€‚</p><pre><code class="hljs shell"><span class="hljs-meta">&gt;</span><span class="bash"> cl.throttle tom:reply 14 30 60 1</span>1) (integer) 0    # 0è¡¨ç¤ºå…è®¸ï¼Œ1è¡¨ç¤ºæ‹’ç»2) (integer) 15    # æ¼æ–—å®¹é‡capacity3) (integer) 14    # æ¼æ–—å‰©ä½™ç©ºé—´left_quota4) (integer) -1    # å¦‚æœæ‹’ç»äº†ï¼Œéœ€è¦å¤šé•¿æ—¶é—´åå†é‡è¯•ï¼Œå•ä½ç§’5) (integer) 2    # å¤šé•¿æ—¶é—´åï¼Œæ¼æ–—å®Œå…¨ç©ºå‡ºæ¥ï¼Œå•ä½ç§’</code></pre><p>è¯¥æŒ‡ä»¤æ„æ€ä¸ºï¼Œå…è®¸ç”¨æˆ· tom çš„ reply è¡Œä¸ºçš„é¢‘ç‡ä¸ºæ¯ 60s æœ€å¤š 30 æ¬¡ï¼Œæ¼æ–—åˆå§‹å®¹é‡ä¸º 15ï¼ˆå› ä¸ºæ˜¯ä» 0 å¼€å§‹è®¡æ•°ï¼Œåˆ° 14 ä¸º 15 ä¸ªï¼‰ï¼Œé»˜è®¤æ¯ä¸ªè¡Œä¸ºå æ®çš„ç©ºé—´ä¸º 1ï¼ˆå¯é€‰å‚æ•°ï¼‰ã€‚<br>å¦‚æœè¢«æ‹’ç»ï¼Œå–è¿”å›æ•°ç»„çš„ç¬¬å››ä¸ªå€¼è¿›è¡Œ sleep å³å¯ä½œä¸ºé‡è¯•æ—¶é—´ï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥å®šæ—¶ä»»åŠ¡æ¥é‡è¯•ã€‚</p><h3 id="ä»¤ç‰Œæ¡¶"><a class="header-anchor" href="#ä»¤ç‰Œæ¡¶"></a>ä»¤ç‰Œæ¡¶</h3><p>ä»¤ç‰Œæ¡¶ç®—æ³• (Token Bucket) å’Œ Leaky Bucket æ•ˆæœä¸€æ ·ä½†æ–¹å‘ç›¸åçš„ç®—æ³•ï¼Œæ›´åŠ å®¹æ˜“ç†è§£ã€‚éšç€æ—¶é—´æµé€ï¼Œç³»ç»Ÿä¼šæŒ‰æ’å®š 1/QPS æ—¶é—´é—´éš” (å¦‚æœ QPS=100, åˆ™é—´éš”æ˜¯ 10ms) å¾€æ¡¶é‡ŒåŠ å…¥ Token (æƒ³è±¡å’Œæ¼æ´æ¼æ°´ç›¸åï¼Œæœ‰ä¸ªæ°´é¾™å¤´åœ¨ä¸æ–­çš„åŠ æ°´), å¦‚æœæ¡¶å·²ç»æ»¡äº†å°±ä¸å†åŠ äº†ã€‚æ–°è¯·æ±‚æ¥ä¸´æ—¶ï¼Œä¼šå„è‡ªæ‹¿èµ°ä¸€ä¸ª Token, å¦‚æœæ²¡æœ‰ Token å¯æ‹¿äº†å°±é˜»å¡æˆ–è€…æ‹’ç»æœåŠ¡. ä»¤ç‰Œæ¡¶çš„å¦å¤–ä¸€ä¸ªå¥½å¤„æ˜¯å¯ä»¥æ–¹ä¾¿çš„æ”¹å˜é€Ÿåº¦ã€‚ä¸€æ—¦éœ€è¦æé«˜é€Ÿç‡ï¼Œåˆ™æŒ‰éœ€æé«˜æ”¾å…¥æ¡¶ä¸­çš„ä»¤ç‰Œçš„é€Ÿç‡ã€‚ä¸€èˆ¬ä¼šå®šæ—¶ (æ¯”å¦‚ 100 æ¯«ç§’) å¾€æ¡¶ä¸­å¢åŠ ä¸€å®šæ•°é‡çš„ä»¤ç‰Œï¼Œæœ‰äº›å˜ç§ç®—æ³•åˆ™å®æ—¶çš„è®¡ç®—åº”è¯¥å¢åŠ çš„ä»¤ç‰Œçš„æ•°é‡. å…·ä½“å®ç°å¯å‚è€ƒ <a href="https://blog.csdn.net/fdipzone/article/details/79352685">php åŸºäº redis ä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•å®ç°æµé‡æ§åˆ¶</a></p><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrafficShaper</span></span><span class="hljs-class"></span>&#123;     <span class="hljs-keyword">private</span> $_config; <span class="hljs-comment">// redisè®¾å®š</span>    <span class="hljs-keyword">private</span> $_redis;  <span class="hljs-comment">// rediså¯¹è±¡</span>    <span class="hljs-keyword">private</span> $_queue;  <span class="hljs-comment">// ä»¤ç‰Œæ¡¶</span>    <span class="hljs-keyword">private</span> $_max;    <span class="hljs-comment">// æœ€å¤§ä»¤ç‰Œæ•°</span>    <span class="hljs-comment">/**</span><span class="hljs-comment">     * åˆå§‹åŒ–</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> Array $config redisè¿æ¥è®¾å®š</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">$config, $queue, $max</span>)</span><span class="hljs-function">    </span>&#123;        <span class="hljs-keyword">$this</span>-&gt;_config = $config;        <span class="hljs-keyword">$this</span>-&gt;_queue = $queue;        <span class="hljs-keyword">$this</span>-&gt;_max = $max;        <span class="hljs-keyword">$this</span>-&gt;_redis = <span class="hljs-keyword">$this</span>-&gt;connect();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * åŠ å…¥ä»¤ç‰Œ</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> Int $num åŠ å…¥çš„ä»¤ç‰Œæ•°é‡</span><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Int åŠ å…¥çš„æ•°é‡</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">$num = <span class="hljs-number">0</span></span>)</span><span class="hljs-function">    </span>&#123;        <span class="hljs-comment">// å½“å‰å‰©ä½™ä»¤ç‰Œæ•°</span>        $curnum = intval(<span class="hljs-keyword">$this</span>-&gt;_redis-&gt;lSize(<span class="hljs-keyword">$this</span>-&gt;_queue));        <span class="hljs-comment">// æœ€å¤§ä»¤ç‰Œæ•°</span>        $maxnum = intval(<span class="hljs-keyword">$this</span>-&gt;_max);        <span class="hljs-comment">// è®¡ç®—æœ€å¤§å¯åŠ å…¥çš„ä»¤ç‰Œæ•°é‡ï¼Œä¸èƒ½è¶…è¿‡æœ€å¤§ä»¤ç‰Œæ•°</span>        $num = $maxnum &gt;= $curnum + $num ? $num : $maxnum - $curnum;        <span class="hljs-comment">// åŠ å…¥ä»¤ç‰Œ</span>        <span class="hljs-keyword">if</span> ($num &gt; <span class="hljs-number">0</span>) &#123;            $token = array_fill(<span class="hljs-number">0</span>, $num, <span class="hljs-number">1</span>);            <span class="hljs-keyword">$this</span>-&gt;_redis-&gt;lPush(<span class="hljs-keyword">$this</span>-&gt;_queue, ...$token);            <span class="hljs-keyword">return</span> $num;        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è·å–ä»¤ç‰Œ</span><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Boolean</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params"></span>)</span><span class="hljs-function">    </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;_redis-&gt;rPop(<span class="hljs-keyword">$this</span>-&gt;_queue) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * é‡è®¾ä»¤ç‰Œæ¡¶ï¼Œå¡«æ»¡ä»¤ç‰Œ</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reset</span>(<span class="hljs-params"></span>)</span><span class="hljs-function">    </span>&#123;        <span class="hljs-keyword">$this</span>-&gt;_redis-&gt;delete(<span class="hljs-keyword">$this</span>-&gt;_queue);        <span class="hljs-keyword">$this</span>-&gt;add(<span class="hljs-keyword">$this</span>-&gt;_max);    &#125;    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connect</span>(<span class="hljs-params"></span>)</span><span class="hljs-function">    </span>&#123;        <span class="hljs-keyword">try</span> &#123;            $redis = <span class="hljs-keyword">new</span> Redis();            $redis-&gt;connect(<span class="hljs-keyword">$this</span>-&gt;_config[<span class="hljs-string">&#x27;host&#x27;</span>], <span class="hljs-keyword">$this</span>-&gt;_config[<span class="hljs-string">&#x27;port&#x27;</span>], <span class="hljs-keyword">$this</span>-&gt;_config[<span class="hljs-string">&#x27;timeout&#x27;</span>], <span class="hljs-keyword">$this</span>-&gt;_config[<span class="hljs-string">&#x27;reserved&#x27;</span>], <span class="hljs-keyword">$this</span>-&gt;_config[<span class="hljs-string">&#x27;retry_interval&#x27;</span>]);            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-keyword">$this</span>-&gt;_config[<span class="hljs-string">&#x27;auth&#x27;</span>])) &#123;                $redis-&gt;auth(<span class="hljs-keyword">$this</span>-&gt;_config[<span class="hljs-string">&#x27;auth&#x27;</span>]);            &#125;            $redis-&gt;select(<span class="hljs-keyword">$this</span>-&gt;_config[<span class="hljs-string">&#x27;index&#x27;</span>]);        &#125; <span class="hljs-keyword">catch</span> (\RedisException $e) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>($e-&gt;getMessage());            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;        &#125;        <span class="hljs-keyword">return</span> $redis;    &#125;&#125; $config = <span class="hljs-keyword">array</span>(    <span class="hljs-string">&#x27;host&#x27;</span> =&gt; <span class="hljs-string">&#x27;localhost&#x27;</span>,    <span class="hljs-string">&#x27;port&#x27;</span> =&gt; <span class="hljs-number">6379</span>,    <span class="hljs-string">&#x27;index&#x27;</span> =&gt; <span class="hljs-number">0</span>,    <span class="hljs-string">&#x27;auth&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,    <span class="hljs-string">&#x27;timeout&#x27;</span> =&gt; <span class="hljs-number">1</span>,    <span class="hljs-string">&#x27;reserved&#x27;</span> =&gt; <span class="hljs-literal">NULL</span>,    <span class="hljs-string">&#x27;retry_interval&#x27;</span> =&gt; <span class="hljs-number">100</span>,);<span class="hljs-comment">// ä»¤ç‰Œæ¡¶å®¹å™¨</span>$queue = <span class="hljs-string">&#x27;mycontainer&#x27;</span>; <span class="hljs-comment">// æœ€å¤§ä»¤ç‰Œæ•°</span>$max = <span class="hljs-number">5</span>;<span class="hljs-comment">// åˆ›å»ºTrafficShaperå¯¹è±¡</span>$oTrafficShaper = <span class="hljs-keyword">new</span> TrafficShaper($config, $queue, $max);<span class="hljs-comment">// é‡è®¾ä»¤ç‰Œæ¡¶ï¼Œå¡«æ»¡ä»¤ç‰Œ</span>$oTrafficShaper-&gt;reset();<span class="hljs-comment">// å¾ªç¯è·å–ä»¤ç‰Œï¼Œä»¤ç‰Œæ¡¶å†…åªæœ‰5ä¸ªä»¤ç‰Œï¼Œå› æ­¤æœ€å3æ¬¡è·å–å¤±è´¥</span><span class="hljs-keyword">for</span> ($i = <span class="hljs-number">0</span>; $i &lt; <span class="hljs-number">8</span>; $i++) &#123;    var_dump($oTrafficShaper-&gt;get());&#125;<span class="hljs-comment">// åŠ å…¥10ä¸ªä»¤ç‰Œï¼Œæœ€å¤§ä»¤ç‰Œä¸º5ï¼Œå› æ­¤åªèƒ½åŠ å…¥5ä¸ª</span>$add_num = $oTrafficShaper-&gt;add(<span class="hljs-number">10</span>);var_dump($add_num);<span class="hljs-comment">// å¾ªç¯è·å–ä»¤ç‰Œï¼Œä»¤ç‰Œæ¡¶å†…åªæœ‰5ä¸ªä»¤ç‰Œï¼Œå› æ­¤æœ€å1æ¬¡è·å–å¤±è´¥</span><span class="hljs-keyword">for</span> ($i = <span class="hljs-number">0</span>; $i &lt; <span class="hljs-number">6</span>; $i++) &#123;    var_dump($oTrafficShaper-&gt;get());&#125;<span class="hljs-meta">?&gt;</span></code></pre><p>æ–‡ç« è½¬è‡ªï¼š<a href="https://learnku.com/articles/30822" title="https://learnku.com/articles/30822">https://learnku.com/articles/30822</a></p>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
      <tag>é™æµç®—æ³•</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>selectã€pollã€epoll</title>
    <link href="/2019/06/14/select%E3%80%81poll%E3%80%81epoll/"/>
    <url>/2019/06/14/select%E3%80%81poll%E3%80%81epoll/</url>
    
    <content type="html"><![CDATA[<p><strong>selectã€pollã€epoll æ¨¡å‹ï¼Œéƒ½æ˜¯ä¸ºå¤šè·¯ioå¤ç”¨æ¨¡å‹ï¼Œå®ƒä»¬æœ‰å“ªäº›ä¸åŒå’Œä¼˜ç¼ºç‚¹ï¼š</strong></p><h3 id="é˜»å¡-io-æ¨¡å‹-blocking-IO"><a class="header-anchor" href="#é˜»å¡-io-æ¨¡å‹-blocking-IO"></a>é˜»å¡ io æ¨¡å‹ blocking IO</h3><p>æœ€å¸¸ç”¨çš„ä¹Ÿå°±æ˜¯é˜»å¡ioæ¨¡å‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½æ˜¯é˜»å¡çš„ã€‚æˆ‘ä»¬ä»¥å¥—æ¥å­—æ¥å£ä¸ºä¾‹æ¥è®²è§£æ­¤æ¨¡å‹ï¼Œåœ¨è¿›ç¨‹ç©ºé—´è°ƒç”¨recvfromï¼Œå…¶ç³»ç»Ÿè°ƒç”¨çŸ¥é“æ•°æ®åŒ…åˆ°è¾¾å¹¶ä¸”è¢«å¤åˆ¶åˆ°è¿›ç¨‹ç¼“å†²ä¸­æˆ–è€…å‘ç”Ÿé”™è¯¯æ—¶æ‰ä¼šè¿”å›ï¼Œåœ¨æ­¤æœŸé—´ä¼šä¸€ç›´é˜»å¡ï¼Œæ‰€ä»¥è¿›ç¨‹åœ¨è°ƒç”¨recvfromå¼€å§‹åˆ°å®ƒè¿”å›çš„æ•´æ®µæ—¶é—´éƒ½æ˜¯é˜»å¡çš„ï¼Œå› æ­¤ç§°ä¹‹ä¸ºé˜»å¡ioæ¨¡å‹ã€‚ <img src="https://blog.wenboo.top/wp-content/uploads/2019/06/4d051d24389fb4ce866b70efba564a98.png" alt=""></p><h3 id="éé˜»å¡-io-æ¨¡å‹-nonblocking-IO"><a class="header-anchor" href="#éé˜»å¡-io-æ¨¡å‹-nonblocking-IO"></a>éé˜»å¡ io æ¨¡å‹ nonblocking IO</h3><p>åº”ç”¨å±‚æ•°æ®åˆ°kernelçš„è¿‡ç¨‹ä¸­ï¼Œrecvfromä¼šè½®è¯¢æ£€æŸ¥ï¼Œå¦‚æœkernelæ•°æ®æ²¡æœ‰å‡†å¤‡è¿˜ï¼Œå°±è¿”å›ä¸€ä¸ªEWOULDBLOCKé”™è¯¯ã€‚ä¸æ–­çš„è½®è¯¢æ£€æŸ¥ï¼Œç›´åˆ°å‘ç°kernelä¸­çš„æ•°æ®å‡†å¤‡å¥½äº†ï¼Œå°±è¿”å›ï¼Œç„¶åè¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œå°†æ•°æ®ä»kernelæ‹·è´åˆ°è¿›ç¨‹ç¼“å†²åŒºä¸­ã€‚ç±»ä¼¼busy-waitingçš„æ–¹æ³• <img src="https://blog.wenboo.top/wp-content/uploads/2019/06/b8be846cdb8aed3745782e47054e8570.png" alt=""></p><h3 id="I-O-å¤šè·¯å¤ç”¨ï¼ˆ-IO-multiplexingï¼‰"><a class="header-anchor" href="#I-O-å¤šè·¯å¤ç”¨ï¼ˆ-IO-multiplexingï¼‰"></a>I/O å¤šè·¯å¤ç”¨ï¼ˆ IO multiplexingï¼‰</h3><p>ä½¿ç”¨ä¸€ä¸ªè¿›ç¨‹æ¥å¤„ç†å¤šä¸ªio fdï¼Œèµ„æºåˆ©ç”¨ç‡é«˜ã€‚select,poll,epollæ¨¡å‹é€šè¿‡è½®è¯¢çš„æ–¹å¼æ¥å‘ç°ioè¯·æ±‚ã€‚</p><ul><li>select</li></ul><p>åŸç†ï¼šå½“å‰è¿›ç¨‹åœ¨è°ƒç”¨select functionæ—¶æ•´ä¸ªè¿›ç¨‹è¿›å…¥<strong>é˜»å¡</strong>ï¼Œæ­¤æ—¶å†…æ ¸å¼€å§‹ç›‘æ§select æ‰€å¤„ç†çš„è¿™ä¸ªsocket ioï¼Œå½“ä¸­ä»»æ„socketè¿æ¥æœ‰æ•°æ®ï¼Œåˆ™ä¼šç«‹å³è¿”å›ã€‚ç”¨æˆ·socketè¿›ç¨‹è¿›å…¥readçŠ¶æ€ï¼Œå†…æ ¸å°†æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·è¿›ç¨‹ç¼“å†²åŒºã€‚ <img src="https://blog.wenboo.top/wp-content/uploads/2019/06/e2a8b3d25cf0f7bbe25ab4fbde60b320.png" alt=""> I/O å¤šè·¯å¤ç”¨çš„ç‰¹ç‚¹æ˜¯é€šè¿‡ä¸€ç§æœºåˆ¶ä¸€ä¸ªè¿›ç¨‹èƒ½åŒæ—¶ç­‰å¾…å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œè¿™äº›æ–‡ä»¶æè¿°ç¬¦ï¼ˆå¥—æ¥å­—æè¿°ç¬¦ï¼‰å…¶ä¸­çš„ä»»æ„ä¸€ä¸ªè¿›å…¥è¯»å°±ç»ªçŠ¶æ€ï¼Œselect()å‡½æ•°å°±å¯ä»¥è¿”å›ã€‚ ç¼ºç‚¹ï¼š</p><ol><li><p>æ¯æ¬¡è°ƒç”¨selectï¼Œéƒ½éœ€è¦æŠŠfdé›†åˆä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªå¼€é”€åœ¨fdå¾ˆå¤šæ—¶ä¼šå¾ˆå¤§</p></li><li><p>åŒæ—¶æ¯æ¬¡è°ƒç”¨selectéƒ½éœ€è¦åœ¨å†…æ ¸éå†ä¼ é€’è¿›æ¥çš„æ‰€æœ‰fdï¼Œè¿™ä¸ªå¼€é”€åœ¨fdå¾ˆå¤šæ—¶ä¹Ÿå¾ˆå¤§</p></li><li><p>selectæ”¯æŒçš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¤ªå°äº†ï¼Œé»˜è®¤æ˜¯1024</p></li></ol><h3 id="poll"><a class="header-anchor" href="#poll"></a>poll</h3><p>ä¸selectæ¨¡å‹åŸºæœ¬ç›¸ä¼¼ã€‚ä¸åŒä¹‹å¤„ 1. åœ¨äºpollå¯¹äºfdå¹¶æ²¡æœ‰æœ€å¤§æ•°é‡é™åˆ¶ï¼ˆä½†æ˜¯æ•°é‡è¿‡å¤§åæ€§èƒ½ä¹Ÿæ˜¯ä¼šä¸‹é™</p><ol start="2"><li>pollæœ‰ä¸€ä¸ªç‰¹ç‚¹æ˜¯æ°´å¹³è§¦å‘ï¼Œä¹Ÿå°±æ˜¯é€šçŸ¥ç¨‹åºfdå°±ç»ªåï¼Œè¿™æ¬¡æ²¡æœ‰è¢«å¤„ç†ï¼Œé‚£ä¹ˆä¸‹æ¬¡pollçš„æ—¶å€™ä¼šå†æ¬¡é€šçŸ¥åŒä¸ªfdå·²ç»å°±ç»ª</li></ol><h3 id="epoll"><a class="header-anchor" href="#epoll"></a>epoll</h3><p><strong>å¢å¼ºç‰ˆçš„selectå’Œpoll</strong> 1. epollåŒæ ·å’Œpollæ²¡æœ‰fdçš„æ•°é‡é™åˆ¶</p><ol start="2"><li><p>å®ƒå¤„ç†æ–¹å¼å¼é€šè¿‡å›è°ƒå‡½æ•°çš„æ–¹å¼ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚fdéƒ½ä¼šæ³¨å†Œäº‹ä»¶å›è°ƒï¼Œè§¦å‘å›è°ƒå‡½æ•°å°†fdå’Œäº‹ä»¶çŠ¶æ€è¿”å›ç»™pollå¯¹è±¡ã€‚</p></li><li><p>ä»2å¯ä»¥çœ‹å‡ºepollä¸selectï¼Œpollçš„ä¸»åŠ¨è½®è¯¢åŒºåˆ«ï¼Œepollæ˜¯äº‹ä»¶é©±åŠ¨è¢«åŠ¨è§¦å‘æ–¹å¼ï¼Œå¯¹äºå¤§é‡fdä¸”ä¸æ˜¯æ‰€æœ‰éƒ½æ´»è·ƒçš„æƒ…å†µä¸‹æ€§èƒ½æ›´åŠ å¥½ã€‚</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¤šè·¯å¤ç”¨æ¨¡å‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Stunnel</title>
    <link href="/2019/05/23/stunnel/"/>
    <url>/2019/05/23/stunnel/</url>
    
    <content type="html"><![CDATA[<p><strong>å¾ˆé«˜å…´ï¼ï¼è¯´çš„é€šè¿‡Amazon alexa éŸ³ç®±æ¥æ’­æ”¾IPCè§†é¢‘çš„ç›®æ ‡å·²ç»å®ç°äº†ã€‚</strong></p><ul><li>æ­¤æ¬¡éªŒè¯äº†å½“åˆé€šè¿‡RTSP redirect çš„æ–¹æ¡ˆæ¥å®ç°æ­¤éœ€æ±‚çš„å¯è¡Œæ€§</li></ul><blockquote><p>å…ˆçœ‹æ•ˆæœ</p></blockquote><video type='video/mp4' controls='controls'  width='50%' height='20%'><source src="/video/Stunnel.mp4"></video><p>ä¸ºäº†æ»¡è¶³Amazonçš„æ¡ä»¶ï¼Œæœ€åä¸€æ­¥éœ€è¦ç»™RTSPé€šè¿‡CAè¯ä¹¦çš„åŠ å¯†ã€‚RTSPä¸åŒäºHTTPåè®®ï¼Œæ— æ³•é€šè¿‡nginxæˆ–è€…Apacheç­‰è½¯ä»¶æ–¹ä¾¿çš„å¼•å…¥certå’Œkeyè¿›è¡ŒsslåŠ å¯†ï¼Œæˆ‘è¿™æ¬¡é€‰æ‹©çš„æ˜¯<strong>Stunnel</strong></p><blockquote><p>Stunnelæ˜¯ä¸€ä¸ªè‡ªç”±çš„è·¨å¹³å°è½¯ä»¶ï¼Œç”¨äºæä¾›å…¨å±€çš„TLS/SSLæœåŠ¡ã€‚é’ˆå¯¹æœ¬èº«æ— æ³•è¿›è¡ŒTLSæˆ–SSLé€šä¿¡çš„å®¢æˆ·ç«¯åŠæœåŠ¡å™¨ï¼ŒStunnelå¯æä¾›å®‰å…¨çš„åŠ å¯†è¿æ¥ã€‚è¯¥è½¯ä»¶å¯åœ¨è®¸å¤šæ“ä½œç³»ç»Ÿä¸‹è¿è¡Œï¼ŒåŒ…æ‹¬Unix-likeç³»ç»Ÿï¼Œä»¥åŠWindowsã€‚Stunnelä¾èµ–äºæŸä¸ªç‹¬ç«‹çš„åº“ï¼Œå¦‚OpenSSLæˆ–è€…SSLeayï¼Œä»¥å®ç°TLSæˆ–SSLåè®®</p></blockquote><p>ubuntuç³»ç»Ÿä¸‹é€šè¿‡<code>apt-get install Stunnel4</code>å®‰è£… å®‰è£…å®Œæˆåè¿›å…¥<code>cd /etc/stunnel</code>ç›®å½• <code>vi stunnel.conf</code> åŸæ¥è¿™ä¸ªç›®å½•æ˜¯æ²¡æœ‰stunnel.confè¿™ä¸ªæ–‡ä»¶çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>cat REDEME</code> çœ‹åˆ°<code>/usr/share/doc/stunnel4/examples/stunnel.conf-sample</code>ç›®å½•ä¸‹æœ‰ä¸ªç¤ºä¾‹æ–‡ä»¶</p><pre><code class="hljs shell">; Sample stunnel configuration file for Unix by Michal Trojnara 2002-2015; Some options used here may be inadequate for your particular configuration; This sample file does *not* represent stunnel.conf defaults; Please consult the manual for detailed description of available options; **************************************************************************; * Global options                                                         *; **************************************************************************; It is recommended to drop root privileges if stunnel is started by root;setuid = stunnel4;setgid = stunnel4; PID file is created inside the chroot jail (if enabled);pid = /var/run/stunnel.pid; Debugging stuff (may be useful for troubleshooting);foreground = yes;debug = info;output = /var/log/stunnel.log; Enable FIPS 140-2 mode if needed for compliance;fips = yes; **************************************************************************; * Service defaults may also be specified in individual service sections  *; **************************************************************************; Enable support for the insecure SSLv3 protocol;options = -NO_SSLv3; These options provide additional security at some performance degradation;options = SINGLE_ECDH_USE;options = SINGLE_DH_USE; **************************************************************************; * Include all configuration file fragments from the specified folder     *; **************************************************************************;include = /etc/stunnel/conf.d; **************************************************************************; * Service definitions (remove all services for inetd mode)               *; **************************************************************************; ***************************************** Example TLS client mode services; The following examples use /etc/ssl/certs, which is the common location; of a hashed directory containing trusted CA certificates.  This is not; a hardcoded path of the stunnel package, as it is not related to the; stunnel configuration in /etc/stunnel/.[gmail-pop3]client = yesaccept = 127.0.0.1:110connect = pop.gmail.com:995verify = 2CApath = @sysconfdir/ssl/certscheckHost = pop.gmail.comOCSPaia = yes[gmail-imap]client = yesaccept = 127.0.0.1:143connect = imap.gmail.com:993verify = 2CApath = @sysconfdir/ssl/certscheckHost = imap.gmail.comOCSPaia = yes[gmail-smtp]client = yesaccept = 127.0.0.1:25connect = smtp.gmail.com:465verify = 2CApath = @sysconfdir/ssl/certscheckHost = smtp.gmail.comOCSPaia = yes; ***************************************** Example TLS server mode services;[pop3s];accept  = 995;connect = 110;cert = /etc/stunnel/stunnel.pem;[imaps];accept  = 993;connect = 143;cert = /etc/stunnel/stunnel.pem;[ssmtp];accept  = 465;connect = 25;cert = /etc/stunnel/stunnel.pem; TLS front-end to a web server;[https];accept  = 443;connect = 80;cert = /etc/stunnel/stunnel.pem; &quot;TIMEOUTclose = 0&quot; is a workaround for a design flaw in Microsoft SChannel; Microsoft implementations do not use TLS close-notify alert and thus they; are vulnerable to truncation attacks;TIMEOUTclose = 0; Remote shell protected with PSK-authenticated TLS; Create &quot;/etc/stunnel/secrets.txt&quot; containing IDENTITY:KEY pairs;[shell];accept = 1337;exec = /bin/sh;execArgs = sh -i;ciphers = PSK;PSKsecrets = /etc/stunnel/secrets.txt; Non-standard MySQL-over-TLS encapsulation connecting the Unix socket;[mysql];cert = /etc/stunnel/stunnel.pem;accept = 3307;connect = /run/mysqld/mysqld.sock; vim:ft=dosini</code></pre><p>å¯ä»¥ç›´æ¥æ‹·è´è¿‡æ¥ç„¶åä¿®æ”¹ï¼Œå°†ä¸éœ€è¦çš„å†…å®¹éƒ½æ³¨é‡Šæ‰ï¼Œæœ€ååœ¨å†…å®¹ä¸­å¢åŠ äº†ä»¥ä¸‹å†…å®¹å³å¯</p><pre><code class="hljs shell">cert = /etc/stunnel/rtsp.pemkey = /etc/stunnel/rtsp.key; Some performance tuningssocket = l:TCP_NODELAY=1socket = r:TCP_NODELAY=1output = /var/log/stunnel.log; Some debugging stuff useful for troubleshooting;debug = 7;foreground=yes; Service-level configuration[rtsp]client = noaccept = 443connect = 554 TIMEOUTclose = 0</code></pre><p>å…¶ä¸­<code>[RTSP]</code>ä¸‹é¢çš„å†…å®¹ä¸ºæœ¬æ¬¡RTSPéœ€è¦åŠ å¯†çš„é…ç½® <code>client = no</code> noä¸ºæœåŠ¡ç«¯ï¼Œyesä¸ºå®¢æˆ·ç«¯ <code>accept</code> ä»£è¡¨æš´éœ²çš„ç«¯å£ <code>connect</code> ä»£è¡¨ç›‘å¬çš„ç«¯å£ é…ç½®å¥½é‡å¯å³å¯</p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ä»£ç†</tag>
      
      <tag>tcp</tag>
      
      <tag>ssl</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RTSPåè®®</title>
    <link href="/2019/05/13/rtsp%E5%8D%8F%E8%AE%AE/"/>
    <url>/2019/05/13/rtsp%E5%8D%8F%E8%AE%AE/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å…¬å¸æœ‰ä¸ªéœ€æ±‚ï¼Œå¯¹æ¥alexa å¹³å°çš„camera skillã€‚å°±æ˜¯å°†ipcçš„è§†é¢‘æµæ”¾åˆ°æ™ºèƒ½å¸¦å±éŸ³ç®±ä¸Šæ’­æ”¾å‡ºæ¥ï¼Œè¿™ä¸ªéœ€æ±‚çœ‹ä¼¼å¥½åƒæ¯”è¾ƒç®€å•å…¶å®å‘çš„ä¸€åŒ¹ğŸ˜­ é¦–å…ˆæˆ‘ä»¬å…·å¤‡çš„åŸºç¡€æ¡ä»¶æ˜¯ï¼š</p><ul><li>å…¬å¸çš„ipcæ²¡æœ‰å…¬ç½‘ç½‘å¡ï¼Œè§†é¢‘æµåªèƒ½åœ¨å±€åŸŸç½‘ä¸­æ’­æ”¾ã€‚</li><li>ç°æœ‰ipcæ˜¯ä¸ºserveræ¨¡å¼ï¼Œå¹¶ä¸”åªæ¥å—è¢«åŠ¨è¯·æ±‚ï¼Œä¸ä¼šä¸»åŠ¨æ¨rtspæµã€‚</li><li>Amazon alexa å¹³å°ç¡¬æ€§è¦æ±‚æ‰€æœ‰çš„rtspæµéœ€è¦è¿›è¡Œäºšé©¬é€Šè®¤è¯çš„CA TLS: <img src="https://blog.wenboo.top/wp-content/uploads/2019/05/eb6f877c69981e9482f4a7ae50d72880.png" alt=""></li></ul><h4 id="é¢ä¸´çš„é—®é¢˜"><a class="header-anchor" href="#é¢ä¸´çš„é—®é¢˜"></a>é¢ä¸´çš„é—®é¢˜</h4><p>å±€åŸŸç½‘çš„rtspæµæ— æ³•è¿›è¡ŒCAè®¤è¯çš„TLSåŠ å¯† 2. å°±ç®—æ­å»ºæ‹‰ç –æ¨æµæœåŠ¡å™¨å†åŠ å¯†ï¼Œä½†æ˜¯å±€åŸŸç½‘çš„ipè¡Œæ‹‰å–ã€‚</p><h4 id="è§£å†³æ–¹æ¡ˆ"><a class="header-anchor" href="#è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><ol><li>æ­å»ºrtspæµè½¬å‘æœåŠ¡å™¨ï¼Œå…¬å¸ç°æœ‰ipcä¸å…·å¤‡æ¨æµæ¡ä»¶ï¼ˆèˆå¼ƒï¼‰</li><li>åœ¨alexa skill store æœ‰çœ‹åˆ°ä¸€å®¶è§£å†³æ–¹æ¡ˆ <strong>Monocle</strong></li></ol><blockquote><p><img src="https://blog.wenboo.top/wp-content/uploads/2019/05/3b7c79a670f8fe4fffd295ee1833a13f.png" alt=""></p></blockquote><p>ä»–ä»¬é€šè¿‡è®¤è¯ç½‘å…³çš„å½¢å¼æ¥è¾¾åˆ°ç›®çš„ï¼Œä½†æ˜¯å…·ä½“çš„å®ç°ä¸çŸ¥ã€‚ä¸‹ä¸€æ­¥å¾—å…ˆå­¦ä¹ ä¸‹RTSPåè®®çš„å†…å®¹ <a href="https://tools.ietf.org/html/rfc2326" title="RFC 2326">RFC 2326</a>ã€‚</p><blockquote><p>ä»RTSPåè®®æ–‡æ¡£ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒRTSPå…·å¤‡å’ŒHTTPç±»ä¼¼çš„é‡å®šå‘åŠŸèƒ½(redirect 3xx)</p></blockquote><p>`A redirect request informs the client that it must connect to another server location. It contains the mandatory header Location, which indicates that the client should issue requests for that URL. It may contain the parameter Range, which indicates when the redirection takes effect. If the client wants to continue to send or receive media for this URI, the client MUST issue a TEARDOWN request for the current session and a SETUP for the new session at the designated host. This example request redirects traffic for this URI to the new server at the given play time:</p><pre><code class="hljs apache"><span class="hljs-attribute">S</span>-&gt;C: REDIRECT rtsp://example.com/fizzle/foo RTSP/<span class="hljs-number">1</span>.<span class="hljs-number">0</span>      <span class="hljs-attribute">CSeq</span>: <span class="hljs-number">732</span>      <span class="hljs-attribute">Location</span>: rtsp://bigserver.com:<span class="hljs-number">8001</span>      <span class="hljs-attribute">Range</span>: clock=<span class="hljs-number">19960213</span>T<span class="hljs-number">143205</span>Z-`</code></pre><p><strong>æˆ‘çŒœæƒ³Monocleçš„å®ç°æ–¹æ³•åº”è¯¥å°±æ˜¯åˆ©ç”¨äº†è¿™ä¸€ä¸ªç‰¹æ€§</strong> å¼€å§‹å»ç½‘ä¸Šæ‰¾è½®å­ï¼Œgithub ï¼ŒGoogleï¼Œç™¾åº¦æœäº†ä¸ªéåŸºæœ¬æ²¡æœ‰ç°æˆçš„è½®å­ã€‚è¿™ä¸ªæ–¹æ³•ç”¨çš„äººåº”è¯¥éå¸¸å°‘ï¼Œè‘—åçš„RTSPå¼€æºé¡¹ç›®Live555ä¹Ÿæ²¡æœ‰å®ç°è¿™ä¸ªæ ‡å‡†ç‰¹æ€§ã€‚ æ‰€ä»¥æˆ‘åˆå¼€å§‹å­¦ä¹ Live555çš„æºç ï¼ˆä»æ²¡å†™è¿‡C++çš„ï¼Œè¡¨ç¤ºè¿™çœŸçš„æ˜¯åœ¨éš¾ä¸ºæˆ‘å•Š~~~)æƒ³é€šè¿‡ä¿®æ”¹æºç æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚ <img src="https://blog.wenboo.top/wp-content/uploads/2019/05/d4a9763c42ee32ebfe4b6d44bd036a2c.png" alt=""> ä¸è¿‡ç›®å‰ç¦»æˆ‘çš„çŒœæƒ³å·²ç»å¾ˆè¿‘äº†ï¼Œç°åœ¨é€šè¿‡æŠ“åŒ…å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°äº†RTSPåè®®çš„äº¤äº’è¿‡ç¨‹ã€‚ Cè¡¨ç¤ºRTSPå®¢æˆ·ç«¯, Sè¡¨ç¤ºRTSPæœåŠ¡ç«¯</p><ol><li><p><strong>ç¬¬ä¸€æ­¥ï¼šæŸ¥è¯¢æœåŠ¡å™¨ç«¯å¯ç”¨æ–¹æ³•</strong></p></li><li><p>C-&gt;S: OPTION request //è¯¢é—®Sæœ‰å“ªäº›æ–¹æ³•å¯ç”¨ 1. S-&gt;C: OPTION response //Så›åº”ä¿¡æ¯çš„publicå¤´å­—æ®µä¸­åŒ…æ‹¬æä¾›çš„æ‰€æœ‰å¯ç”¨æ–¹æ³•</p></li><li><p><strong>ç¬¬äºŒæ­¥ï¼šå¾—åˆ°åª’ä½“æè¿°ä¿¡æ¯</strong></p></li><li><p>C-&gt;S: DESCRIBE request //è¦æ±‚å¾—åˆ°Sæä¾›çš„åª’ä½“æè¿°ä¿¡æ¯ 2. S-&gt;C: DESCRIBE response //Så›åº”åª’ä½“æè¿°ä¿¡æ¯ï¼Œä¸€èˆ¬æ˜¯sdpä¿¡æ¯</p></li><li><p><strong>ç¬¬ä¸‰æ­¥ï¼šå»ºç«‹****RTSP****ä¼šè¯</strong></p></li><li><p>C-&gt;S: SETUP request //é€šè¿‡Transportå¤´å­—æ®µåˆ—å‡ºå¯æ¥å—çš„ä¼ è¾“é€‰é¡¹ï¼Œè¯·æ±‚Så»ºç«‹ä¼šè¯ 3. S-&gt;C: SETUP response //Så»ºç«‹ä¼šè¯ï¼Œé€šè¿‡Transportå¤´å­—æ®µè¿”å›é€‰æ‹©çš„å…·ä½“è½¬è¾“é€‰é¡¹ï¼Œå¹¶è¿”å›å»ºç«‹çš„Session ID;</p></li><li><p><strong>ç¬¬å››æ­¥ï¼šè¯·æ±‚å¼€å§‹ä¼ é€æ•°æ®</strong></p></li><li><p>C-&gt;S: PLAY request //Cè¯·æ±‚Så¼€å§‹å‘é€æ•°æ® 4. S-&gt;C: PLAY response //Så›åº”è¯¥è¯·æ±‚çš„ä¿¡æ¯</p></li><li><p><strong>ç¬¬äº”æ­¥ï¼š</strong> ******æ•°æ®ä¼ é€æ’­æ”¾ä¸­**</p></li></ol><p>S-&gt;C: å‘é€æµåª’ä½“æ•°æ® // é€šè¿‡RTPåè®®ä¼ é€æ•°æ®</p><ol start="6"><li><p><strong>ç¬¬å…­æ­¥ï¼šå…³é—­ä¼šè¯ï¼Œé€€å‡º</strong></p></li><li><p>C-&gt;S: TEARDOWN request //Cè¯·æ±‚å…³é—­ä¼šè¯ 6. S-&gt;C: TEARDOWN response //Så›åº”è¯¥è¯·æ±‚</p></li></ol><p><img src="https://blog.wenboo.top/wp-content/uploads/2019/05/f73b01c1e1d5a8fac285228863196c78.png" alt=""> <img src="https://blog.wenboo.top/wp-content/uploads/2019/05/49f4629698a5327a89a2d973207bd66d.png" alt=""></p><p>å¯ä»¥ä¿®æ”¹é€šè¿‡ä¿®æ”¹SETUP Phaseå½“ä¸­çš„äº¤äº’è¿”å›æ¥å®ç°ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>ç½‘ç»œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>rtsp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>http1.0ã€http1.1ã€http2.0</title>
    <link href="/2019/05/08/http1-0%E3%80%81http1-1%E3%80%81http2-0/"/>
    <url>/2019/05/08/http1-0%E3%80%81http1-1%E3%80%81http2-0/</url>
    
    <content type="html"><![CDATA[<p><strong>ä¸€ã€æ±‡æ€»å¯¹æ¯”</strong></p><table><thead><tr><th>HTTP1.0</th><th>æ— çŠ¶æ€ã€æ— è¿æ¥</th></tr></thead><tbody><tr><td>HTTP1.1</td><td>æŒä¹…è¿æ¥<br>è¯·æ±‚ç®¡é“åŒ– <br>å¢åŠ ç¼“å­˜å¤„ç†ï¼ˆæ–°çš„å­—æ®µå¦‚cache-controlï¼‰<br>å¢åŠ Hostå­—æ®µã€æ”¯æŒæ–­ç‚¹ä¼ è¾“ç­‰ï¼ˆæŠŠæ–‡ä»¶åˆ†æˆå‡ éƒ¨åˆ†)</td></tr><tr><td>HTTP2.0</td><td>äºŒè¿›åˆ¶åˆ†å¸§<br>å¤šè·¯å¤ç”¨ï¼ˆæˆ–è¿æ¥å…±äº«ï¼‰<br>å¤´éƒ¨å‹ç¼© <br>æœåŠ¡å™¨æ¨é€</td></tr></tbody></table><p><strong>äºŒã€HTTP1.0ï¼š</strong> æµè§ˆå™¨çš„æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦ä¸æœåŠ¡å™¨å»ºç«‹ä¸€ä¸ª <code>TCP</code> è¿æ¥ï¼ŒæœåŠ¡å™¨å¤„ç†å®Œæˆåç«‹å³æ–­å¼€ <code>TCP</code> è¿æ¥ï¼ˆæ— è¿æ¥ï¼‰ï¼ŒæœåŠ¡å™¨ä¸è·Ÿè¸ªæ¯ä¸ªå®¢æˆ·ç«¯ä¹Ÿä¸è®°å½•è¿‡å»çš„è¯·æ±‚ï¼ˆæ— çŠ¶æ€ï¼‰ã€‚ <strong>ä¸‰ã€HTTP1.1ï¼š</strong> HTTP/1.0ä¸­é»˜è®¤ä½¿ç”¨Connection: closeã€‚åœ¨HTTP/1.1ä¸­å·²ç»é»˜è®¤ä½¿ç”¨Connection: keep-aliveï¼Œé¿å…äº†è¿æ¥å»ºç«‹å’Œé‡Šæ”¾çš„å¼€é”€ï¼Œä½†æœåŠ¡å™¨å¿…é¡»æŒ‰ç…§å®¢æˆ·ç«¯è¯·æ±‚çš„å…ˆåé¡ºåºä¾æ¬¡å›é€ç›¸åº”çš„ç»“æœï¼Œä»¥ä¿è¯å®¢æˆ·ç«¯èƒ½å¤ŸåŒºåˆ†å‡ºæ¯æ¬¡è¯·æ±‚çš„å“åº”å†…å®¹ã€‚é€šè¿‡ <code>Content-Length</code> å­—æ®µæ¥åˆ¤æ–­å½“å‰è¯·æ±‚çš„æ•°æ®æ˜¯å¦å·²ç»å…¨éƒ¨æ¥æ”¶ã€‚ä¸å…è®¸åŒæ—¶å­˜åœ¨ä¸¤ä¸ª<strong>å¹¶è¡Œçš„å“åº”</strong>ã€‚ <strong>å››ã€HTTP2.0ï¼š</strong> <code>HTTP/2</code> å¼•å…¥ <code>äºŒè¿›åˆ¶æ•°æ®å¸§</code> å’Œ <code>æµ</code> çš„æ¦‚å¿µï¼Œå…¶ä¸­å¸§å¯¹æ•°æ®è¿›è¡Œé¡ºåºæ ‡è¯†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™æ ·æµè§ˆå™¨æ”¶åˆ°æ•°æ®ä¹‹åï¼Œå°±å¯ä»¥æŒ‰ç…§åºåˆ—å¯¹æ•°æ®è¿›è¡Œåˆå¹¶ï¼Œè€Œä¸ä¼šå‡ºç°åˆå¹¶åæ•°æ®é”™ä¹±çš„æƒ…å†µã€‚åŒæ ·æ˜¯å› ä¸ºæœ‰äº†åºåˆ—ï¼ŒæœåŠ¡å™¨å°±å¯ä»¥å¹¶è¡Œçš„ä¼ è¾“æ•°æ®ï¼Œè¿™å°±æ˜¯ <code>æµ</code> æ‰€åšçš„äº‹æƒ…ã€‚</p><table><thead><tr><th>æµï¼ˆ <code>stream</code> ï¼‰</th><th>å·²å»ºç«‹è¿æ¥ä¸Šçš„åŒå‘å­—èŠ‚æµ</th></tr></thead><tbody><tr><td>æ¶ˆæ¯</td><td>ä¸é€»è¾‘æ¶ˆæ¯å¯¹åº”çš„å®Œæ•´çš„ä¸€ç³»åˆ—æ•°æ®å¸§</td></tr><tr><td>å¸§</td><td><code>HTTP2.0</code> é€šä¿¡çš„æœ€å°å•ä½ï¼Œæ¯ä¸ªå¸§åŒ…å«å¸§å¤´éƒ¨ï¼Œè‡³å°‘ä¹Ÿä¼šæ ‡è¯†å‡ºå½“å‰å¸§æ‰€å±çš„æµï¼ˆ <code>stream id</code> ï¼‰ã€‚</td></tr></tbody></table><p><strong>å¤šè·¯å¤ç”¨</strong>ï¼š 1ã€æ‰€æœ‰çš„ <code>HTTP2.0</code> é€šä¿¡éƒ½åœ¨ä¸€ä¸ª <code>TCP</code> è¿æ¥ä¸Šå®Œæˆï¼Œè¿™ä¸ªè¿æ¥å¯ä»¥æ‰¿è½½ä»»æ„æ•°é‡çš„åŒå‘æ•°æ®æµã€‚ 2ã€æ¯ä¸ªæ•°æ®æµä»¥æ¶ˆæ¯çš„å½¢å¼å‘é€ï¼Œè€Œæ¶ˆæ¯ç”±ä¸€æˆ–å¤šä¸ªå¸§ç»„æˆã€‚è¿™äº›å¸§å¯ä»¥ä¹±åºå‘é€ï¼Œç„¶åå†æ ¹æ®æ¯ä¸ªå¸§å¤´éƒ¨çš„æµæ ‡è¯†ç¬¦ï¼ˆ <code>stream id</code> ï¼‰é‡æ–°ç»„è£…ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œæ¯ä¸ªè¯·æ±‚æ˜¯ä¸€ä¸ªæ•°æ®æµï¼Œæ•°æ®æµä»¥æ¶ˆæ¯çš„æ–¹å¼å‘é€ï¼Œè€Œæ¶ˆæ¯åˆåˆ†ä¸ºå¤šä¸ªå¸§ï¼Œå¸§å¤´éƒ¨è®°å½•ç€ <code>stream id</code> ç”¨æ¥æ ‡è¯†æ‰€å±çš„æ•°æ®æµï¼Œä¸åŒå±çš„å¸§å¯ä»¥åœ¨è¿æ¥ä¸­éšæœºæ··æ‚åœ¨ä¸€èµ·ã€‚æ¥æ”¶æ–¹å¯ä»¥æ ¹æ® <code>stream id</code> å°†å¸§å†å½’å±åˆ°å„è‡ªä¸åŒçš„è¯·æ±‚å½“ä¸­å»ã€‚ 3ã€å¦å¤–ï¼Œå¤šè·¯å¤ç”¨ï¼ˆè¿æ¥å…±äº«ï¼‰å¯èƒ½ä¼šå¯¼è‡´å…³é”®è¯·æ±‚è¢«é˜»å¡ã€‚ <code>HTTP2.0</code> é‡Œæ¯ä¸ªæ•°æ®æµéƒ½å¯ä»¥è®¾ç½®ä¼˜å…ˆçº§å’Œä¾èµ–ï¼Œä¼˜å…ˆçº§é«˜çš„æ•°æ®æµä¼šè¢«æœåŠ¡å™¨ä¼˜å…ˆå¤„ç†å’Œè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæ•°æ®æµè¿˜å¯ä»¥ä¾èµ–å…¶ä»–çš„å­æ•°æ®æµã€‚ 4ã€å¯è§ï¼Œ <code>HTTP2.0</code> å®ç°äº†çœŸæ­£çš„å¹¶è¡Œä¼ è¾“ï¼Œå®ƒèƒ½å¤Ÿåœ¨ä¸€ä¸ª <code>TCP</code> ä¸Šè¿›è¡Œä»»æ„æ•°é‡ <code>HTTP</code> è¯·æ±‚ã€‚è€Œè¿™ä¸ªå¼ºå¤§çš„åŠŸèƒ½åˆ™æ˜¯åŸºäºâ€œäºŒè¿›åˆ¶åˆ†å¸§â€çš„ç‰¹æ€§ã€‚ <strong>å¤´éƒ¨å‹ç¼©</strong> åœ¨ <code>HTTP1.x</code> ä¸­ï¼Œå¤´éƒ¨å…ƒæ•°æ®éƒ½æ˜¯ä»¥çº¯æ–‡æœ¬çš„å½¢å¼å‘é€çš„ï¼Œé€šå¸¸ä¼šç»™æ¯ä¸ªè¯·æ±‚å¢åŠ 500~800å­—èŠ‚çš„è´Ÿè·ã€‚ <code>HTTP2.0</code> ä½¿ç”¨ <code>encoder</code> æ¥å‡å°‘éœ€è¦ä¼ è¾“çš„ <code>header</code> å¤§å°ï¼Œé€šè®¯åŒæ–¹å„è‡ª <code>cache</code> ä¸€ä»½ <code>header fields</code> è¡¨ï¼Œæ—¢é¿å…äº†é‡å¤ <code>header</code> çš„ä¼ è¾“ï¼Œåˆå‡å°äº†éœ€è¦ä¼ è¾“çš„å¤§å°ã€‚é«˜æ•ˆçš„å‹ç¼©ç®—æ³•å¯ä»¥å¾ˆå¤§çš„å‹ç¼© <code>header</code> ï¼Œå‡å°‘å‘é€åŒ…çš„æ•°é‡ä»è€Œé™ä½å»¶è¿Ÿã€‚ <strong>æœåŠ¡å™¨æ¨é€</strong>ï¼š æœåŠ¡å™¨é™¤äº†å¯¹æœ€åˆè¯·æ±‚çš„å“åº”å¤–ï¼ŒæœåŠ¡å™¨è¿˜å¯ä»¥é¢å¤–çš„å‘å®¢æˆ·ç«¯æ¨é€èµ„æºï¼Œè€Œæ— éœ€å®¢æˆ·ç«¯æ˜ç¡®çš„è¯·æ±‚ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>ç½‘ç»œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HTTPç‰ˆæœ¬å¯¹æ¯”</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TCPåè®®ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹</title>
    <link href="/2019/04/08/tcp%E5%8D%8F%E8%AE%AE%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/"/>
    <url>/2019/04/08/tcp%E5%8D%8F%E8%AE%AE%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/</url>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡è½¬è‡ªï¼š<a href="https://mp.weixin.qq.com/s/ikVublI1pzJyllENYKZhZA" title="Linuxå…¬ç¤¾">Linuxå…¬ç¤¾</a></strong> 1ã€ä¸‰æ¬¡æ¡æ‰‹ ï¼ˆ1ï¼‰ä¸‰æ¬¡æ¡æ‰‹çš„è¯¦è¿° é¦–å…ˆClientç«¯å‘é€è¿æ¥è¯·æ±‚æŠ¥æ–‡ï¼ŒServeræ®µæ¥å—è¿æ¥åå›å¤ACKæŠ¥æ–‡ï¼Œå¹¶ä¸ºè¿™æ¬¡è¿æ¥åˆ†é…èµ„æºã€‚Clientç«¯æ¥æ”¶åˆ°ACKæŠ¥æ–‡åä¹Ÿå‘Serveræ®µå‘ç”ŸACKæŠ¥æ–‡ï¼Œå¹¶åˆ†é…èµ„æºï¼Œè¿™æ ·TCPè¿æ¥å°±å»ºç«‹äº†ã€‚ <img src="https://blog.wenboo.top/wp-content/uploads/2019/04/20dce2ef7675491e9e20fba4ad8d47b4.png" alt=""> æœ€åˆä¸¤ç«¯çš„TCPè¿›ç¨‹éƒ½å¤„äºCLOSEDå…³é—­çŠ¶æ€ï¼ŒAä¸»åŠ¨æ‰“å¼€è¿æ¥ï¼Œè€ŒBè¢«åŠ¨æ‰“å¼€è¿æ¥ã€‚ï¼ˆ<strong>Aã€Bå…³é—­çŠ¶æ€CLOSED</strong>â€”â€”<strong>Bæ”¶å¬çŠ¶æ€LISTENâ€”â€”AåŒæ­¥å·²å‘é€çŠ¶æ€SYN-SENTâ€”â€”BåŒæ­¥æ”¶åˆ°çŠ¶æ€SYN-RCVDâ€”â€”Aã€Bè¿æ¥å·²å»ºç«‹çŠ¶æ€ESTABLISHED</strong>ï¼‰</p><ul><li><p>Bçš„TCPæœåŠ¡å™¨è¿›ç¨‹å…ˆåˆ›å»ºä¼ è¾“æ§åˆ¶å—TCBï¼Œå‡†å¤‡æ¥å—å®¢æˆ·è¿›ç¨‹çš„è¿æ¥è¯·æ±‚ã€‚ç„¶åæœåŠ¡å™¨è¿›ç¨‹å°±å¤„äºLISTENï¼ˆæ”¶å¬ï¼‰çŠ¶æ€ï¼Œç­‰å¾…å®¢æˆ·çš„è¿æ¥è¯·æ±‚ã€‚è‹¥æœ‰ï¼Œåˆ™ä½œå‡ºå“åº”ã€‚</p></li><li><p><strong>1****ï¼‰ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼š<strong>Açš„TCPå®¢æˆ·è¿›ç¨‹ä¹Ÿæ˜¯é¦–å…ˆåˆ›å»ºä¼ è¾“æ§åˆ¶å—TCBï¼Œç„¶åå‘Bå‘å‡ºè¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µï¼Œï¼ˆé¦–éƒ¨çš„</strong>åŒæ­¥ä½SYN=1</strong>ï¼Œ<strong>åˆå§‹åºå·seq=xï¼‰</strong>ï¼Œï¼ˆSYN=1çš„æŠ¥æ–‡æ®µä¸èƒ½æºå¸¦æ•°æ®ï¼‰ä½†è¦æ¶ˆè€—æ‰ä¸€ä¸ªåºå·ï¼Œæ­¤æ—¶TCPå®¢æˆ·è¿›ç¨‹è¿›å…¥SYN-SENTï¼ˆåŒæ­¥å·²å‘é€ï¼‰çŠ¶æ€ã€‚</p></li><li><p>**2****ï¼‰ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼š**Bæ”¶åˆ°è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µåï¼Œå¦‚åŒæ„å»ºç«‹è¿æ¥ï¼Œåˆ™å‘Aå‘é€ç¡®è®¤ï¼Œåœ¨ç¡®è®¤æŠ¥æ–‡æ®µä¸­ï¼ˆ<strong>SYN=1ï¼ŒACK=1ï¼Œç¡®è®¤å·ack=x+1ï¼Œåˆå§‹åºå·seq=y</strong>ï¼‰ï¼Œæµ‹è¯•TCPæœåŠ¡å™¨è¿›ç¨‹è¿›å…¥SYN-RCVDï¼ˆåŒæ­¥æ”¶åˆ°ï¼‰çŠ¶æ€ï¼›</p></li><li><p>**3****ï¼‰ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼š**TCPå®¢æˆ·è¿›ç¨‹æ”¶åˆ°Bçš„ç¡®è®¤åï¼Œè¦å‘Bç»™å‡ºç¡®è®¤æŠ¥æ–‡æ®µï¼ˆ<strong>ACK=1ï¼Œç¡®è®¤å·ack=y+1ï¼Œåºå·seq=x+1</strong>ï¼‰ï¼ˆåˆå§‹ä¸ºseq=xï¼Œç¬¬äºŒä¸ªæŠ¥æ–‡æ®µæ‰€ä»¥è¦+1ï¼‰ï¼ŒACKæŠ¥æ–‡æ®µå¯ä»¥æºå¸¦æ•°æ®ï¼Œä¸æºå¸¦æ•°æ®åˆ™ä¸æ¶ˆè€—åºå·ã€‚TCPè¿æ¥å·²ç»å»ºç«‹ï¼ŒAè¿›å…¥ESTABLISHEDï¼ˆå·²å»ºç«‹è¿æ¥ï¼‰ã€‚</p></li><li><p>å½“Bæ”¶åˆ°Açš„ç¡®è®¤åï¼Œä¹Ÿè¿›å…¥ESTABLISHEDçŠ¶æ€ã€‚</p></li></ul><p>ï¼ˆ2ï¼‰æ€»ç»“ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼š</p><ul><li><p><strong>ç¬¬ä¸€æ¬¡æ¡æ‰‹</strong>ï¼šèµ·åˆä¸¤ç«¯éƒ½å¤„äºCLOSEDå…³é—­çŠ¶æ€ï¼ŒClientå°†æ ‡å¿—ä½SYNç½®ä¸º1ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=xï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™Serverï¼ŒClientè¿›å…¥SYN-SENTçŠ¶æ€ï¼Œç­‰å¾…Serverç¡®è®¤ï¼›</p></li><li><p><strong>ç¬¬äºŒæ¬¡æ¡æ‰‹</strong>ï¼šServeræ”¶åˆ°æ•°æ®åŒ…åç”±æ ‡å¿—ä½SYN=1å¾—çŸ¥Clientè¯·æ±‚å»ºç«‹è¿æ¥ï¼ŒServerå°†æ ‡å¿—ä½SYNå’ŒACKéƒ½ç½®ä¸º1ï¼Œack=x+1ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=yï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™Clientä»¥ç¡®è®¤è¿æ¥è¯·æ±‚ï¼ŒServerè¿›å…¥SYN-RCVDçŠ¶æ€ï¼Œæ­¤æ—¶æ“ä½œç³»ç»Ÿä¸ºè¯¥TCPè¿æ¥åˆ†é…TCPç¼“å­˜å’Œå˜é‡ï¼›</p></li><li><p><strong>ç¬¬ä¸‰æ¬¡æ¡æ‰‹</strong>ï¼šClientæ”¶åˆ°ç¡®è®¤åï¼Œæ£€æŸ¥ackæ˜¯å¦ä¸ºx+1ï¼ŒACKæ˜¯å¦ä¸º1ï¼Œå¦‚æœæ­£ç¡®åˆ™å°†æ ‡å¿—ä½ACKç½®ä¸º1ï¼Œack=y+1ï¼Œå¹¶ä¸”æ­¤æ—¶æ“ä½œç³»ç»Ÿä¸ºè¯¥TCPè¿æ¥åˆ†é…TCPç¼“å­˜å’Œå˜é‡ï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™Serverï¼ŒServeræ£€æŸ¥ackæ˜¯å¦ä¸ºy+1ï¼ŒACKæ˜¯å¦ä¸º1ï¼Œå¦‚æœæ­£ç¡®åˆ™è¿æ¥å»ºç«‹æˆåŠŸï¼ŒClientå’ŒServerè¿›å…¥ESTABLISHEDçŠ¶æ€ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼ŒéšåClientå’ŒServerå°±å¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®ã€‚</p></li></ul><p>èµ·åˆAå’ŒBéƒ½å¤„äº<strong>CLOSEDçŠ¶æ€</strong>â€”â€”Båˆ›å»ºTCBï¼Œå¤„äº<strong>LISTENçŠ¶æ€</strong>ï¼Œç­‰å¾…Aè¯·æ±‚â€”â€”Aåˆ›å»ºTCBï¼Œå‘é€è¿æ¥è¯·æ±‚ï¼ˆSYN=1ï¼Œseq=xï¼‰ï¼Œè¿›å…¥<strong>SYN-SENTçŠ¶æ€</strong>â€”â€”Bæ”¶åˆ°è¿æ¥è¯·æ±‚ï¼Œå‘Aå‘é€ç¡®è®¤ï¼ˆSYN=ACK=1ï¼Œç¡®è®¤å·ack=x+1ï¼Œåˆå§‹åºå·seq=yï¼‰ï¼Œè¿›å…¥<strong>SYN-RCVDçŠ¶æ€</strong>â€”â€”Aæ”¶åˆ°Bçš„ç¡®è®¤åï¼Œç»™Bå‘å‡ºç¡®è®¤ï¼ˆACK=1ï¼Œack=y+1ï¼Œseq=x+1ï¼‰ï¼ŒAè¿›å…¥<strong>ESTABLISHEDçŠ¶æ€</strong>â€”â€”Bæ”¶åˆ°Açš„ç¡®è®¤åï¼Œè¿›å…¥ESTABLISHEDçŠ¶æ€ã€‚ <strong>TCB****ä¼ è¾“æ§åˆ¶å—</strong>Transmission Control Blockï¼Œå­˜å‚¨æ¯ä¸€ä¸ªè¿æ¥ä¸­çš„é‡è¦ä¿¡æ¯ï¼Œå¦‚TCPè¿æ¥è¡¨ï¼Œåˆ°å‘é€å’Œæ¥æ”¶ç¼“å­˜çš„æŒ‡é’ˆï¼Œåˆ°é‡ä¼ é˜Ÿåˆ—çš„æŒ‡é’ˆï¼Œå½“å‰çš„å‘é€å’Œæ¥æ”¶åºå·ã€‚ ï¼ˆ3ï¼‰ä¸ºä»€ä¹ˆAè¿˜è¦å‘é€ä¸€æ¬¡ç¡®è®¤å‘¢ï¼Ÿå¯ä»¥äºŒæ¬¡æ¡æ‰‹å—ï¼Ÿ ç­”ï¼š<strong>ä¸»è¦ä¸ºäº†é˜²æ­¢å·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µçªç„¶åˆä¼ é€åˆ°äº†Bï¼Œå› è€Œäº§ç”Ÿé”™è¯¯</strong>ã€‚å¦‚Aå‘å‡ºè¿æ¥è¯·æ±‚ï¼Œä½†å› è¿æ¥è¯·æ±‚æŠ¥æ–‡ä¸¢å¤±è€Œæœªæ”¶åˆ°ç¡®è®¤ï¼Œäºæ˜¯Aå†é‡ä¼ ä¸€æ¬¡è¿æ¥è¯·æ±‚ã€‚åæ¥æ”¶åˆ°äº†ç¡®è®¤ï¼Œå»ºç«‹äº†è¿æ¥ã€‚æ•°æ®ä¼ è¾“å®Œæ¯•åï¼Œå°±é‡Šæ”¾äº†è¿æ¥ï¼ŒAå·¥å‘å‡ºäº†ä¸¤ä¸ªè¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªä¸¢å¤±ï¼Œç¬¬äºŒä¸ªåˆ°è¾¾äº†Bï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªä¸¢å¤±çš„æŠ¥æ–‡æ®µåªæ˜¯åœ¨<strong>æŸäº›ç½‘ç»œç»“ç‚¹é•¿æ—¶é—´æ»ç•™äº†ï¼Œå»¶è¯¯åˆ°è¿æ¥é‡Šæ”¾ä»¥åçš„æŸä¸ªæ—¶é—´æ‰åˆ°è¾¾B</strong>ï¼Œæ­¤æ—¶Bè¯¯è®¤ä¸ºAåˆå‘å‡ºä¸€æ¬¡æ–°çš„è¿æ¥è¯·æ±‚ï¼Œäºæ˜¯å°±å‘Aå‘å‡ºç¡®è®¤æŠ¥æ–‡æ®µï¼ŒåŒæ„å»ºç«‹è¿æ¥ï¼Œä¸é‡‡ç”¨ä¸‰æ¬¡æ¡æ‰‹ï¼Œåªè¦Bå‘å‡ºç¡®è®¤ï¼Œå°±å»ºç«‹æ–°çš„è¿æ¥äº†ï¼Œæ­¤æ—¶Aä¸ç†ç¬Bçš„ç¡®è®¤ä¸”ä¸å‘é€æ•°æ®ï¼Œåˆ™Bä¸€è‡´ç­‰å¾…Aå‘é€æ•°æ®ï¼Œæµªè´¹èµ„æºã€‚ ï¼ˆ4ï¼‰Serverç«¯æ˜“å—åˆ°SYNæ”»å‡»ï¼Ÿ æœåŠ¡å™¨ç«¯çš„èµ„æºåˆ†é…æ˜¯åœ¨äºŒæ¬¡æ¡æ‰‹æ—¶åˆ†é…çš„ï¼Œè€Œå®¢æˆ·ç«¯çš„èµ„æºæ˜¯åœ¨å®Œæˆä¸‰æ¬¡æ¡æ‰‹æ—¶åˆ†é…çš„ï¼Œæ‰€ä»¥æœåŠ¡å™¨å®¹æ˜“å—åˆ°SYNæ´ªæ³›æ”»å‡»ï¼ŒSYNæ”»å‡»å°±æ˜¯Clientåœ¨çŸ­æ—¶é—´å†…ä¼ªé€ å¤§é‡ä¸å­˜åœ¨çš„IPåœ°å€ï¼Œå¹¶å‘Serverä¸æ–­åœ°å‘é€SYNåŒ…ï¼ŒServeråˆ™å›å¤ç¡®è®¤åŒ…ï¼Œå¹¶ç­‰å¾…Clientç¡®è®¤ï¼Œç”±äºæºåœ°å€ä¸å­˜åœ¨ï¼Œå› æ­¤Serveréœ€è¦ä¸æ–­é‡å‘ç›´è‡³è¶…æ—¶ï¼Œè¿™äº›ä¼ªé€ çš„SYNåŒ…å°†é•¿æ—¶é—´å ç”¨æœªè¿æ¥é˜Ÿåˆ—ï¼Œå¯¼è‡´æ­£å¸¸çš„SYNè¯·æ±‚å› ä¸ºé˜Ÿåˆ—æ»¡è€Œè¢«ä¸¢å¼ƒï¼Œä»è€Œå¼•èµ·ç½‘ç»œæ‹¥å¡ç”šè‡³ç³»ç»Ÿç˜«ç—ªã€‚ é˜²èŒƒSYNæ”»å‡»æªæ–½ï¼šé™ä½ä¸»æœºçš„ç­‰å¾…æ—¶é—´ä½¿ä¸»æœºå°½å¿«çš„é‡Šæ”¾åŠè¿æ¥çš„å ç”¨ï¼ŒçŸ­æ—¶é—´å—åˆ°æŸIPçš„é‡å¤SYNåˆ™ä¸¢å¼ƒåç»­è¯·æ±‚ã€‚ 2ã€å››æ¬¡æŒ¥æ‰‹ ï¼ˆ1ï¼‰å››æ¬¡æŒ¥æ‰‹çš„è¯¦è¿° å‡è®¾Clientç«¯å‘èµ·ä¸­æ–­è¿æ¥è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯å‘é€FINæŠ¥æ–‡ã€‚Serverç«¯æ¥åˆ°FINæŠ¥æ–‡åï¼Œæ„æ€æ˜¯è¯´&quot;æˆ‘Clientç«¯æ²¡æœ‰æ•°æ®è¦å‘ç»™ä½ äº†&quot;ï¼Œä½†æ˜¯å¦‚æœä½ è¿˜æœ‰æ•°æ®æ²¡æœ‰å‘é€å®Œæˆï¼Œåˆ™ä¸å¿…æ€¥ç€å…³é—­Socketï¼Œå¯ä»¥ç»§ç»­å‘é€æ•°æ®ã€‚æ‰€ä»¥ä½ å…ˆå‘é€ACKï¼Œâ€œå‘Šè¯‰Clientç«¯ï¼Œä½ çš„è¯·æ±‚æˆ‘æ”¶åˆ°äº†ï¼Œä½†æ˜¯æˆ‘è¿˜æ²¡å‡†å¤‡å¥½ï¼Œè¯·ç»§ç»­ä½ ç­‰æˆ‘çš„æ¶ˆæ¯â€ã€‚è¿™ä¸ªæ—¶å€™Clientç«¯å°±è¿›å…¥FIN_WAITçŠ¶æ€ï¼Œç»§ç»­ç­‰å¾…Serverç«¯çš„FINæŠ¥æ–‡ã€‚å½“Serverç«¯ç¡®å®šæ•°æ®å·²å‘é€å®Œæˆï¼Œåˆ™å‘Clientç«¯å‘é€FINæŠ¥æ–‡ï¼Œâ€œå‘Šè¯‰Clientç«¯ï¼Œå¥½äº†ï¼Œæˆ‘è¿™è¾¹æ•°æ®å‘å®Œäº†ï¼Œå‡†å¤‡å¥½å…³é—­è¿æ¥äº†â€ã€‚Clientç«¯æ”¶åˆ°FINæŠ¥æ–‡åï¼Œ&quot;å°±çŸ¥é“å¯ä»¥å…³é—­è¿æ¥äº†ï¼Œä½†æ˜¯ä»–è¿˜æ˜¯ä¸ç›¸ä¿¡ç½‘ç»œï¼Œæ€•Serverç«¯ä¸çŸ¥é“è¦å…³é—­ï¼Œæ‰€ä»¥å‘é€ACKåè¿›å…¥TIME_WAITçŠ¶æ€ï¼Œå¦‚æœServerç«¯æ²¡æœ‰æ”¶åˆ°ACKåˆ™å¯ä»¥é‡ä¼ ã€‚â€œï¼ŒServerç«¯æ”¶åˆ°ACKåï¼Œâ€œå°±çŸ¥é“å¯ä»¥æ–­å¼€è¿æ¥äº†â€ã€‚Clientç«¯ç­‰å¾…äº†2MSLåä¾ç„¶æ²¡æœ‰æ”¶åˆ°å›å¤ï¼Œåˆ™è¯æ˜Serverç«¯å·²æ­£å¸¸å…³é—­ï¼Œé‚£å¥½ï¼Œæˆ‘Clientç«¯ä¹Ÿå¯ä»¥å…³é—­è¿æ¥äº†ã€‚Okï¼ŒTCPè¿æ¥å°±è¿™æ ·å…³é—­äº†ï¼ <img src="https://blog.wenboo.top/wp-content/uploads/2019/04/0fde2c05428aada0e267265b1beab611.png" alt=""> æ•°æ®ä¼ è¾“ç»“æŸåï¼Œé€šä¿¡çš„åŒæ–¹éƒ½å¯é‡Šæ”¾è¿æ¥ï¼ŒAå’ŒBéƒ½å¤„äºESTABLISHEDçŠ¶æ€ã€‚ï¼ˆ<strong>Aã€Bè¿æ¥å»ºç«‹çŠ¶æ€ESTABLISHED</strong>â€”â€”<strong>Aç»ˆæ­¢ç­‰å¾…1çŠ¶æ€FIN-WAIT-1</strong>â€”â€”<strong>Bå…³é—­ç­‰å¾…çŠ¶æ€CLOSE-WAIT</strong>â€”â€”<strong>Aç»ˆæ­¢ç­‰å¾…2çŠ¶æ€FIN-WAIT-2</strong>â€”â€”<strong>Bæœ€åç¡®è®¤çŠ¶æ€LAST-ACK</strong>â€”â€”<strong>Aæ—¶é—´ç­‰å¾…çŠ¶æ€TIME-WAIT</strong>â€”â€”<strong>Bã€Aå…³é—­çŠ¶æ€CLOSED</strong>ï¼‰</p><ul><li><p>1ï¼‰Açš„åº”ç”¨è¿›ç¨‹å…ˆå‘å…¶TCPå‘å‡ºè¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µï¼ˆ<strong>FIN=1ï¼Œåºå·seq=u</strong>ï¼‰ï¼Œå¹¶åœæ­¢å†å‘é€æ•°æ®ï¼Œä¸»åŠ¨å…³é—­TCPè¿æ¥ï¼Œè¿›å…¥FIN-WAIT-1ï¼ˆç»ˆæ­¢ç­‰å¾…1ï¼‰çŠ¶æ€ï¼Œç­‰å¾…Bçš„ç¡®è®¤ã€‚</p></li><li><p>2ï¼‰Bæ”¶åˆ°è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µåå³å‘å‡ºç¡®è®¤æŠ¥æ–‡æ®µï¼Œï¼ˆ<strong>ACK=1ï¼Œç¡®è®¤å·ack=u+1ï¼Œåºå·seq=v</strong>ï¼‰ï¼ŒBè¿›å…¥CLOSE-WAITï¼ˆå…³é—­ç­‰å¾…ï¼‰çŠ¶æ€ï¼Œæ­¤æ—¶çš„TCPå¤„äºåŠå…³é—­çŠ¶æ€ï¼ŒAåˆ°Bçš„è¿æ¥é‡Šæ”¾ã€‚</p></li><li><p>3ï¼‰Aæ”¶åˆ°Bçš„ç¡®è®¤åï¼Œè¿›å…¥FIN-WAIT-2ï¼ˆç»ˆæ­¢ç­‰å¾…2ï¼‰çŠ¶æ€ï¼Œç­‰å¾…Bå‘å‡ºçš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µã€‚</p></li><li><p>4ï¼‰Bæ²¡æœ‰è¦å‘Aå‘å‡ºçš„æ•°æ®ï¼ŒBå‘å‡ºè¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µï¼ˆ**FIN=1ï¼ŒACK=1ï¼Œåºå·seq=wï¼Œç¡®è®¤å·ack=u+1ï¼‰ï¼Œ**Bè¿›å…¥LAST-ACKï¼ˆæœ€åç¡®è®¤ï¼‰çŠ¶æ€ï¼Œç­‰å¾…Açš„ç¡®è®¤ã€‚</p></li><li><p>5ï¼‰Aæ”¶åˆ°Bçš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µåï¼Œå¯¹æ­¤å‘å‡ºç¡®è®¤æŠ¥æ–‡æ®µï¼ˆ<strong>ACK=1ï¼Œseq=u+1ï¼Œack=w+1</strong>ï¼‰ï¼ŒAè¿›å…¥TIME-WAITï¼ˆæ—¶é—´ç­‰å¾…ï¼‰çŠ¶æ€ã€‚æ­¤æ—¶TCPæœªé‡Šæ”¾æ‰ï¼Œéœ€è¦ç»è¿‡æ—¶é—´ç­‰å¾…è®¡æ—¶å™¨è®¾ç½®çš„æ—¶é—´2MSLåï¼ŒAæ‰è¿›å…¥CLOSEDçŠ¶æ€ã€‚</p></li></ul><p>ï¼ˆ2ï¼‰æ€»ç»“å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹ï¼š èµ·åˆAå’ŒBå¤„äº<strong>ESTABLISHEDçŠ¶æ€</strong>â€”â€”Aå‘å‡ºè¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µå¹¶å¤„äº<strong>FIN-WAIT-1çŠ¶æ€</strong>â€”â€”Bå‘å‡ºç¡®è®¤æŠ¥æ–‡æ®µä¸”è¿›å…¥<strong>CLOSE-WAITçŠ¶æ€</strong>â€”â€”Aæ”¶åˆ°ç¡®è®¤åï¼Œè¿›å…¥<strong>FIN-WAIT-2çŠ¶æ€</strong>ï¼Œç­‰å¾…Bçš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µâ€”â€”Bæ²¡æœ‰è¦å‘Aå‘å‡ºçš„æ•°æ®ï¼ŒBå‘å‡ºè¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µä¸”è¿›å…¥<strong>LAST-ACKçŠ¶æ€</strong>â€”â€”Aå‘å‡ºç¡®è®¤æŠ¥æ–‡æ®µä¸”è¿›å…¥<strong>TIME-WAITçŠ¶æ€</strong>â€”â€”Bæ”¶åˆ°ç¡®è®¤æŠ¥æ–‡æ®µåè¿›å…¥<strong>CLOSEDçŠ¶æ€</strong>â€”â€”Aç»è¿‡ç­‰å¾…è®¡æ—¶å™¨æ—¶é—´2MSLåï¼Œè¿›å…¥<strong>CLOSEDçŠ¶æ€</strong>ã€‚ ï¼ˆ3ï¼‰ä¸ºä»€ä¹ˆAåœ¨TIME-WAITçŠ¶æ€å¿…é¡»ç­‰å¾…2MSLçš„æ—¶é—´ï¼Ÿ MSLæœ€é•¿æŠ¥æ–‡æ®µå¯¿å‘½Maximum Segment Lifetimeï¼ŒMSL=2 ç­”ï¼šã€€ã€€ä¸¤ä¸ªç†ç”±ï¼š<strong>1****ï¼‰ä¿è¯****A****å‘é€çš„æœ€åä¸€ä¸ª****ACK****æŠ¥æ–‡æ®µèƒ½å¤Ÿåˆ°è¾¾****B****ã€‚****2****ï¼‰é˜²æ­¢â€œå·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µâ€å‡ºç°åœ¨æœ¬è¿æ¥ä¸­ã€‚</strong></p><ul><li><p>1ï¼‰è¿™ä¸ªACKæŠ¥æ–‡æ®µæœ‰å¯èƒ½ä¸¢å¤±ï¼Œä½¿å¾—å¤„äºLAST-ACKçŠ¶æ€çš„Bæ”¶ä¸åˆ°å¯¹å·²å‘é€çš„FIN+ACKæŠ¥æ–‡æ®µçš„ç¡®è®¤ï¼ŒBè¶…æ—¶é‡ä¼ FIN+ACKæŠ¥æ–‡æ®µï¼Œè€ŒAèƒ½åœ¨2MSLæ—¶é—´å†…æ”¶åˆ°è¿™ä¸ªé‡ä¼ çš„FIN+ACKæŠ¥æ–‡æ®µï¼Œæ¥ç€Aé‡ä¼ ä¸€æ¬¡ç¡®è®¤ï¼Œé‡æ–°å¯åŠ¨2MSLè®¡æ—¶å™¨ï¼Œæœ€åAå’ŒBéƒ½è¿›å…¥åˆ°CLOSEDçŠ¶æ€ï¼Œ<strong>è‹¥Aåœ¨TIME-WAITçŠ¶æ€ä¸ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè€Œæ˜¯å‘é€å®ŒACKæŠ¥æ–‡æ®µåç«‹å³é‡Šæ”¾è¿æ¥ï¼Œåˆ™æ— æ³•æ”¶åˆ°Bé‡ä¼ çš„FIN+ACKæŠ¥æ–‡æ®µï¼Œæ‰€ä»¥ä¸ä¼šå†å‘é€ä¸€æ¬¡ç¡®è®¤æŠ¥æ–‡æ®µï¼Œåˆ™Bæ— æ³•æ­£å¸¸è¿›å…¥åˆ°CLOSEDçŠ¶æ€ã€‚</strong></p></li><li><p>2ï¼‰Aåœ¨å‘é€å®Œæœ€åä¸€ä¸ªACKæŠ¥æ–‡æ®µåï¼Œå†ç»è¿‡2MSLï¼Œå°±å¯ä»¥ä½¿æœ¬è¿æ¥æŒç»­çš„æ—¶é—´å†…æ‰€äº§ç”Ÿçš„æ‰€æœ‰æŠ¥æ–‡æ®µéƒ½ä»ç½‘ç»œä¸­æ¶ˆå¤±ï¼Œä½¿ä¸‹ä¸€ä¸ªæ–°çš„è¿æ¥ä¸­ä¸ä¼šå‡ºç°è¿™ç§æ—§çš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µã€‚</p></li></ul><p>ï¼ˆ4ï¼‰ä¸ºä»€ä¹ˆè¿æ¥çš„æ—¶å€™æ˜¯ä¸‰æ¬¡æ¡æ‰‹ï¼Œå…³é—­çš„æ—¶å€™å´æ˜¯å››æ¬¡æ¡æ‰‹ï¼Ÿ ç­”ï¼šå› ä¸ºå½“Serverç«¯æ”¶åˆ°Clientç«¯çš„SYNè¿æ¥è¯·æ±‚æŠ¥æ–‡åï¼Œå¯ä»¥ç›´æ¥å‘é€SYN+ACKæŠ¥æ–‡ã€‚å…¶ä¸­ACKæŠ¥æ–‡æ˜¯ç”¨æ¥åº”ç­”çš„ï¼ŒSYNæŠ¥æ–‡æ˜¯ç”¨æ¥åŒæ­¥çš„ã€‚ä½†æ˜¯å…³é—­è¿æ¥æ—¶ï¼Œå½“Serverç«¯æ”¶åˆ°FINæŠ¥æ–‡æ—¶ï¼Œå¾ˆå¯èƒ½å¹¶ä¸ä¼šç«‹å³å…³é—­SOCKETï¼Œæ‰€ä»¥åªèƒ½å…ˆå›å¤ä¸€ä¸ªACKæŠ¥æ–‡ï¼Œå‘Šè¯‰Clientç«¯ï¼Œâ€œä½ å‘çš„FINæŠ¥æ–‡æˆ‘æ”¶åˆ°äº†â€ã€‚åªæœ‰ç­‰åˆ°æˆ‘Serverç«¯æ‰€æœ‰çš„æŠ¥æ–‡éƒ½å‘é€å®Œäº†ï¼Œæˆ‘æ‰èƒ½å‘é€FINæŠ¥æ–‡ï¼Œå› æ­¤ä¸èƒ½ä¸€èµ·å‘é€ã€‚æ•…éœ€è¦å››æ­¥æ¡æ‰‹ã€‚ ï¼ˆ5ï¼‰ä¸ºä»€ä¹ˆTIME_WAITçŠ¶æ€éœ€è¦ç»è¿‡2MSL(æœ€å¤§æŠ¥æ–‡æ®µç”Ÿå­˜æ—¶é—´)æ‰èƒ½è¿”å›åˆ°CLOSEçŠ¶æ€ï¼Ÿ ç­”ï¼šè™½ç„¶æŒ‰é“ç†ï¼Œå››ä¸ªæŠ¥æ–‡éƒ½å‘é€å®Œæ¯•ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è¿›å…¥CLOSEçŠ¶æ€äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»å‡è±¡ç½‘ç»œæ˜¯ä¸å¯é çš„ï¼Œæœ‰å¯ä»¥æœ€åä¸€ä¸ªACKä¸¢å¤±ã€‚æ‰€ä»¥TIME_WAITçŠ¶æ€å°±æ˜¯ç”¨æ¥é‡å‘å¯èƒ½ä¸¢å¤±çš„ACKæŠ¥æ–‡ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>ç½‘ç»œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>tcp</tag>
      
      <tag>ä¸‰æ¬¡æ¡æ‰‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>php5 -php7</title>
    <link href="/2019/04/04/php5-php7/"/>
    <url>/2019/04/04/php5-php7/</url>
    
    <content type="html"><![CDATA[<h1>ä»PHP 5.5.x ç§»æ¤åˆ° PHP 5.6.x</h1><h2 id="æ–°ç‰¹æ€§"><a class="header-anchor" href="#æ–°ç‰¹æ€§"></a>æ–°ç‰¹æ€§</h2><h3 id="ä½¿ç”¨è¡¨è¾¾å¼å®šä¹‰å¸¸é‡"><a class="header-anchor" href="#ä½¿ç”¨è¡¨è¾¾å¼å®šä¹‰å¸¸é‡"></a>ä½¿ç”¨è¡¨è¾¾å¼å®šä¹‰å¸¸é‡</h3><ul><li>åœ¨ä¹‹å‰çš„ PHP ç‰ˆæœ¬ä¸­ï¼Œ å¿…é¡»ä½¿ç”¨é™æ€å€¼æ¥å®šä¹‰å¸¸é‡ï¼Œå£°æ˜å±æ€§ä»¥åŠæŒ‡å®šå‡½æ•°å‚æ•°é»˜è®¤å€¼ã€‚ ç°åœ¨ä½ å¯ä»¥ä½¿ç”¨åŒ…æ‹¬æ•°å€¼ã€å­—ç¬¦ä¸²å­—é¢é‡ä»¥åŠå…¶ä»–å¸¸é‡åœ¨å†…çš„æ•°å€¼è¡¨è¾¾å¼æ¥ å®šä¹‰å¸¸é‡ã€å£°æ˜å±æ€§ä»¥åŠè®¾ç½®å‡½æ•°å‚æ•°é»˜è®¤å€¼ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-keyword">const</span> ONE = <span class="hljs-number">1</span>;<span class="hljs-keyword">const</span> TWO = ONE * <span class="hljs-number">2</span>; <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span> </span>&#123;        <span class="hljs-keyword">const</span> THREE = TWO + <span class="hljs-number">1</span>;        <span class="hljs-keyword">const</span> ONE_THIRD = ONE / <span class="hljs-built_in">self</span>::THREE;        <span class="hljs-keyword">const</span> SENTENCE = <span class="hljs-string">&#x27;The value of THREE is &#x27;</span>.<span class="hljs-built_in">self</span>::THREE;&#125;</code></pre><ul><li>ç°åœ¨å¯ä»¥é€šè¿‡ const å…³é”®å­—æ¥å®šä¹‰ç±»å‹ä¸º array çš„å¸¸é‡ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>    <span class="hljs-keyword">const</span> ARR = [<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>]; <span class="hljs-keyword">echo</span> ARR[<span class="hljs-number">0</span>];</code></pre><h3 id="ä½¿ç”¨-è¿ç®—ç¬¦å®šä¹‰å˜é•¿å‚æ•°å‡½æ•°"><a class="header-anchor" href="#ä½¿ç”¨-è¿ç®—ç¬¦å®šä¹‰å˜é•¿å‚æ•°å‡½æ•°"></a>ä½¿ç”¨ <code>...</code> è¿ç®—ç¬¦å®šä¹‰å˜é•¿å‚æ•°å‡½æ•°</h3><ul><li>ç°åœ¨å¯ä»¥ä¸ä¾èµ– func_get_args()ï¼Œ ä½¿ç”¨ â€¦ è¿ç®—ç¬¦ æ¥å®ç° å˜é•¿å‚æ•°å‡½æ•°ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span>(<span class="hljs-params">$req, $opt = <span class="hljs-literal">null</span>, ...$params</span>)</span><span class="hljs-function"></span>&#123;    <span class="hljs-comment">// $params æ˜¯ä¸€ä¸ªåŒ…å«äº†å‰©ä½™å‚æ•°çš„æ•°ç»„    </span>    printf(<span class="hljs-string">&#x27;$req: %d; $opt: %d; number of params: %d&#x27;</span>.<span class="hljs-string">&quot;\n&quot;</span>,$req,$opt,count($params));&#125; f(<span class="hljs-number">1</span>);f(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);f(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);f(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>);&#125;</code></pre><p>ä»¥ä¸Šä¾‹ç¨‹ä¼šè¾“å‡ºï¼š</p><pre><code class="hljs php">$req: <span class="hljs-number">1</span>; $opt: <span class="hljs-number">0</span>; number of params: <span class="hljs-number">0</span>$req: <span class="hljs-number">1</span>; $opt: <span class="hljs-number">2</span>; number of params: <span class="hljs-number">0</span>$req: <span class="hljs-number">1</span>; $opt: <span class="hljs-number">2</span>; number of params: <span class="hljs-number">1</span>$req: <span class="hljs-number">1</span>; $opt: <span class="hljs-number">2</span>; number of params: <span class="hljs-number">2</span></code></pre><h3 id="ä½¿ç”¨-è¿ç®—ç¬¦è¿›è¡Œå‚æ•°å±•å¼€"><a class="header-anchor" href="#ä½¿ç”¨-è¿ç®—ç¬¦è¿›è¡Œå‚æ•°å±•å¼€"></a>ä½¿ç”¨ <code>...</code> è¿ç®—ç¬¦è¿›è¡Œå‚æ•°å±•å¼€</h3><ul><li>åœ¨è°ƒç”¨å‡½æ•°çš„æ—¶å€™ï¼Œä½¿ç”¨ â€¦ è¿ç®—ç¬¦ï¼Œ å°† æ•°ç»„ å’Œ å¯éå† å¯¹è±¡å±•å¼€ä¸ºå‡½æ•°å‚æ•°ã€‚ åœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ï¼Œæ¯”å¦‚ Rubyä¸­ï¼Œè¿™è¢«ç§°ä¸ºè¿æ¥è¿ç®—ç¬¦ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">$a, $b, $c</span>) </span><span class="hljs-function"></span>&#123;        <span class="hljs-keyword">return</span> $a + $b + $c;&#125; $operators = [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<span class="hljs-keyword">echo</span> add(<span class="hljs-number">1</span>, ...$operators);<span class="hljs-meta">?&gt;</span></code></pre><p>ä»¥ä¸Šä¾‹ç¨‹ä¼šè¾“å‡ºï¼š</p><pre><code class="hljs php"><span class="hljs-number">6</span></code></pre><h3 id="use-function-ä»¥åŠ-use-const"><a class="header-anchor" href="#use-function-ä»¥åŠ-use-const"></a>use function ä»¥åŠ use const</h3><ul><li>use è¿ç®—ç¬¦ è¢«è¿›è¡Œäº†æ‰©å±•ä»¥æ”¯æŒåœ¨ç±»ä¸­å¯¼å…¥å¤–éƒ¨çš„å‡½æ•°å’Œå¸¸é‡ã€‚ å¯¹åº”çš„ç»“æ„ä¸º use function å’Œ use constã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-keyword">namespace</span> <span class="hljs-title">Name</span>\<span class="hljs-title">Space</span> &#123;   <span class="hljs-title">const</span> <span class="hljs-title">FOO</span> = 42;    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span>(<span class="hljs-params"></span>) </span><span class="hljs-function"></span>&#123;     <span class="hljs-keyword">echo</span> <span class="hljs-keyword">__FUNCTION__</span>.<span class="hljs-string">&quot;\n&quot;</span>; &#125;&#125; <span class="hljs-keyword">namespace</span> &#123;    <span class="hljs-title">use</span> <span class="hljs-title">const</span> <span class="hljs-title">Name</span>\<span class="hljs-title">Space</span>\<span class="hljs-title">FOO</span>;    <span class="hljs-keyword">use</span> <span class="hljs-title">function</span> <span class="hljs-title">Name</span>\<span class="hljs-title">Space</span>\<span class="hljs-title">f</span>;     <span class="hljs-keyword">echo</span> FOO.<span class="hljs-string">&quot;\n&quot;</span>;    f();&#125;</code></pre><p>ä»¥ä¸Šä¾‹ç¨‹ä¼šè¾“å‡ºï¼š</p><pre><code class="hljs php"><span class="hljs-keyword">use</span> <span class="hljs-title">Name</span>\<span class="hljs-title">Space</span>\<span class="hljs-title">f</span></code></pre><h3 id="ä½¿ç”¨-hash-equals-æ¯”è¾ƒå­—ç¬¦ä¸²é¿å…æ—¶åºæ”»å‡»"><a class="header-anchor" href="#ä½¿ç”¨-hash-equals-æ¯”è¾ƒå­—ç¬¦ä¸²é¿å…æ—¶åºæ”»å‡»"></a>ä½¿ç”¨ hash_equals() æ¯”è¾ƒå­—ç¬¦ä¸²é¿å…æ—¶åºæ”»å‡»</h3><h1>ä»PHP 5.6.x ç§»æ¤åˆ° PHP 7.0.x</h1><h2 id="æ–°ç‰¹æ€§-2"><a class="header-anchor" href="#æ–°ç‰¹æ€§-2"></a>æ–°ç‰¹æ€§</h2><h3 id="æ ‡é‡ç±»å‹å£°æ˜"><a class="header-anchor" href="#æ ‡é‡ç±»å‹å£°æ˜"></a>æ ‡é‡ç±»å‹å£°æ˜</h3><ul><li>æ ‡é‡ç±»å‹å£°æ˜ æœ‰ä¸¤ç§æ¨¡å¼: å¼ºåˆ¶ (é»˜è®¤) å’Œ ä¸¥æ ¼æ¨¡å¼ã€‚ ç°åœ¨å¯ä»¥ä½¿ç”¨ä¸‹åˆ—ç±»å‹å‚æ•°ï¼ˆæ— è®ºç”¨å¼ºåˆ¶æ¨¡å¼è¿˜æ˜¯ä¸¥æ ¼æ¨¡å¼ï¼‰ï¼š å­—ç¬¦ä¸²(string), æ•´æ•° (int), æµ®ç‚¹æ•° (float), ä»¥åŠå¸ƒå°”å€¼ (bool)ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-comment">// Coercive modefunction </span>sumOfInts(<span class="hljs-keyword">int</span> ...$ints)&#123;        <span class="hljs-keyword">return</span> array_sum($ints);&#125; var_dump(sumOfInts(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">4.1</span>));</code></pre><p>ä»¥ä¸Šä¾‹ç¨‹ä¼šè¾“å‡ºï¼š</p><pre><code class="hljs php"><span class="hljs-keyword">int</span>(<span class="hljs-number">9</span>)</code></pre><h3 id="è¿”å›å€¼ç±»å‹å£°æ˜"><a class="header-anchor" href="#è¿”å›å€¼ç±»å‹å£°æ˜"></a>è¿”å›å€¼ç±»å‹å£°æ˜</h3><ul><li>PHP 7 å¢åŠ äº†å¯¹è¿”å›ç±»å‹å£°æ˜çš„æ”¯æŒã€‚ ç±»ä¼¼äºå‚æ•°ç±»å‹å£°æ˜ï¼Œè¿”å›ç±»å‹å£°æ˜æŒ‡æ˜äº†å‡½æ•°è¿”å›å€¼çš„ç±»å‹ã€‚å¯ç”¨çš„ç±»å‹ä¸å‚æ•°å£°æ˜ä¸­å¯ç”¨çš„ç±»å‹ç›¸åŒã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">arraysSum</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> ...$arrays</span>): <span class="hljs-title">array</span></span><span class="hljs-function"></span>&#123;        <span class="hljs-keyword">return</span> array_map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> $array</span>): <span class="hljs-title">int</span> </span><span class="hljs-function">    </span>&#123;                <span class="hljs-keyword">return</span> array_sum($array);        &#125;, $arrays);&#125;</code></pre><h3 id="nullåˆå¹¶è¿ç®—ç¬¦"><a class="header-anchor" href="#nullåˆå¹¶è¿ç®—ç¬¦"></a>nullåˆå¹¶è¿ç®—ç¬¦</h3><ul><li>ç”±äºæ—¥å¸¸ä½¿ç”¨ä¸­å­˜åœ¨å¤§é‡åŒæ—¶ä½¿ç”¨ä¸‰å…ƒè¡¨è¾¾å¼å’Œ isset()çš„æƒ…å†µï¼Œ æˆ‘ä»¬æ·»åŠ äº†nullåˆå¹¶è¿ç®—ç¬¦ (<code>??</code>) è¿™ä¸ªè¯­æ³•ç³–ã€‚å¦‚æœå˜é‡å­˜åœ¨ä¸”å€¼ä¸ä¸ºNULLï¼Œ å®ƒå°±ä¼šè¿”å›è‡ªèº«çš„å€¼ï¼Œå¦åˆ™è¿”å›å®ƒçš„ç¬¬äºŒä¸ªæ“ä½œæ•°ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-comment">// Fetches the value of $_GET[&#x27;user&#x27;] and returns &#x27;nobody&#x27; if it does not exist.</span>$username = $_GET[<span class="hljs-string">&#x27;user&#x27;</span>] ?? <span class="hljs-string">&#x27;nobody&#x27;</span>;<span class="hljs-comment">// This is equivalent to:</span>$username = <span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">&#x27;user&#x27;</span>]) ? $_GET[<span class="hljs-string">&#x27;user&#x27;</span>] : <span class="hljs-string">&#x27;nobody&#x27;</span>; <span class="hljs-comment">// Coalesces can be chained: this will return the first defined value out of $_GET[&#x27;user&#x27;], $_POST[&#x27;user&#x27;], and &#x27;nobody&#x27;.</span>$username = $_GET[<span class="hljs-string">&#x27;user&#x27;</span>] ?? $_POST[<span class="hljs-string">&#x27;user&#x27;</span>] ?? <span class="hljs-string">&#x27;nobody&#x27;</span>;<span class="hljs-meta">?&gt;</span></code></pre><h3 id="å¤ªç©ºèˆ¹æ“ä½œç¬¦ï¼ˆç»„åˆæ¯”è¾ƒç¬¦ï¼‰"><a class="header-anchor" href="#å¤ªç©ºèˆ¹æ“ä½œç¬¦ï¼ˆç»„åˆæ¯”è¾ƒç¬¦ï¼‰"></a>å¤ªç©ºèˆ¹æ“ä½œç¬¦ï¼ˆç»„åˆæ¯”è¾ƒç¬¦ï¼‰</h3><ul><li>å¤ªç©ºèˆ¹æ“ä½œç¬¦ç”¨äºæ¯”è¾ƒä¸¤ä¸ªè¡¨è¾¾å¼ã€‚å½“$aå°äºã€ç­‰äºæˆ–å¤§äº$bæ—¶å®ƒåˆ†åˆ«è¿”å›-1ã€0æˆ–1ã€‚ æ¯”è¾ƒçš„åŸåˆ™æ˜¯æ²¿ç”¨ PHP çš„å¸¸è§„æ¯”è¾ƒè§„åˆ™è¿›è¡Œçš„ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-comment">// æ•´æ•°</span><span class="hljs-keyword">echo</span> <span class="hljs-number">1</span> &lt;=&gt; <span class="hljs-string">&#x27;1&#x27;</span>; <span class="hljs-comment">// 0</span><span class="hljs-keyword">echo</span> <span class="hljs-number">1</span> &lt;=&gt; <span class="hljs-number">2</span>; <span class="hljs-comment">// -1</span><span class="hljs-keyword">echo</span> <span class="hljs-number">2</span> &lt;=&gt; <span class="hljs-number">1</span>; <span class="hljs-comment">// 1 </span><span class="hljs-comment">// æµ®ç‚¹æ•°</span><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;1.50&#x27;</span> &lt;=&gt; <span class="hljs-number">1.5</span>; <span class="hljs-comment">// 0</span><span class="hljs-keyword">echo</span> <span class="hljs-number">1.5</span> &lt;=&gt; <span class="hljs-number">2.5</span>; <span class="hljs-comment">// -1</span><span class="hljs-keyword">echo</span> <span class="hljs-number">2.5</span> &lt;=&gt; <span class="hljs-number">1.5</span>; <span class="hljs-comment">// 1 </span><span class="hljs-comment">// å­—ç¬¦ä¸²</span><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;a&quot;</span> &lt;=&gt; <span class="hljs-string">&quot;a&quot;</span>; <span class="hljs-comment">// 0</span><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;a&quot;</span> &lt;=&gt; <span class="hljs-string">&quot;b&quot;</span>; <span class="hljs-comment">// -1</span><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;b&quot;</span> &lt;=&gt; <span class="hljs-string">&quot;a&quot;</span>; <span class="hljs-comment">// 1</span></code></pre><h3 id="é€šè¿‡-define-å®šä¹‰å¸¸é‡æ•°ç»„"><a class="header-anchor" href="#é€šè¿‡-define-å®šä¹‰å¸¸é‡æ•°ç»„"></a>é€šè¿‡ define() å®šä¹‰å¸¸é‡æ•°ç»„</h3><ul><li>Array ç±»å‹çš„å¸¸é‡ç°åœ¨å¯ä»¥é€šè¿‡ define() æ¥å®šä¹‰ã€‚åœ¨ PHP5.6 ä¸­ä»…èƒ½é€šè¿‡ const å®šä¹‰ã€‚</li></ul><pre><code class="hljs php">define(<span class="hljs-string">&#x27;ANIMALS&#x27;</span>, [    <span class="hljs-string">&#x27;dog&#x27;</span>,    <span class="hljs-string">&#x27;cat&#x27;</span>,    <span class="hljs-string">&#x27;bird&#x27;</span>]); <span class="hljs-keyword">echo</span> ANIMALS[<span class="hljs-number">1</span>]; <span class="hljs-comment">// è¾“å‡º &quot;cat&quot;</span></code></pre><h3 id="Closure-call"><a class="header-anchor" href="#Closure-call"></a>Closure::call()</h3><ul><li>Closure::call() ç°åœ¨æœ‰ç€æ›´å¥½çš„æ€§èƒ½ï¼Œç®€çŸ­å¹²ç»ƒçš„æš‚æ—¶ç»‘å®šä¸€ä¸ªæ–¹æ³•åˆ°å¯¹è±¡ä¸Šé—­åŒ…å¹¶è°ƒç”¨å®ƒã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>&#123;<span class="hljs-keyword">private</span> $x = <span class="hljs-number">1</span>;&#125; <span class="hljs-comment">// PHP 7 ä¹‹å‰ç‰ˆæœ¬çš„ä»£ç </span>$getXCB = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;x;&#125;;$getX = $getXCB-&gt;bindTo(<span class="hljs-keyword">new</span> A, <span class="hljs-string">&#x27;A&#x27;</span>); <span class="hljs-comment">// ä¸­é—´å±‚é—­åŒ…</span><span class="hljs-keyword">echo</span> $getX();<span class="hljs-comment">// PHP 7+ åŠæ›´é«˜ç‰ˆæœ¬çš„ä»£ç </span>$getX = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;x;&#125;;<span class="hljs-keyword">echo</span> $getX-&gt;call(<span class="hljs-keyword">new</span> A);</code></pre><p>ä»¥ä¸Šä¾‹ç¨‹ä¼šè¾“å‡ºï¼š</p><pre><code class="hljs php"><span class="hljs-number">1</span></code></pre><h3 id="åˆ†ç»„-use-å£°æ˜"><a class="header-anchor" href="#åˆ†ç»„-use-å£°æ˜"></a>åˆ†ç»„ <code>use</code> å£°æ˜</h3><ul><li>ä»åŒä¸€ namespace å¯¼å…¥çš„ç±»ã€å‡½æ•°å’Œå¸¸é‡ç°åœ¨å¯ä»¥é€šè¿‡å•ä¸ª use è¯­å¥ ä¸€æ¬¡æ€§å¯¼å…¥äº†ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>     <span class="hljs-comment">// PHP 7 ä¹‹å‰çš„ä»£ç </span><span class="hljs-keyword">use</span> <span class="hljs-title">some</span>\<span class="hljs-title">namespace</span>\<span class="hljs-title">ClassA</span>;<span class="hljs-keyword">use</span> <span class="hljs-title">some</span>\<span class="hljs-title">namespace</span>\<span class="hljs-title">ClassB</span>;<span class="hljs-keyword">use</span> <span class="hljs-title">some</span>\<span class="hljs-title">namespace</span>\<span class="hljs-title">ClassC</span> <span class="hljs-title">as</span> <span class="hljs-title">C</span>; <span class="hljs-keyword">use</span> <span class="hljs-title">function</span> <span class="hljs-title">some</span>\<span class="hljs-title">namespace</span>\<span class="hljs-title">fn_a</span>;<span class="hljs-keyword">use</span> <span class="hljs-title">function</span> <span class="hljs-title">some</span>\<span class="hljs-title">namespace</span>\<span class="hljs-title">fn_b</span>;<span class="hljs-keyword">use</span> <span class="hljs-title">function</span> <span class="hljs-title">some</span>\<span class="hljs-title">namespace</span>\<span class="hljs-title">fn_c</span>; <span class="hljs-keyword">use</span> <span class="hljs-title">const</span> <span class="hljs-title">some</span>\<span class="hljs-title">namespace</span>\<span class="hljs-title">ConstA</span>;<span class="hljs-keyword">use</span> <span class="hljs-title">const</span> <span class="hljs-title">some</span>\<span class="hljs-title">namespace</span>\<span class="hljs-title">ConstB</span>;<span class="hljs-keyword">use</span> <span class="hljs-title">const</span> <span class="hljs-title">some</span>\<span class="hljs-title">namespace</span>\<span class="hljs-title">ConstC</span>; <span class="hljs-comment">// PHP 7+ åŠæ›´é«˜ç‰ˆæœ¬çš„ä»£ç </span><span class="hljs-keyword">use</span> <span class="hljs-title">some</span>\<span class="hljs-title">namespace</span>\&#123;    <span class="hljs-title">ClassA</span>, <span class="hljs-title">ClassB</span>, <span class="hljs-title">ClassC</span> <span class="hljs-title">as</span> <span class="hljs-title">C</span>&#125;;<span class="hljs-keyword">use</span> <span class="hljs-title">function</span> <span class="hljs-title">some</span>\<span class="hljs-title">namespace</span>\&#123;    <span class="hljs-title">fn_a</span>,     <span class="hljs-title">fn_b</span>,     <span class="hljs-title">fn_c</span>&#125;;<span class="hljs-keyword">use</span> <span class="hljs-title">const</span> <span class="hljs-title">some</span>\<span class="hljs-title">namespace</span>\&#123;<span class="hljs-title">ConstA</span>, <span class="hljs-title">ConstB</span>, <span class="hljs-title">ConstC</span>&#125;;</code></pre><h3 id="ç”Ÿæˆå™¨å¯ä»¥è¿”å›è¡¨è¾¾å¼"><a class="header-anchor" href="#ç”Ÿæˆå™¨å¯ä»¥è¿”å›è¡¨è¾¾å¼"></a>ç”Ÿæˆå™¨å¯ä»¥è¿”å›è¡¨è¾¾å¼</h3><ul><li>æ­¤ç‰¹æ€§åŸºäº PHP 5.5 ç‰ˆæœ¬ä¸­å¼•å…¥çš„ç”Ÿæˆå™¨ç‰¹æ€§æ„å»ºçš„ã€‚ å®ƒå…è®¸åœ¨ç”Ÿæˆå™¨å‡½æ•°ä¸­é€šè¿‡ä½¿ç”¨ return è¯­æ³•æ¥è¿”å›ä¸€ä¸ªè¡¨è¾¾å¼ ï¼ˆä½†æ˜¯ä¸å…è®¸è¿”å›å¼•ç”¨å€¼ï¼‰ï¼Œ å¯ä»¥é€šè¿‡è°ƒç”¨ Generator::getReturn() æ–¹æ³•æ¥è·å–ç”Ÿæˆå™¨çš„è¿”å›å€¼ï¼Œ ä½†æ˜¯è¿™ä¸ªæ–¹æ³•åªèƒ½åœ¨ç”Ÿæˆå™¨å®Œæˆäº§ç”Ÿå·¥ä½œä»¥åè°ƒç”¨ä¸€æ¬¡ã€‚</li></ul><h3 id="æ•´æ•°é™¤æ³•å‡½æ•°-intdiv"><a class="header-anchor" href="#æ•´æ•°é™¤æ³•å‡½æ•°-intdiv"></a>æ•´æ•°é™¤æ³•å‡½æ•° intdiv()</h3><hr><h1>ä»PHP 7.0.x ç§»æ¤åˆ° PHP 7.1.x</h1><h2 id="æ–°ç‰¹æ€§-3"><a class="header-anchor" href="#æ–°ç‰¹æ€§-3"></a>æ–°ç‰¹æ€§</h2><h3 id="å¯ä¸ºç©ºï¼ˆNullableï¼‰ç±»å‹"><a class="header-anchor" href="#å¯ä¸ºç©ºï¼ˆNullableï¼‰ç±»å‹"></a>å¯ä¸ºç©ºï¼ˆNullableï¼‰ç±»å‹</h3><ul><li>å‚æ•°ä»¥åŠè¿”å›å€¼çš„ç±»å‹ç°åœ¨å¯ä»¥é€šè¿‡åœ¨ç±»å‹å‰åŠ ä¸Šä¸€ä¸ªé—®å·ä½¿ä¹‹å…è®¸ä¸ºç©ºã€‚ å½“å¯ç”¨è¿™ä¸ªç‰¹æ€§æ—¶ï¼Œä¼ å…¥çš„å‚æ•°æˆ–è€…å‡½æ•°è¿”å›çš„ç»“æœè¦ä¹ˆæ˜¯ç»™å®šçš„ç±»å‹ï¼Œè¦ä¹ˆæ˜¯ null ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testReturn</span>(<span class="hljs-params"></span>): ?<span class="hljs-title">string</span></span><span class="hljs-function"></span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;elePHPant&#x27;</span>;&#125; var_dump(testReturn()); <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testReturn</span>(<span class="hljs-params"></span>): ?<span class="hljs-title">string</span></span><span class="hljs-function"></span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;&#125; var_dump(testReturn()); <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params">?<span class="hljs-keyword">string</span> $name</span>)</span><span class="hljs-function"></span>&#123;        var_dump($name);&#125; test(<span class="hljs-string">&#x27;elePHPant&#x27;</span>);test(<span class="hljs-literal">null</span>);test();</code></pre><p>ä»¥ä¸Šä¾‹ç¨‹ä¼šè¾“å‡ºï¼š</p><pre><code class="hljs php"><span class="hljs-keyword">string</span>(<span class="hljs-number">10</span>) <span class="hljs-string">&quot;elePHPant&quot;</span><span class="hljs-literal">NULL</span><span class="hljs-keyword">string</span>(<span class="hljs-number">10</span>) <span class="hljs-string">&quot;elePHPant&quot;</span><span class="hljs-literal">NULL</span>Uncaught <span class="hljs-built_in">Error</span>: Too few arguments to <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>), 0 <span class="hljs-title">passed</span> <span class="hljs-title">in</span>...</span></code></pre><h3 id="Void-å‡½æ•°"><a class="header-anchor" href="#Void-å‡½æ•°"></a>Void å‡½æ•°</h3><ul><li>ä¸€ä¸ªæ–°çš„è¿”å›å€¼ç±»å‹voidè¢«å¼•å…¥ã€‚ è¿”å›å€¼å£°æ˜ä¸º void ç±»å‹çš„æ–¹æ³•è¦ä¹ˆå¹²è„†çœå» return è¯­å¥ï¼Œè¦ä¹ˆä½¿ç”¨ä¸€ä¸ªç©ºçš„ return è¯­å¥ã€‚ å¯¹äº void å‡½æ•°æ¥è¯´ï¼ŒNULL ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„è¿”å›å€¼ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">swap</span>(<span class="hljs-params">&amp;$left, &amp;$right</span>) : <span class="hljs-title">void</span></span><span class="hljs-function"></span>&#123;        <span class="hljs-keyword">if</span> ($left === $right) &#123;    <span class="hljs-keyword">return</span>;    &#125;      $tmp = $left;     $left = $right;     $right = $tmp;&#125; $a = <span class="hljs-number">1</span>;$b = <span class="hljs-number">2</span>;var_dump(swap($a, $b), $a, $b);</code></pre><p>ä»¥ä¸Šä¾‹ç¨‹ä¼šè¾“å‡ºï¼š</p><pre><code class="hljs php"><span class="hljs-literal">null</span><span class="hljs-keyword">int</span>(<span class="hljs-number">2</span>)<span class="hljs-keyword">int</span>(<span class="hljs-number">1</span>)</code></pre><h3 id="Symmetric-array-destructuring"><a class="header-anchor" href="#Symmetric-array-destructuring"></a>Symmetric array destructuring</h3><ul><li>çŸ­æ•°ç»„è¯­æ³•ï¼ˆ[]ï¼‰ç°åœ¨ä½œä¸ºlist()è¯­æ³•çš„ä¸€ä¸ªå¤‡é€‰é¡¹ï¼Œå¯ä»¥ç”¨äºå°†æ•°ç»„çš„å€¼èµ‹ç»™ä¸€äº›å˜é‡ï¼ˆåŒ…æ‹¬åœ¨foreachä¸­ï¼‰ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>$data = [    [<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;Tom&#x27;</span>],    [<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;Fred&#x27;</span>],]; <span class="hljs-comment">// list() style</span><span class="hljs-keyword">list</span>($id1, $name1) = $data[<span class="hljs-number">0</span>]; <span class="hljs-comment">// [] style</span>[$id1, $name1] = $data[<span class="hljs-number">0</span>]; <span class="hljs-comment">// list() style</span><span class="hljs-keyword">foreach</span> ($data <span class="hljs-keyword">as</span> <span class="hljs-keyword">list</span>($id, $name)) &#123;        <span class="hljs-comment">// logic here with $id and $name</span>&#125;     <span class="hljs-comment">// [] style</span><span class="hljs-keyword">foreach</span> ($data <span class="hljs-keyword">as</span> [$id, $name]) &#123;        <span class="hljs-comment">// logic here with $id and $name</span>&#125;</code></pre><h3 id="ç±»å¸¸é‡å¯è§æ€§"><a class="header-anchor" href="#ç±»å¸¸é‡å¯è§æ€§"></a>ç±»å¸¸é‡å¯è§æ€§</h3><ul><li>ç°åœ¨èµ·æ”¯æŒè®¾ç½®ç±»å¸¸é‡çš„å¯è§æ€§ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConstDemo</span></span>&#123;        <span class="hljs-keyword">const</span> PUBLIC_CONST_A = <span class="hljs-number">1</span>;        <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> PUBLIC_CONST_B = <span class="hljs-number">2</span>;        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">const</span> PROTECTED_CONST = <span class="hljs-number">3</span>;        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> PRIVATE_CONST = <span class="hljs-number">4</span>;&#125;</code></pre><h3 id="iterable-ä¼ªç±»"><a class="header-anchor" href="#iterable-ä¼ªç±»"></a>iterable ä¼ªç±»</h3><ul><li>ç°åœ¨å¼•å…¥äº†ä¸€ä¸ªæ–°çš„è¢«ç§°ä¸ºiterableçš„ä¼ªç±» (ä¸callableç±»ä¼¼)ã€‚ è¿™å¯ä»¥è¢«ç”¨åœ¨å‚æ•°æˆ–è€…è¿”å›å€¼ç±»å‹ä¸­ï¼Œå®ƒä»£è¡¨æ¥å—æ•°ç»„æˆ–è€…å®ç°äº†Traversableæ¥å£çš„å¯¹è±¡ã€‚ è‡³äºå­ç±»ï¼Œå½“ç”¨ä½œå‚æ•°æ—¶ï¼Œå­ç±»å¯ä»¥æ”¶ç´§çˆ¶ç±»çš„iterableç±»å‹åˆ°array æˆ–ä¸€ä¸ªå®ç°äº†Traversableçš„å¯¹è±¡ã€‚å¯¹äºè¿”å›å€¼ï¼Œå­ç±»å¯ä»¥æ‹“å®½çˆ¶ç±»çš„ arrayæˆ–å¯¹è±¡è¿”å›å€¼ç±»å‹åˆ°iterableã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">iterator</span>(<span class="hljs-params"><span class="hljs-keyword">iterable</span> $iter</span>) : <span class="hljs-title">iterable</span></span><span class="hljs-function"></span>&#123;        <span class="hljs-keyword">foreach</span> ($iter <span class="hljs-keyword">as</span> $val) &#123;        <span class="hljs-comment">//    </span>    &#125;&#125;</code></pre><h3 id="å¤šå¼‚å¸¸æ•è·å¤„ç†"><a class="header-anchor" href="#å¤šå¼‚å¸¸æ•è·å¤„ç†"></a>å¤šå¼‚å¸¸æ•è·å¤„ç†</h3><ul><li>ä¸€ä¸ªcatchè¯­å¥å—ç°åœ¨å¯ä»¥é€šè¿‡ç®¡é“å­—ç¬¦(|)æ¥å®ç°å¤šä¸ªå¼‚å¸¸çš„æ•è·ã€‚ è¿™å¯¹äºéœ€è¦åŒæ—¶å¤„ç†æ¥è‡ªä¸åŒç±»çš„ä¸åŒå¼‚å¸¸æ—¶å¾ˆæœ‰ç”¨ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>    <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// some code</span>    &#125; <span class="hljs-keyword">catch</span> (FirstException | SecondException $e) &#123;            <span class="hljs-comment">// handle first and second exceptions</span>    &#125;</code></pre><h3 id="list-ç°åœ¨æ”¯æŒé”®å"><a class="header-anchor" href="#list-ç°åœ¨æ”¯æŒé”®å"></a><code>list()</code>ç°åœ¨æ”¯æŒé”®å</h3><ul><li>ç°åœ¨list()å’Œå®ƒçš„æ–°çš„[]è¯­æ³•æ”¯æŒåœ¨å®ƒå†…éƒ¨å»æŒ‡å®šé”®åã€‚è¿™æ„å‘³ç€å®ƒå¯ä»¥å°†ä»»æ„ç±»å‹çš„æ•°ç»„ éƒ½èµ‹å€¼ç»™ä¸€äº›å˜é‡ï¼ˆä¸çŸ­æ•°ç»„è¯­æ³•ç±»ä¼¼ï¼‰</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>$data = [    [<span class="hljs-string">&quot;id&quot;</span> =&gt; <span class="hljs-number">1</span>, <span class="hljs-string">&quot;name&quot;</span> =&gt; <span class="hljs-string">&#x27;Tom&#x27;</span>],    [<span class="hljs-string">&quot;id&quot;</span> =&gt; <span class="hljs-number">2</span>, <span class="hljs-string">&quot;name&quot;</span> =&gt; <span class="hljs-string">&#x27;Fred&#x27;</span>],]; <span class="hljs-comment">// list() style</span><span class="hljs-keyword">list</span>(<span class="hljs-string">&quot;id&quot;</span> =&gt; $id1, <span class="hljs-string">&quot;name&quot;</span> =&gt; $name1) = $data[<span class="hljs-number">0</span>]; <span class="hljs-comment">// [] style</span>[<span class="hljs-string">&quot;id&quot;</span> =&gt; $id1, <span class="hljs-string">&quot;name&quot;</span> =&gt; $name1] = $data[<span class="hljs-number">0</span>]; <span class="hljs-comment">// list() style</span><span class="hljs-keyword">foreach</span> ($data <span class="hljs-keyword">as</span> <span class="hljs-keyword">list</span>(<span class="hljs-string">&quot;id&quot;</span> =&gt; $id, <span class="hljs-string">&quot;name&quot;</span> =&gt; $name)) &#123;        <span class="hljs-comment">// logic here with $id and $name</span>&#125; <span class="hljs-comment">// [] style</span><span class="hljs-keyword">foreach</span> ($data <span class="hljs-keyword">as</span> [<span class="hljs-string">&quot;id&quot;</span> =&gt; $id, <span class="hljs-string">&quot;name&quot;</span> =&gt; $name]) &#123;        <span class="hljs-comment">// logic here with $id and $name</span>&#125;</code></pre><hr><h1>ä»PHP 7.1.x ç§»æ¤åˆ° PHP 7.2.x</h1><h2 id="æ–°ç‰¹æ€§-4"><a class="header-anchor" href="#æ–°ç‰¹æ€§-4"></a>æ–°ç‰¹æ€§</h2><h3 id="æ–°çš„å¯¹è±¡ç±»å‹"><a class="header-anchor" href="#æ–°çš„å¯¹è±¡ç±»å‹"></a>æ–°çš„å¯¹è±¡ç±»å‹</h3><ul><li>è¿™ç§æ–°çš„å¯¹è±¡ç±»å‹, object, å¼•è¿›äº†å¯ç”¨äºé€†å˜ï¼ˆcontravariantï¼‰å‚æ•°è¾“å…¥å’Œåå˜ï¼ˆcovariantï¼‰è¿”å›ä»»ä½•å¯¹è±¡ç±»å‹ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> $obj</span>) : <span class="hljs-title">object</span></span><span class="hljs-function"></span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SplQueue</span>();&#125; test(<span class="hljs-keyword">new</span> <span class="hljs-built_in">StdClass</span>());</code></pre><h3 id="å…è®¸é‡å†™æŠ½è±¡æ–¹æ³•-Abstract-method"><a class="header-anchor" href="#å…è®¸é‡å†™æŠ½è±¡æ–¹æ³•-Abstract-method"></a>å…è®¸é‡å†™æŠ½è±¡æ–¹æ³•(Abstract method)</h3><ul><li>å½“ä¸€ä¸ªæŠ½è±¡ç±»ç»§æ‰¿äºå¦å¤–ä¸€ä¸ªæŠ½è±¡ç±»çš„æ—¶å€™ï¼Œç»§æ‰¿åçš„æŠ½è±¡ç±»å¯ä»¥é‡å†™è¢«ç»§æ‰¿çš„æŠ½è±¡ç±»çš„æŠ½è±¡æ–¹æ³•ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span><span class="hljs-class"></span>&#123;        <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $s</span>)</span>;&#125;<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">A</span></span><span class="hljs-class"></span>&#123;    <span class="hljs-comment">// overridden - still maintaining contravariance for parameters and covariance for return    </span>    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params">$s</span>) : <span class="hljs-title">int</span></span>;&#125;</code></pre><h3 id="æ‰©å±•äº†å‚æ•°ç±»å‹"><a class="header-anchor" href="#æ‰©å±•äº†å‚æ•°ç±»å‹"></a>æ‰©å±•äº†å‚æ•°ç±»å‹</h3><ul><li>é‡å†™æ–¹æ³•å’Œæ¥å£å®ç°çš„å‚æ•°ç±»å‹ç°åœ¨å¯ä»¥çœç•¥äº†ã€‚ä¸è¿‡è¿™ä»ç„¶æ˜¯ç¬¦åˆLSPï¼Œå› ä¸ºç°åœ¨è¿™ç§å‚æ•°ç±»å‹æ˜¯é€†å˜çš„ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">A</span></span><span class="hljs-class"></span>&#123;        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Test</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> $input</span>)</span>;&#125; <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">A</span></span><span class="hljs-class"></span>&#123;        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Test</span>(<span class="hljs-params">$input</span>)</span><span class="hljs-function">    </span>&#123;    &#125;     <span class="hljs-comment">// type omitted for $input</span>&#125;</code></pre><h3 id="å…è®¸åˆ†ç»„å‘½åç©ºé—´çš„å°¾éƒ¨é€—å·"><a class="header-anchor" href="#å…è®¸åˆ†ç»„å‘½åç©ºé—´çš„å°¾éƒ¨é€—å·"></a>å…è®¸åˆ†ç»„å‘½åç©ºé—´çš„å°¾éƒ¨é€—å·</h3><ul><li>å‘½åç©ºé—´å¯ä»¥åœ¨PHP 7ä¸­ä½¿ç”¨å°¾éšé€—å·è¿›è¡Œåˆ†ç»„å¼•å…¥ã€‚</li></ul><pre><code class="hljs php"><span class="hljs-keyword">use</span> <span class="hljs-title">Foo</span>\<span class="hljs-title">Bar</span>\&#123;    <span class="hljs-title">Foo</span>,    <span class="hljs-title">Bar</span>,    <span class="hljs-title">Baz</span>,&#125;;</code></pre>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>phpç‰ˆæœ¬</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kafka</title>
    <link href="/2019/03/24/kafka%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <url>/2019/03/24/kafka%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<p>è½¬è‡³ï¼š<a href="https://blog.csdn.net/dapeng1995/article/details/81536862">https://blog.csdn.net/dapeng1995/article/details/81536862</a></p><h1>1 Kafkaå…¥é—¨æ•™ç¨‹</h1><h2 id="1-1-æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage-Queue"><a class="header-anchor" href="#1-1-æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage-Queue"></a>1.1 æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queue)</h2><p>Message Queueæ¶ˆæ¯ä¼ é€ç³»ç»Ÿæä¾›ä¼ é€æœåŠ¡ã€‚æ¶ˆæ¯ä¼ é€ä¾èµ–äºå¤§é‡æ”¯æŒç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶è´Ÿè´£å¤„ç†è¿æ¥æœåŠ¡ã€æ¶ˆæ¯çš„è·¯ç”±å’Œä¼ é€ã€æŒä¹…æ€§ã€å®‰å…¨æ€§ä»¥åŠæ—¥å¿—è®°å½•ã€‚æ¶ˆæ¯<a href="https://www.baidu.com/s?wd=%E6%9C%8D%E5%8A%A1%E5%99%A8&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd">æœåŠ¡å™¨</a>å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªä»£ç†å®ä¾‹ã€‚ JMSï¼ˆJava Messaging Serviceï¼‰æ˜¯Javaå¹³å°ä¸Šæœ‰å…³é¢å‘<a href="https://www.baidu.com/s?wd=%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd">æ¶ˆæ¯ä¸­é—´ä»¶</a>(MOM)çš„æŠ€æœ¯è§„èŒƒï¼Œå®ƒä¾¿äºæ¶ˆæ¯ç³»ç»Ÿä¸­çš„Javaåº”ç”¨ç¨‹åºè¿›è¡Œæ¶ˆæ¯äº¤æ¢, å¹¶ä¸”é€šè¿‡æä¾›æ ‡å‡†çš„äº§ç”Ÿã€å‘é€ã€æ¥æ”¶æ¶ˆæ¯çš„æ¥å£ç®€åŒ–ä¼ä¸šåº”ç”¨çš„å¼€å‘ï¼Œç¿»è¯‘ä¸ºJavaæ¶ˆæ¯æœåŠ¡ã€‚</p><h2 id="1-2-MQæ¶ˆæ¯æ¨¡å‹"><a class="header-anchor" href="#1-2-MQæ¶ˆæ¯æ¨¡å‹"></a>1.2 MQæ¶ˆæ¯æ¨¡å‹</h2><p><img src="https://blog.wenboo.top/wp-content/uploads/2019/01/767642f7e981152f4d5b961af0989cfe.png" alt=""> <em>KafkaMQæ¶ˆæ¯æ¨¡å‹å›¾1-1</em></p><h2 id="1-3-MQæ¶ˆæ¯é˜Ÿåˆ—åˆ†ç±»"><a class="header-anchor" href="#1-3-MQæ¶ˆæ¯é˜Ÿåˆ—åˆ†ç±»"></a>1.3 MQæ¶ˆæ¯é˜Ÿåˆ—åˆ†ç±»</h2><p>æ¶ˆæ¯é˜Ÿåˆ—åˆ†ç±»ï¼šç‚¹å¯¹ç‚¹å’Œå‘å¸ƒ/è®¢é˜…ä¸¤ç§ï¼š 1ã€ç‚¹å¯¹ç‚¹ï¼š æ¶ˆæ¯ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯å‘é€åˆ°queueä¸­ï¼Œç„¶åæ¶ˆæ¯æ¶ˆè´¹è€…ä»queueä¸­å–å‡ºå¹¶ä¸”æ¶ˆè´¹æ¶ˆæ¯ã€‚ æ¶ˆæ¯è¢«æ¶ˆè´¹ä»¥åï¼Œqueueä¸­ä¸å†æœ‰å­˜å‚¨ï¼Œæ‰€ä»¥æ¶ˆæ¯æ¶ˆè´¹è€…ä¸å¯èƒ½æ¶ˆè´¹åˆ°å·²ç»è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚Queueæ”¯æŒå­˜åœ¨å¤šä¸ªæ¶ˆè´¹è€…ï¼Œä½†æ˜¯å¯¹ä¸€ä¸ªæ¶ˆæ¯è€Œè¨€ï¼Œåªä¼šæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹ã€‚ 2ã€å‘å¸ƒ/è®¢é˜…ï¼š æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆå‘å¸ƒï¼‰å°†æ¶ˆæ¯å‘å¸ƒåˆ°topicä¸­ï¼ŒåŒæ—¶æœ‰å¤šä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆè®¢é˜…ï¼‰æ¶ˆè´¹è¯¥æ¶ˆæ¯ã€‚å’Œç‚¹å¯¹ç‚¹æ–¹å¼ä¸åŒï¼Œå‘å¸ƒåˆ°topicçš„æ¶ˆæ¯ä¼šè¢«æ‰€æœ‰è®¢é˜…è€…æ¶ˆè´¹ã€‚</p><h2 id="1-4-MQæ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”"><a class="header-anchor" href="#1-4-MQæ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”"></a>1.4 MQæ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”</h2><p>1ã€RabbitMQï¼šæ”¯æŒçš„åè®®å¤šï¼Œéå¸¸é‡é‡çº§æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯¹è·¯ç”±(Routing)ï¼Œè´Ÿè½½å‡è¡¡(Loadbalance)æˆ–è€…æ•°æ®æŒä¹…åŒ–éƒ½æœ‰å¾ˆå¥½çš„æ”¯æŒã€‚ 2ã€ZeroMQï¼šå·ç§°æœ€å¿«çš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œå°¤å…¶é’ˆå¯¹å¤§ååé‡çš„éœ€æ±‚åœºæ™¯ï¼Œæ“…é•¿çš„é«˜çº§/å¤æ‚çš„é˜Ÿåˆ—ï¼Œä½†æ˜¯æŠ€æœ¯ä¹Ÿå¤æ‚ï¼Œå¹¶ä¸”åªæä¾›éæŒä¹…æ€§çš„é˜Ÿåˆ—ã€‚ 3ã€<a href="https://www.baidu.com/s?wd=ActiveMQ&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd">ActiveMQ</a>ï¼šApacheä¸‹çš„ä¸€ä¸ªå­é¡¹ï¼Œç±»ä¼¼ZeroMQï¼Œèƒ½å¤Ÿä»¥ä»£ç†äººå’Œç‚¹å¯¹ç‚¹çš„æŠ€æœ¯å®ç°é˜Ÿåˆ—ã€‚ 4ã€Redisï¼šæ˜¯ä¸€ä¸ªkey-Valueçš„NOSqlæ•°æ®åº“ï¼Œä½†ä¹Ÿæ”¯æŒMQåŠŸèƒ½ï¼Œæ•°æ®é‡è¾ƒå°ï¼Œæ€§èƒ½ä¼˜äºRabbitMQï¼Œæ•°æ®è¶…è¿‡10Kå°±æ…¢çš„æ— æ³•å¿å—ã€‚</p><h2 id="1-5-Kafkaç®€ä»‹"><a class="header-anchor" href="#1-5-Kafkaç®€ä»‹"></a>1.5 Kafkaç®€ä»‹</h2><p>Kafkaæ˜¯åˆ†å¸ƒå¼å‘å¸ƒ-è®¢é˜…æ¶ˆæ¯ç³»ç»Ÿ, å®ƒæœ€åˆç”± LinkedIn å…¬å¸å¼€å‘ï¼Œä½¿ç”¨ Scalaè¯­è¨€ç¼–å†™, ä¹‹åæˆä¸º Apache é¡¹ç›®çš„ä¸€éƒ¨åˆ†ã€‚åœ¨Kafkaé›†ç¾¤ä¸­ï¼Œæ²¡æœ‰â€œä¸­å¿ƒä¸»èŠ‚ç‚¹â€çš„æ¦‚å¿µï¼Œé›†ç¾¤ä¸­æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½æ˜¯å¯¹ç­‰çš„ï¼Œå› æ­¤ï¼Œå¯ä»¥åœ¨ä¸åšä»»ä½•é…ç½®çš„æ›´æ”¹çš„æƒ…å†µä¸‹å®ç°æœåŠ¡å™¨çš„çš„æ·»åŠ ä¸åˆ é™¤ï¼ŒåŒæ ·çš„æ¶ˆæ¯çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹Ÿèƒ½å¤Ÿåšåˆ°éšæ„é‡å¯å’Œæœºå™¨çš„ä¸Šä¸‹çº¿ã€‚</p><p><img src="https://blog.wenboo.top/wp-content/uploads/2019/01/71b3fb3fed3fa3528894c67de93394d3.png" alt=""> <em>Kafkaæ¶ˆæ¯ç³»ç»Ÿç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ¨ç½²å…³ç³»å›¾1-2</em> <img src="https://blog.wenboo.top/wp-content/uploads/2019/01/961b508e41d1acbd486891c0b16006f3.png" alt=""></p><p><em>Kafkaæ¶ˆæ¯ç³»ç»Ÿæ¶æ„å›¾1-3</em> __</p><h2 id="1-6-Kafkaæœ¯è¯­ä»‹ç»"><a class="header-anchor" href="#1-6-Kafkaæœ¯è¯­ä»‹ç»"></a>1.6 Kafkaæœ¯è¯­ä»‹ç»</h2><p>1ã€æ¶ˆæ¯ç”Ÿäº§è€…ï¼šå³ï¼šProducerï¼Œæ˜¯æ¶ˆæ¯çš„äº§ç”Ÿçš„æºå¤´ï¼Œè´Ÿè´£ç”Ÿæˆæ¶ˆæ¯å¹¶å‘é€åˆ°Kafka æœåŠ¡å™¨ä¸Šã€‚ 2ã€æ¶ˆæ¯æ¶ˆè´¹è€…ï¼šå³ï¼šConsumerï¼Œæ˜¯æ¶ˆæ¯çš„ä½¿ç”¨æ–¹ï¼Œè´Ÿè´£æ¶ˆè´¹KafkaæœåŠ¡å™¨ä¸Šçš„æ¶ˆæ¯ã€‚ 3ã€ä¸»é¢˜ï¼šå³ï¼šTopicï¼Œç”±ç”¨æˆ·å®šä¹‰å¹¶é…ç½®åœ¨KafkaæœåŠ¡å™¨ï¼Œç”¨äºå»ºç«‹ç”Ÿäº§è€…å’Œæ¶ˆæ¯è€…ä¹‹é—´çš„è®¢é˜…å…³ç³»ï¼šç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°æŒ‡å®šçš„Topicä¸‹ï¼Œæ¶ˆæ¯è€…ä»è¿™ä¸ªTopicä¸‹æ¶ˆè´¹æ¶ˆæ¯ã€‚ 4ã€æ¶ˆæ¯åˆ†åŒºï¼šå³ï¼šPartitionï¼Œä¸€ä¸ªTopicä¸‹é¢ä¼šåˆ†ä¸ºå¾ˆå¤šåˆ†åŒºï¼Œä¾‹å¦‚ï¼šâ€œkafka-testâ€è¿™ä¸ªTopicä¸‹å¯ä»¥åˆ†ä¸º6ä¸ªåˆ†åŒºï¼Œåˆ†åˆ«ç”±ä¸¤å°æœåŠ¡å™¨æä¾›ï¼Œé‚£ä¹ˆé€šå¸¸å¯ä»¥é…ç½®ä¸ºè®©æ¯å°æœåŠ¡å™¨æä¾›3ä¸ªåˆ†åŒºï¼Œå‡å¦‚æœåŠ¡å™¨IDåˆ†åˆ«ä¸º0ã€1ï¼Œåˆ™æ‰€æœ‰çš„åˆ†åŒºä¸º0-0ã€0-1ã€0-2å’Œ1-0ã€1-1ã€1-2ã€‚Topicç‰©ç†ä¸Šçš„åˆ†ç»„ï¼Œä¸€ä¸ª topicå¯ä»¥åˆ†ä¸ºå¤šä¸ª partitionï¼Œæ¯ä¸ª partition æ˜¯ä¸€ä¸ªæœ‰åºçš„é˜Ÿåˆ—ã€‚partitionä¸­çš„æ¯æ¡æ¶ˆæ¯éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªæœ‰åºçš„ idï¼ˆoffsetï¼‰ã€‚ 5ã€Brokerï¼šå³Kafkaçš„æœåŠ¡å™¨ï¼Œç”¨æˆ·å­˜å‚¨æ¶ˆæ¯ï¼ŒKafaé›†ç¾¤ä¸­çš„ä¸€å°æˆ–å¤šå°æœåŠ¡å™¨ç»Ÿç§°ä¸º brokerã€‚ 6ã€æ¶ˆè´¹è€…åˆ†ç»„ï¼šGroupï¼Œç”¨äºå½’ç»„åŒç±»æ¶ˆè´¹è€…ï¼Œåœ¨Kafkaä¸­ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥å…±åŒæ¶ˆæ¯ä¸€ä¸ªTopicä¸‹çš„æ¶ˆæ¯ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹å…¶ä¸­çš„éƒ¨åˆ†æ¶ˆæ¯ï¼Œè¿™äº›æ¶ˆè´¹è€…å°±ç»„æˆäº†ä¸€ä¸ªåˆ†ç»„ï¼Œæ‹¥æœ‰åŒä¸€ä¸ªåˆ†ç»„åç§°ï¼Œé€šå¸¸ä¹Ÿè¢«ç§°ä¸ºæ¶ˆè´¹è€…é›†ç¾¤ã€‚ 7ã€Offsetï¼šæ¶ˆæ¯å­˜å‚¨åœ¨Kafkaçš„Brokerä¸Šï¼Œæ¶ˆè´¹è€…æ‹‰å–æ¶ˆæ¯æ•°æ®çš„è¿‡ç¨‹ä¸­éœ€è¦çŸ¥é“æ¶ˆæ¯åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ï¼Œè¿™ä¸ªåç§»é‡å°±æ˜¯æ‰€è°“çš„Offsetã€‚</p><h2 id="1-7-Kafkaä¸­Broker"><a class="header-anchor" href="#1-7-Kafkaä¸­Broker"></a>1.7 Kafkaä¸­Broker</h2><p>1ã€Brokerï¼šå³Kafkaçš„æœåŠ¡å™¨ï¼Œç”¨æˆ·å­˜å‚¨æ¶ˆæ¯ï¼ŒKafaé›†ç¾¤ä¸­çš„ä¸€å°æˆ–å¤šå°æœåŠ¡å™¨ç»Ÿç§°ä¸º brokerã€‚ 2ã€Messageåœ¨Brokerä¸­é€šLogè¿½åŠ çš„æ–¹å¼è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ã€‚å¹¶è¿›è¡Œåˆ†åŒºï¼ˆpatitions)ã€‚ 3ã€ä¸ºäº†å‡å°‘ç£ç›˜å†™å…¥çš„æ¬¡æ•°, brokerä¼šå°†æ¶ˆæ¯æš‚æ—¶bufferèµ·æ¥, å½“æ¶ˆæ¯çš„ä¸ªæ•°(æˆ–å°ºå¯¸)è¾¾åˆ°ä¸€å®šé˜€å€¼æ—¶, å†flushåˆ°ç£ç›˜, è¿™æ ·å‡å°‘äº†ç£ç›˜IOè°ƒç”¨çš„æ¬¡æ•°ã€‚ 4ã€Brokeræ²¡æœ‰å‰¯æœ¬æœºåˆ¶ï¼Œä¸€æ—¦brokerå®•æœºï¼Œè¯¥brokerçš„æ¶ˆæ¯å°†éƒ½ä¸å¯ç”¨ã€‚Messageæ¶ˆæ¯æ˜¯æœ‰å¤šä»½çš„ã€‚ 5ã€Brokerä¸ä¿å­˜è®¢é˜…è€…çš„çŠ¶æ€ï¼Œç”±è®¢é˜…è€…è‡ªå·±ä¿å­˜ã€‚ 6ã€æ— çŠ¶æ€å¯¼è‡´æ¶ˆæ¯çš„åˆ é™¤æˆä¸ºéš¾é¢˜ï¼ˆå¯èƒ½åˆ é™¤çš„æ¶ˆæ¯æ­£åœ¨è¢«è®¢é˜…ï¼‰ï¼Œkafkaé‡‡ç”¨åŸºäºæ—¶é—´çš„SLA(æœåŠ¡æ°´å¹³ä¿è¯)ï¼Œæ¶ˆæ¯ä¿å­˜ä¸€å®šæ—¶é—´ï¼ˆé€šå¸¸ä¸º7å¤©ï¼‰åä¼šè¢«åˆ é™¤ã€‚ 7ã€æ¶ˆæ¯è®¢é˜…è€…å¯ä»¥rewind backåˆ°ä»»æ„ä½ç½®é‡æ–°è¿›è¡Œæ¶ˆè´¹ï¼Œå½“è®¢é˜…è€…æ•…éšœæ—¶ï¼Œå¯ä»¥é€‰æ‹©æœ€å°çš„offset(id)è¿›è¡Œé‡æ–°è¯»å–æ¶ˆè´¹æ¶ˆæ¯ã€‚</p><h2 id="1-8-Kafkaçš„Messageç»„æˆ"><a class="header-anchor" href="#1-8-Kafkaçš„Messageç»„æˆ"></a>1.8 Kafkaçš„Messageç»„æˆ</h2><p>1ã€Messageæ¶ˆæ¯ï¼šæ˜¯é€šä¿¡çš„åŸºæœ¬å•ä½ï¼Œæ¯ä¸ª producer å¯ä»¥å‘ä¸€ä¸ª topicï¼ˆä¸»é¢˜ï¼‰å‘å¸ƒä¸€äº›æ¶ˆæ¯ã€‚ 2ã€Kafkaä¸­çš„Messageæ˜¯ä»¥topicä¸ºåŸºæœ¬å•ä½ç»„ç»‡çš„ï¼Œä¸åŒçš„topicä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚æ¯ä¸ªtopicåˆå¯ä»¥åˆ†æˆå‡ ä¸ªä¸åŒçš„partition(æ¯ä¸ªtopicæœ‰å‡ ä¸ªpartitionæ˜¯åœ¨åˆ›å»ºtopicæ—¶æŒ‡å®šçš„)ï¼Œæ¯ä¸ªpartitionå­˜å‚¨ä¸€éƒ¨åˆ†Messageã€‚ 3ã€partitionä¸­çš„æ¯æ¡MessageåŒ…å«äº†ä»¥ä¸‹ä¸‰ä¸ªå±æ€§ï¼š offset å³ï¼šæ¶ˆæ¯å”¯ä¸€æ ‡è¯†: å¯¹åº”ç±»å‹ï¼šlong MessageSize å¯¹åº”ç±»å‹ï¼šint32 data æ˜¯messageçš„å…·ä½“å†…å®¹ã€‚</p><h2 id="1-9-Kafkaçš„Partitionsåˆ†åŒº"><a class="header-anchor" href="#1-9-Kafkaçš„Partitionsåˆ†åŒº"></a>1.9 Kafkaçš„Partitionsåˆ†åŒº</h2><p>1ã€KafkaåŸºäºæ–‡ä»¶å­˜å‚¨. é€šè¿‡åˆ†åŒºï¼Œå¯ä»¥å°†æ—¥å¿—å†…å®¹åˆ†æ•£åˆ°å¤šä¸ªserverä¸Š, æ¥é¿å…æ–‡ä»¶å°ºå¯¸è¾¾åˆ°å•æœºç£ç›˜çš„ä¸Šé™ï¼Œæ¯ä¸ªpartitonéƒ½ä¼šè¢«å½“å‰server(kafkaå®ä¾‹)ä¿å­˜ã€‚ 2ã€å¯ä»¥å°†ä¸€ä¸ªtopicåˆ‡åˆ†å¤šä»»æ„å¤šä¸ªpartitionsï¼Œæ¥æ¶ˆæ¯ä¿å­˜/æ¶ˆè´¹çš„æ•ˆç‡ã€‚ 3ã€è¶Šå¤šçš„partitionsæ„å‘³ç€å¯ä»¥å®¹çº³æ›´å¤šçš„consumerï¼Œæœ‰æ•ˆæå‡å¹¶å‘æ¶ˆè´¹çš„èƒ½åŠ›ã€‚</p><h2 id="1-10-Kafkaçš„Consumers"><a class="header-anchor" href="#1-10-Kafkaçš„Consumers"></a>1.10 Kafkaçš„Consumers</h2><p>1ã€æ¶ˆæ¯å’Œæ•°æ®æ¶ˆè´¹è€…ï¼Œè®¢é˜… topicså¹¶å¤„ç†å…¶å‘å¸ƒçš„æ¶ˆæ¯çš„è¿‡ç¨‹å«åš consumersã€‚ 2ã€åœ¨ kafkaä¸­, æˆ‘ä»¬å¯ä»¥è®¤ä¸ºä¸€ä¸ªgroupæ˜¯ä¸€ä¸ªâ€œè®¢é˜…è€…â€ï¼Œä¸€ä¸ªTopicä¸­çš„æ¯ä¸ªpartionsï¼Œåªä¼šè¢«ä¸€ä¸ªâ€œè®¢é˜…è€…â€ä¸­çš„ä¸€ä¸ªconsumeræ¶ˆè´¹ï¼Œä¸è¿‡ä¸€ä¸ª consumerå¯ä»¥æ¶ˆè´¹å¤šä¸ªpartitionsä¸­çš„æ¶ˆæ¯ï¼ˆæ¶ˆè´¹è€…æ•°æ®å°äºPartionsçš„æ•°é‡æ—¶ï¼‰ã€‚æ³¨æ„ï¼škafkaçš„è®¾è®¡åŸç†å†³å®šï¼Œå¯¹äºä¸€ä¸ªtopicï¼ŒåŒä¸€ä¸ªgroupä¸­ä¸èƒ½æœ‰å¤šäºpartitionsä¸ªæ•°çš„consumeråŒæ—¶æ¶ˆè´¹ï¼Œå¦åˆ™å°†æ„å‘³ç€æŸäº›consumerå°†æ— æ³•å¾—åˆ°æ¶ˆæ¯ã€‚ 3ã€ä¸€ä¸ªpartitionä¸­çš„æ¶ˆæ¯åªä¼šè¢«groupä¸­çš„ä¸€ä¸ªconsumeræ¶ˆæ¯ã€‚æ¯ä¸ªgroupä¸­consumeræ¶ˆæ¯æ¶ˆè´¹äº’ç›¸ç‹¬ç«‹ã€‚</p><h2 id="1-11-Kafkaçš„æŒä¹…åŒ–"><a class="header-anchor" href="#1-11-Kafkaçš„æŒä¹…åŒ–"></a>1.11 Kafkaçš„æŒä¹…åŒ–</h2><p>1ã€ä¸€ä¸ªTopicå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç±»æ¶ˆæ¯ï¼Œæ¯ä¸ªtopicå°†è¢«åˆ†æˆå¤špartition(åŒº), æ¯ä¸ªpartitionåœ¨å­˜å‚¨å±‚é¢æ˜¯append logæ–‡ä»¶ã€‚ä»»ä½•å‘å¸ƒåˆ°æ­¤partitionçš„æ¶ˆæ¯éƒ½ä¼šè¢«ç›´æ¥è¿½åŠ åˆ°logæ–‡ä»¶çš„å°¾éƒ¨ï¼Œæ¯æ¡æ¶ˆæ¯åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®ç§°ä¸ºoffsetï¼ˆåç§»é‡ï¼‰ï¼Œpartitionæ˜¯ä»¥æ–‡ä»¶çš„å½¢å¼å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚ 2ã€Logsæ–‡ä»¶æ ¹æ®brokerä¸­çš„é…ç½®è¦æ±‚, ä¿ç•™ä¸€å®šæ—¶é—´ååˆ é™¤æ¥é‡Šæ”¾ç£ç›˜ç©ºé—´ã€‚</p><p><img src="https://blog.wenboo.top/wp-content/uploads/2019/01/15e686fadcd3a2b25d5e5fd170c47932.png" alt=""> <em>Kafkaæ¶ˆæ¯åˆ†åŒºPartitionå›¾1-4</em> Partitionï¼š Topicç‰©ç†ä¸Šçš„åˆ†ç»„ï¼Œä¸€ä¸ª topicå¯ä»¥åˆ†ä¸ºå¤šä¸ª partitionï¼Œæ¯ä¸ª partitionæ˜¯ä¸€ä¸ªæœ‰åºçš„é˜Ÿåˆ—ã€‚partitionä¸­çš„æ¯æ¡æ¶ˆæ¯éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªæœ‰åºçš„ idï¼ˆoffsetï¼‰ã€‚ 3ã€ä¸ºæ•°æ®æ–‡ä»¶å»ºç´¢å¼•ï¼šç¨€ç–å­˜å‚¨ï¼Œæ¯éš”ä¸€å®šå­—èŠ‚çš„æ•°æ®å»ºç«‹ä¸€æ¡ç´¢å¼•ã€‚ä¸‹å›¾ä¸ºä¸€ä¸ªpartitionçš„ç´¢å¼•ç¤ºæ„å›¾ï¼š <img src="https://blog.wenboo.top/wp-content/uploads/2019/01/31f787533840e374e9e9dc9f1a352872.png" alt=""></p><p><em>Kafkaæ¶ˆæ¯åˆ†åŒºPartitionç´¢å¼•å›¾1-5</em></p><h2 id="1-12-Kafkaçš„åˆ†å¸ƒå¼å®ç°ï¼š"><a class="header-anchor" href="#1-12-Kafkaçš„åˆ†å¸ƒå¼å®ç°ï¼š"></a>1.12 Kafkaçš„åˆ†å¸ƒå¼å®ç°ï¼š</h2><p><img src="https://blog.wenboo.top/wp-content/uploads/2019/01/d5f1c4528fa627008746864d86ed2dba.png" alt=""> <em>Kafkaåˆ†å¸ƒå¼å…³ç³»å›¾1-6</em> <img src="https://blog.wenboo.top/wp-content/uploads/2019/01/aaf2c87a1feb6e849b807ed1af44eba9.png" alt=""></p><p><em>Kafkaç”Ÿäº§ç¯å¢ƒå…³ç³»å›¾1-7</em></p><h2 id="1-13-Kafkaçš„é€šè®¯åè®®ï¼š"><a class="header-anchor" href="#1-13-Kafkaçš„é€šè®¯åè®®ï¼š"></a>1.13 Kafkaçš„é€šè®¯åè®®ï¼š</h2><p>1ã€Kafkaçš„Producerã€Brokerå’ŒConsumerä¹‹é—´é‡‡ç”¨çš„æ˜¯ä¸€å¥—è‡ªè¡Œè®¾è®¡åŸºäºTCPå±‚çš„åè®®ï¼Œæ ¹æ®ä¸šåŠ¡éœ€æ±‚å®šåˆ¶ï¼Œè€Œéå®ç°ä¸€å¥—ç±»ä¼¼ProtocolBufferçš„é€šç”¨åè®®ã€‚ 2ã€åŸºæœ¬æ•°æ®ç±»å‹ï¼šï¼ˆKafkaæ˜¯åŸºäºScalaè¯­è¨€å®ç°çš„ï¼Œç±»å‹ä¹Ÿæ˜¯Scalaä¸­çš„æ•°æ®ç±»å‹ï¼‰ <strong>å®šé•¿æ•°æ®ç±»å‹</strong>ï¼šint8, int16, int32å’Œint64ï¼Œå¯¹åº”åˆ°Javaä¸­å°±æ˜¯byte, short, intå’Œlongã€‚ <strong>å˜é•¿æ•°æ®ç±»å‹</strong>ï¼šbyteså’Œstringã€‚å˜é•¿çš„æ•°æ®ç±»å‹ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ä¸€ä¸ªæœ‰ç¬¦å·æ•´æ•°N(è¡¨ç¤ºå†…å®¹çš„é•¿åº¦)å’ŒNä¸ªå­—èŠ‚çš„å†…å®¹ã€‚å…¶ä¸­ï¼ŒNä¸º-1è¡¨ç¤ºå†…å®¹ä¸ºnullã€‚bytesçš„é•¿åº¦ç”±int32è¡¨ç¤ºï¼Œstringçš„é•¿åº¦ç”±int16è¡¨ç¤ºã€‚ <strong>æ•°ç»„</strong>ï¼šæ•°ç»„ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ä¸€ä¸ªç”±int32ç±»å‹çš„æ•°å­—è¡¨ç¤ºçš„æ•°ç»„é•¿åº¦Nå’ŒNä¸ªå…ƒç´ ã€‚ 3ã€Kafkaé€šè®¯çš„åŸºæœ¬å•ä½æ˜¯Request/Responseã€‚ 4ã€åŸºæœ¬ç»“æ„ï¼š RequestOrResponse =&gt; MessageSize(RequestMessage | ResponseMessage)</p><table><thead><tr><th>col 1</th><th>col 2</th><th>col 3</th></tr></thead><tbody><tr><td>åç§°</td><td>ç±»å‹</td><td>ææœ¯</td></tr><tr><td>MessageSize</td><td>int32</td><td>è¡¨ç¤ºRequestMessageæˆ–è€…ResponseMessageçš„é•¿åº¦</td></tr><tr><td>RequestMessage</td><td>â€”</td><td></td></tr><tr><td>ResponseMessage</td><td>â€”</td><td></td></tr></tbody></table><p>5ã€é€šè®¯è¿‡ç¨‹ï¼š å®¢æˆ·ç«¯æ‰“å¼€ä¸æœåŠ¡å™¨ç«¯çš„Socket å¾€Socketå†™å…¥ä¸€ä¸ªint32çš„æ•°å­—(æ•°å­—è¡¨ç¤ºè¿™æ¬¡å‘é€çš„Requestæœ‰å¤šå°‘å­—èŠ‚) æœåŠ¡å™¨ç«¯å…ˆè¯»å‡ºä¸€ä¸ªint32çš„æ•´æ•°ä»è€Œè·å–è¿™æ¬¡Requestçš„å¤§å° ç„¶åè¯»å–å¯¹åº”å­—èŠ‚æ•°çš„æ•°æ®ä»è€Œå¾—åˆ°Requestçš„å…·ä½“å†…å®¹ æœåŠ¡å™¨ç«¯å¤„ç†äº†è¯·æ±‚åï¼Œä¹Ÿç”¨åŒæ ·çš„æ–¹å¼æ¥å‘é€å“åº”ã€‚ 6ã€RequestMessageç»“æ„ï¼š RequestMessage =&gt; ApiKey ApiVersionCorrelationId ClientId Request</p><table><thead><tr><th>col 1</th><th>col 2</th><th>col 3</th></tr></thead><tbody><tr><td>åç§°</td><td>ç±»å‹</td><td>ææœ¯</td></tr><tr><td>ApiKey</td><td>int16</td><td>è¡¨ç¤ºè¿™æ¬¡è¯·æ±‚çš„APIç¼–å·</td></tr><tr><td>ApiVersion</td><td>int16</td><td>è¡¨ç¤ºè¯·æ±‚çš„APIçš„ç‰ˆæœ¬ï¼Œæœ‰äº†ç‰ˆæœ¬åå°±å¯ä»¥åšåˆ°åå‘å…¼å®¹</td></tr><tr><td>CorrelationId</td><td>int32</td><td>ç”±å®¢æˆ·ç«¯æŒ‡å®šçš„ä¸€ä¸ªæ•°å­—å”¯ä¸€æ ‡ç¤ºè¿™æ¬¡è¯·æ±‚çš„idï¼ŒæœåŠ¡å™¨ç«¯åœ¨å¤„ç†å®Œè¯·æ±‚åä¹Ÿä¼šæŠŠåŒæ ·çš„CorrelationIdå†™åˆ°Responseä¸­ï¼Œè¿™æ ·å®¢æˆ·ç«¯å°±èƒ½æŠŠæŸä¸ªè¯·æ±‚å’Œå“åº”å¯¹åº”èµ·æ¥äº†ã€‚</td></tr><tr><td>ClientId</td><td>string</td><td>å®¢æˆ·ç«¯æŒ‡å®šçš„ç”¨æ¥æè¿°å®¢æˆ·ç«¯çš„å­—ç¬¦ä¸²ï¼Œä¼šè¢«ç”¨æ¥è®°å½•æ—¥å¿—å’Œç›‘æ§ï¼Œå®ƒå”¯ä¸€æ ‡ç¤ºä¸€ä¸ªå®¢æˆ·ç«¯ã€‚</td></tr><tr><td>Request</td><td>â€”</td><td>Requestçš„å…·ä½“å†…å®¹ã€‚</td></tr></tbody></table><p>7ã€ResponseMessageç»“æ„ï¼š ResponseMessage =&gt; CorrelationId Response</p><table><thead><tr><th>col 1</th><th>col 2</th><th>col 3</th></tr></thead><tbody><tr><td>åç§°</td><td>ç±»å‹</td><td>ææœ¯</td></tr><tr><td>CorrelationId</td><td>int32</td><td>å¯¹åº”Requestçš„CorrelationIdã€‚</td></tr><tr><td>Response</td><td>â€”</td><td>å¯¹åº”Requestçš„Responseï¼Œä¸åŒçš„Requestçš„Responseçš„å­—æ®µæ˜¯ä¸ä¸€æ ·çš„ã€‚</td></tr></tbody></table><p>Kafkaé‡‡ç”¨æ˜¯ç»å…¸çš„Reactor(åŒæ­¥IO)æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯1ä¸ªAcceptorå“åº”å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼ŒNä¸ªProcessoræ¥è¯»å–æ•°æ®ï¼Œè¿™ç§æ¨¡å¼å¯ä»¥æ„å»ºå‡ºé«˜æ€§èƒ½çš„æœåŠ¡å™¨ã€‚ 8ã€Messageç»“æ„ï¼š Message: Producerç”Ÿäº§çš„æ¶ˆæ¯, é”®-å€¼å¯¹ Message =&gt; Crc MagicByte Attributes KeyValue</p><table><thead><tr><th>col 1</th><th>col 2</th><th>col 3</th></tr></thead><tbody><tr><td>åç§°</td><td>ç±»å‹</td><td>ææœ¯</td></tr><tr><td>CRC</td><td>int32</td><td>è¡¨ç¤ºè¿™æ¡æ¶ˆæ¯(ä¸åŒ…æ‹¬CRCå­—æ®µæœ¬èº«)çš„æ ¡éªŒç ã€‚</td></tr><tr><td>MagicByte</td><td>int8</td><td>è¡¨ç¤ºæ¶ˆæ¯æ ¼å¼çš„ç‰ˆæœ¬ï¼Œç”¨æ¥åšåå‘å…¼å®¹ï¼Œç›®å‰å€¼ä¸º0ã€‚</td></tr><tr><td>Attributes</td><td>int8</td><td>è¡¨ç¤ºè¿™æ¡æ¶ˆæ¯çš„å…ƒæ•°æ®ï¼Œç›®å‰æœ€ä½ä¸¤ä½ç”¨æ¥è¡¨ç¤ºå‹ç¼©æ ¼å¼ã€‚</td></tr><tr><td>Key</td><td>bytes</td><td>è¡¨ç¤ºè¿™æ¡æ¶ˆæ¯çš„Keyï¼Œå¯ä»¥ä¸ºnullã€‚</td></tr><tr><td>Value</td><td>bytes</td><td>è¡¨ç¤ºè¿™æ¡æ¶ˆæ¯çš„Valueã€‚Kafkaæ”¯æŒæ¶ˆæ¯åµŒå¥—ï¼Œä¹Ÿå°±æ˜¯æŠŠä¸€æ¡æ¶ˆæ¯ä½œä¸ºValueæ”¾åˆ°å¦å¤–ä¸€æ¡æ¶ˆæ¯é‡Œé¢ã€‚</td></tr></tbody></table><p>9ã€MessageSetç»“æ„ï¼š MessageSet: ç”¨æ¥ç»„åˆå¤šæ¡Messageï¼Œå®ƒåœ¨æ¯æ¡Messageçš„åŸºç¡€ä¸ŠåŠ ä¸Šäº†Offsetå’ŒMessageSize MessageSet =&gt; [Offset MessageSize Message]</p><table><thead><tr><th>col 1</th><th>col 2</th><th>col 3</th></tr></thead><tbody><tr><td>åç§°</td><td>ç±»å‹</td><td>ææœ¯</td></tr><tr><td>Offset</td><td>int64</td><td>å®ƒç”¨æ¥ä½œä¸ºlogä¸­çš„åºåˆ—å·ï¼ŒProduceråœ¨ç”Ÿäº§æ¶ˆæ¯çš„æ—¶å€™è¿˜ä¸çŸ¥é“å…·ä½“çš„å€¼æ˜¯ä»€ä¹ˆï¼Œå¯ä»¥éšä¾¿å¡«ä¸ªæ•°å­—è¿›å»ã€‚</td></tr><tr><td>MessageSize</td><td>int32</td><td>è¡¨ç¤ºè¿™æ¡Messageçš„å¤§å°ã€‚</td></tr><tr><td>Message</td><td>-</td><td>è¡¨ç¤ºè¿™æ¡Messageçš„å…·ä½“å†…å®¹ï¼Œå…¶æ ¼å¼è§ä¸Šä¸€å°èŠ‚ã€‚</td></tr></tbody></table><p>10ã€ Request/Responeå’ŒMessage/MessageSetçš„å…³ç³»ï¼š Request/Responseæ˜¯é€šè®¯å±‚çš„ç»“æ„ï¼Œå’Œç½‘ç»œçš„7å±‚æ¨¡å‹å¯¹æ¯”çš„è¯ï¼Œå®ƒç±»ä¼¼äºTCPå±‚ã€‚ Message/MessageSetå®šä¹‰çš„æ˜¯ä¸šåŠ¡å±‚çš„ç»“æ„ï¼Œç±»ä¼¼äºç½‘ç»œ7å±‚æ¨¡å‹ä¸­çš„HTTPå±‚ã€‚Message/MessageSetåªæ˜¯Request/Responseçš„payloadä¸­çš„ä¸€ç§æ•°æ®ç»“æ„ã€‚ å¤‡æ³¨ï¼šKafkaçš„é€šè®¯åè®®ä¸­ä¸å«Schemaï¼Œæ ¼å¼ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œè¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯åè®®è‡ªèº«çš„Overheadå°ï¼Œå†åŠ ä¸ŠæŠŠå¤šæ¡Messageæ”¾åœ¨ä¸€èµ·åšå‹ç¼©ï¼Œæé«˜å‹ç¼©æ¯”ç‡ï¼Œä»è€Œåœ¨ç½‘ç»œä¸Šä¼ è¾“çš„æ•°æ®é‡ä¼šå°‘ä¸€äº›ã€‚</p><h2 id="1-14-æ•°æ®ä¼ è¾“çš„äº‹åŠ¡å®šä¹‰ï¼š"><a class="header-anchor" href="#1-14-æ•°æ®ä¼ è¾“çš„äº‹åŠ¡å®šä¹‰ï¼š"></a>1.14 æ•°æ®ä¼ è¾“çš„äº‹åŠ¡å®šä¹‰ï¼š</h2><p>1ã€<strong>at most once</strong>: æœ€å¤šä¸€æ¬¡, è¿™ä¸ªå’ŒJMSä¸­â€éæŒä¹…åŒ–â€æ¶ˆæ¯ç±»ä¼¼. å‘é€ä¸€æ¬¡ï¼Œæ— è®ºæˆè´¥ï¼Œå°†ä¸ä¼šé‡å‘ã€‚ at most once: æ¶ˆè´¹è€…fetchæ¶ˆæ¯, ç„¶åä¿å­˜offsetï¼Œç„¶åå¤„ç†æ¶ˆæ¯; å½“clientä¿å­˜offsetä¹‹åï¼Œä½†æ˜¯åœ¨æ¶ˆæ¯å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°äº†å¼‚å¸¸ï¼Œå¯¼è‡´éƒ¨åˆ†æ¶ˆæ¯æœªèƒ½ç»§ç»­å¤„ç†. é‚£ä¹ˆæ­¤åâ€æœªå¤„ç†â€çš„æ¶ˆæ¯å°†ä¸èƒ½è¢«fetchåˆ°ï¼Œè¿™å°±æ˜¯â€œatmost onceâ€ã€‚ 2ã€<strong>at least once</strong>: æ¶ˆæ¯è‡³å°‘å‘é€ä¸€æ¬¡ï¼Œå¦‚æœæ¶ˆæ¯æœªèƒ½æ¥å—æˆåŠŸï¼Œå¯èƒ½ä¼šé‡å‘ï¼Œç›´åˆ°æ¥æ”¶æˆåŠŸã€‚ at least once: æ¶ˆè´¹è€…fetchæ¶ˆæ¯ï¼Œç„¶åå¤„ç†æ¶ˆæ¯ï¼Œç„¶åä¿å­˜offset. å¦‚æœæ¶ˆæ¯å¤„ç†æˆåŠŸä¹‹åï¼Œä½†æ˜¯åœ¨ä¿å­˜offseté˜¶æ®µzookeeperå¼‚å¸¸å¯¼è‡´ä¿å­˜æ“ä½œæœªèƒ½æ‰§è¡ŒæˆåŠŸï¼Œè¿™å°±å¯¼è‡´æ¥ä¸‹æ¥å†æ¬¡fetchæ—¶å¯èƒ½è·å¾—ä¸Šæ¬¡å·²ç»å¤„ç†è¿‡çš„æ¶ˆæ¯ï¼Œè¿™å°±æ˜¯â€œatleast onceâ€ï¼ŒåŸå› offsetæ²¡æœ‰åŠæ—¶çš„æäº¤ç»™zookeeperï¼Œzookeeperæ¢å¤æ­£å¸¸è¿˜æ˜¯ä¹‹å‰offsetçŠ¶æ€ã€‚ 3ã€<strong>exactly once</strong>: æ¶ˆæ¯åªä¼šå‘é€ä¸€æ¬¡ã€‚ exactly once: kafkaä¸­å¹¶æ²¡æœ‰ä¸¥æ ¼çš„å»å®ç°(åŸºäº2é˜¶æ®µæäº¤ï¼Œäº‹åŠ¡)ï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™ç§ç­–ç•¥åœ¨kafkaä¸­æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚ æ³¨ï¼šé€šå¸¸æƒ…å†µä¸‹â€œat-least-onceâ€æ˜¯æˆ‘ä»¬é¦–é€‰ã€‚(ç›¸æ¯”at most onceè€Œè¨€ï¼Œé‡å¤æ¥æ”¶æ•°æ®æ€»æ¯”ä¸¢å¤±æ•°æ®è¦å¥½)ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>+ æ¶ˆæ¯é˜Ÿåˆ—</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kafa</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é˜¶æ¢¯æ”¶è´¹é—®é¢˜</title>
    <link href="/2019/03/18/%E9%98%B6%E6%A2%AF%E6%94%B6%E8%B4%B9%E9%97%AE%E9%A2%98/"/>
    <url>/2019/03/18/%E9%98%B6%E6%A2%AF%E6%94%B6%E8%B4%B9%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<table><thead><tr><th>æ¢¯åº¦</th><th>è®¢å•æ•°</th><th>æ”¶è´¹</th></tr></thead><tbody><tr><td>1</td><td>1-10</td><td>30</td></tr><tr><td>2</td><td>11-15</td><td>25</td></tr><tr><td>3</td><td>16-25</td><td>20</td></tr><tr><td>4</td><td>26-40</td><td>10</td></tr><tr><td>5</td><td>å¤§äº40</td><td>5</td></tr></tbody></table><p>ä¾‹å¦‚ï¼šä¸€ä¸ªç”¨æˆ·æœ‰11ç¬”è®¢å•ï¼Œåˆ™ï¼š<code>30*10 + 1*25 = 325</code> ä»¥ä¸‹ä¸ºè®¡ç®—æ”¶è´¹æ–¹æ³•</p><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toll</span>(<span class="hljs-params">$order, &amp; $toll</span>)</span><span class="hljs-function"></span>&#123;    <span class="hljs-keyword">switch</span>($order)&#123;        <span class="hljs-keyword">case</span> $order &gt; <span class="hljs-number">40</span>:        $toll += ($order - <span class="hljs-number">40</span>)*<span class="hljs-number">5</span> + toll(<span class="hljs-number">40</span>, $toll);        <span class="hljs-keyword">break</span>;        <span class="hljs-keyword">case</span> $order &gt; <span class="hljs-number">25</span>:        $toll += ($order - <span class="hljs-number">25</span>)*<span class="hljs-number">10</span> + toll(<span class="hljs-number">25</span>, $toll);        <span class="hljs-keyword">break</span>;        <span class="hljs-keyword">case</span> $order &gt; <span class="hljs-number">15</span>:        $toll += ($order - <span class="hljs-number">15</span>)*<span class="hljs-number">10</span> + toll(<span class="hljs-number">15</span>, $toll);        <span class="hljs-keyword">break</span>;        <span class="hljs-keyword">case</span> $order &gt; <span class="hljs-number">10</span>:        $toll += ($order <span class="hljs-number">-10</span>)*<span class="hljs-number">25</span> + toll(<span class="hljs-number">10</span>, $toll);        <span class="hljs-keyword">break</span>;        <span class="hljs-keyword">default</span> :        $toll += $order * <span class="hljs-number">30</span>        <span class="hljs-keyword">break</span>;    &#125;&#125;toll(<span class="hljs-number">60</span>, $toll);<span class="hljs-keyword">print</span>($toll);</code></pre>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é˜¶æ¢¯æ”¶è´¹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¾èµ–æ³¨å…¥å’Œæ§åˆ¶åè½¬</title>
    <link href="/2019/03/13/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E5%92%8C%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%AC/"/>
    <url>/2019/03/13/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E5%92%8C%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%AC/</url>
    
    <content type="html"><![CDATA[<h4 id="Dependency-Injection-ä¸­æ–‡å«ä¾èµ–æ³¨å…¥ï¼ŒInversion-of-Control-å³æ§åˆ¶åè½¬"><a class="header-anchor" href="#Dependency-Injection-ä¸­æ–‡å«ä¾èµ–æ³¨å…¥ï¼ŒInversion-of-Control-å³æ§åˆ¶åè½¬"></a>Dependency Injection ä¸­æ–‡å«ä¾èµ–æ³¨å…¥ï¼ŒInversion of Control å³æ§åˆ¶åè½¬</h4><p><strong>ä¾èµ–æ³¨å…¥å’Œæ§åˆ¶åè½¬ï¼Œå…¶å®æ˜¯ä¸€ä¸ªä¸œè¥¿çš„ä¸¤ç§å«æ³•ï¼Œæˆ–è€…è¯´ä¸åŒè§’åº¦å¯¹è¿™ä¸ªäº‹æƒ…çš„ä¸¤ç§è§‚å¯Ÿã€‚</strong> æˆ‘ä»¬å…ˆè¯´ä¸‹**â€œä¾èµ–å€’ç½®åŸåˆ™â€**ï¼š åœ¨è½¯ä»¶è®¾è®¡ä¸­å¯ä»¥çœ‹åˆ°ä¼ ç»Ÿè½¯ä»¶çš„è®¾è®¡ï¼Œéƒ½æ˜¯ä¸Šå±‚ä»£ç ä¾èµ–äºä¸‹å±‚ä»£ç ï¼Œå½“ä¸‹å±‚ä»£ç æœ‰æ‰€æ”¹åŠ¨æ—¶ï¼Œä¸Šå±‚ä»£ç ä¹Ÿè¦ç›¸åº”è¿›è¡Œæ”¹åŠ¨ï¼Œå› æ­¤ç»´æŠ¤æˆæœ¬è¾ƒé«˜ã€‚è€Œä¾èµ–å€’ç½®åŸåˆ™çš„æ€æƒ³æ˜¯ï¼Œä¸Šå±‚ä¸åº”è¯¥ä¾èµ–ä¸‹å±‚ï¼Œåº”ä¾èµ–æ¥å£ã€‚æ„ä¸ºä¸Šå±‚ä»£ç å®šä¹‰æ¥å£ï¼Œä¸‹å±‚ä»£ç å®ç°è¯¥æ¥å£ï¼Œä»è€Œä½¿å¾—ä¸‹å±‚ä¾èµ–äºä¸Šå±‚æ¥å£ï¼Œé™ä½è€¦åˆåº¦ï¼Œæé«˜ç³»ç»Ÿå¼¹æ€§&quot;ã€‚ æˆ‘ä»¬æ¥é€šè¿‡ä»¥ä¸‹ç®€å•ç¤ºä¾‹æ¥è¡¨è¾¾ï¼š</p><pre><code class="hljs php"><span class="hljs-comment">//é‚®ä»¶ç±»</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Email</span></span><span class="hljs-class"></span>&#123;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendMail</span>(<span class="hljs-params"></span>)</span><span class="hljs-function">    </span>&#123;        ......    &#125;&#125;<span class="hljs-comment">//è¿™æ˜¯ä¸€ä¸ªæ³¨å†Œç±»</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Register</span></span><span class="hljs-class"></span>&#123;    <span class="hljs-comment">//æ³¨å†Œé€»è¾‘</span>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span>(<span class="hljs-params"></span>)</span><span class="hljs-function">    </span>&#123;        $Mail = <span class="hljs-keyword">new</span> Email();        <span class="hljs-comment">//å‘é€é‚®ä»¶</span>        $Mail-&gt;sendMail();    &#125;&#125;<span class="hljs-comment">//ä½¿ç”¨</span>$register = <span class="hljs-keyword">new</span> Register();<span class="hljs-comment">//å®ä¾‹åŒ–æ³¨å†Œç±»</span>$register-&gt;register();<span class="hljs-comment">//æ³¨å†Œæ“ä½œ</span></code></pre><p>ä»ä¸Šå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å·²ç»å®Œæˆäº†æ•´ä¸ªæ³¨å†Œçš„åŠŸèƒ½ï¼Œä½†æ˜¯å¦‚æœåç»­äº§å“ç»ç†è¯´ç”¨é‚®ä»¶å‘é€æ³¨å†Œç ä¸å¦‚æ”¹ç”¨çŸ­ä¿¡å‘é€ã€‚äº§å“ä¸Šçº¿åæ ¹æ®ä¸šåŠ¡çš„è°ƒæ•´ä¼šéœ€è¦ä¿®æ”¹ç¨‹åºï¼Œè¿™ç§æƒ…å†µå¹¶ä¸å°‘è§ã€‚ä»¥ä¸Šä»£ç é™¤äº†éœ€è¦æ–°å†™ä¸€ä¸ªçŸ­ä¿¡å‘é€ç±»ï¼Œè¿˜å¿…é¡»è¦æ”¹åŠ¨æœ€ä¸Šå±‚çš„Registerç±»ã€‚æ­¤æ—¶ç¨‹åºå‘˜å¿ƒé‡Œè·‘è¿‡ä¸€ä¸‡å¤´è‰æ³¥é©¬ï¼Œä»¥ä¸Šåœºæ™¯çš„é—®é¢˜åœ¨äºï¼Œä½ æ¯æ¬¡ä¸å¾—ä¸å¯¹â€™Mailâ€™ç±»è¿›è¡Œä¿®æ”¹ï¼Œä»£ç å¤ç”¨æ€§å¾ˆä½ï¼Œé«˜å±‚è¿‡åº¦ä¾èµ–äºåº•å±‚ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬å°±éµå¾ªâ€˜ä¾èµ–å€’ç½®åŸåˆ™â€™è®©åº•å±‚ç»§æ‰¿å®ç°ä¸Šå±‚å®šåˆ¶çš„æ¥å£ï¼Œè€Œä¸Šå±‚ä¾èµ–äºæ¥å£ã€‚</p><pre><code class="hljs php"><span class="hljs-comment">//å®šä¹‰æ¥å£</span><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Message</span></span><span class="hljs-class"></span>&#123;Â  Â  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send</span>(<span class="hljs-params"></span>)</span>;&#125;<span class="hljs-comment">//è®©é‚®ä»¶ç±»ç»§æ‰¿Messageæ¥å£ï¼Œå¹¶å®ç°æ¥å£ä¸­çš„sendæ–¹æ³•</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Email</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Message</span></span><span class="hljs-class"></span>&#123;Â  Â  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send</span>(<span class="hljs-params"></span>)</span><span class="hljs-function">Â  Â  </span>&#123;Â  Â  Â  Â  <span class="hljs-comment">//å‘é€Email</span>Â Â Â Â Â Â Â Â ......Â  Â  &#125;&#125;<span class="hljs-comment">//çŸ­ä¿¡ç±»ç»§æ‰¿Messageæ¥å£,å¹¶å®ç°æ¥å£ä¸­çš„sendæ–¹æ³•</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Sms</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Message</span></span><span class="hljs-class"></span>&#123;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send</span>(<span class="hljs-params"></span>)</span><span class="hljs-function">    </span>&#123;        <span class="hljs-comment">//å‘é€çŸ­ä¿¡</span>      ......    &#125;&#125;<span class="hljs-comment">//ä¿®æ”¹Registerç±»</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Register</span></span><span class="hljs-class"></span>&#123;    <span class="hljs-keyword">public</span> $message;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">Message $message</span>)</span><span class="hljs-function">    </span>&#123;        <span class="hljs-keyword">$this</span>-&gt;$message =  $message;    &#125;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span>(<span class="hljs-params"></span>)</span><span class="hljs-function">    </span>&#123;        <span class="hljs-comment">//å‘é€çŸ­ä¿¡</span>        <span class="hljs-keyword">$this</span>-&gt;$message-&gt;send();    &#125;    ......&#125;<span class="hljs-comment">//ä½¿ç”¨é‚®ä»¶æ³¨å†Œ</span>$Email = <span class="hljs-keyword">new</span> Email();$Register = <span class="hljs-keyword">new</span> Register($Email);$Register-&gt;register();<span class="hljs-comment">//ä½¿ç”¨çŸ­ä¿¡æ³¨å†Œ</span>$Sms = <span class="hljs-keyword">new</span> Sms();$Register = <span class="hljs-keyword">new</span> Register($Sms);$Register-&gt;register();</code></pre><p><strong>ä»¥ä¸Šç¤ºä¾‹å¯ä»¥çœ‹åˆ°ï¼Œæœ¬æ¥æ³¨å†Œæ—¶çš„ç±»å®ä¾‹åŒ–æµç¨‹æ˜¯Registerç±»-&gt;Emailç±»/Smsç±»ï¼Œæœ€ä¸Šå±‚ä¾èµ–åº•å±‚ï¼Œä»£ç ä¼šä¸€å±‚ä¸€å±‚çš„å¯¹åº•å±‚ä»£ç è¿›è¡Œå®ä¾‹åŒ–å’Œè°ƒç”¨ã€‚é€šè¿‡ä½¿ç”¨æ¥å£åå®ä¾‹åŒ–çš„è¿‡ç¨‹åˆ™æ°å¥½åè¿‡æ¥äº†ï¼Œå…ˆå®ä¾‹åŒ–åº•å±‚ä»£ç éœ€è¦ç”¨åˆ°é‚®ä»¶å°±å…ˆå®ä¾‹åŒ–Emailç±»ï¼Œå†å®ä¾‹åŒ–ä¸Šå±‚Registerç±»ã€‚è¿™å°±æ˜¯æ§åˆ¶åè½¬ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¾è€Œæ˜“è§ï¼Œæé«˜äº†ä»£ç çš„çµæ´»åº¦ï¼Œæ¾å¼€äº†ç»„ä»¶é—´çš„è€¦åˆåº¦ã€‚</strong></p>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ä¾èµ–æ³¨å…¥</tag>
      
      <tag>DI</tag>
      
      <tag>IOC</tag>
      
      <tag>æ§åˆ¶åè½¬</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>composer.lockæ–‡ä»¶çš„ä½œç”¨</title>
    <link href="/2019/03/12/composer-lock%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%9C%E7%94%A8/"/>
    <url>/2019/03/12/composer-lock%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%9C%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<p><strong>ä½¿ç”¨composerç®¡ç†å™¨æ—¶é™¤äº†composer.jsonæ–‡ä»¶å¤– è¿˜æœ‰ä¸€ä¸ªcomposer.lockæ–‡ä»¶ä¹Ÿéå¸¸é‡è¦</strong> composer install å‘½ä»¤ä»å½“å‰ç›®å½•è¯»å– composer.json æ–‡ä»¶ï¼Œå¤„ç†ä¾èµ–å…³ç³»ï¼Œå¹¶æŠŠä¾èµ–å®‰è£…åˆ° vendor ç›®å½•ä¸‹ã€‚ å¦‚æœå½“å‰ç›®å½•ä¸‹å­˜åœ¨ composer.lock æ–‡ä»¶ï¼Œå®ƒä¼šä»æ­¤æ–‡ä»¶è¯»å–ä¾èµ–ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯æ ¹æ® composer.json æ–‡ä»¶å»è·å–ä¾èµ–ã€‚è¿™ç¡®ä¿äº†è¯¥åº“çš„æ¯ä¸ªä½¿ç”¨è€…éƒ½èƒ½å¾—åˆ°ç›¸åŒçš„ä¾èµ–ç‰ˆæœ¬ã€‚ å¦‚æœæ²¡æœ‰ composer.lock æ–‡ä»¶ï¼Œcomposer å°†åœ¨å¤„ç†å®Œä¾èµ–å…³ç³»ååˆ›å»ºå®ƒã€‚ ä¸ºäº†è·å–ä¾èµ–çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶ä¸”å‡çº§ composer.lock æ–‡ä»¶ï¼Œä½ åº”è¯¥ä½¿ç”¨ composer update å‘½ä»¤ã€‚ åœ¨å›¢é˜ŸååŒå¼€å‘æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å°†composer.lockæ–‡ä»¶åŠ å…¥ç‰ˆæœ¬æ§åˆ¶ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ‰€æœ‰å›¢é˜Ÿäººå‘˜phpç»„ä»¶ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œé¿å…åœ¨å¼€å‘ä¸­é‡åˆ°ä¸å¿…è¦çš„éº»çƒ¦ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>composer</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTTP/2</title>
    <link href="/2019/03/06/http-2/"/>
    <url>/2019/03/06/http-2/</url>
    
    <content type="html"><![CDATA[<p><strong>#1 HTTP2</strong></p><p><img src="http://p1.pstatp.com/large/pgc-image/15254174738146085162958" alt="æ¶æ„å¸ˆè°ˆåŸºäºHTTP2æ¨é€æ¶ˆæ¯åˆ°APNs"></p><p>HTTP1.0æœ€æ—©åœ¨ç½‘é¡µä¸­ä½¿ç”¨æ˜¯åœ¨1996å¹´ï¼Œé‚£ä¸ªæ—¶å€™åªæ˜¯ä½¿ç”¨ä¸€äº›è¾ƒä¸ºç®€å•çš„ç½‘é¡µä¸Šå’Œç½‘ç»œè¯·æ±‚ä¸Šï¼Œè€ŒHTTP1.1åˆ™åœ¨1999å¹´æ‰å¼€å§‹å¹¿æ³›åº”ç”¨äºç°åœ¨çš„å„å¤§æµè§ˆå™¨ç½‘ç»œè¯·æ±‚ä¸­ï¼ŒåŒæ—¶HTTP1.1ä¹Ÿæ˜¯å½“å‰ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„HTTPåè®®ã€‚</p><p>åœ¨ HTTP/1.0 çš„æ—¶å€™ï¼Œclientæ¯è¯·æ±‚ä¸€é¡¹èµ„æºï¼Œéƒ½å¿…é¡»å…ˆå»ºç«‹ä¸€æ¬¡ TCP è¿çº¿ï¼Œè€Œåœ¨ client æ”¶åˆ° server çš„ responseåï¼Œä¾¿ä¼šæ–­å¼€TCPè¿çº¿ã€‚è€Œåœ¨ HTTP/1.1 çš„æ—¶ä»£ï¼Œå…è®¸åŒåŸŸåä¸‹çš„èµ„æº request and response åï¼Œæ‰æ–­å¼€ TCP è¿çº¿ã€‚</p><p><img src="http://p1.pstatp.com/large/pgc-image/1525417473947b700cac46d" alt="æ¶æ„å¸ˆè°ˆåŸºäºHTTP2æ¨é€æ¶ˆæ¯åˆ°APNs"></p><p>HTTP2 æ˜¯ HTTP/1.1 åçš„ä¸€æ¬¡é‡å¤§çš„æ”¹è¿›ï¼Œåœ¨åè®®å±‚é¢æ”¹å–„äº†ä»¥ä¸Šé—®é¢˜ï¼Œå‡å°‘èµ„æºå ç”¨ï¼Œæ¥ï¼Œç›´æ¥æ„Ÿå—ä¸€ä¸‹å·®å¼‚ï¼š</p><p>HTTP/2 is the future of the Web, and it is here!</p><p>è¿™æ˜¯ Akamai å…¬å¸å»ºç«‹çš„ä¸€ä¸ªå®˜æ–¹çš„æ¼”ç¤ºï¼Œç”¨ä»¥è¯´æ˜ HTTP/2 ç›¸æ¯”äºä¹‹å‰çš„ HTTP/1.1 åœ¨æ€§èƒ½ä¸Šçš„å¤§å¹…åº¦æå‡ã€‚ åŒæ—¶è¯·æ±‚ 379 å¼ å›¾ç‰‡ï¼Œä»Load time çš„å¯¹æ¯”å¯ä»¥çœ‹å‡º HTTP/2 åœ¨é€Ÿåº¦ä¸Šçš„ä¼˜åŠ¿ã€‚</p><p><img src="http://p9.pstatp.com/large/pgc-image/1525417473899180e242782" alt="æ¶æ„å¸ˆè°ˆåŸºäºHTTP2æ¨é€æ¶ˆæ¯åˆ°APNs"></p><p>HTTP/2 æºè‡ª SPDY/2ã€‚SPDY ç³»åˆ—åè®®ç”±è°·æ­Œå¼€å‘ï¼Œäº 2009 å¹´å…¬å¼€ã€‚å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯é™ä½ 50% çš„é¡µé¢åŠ è½½æ—¶é—´ã€‚å½“ä¸‹å¾ˆå¤šè‘—åçš„äº’è”ç½‘å…¬å¸éƒ½åœ¨è‡ªå·±çš„ç½‘ç«™æˆ– APP ä¸­é‡‡ç”¨äº† SPDY ç³»åˆ—åè®®ï¼ˆå½“å‰æœ€æ–°ç‰ˆæœ¬æ˜¯ SPDY/3.1ï¼‰ï¼Œå› ä¸ºå®ƒå¯¹æ€§èƒ½çš„æå‡æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚ä¸»æµçš„æµè§ˆå™¨ï¼ˆè°·æ­Œã€ç«ç‹ã€Operaï¼‰ä¹Ÿéƒ½æ—©å·²ç»æ”¯æŒ SPDYï¼Œå®ƒå·²ç»æˆä¸ºäº†å·¥ä¸šæ ‡å‡†ï¼ŒHTTP Working-Group æœ€ç»ˆå†³å®šä»¥ SPDY/2 ä¸ºåŸºç¡€ï¼Œå¼€å‘ HTTP/2ã€‚HTTP/2 æ ‡å‡†äº2015å¹´5æœˆä»¥ RFC 7540 æ­£å¼å‘è¡¨ã€‚</p><p>HTTP/2 çš„5ä¸ªç‰¹è‰²ï¼š</p><p><strong>Binary Framing Layer</strong></p><p>HTTP/2 é‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼ä¼ è¾“æ•°æ®ï¼Œè€Œé HTTP/1.x çš„æ–‡æœ¬æ ¼å¼ã€‚</p><p><img src="http://p1.pstatp.com/large/pgc-image/152541747386539f2fabf67" alt="æ¶æ„å¸ˆè°ˆåŸºäºHTTP2æ¨é€æ¶ˆæ¯åˆ°APNs"></p><p>åœ¨ HTTP/1.X ç”± OSI model ä¸­çš„ Application Layerï¼Œå­˜åœ¨ç€ Binary Framing Layerï¼Œè®°å½•ç€ HTTP çš„å†…å®¹åƒ HEADER ä¸­çš„ methodã€contentã€message ç­‰å†…å®¹ï¼Œä»¥åŠ Data éƒ¨åˆ†ã€‚</p><p><img src="http://p3.pstatp.com/large/pgc-image/1525417473882912fa06f4f" alt="æ¶æ„å¸ˆè°ˆåŸºäºHTTP2æ¨é€æ¶ˆæ¯åˆ°APNs"></p><p>Frame çš„åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š</p><p><img src="http://p9.pstatp.com/large/pgc-image/1525417473846a70f8c5365" alt="æ¶æ„å¸ˆè°ˆåŸºäºHTTP2æ¨é€æ¶ˆæ¯åˆ°APNs"></p><p>ä¸€ä¸ªåŸºç¡€çš„ Stream ç”± HEADER frame ä¸ Data frame ç»„æˆã€‚(å…±æœ‰10ç§ frame)</p><p>è€Œæ¯æ¬¡çš„ connection å¯ä»¥ä¹˜è½½ç€ä»»æ„æ•°é‡çš„ streamã€‚</p><p><img src="http://p1.pstatp.com/large/pgc-image/152541747387724cdd3737f" alt="æ¶æ„å¸ˆè°ˆåŸºäºHTTP2æ¨é€æ¶ˆæ¯åˆ°APNs"></p><p>å¯ä»¥ç”¨ chrome å†…éƒ¨è‡ªå¸¦çš„å·¥å…·ï¼ˆchrome://net-internals/ï¼‰æŸ¥çœ‹ HTTP2 æµé‡ï¼Œä½†è¿™ä¸ªåŒ…ä¿¡æ¯é‡æ¯”è¾ƒå°‘ï¼Œç»“æ„ä¸å¦‚æˆ‘ä»¬ç†Ÿæ‚‰çš„ Fiddler or Wireshark æ¸…æ™°ã€‚</p><p>ç”¨ wireshark æŠ“åŒ…ï¼š</p><p><img src="http://p3.pstatp.com/large/pgc-image/152541747392846d2dc37aa" alt="æ¶æ„å¸ˆè°ˆåŸºäºHTTP2æ¨é€æ¶ˆæ¯åˆ°APNs"></p><p>ä¸€ä¸ªåŒ…å†…æœ‰å¤šä¸ªä¸åŒçš„ Steam ID</p><p><img src="http://p1.pstatp.com/large/pgc-image/15254174738973d65032c4c" alt="æ¶æ„å¸ˆè°ˆåŸºäºHTTP2æ¨é€æ¶ˆæ¯åˆ°APNs"></p><p><strong>Multiplexing</strong></p><p>Multiplexing å…è®¸å•ä¸€çš„ tcp æœ‰å¤šé‡è¯·æ±‚/å›åº”ï¼Œä¹Ÿå°±æ˜¯è¯´ client å’Œ server å¯ä»¥å°† http è¯·æ±‚/å›åº”åˆ†è§£æˆä¸è—•åˆçš„ frameï¼Œç„¶åéšæœºå‘é€ï¼Œæœ€ååœ¨å¦ä¸€ç«¯æ ¹æ® stream ID å°† freame ç»„åˆèµ·æ¥ã€‚</p><p><img src="http://p1.pstatp.com/large/pgc-image/152541747385933b6e160fc" alt="æ¶æ„å¸ˆè°ˆåŸºäºHTTP2æ¨é€æ¶ˆæ¯åˆ°APNs"></p><p><strong>Request Prioritization</strong></p><p>åœ¨ HTTP/2 ä¸­ï¼Œstream æœ‰è‘— priority çš„å±æ€§ï¼Œè€Œè—‰ç”± Priorty frameï¼Œä¾¿å¯ä»¥å»ºç«‹èµ· priority treeã€‚</p><p><img src="http://p3.pstatp.com/large/pgc-image/1525417473905cafa2f0b76" alt="æ¶æ„å¸ˆè°ˆåŸºäºHTTP2æ¨é€æ¶ˆæ¯åˆ°APNs"></p><p><strong>Header Compression</strong></p><p>åœ¨ client å’Œ server ä¸ªç»´æŠ¤ä¸€ä¸ª HPACKï¼Œæ¡ç”¨ hash çš„æ–¹å¼æ¥è®°å½• HEADER çš„å†…å®¹ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ client è¦è¯·æ±‚èµ„æºå‰ä¼šå…ˆå» HPACK æŸ¥æ‰¾ç¼ºå¤±çš„èµ„æºï¼Œæ¥è‘—è¯·æ±‚ç¼ºå°‘çš„èµ„æºã€‚</p><p><img src="http://p1.pstatp.com/large/pgc-image/1525417473887ce96d4e76b" alt="æ¶æ„å¸ˆè°ˆåŸºäºHTTP2æ¨é€æ¶ˆæ¯åˆ°APNs"></p><p><strong>Server Push</strong></p><p>åœ¨ Binary Framing Layer æè¿‡ï¼Œframe å…±æœ‰10ç§ã€‚åœ¨è¿™è£¡ä¼šåˆ©ç”¨ PUSH_PROMISE çš„frameï¼Œå®ƒç”¨äº server ä¸»åŠ¨å‘é€èµ„æºç»™ clientã€‚</p><p><img src="http://p1.pstatp.com/large/pgc-image/1525417473894999f15dbf0" alt="æ¶æ„å¸ˆè°ˆåŸºäºHTTP2æ¨é€æ¶ˆæ¯åˆ°APNs"></p>]]></content>
    
    
    <categories>
      
      <category>ç½‘ç»œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HTTP2</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>php é«˜å¹¶å‘å¤„ç†</title>
    <link href="/2019/02/26/php-%E9%AB%98%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86/"/>
    <url>/2019/02/26/php-%E9%AB%98%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86/</url>
    
    <content type="html"><![CDATA[<p>è½¬ï¼š<a href="https://www.cnblogs.com/walblog/articles/8476579.html" title="https://www.cnblogs.com/walblog/articles/8476579.html">https://www.cnblogs.com/walblog/articles/8476579.html</a></p><p>æˆ‘ä»¬é€šå¸¸è¡¡é‡ä¸€ä¸ªWebç³»ç»Ÿçš„ååç‡çš„æŒ‡æ ‡æ˜¯QPSï¼ˆQuery Per Secondï¼Œæ¯ç§’å¤„ç†è¯·æ±‚æ•°ï¼‰ï¼Œè§£å†³æ¯ç§’æ•°ä¸‡æ¬¡çš„é«˜å¹¶å‘åœºæ™¯ï¼Œè¿™ä¸ªæŒ‡æ ‡éå¸¸å…³é”®ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å‡è®¾å¤„ç†ä¸€ä¸ªä¸šåŠ¡è¯·æ±‚å¹³å‡å“åº”æ—¶é—´ä¸º100msï¼ŒåŒæ—¶ï¼Œç³»ç»Ÿå†…æœ‰20å°Apacheçš„WebæœåŠ¡å™¨ï¼Œé…ç½®MaxClientsä¸º500ä¸ªï¼ˆè¡¨ç¤ºApacheçš„æœ€å¤§è¿æ¥æ•°ç›®ï¼‰ã€‚ é‚£ä¹ˆï¼Œæˆ‘ä»¬çš„Webç³»ç»Ÿçš„ç†è®ºå³°å€¼QPSä¸ºï¼ˆç†æƒ³åŒ–çš„è®¡ç®—æ–¹å¼ï¼‰ï¼š 20*500/0.1 = 100000 ï¼ˆ10ä¸‡QPSï¼‰ å’¦ï¼Ÿæˆ‘ä»¬çš„ç³»ç»Ÿä¼¼ä¹å¾ˆå¼ºå¤§ï¼Œ1ç§’é’Ÿå¯ä»¥å¤„ç†å®Œ10ä¸‡çš„è¯·æ±‚ï¼Œ5w/sçš„ç§’æ€ä¼¼ä¹æ˜¯â€œçº¸è€è™â€å“ˆã€‚å®é™…æƒ…å†µï¼Œå½“ç„¶æ²¡æœ‰è¿™ä¹ˆç†æƒ³ã€‚åœ¨é«˜å¹¶å‘çš„å®é™…åœºæ™¯ä¸‹ï¼Œæœºå™¨éƒ½å¤„äºé«˜è´Ÿè½½çš„çŠ¶æ€ï¼Œåœ¨è¿™ä¸ªæ—¶å€™å¹³å‡å“åº”æ—¶é—´ä¼šè¢«å¤§å¤§å¢åŠ ã€‚ æ™®é€šçš„ä¸€ä¸ªp4çš„æœåŠ¡å™¨æ¯å¤©æœ€å¤šèƒ½æ”¯æŒå¤§çº¦10ä¸‡å·¦å³çš„IPï¼Œå¦‚æœè®¿é—®é‡è¶…è¿‡10Wé‚£ä¹ˆéœ€è¦ä¸“ç”¨çš„æœåŠ¡å™¨æ‰èƒ½è§£å†³ï¼Œå¦‚æœç¡¬ä»¶ä¸ç»™åŠ› è½¯ä»¶æ€ä¹ˆä¼˜åŒ–éƒ½æ˜¯äºäº‹æ— è¡¥çš„ã€‚ä¸»è¦å½±å“æœåŠ¡å™¨çš„é€Ÿåº¦ æœ‰ï¼šç½‘ç»œ-ç¡¬ç›˜è¯»å†™é€Ÿåº¦-å†…å­˜å¤§å°-cpuå¤„ç†é€Ÿåº¦ã€‚ å°±WebæœåŠ¡å™¨è€Œè¨€ï¼ŒApacheæ‰“å¼€äº†è¶Šå¤šçš„è¿æ¥è¿›ç¨‹ï¼ŒCPUéœ€è¦å¤„ç†çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¹Ÿè¶Šå¤šï¼Œé¢å¤–å¢åŠ äº†CPUçš„æ¶ˆè€—ï¼Œç„¶åå°±ç›´æ¥å¯¼è‡´å¹³å‡å“åº”æ—¶é—´å¢åŠ ã€‚å› æ­¤ä¸Šè¿°çš„MaxClientæ•°ç›®ï¼Œè¦æ ¹æ®CPUã€å†…å­˜ç­‰ç¡¬ä»¶å› ç´ ç»¼åˆè€ƒè™‘ï¼Œç»å¯¹ä¸æ˜¯è¶Šå¤šè¶Šå¥½ã€‚å¯ä»¥é€šè¿‡Apacheè‡ªå¸¦çš„abenchæ¥æµ‹è¯•ä¸€ä¸‹ï¼Œå–ä¸€ä¸ªåˆé€‚çš„å€¼ã€‚ç„¶åï¼Œæˆ‘ä»¬é€‰æ‹©å†…å­˜æ“ä½œçº§åˆ«çš„å­˜å‚¨çš„Redisï¼Œåœ¨é«˜å¹¶å‘çš„çŠ¶æ€ä¸‹ï¼Œå­˜å‚¨çš„å“åº”æ—¶é—´è‡³å…³é‡è¦ã€‚ç½‘ç»œå¸¦å®½è™½ç„¶ä¹Ÿæ˜¯ä¸€ä¸ªå› ç´ ï¼Œä¸è¿‡ï¼Œè¿™ç§è¯·æ±‚æ•°æ®åŒ…ä¸€èˆ¬æ¯”è¾ƒå°ï¼Œä¸€èˆ¬å¾ˆå°‘æˆä¸ºè¯·æ±‚çš„ç“¶é¢ˆã€‚è´Ÿè½½å‡è¡¡æˆä¸ºç³»ç»Ÿç“¶é¢ˆçš„æƒ…å†µæ¯”è¾ƒå°‘ï¼Œåœ¨è¿™é‡Œä¸åšè®¨è®ºå“ˆã€‚ é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå‡è®¾æˆ‘ä»¬çš„ç³»ç»Ÿï¼Œåœ¨5w/sçš„é«˜å¹¶å‘çŠ¶æ€ä¸‹ï¼Œå¹³å‡å“åº”æ—¶é—´ä»100mså˜ä¸º250msï¼ˆå®é™…æƒ…å†µï¼Œç”šè‡³æ›´å¤šï¼‰ï¼š 20*500/0.25 = 40000 ï¼ˆ4ä¸‡QPSï¼‰ äºæ˜¯ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿå‰©ä¸‹äº†4wçš„QPSï¼Œé¢å¯¹5wæ¯ç§’çš„è¯·æ±‚ï¼Œä¸­é—´ç›¸å·®äº†1wã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œé«˜é€Ÿè·¯å£ï¼Œ1ç§’é’Ÿæ¥5éƒ¨è½¦ï¼Œæ¯ç§’é€šè¿‡5éƒ¨è½¦ï¼Œé«˜é€Ÿè·¯å£è¿ä½œæ­£å¸¸ã€‚çªç„¶ï¼Œè¿™ä¸ªè·¯å£1ç§’é’Ÿåªèƒ½é€šè¿‡4éƒ¨è½¦ï¼Œè½¦æµé‡ä»ç„¶ä¾æ—§ï¼Œç»“æœå¿…å®šå‡ºç°å¤§å¡è½¦ã€‚ï¼ˆ5æ¡è½¦é“å¿½ç„¶å˜æˆ4æ¡è½¦é“çš„æ„Ÿè§‰ï¼‰ åŒç†ï¼ŒæŸä¸€ä¸ªç§’å†…ï¼Œ20*500ä¸ªå¯ç”¨è¿æ¥è¿›ç¨‹éƒ½åœ¨æ»¡è´Ÿè·å·¥ä½œä¸­ï¼Œå´ä»ç„¶æœ‰1ä¸‡ä¸ªæ–°æ¥è¯·æ±‚ï¼Œæ²¡æœ‰è¿æ¥è¿›ç¨‹å¯ç”¨ï¼Œç³»ç»Ÿé™·å…¥åˆ°å¼‚å¸¸çŠ¶æ€ä¹Ÿæ˜¯é¢„æœŸä¹‹å†…ã€‚ <img src="http://img.php.cn//upload/image/146/269/839/1485234211796818.jpg" alt="14834077821.jpg" title="1485234211796818.jpg"> å…¶å®åœ¨æ­£å¸¸çš„éé«˜å¹¶å‘çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œä¹Ÿæœ‰ç±»ä¼¼çš„æƒ…å†µå‡ºç°ï¼ŒæŸä¸ªä¸šåŠ¡è¯·æ±‚æ¥å£å‡ºç°é—®é¢˜ï¼Œå“åº”æ—¶é—´ææ…¢ï¼Œå°†æ•´ä¸ªWebè¯·æ±‚å“åº”æ—¶é—´æ‹‰å¾—å¾ˆé•¿ï¼Œé€æ¸å°†WebæœåŠ¡å™¨çš„å¯ç”¨è¿æ¥æ•°å æ»¡ï¼Œå…¶ä»–æ­£å¸¸çš„ä¸šåŠ¡è¯·æ±‚ï¼Œæ— è¿æ¥è¿›ç¨‹å¯ç”¨ã€‚ æ›´å¯æ€•çš„é—®é¢˜æ˜¯ï¼Œæ˜¯ç”¨æˆ·çš„è¡Œä¸ºç‰¹ç‚¹ï¼Œç³»ç»Ÿè¶Šæ˜¯ä¸å¯ç”¨ï¼Œç”¨æˆ·çš„ç‚¹å‡»è¶Šé¢‘ç¹ï¼Œæ¶æ€§å¾ªç¯æœ€ç»ˆå¯¼è‡´â€œé›ªå´©â€ï¼ˆå…¶ä¸­ä¸€å°Webæœºå™¨æŒ‚äº†ï¼Œå¯¼è‡´æµé‡åˆ†æ•£åˆ°å…¶ä»–æ­£å¸¸å·¥ä½œçš„æœºå™¨ä¸Šï¼Œå†å¯¼è‡´æ­£å¸¸çš„æœºå™¨ä¹ŸæŒ‚ï¼Œç„¶åæ¶æ€§å¾ªç¯ï¼‰ï¼Œå°†æ•´ä¸ªWebç³»ç»Ÿæ‹–å®ã€‚</p><ol start="3"><li>é‡å¯ä¸è¿‡è½½ä¿æŠ¤</li></ol><p>å¦‚æœç³»ç»Ÿå‘ç”Ÿâ€œé›ªå´©â€ï¼Œè´¸ç„¶é‡å¯æœåŠ¡ï¼Œæ˜¯æ— æ³•è§£å†³é—®é¢˜çš„ã€‚æœ€å¸¸è§çš„ç°è±¡æ˜¯ï¼Œå¯åŠ¨èµ·æ¥åï¼Œç«‹åˆ»æŒ‚æ‰ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæœ€å¥½åœ¨å…¥å£å±‚å°†æµé‡æ‹’ç»ï¼Œç„¶åå†å°†é‡å¯ã€‚å¦‚æœæ˜¯redis/memcacheè¿™ç§æœåŠ¡ä¹ŸæŒ‚äº†ï¼Œé‡å¯çš„æ—¶å€™éœ€è¦æ³¨æ„â€œé¢„çƒ­â€ï¼Œå¹¶ä¸”å¾ˆå¯èƒ½éœ€è¦æ¯”è¾ƒé•¿çš„æ—¶é—´ã€‚ ç§’æ€å’ŒæŠ¢è´­çš„åœºæ™¯ï¼Œæµé‡å¾€å¾€æ˜¯è¶…ä¹æˆ‘ä»¬ç³»ç»Ÿçš„å‡†å¤‡å’Œæƒ³è±¡çš„ã€‚è¿™ä¸ªæ—¶å€™ï¼Œè¿‡è½½ä¿æŠ¤æ˜¯å¿…è¦çš„ã€‚å¦‚æœæ£€æµ‹åˆ°ç³»ç»Ÿæ»¡è´Ÿè½½çŠ¶æ€ï¼Œæ‹’ç»è¯·æ±‚ä¹Ÿæ˜¯ä¸€ç§ä¿æŠ¤æªæ–½ã€‚åœ¨å‰ç«¯è®¾ç½®è¿‡æ»¤æ˜¯æœ€ç®€å•çš„æ–¹å¼ï¼Œä½†æ˜¯ï¼Œè¿™ç§åšæ³•æ˜¯è¢«ç”¨æˆ·â€œåƒå¤«æ‰€æŒ‡â€çš„è¡Œä¸ºã€‚æ›´åˆé€‚ä¸€ç‚¹çš„æ˜¯ï¼Œå°†è¿‡è½½ä¿æŠ¤è®¾ç½®åœ¨CGIå…¥å£å±‚ï¼Œå¿«é€Ÿå°†å®¢æˆ·çš„ç›´æ¥è¯·æ±‚è¿”å› é«˜å¹¶å‘ä¸‹çš„æ•°æ®å®‰å…¨ æˆ‘ä»¬çŸ¥é“åœ¨å¤šçº¿ç¨‹å†™å…¥åŒä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œä¼šå­˜ç°â€œçº¿ç¨‹å®‰å…¨â€çš„é—®é¢˜ï¼ˆå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡ŒåŒä¸€æ®µä»£ç ï¼Œå¦‚æœæ¯æ¬¡è¿è¡Œç»“æœå’Œå•çº¿ç¨‹è¿è¡Œçš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œç»“æœå’Œé¢„æœŸç›¸åŒï¼Œå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼‰ã€‚å¦‚æœæ˜¯MySQLæ•°æ®åº“ï¼Œå¯ä»¥ä½¿ç”¨å®ƒè‡ªå¸¦çš„é”æœºåˆ¶å¾ˆå¥½çš„è§£å†³é—®é¢˜ï¼Œä½†æ˜¯ï¼Œåœ¨å¤§è§„æ¨¡å¹¶å‘çš„åœºæ™¯ä¸­ï¼Œæ˜¯ä¸æ¨èä½¿ç”¨MySQLçš„ã€‚ç§’æ€å’ŒæŠ¢è´­çš„åœºæ™¯ä¸­ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯â€œè¶…å‘â€ï¼Œå¦‚æœåœ¨è¿™æ–¹é¢æ§åˆ¶ä¸æ…ï¼Œä¼šäº§ç”Ÿå‘é€è¿‡å¤šçš„æƒ…å†µã€‚æˆ‘ä»¬ä¹Ÿæ›¾ç»å¬è¯´è¿‡ï¼ŒæŸäº›ç”µå•†ææŠ¢è´­æ´»åŠ¨ï¼Œä¹°å®¶æˆåŠŸæ‹ä¸‹åï¼Œå•†å®¶å´ä¸æ‰¿è®¤è®¢å•æœ‰æ•ˆï¼Œæ‹’ç»å‘è´§ã€‚è¿™é‡Œçš„é—®é¢˜ï¼Œä¹Ÿè®¸å¹¶ä¸ä¸€å®šæ˜¯å•†å®¶å¥¸è¯ˆï¼Œè€Œæ˜¯ç³»ç»ŸæŠ€æœ¯å±‚é¢å­˜åœ¨è¶…å‘é£é™©å¯¼è‡´çš„ã€‚</p><ol><li>è¶…å‘çš„åŸå› </li></ol><p>å‡è®¾æŸä¸ªæŠ¢è´­åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¸€å…±åªæœ‰100ä¸ªå•†å“ï¼Œåœ¨æœ€åä¸€åˆ»ï¼Œæˆ‘ä»¬å·²ç»æ¶ˆè€—äº†99ä¸ªå•†å“ï¼Œä»…å‰©æœ€åä¸€ä¸ªã€‚è¿™ä¸ªæ—¶å€™ï¼Œç³»ç»Ÿå‘æ¥å¤šä¸ªå¹¶å‘è¯·æ±‚ï¼Œè¿™æ‰¹è¯·æ±‚è¯»å–åˆ°çš„å•†å“ä½™é‡éƒ½æ˜¯99ä¸ªï¼Œç„¶åéƒ½é€šè¿‡äº†è¿™ä¸€ä¸ªä½™é‡åˆ¤æ–­ï¼Œæœ€ç»ˆå¯¼è‡´è¶…å‘ã€‚ï¼ˆåŒæ–‡ç« å‰é¢è¯´çš„åœºæ™¯ï¼‰ <img src="http://img.php.cn//upload/image/398/176/480/1485234279277458.jpg" alt="14834077822.jpg" title="1485234279277458.jpg"> åœ¨ä¸Šé¢çš„è¿™ä¸ªå›¾ä¸­ï¼Œå°±å¯¼è‡´äº†å¹¶å‘ç”¨æˆ·Bä¹Ÿâ€œæŠ¢è´­æˆåŠŸâ€ï¼Œå¤šè®©ä¸€ä¸ªäººè·å¾—äº†å•†å“ã€‚è¿™ç§åœºæ™¯ï¼Œåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹éå¸¸å®¹æ˜“å‡ºç°ã€‚ ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šå°†åº“å­˜å­—æ®µnumberå­—æ®µè®¾ä¸ºunsignedï¼Œå½“åº“å­˜ä¸º0æ—¶ï¼Œå› ä¸ºå­—æ®µä¸èƒ½ä¸ºè´Ÿæ•°ï¼Œå°†ä¼šè¿”å›false</p><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-comment">//ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šå°†åº“å­˜å­—æ®µnumberå­—æ®µè®¾ä¸ºunsignedï¼Œå½“åº“å­˜ä¸º0æ—¶ï¼Œå› ä¸ºå­—æ®µä¸èƒ½ä¸ºè´Ÿæ•°ï¼Œå°†ä¼šè¿”å›false</span><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;./mysql.php&#x27;</span>);$username = <span class="hljs-string">&#x27;wang&#x27;</span>.rand(<span class="hljs-number">0</span>,<span class="hljs-number">1000</span>);<span class="hljs-comment">//ç”Ÿæˆå”¯ä¸€è®¢å•</span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">build_order_no</span>(<span class="hljs-params"></span>)</span>&#123;  <span class="hljs-keyword">return</span> date(<span class="hljs-string">&#x27;ymd&#x27;</span>).substr(implode(<span class="hljs-literal">NULL</span>, array_map(<span class="hljs-string">&#x27;ord&#x27;</span>, str_split(substr(uniqid(), <span class="hljs-number">7</span>, <span class="hljs-number">13</span>), <span class="hljs-number">1</span>))), <span class="hljs-number">0</span>, <span class="hljs-number">8</span>);&#125;<span class="hljs-comment">//è®°å½•æ—¥å¿—</span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">insertLog</span>(<span class="hljs-params">$event,$type=<span class="hljs-number">0</span>,$username</span>)</span>&#123;    <span class="hljs-keyword">global</span> $conn;    $sql=<span class="hljs-string">&quot;insert into ih_log(event,type,usernma)</span><span class="hljs-string">    values(&#x27;$event&#x27;,&#x27;$type&#x27;,&#x27;$username&#x27;)&quot;</span>;    <span class="hljs-keyword">return</span> mysqli_query($conn,$sql);&#125;<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">insertOrder</span>(<span class="hljs-params">$order_sn,$user_id,$goods_id,$sku_id,$price,$username,$number</span>)</span><span class="hljs-function"></span>&#123;      <span class="hljs-keyword">global</span> $conn;      $sql=<span class="hljs-string">&quot;insert into ih_order(order_sn,user_id,goods_id,sku_id,price,username,number)</span><span class="hljs-string">      values(&#x27;$order_sn&#x27;,&#x27;$user_id&#x27;,&#x27;$goods_id&#x27;,&#x27;$sku_id&#x27;,&#x27;$price&#x27;,&#x27;$username&#x27;,&#x27;$number&#x27;)&quot;</span>;     <span class="hljs-keyword">return</span>  mysqli_query($conn,$sql);&#125;<span class="hljs-comment">//æ¨¡æ‹Ÿä¸‹å•æ“ä½œ</span><span class="hljs-comment">//åº“å­˜æ˜¯å¦å¤§äº0</span>$sql=<span class="hljs-string">&quot;select number from ih_store where goods_id=&#x27;$goods_id&#x27; and sku_id=&#x27;$sku_id&#x27; &quot;</span>;$rs=mysqli_query($conn,$sql);$row = $rs-&gt;fetch_assoc();  <span class="hljs-keyword">if</span>($row[<span class="hljs-string">&#x27;number&#x27;</span>]&gt;<span class="hljs-number">0</span>)&#123;<span class="hljs-comment">//é«˜å¹¶å‘ä¸‹ä¼šå¯¼è‡´è¶…å–</span>      <span class="hljs-keyword">if</span>($row[<span class="hljs-string">&#x27;number&#x27;</span>]&lt;$number)&#123;        <span class="hljs-keyword">return</span> insertLog(<span class="hljs-string">&#x27;åº“å­˜ä¸å¤Ÿ&#x27;</span>,<span class="hljs-number">3</span>,$username);      &#125;      $order_sn=build_order_no();      <span class="hljs-comment">//åº“å­˜å‡å°‘</span>      $sql=<span class="hljs-string">&quot;update ih_store set number=number-&#123;$number&#125; where sku_id=&#x27;$sku_id&#x27; and number&gt;0&quot;</span>;      $store_rs=mysqli_query($conn,$sql);      <span class="hljs-keyword">if</span>($store_rs)&#123;          <span class="hljs-comment">//ç”Ÿæˆè®¢å•</span>          insertOrder($order_sn,$user_id,$goods_id,$sku_id,$price,$username,$number);          insertLog(<span class="hljs-string">&#x27;åº“å­˜å‡å°‘æˆåŠŸ&#x27;</span>,<span class="hljs-number">1</span>,$username);      &#125;<span class="hljs-keyword">else</span>&#123;          insertLog(<span class="hljs-string">&#x27;åº“å­˜å‡å°‘å¤±è´¥&#x27;</span>,<span class="hljs-number">2</span>,$username);      &#125;  &#125;<span class="hljs-keyword">else</span>&#123;      insertLog(<span class="hljs-string">&#x27;åº“å­˜ä¸å¤Ÿ&#x27;</span>,<span class="hljs-number">3</span>,$username);  &#125;<span class="hljs-meta">?&gt;</span></code></pre><ol start="2"><li>æ‚²è§‚é”æ€è·¯</li></ol><p>è§£å†³çº¿ç¨‹å®‰å…¨çš„æ€è·¯å¾ˆå¤šï¼Œå¯ä»¥ä»â€œæ‚²è§‚é”â€çš„æ–¹å‘å¼€å§‹è®¨è®ºã€‚ æ‚²è§‚é”ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¿®æ”¹æ•°æ®çš„æ—¶å€™ï¼Œé‡‡ç”¨é”å®šçŠ¶æ€ï¼Œæ’æ–¥å¤–éƒ¨è¯·æ±‚çš„ä¿®æ”¹ã€‚é‡åˆ°åŠ é”çš„çŠ¶æ€ï¼Œå°±å¿…é¡»ç­‰å¾…ã€‚ <img src="http://img.php.cn//upload/image/386/682/712/1485234326781590.jpg" alt="14834077833.jpg" title="1485234326781590.jpg"> è™½ç„¶ä¸Šè¿°çš„æ–¹æ¡ˆçš„ç¡®è§£å†³äº†çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ï¼Œä½†æ˜¯ï¼Œåˆ«å¿˜è®°ï¼Œæˆ‘ä»¬çš„åœºæ™¯æ˜¯â€œé«˜å¹¶å‘â€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¼šå¾ˆå¤šè¿™æ ·çš„ä¿®æ”¹è¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦ç­‰å¾…â€œé”â€ï¼ŒæŸäº›çº¿ç¨‹å¯èƒ½æ°¸è¿œéƒ½æ²¡æœ‰æœºä¼šæŠ¢åˆ°è¿™ä¸ªâ€œé”â€ï¼Œè¿™ç§è¯·æ±‚å°±ä¼šæ­»åœ¨é‚£é‡Œã€‚åŒæ—¶ï¼Œè¿™ç§è¯·æ±‚ä¼šå¾ˆå¤šï¼Œç¬é—´å¢å¤§ç³»ç»Ÿçš„å¹³å‡å“åº”æ—¶é—´ï¼Œç»“æœæ˜¯å¯ç”¨è¿æ¥æ•°è¢«è€—å°½ï¼Œç³»ç»Ÿé™·å…¥å¼‚å¸¸ã€‚ ä¼˜åŒ–æ–¹æ¡ˆ2ï¼šä½¿ç”¨MySQLçš„äº‹åŠ¡ï¼Œé”ä½æ“ä½œçš„è¡Œ</p><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-comment">//ä¼˜åŒ–æ–¹æ¡ˆ2ï¼šä½¿ç”¨MySQLçš„äº‹åŠ¡ï¼Œé”ä½æ“ä½œçš„è¡Œ</span><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;./mysql.php&#x27;</span>);<span class="hljs-comment">//ç”Ÿæˆå”¯ä¸€è®¢å•å·</span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">build_order_no</span>(<span class="hljs-params"></span>)</span>&#123;  <span class="hljs-keyword">return</span> date(<span class="hljs-string">&#x27;ymd&#x27;</span>).substr(implode(<span class="hljs-literal">NULL</span>, array_map(<span class="hljs-string">&#x27;ord&#x27;</span>, str_split(substr(uniqid(), <span class="hljs-number">7</span>, <span class="hljs-number">13</span>), <span class="hljs-number">1</span>))), <span class="hljs-number">0</span>, <span class="hljs-number">8</span>);&#125;<span class="hljs-comment">//è®°å½•æ—¥å¿—</span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">insertLog</span>(<span class="hljs-params">$event,$type=<span class="hljs-number">0</span></span>)</span>&#123;    <span class="hljs-keyword">global</span> $conn;    $sql=<span class="hljs-string">&quot;insert into ih_log(event,type)</span><span class="hljs-string">    values(&#x27;$event&#x27;,&#x27;$type&#x27;)&quot;</span>;    mysqli_query($conn,$sql);&#125;<span class="hljs-comment">//æ¨¡æ‹Ÿä¸‹å•æ“ä½œ</span><span class="hljs-comment">//åº“å­˜æ˜¯å¦å¤§äº0</span>mysqli_query($conn,<span class="hljs-string">&quot;BEGIN&quot;</span>);  <span class="hljs-comment">//å¼€å§‹äº‹åŠ¡</span>$sql=<span class="hljs-string">&quot;select number from ih_store where goods_id=&#x27;$goods_id&#x27; and sku_id=&#x27;$sku_id&#x27; FOR UPDATE&quot;</span>;<span class="hljs-comment">//æ­¤æ—¶è¿™æ¡è®°å½•è¢«é”ä½,å…¶å®ƒäº‹åŠ¡å¿…é¡»ç­‰å¾…æ­¤æ¬¡äº‹åŠ¡æäº¤åæ‰èƒ½æ‰§è¡Œ</span>$rs=mysqli_query($conn,$sql);$row=$rs-&gt;fetch_assoc();<span class="hljs-keyword">if</span>($row[<span class="hljs-string">&#x27;number&#x27;</span>]&gt;<span class="hljs-number">0</span>)&#123;    <span class="hljs-comment">//ç”Ÿæˆè®¢å•</span>    $order_sn=build_order_no();    $sql=<span class="hljs-string">&quot;insert into ih_order(order_sn,user_id,goods_id,sku_id,price)</span><span class="hljs-string">    values(&#x27;$order_sn&#x27;,&#x27;$user_id&#x27;,&#x27;$goods_id&#x27;,&#x27;$sku_id&#x27;,&#x27;$price&#x27;)&quot;</span>;    $order_rs=mysqli_query($conn,$sql);    <span class="hljs-comment">//åº“å­˜å‡å°‘</span>    $sql=<span class="hljs-string">&quot;update ih_store set number=number-&#123;$number&#125; where sku_id=&#x27;$sku_id&#x27;&quot;</span>;    $store_rs=mysqli_query($conn,$sql);    <span class="hljs-keyword">if</span>($store_rs)&#123;      <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;åº“å­˜å‡å°‘æˆåŠŸ&#x27;</span>;        insertLog(<span class="hljs-string">&#x27;åº“å­˜å‡å°‘æˆåŠŸ&#x27;</span>);        mysqli_query($conn,<span class="hljs-string">&quot;COMMIT&quot;</span>);<span class="hljs-comment">//äº‹åŠ¡æäº¤å³è§£é”</span>    &#125;<span class="hljs-keyword">else</span>&#123;      <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;åº“å­˜å‡å°‘å¤±è´¥&#x27;</span>;        insertLog(<span class="hljs-string">&#x27;åº“å­˜å‡å°‘å¤±è´¥&#x27;</span>);    &#125;&#125;<span class="hljs-keyword">else</span>&#123;  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;åº“å­˜ä¸å¤Ÿ&#x27;</span>;    insertLog(<span class="hljs-string">&#x27;åº“å­˜ä¸å¤Ÿ&#x27;</span>);    mysqli_query($conn,<span class="hljs-string">&quot;ROLLBACK&quot;</span>);&#125;<span class="hljs-meta">?&gt;</span></code></pre><ol start="3"><li>FIFOé˜Ÿåˆ—æ€è·¯</li></ol><p>é‚£å¥½ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„åœºæ™¯ï¼Œæˆ‘ä»¬ç›´æ¥å°†è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ä¸­çš„ï¼Œé‡‡ç”¨FIFOï¼ˆFirst Input First Outputï¼Œå…ˆè¿›å…ˆå‡ºï¼‰ï¼Œè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±ä¸ä¼šå¯¼è‡´æŸäº›è¯·æ±‚æ°¸è¿œè·å–ä¸åˆ°é”ã€‚çœ‹åˆ°è¿™é‡Œï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å¼ºè¡Œå°†å¤šçº¿ç¨‹å˜æˆå•çº¿ç¨‹çš„æ„Ÿè§‰å“ˆã€‚ <img src="http://img.php.cn//upload/image/744/620/541/1485234417677669.jpg" alt="14834077834.jpg" title="1485234417677669.jpg"> ç„¶åï¼Œæˆ‘ä»¬ç°åœ¨è§£å†³äº†é”çš„é—®é¢˜ï¼Œå…¨éƒ¨è¯·æ±‚é‡‡ç”¨â€œå…ˆè¿›å…ˆå‡ºâ€çš„é˜Ÿåˆ—æ–¹å¼æ¥å¤„ç†ã€‚é‚£ä¹ˆæ–°çš„é—®é¢˜æ¥äº†ï¼Œé«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œå› ä¸ºè¯·æ±‚å¾ˆå¤šï¼Œå¾ˆå¯èƒ½ä¸€ç¬é—´å°†é˜Ÿåˆ—å†…å­˜â€œæ’‘çˆ†â€ï¼Œç„¶åç³»ç»Ÿåˆé™·å…¥åˆ°äº†å¼‚å¸¸çŠ¶æ€ã€‚æˆ–è€…è®¾è®¡ä¸€ä¸ªæå¤§çš„å†…å­˜é˜Ÿåˆ—ï¼Œä¹Ÿæ˜¯ä¸€ç§æ–¹æ¡ˆï¼Œä½†æ˜¯ï¼Œç³»ç»Ÿå¤„ç†å®Œä¸€ä¸ªé˜Ÿåˆ—å†…è¯·æ±‚çš„é€Ÿåº¦æ ¹æœ¬æ— æ³•å’Œç–¯ç‹‚æ¶Œå…¥é˜Ÿåˆ—ä¸­çš„æ•°ç›®ç›¸æ¯”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé˜Ÿåˆ—å†…çš„è¯·æ±‚ä¼šè¶Šç§¯ç´¯è¶Šå¤šï¼Œæœ€ç»ˆWebç³»ç»Ÿå¹³å‡å“åº”æ—¶å€™è¿˜æ˜¯ä¼šå¤§å¹…ä¸‹é™ï¼Œç³»ç»Ÿè¿˜æ˜¯é™·å…¥å¼‚å¸¸ã€‚</p><ol start="4"><li>æ–‡ä»¶é”çš„æ€è·¯</li></ol><p>å¯¹äºæ—¥IPä¸é«˜æˆ–è€…è¯´å¹¶å‘æ•°ä¸æ˜¯å¾ˆå¤§çš„åº”ç”¨ï¼Œä¸€èˆ¬ä¸ç”¨è€ƒè™‘è¿™äº›ï¼ç”¨ä¸€èˆ¬çš„æ–‡ä»¶æ“ä½œæ–¹æ³•å®Œå…¨æ²¡æœ‰é—®é¢˜ã€‚ä½†å¦‚æœå¹¶å‘é«˜ï¼Œåœ¨æˆ‘ä»¬å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œå¾ˆæœ‰å¯èƒ½å¤šä¸ªè¿›ç¨‹å¯¹è¿›ä¸€æ–‡ä»¶è¿›è¡Œæ“ä½œï¼Œå¦‚æœè¿™æ—¶ä¸å¯¹æ–‡ä»¶çš„è®¿é—®è¿›è¡Œç›¸åº”çš„ç‹¬å ï¼Œå°±å®¹æ˜“é€ æˆæ•°æ®ä¸¢å¤± ä¼˜åŒ–æ–¹æ¡ˆ4ï¼šä½¿ç”¨éé˜»å¡çš„æ–‡ä»¶æ’ä»–é”</p><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-comment">//ä¼˜åŒ–æ–¹æ¡ˆ4ï¼šä½¿ç”¨éé˜»å¡çš„æ–‡ä»¶æ’ä»–é”</span><span class="hljs-keyword">include</span> (<span class="hljs-string">&#x27;./mysql.php&#x27;</span>);<span class="hljs-comment">//ç”Ÿæˆå”¯ä¸€è®¢å•å·</span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">build_order_no</span>(<span class="hljs-params"></span>)</span>&#123;  <span class="hljs-keyword">return</span> date(<span class="hljs-string">&#x27;ymd&#x27;</span>).substr(implode(<span class="hljs-literal">NULL</span>, array_map(<span class="hljs-string">&#x27;ord&#x27;</span>, str_split(substr(uniqid(), <span class="hljs-number">7</span>, <span class="hljs-number">13</span>), <span class="hljs-number">1</span>))), <span class="hljs-number">0</span>, <span class="hljs-number">8</span>);&#125;<span class="hljs-comment">//è®°å½•æ—¥å¿—</span><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">insertLog</span>(<span class="hljs-params">$event,$type=<span class="hljs-number">0</span></span>)</span>&#123;    <span class="hljs-keyword">global</span> $conn;    $sql=<span class="hljs-string">&quot;insert into ih_log(event,type)</span><span class="hljs-string">    values(&#x27;$event&#x27;,&#x27;$type&#x27;)&quot;</span>;    mysqli_query($conn,$sql);&#125;$fp = fopen(<span class="hljs-string">&quot;lock.txt&quot;</span>, <span class="hljs-string">&quot;w+&quot;</span>);<span class="hljs-keyword">if</span>(!flock($fp,LOCK_EX | LOCK_NB))&#123;    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•&quot;</span>;    <span class="hljs-keyword">return</span>;&#125;<span class="hljs-comment">//ä¸‹å•</span>$sql=<span class="hljs-string">&quot;select number from ih_store where goods_id=&#x27;$goods_id&#x27; and sku_id=&#x27;$sku_id&#x27;&quot;</span>;$rs =  mysqli_query($conn,$sql);$row = $rs-&gt;fetch_assoc();<span class="hljs-keyword">if</span>($row[<span class="hljs-string">&#x27;number&#x27;</span>]&gt;<span class="hljs-number">0</span>)&#123;<span class="hljs-comment">//åº“å­˜æ˜¯å¦å¤§äº0</span>    <span class="hljs-comment">//æ¨¡æ‹Ÿä¸‹å•æ“ä½œ</span>    $order_sn=build_order_no();    $sql=<span class="hljs-string">&quot;insert into ih_order(order_sn,user_id,goods_id,sku_id,price)</span><span class="hljs-string">    values(&#x27;$order_sn&#x27;,&#x27;$user_id&#x27;,&#x27;$goods_id&#x27;,&#x27;$sku_id&#x27;,&#x27;$price&#x27;)&quot;</span>;    $order_rs =  mysqli_query($conn,$sql);    <span class="hljs-comment">//åº“å­˜å‡å°‘</span>    $sql=<span class="hljs-string">&quot;update ih_store set number=number-&#123;$number&#125; where sku_id=&#x27;$sku_id&#x27;&quot;</span>;    $store_rs =  mysqli_query($conn,$sql);    <span class="hljs-keyword">if</span>($store_rs)&#123;      <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;åº“å­˜å‡å°‘æˆåŠŸ&#x27;</span>;        insertLog(<span class="hljs-string">&#x27;åº“å­˜å‡å°‘æˆåŠŸ&#x27;</span>);        flock($fp,LOCK_UN);<span class="hljs-comment">//é‡Šæ”¾é”</span>    &#125;<span class="hljs-keyword">else</span>&#123;      <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;åº“å­˜å‡å°‘å¤±è´¥&#x27;</span>;        insertLog(<span class="hljs-string">&#x27;åº“å­˜å‡å°‘å¤±è´¥&#x27;</span>);    &#125;&#125;<span class="hljs-keyword">else</span>&#123;  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;åº“å­˜ä¸å¤Ÿ&#x27;</span>;    insertLog(<span class="hljs-string">&#x27;åº“å­˜ä¸å¤Ÿ&#x27;</span>);&#125;fclose($fp); <span class="hljs-meta">?&gt;</span></code></pre><ol start="5"><li>ä¹è§‚é”æ€è·¯</li></ol><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¨è®ºä¸€ä¸‹â€œä¹è§‚é”â€çš„æ€è·¯äº†ã€‚ä¹è§‚é”ï¼Œæ˜¯ç›¸å¯¹äºâ€œæ‚²è§‚é”â€é‡‡ç”¨æ›´ä¸ºå®½æ¾çš„åŠ é”æœºåˆ¶ï¼Œå¤§éƒ½æ˜¯é‡‡ç”¨å¸¦ç‰ˆæœ¬å·ï¼ˆVersionï¼‰æ›´æ–°ã€‚å®ç°å°±æ˜¯ï¼Œè¿™ä¸ªæ•°æ®æ‰€æœ‰è¯·æ±‚éƒ½æœ‰èµ„æ ¼å»ä¿®æ”¹ï¼Œä½†ä¼šè·å¾—ä¸€ä¸ªè¯¥æ•°æ®çš„ç‰ˆæœ¬å·ï¼Œåªæœ‰ç‰ˆæœ¬å·ç¬¦åˆçš„æ‰èƒ½æ›´æ–°æˆåŠŸï¼Œå…¶ä»–çš„è¿”å›æŠ¢è´­å¤±è´¥ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦è€ƒè™‘é˜Ÿåˆ—çš„é—®é¢˜ï¼Œä¸è¿‡ï¼Œå®ƒä¼šå¢å¤§CPUçš„è®¡ç®—å¼€é”€ã€‚ä½†æ˜¯ï¼Œç»¼åˆæ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆã€‚ <img src="http://img.php.cn//upload/image/542/338/822/1485234456400515.jpg" alt="14834077835.jpg" title="1485234456400515.jpg"> æœ‰å¾ˆå¤šè½¯ä»¶å’ŒæœåŠ¡éƒ½â€œä¹è§‚é”â€åŠŸèƒ½çš„æ”¯æŒï¼Œä¾‹å¦‚Redisä¸­çš„watchå°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚é€šè¿‡è¿™ä¸ªå®ç°ï¼Œæˆ‘ä»¬ä¿è¯äº†æ•°æ®çš„å®‰å…¨ã€‚ ä¼˜åŒ–æ–¹æ¡ˆ5ï¼šRedisä¸­çš„watch</p><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>$redis = <span class="hljs-keyword">new</span> redis(); $result = $redis-&gt;connect(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">6379</span>); <span class="hljs-keyword">echo</span> $mywatchkey = $redis-&gt;get(<span class="hljs-string">&quot;mywatchkey&quot;</span>);<span class="hljs-comment">/*</span><span class="hljs-comment">  //æ’å…¥æŠ¢è´­æ•°æ®</span><span class="hljs-comment"> if($mywatchkey&gt;0)</span><span class="hljs-comment"> &#123;</span><span class="hljs-comment">     $redis-&gt;watch(&quot;mywatchkey&quot;);</span><span class="hljs-comment">  //å¯åŠ¨ä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚</span><span class="hljs-comment">    $redis-&gt;multi();</span><span class="hljs-comment">   $redis-&gt;set(&quot;mywatchkey&quot;,$mywatchkey-1);</span><span class="hljs-comment">   $result = $redis-&gt;exec();</span><span class="hljs-comment">   if($result) &#123;</span><span class="hljs-comment">      $redis-&gt;hSet(&quot;watchkeylist&quot;,&quot;user_&quot;.mt_rand(1,99999),time());</span><span class="hljs-comment">      $watchkeylist = $redis-&gt;hGetAll(&quot;watchkeylist&quot;);</span><span class="hljs-comment">        echo &quot;æŠ¢è´­æˆåŠŸï¼&lt;br/&gt;&quot;;</span><span class="hljs-comment">        $re = $mywatchkey - 1;  </span><span class="hljs-comment">        echo &quot;å‰©ä½™æ•°é‡ï¼š&quot;.$re.&quot;&lt;br/&gt;&quot;;</span><span class="hljs-comment">        echo &quot;ç”¨æˆ·åˆ—è¡¨ï¼š&lt;pre&gt;&quot;;</span><span class="hljs-comment">        print_r($watchkeylist);</span><span class="hljs-comment">   &#125;else&#123;</span><span class="hljs-comment">      echo &quot;æ‰‹æ°”ä¸å¥½ï¼Œå†æŠ¢è´­ï¼&quot;;exit;</span><span class="hljs-comment">   &#125; </span><span class="hljs-comment"> &#125;else&#123;</span><span class="hljs-comment">     // $redis-&gt;hSet(&quot;watchkeylist&quot;,&quot;user_&quot;.mt_rand(1,99999),&quot;12&quot;);</span><span class="hljs-comment">     //  $watchkeylist = $redis-&gt;hGetAll(&quot;watchkeylist&quot;);</span><span class="hljs-comment">        echo &quot;failï¼&lt;br/&gt;&quot;;   </span><span class="hljs-comment">        echo &quot;.no result&lt;br/&gt;&quot;;</span><span class="hljs-comment">        echo &quot;ç”¨æˆ·åˆ—è¡¨ï¼š&lt;pre&gt;&quot;;</span><span class="hljs-comment">      //  var_dump($watchkeylist); </span><span class="hljs-comment"> &#125;*/</span>$rob_total = <span class="hljs-number">100</span>;   <span class="hljs-comment">//æŠ¢è´­æ•°é‡</span><span class="hljs-keyword">if</span>($mywatchkey&lt;=$rob_total)&#123;    $redis-&gt;watch(<span class="hljs-string">&quot;mywatchkey&quot;</span>);    $redis-&gt;multi(); <span class="hljs-comment">//åœ¨å½“å‰è¿æ¥ä¸Šå¯åŠ¨ä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚</span>    <span class="hljs-comment">//æ’å…¥æŠ¢è´­æ•°æ®</span>    $redis-&gt;set(<span class="hljs-string">&quot;mywatchkey&quot;</span>,$mywatchkey+<span class="hljs-number">1</span>);    $rob_result = $redis-&gt;exec();    <span class="hljs-keyword">if</span>($rob_result)&#123;         $redis-&gt;hSet(<span class="hljs-string">&quot;watchkeylist&quot;</span>,<span class="hljs-string">&quot;user_&quot;</span>.mt_rand(<span class="hljs-number">1</span>, <span class="hljs-number">9999</span>),$mywatchkey);        $mywatchlist = $redis-&gt;hGetAll(<span class="hljs-string">&quot;watchkeylist&quot;</span>);        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;æŠ¢è´­æˆåŠŸï¼&lt;br/&gt;&quot;</span>;        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;å‰©ä½™æ•°é‡ï¼š&quot;</span>.($rob_total-$mywatchkey<span class="hljs-number">-1</span>).<span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;ç”¨æˆ·åˆ—è¡¨ï¼š&lt;pre&gt;&quot;</span>;        var_dump($mywatchlist);    &#125;<span class="hljs-keyword">else</span>&#123;          $redis-&gt;hSet(<span class="hljs-string">&quot;watchkeylist&quot;</span>,<span class="hljs-string">&quot;user_&quot;</span>.mt_rand(<span class="hljs-number">1</span>, <span class="hljs-number">9999</span>),<span class="hljs-string">&#x27;meiqiangdao&#x27;</span>);        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;æ‰‹æ°”ä¸å¥½ï¼Œå†æŠ¢è´­ï¼&quot;</span>;<span class="hljs-keyword">exit</span>;    &#125;&#125;<span class="hljs-meta">?&gt;</span></code></pre>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é«˜å¹¶å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker å‘½ä»¤</title>
    <link href="/2019/02/20/docker-%E5%91%BD%E4%BB%A4/"/>
    <url>/2019/02/20/docker-%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<ul><li>æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨</li></ul><p><code>docker ps</code></p><ul><li>æŸ¥çœ‹æ‰€æœ‰å®¹å™¨åˆ—å‡ºæ‰€æœ‰container</li></ul><p><code>docker-ps -a</code></p><ul><li>åœæ­¢/è¿è¡Œå®ä¾‹</li></ul><p><code>docker run/stop --help</code> <code>docker run/stop container</code></p><ul><li>æŸ¥çœ‹containerè¯¦æƒ…</li></ul><p><code>docker inspect [container]</code></p><ul><li>åˆ é™¤æŸä¸ªcontainer</li></ul><p><code>docker rm [container]</code> <code>docker rm `docker ps -a -q` åˆ é™¤æ‰€æœ‰å®¹å™¨ï¼Œ-qè¡¨ç¤ºåªè¿”å›å®¹å™¨çš„ID</code></p><ul><li>æŸ¥çœ‹æŸä¸ªcontainerçš„è¿è¡Œæ—¥å¿—</li></ul><pre><code class="hljs axapta">docker logs [<span class="hljs-keyword">container</span>]docker logs -f [<span class="hljs-keyword">container</span>] ç±»ä¼¼tailf</code></pre><ul><li>æŸ¥çœ‹å®¹å™¨å†…éƒ¨çš„è¿›ç¨‹ä¿¡æ¯</li></ul><p><code>docker top [container]</code></p><ul><li>åœ¨å®¹å™¨ä¸­è¿è¡Œåå°ä»»åŠ¡ï¼Œåªå¯¹æ­£åœ¨è¿è¡Œçš„å®¹å™¨æœ‰æ•ˆ</li></ul><pre><code class="hljs mel">docker <span class="hljs-keyword">exec</span> -d [<span class="hljs-keyword">container</span>] [cmd]docker <span class="hljs-keyword">exec</span> -d edison touch /home/haha</code></pre>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>php socket C/S IOé˜»å¡æ–¹å¼</title>
    <link href="/2019/02/16/php-socket-c-s-io%E9%98%BB%E5%A1%9E%E6%96%B9%E5%BC%8F/"/>
    <url>/2019/02/16/php-socket-c-s-io%E9%98%BB%E5%A1%9E%E6%96%B9%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h4 id="ç½‘ç»œç¼–ç¨‹é˜»å¡æ¨¡å¼"><a class="header-anchor" href="#ç½‘ç»œç¼–ç¨‹é˜»å¡æ¨¡å¼"></a>ç½‘ç»œç¼–ç¨‹é˜»å¡æ¨¡å¼</h4><p><strong>åœ¨ç½‘ç½‘ç»œç¼–ç¨‹ä¸­é€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§è°ƒç”¨æ–¹å¼ï¼š</strong></p><ul><li>åŒæ­¥è°ƒç”¨ï¼ˆSyncï¼‰</li><li>å¼‚æ­¥è°ƒç”¨ï¼ˆAsyncï¼‰</li><li>é˜»å¡(Block)</li><li>éé˜»å¡(Unblock)</li></ul><p><strong>è¿™å‡ ç§è°ƒç”¨æ–¹å¼å¯ä»¥è¿›è¡Œç»„åˆï¼š</strong></p><ul><li>åŒæ­¥é˜»å¡</li><li>åŒæ­¥éé˜»å¡</li><li>å¼‚æ­¥é˜»å¡</li><li>å¼‚æ­¥éé˜»å¡</li></ul><p>æˆ‘ä»¬åœ¨é€šè¿‡phpè¿›è¡Œç½‘ç»œç¼–ç¨‹æ—¶ä¼šå‘ç°ï¼Œphpçš„ä¼šæœ‰IOé˜»å¡çš„ç°è±¡ã€‚åœ¨å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥æœåŠ¡å™¨ç«¯æ—¶ï¼ŒæœåŠ¡å™¨ç«¯ä¼šä»¥å®¢æˆ·ç«¯è¿æ¥çš„å…ˆåé¡ºåºæ¥å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼Œå½¢æˆä¸€ä¸ªé¡ºåºé˜Ÿåˆ—çš„æ–¹å¼ã€‚å½“æœåŠ¡ç«¯åœ¨å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œå…¶ä»–çš„å®¢æˆ·ç«¯æ˜¯ä¸æœåŠ¡å™¨è¿›è¡Œäº¤äº’çš„ï¼Œåªæœ‰ç­‰å¾…å‰ä¸€ä¸ªè¿æ¥å¤„ç†ç»“æŸã€‚ <strong>server/client phpä»£ç ç¤ºä¾‹</strong> æœåŠ¡ç«¯</p><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>set_time_limit(<span class="hljs-number">0</span>);<span class="hljs-comment">//ç¡®ä¿è¿æ¥å®¢æˆ·ç«¯ä¸ä¼šè¶…æ—¶</span>$ip = <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>;$port = <span class="hljs-number">4321</span>;<span class="hljs-comment">//åˆ›å»ºsocket</span><span class="hljs-keyword">if</span>(($socket = socket_create(AF_INET, STREAM_SOCK_STREAM, SOL_TCP)) &lt; <span class="hljs-number">0</span>)&#123;    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;socket_create() å¤±è´¥çš„åŸå› æ˜¯:&quot;</span>.socket_strerror(socket_last_error()).<span class="hljs-string">&quot;\n&quot;</span>;&#125;<span class="hljs-comment">//é˜»å¡æ¨¡å¼</span>socket_set_block($socket) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;socket_set_block() å¤±è´¥çš„åŸå› æ˜¯:&quot;</span> . socket_strerror(socket_last_error()) . <span class="hljs-string">&quot;\n&quot;</span>);<span class="hljs-comment">//ç»‘å®šipå’Œç«¯å£</span><span class="hljs-keyword">if</span>(($ret = socket_bind($socket, $ip, $port)) &lt; <span class="hljs-number">0</span>)&#123;    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;socket_bind() å¤±è´¥çš„åŸå› æ˜¯:&quot;</span>.socket_strerror($ret).<span class="hljs-string">&quot;\n&quot;</span>;&#125;<span class="hljs-comment">//ç›‘å¬</span><span class="hljs-keyword">if</span>(($ret = socket_listen($socket)) &lt; <span class="hljs-number">0</span>)&#123;    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;socket_listen() å¤±è´¥çš„åŸå› æ˜¯:&quot;</span>.socket_strerror($ret).<span class="hljs-string">&quot;\n&quot;</span>;&#125;<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;PHP Socket Server create success!\n&quot;</span>;$buf = <span class="hljs-literal">null</span>;<span class="hljs-keyword">do</span>&#123;    <span class="hljs-comment">// æ¥å—ä¸€ä¸ªSocketå®¢æˆ·ç«¯è¿æ¥</span>    <span class="hljs-keyword">if</span>(($client = socket_accept($socket)) &lt; <span class="hljs-number">0</span>)&#123;        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;socket_accept() failed: reason: &quot;</span> . socket_strerror(socket_last_error($client)) . <span class="hljs-string">&quot;\n&quot;</span>;    &#125;<span class="hljs-keyword">else</span>&#123;        socket_getpeername($client, $client_addr, $client_port);        <span class="hljs-comment">//å‘ŠçŸ¥å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ</span>        $msg = <span class="hljs-string">&quot;connect success!&quot;</span>;        socket_write($client, $msg, strlen($msg));        <span class="hljs-keyword">do</span>&#123;            <span class="hljs-comment">//æ‰“å°å®¢æˆ·ç«¯å‘é€æ¥çš„ä¿¡æ¯</span>            <span class="hljs-keyword">if</span>(($buf = @socket_read($client, <span class="hljs-number">8192</span>)) === <span class="hljs-literal">false</span>)&#123;                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;socket_read() failed: reason: &quot;</span> . socket_strerror(socket_last_error($client)) . <span class="hljs-string">&quot;\n&quot;</span>;                socket_close($client);                <span class="hljs-keyword">break</span>;            &#125;            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;rev client[&#123;$client_addr&#125;]:&quot;</span>.$buf.<span class="hljs-string">&quot;\n&quot;</span>;            <span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;exit&#x27;</span> == $buf)&#123;                <span class="hljs-keyword">break</span>;            &#125;            <span class="hljs-comment">//æœåŠ¡å™¨å‘é€ç»™å®¢æˆ·ç«¯</span>            $buf = <span class="hljs-string">&quot;server send: ($buf)&quot;</span>;            socket_write($client, $buf, strlen($buf));        &#125;<span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>);    &#125;&#125;<span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>);<span class="hljs-comment">//å…³é—­socket</span>socket_close($socket);</code></pre><p>å®¢æˆ·ç«¯</p><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>error_reporting(E_ALL);set_time_limit(<span class="hljs-number">0</span>);<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;start connect server\n&quot;</span>;$ip = <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>;$port = <span class="hljs-number">4321</span>;<span class="hljs-comment">//åˆ›å»ºsocket</span><span class="hljs-keyword">if</span>(($socket = socket_create(AF_INET, STREAM_SOCK_STREAM, SOL_TCP)) &lt; <span class="hljs-number">0</span>)&#123;    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;socket_create() failed: reason: &quot;</span> . socket_strerror(socket_last_error()) . <span class="hljs-string">&quot;\n&quot;</span>;&#125;<span class="hljs-comment">/***è®¾ç½®socketè¿æ¥é€‰é¡¹ï¼Œè¿™ä¸¤ä¸ªæ­¥éª¤å¯ä»¥çœç•¥***/</span><span class="hljs-comment">//æ¥æ”¶å¥—æ¥æµçš„æœ€å¤§è¶…æ—¶æ—¶é—´1ç§’ï¼Œåé¢æ˜¯å¾®ç§’å•ä½è¶…æ—¶æ—¶é—´ï¼Œè®¾ç½®ä¸ºé›¶ï¼Œè¡¨ç¤ºä¸ç®¡å®ƒ</span>socket_set_option($socket, SOL_SOCKET, SO_RCVTIMEO, <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;sec&quot;</span> =&gt; <span class="hljs-number">1</span>, <span class="hljs-string">&quot;usec&quot;</span> =&gt; <span class="hljs-number">0</span>));<span class="hljs-comment">//å‘é€å¥—æ¥æµçš„æœ€å¤§è¶…æ—¶æ—¶é—´ä¸º6ç§’</span>socket_set_option($socket, SOL_SOCKET, SO_SNDTIMEO, <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;sec&quot;</span> =&gt; <span class="hljs-number">6</span>, <span class="hljs-string">&quot;usec&quot;</span> =&gt; <span class="hljs-number">0</span>));<span class="hljs-comment">/***è®¾ç½®socketè¿æ¥é€‰é¡¹ï¼Œè¿™ä¸¤ä¸ªæ­¥éª¤å¯ä»¥çœç•¥***/</span>$info = <span class="hljs-string">&quot;connect $ip:$port...\n&quot;</span>;<span class="hljs-keyword">echo</span> $info;<span class="hljs-comment">//è¿æ¥åˆ°127.0.0.1:4321è¿™ä¸ªsocket serverä¸Šé¢</span><span class="hljs-keyword">if</span>(($ret = socket_connect($socket, $ip, $port)) &lt; <span class="hljs-number">0</span>)&#123;    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;socket_connect() failed.\nReason: ($ret) &quot;</span> . socket_strerror($ret) . <span class="hljs-string">&quot;\n&quot;</span>;&#125;<span class="hljs-keyword">do</span>&#123;    <span class="hljs-comment">//è¯»å–æœåŠ¡å™¨å‘é€ä¿¡æ¯</span>    $out = socket_read($socket, <span class="hljs-number">8192</span>);    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;client æ¥æ”¶:&quot;</span>,$out.<span class="hljs-string">&quot;\n&quot;</span>;    <span class="hljs-comment">//è¯»å–é”®ç›˜è¾“å…¥å¹¶å‘é€ç»™æœåŠ¡å™¨</span>    $in = trim(fgets(STDIN));    <span class="hljs-keyword">if</span>(! socket_write($socket, $in, strlen($in)))&#123;        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;socket_write() failed: reason: &quot;</span> . socket_strerror(socket_last_error($socket)) . <span class="hljs-string">&quot;\n&quot;</span>;    &#125;    <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦é€€å‡ºå‘½ä»¤</span>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;exit&#x27;</span> == $in)&#123;        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;client quit\n&quot;</span>;        <span class="hljs-keyword">break</span>;    &#125;&#125;<span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>);<span class="hljs-comment">//å…³é—­socket</span>socket_close($socket);</code></pre><p>è¿è¡Œserverï¼š <img src="https://blog.wenboo.top/wp-content/uploads/2019/02/9765cc61c56df054f7d81d678964e3b3.png" alt=""> è¿è¡Œclient 1 <img src="https://blog.wenboo.top/wp-content/uploads/2019/02/bd6dcdf1a6fd7eb42b012f0489f82ff0.png" alt=""> æœåŠ¡ç«¯å“åº” <img src="https://blog.wenboo.top/wp-content/uploads/2019/02/b37117313704f3a854f249f73b089c0f.png" alt=""> ä¿æŒClient 1ä¸æ–­å¼€ è¿è¡ŒClient 2 ç¨‹åº <img src="https://blog.wenboo.top/wp-content/uploads/2019/02/11d7577a91fdfb2ebc04d1be10362779.png" alt=""> æœåŠ¡ç«¯æ²¡æœ‰ä»»ä½•å“åº”ï¼Œè¯´æ˜æ­¤æ—¶Client2å®¢æˆ·ç«¯æ˜¯é˜»å¡çŠ¶æ€ æ–­å¼€Client1åï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°äº†Client2çš„æ•°æ® <img src="https://blog.wenboo.top/wp-content/uploads/2019/02/017634ef64e7701619bafa4a0a872001.png" alt=""></p>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php socket</tag>
      
      <tag>socket</tag>
      
      <tag>I/O</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux cronå®šæ—¶ä»»åŠ¡ ç¯å¢ƒå˜é‡å‘</title>
    <link href="/2019/01/12/linux-cron%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E5%9D%91/"/>
    <url>/2019/01/12/linux-cron%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E5%9D%91/</url>
    
    <content type="html"><![CDATA[<h5 id="æœ€è¿‘å†™äº†ä¸€ä¸ªè‡ªåŠ¨åˆ é™¤æ—¥å¿—æ–‡ä»¶çš„shellè„šæœ¬ï¼Œåœ¨æ‰‹åŠ¨æ‰§è¡Œä¸‹ä¸€åˆ‡æ­£å¸¸ã€‚ä½†æ˜¯ä½¿ç”¨cronåšå®šæ—¶ä»»åŠ¡æ—¶å„ç§å‘çˆ¹çš„é—®é¢˜ã€‚"><a class="header-anchor" href="#æœ€è¿‘å†™äº†ä¸€ä¸ªè‡ªåŠ¨åˆ é™¤æ—¥å¿—æ–‡ä»¶çš„shellè„šæœ¬ï¼Œåœ¨æ‰‹åŠ¨æ‰§è¡Œä¸‹ä¸€åˆ‡æ­£å¸¸ã€‚ä½†æ˜¯ä½¿ç”¨cronåšå®šæ—¶ä»»åŠ¡æ—¶å„ç§å‘çˆ¹çš„é—®é¢˜ã€‚"></a>æœ€è¿‘å†™äº†ä¸€ä¸ªè‡ªåŠ¨åˆ é™¤æ—¥å¿—æ–‡ä»¶çš„shellè„šæœ¬ï¼Œåœ¨æ‰‹åŠ¨æ‰§è¡Œä¸‹ä¸€åˆ‡æ­£å¸¸ã€‚ä½†æ˜¯ä½¿ç”¨cronåšå®šæ—¶ä»»åŠ¡æ—¶å„ç§å‘çˆ¹çš„é—®é¢˜ã€‚</h5><p>è„šæœ¬å¦‚ä¸‹ï¼š</p><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><span class="hljs-meta">#</span><span class="bash">æ—¥å¿—è·¯å¾„</span>cd /root/IOTC_Server/log/SSI_A146_0001_0003_2<span class="hljs-meta">#</span><span class="bash">ä»15å¤©å‰çš„æ—¶é—´å¾€å‰åˆ 15å¤©<span class="hljs-built_in">log</span></span>start_time=`date -d &quot;-1 month&quot; +%s`for ((i=0;i&lt;15;i++))dotime=$((start_time + i*86400))<span class="hljs-meta">#</span><span class="bash">åˆ é™¤ddhhæ—¥å¿—</span>ymd=`date -d @$time +%Y%m%d`d=`date -d @$time +%d`echo &quot;æ­£åœ¨åˆ é™¤ $ymd çš„æ—¥å¿—&quot; &gt;&gt; /root/del_iot_log.txtddhh_log=`ls|grep &quot;$d&quot;|grep &quot;^$d&quot;`if [ -z &quot;$ddhh_log&quot; ];thenecho &#x27;not find file&#x27;elserm -f $ddhh_logfiDevice_log=`ls|grep &quot;$d&quot;|grep &quot;^DeviceUsage$d&quot;`if [ -z &quot;$Device_log&quot; ];thenecho &#x27;not find file&#x27;elserm -f $Device_logfiConnect_log=`ls|grep &quot;$d&quot;|grep &quot;^ConnectResult$d&quot;`if [ -z &quot;$Connect_log&quot; ];thenecho &#x27;not find file&#x27;elserm -f $Connect_logfiRelay_log=`ls|grep Relay$ymd`if [ -z &quot;$Relay_log&quot; ];thenecho &#x27;not find file&#x27;elserm -f $Relay_logfista_file=`ls|grep Statistics$ymd`if [ -z &quot;$sta_file&quot; ];thenecho &#x27;not find file&#x27;elserm -f $sta_filefidoneshell_time=`date &quot;+%F %T&quot;`echo &quot;$shell_time logåˆ é™¤å®Œæˆ!&quot; &gt;&gt; /root/del_iot_log.txt</code></pre><p>åŸæ¥çš„è¢«åˆ é™¤æ—¥å¿—è·¯å¾„ç›´æ¥å†™çš„ç»å¯¹è·¯å¾„ï¼Œç„¶åé€šè¿‡ç®¡é“ç¬¦æ‰¾åˆ°è¦åˆ é™¤çš„æ–‡ä»¶åï¼Œæœ€åé€šè¿‡<code>rm -f $log_path/æ–‡ä»¶å</code>å‘½ä»¤åˆ é™¤ã€‚ æ‰‹åŠ¨æ‰§è¡Œåï¼Œæ­£å¸¸åˆ é™¤æŸ¥æ‰¾åˆ°æ‰€æœ‰æ–‡ä»¶ã€‚ä½†æ˜¯é€šè¿‡cronæ‰§è¡Œæ­¤è„šæœ¬ï¼Œæ­»æ´»åªèƒ½åˆ é™¤ä¸€ä¸ªæ–‡ä»¶ä¾‹å¦‚æŸ¥æ‰¾åˆ°123.txt 234.txt,æ‰§è¡Œæ—¶æ˜¯<code>rm -f $log_path/123.txt 234.txt</code>,ç»“æœåªæœ‰123.txtè¢«åˆ é™¤æ‰ å®šä½åˆ°åº”è¯¥æ˜¯ç¯å¢ƒå˜é‡çš„é—®é¢˜ï¼Œé€šè¿‡åœ¨è„šæœ¬æœ€å‰å¤´å¼•å…¥ç¯å¢ƒå˜é‡ï¼Œè¿˜æœ‰ç½‘ä¸Šè¯´çš„ä¸€äº›æ–¹æ³•ï¼Œç»“æœè¿˜æ˜¯ä¸€æ ·ã€‚ æœ€åè¿˜æ˜¯é€šè¿‡<code>cd</code>å…ˆåˆ‡æ¢ç›®æ ‡è·¯å¾„å åœ¨è¿›è¡Œè„šæœ¬çš„åˆ é™¤æ‰§è¡Œã€‚æ— é—®é¢˜ ğŸ˜² è™½ç„¶è§£å†³äº†é—®é¢˜ï¼Œä¸€åœˆä¸‹æ¥è¿˜æ˜¯ä¸çŸ¥é“æ˜¯å“ªé‡Œå‡ºäº†é—®é¢˜ï¼Œæ•…æ­¤å…ˆåšè®°å½•ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
      <category>shell</category>
      
    </categories>
    
    
    <tags>
      
      <tag>crontab</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€ä¸ªå¥½ç”¨çš„å…è´¹DDNS</title>
    <link href="/2019/01/12/%E5%88%86%E4%BA%AB%E4%B8%80%E4%B8%AA%E5%A5%BD%E7%94%A8%E7%9A%84%E5%85%8D%E8%B4%B9ddns/"/>
    <url>/2019/01/12/%E5%88%86%E4%BA%AB%E4%B8%80%E4%B8%AA%E5%A5%BD%E7%94%A8%E7%9A%84%E5%85%8D%E8%B4%B9ddns/</url>
    
    <content type="html"><![CDATA[<h4 id="æœ‰è¿œç¨‹è®¿é—®çš„éœ€æ±‚ï¼Œä¸”æœ‰åŠ¨æ€å…¬ç½‘ipï¼ˆç”µä¿¡å…¬å¸ä¸€èˆ¬ç»™ç§äººçš„éƒ½æ˜¯è¿™ä¸ªï¼‰åˆä¸æƒ³ç”¨å†…ç½‘ç©¿é€çš„æ–¹æ³•ï¼Œè¿™æ—¶å°±å¿…é¡»è¦ä½¿ç”¨åˆ°DDNSåŠ¨æ€dnsäº†"><a class="header-anchor" href="#æœ‰è¿œç¨‹è®¿é—®çš„éœ€æ±‚ï¼Œä¸”æœ‰åŠ¨æ€å…¬ç½‘ipï¼ˆç”µä¿¡å…¬å¸ä¸€èˆ¬ç»™ç§äººçš„éƒ½æ˜¯è¿™ä¸ªï¼‰åˆä¸æƒ³ç”¨å†…ç½‘ç©¿é€çš„æ–¹æ³•ï¼Œè¿™æ—¶å°±å¿…é¡»è¦ä½¿ç”¨åˆ°DDNSåŠ¨æ€dnsäº†"></a>æœ‰è¿œç¨‹è®¿é—®çš„éœ€æ±‚ï¼Œä¸”æœ‰åŠ¨æ€å…¬ç½‘ipï¼ˆç”µä¿¡å…¬å¸ä¸€èˆ¬ç»™ç§äººçš„éƒ½æ˜¯è¿™ä¸ªï¼‰åˆä¸æƒ³ç”¨å†…ç½‘ç©¿é€çš„æ–¹æ³•ï¼Œè¿™æ—¶å°±å¿…é¡»è¦ä½¿ç”¨åˆ°DDNSåŠ¨æ€dnsäº†</h4><p><strong>no-ip</strong> åœ¨ä½¿ç”¨äº†ä¸€ä¸ªæœˆåï¼Œæˆ‘å¯¹è¿™ä¸ªddnså¾ˆæ»¡æ„ï¼Œé€Ÿåº¦å¿«ã€å…è´¹ï¼ˆéœ€è¦æ¯ä¸ªæœˆè¿›è¡Œé‚®ä»¶ç¡®è®¤ä¸€æ¬¡ï¼‰ å®˜ç½‘ï¼š<a href="https://www.noip.com/" title="no-ip">no-ip</a> å…è²»ç”¨æˆ·å¯ä»¥åˆ›å»º3ä¸ªä¸»æœº <img src="https://blog.wenboo.top/wp-content/uploads/2019/01/f37995b4cbbeec86e7874d7d72e68ddb.png" alt=""> å®˜æ–¹æä¾›äº† winã€linuxã€macçš„ DUCï¼ˆDynamic DNS Update Clientï¼‰ä½¿ç”¨èµ·æ¥å¾ˆç®€å•ã€‚ <img src="https://blog.wenboo.top/wp-content/uploads/2019/01/052ff5368684b69915bf7ec60c95652a.png" alt=""></p>]]></content>
    
    
    <categories>
      
      <category>DDNS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>DDns</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è¿œç¨‹å¼€æœº&amp;è®¿é—®å®¶é‡Œçš„PC</title>
    <link href="/2018/12/27/%E8%BF%9C%E7%A8%8B%E5%BC%80%E6%9C%BA%E8%AE%BF%E9%97%AE%E5%AE%B6%E9%87%8C%E7%9A%84pc/"/>
    <url>/2018/12/27/%E8%BF%9C%E7%A8%8B%E5%BC%80%E6%9C%BA%E8%AE%BF%E9%97%AE%E5%AE%B6%E9%87%8C%E7%9A%84pc/</url>
    
    <content type="html"><![CDATA[<h3 id="æœ€è¿‘æäº†ä¸ªå…¬ç½‘ipï¼Œæƒ³èµ·äº†ç°åœ¨çš„ç”µè„‘éƒ½æ”¯æŒWOL-wake-on-lan-ç½‘ç»œå”¤é†’ï¼Œäºæ˜¯å°±æŠ˜è…¾äº†ä¸€ä¸‹ã€‚"><a class="header-anchor" href="#æœ€è¿‘æäº†ä¸ªå…¬ç½‘ipï¼Œæƒ³èµ·äº†ç°åœ¨çš„ç”µè„‘éƒ½æ”¯æŒWOL-wake-on-lan-ç½‘ç»œå”¤é†’ï¼Œäºæ˜¯å°±æŠ˜è…¾äº†ä¸€ä¸‹ã€‚"></a>æœ€è¿‘æäº†ä¸ªå…¬ç½‘ipï¼Œæƒ³èµ·äº†ç°åœ¨çš„ç”µè„‘éƒ½æ”¯æŒWOL(wake on lan)ç½‘ç»œå”¤é†’ï¼Œäºæ˜¯å°±æŠ˜è…¾äº†ä¸€ä¸‹ã€‚</h3><ul><li>å…¬ç½‘ipçš„è¯ï¼Œæˆ‘è¿™è¾¹æ˜¯ç”µä¿¡çš„åˆšå¼€å§‹ä¹Ÿæ˜¯æ²¡æœ‰å…¬ç½‘ipçš„ï¼Œåæ¥è”ç³»å®¢æœï¼ˆæˆ‘æ˜¯åœ¨å¾®ä¿¡å…¬ä¼—å·ä¸­é—´è”ç³»çš„ï¼Œç”µè¯åº”è¯¥ä¹Ÿæ˜¯ä¸€æ ·ï¼‰è¯´è¦ä¸€ä¸ªå…¬ç½‘ipï¼Œç„¶åå®¢æˆ·å°±æ´¾å•ç»™äº†å¸ˆå‚…ï¼Œç¬¬äºŒå¤©å°±å¥½äº†ã€‚</li><li>ç”±äºç”µä¿¡ç»™çš„å…¬ç½‘ipæ˜¯åŠ¨æ€çš„ï¼Œå°±åªè¦è¶…è¿‡48å°æ—¶æˆ–è€…è·¯ç”±å™¨é‡æ–°æ‹¨å·ipå°±å˜äº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ddnsåŸŸåæ¥è§£æipï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯å…è´¹çš„ddns no-ip<a href="https://www.noip.com/" title="å®˜ç½‘">å®˜ç½‘</a>ã€‚</li><li>no-ipéœ€è¦ä½¿ä¸€ä¸ªåŠ¨æ€åˆ·æ–°ipçš„å®¢æˆ·ç«¯ï¼Œlinuxã€windowsã€macå…¨å¹³å°éƒ½æ”¯æŒï¼Œè€Œä¸”æ¯ä¸ªéœ€è¦ä¸€æ¬¡é‚®ä»¶éªŒè¯ï¼ˆå…¶å®éƒ½èƒ½æ¥å—ï¼Œæ¯•ç«Ÿæ˜¯å…è´¹çš„ï¼Œä½¿ç”¨ä¸€æ®µæ—¶é—´æ„Ÿè§‰æ•ˆæœä¸é”™ï¼‰ã€‚</li></ul><h4 id="é‡åˆ°çš„é—®é¢˜"><a class="header-anchor" href="#é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h4><p>å‰ææ¡ä»¶ï¼šç”µè„‘ä¸»æ¿å¿…é¡»æ”¯æŒwolï¼Œå¹¶å·²ç»åœ¨bioså¼€å¯æ­¤åŠŸèƒ½,ç½‘å¡ç½‘å¡æ”¯æŒç½‘ç»œå”¤é†’ï¼Œåœ¨ç½‘å¡é…ç½®ç”µæºç®¡ç†ä¸­å‹¾é€‰ä»¥ä¸‹é€‰é¡¹ <img src="https://blog.wenboo.top/wp-content/uploads/2018/12/1651a138b5a294a1cd7596bab9966683.png" alt=""> 1. æœ€å¼€å§‹å°è¯•ç€åœ¨å±€åŸŸç½‘ä¸­è¿›è¡Œå¼€æœºå”¤é†’æ­»æ´»å”¤é†’ä¸äº†ï¼Œåæ¥çœ‹è§ç½‘ä¸Šè¯´å¯èƒ½æ˜¯é˜²ç«å¢™çš„é—®é¢˜ã€‚ åœ¨é˜²ç«å¢™è®¾ç½®ä¸­å¼€æ”¾ä¸€ä¸ªç«¯å£ï¼š æ–°å»ºä¸€ä¸ª<strong>å…¥ç«™è§„åˆ™</strong> <img src="https://blog.wenboo.top/wp-content/uploads/2018/12/897386590604c95e7d26d2eb078dc436.png" alt=""> <img src="https://blog.wenboo.top/wp-content/uploads/2018/12/a57ed6627604e90edfa711fa2c3e545a.png" alt=""> <strong>è¿™ä¸ªç«¯å£å¾ˆé‡è¦ï¼Œéœ€è¦åœ¨è·¯ç”±å™¨ä¸­è®¾ç½®ç«¯å£è½¬å‘,ç„¶åä½œç”¨åŸŸçš„è¯å…¨éƒ¨å‹¾é€‰å°±å¥½</strong> <img src="https://blog.wenboo.top/wp-content/uploads/2018/12/ae615908032c5ae22d86c3c719de4640.png" alt=""> é€šè¿‡ä»¥ä¸Šè®¾ç½®åï¼Œåœ¨å±€åŸŸç½‘å†…å·²ç»èƒ½å¤ŸæˆåŠŸå”¤é†’ç”µè„‘äº†ã€‚</p><ol start="2"><li>åœ¨å¹¿åŸŸç½‘å”¤é†’ç”µè„‘</li></ol><p>åœ¨å¹¿åŸŸç½‘ä¸­å”¤é†’ç”µè„‘å¼€æœºçš„å‰ææ¡ä»¶ï¼š - å…¬ç½‘ipæˆ–è€…å†…ç½‘ç©¿é€ - è·¯ç”±å¯ä»¥é™æ€arpç»‘å®šï¼Œç»‘å®špcçš„macåœ°å€å’Œå†…ç½‘ip ç°åœ¨å¾ˆå¤šçš„è·¯ç”±å™¨ï¼ˆæˆ‘çš„æ˜¯è…¾è¾¾åƒåœ¾è·¯ç”±ac9ï¼‰éƒ½æŠŠé™æ€arpç»‘å®šè¿™ä¸ªåŠŸèƒ½å»æ‰äº†ï¼Œä»¥å‰çš„è·¯ç”±å™¨éƒ½æœ‰ã€‚ åœ¨è·¯ç”±å™¨webç®¡ç†é¡µé¢ä¸­æ²¡æœ‰é™æ€arpç»‘å®šçš„åŠŸèƒ½ï¼Œå°±èƒ½åªèƒ½é€šè¿‡å‘½ä»¤çš„å½¢å¼ç™»å½•åˆ°è·¯ç”±å™¨ä¸Šä½¿ç”¨linux arpå‘½ä»¤æ¥æ‰‹åŠ¨ç»‘å®šï¼ˆæˆ‘ç”¨çš„telnetï¼Œæœ‰äº›è·¯ç”±å™¨å¯ä»¥ç›´æ¥sshç™»å½•ï¼‰ ç™»å½•åæ‰§è¡Œ <code>arp -s ip mac</code> ç»‘å®šï¼ˆè¿™æ¡å‘½ä»¤å¯ä»¥åŠ å¦‚è·¯ç”±å™¨çš„å¼€æœºåˆå§‹åŒ–è„šæœ¬é‡Œé¢ï¼Œè¿™æ ·è·¯ç”±å™¨é‡å¯ä¹‹ååˆä¼šé‡æ–°ç»‘å®šï¼‰</p><h4 id="è¿œç¨‹æ§åˆ¶"><a class="header-anchor" href="#è¿œç¨‹æ§åˆ¶"></a>è¿œç¨‹æ§åˆ¶</h4><p>ä»¥å‰ä¸€ç›´ä½¿ç”¨çš„æ˜¯teamviewerä½“éªŒä¸€èˆ¬ï¼Œæœ‰æ—¶å€™ç™»å½•éƒ½è¦å¾ˆä¹…éå¸¸å¡é¡¿ï¼Œæœ‰æ—¶åˆå¾ˆæµç•…ï¼Œä¸ç¨³å®šã€‚æœ‰äº†å…¬ç½‘ipåæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨windowsè‡ª<strong>è¿œç¨‹æ¡Œé¢è¿æ¥</strong>äº† <img src="https://blog.wenboo.top/wp-content/uploads/2018/12/c2005d789570ee1f575463623fdcfd01.png" alt=""> è®°å¾—æ‰“å¼€è·¯ç”±å™¨ç«¯å£è½¬å‘ 3389ï¼ˆé»˜è®¤ï¼Œå¯ä»¥ä¿®æ”¹ï¼‰ç«¯å£ æ‰‹æœºç«¯æ¨èå¾®è½¯è‡ªå®¶çš„RD Client Androidå’Œioséƒ½æœ‰</p>]]></content>
    
    
    <categories>
      
      <category>ç½‘ç»œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è¿œç¨‹</tag>
      
      <tag>pc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è®°ä¸€æ¬¡dockeréƒ¨ç½²å®‰è£…fecshop</title>
    <link href="/2018/12/21/%E8%AE%B0%E4%B8%80%E6%AC%A1docker%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85fecshop/"/>
    <url>/2018/12/21/%E8%AE%B0%E4%B8%80%E6%AC%A1docker%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85fecshop/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å…¬å¸éœ€è¦åœ¨è‡ªæœ‰appä¸­åµŒå…¥ä¸€ä¸ªå•†åŸï¼Œåœ¨ç»“åˆå®é™…æƒ…å†µè°ƒç ”åé€‰æ‹©äº†å¼€æºçš„å•†åŸé¡¹**<a href="http://www.fecshop.com/" title="fecshop">fecshop</a>**ã€‚</p><blockquote><p>Fecshopï¼Œæ˜¯ç”±Terryä»2015å¹´åˆå¼€å§‹ï¼Œä¸€ç›´åšæŒåˆ°ä»Šå¤©çš„å¼€æºç”µå•†é¡¹ç›®ï¼Œéå•†ä¸šåŒ–è¿ä½œï¼Œæ˜¯çœŸæ­£ å¼€æºçš„ç”µå•†ç³»ç»Ÿï¼Œ éµå¾ªBSD-3-Clauseå¼€æºåè®®ã€‚</p></blockquote><p><strong>Fecshop å…¨ç§°ä¸ºFancy ECommerce Shopï¼Œæ˜¯åŸºäºphp Yii2æ¡†æ¶ä¹‹ä¸Šå¼€å‘çš„ä¸€æ¬¾ä¼˜ç§€çš„å¼€æºç”µå•†ç³»ç»Ÿï¼Œ éµå¾ªBSD-3-Clauseå¼€æºåè®®ï¼ŒFecshopæ”¯æŒå¤šè¯­è¨€ï¼Œå¤šè´§å¸ï¼Œæ¶æ„ä¸Šæ”¯æŒpcï¼Œæ‰‹æœºwebï¼Œæ‰‹æœºappï¼Œå’Œerpå¯¹æ¥ç­‰å…¥å£ï¼Œæ‚¨å¯ä»¥å…è´¹å¿«é€Ÿçš„å®šåˆ¶å’Œéƒ¨ç½²å±äºæ‚¨çš„ç”µå•†ç³»ç»Ÿã€‚ æˆªæ­¢åˆ°2017-10æœˆï¼Œappfrontï¼ˆpcå‰ç«¯webï¼‰ï¼Œappadminï¼ˆåå°ï¼‰ï¼Œapphtml5ï¼ˆwapç«¯webï¼‰ï¼Œ appserverï¼ˆVUEï¼Œæ‰‹æœºappçš„apiæä¾›ç«¯ï¼‰ï¼Œconsoleï¼ˆå‘½ä»¤è¡Œï¼‰ï¼Œ appapiï¼ˆå’Œç¬¬ä¸‰æ–¹ç³»ç»Ÿé€šä¿¡ç«¯ï¼‰éƒ½å·²ç»å®Œæˆï¼Œç°åœ¨å·²ç»è¶‹äºç¨³å®šï¼Œ Terryåœ¨2010å¹´å¼€å§‹è¿›å…¥è·¨å¢ƒç”µå•†é¢†åŸŸï¼Œ ç”¨äº†ä¸å°‘å¼€æºç”µå•†ç³»ç»Ÿï¼Œè­¬å¦‚magentoï¼Œ å‘ç°å¼€æºæ¡†æ¶éƒ½æœ‰ä¸€å®š çš„è¯Ÿç—…ï¼Œåœ¨å¹¶å‘æ–¹é¢å·®ï¼ŒåæœŸæ‰©å±•ï¼Œä¸šåŠ¡å‘å±•åæœŸé‡æ„éš¾ï¼Œ å°¤å…¶æ˜¯ç°åœ¨çš„ç§»åŠ¨ç«¯çš„å‘å±•ï¼Œå¤šå…¥å£çš„ç”µå•†æ¨¡å¼å æ®ä¸»æµï¼Œ æ€§èƒ½æ–¹é¢çš„è¦æ±‚è¶Šæ¥è¶Šé«˜ï¼ŒFecshopåŸºäºYii2çš„é«˜æ•ˆæ¡†æ¶ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿›ä¸€æ­¥å°è£…ï¼ŒåŠ å…¥äº† serviceå±‚å’Œblockå±‚ï¼Œæ•°æ®åº“é‡‡ç”¨äº†nosqlå’Œmysqlç»“åˆçš„æ–¹å¼ï¼Œ å…³ç³»å‹è¡¨æ”¾åˆ°mysqlä¸­ï¼Œè­¬å¦‚ä¼˜æƒ åˆ¸ï¼Œè´­ç‰©è½¦ï¼Œè®¢å•ç­‰ï¼Œ éå…³ç³»å‹æ•°æ®è¡¨ï¼ˆéå…³ç³»å‹ä»£è¡¨ä¸ä¼šå‡ºç°å¤šè¡¨å¼ºäº‹åŠ¡ç±»å‹æ“ä½œï¼‰ æ”¾åˆ°mongodbä¸­ï¼Œ ç¼“å­˜ç”¨redisï¼Œæœç´¢ç›®å‰ç”¨çš„æ˜¯mongodbçš„FullTextSearchåŠŸèƒ½ï¼Œ æ”¯æŒä¸€äº›ä¸»æµè¯­è¨€çš„åˆ†è¯ä¸æœç´¢ï¼Œå¯¹äºä¸­æ–‡æœç´¢ï¼Œä½¿ç”¨çš„æ˜¯xunsearchã€‚</strong> fecshopå®˜æ–¹æä¾›å‡ ç§å®‰è£…æ–¹æ³•</p><ul><li><p>Docker Compose æ–¹å¼å®‰è£…Fecshop(æ¨è)</p></li><li><p>Vagrant Box æ–¹å¼å®‰è£…Fecshopï¼ˆ2017.6æœˆåšçš„boxï¼Œä»¥åä¸å†ç»´æŠ¤vagrant boxï¼‰</p></li><li><p>linuxä¸‹å•ä¸ªè½¯ä»¶å®‰è£…ï¼ˆåŒ…æ‹¬mysqlã€phpã€mongodbã€xunsearchã€redisï¼‰</p></li></ul><p>æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯ä»¥docker-composeæ–¹å¼æ¥å®‰è£…çš„ï¼Œå®˜æ–¹gitæœ‰æä¾›å®Œæ•´çš„æ–‡æ¡£ï¼ŒæŒ‰ç…§æ–‡æ¡£ç»†å¿ƒä»”ç»†çš„å®‰è£…å°±å¯ä»¥äº†<a href="https://github.com/fecshop/yii2_fecshop_docker" title="fecshop dockerå®‰è£…æ–¹å¼">fecshop dockerå®‰è£…æ–¹å¼</a> é‡åˆ°äº†å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li><p>dockerä¸æ˜¯è™šæ‹Ÿæœº ï¼Œæ²¡æœ‰æ“ä½œdockerçš„ç»éªŒä¸‹å¿…é¡»è¦æœ‰è¿™ä¸ªæ¦‚å¿µï¼Œå®ƒå°†æ¯ä¸€ä¸ªæœåŠ¡ç›¸äº’éš”ç¦»å¼€æ¥äº’ä¸å½±å“ï¼Œè‹¥è¦å¯¹æœåŠ¡è¿›è¡Œæ“ä½œéœ€è¦é€šè¿‡å‘½ä»¤<code>docker-compose exec xxx(å®¹å™¨å) bash</code> è¿›å…¥åˆ°æœåŠ¡æ‰€åœ¨çš„å®¹å™¨å†…ã€‚</p></li><li><p>docker-compose å°†æ•´ä¸ªè¿è¡Œç¯å¢ƒå’ŒæœåŠ¡çš„é…ç½®æ•´åˆåœ¨äº†ä¸€èµ·ï¼Œå¯ä»¥é€šè¿‡docker-compose.ymlæ–‡ä»¶è¿›è¡Œé…ç½®ã€‚</p></li><li><p>åœ¨vueå‰åç«¯åˆ†ç¦»è¿™ä¸ªå…¥å£çš„æ­å»ºæ—¶é‡åˆ°äº†è·¨åŸŸé—®é¢˜ï¼ˆåº”è¯¥å®˜æ–¹bugï¼‰</p></li></ol><p><code>Access to XMLHttpRequest at 'http://appserver.fecshoptest.com/cms/home/index' from origin 'http://vue.fecshop.test' has been blocked by CORS policy: Request header field fecshop-currency is not allowed by Access-Control-Allow-Headers in preflight response.</code> è¦åœ¨è¿™ä¸ªæ–‡ä»¶ä¸‹ä¿®æ”¹ï¼Œæ–°å¢ä¸€ä¸ªåˆ¤æ–­optionsè¯·æ±‚https://github.com/fecshop/yii2_fecshop/blob/master/services/helper/Appserver.php#L183</p><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCors</span>(<span class="hljs-params"></span>)</span>&#123;        $fecshop_uuid = Yii::$service-&gt;session-&gt;fecshop_uuid;        $cors_allow_headers = [$fecshop_uuid, <span class="hljs-string">&#x27;fecshop-lang&#x27;</span>, <span class="hljs-string">&#x27;fecshop-currency&#x27;</span>, <span class="hljs-string">&#x27;access-token&#x27;</span>];        $cors = <span class="hljs-keyword">$this</span>-&gt;appserver_cors;        $corsFilterArr = [];        <span class="hljs-keyword">if</span> (is_array($cors) &amp;&amp; !<span class="hljs-keyword">empty</span>($cors)) &#123;            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($cors[<span class="hljs-string">&#x27;Origin&#x27;</span>]) &amp;&amp; $cors[<span class="hljs-string">&#x27;Origin&#x27;</span>]) &#123;                $corsFilterArr[<span class="hljs-string">&#x27;Origin&#x27;</span>] = $cors[<span class="hljs-string">&#x27;Origin&#x27;</span>];            &#125;            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($cors[<span class="hljs-string">&#x27;Access-Control-Request-Method&#x27;</span>]) &amp;&amp; $cors[<span class="hljs-string">&#x27;Access-Control-Request-Method&#x27;</span>]) &#123;                $corsFilterArr[<span class="hljs-string">&#x27;Access-Control-Request-Method&#x27;</span>] = $cors[<span class="hljs-string">&#x27;Access-Control-Request-Method&#x27;</span>];            &#125;            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($cors[<span class="hljs-string">&#x27;Access-Control-Max-Age&#x27;</span>]) &amp;&amp; $cors[<span class="hljs-string">&#x27;Access-Control-Max-Age&#x27;</span>]) &#123;                $corsFilterArr[<span class="hljs-string">&#x27;Access-Control-Max-Age&#x27;</span>] = $cors[<span class="hljs-string">&#x27;Access-Control-Max-Age&#x27;</span>];            &#125;            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($cors[<span class="hljs-string">&#x27;Access-Control-Expose-Headers&#x27;</span>]) &amp;&amp; $cors[<span class="hljs-string">&#x27;Access-Control-Expose-Headers&#x27;</span>]) &#123;                $cors_allow_headers = array_merge($cors_allow_headers, $cors[<span class="hljs-string">&#x27;Access-Control-Expose-Headers&#x27;</span>]);            &#125;            $corsFilterArr[<span class="hljs-string">&#x27;Access-Control-Expose-Headers&#x27;</span>] = $cors_allow_headers;            <span class="hljs-comment">//æ–°å¢è¿™ä¸ªåˆ¤æ–­</span>            <span class="hljs-keyword">if</span>(Yii::$app-&gt;request-&gt;getMethod() === <span class="hljs-string">&#x27;OPTIONS&#x27;</span>)&#123;                $corsFilterArr[<span class="hljs-string">&#x27;Access-Control-Request-Headers&#x27;</span>] = $cors_allow_headers;            &#125;        &#125;        <span class="hljs-keyword">return</span> $corsFilterArr;    &#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>fecshop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ‰¹é‡æŸ¥è¯¢IPåœ°å€å½’å±åœ° è„šæœ¬</title>
    <link href="/2018/12/03/%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2ip%E5%9C%B0%E5%9D%80%E5%BD%92%E5%B1%9E%E5%9C%B0-%E8%84%9A%E6%9C%AC/"/>
    <url>/2018/12/03/%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2ip%E5%9C%B0%E5%9D%80%E5%BD%92%E5%B1%9E%E5%9C%B0-%E8%84%9A%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘éœ€è¦ä»æœåŠ¡å™¨æ—¥å¿—ä¸­è·å–è¯·æ±‚ipçš„æ¥æºåœ°ï¼Œæ‰€ä»¥å†™äº†ä»¥ä¸‹shellè„šæœ¬</p></blockquote><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span>count=`cat $1|wc -l`n=1cat $1 | while read mdoip=`echo $m | awk &#x27;&#123;print $4&#125;&#x27;`addr=`curl -s https://ip.cn/index.php?ip=$&#123;ip&#125;`<span class="hljs-meta">#</span><span class="bash">æ·˜å®è¿™ä¸ªæ¥å£æœ‰ç‚¹é—®é¢˜ï¼Œæ‰¹é‡è·å–æ—¶ä¼šæœ‰è¯·æ±‚ä¸åˆ°æ•°æ®çš„æƒ…å†µ</span><span class="hljs-meta">#</span><span class="bash">addr=`curl -s http://ip.taobao.com/service/getIpInfo.php?ip=<span class="hljs-variable">$&#123;ip&#125;</span>|awk -F <span class="hljs-string">&#x27;&quot;&#x27;</span> <span class="hljs-string">&#x27;&#123;print  $12,$20&#125;&#x27;</span>`</span>echo &quot;`echo $m|awk &#x27;&#123;print $1,$2,$3&#125;&#x27;` $&#123;addr&#125; æ€»æ•°ï¼š$&#123;count&#125; å®Œæˆï¼š$&#123;n&#125;&quot;echo &quot;`echo $m|awk &#x27;&#123;print $1,$2,$3&#125;&#x27;` $&#123;addr&#125;&quot; &gt;&gt; ip_addr.txtn=$(($n+1))don</code></pre>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
      <category>shell</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ‰¹é‡ip</tag>
      
      <tag>è„šæœ¬</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JWT</title>
    <link href="/2018/11/15/jwt/"/>
    <url>/2018/11/15/jwt/</url>
    
    <content type="html"><![CDATA[<h4 id="JWTï¼šJson-Web-Token"><a class="header-anchor" href="#JWTï¼šJson-Web-Token"></a>JWTï¼šJson Web Token</h4><p>è·¨åŸŸèº«ä»½è®¤è¯æœ‰å¤šç§æ–¹å¼ï¼ŒJWTå°†ç”¨æˆ·ä¿¡æ¯åŠ å¯†åˆ°tokené‡Œï¼ŒæœåŠ¡å™¨ä¸ä¿å­˜ä»»ä½•ç”¨æˆ·ä¿¡æ¯ã€‚æœåŠ¡å™¨é€šè¿‡ä½¿ç”¨ä¿å­˜çš„å¯†é’¥éªŒè¯tokençš„æ­£ç¡®æ€§ï¼Œåªè¦æ­£ç¡®å³é€šè¿‡éªŒè¯ã€‚ åœ¨äº’è”ç½‘æœåŠ¡å™¨çš„äº¤äº’ä¸­ç¦»ä¸å¼€éªŒè¯ï¼Œæ­¤æ¬¡å¯¹æ¥Google assistant æ™ºèƒ½å®¶å±…Apiæ—¶ï¼Œä½¿ç”¨çš„èº«ä»½éªŒè¯æ–¹å¼ï¼Œæˆ‘é€‰æ‹©çš„å°±æ˜¯JWTã€‚ <strong>é¦–å…ˆ</strong>ï¼Œæˆ‘ä»¬æ¥çœ‹æœ€æ™®éçš„webæœåŠ¡å™¨ç”¨æˆ·éªŒè¯æµç¨‹ã€‚</p><ul><li>ç”¨æˆ·å‘é€ç”¨æˆ·åå’Œå¯†ç ã€‚</li><li>æœåŠ¡å™¨éªŒè¯ç”¨æˆ·åå’Œå¯†ç ï¼ŒæœåŠ¡å™¨é€šè¿‡éªŒè¯ååœ¨å½“å‰å¯¹è¯ï¼ˆsessionï¼‰é‡Œé¢ä¿å­˜ç›¸å…³æ•°æ®ã€‚</li><li>æœåŠ¡å™¨å‘ç”¨æˆ·è¿”å›ä¸€ä¸ªsession_idï¼Œå°†session_idå†™å…¥ç”¨æˆ·cookieé‡Œ</li><li>ç”¨æˆ·åé¢çš„æ¯ä¸€ä¸ªè¯·æ±‚ä¸­éƒ½ä¼šå°†åŒ…å«è¿™ä¸ªsession_id</li><li>æœåŠ¡å™¨é€šè¿‡session_idï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ç”¨æˆ·æ•°æ®</li></ul><p>è¿™ç§æ¨¡å¼åœ¨webæœåŠ¡ä¸­æ™®éå­˜åœ¨ï¼ŒåŸºæœ¬æ˜¯é»˜è®¤çš„ç”¨æˆ·èº«ä»½éªŒè¯æ–¹å¼ï¼Œç”¨èµ·æ¥ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚ä½†æ˜¯å®ƒçš„é—®é¢˜åœ¨äºæ‰©å¼ æ€§éå¸¸å·®ï¼Œåœ¨æœåŠ¡å™¨é›†ç¾¤æˆ–è€…æ˜¯è·¨åŸŸçš„æœåŠ¡å¯¼å‘æ¶æ„ï¼Œå°±æ¶‰åŠåˆ°äº†sessionå…±äº«çš„é—®é¢˜ï¼Œæ¯å°æœåŠ¡å™¨éƒ½éœ€è¦è¯»å–åˆ°sessionä¿¡æ¯ã€‚ è¦è§£å†³sessionå…±äº«çš„æ–¹æ¡ˆæœ‰ï¼š 1. session æ•°æ®æŒä¹…åŒ–ï¼Œå†™å…¥æ•°æ®åº“æˆ–åˆ«çš„æŒä¹…å±‚ã€‚å„ç§æœåŠ¡æ”¶åˆ°è¯·æ±‚åï¼Œéƒ½å‘æŒä¹…å±‚è¯·æ±‚æ•°æ®ã€‚è¿™ç§æ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯æ¶æ„æ¸…æ™°ï¼Œç¼ºç‚¹æ˜¯å·¥ç¨‹é‡æ¯”è¾ƒå¤§ã€‚å¦å¤–ï¼ŒæŒä¹…å±‚ä¸‡ä¸€æŒ‚äº†ï¼Œå°±ä¼šå•ç‚¹å¤±è´¥ã€‚ 2. æœåŠ¡å™¨ç´¢æ€§ä¸ä¿å­˜ session æ•°æ®äº†ï¼Œæ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½å‘å›æœåŠ¡å™¨ã€‚JWT å°±æ˜¯è¿™ç§æ–¹æ¡ˆçš„ä¸€ä¸ªä»£è¡¨ã€‚ <strong>JWT</strong>åŸºæœ¬åŸç† æœåŠ¡å™¨è®¤è¯ä»¥åï¼Œç”Ÿæˆä¸€ä¸ª JSON å¯¹è±¡ï¼Œå‘å›ç»™ç”¨æˆ·ï¼Œå°±åƒä¸‹é¢è¿™æ ·</p><pre><code class="hljs json">&#123;  <span class="hljs-attr">&quot;å§“å&quot;</span>: <span class="hljs-string">&quot;å¼ ä¸‰&quot;</span>,  <span class="hljs-attr">&quot;è§’è‰²&quot;</span>: <span class="hljs-string">&quot;ç®¡ç†å‘˜&quot;</span>,  <span class="hljs-attr">&quot;åˆ°æœŸæ—¶é—´&quot;</span>: <span class="hljs-string">&quot;2018å¹´7æœˆ1æ—¥0ç‚¹0åˆ†&quot;</span>&#125;</code></pre><p>ä»¥åï¼Œç”¨æˆ·ä¸æœåŠ¡ç«¯é€šä¿¡çš„æ—¶å€™ï¼Œéƒ½è¦å‘å›è¿™ä¸ª JSON å¯¹è±¡ã€‚æœåŠ¡å™¨å®Œå…¨åªé è¿™ä¸ªå¯¹è±¡è®¤å®šç”¨æˆ·èº«ä»½ã€‚ä¸ºäº†é˜²æ­¢ç”¨æˆ·ç¯¡æ”¹æ•°æ®ï¼ŒæœåŠ¡å™¨åœ¨ç”Ÿæˆè¿™ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œä¼šåŠ ä¸Š<strong>ç­¾å</strong> JWTé€šå¸¸ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆ</p><ul><li>Headerï¼ˆå¤´éƒ¨ï¼‰</li><li>Payloadï¼ˆè´Ÿè½½ï¼‰</li><li>Signatureï¼ˆç­¾åï¼‰</li></ul><p>é€šè¿‡ç­¾ååŠ å¯†ç”Ÿåçš„æ ·å­å¦‚ä¸‹ <strong>Header.Payload.Signature</strong></p><pre><code class="hljs json">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</code></pre><blockquote><p>header</p></blockquote><pre><code class="hljs json">&#123;  <span class="hljs-attr">&quot;alg&quot;</span>: <span class="hljs-string">&quot;HS256&quot;</span>,  <span class="hljs-attr">&quot;typ&quot;</span>: <span class="hljs-string">&quot;JWT&quot;</span>&#125;</code></pre><p>algå±æ€§è¡¨ç¤ºç­¾åçš„ç®—æ³•ï¼ˆalgorithmï¼‰ï¼Œé»˜è®¤æ˜¯ HMAC SHA256ï¼ˆå†™æˆ HS256ï¼‰ï¼›typå±æ€§è¡¨ç¤ºè¿™ä¸ªä»¤ç‰Œï¼ˆtokenï¼‰çš„ç±»å‹ï¼ˆtypeï¼‰ï¼ŒJWT ä»¤ç‰Œç»Ÿä¸€å†™ä¸ºJWT</p><blockquote><p>Payload</p></blockquote><p>Payload éƒ¨åˆ†ä¹Ÿæ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œç”¨æ¥å­˜æ”¾å®é™…éœ€è¦ä¼ é€’çš„æ•°æ®ã€‚JWT è§„å®šäº†7ä¸ªå®˜æ–¹å­—æ®µï¼Œä¾›é€‰ç”¨ã€‚</p><ul><li>iss (issuer)ï¼šç­¾å‘äºº</li><li>exp (expiration time)ï¼šè¿‡æœŸæ—¶é—´</li><li>sub (subject)ï¼šä¸»é¢˜</li><li>aud (audience)ï¼šå—ä¼—</li><li>nbf (Not Before)ï¼šç”Ÿæ•ˆæ—¶é—´</li><li>iat (Issued At)ï¼šç­¾å‘æ—¶é—´</li><li>jti (JWT ID)ï¼šç¼–å·</li></ul><p>ä¾‹å¦‚ï¼š</p><pre><code class="hljs json">&#123;  <span class="hljs-attr">&quot;sub&quot;</span>: <span class="hljs-string">&quot;1234567890&quot;</span>,  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;John Doe&quot;</span>,  <span class="hljs-attr">&quot;iat&quot;</span>: <span class="hljs-number">1516239022</span>&#125;</code></pre><p><strong>å¹¶ä¸”é™¤äº†å®˜æ–¹å®šä¹‰çš„å­—æ®µï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰å­—æ®µå</strong> æ³¨æ„ï¼ŒJWT é»˜è®¤æ˜¯ä¸åŠ å¯†çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥è¯»åˆ°ï¼Œæ‰€ä»¥ä¸è¦æŠŠç§˜å¯†ä¿¡æ¯æ”¾åœ¨è¿™ä¸ªéƒ¨åˆ†ã€‚ è¿™ä¸ª JSON å¯¹è±¡ä¹Ÿè¦ä½¿ç”¨ Base64URL ç®—æ³•è½¬æˆå­—ç¬¦ä¸²</p><blockquote><p>Signature</p></blockquote><p>Signature éƒ¨åˆ†æ˜¯å¯¹å‰ä¸¤éƒ¨åˆ†çš„ç­¾åï¼Œé˜²æ­¢æ•°æ®ç¯¡æ”¹ã€‚é¦–å…ˆï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªå¯†é’¥ï¼ˆsecretï¼‰ã€‚è¿™ä¸ªå¯†é’¥åªæœ‰æœåŠ¡å™¨æ‰çŸ¥é“ï¼Œä¸èƒ½æ³„éœ²ç»™ç”¨æˆ·ã€‚ç„¶åï¼Œä½¿ç”¨ Header é‡Œé¢æŒ‡å®šçš„ç­¾åç®—æ³•ï¼ˆé»˜è®¤æ˜¯ HMAC SHA256ï¼‰ï¼ŒæŒ‰ç…§ä¸‹é¢çš„å…¬å¼äº§ç”Ÿç­¾åã€‚ç®—å‡ºç­¾åä»¥åï¼ŒæŠŠ Headerã€Payloadã€Signature ä¸‰ä¸ªéƒ¨åˆ†æ‹¼æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªéƒ¨åˆ†ä¹‹é—´ç”¨&quot;ç‚¹&quot;ï¼ˆ.ï¼‰åˆ†éš”ï¼Œå°±å¯ä»¥è¿”å›ç»™ç”¨æˆ·ã€‚</p><blockquote><p>ç‰¹ç‚¹</p></blockquote><ol><li>JWT é»˜è®¤æ˜¯ä¸åŠ å¯†ï¼Œä½†ä¹Ÿæ˜¯å¯ä»¥åŠ å¯†çš„ã€‚ç”ŸæˆåŸå§‹ Token ä»¥åï¼Œå¯ä»¥ç”¨å¯†é’¥å†åŠ å¯†ä¸€æ¬¡ã€‚</li><li>JWT ä¸åŠ å¯†çš„æƒ…å†µä¸‹ï¼Œä¸èƒ½å°†ç§˜å¯†æ•°æ®å†™å…¥ JWTã€‚</li><li>JWT ä¸ä»…å¯ä»¥ç”¨äºè®¤è¯ï¼Œä¹Ÿå¯ä»¥ç”¨äºäº¤æ¢ä¿¡æ¯ã€‚æœ‰æ•ˆä½¿ç”¨ JWTï¼Œå¯ä»¥é™ä½æœåŠ¡å™¨æŸ¥è¯¢æ•°æ®åº“çš„æ¬¡æ•°ã€‚</li><li>JWT çš„æœ€å¤§ç¼ºç‚¹æ˜¯ï¼Œç”±äºæœåŠ¡å™¨ä¸ä¿å­˜ session çŠ¶æ€ï¼Œå› æ­¤æ— æ³•åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­åºŸæ­¢æŸä¸ª tokenï¼Œæˆ–è€…æ›´æ”¹ token çš„æƒé™ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦ JWT ç­¾å‘äº†ï¼Œåœ¨åˆ°æœŸä¹‹å‰å°±ä¼šå§‹ç»ˆæœ‰æ•ˆï¼Œé™¤éæœåŠ¡å™¨éƒ¨ç½²é¢å¤–çš„é€»è¾‘ã€‚</li><li>JWT æœ¬èº«åŒ…å«äº†è®¤è¯ä¿¡æ¯ï¼Œä¸€æ—¦æ³„éœ²ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å¾—è¯¥ä»¤ç‰Œçš„æ‰€æœ‰æƒé™ã€‚ä¸ºäº†å‡å°‘ç›—ç”¨ï¼ŒJWT çš„æœ‰æ•ˆæœŸåº”è¯¥è®¾ç½®å¾—æ¯”è¾ƒçŸ­ã€‚å¯¹äºä¸€äº›æ¯”è¾ƒé‡è¦çš„æƒé™ï¼Œä½¿ç”¨æ—¶åº”è¯¥å†æ¬¡å¯¹ç”¨æˆ·è¿›è¡Œè®¤è¯ã€‚</li><li>ä¸ºäº†å‡å°‘ç›—ç”¨ï¼ŒJWT ä¸åº”è¯¥ä½¿ç”¨ HTTP åè®®æ˜ç ä¼ è¾“ï¼Œè¦ä½¿ç”¨ HTTPS åè®®ä¼ è¾“ã€‚</li></ol><blockquote><p>ä»£ç ç¤ºä¾‹</p></blockquote><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-comment">/**</span><span class="hljs-comment"> * Created by PhpStorm.</span><span class="hljs-comment"> * User: dengbo</span><span class="hljs-comment"> * Date: 2018/10/29</span><span class="hljs-comment"> * Time: 16:44</span><span class="hljs-comment"> */</span><span class="hljs-keyword">namespace</span> <span class="hljs-title">Comm</span>;<span class="hljs-keyword">require_once</span> <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">&#x27;/../vendor/autoload.php&#x27;</span>;<span class="hljs-keyword">use</span> \<span class="hljs-title">Firebase</span>\<span class="hljs-title">JWT</span>\<span class="hljs-title">JWT</span>;<span class="hljs-keyword">use</span> <span class="hljs-title">Log</span>\<span class="hljs-title">LogCat</span>;<span class="hljs-keyword">use</span> <span class="hljs-title">RedisManager</span>\<span class="hljs-title">RedisManager</span>;<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReportStates</span></span>&#123;    <span class="hljs-keyword">private</span> $secretRaw = <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">&#x27;/../Config/jwt.json&#x27;</span>;<span class="hljs-comment">//ç­¾åå¯†é’¥</span>    <span class="hljs-keyword">private</span> $googleToken;    <span class="hljs-keyword">private</span> $jwt;    <span class="hljs-keyword">private</span> $secret;    <span class="hljs-keyword">private</span> $Redis;    <span class="hljs-comment">//è·å–jwt</span>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getJwt</span>(<span class="hljs-params"></span>)</span><span class="hljs-function">    </span>&#123;        $defaultServiceAccount = <span class="hljs-keyword">$this</span>-&gt;secret[<span class="hljs-string">&#x27;client_email&#x27;</span>];        $privateKey = <span class="hljs-keyword">$this</span>-&gt;secret[<span class="hljs-string">&#x27;private_key&#x27;</span>];        $scope = <span class="hljs-string">&#x27;https://www.googleapis.com/auth/homegraph&#x27;</span>;        $token = <span class="hljs-keyword">array</span>(            <span class="hljs-string">&quot;iss&quot;</span> =&gt; $defaultServiceAccount,            <span class="hljs-string">&quot;scope&quot;</span> =&gt; $scope,            <span class="hljs-string">&quot;aud&quot;</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;secret[<span class="hljs-string">&#x27;token_uri&#x27;</span>],            <span class="hljs-string">&quot;iat&quot;</span> =&gt; time(),            <span class="hljs-string">&quot;exp&quot;</span> =&gt; time() + <span class="hljs-number">3600</span>        );        <span class="hljs-comment">//è·å–åŠ å¯†åçš„tokenï¼Œè½¬ä¸ºå­—ç¬¦ä¸²</span>        <span class="hljs-keyword">return</span> JWT::encode($token, $privateKey, <span class="hljs-string">&#x27;RS256&#x27;</span>);    &#125;    <span class="hljs-comment">//è·å–Google jwt token</span>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getToken</span>(<span class="hljs-params"></span>)</span><span class="hljs-function">    </span>&#123;        $options = <span class="hljs-keyword">array</span>(            <span class="hljs-string">&#x27;http&#x27;</span> =&gt; <span class="hljs-keyword">array</span>(                <span class="hljs-string">&#x27;method&#x27;</span> =&gt; <span class="hljs-string">&#x27;POST&#x27;</span>,                <span class="hljs-string">&#x27;header&#x27;</span> =&gt; <span class="hljs-string">&#x27;Content-type:application/x-www-form-urlencoded&#x27;</span>,                <span class="hljs-string">&#x27;content&#x27;</span> =&gt; <span class="hljs-string">&#x27;grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&amp;assertion=&#x27;</span>.<span class="hljs-keyword">$this</span>-&gt;jwt,                <span class="hljs-string">&#x27;timeout&#x27;</span> =&gt; <span class="hljs-number">60</span> <span class="hljs-comment">// è¶…æ—¶æ—¶é—´ï¼ˆå•ä½:sï¼‰</span>            )        );        $context = stream_context_create($options);        $result = file_get_contents(<span class="hljs-keyword">$this</span>-&gt;secret[<span class="hljs-string">&#x27;token_uri&#x27;</span>], <span class="hljs-literal">false</span>, $context);        $token =  json_decode($result, JSON_UNESCAPED_UNICODE)[<span class="hljs-string">&#x27;access_token&#x27;</span>];        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>($token))&#123;            <span class="hljs-keyword">$this</span>-&gt;Redis-&gt;setex(<span class="hljs-string">&quot;google_token:&#123;$this-&gt;agentUserId&#125;&quot;</span>, <span class="hljs-number">3599</span>, $token);            <span class="hljs-keyword">return</span> $token;        &#125;<span class="hljs-keyword">else</span>&#123;            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;        &#125;    &#125;&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>ç½‘ç»œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jwt</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang æ–°æ‰‹å¯èƒ½ä¼šè¸©çš„ 50 ä¸ªå‘  è½¬ï¼šsf</title>
    <link href="/2018/10/26/golang-%E6%96%B0%E6%89%8B%E5%8F%AF%E8%83%BD%E4%BC%9A%E8%B8%A9%E7%9A%84-50-%E4%B8%AA%E5%9D%91-%E8%BD%AC%EF%BC%9Asf/"/>
    <url>/2018/10/26/golang-%E6%96%B0%E6%89%8B%E5%8F%AF%E8%83%BD%E4%BC%9A%E8%B8%A9%E7%9A%84-50-%E4%B8%AA%E5%9D%91-%E8%BD%AC%EF%BC%9Asf/</url>
    
    <content type="html"><![CDATA[<p><strong>Go æ˜¯ä¸€é—¨ç®€å•æœ‰è¶£çš„ç¼–ç¨‹è¯­è¨€ï¼Œä¸å…¶ä»–è¯­è¨€ä¸€æ ·ï¼Œåœ¨ä½¿ç”¨æ—¶ä¸å…ä¼šé‡åˆ°å¾ˆå¤šå‘ï¼Œä¸è¿‡å®ƒä»¬å¤§å¤šä¸æ˜¯ Go æœ¬èº«çš„è®¾è®¡ç¼ºé™·ã€‚å¦‚æœä½ åˆšä»å…¶ä»–è¯­è¨€è½¬åˆ° Goï¼Œé‚£è¿™ç¯‡æ–‡ç« é‡Œçš„å‘å¤šåŠä¼šè¸©åˆ°ã€‚</strong></p><h3 id="åœ°å€ï¼š"><a class="header-anchor" href="#åœ°å€ï¼š"></a>åœ°å€ï¼š</h3><p><a href="https://segmentfault.com/a/1190000013739000" title="https://segmentfault.com/a/1190000013739000">https://segmentfault.com/a/1190000013739000</a></p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è¸©å‘</tag>
      
      <tag>Golang</tag>
      
      <tag>å…¥é—¨</tag>
      
      <tag>æ–°æ‰‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯å¦åœ¨40äº¿ä¸ªæ•´æ•°ä¸­ï¼Ÿ</title>
    <link href="/2018/10/13/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E4%B8%80%E4%B8%AA%E6%95%B0%E6%98%AF%E5%90%A6%E5%9C%A840%E4%BA%BF%E4%B8%AA%E6%95%B4%E6%95%B0%E4%B8%AD%EF%BC%9F/"/>
    <url>/2018/10/13/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E4%B8%80%E4%B8%AA%E6%95%B0%E6%98%AF%E5%90%A6%E5%9C%A840%E4%BA%BF%E4%B8%AA%E6%95%B4%E6%95%B0%E4%B8%AD%EF%BC%9F/</url>
    
    <content type="html"><![CDATA[<h3 id="è½¬è‡³å…¬ä¼—å·ï¼ˆjavaåç«¯æŠ€æœ¯ï¼‰"><a class="header-anchor" href="#è½¬è‡³å…¬ä¼—å·ï¼ˆjavaåç«¯æŠ€æœ¯ï¼‰"></a>è½¬è‡³å…¬ä¼—å·ï¼ˆjavaåç«¯æŠ€æœ¯ï¼‰</h3><p><strong><a href="https://mp.weixin.qq.com/s/sPA2Pw5vDo_9isMy3fuE4A" title="https://mp.weixin.qq.com/s/sPA2Pw5vDo_9isMy3fuE4A">https://mp.weixin.qq.com/s/sPA2Pw5vDo_9isMy3fuE4A</a></strong></p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>40äº¿</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>github ä¸Šä¸€ä¸ªè‰¯å¿ƒçš„PCè½¯ä»¶æ¨èé¡¹ç›®</title>
    <link href="/2018/09/28/github-%E4%B8%8A%E4%B8%80%E4%B8%AA%E8%89%AF%E5%BF%83%E7%9A%84pc%E8%BD%AF%E4%BB%B6%E6%8E%A8%E8%8D%90%E9%A1%B9%E7%9B%AE/"/>
    <url>/2018/09/28/github-%E4%B8%8A%E4%B8%80%E4%B8%AA%E8%89%AF%E5%BF%83%E7%9A%84pc%E8%BD%AF%E4%BB%B6%E6%8E%A8%E8%8D%90%E9%A1%B9%E7%9B%AE/</url>
    
    <content type="html"><![CDATA[<p><strong>å›½å†…æµæ°“è½¯ä»¶æ˜¯å¦‚æ­¤çš„å¤šï¼Œä»¥è‡³äºæˆ‘ä»¬éšä¾¿å®‰è£…ä¸€å®¶å¤§å‚çš„è½¯ä»¶ï¼Œä¸çŸ¥ä¸è§‰çš„å®ƒä¼šç»™ä½ å¸¦æ¥å…¨å®¶ã€‚å…¶å®å›½å†…å¤–æœ‰å¾ˆå¤šä¼˜ç§€çš„windowsè½¯ä»¶å¼€å‘è€…ï¼Œä»–ä»¬åšå‡ºå¥½ç”¨çš„è½¯ä»¶ï¼Œå¹¶æ²¡æœ‰ç—…æ¯’å’Œå¹¿å‘Šã€‚æ— æ„é—´åœ¨gitä¸Šå‘ç°è¿™ä¸ªé¡¹ç›®ï¼Œmarkä¸€ä¸‹ã€‚ã€‚</strong></p><h4 id="ğŸ’»-An-awesome-curated-list-of-best-applications-and-tools-for-Windows"><a class="header-anchor" href="#ğŸ’»-An-awesome-curated-list-of-best-applications-and-tools-for-Windows"></a>ğŸ’» An awesome &amp; curated list of best applications and tools for Windows.</h4><ul><li><p><strong>é¡¹ç›®åœ°å€:</strong> <a href="https://github.com/Awesome-Windows/Awesome" title="https://github.com/Awesome-Windows/Awesome">https://github.com/Awesome-Windows/Awesome</a></p></li><li><p><strong>è¿˜æœ‰å¦ä¸€ä¸ªï¼šç»èµåº”ç”¨</strong> <a href="https://amazing-apps.gitbooks.io/windows-apps-that-amaze-us/content/zh-CN/" title="https://amazing-apps.gitbooks.io/windows-apps-that-amaze-us/content/zh-CN/">https://amazing-apps.gitbooks.io/windows-apps-that-amaze-us/content/zh-CN/</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>gihub</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Github</tag>
      
      <tag>awesome</tag>
      
      <tag>é¡¹ç›®æ¨è</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>phpä¸­æœ€å¸¸ç”¨çš„ç³»ç»Ÿå¸¸é‡</title>
    <link href="/2018/09/28/php%E4%B8%AD%E6%9C%80%E5%B8%B8%E7%94%A8%E7%9A%84%E7%B3%BB%E7%BB%9F%E5%B8%B8%E9%87%8F/"/>
    <url>/2018/09/28/php%E4%B8%AD%E6%9C%80%E5%B8%B8%E7%94%A8%E7%9A%84%E7%B3%BB%E7%BB%9F%E5%B8%B8%E9%87%8F/</url>
    
    <content type="html"><![CDATA[<h4 id="ç³»ç»Ÿå¸¸é‡"><a class="header-anchor" href="#ç³»ç»Ÿå¸¸é‡"></a>ç³»ç»Ÿå¸¸é‡</h4><ul><li><p>FILE å½“å‰PHPæ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„</p></li><li><p>LINE å½“å‰PHPæ–‡ä»¶ä¸­æ‰€åœ¨çš„è¡Œå·</p></li><li><p>FUNCTION å½“å‰å‡½æ•°åï¼Œåªå¯¹å‡½æ•°å†…è°ƒç”¨èµ·ä½œç”¨</p></li><li><p>CLASS å½“å‰ç±»åï¼Œåªå¯¹ç±»èµ·ä½œç”¨</p></li><li><p>PHP_VERSION å½“å‰ä½¿ç”¨çš„PHPç‰ˆæœ¬å·</p></li><li><p>PHP_OS å½“å‰PHPç¯å¢ƒçš„è¿è¡Œæ“ä½œç³»ç»Ÿ</p></li><li><p>TRUE ä¸trueä¸€æ ·</p></li><li><p>FALSE ä¸falseä¸€æ ·</p></li><li><p>M_PI åœ†å‘¨ç‡å¸¸é‡å€¼</p></li><li><p>M_E ç§‘å­¦å¸¸æ•°e</p></li><li><p>M_LOG2E ä»£è¡¨log2</p></li><li><p>eï¼Œä»¥2ä¸ºåº•eçš„å¯¹æ•°</p></li><li><p>M_LOG10E ä»£è¡¨lg</p></li><li><p>eï¼Œä»¥10ä¸ºåº•eçš„å¯¹æ•°</p></li><li><p>M_LN2 2çš„è‡ªç„¶å¯¹æ•°</p></li><li><p>M_LN10 10çš„è‡ªç„¶å¯¹æ•°</p></li><li><p>E_ERROR æœ€è¿‘çš„é”™è¯¯ä¹‹å¤„</p></li><li><p>E_WARNING æœ€è¿‘çš„è­¦å‘Šä¹‹å¤„</p></li><li><p>E_PARSE å‰–æè¯­æ³•æœ‰æ½œåœ¨é—®é¢˜ä¹‹å¤„</p></li><li><p>METHOD è¡¨ç¤ºç±»æ–¹æ³•åï¼Œæ¯”å¦‚B::test</p></li></ul><h4 id="æœåŠ¡å™¨å…¨å±€å˜é‡"><a class="header-anchor" href="#æœåŠ¡å™¨å…¨å±€å˜é‡"></a>æœåŠ¡å™¨å…¨å±€å˜é‡</h4><ul><li><p>$_SERVER è¿”å›æœåŠ¡å™¨ç›¸å…³ä¿¡æ¯ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„</p></li><li><p>$_GET æ‰€æœ‰GETè¯·æ±‚è¿‡æ¥çš„å‚æ•°</p></li><li><p>$_POST æ‰€æœ‰POSTè¿‡æ¥çš„å‚æ•°</p></li><li><p>$_COOKIE æ‰€æœ‰HTTPæäº¤è¿‡æ¥çš„cookie</p></li><li><p>$_FILES æ‰€æœ‰HTTPæäº¤è¿‡æ¥çš„æ–‡ä»¶</p></li><li><p>$_ENV å½“å‰çš„æ‰§è¡Œç¯å¢ƒä¿¡æ¯</p></li><li><p>$_REQUEST ç›¸å½“äº$_POSTã€$_GETã€$_COOKIEæäº¤è¿‡æ¥çš„æ•°æ®ï¼Œå› æ­¤è¿™ä¸ªå˜é‡ä¸å€¼å¾—ä¿¡ä»»</p></li><li><p>$_SESSION sessionä¼šè¯å˜é‡</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>phpå†…ç½®å¸¸é‡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç™¾åº¦doueros æ™ºèƒ½å®¶å±…æŠ€èƒ½å¼€å‘æ€»ç»“</title>
    <link href="/2018/09/19/308/"/>
    <url>/2018/09/19/308/</url>
    
    <content type="html"><![CDATA[<h3 id="ç™¾åº¦doueros-æ™ºèƒ½å®¶å±…æŠ€èƒ½å¼€å‘æ€»ç»“"><a class="header-anchor" href="#ç™¾åº¦doueros-æ™ºèƒ½å®¶å±…æŠ€èƒ½å¼€å‘æ€»ç»“"></a>ç™¾åº¦doueros æ™ºèƒ½å®¶å±…æŠ€èƒ½å¼€å‘æ€»ç»“</h3><ul><li><strong><a href="https://dueros.baidu.com/didp/doc/overall/open-platform-intro_markdown">dueroså®˜æ–¹æ–‡æ¡£</a></strong></li></ul><blockquote><p>å¼€å‘å‡†å¤‡å·¥ä½œ</p></blockquote><ol><li>oauth2.0 æˆæƒ</li></ol><p>æ­¤æ¬¡å¼€å‘æ­å»ºçš„oauth2.0 server ä½¿ç”¨çš„æ˜¯githubä½œè€… <strong>bshaffer</strong> æä¾›çš„ OAuth2 Server PHPæ¡†æ¶ã€‚<a href="http://bshaffer.github.io/oauth2-server-php-docs/">å®˜æ–¹æ–‡æ¡£åœ°å€</a></p><blockquote><p>oauth2.0 å·¥ä½œåŸç†ç®€è¦å›¾è§£</p></blockquote><p><img src="https://s1.ax1x.com/2018/09/19/ie6Rds.gif" alt="ie6Rds.gif"> æˆæƒç›®çš„ï¼šæˆæƒDuerOSå°†è¯†åˆ«åçš„æ§åˆ¶æŒ‡ä»¤ï¼Œå‘ç»™å¼€å‘è€…çš„æœåŠ¡å™¨æˆ–è®¾å¤‡äº‘ã€‚ æˆæƒå†…å®¹è¯´æ˜ æˆæƒåœ°å€ï¼šå¼€å‘è€…æˆæƒDuerOSè®¿é—®çš„æœåŠ¡å™¨æˆ–è®¾å¤‡äº‘åœ°å€ï¼Œéœ€éµå®ˆOAuth 2.0æ ‡å‡†ï¼ˆæ‰“é€šç™¾åº¦è´¦å·å’Œè‡ªæœ‰è´¦å·ï¼‰ã€‚ Client_Idï¼šå¼€å‘è€…åˆ†é…ç»™DuerOS SHçš„Client_ID ClientSecretï¼šå¼€å‘è€…åˆ†é…ç»™DuerOS SHçš„å¯†é’¥ Scopeï¼šè·å–çš„ç”¨æˆ·æ•°æ®çš„æƒé™åˆ—è¡¨(åç§°ï¼Œå¤´åƒï¼Œå¹´é¾„ï¼Œæ€§åˆ«â€¦)ï¼Œå¤šä¸ªæƒé™ä¹‹é—´è¯·ä½¿ç”¨ç©ºæ ¼è¿›è¡Œåˆ†å¼€,æš‚æœªåšç»†åˆ†ã€‚ å›è°ƒåœ°å€ï¼šæ¯ä¸ªæŠ€èƒ½åˆ›å»ºæ—¶ï¼Œåœ¨å¼€æ”¾å¹³å°ä¸Šç”Ÿæˆçš„å”¯ä¸€URLåœ°å€ï¼Œè¯¥åœ°å€ä¸èƒ½ä¿®æ”¹ã€‚ Tokenåœ°å€ï¼šç”¨äºè·å–å¼€å‘è€…çš„Access Tokenï¼Œä»¥ä¾¿DuerOSè®¿é—®ä»–ä»¬çš„æœåŠ¡å™¨ã€‚éœ€è¦éµå®ˆOAuth 2.0æ ‡å‡†åè®®ã€‚ è¯·æ±‚æ–¹å¼ï¼šAccess Tokençš„è¯·æ±‚æ–¹å¼ã€‚ WebServiceï¼šæ™ºèƒ½å®¶å±…è®¾å¤‡çš„è®¾å¤‡äº‘æœåŠ¡éƒ¨ç½²åœ°å€ã€‚</p><blockquote><p>å®ç°ç»“æœæˆæƒç™»å½•å›¾</p></blockquote><p><a href="https://imgchr.com/i/iecieH"><img src="https://s1.ax1x.com/2018/09/19/iecieH.md.jpg" alt="iecieH.md.jpg"></a> ç™»å½•ç•Œé¢ä¸ºhtml5ç”Ÿæˆï¼Œæ¯å½“ç”¨æˆ·åœ¨ç‚¹å‡»æˆæƒæ—¶ç”±äº¿è”æœåŠ¡å™¨è¿”å›ç»™ç™¾åº¦éŸ³å“appï¼Œç”±ç™¾åº¦éŸ³å“appå†…åµŒæ˜¾ç¤ºã€‚ å½“ç”¨æˆ·æ­£ç¡®è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼ˆå’Œæ™ºèƒ½çœ‹å®¶å®å…±ç”¨ï¼‰ç‚¹å‡»ç¡®å®šå³å¯æˆæƒæˆåŠŸï¼Œæ­¤æ—¶æœåŠ¡å™¨ç”Ÿæˆå’Œä¿å­˜access tokenã€refresh tokenå¹¶å‘æ”¾access tokenç»™åˆ°dueroså¹³å°ï¼Œdueroså°†ç”¨æˆ·ä¿¡æ¯å’Œaccess tokenå¯¹åº”ä¿å­˜ã€‚ å½“ç”¨æˆ·è§¦å‘è¯­éŸ³å¦‚ï¼šâ€œå°åº¦å°åº¦ï¼Œæ‰“å¼€ç¯â€æŒ‡ä»¤æ—¶ï¼Œdueroså°†è‡ªç„¶è¯­è¨€é€šè¿‡å¤„ç†ï¼Œç„¶åé€šè¿‡æ™ºèƒ½å®¶å±…åè®®å‘é€å“åº”çš„æŒ‡ä»¤åˆ°äº¿è”è®¾å¤‡äº‘ã€‚</p><blockquote><p>æ™ºèƒ½å®¶å±…åè®®</p></blockquote><p><img src="https://developer-bos.cdn.bcebos.com/c6e4889f-d268-4ce4-b223-9a4f6c808f3f.png" alt="image"></p><blockquote><p><a href="https://dueros.baidu.com/didp/doc/dueros-bot-platform/dbp-smart-home/smart-home-skill/create-smart-skill_markdown">æ™ºèƒ½å®¶å±…åè®®æ–‡æ¡£åœ°å€</a></p></blockquote><p><strong>æœåŠ¡å™¨äº¤äº’æµç¨‹</strong> <img src="https://s1.ax1x.com/2018/09/19/ieRkTJ.gif" alt="ieRkTJ.gif"> æœåŠ¡ç«¯æˆæƒæ ¡éªŒï¼š</p><pre><code class="hljs php"><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;server-&gt;verifyResourceRequest(Request::createFromGlobals())) &#123;            <span class="hljs-comment">//access_tokenå¤±æ•ˆåˆ™ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–æ–°çš„access_tokenå’Œrefresh_token</span>            $refresh = Directives::RefreshToken($payload[<span class="hljs-string">&#x27;accessToken&#x27;</span>]);            $refresh = json_decode($refresh,JSON_UNESCAPED_UNICODE);            <span class="hljs-comment">//åˆ·æ–°ä»¤ç‰Œå¤±æ•ˆ</span>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($refresh[<span class="hljs-string">&#x27;error&#x27;</span>]))&#123;                <span class="hljs-comment">//è¿”å›ä»¤ç‰Œå¤±æ•ˆåˆ°dueros</span>                Directives::ExpiredAccessTokenError();                <span class="hljs-keyword">die</span>;            &#125;</code></pre><pre><code class="hljs php"><span class="hljs-comment">//access tokenè¿‡æœŸ</span>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">expiredAccessTokenError</span>(<span class="hljs-params"></span>)</span><span class="hljs-function">    </span>&#123;        $jsonArr = [            <span class="hljs-string">&#x27;header&#x27;</span> =&gt; [                <span class="hljs-string">&#x27;namespace&#x27;</span> =&gt; <span class="hljs-string">&#x27;DuerOS.ConnectedHome.Discovery&#x27;</span>,                <span class="hljs-string">&#x27;name&#x27;</span> =&gt; <span class="hljs-string">&#x27;ExpiredAccessTokenError&#x27;</span>,                <span class="hljs-string">&#x27;messageId&#x27;</span> =&gt; md5(time()),                <span class="hljs-string">&#x27;payloadVersion&#x27;</span> =&gt; <span class="hljs-string">&#x27;1&#x27;</span>            ],            <span class="hljs-string">&#x27;payload&#x27;</span> =&gt; []        ];        <span class="hljs-built_in">self</span>::duerosJsonResponse($jsonArr);    &#125;</code></pre><p>ç™¾åº¦äº‘å’Œäº¿è”è®¾å¤‡äº‘äº¤äº’å›¾ç®€ä»‹ <a href="https://imgchr.com/i/iefMIH"><img src="https://s1.ax1x.com/2018/09/19/iefMIH.md.png" alt="iefMIH.md.png"></a> å¯¹äºç”¨æˆ·è€Œè¨€</p><ul><li>ç”¨æˆ·å¯¹äºè®¾å¤‡çš„ä½¿ç”¨æ— å…¶ä»–æ”¹å˜ï¼ŒåŒæ ·é€šè¿‡äº¿è”appå°†è®¾å¤‡ç»‘å®šåœ¨ç½‘å…³ã€‚</li><li>ç”¨æˆ·è¦å°†æ™ºèƒ½éŸ³ç®±å’Œç½‘å…³æˆ–è®¾å¤‡è¿›è¡Œå…³è”çš„å·¥ä½œåªæœ‰ä¸€æ­¥ï¼Œåœ¨å°åº¦éŸ³ç®±appæ‰¾åˆ°â€œäº¿è”æ™ºèƒ½å®¶å±…â€æŠ€èƒ½è¿›è¡Œæˆæƒå³å¯ã€‚</li><li>äº¿è”å­è´¦å·é€šè¿‡æˆæƒåä¹Ÿå¯å¯¹è®¾å¤‡è¿›è¡Œæ“ä½œ</li><li>è®¾å¤‡çš„æ–°å¢ã€åˆ é™¤é‡å‘½åç­‰æ“ä½œåœ¨äº¿è”appä¸­è®¾å¤‡å®Œæˆåä¼šè‡ªåŠ¨åŒæ­¥åˆ°dueroså¹³å°ï¼Œæ— éœ€åšå…¶ä»–é™„åŠ æ“ä½œã€‚</li><li>ç”±äºäº¿è”æ§åˆ¶äº‘ç«¯æ¶æ„ç‰¹æ®Šæ€§ï¼ˆå­ä¸»å¸å·ï¼‰ï¼Œè¢«è¸¢ç½‘çš„ç”¨æˆ·å°†ä¼šéœ€è¦é‡æ–°åˆ°å°åº¦éŸ³ç®±appè¿›è¡Œæˆæƒç™»å½•ï¼ˆå‡å¦‚ä»–æ˜¯å­è´¦å·ä¹Ÿæ˜¯ä¸»è´¦å·ä¹Ÿæ˜¯åŒæ ·çš„ï¼‰ã€‚</li></ul><p>ç™»å½•å°åº¦éŸ³ç®±appåï¼Œèƒ½å¤Ÿå¯è§†åŒ–çœ‹åˆ°è‡ªå·±çš„è®¾å¤‡ä¿¡æ¯ã€‚ <a href="https://imgchr.com/i/ie4Fjx"><img src="https://s1.ax1x.com/2018/09/19/ie4Fjx.md.jpg" alt="ie4Fjx.md.jpg"></a></p><blockquote><p>æ›´å¤š <a href="https://dueros.baidu.com/forum/topic/show/290891">ã€ å¼€å‘æŒ‡å— ã€‘æ™ºèƒ½å®¶å±…æŠ€èƒ½</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>æ™ºèƒ½è¯­éŸ³</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç™¾åº¦</tag>
      
      <tag>dueros</tag>
      
      <tag>æ™ºèƒ½å®¶å±…</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PHPå¹¶å‘IOç¼–ç¨‹ä¹‹è·¯</title>
    <link href="/2018/09/14/%E8%BD%AC%EF%BC%9Aphp%E5%8D%8F%E7%A8%8B%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3/"/>
    <url>/2018/09/14/%E8%BD%AC%EF%BC%9Aphp%E5%8D%8F%E7%A8%8B%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<p>å¹¶å‘ IO é—®é¢˜ä¸€ç›´æ˜¯æœåŠ¡å™¨ç«¯ç¼–ç¨‹ä¸­çš„æŠ€æœ¯éš¾é¢˜ï¼Œä»æœ€æ—©çš„åŒæ­¥é˜»å¡ç›´æ¥ Fork è¿›ç¨‹ï¼Œåˆ° Worker è¿›ç¨‹æ± /çº¿ç¨‹æ± ï¼Œåˆ°ç°åœ¨çš„å¼‚æ­¥IOã€åç¨‹ã€‚PHP ç¨‹åºå‘˜å› ä¸ºæœ‰å¼ºå¤§çš„ LAMP æ¡†æ¶ï¼Œå¯¹è¿™ç±»åº•å±‚æ–¹é¢çš„çŸ¥è¯†çŸ¥ä¹‹ç”šå°‘ï¼Œæœ¬æ–‡ç›®çš„å°±æ˜¯è¯¦ç»†ä»‹ç» PHP è¿›è¡Œå¹¶å‘ IO ç¼–ç¨‹çš„å„ç§å°è¯•ï¼Œæœ€åå†ä»‹ç» Swoole çš„ä½¿ç”¨ï¼Œæ·±å…¥æµ…å‡ºå…¨é¢è§£æå¹¶å‘ IO é—®é¢˜ã€‚</p><h3 id="å¤šè¿›ç¨‹-å¤šçº¿ç¨‹åŒæ­¥é˜»å¡"><a class="header-anchor" href="#å¤šè¿›ç¨‹-å¤šçº¿ç¨‹åŒæ­¥é˜»å¡"></a>å¤šè¿›ç¨‹/å¤šçº¿ç¨‹åŒæ­¥é˜»å¡</h3><p>æœ€æ—©çš„æœåŠ¡å™¨ç«¯ç¨‹åºéƒ½æ˜¯é€šè¿‡å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹æ¥è§£å†³å¹¶å‘IOçš„é—®é¢˜ã€‚è¿›ç¨‹æ¨¡å‹å‡ºç°çš„æœ€æ—©ï¼Œä» Unix ç³»ç»Ÿè¯ç”Ÿå°±å¼€å§‹æœ‰äº†è¿›ç¨‹çš„æ¦‚å¿µã€‚æœ€æ—©çš„æœåŠ¡å™¨ç«¯ç¨‹åºä¸€èˆ¬éƒ½æ˜¯ Accept ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥å°±åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œç„¶åå­è¿›ç¨‹è¿›å…¥å¾ªç¯åŒæ­¥é˜»å¡åœ°ä¸å®¢æˆ·ç«¯è¿æ¥è¿›è¡Œäº¤äº’ï¼Œæ”¶å‘å¤„ç†æ•°æ®ã€‚</p><p><img src="http://rango.swoole.com/static/io/4.png" alt="" title="4"></p><p>å¤šçº¿ç¨‹æ¨¡å¼å‡ºç°è¦æ™šä¸€äº›ï¼Œçº¿ç¨‹ä¸è¿›ç¨‹ç›¸æ¯”æ›´è½»é‡ï¼Œè€Œä¸”çº¿ç¨‹ä¹‹é—´æ˜¯å…±äº«å†…å­˜å †æ ˆçš„ï¼Œæ‰€ä»¥ä¸åŒçš„çº¿ç¨‹ä¹‹é—´äº¤äº’éå¸¸å®¹æ˜“å®ç°ã€‚æ¯”å¦‚èŠå¤©å®¤è¿™æ ·çš„ç¨‹åºï¼Œå®¢æˆ·ç«¯è¿æ¥ä¹‹é—´å¯ä»¥äº¤äº’ï¼Œæ¯”èŠå¤©å®¤ä¸­çš„ç©å®¶å¯ä»¥ä»»æ„çš„å…¶ä»–äººå‘æ¶ˆæ¯ã€‚ç”¨å¤šçº¿ç¨‹æ¨¡å¼å®ç°éå¸¸ç®€å•ï¼Œçº¿ç¨‹ä¸­å¯ä»¥ç›´æ¥å‘æŸä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥å‘é€æ•°æ®ã€‚è€Œå¤šè¿›ç¨‹æ¨¡å¼å°±è¦ç”¨åˆ°ç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜ï¼Œç»Ÿç§°è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰å¤æ‚çš„æŠ€æœ¯æ‰èƒ½å®ç°ã€‚</p><p>ä»£ç å®ä¾‹ï¼š</p><p><img src="http://rango.swoole.com/static/io/1.png" alt="" title="å®ä¾‹1"></p><p>å¤šè¿›ç¨‹/çº¿ç¨‹æ¨¡å‹çš„æµç¨‹æ˜¯</p><ol><li>åˆ›å»ºä¸€ä¸ª socketï¼Œç»‘å®šæœåŠ¡å™¨ç«¯å£ï¼ˆbindï¼‰ï¼Œç›‘å¬ç«¯å£ï¼ˆlistenï¼‰ï¼Œåœ¨PHPä¸­ç”¨stream_socket_serverä¸€ä¸ªå‡½æ•°å°±èƒ½å®Œæˆä¸Šé¢3ä¸ªæ­¥éª¤ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´åº•å±‚çš„socketsæ‰©å±•åˆ†åˆ«å®ç°ã€‚</li><li>è¿›å…¥whileå¾ªç¯ï¼Œé˜»å¡åœ¨acceptæ“ä½œä¸Šï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥è¿›å…¥ã€‚æ­¤æ—¶ç¨‹åºä¼šè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç›´åˆ°æœ‰æ–°çš„å®¢æˆ·ç«¯å‘èµ·connectåˆ°æœåŠ¡å™¨ï¼Œæ“ä½œç³»ç»Ÿä¼šå”¤é†’æ­¤è¿›ç¨‹ã€‚acceptå‡½æ•°è¿”å›å®¢æˆ·ç«¯è¿æ¥çš„socket</li><li>ä¸»è¿›ç¨‹åœ¨å¤šè¿›ç¨‹æ¨¡å‹ä¸‹é€šè¿‡forkï¼ˆphp: pcntl_forkï¼‰åˆ›å»ºå­è¿›ç¨‹ï¼Œå¤šçº¿ç¨‹æ¨¡å‹ä¸‹ä½¿ç”¨pthread_createï¼ˆphp: new Threadï¼‰åˆ›å»ºå­çº¿ç¨‹ã€‚ä¸‹æ–‡å¦‚æ— ç‰¹æ®Šå£°æ˜å°†ä½¿ç”¨è¿›ç¨‹åŒæ—¶è¡¨ç¤ºè¿›ç¨‹/çº¿ç¨‹ã€‚</li><li>å­è¿›ç¨‹åˆ›å»ºæˆåŠŸåè¿›å…¥whileå¾ªç¯ï¼Œé˜»å¡åœ¨recvï¼ˆphp: freadï¼‰è°ƒç”¨ä¸Šï¼Œç­‰å¾…å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®ã€‚æ”¶åˆ°æ•°æ®åæœåŠ¡å™¨ç¨‹åºè¿›è¡Œå¤„ç†ç„¶åä½¿ç”¨sendï¼ˆphp: fwriteï¼‰å‘å®¢æˆ·ç«¯å‘é€å“åº”ã€‚é•¿è¿æ¥çš„æœåŠ¡ä¼šæŒç»­ä¸å®¢æˆ·ç«¯äº¤äº’ï¼Œè€ŒçŸ­è¿æ¥æœåŠ¡ä¸€èˆ¬æ”¶åˆ°å“åº”å°±ä¼šcloseã€‚</li><li>å½“å®¢æˆ·ç«¯è¿æ¥å…³é—­æ—¶ï¼Œå­è¿›ç¨‹é€€å‡ºå¹¶é”€æ¯æ‰€æœ‰èµ„æºã€‚ä¸»è¿›ç¨‹ä¼šå›æ”¶æ‰æ­¤å­è¿›ç¨‹ã€‚</li></ol><p>è¿™ç§æ¨¡å¼æœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œè¿›ç¨‹/çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€å¾ˆå¤§ã€‚æ‰€ä»¥ä¸Šé¢çš„æ¨¡å¼æ²¡åŠæ³•åº”ç”¨äºéå¸¸ç¹å¿™çš„æœåŠ¡å™¨ç¨‹åºã€‚å¯¹åº”çš„æ”¹è¿›ç‰ˆè§£å†³äº†æ­¤é—®é¢˜ï¼Œè¿™å°±æ˜¯ç»å…¸çš„ <strong>Leader-Follower</strong> æ¨¡å‹ã€‚</p><p>ä»£ç å®ä¾‹ï¼š</p><p><img src="http://rango.swoole.com/static/io/2.png" alt="" title="2"></p><p>å®ƒçš„ç‰¹ç‚¹æ˜¯ç¨‹åºå¯åŠ¨åå°±ä¼šåˆ›å»ºNä¸ªè¿›ç¨‹ã€‚æ¯ä¸ªå­è¿›ç¨‹è¿›å…¥ Acceptï¼Œç­‰å¾…æ–°çš„è¿æ¥è¿›å…¥ã€‚å½“å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªå­è¿›ç¨‹ä¼šè¢«å”¤é†’ï¼Œå¼€å§‹å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¹¶ä¸”ä¸å†æ¥å—æ–°çš„TCPè¿æ¥ã€‚å½“æ­¤è¿æ¥å…³é—­æ—¶ï¼Œå­è¿›ç¨‹ä¼šé‡Šæ”¾ï¼Œé‡æ–°è¿›å…¥ Accept ï¼Œå‚ä¸å¤„ç†æ–°çš„è¿æ¥ã€‚</p><p>è¿™ä¸ªæ¨¡å‹çš„ä¼˜åŠ¿æ˜¯å®Œå…¨å¯ä»¥å¤ç”¨è¿›ç¨‹ï¼Œæ²¡æœ‰é¢å¤–æ¶ˆè€—ï¼Œæ€§èƒ½éå¸¸å¥½ã€‚å¾ˆå¤šå¸¸è§çš„æœåŠ¡å™¨ç¨‹åºéƒ½æ˜¯åŸºäºæ­¤æ¨¡å‹çš„ï¼Œæ¯”å¦‚ Apache ã€PHP-FPMã€‚</p><p>å¤šè¿›ç¨‹æ¨¡å‹ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ã€‚</p><ol><li>è¿™ç§æ¨¡å‹ä¸¥é‡ä¾èµ–è¿›ç¨‹çš„æ•°é‡è§£å†³å¹¶å‘é—®é¢˜ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥å°±éœ€è¦å ç”¨ä¸€ä¸ªè¿›ç¨‹ï¼Œå·¥ä½œè¿›ç¨‹çš„æ•°é‡æœ‰å¤šå°‘ï¼Œå¹¶å‘å¤„ç†èƒ½åŠ›å°±æœ‰å¤šå°‘ã€‚æ“ä½œç³»ç»Ÿå¯ä»¥åˆ›å»ºçš„è¿›ç¨‹æ•°é‡æ˜¯æœ‰é™çš„ã€‚</li><li>å¯åŠ¨å¤§é‡è¿›ç¨‹ä¼šå¸¦æ¥é¢å¤–çš„è¿›ç¨‹è°ƒåº¦æ¶ˆè€—ã€‚æ•°ç™¾ä¸ªè¿›ç¨‹æ—¶å¯èƒ½è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢è°ƒåº¦æ¶ˆè€—å CPUä¸åˆ°1%å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œå¦‚æœå¯åŠ¨æ•°åƒç”šè‡³æ•°ä¸‡ä¸ªè¿›ç¨‹ï¼Œæ¶ˆè€—å°±ä¼šç›´çº¿ä¸Šå‡ã€‚è°ƒåº¦æ¶ˆè€—å¯èƒ½å åˆ° CPU çš„ç™¾åˆ†ä¹‹å‡ åç”šè‡³ 100%ã€‚</li></ol><p>å¦å¤–æœ‰ä¸€äº›åœºæ™¯å¤šè¿›ç¨‹æ¨¡å‹æ— æ³•è§£å†³ï¼Œæ¯”å¦‚å³æ—¶èŠå¤©ç¨‹åºï¼ˆIMï¼‰ï¼Œä¸€å°æœåŠ¡å™¨è¦åŒæ—¶ç»´æŒä¸Šä¸‡ç”šè‡³å‡ åä¸‡ä¸Šç™¾ä¸‡çš„è¿æ¥ï¼ˆç»å…¸çš„C10Ké—®é¢˜ï¼‰ï¼Œå¤šè¿›ç¨‹æ¨¡å‹å°±åŠ›ä¸ä»å¿ƒäº†ã€‚</p><p>è¿˜æœ‰ä¸€ç§åœºæ™¯ä¹Ÿæ˜¯å¤šè¿›ç¨‹æ¨¡å‹çš„è½¯è‚‹ã€‚é€šå¸¸WebæœåŠ¡å™¨å¯åŠ¨100ä¸ªè¿›ç¨‹ï¼Œå¦‚æœä¸€ä¸ªè¯·æ±‚æ¶ˆè€—100msï¼Œ100ä¸ªè¿›ç¨‹å¯ä»¥æä¾›1000qpsï¼Œè¿™æ ·çš„å¤„ç†èƒ½åŠ›è¿˜æ˜¯ä¸é”™çš„ã€‚ä½†æ˜¯å¦‚æœè¯·æ±‚å†…è¦è°ƒç”¨å¤–ç½‘Httpæ¥å£ï¼ŒåƒQQã€å¾®åšç™»å½•ï¼Œè€—æ—¶ä¼šå¾ˆé•¿ï¼Œä¸€ä¸ªè¯·æ±‚éœ€è¦10sã€‚é‚£ä¸€ä¸ªè¿›ç¨‹1ç§’åªèƒ½å¤„ç†0.1ä¸ªè¯·æ±‚ï¼Œ100ä¸ªè¿›ç¨‹åªèƒ½è¾¾åˆ°10qpsï¼Œè¿™æ ·çš„å¤„ç†èƒ½åŠ›å°±å¤ªå·®äº†ã€‚</p><p>æœ‰æ²¡æœ‰ä¸€ç§æŠ€æœ¯å¯ä»¥åœ¨ä¸€ä¸ªè¿›ç¨‹å†…å¤„ç†æ‰€æœ‰å¹¶å‘IOå‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰ï¼Œè¿™å°±æ˜¯IOå¤ç”¨æŠ€æœ¯ã€‚</p><h3 id="IOå¤ç”¨-äº‹ä»¶å¾ªç¯-å¼‚æ­¥éé˜»å¡"><a class="header-anchor" href="#IOå¤ç”¨-äº‹ä»¶å¾ªç¯-å¼‚æ­¥éé˜»å¡"></a>IOå¤ç”¨/äº‹ä»¶å¾ªç¯/å¼‚æ­¥éé˜»å¡</h3><p>å…¶å®IOå¤ç”¨çš„å†å²å’Œå¤šè¿›ç¨‹ä¸€æ ·é•¿ï¼ŒLinuxå¾ˆæ—©å°±æä¾›äº† select ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªè¿›ç¨‹å†…ç»´æŒ1024ä¸ªè¿æ¥ã€‚åæ¥åˆåŠ å…¥äº†pollç³»ç»Ÿè°ƒç”¨ï¼Œpollåšäº†ä¸€äº›æ”¹è¿›ï¼Œè§£å†³äº† 1024 é™åˆ¶çš„é—®é¢˜ï¼Œå¯ä»¥ç»´æŒä»»æ„æ•°é‡çš„è¿æ¥ã€‚ä½†select/pollè¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå®ƒéœ€è¦å¾ªç¯æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰äº‹ä»¶ã€‚è¿™æ ·é—®é¢˜å°±æ¥äº†ï¼Œå¦‚æœæœåŠ¡å™¨æœ‰100ä¸‡ä¸ªè¿æ¥ï¼Œåœ¨æŸä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè¿æ¥å‘æœåŠ¡å™¨å‘é€äº†æ•°æ®ï¼Œselect/polléœ€è¦åšå¾ªç¯100ä¸‡æ¬¡ï¼Œå…¶ä¸­åªæœ‰1æ¬¡æ˜¯å‘½ä¸­çš„ï¼Œå‰©ä¸‹çš„99ä¸‡9999æ¬¡éƒ½æ˜¯æ— æ•ˆçš„ï¼Œç™½ç™½æµªè´¹äº†CPUèµ„æºã€‚</p><p>ç›´åˆ°Linux 2.6å†…æ ¸æä¾›äº†æ–°çš„epollç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥ç»´æŒæ— é™æ•°é‡çš„è¿æ¥ï¼Œè€Œä¸”æ— éœ€è½®è¯¢ï¼Œè¿™æ‰çœŸæ­£è§£å†³äº† C10K é—®é¢˜ã€‚ç°åœ¨å„ç§é«˜å¹¶å‘å¼‚æ­¥IOçš„æœåŠ¡å™¨ç¨‹åºéƒ½æ˜¯åŸºäºepollå®ç°çš„ï¼Œæ¯”å¦‚Nginxã€Node.jsã€Erlangã€Golangã€‚åƒ Node.js è¿™æ ·å•è¿›ç¨‹å•çº¿ç¨‹çš„ç¨‹åºï¼Œéƒ½å¯ä»¥ç»´æŒè¶…è¿‡1ç™¾ä¸‡TCPè¿æ¥ï¼Œå…¨éƒ¨å½’åŠŸäºepollæŠ€æœ¯ã€‚</p><p>IOå¤ç”¨å¼‚æ­¥éé˜»å¡ç¨‹åºä½¿ç”¨ç»å…¸çš„<strong>Reactor</strong>æ¨¡å‹ï¼ŒReactoré¡¾åæ€ä¹‰å°±æ˜¯ååº”å †çš„æ„æ€ï¼Œå®ƒæœ¬èº«ä¸å¤„ç†ä»»ä½•æ•°æ®æ”¶å‘ã€‚åªæ˜¯å¯ä»¥ç›‘è§†ä¸€ä¸ªsocketå¥æŸ„çš„äº‹ä»¶å˜åŒ–ã€‚</p><p><img src="http://rango.swoole.com/static/io/5.png" alt="" title="5"></p><p>Reactoræœ‰4ä¸ªæ ¸å¿ƒçš„æ“ä½œï¼š</p><ol><li>addæ·»åŠ socketç›‘å¬åˆ°reactorï¼Œå¯ä»¥æ˜¯listen socketä¹Ÿå¯ä»¥ä½¿å®¢æˆ·ç«¯socketï¼Œä¹Ÿå¯ä»¥æ˜¯ç®¡é“ã€eventfdã€ä¿¡å·ç­‰</li><li>setä¿®æ”¹äº‹ä»¶ç›‘å¬ï¼Œå¯ä»¥è®¾ç½®ç›‘å¬çš„ç±»å‹ï¼Œå¦‚å¯è¯»ã€å¯å†™ã€‚å¯è¯»å¾ˆå¥½ç†è§£ï¼Œå¯¹äºlisten socketå°±æ˜¯æœ‰æ–°å®¢æˆ·ç«¯è¿æ¥åˆ°æ¥äº†éœ€è¦acceptã€‚å¯¹äºå®¢æˆ·ç«¯è¿æ¥å°±æ˜¯æ”¶åˆ°æ•°æ®ï¼Œéœ€è¦recvã€‚å¯å†™äº‹ä»¶æ¯”è¾ƒéš¾ç†è§£ä¸€äº›ã€‚ä¸€ä¸ªSOCKETæ˜¯æœ‰ç¼“å­˜åŒºçš„ï¼Œå¦‚æœè¦å‘å®¢æˆ·ç«¯è¿æ¥å‘é€2Mçš„æ•°æ®ï¼Œä¸€æ¬¡æ€§æ˜¯å‘ä¸å‡ºå»çš„ï¼Œæ“ä½œç³»ç»Ÿé»˜è®¤TCPç¼“å­˜åŒºåªæœ‰256Kã€‚ä¸€æ¬¡æ€§åªèƒ½å‘256Kï¼Œç¼“å­˜åŒºæ»¡äº†ä¹‹åsendå°±ä¼šè¿”å›EAGAINé”™è¯¯ã€‚è¿™æ—¶å€™å°±è¦ç›‘å¬å¯å†™äº‹ä»¶ï¼Œåœ¨çº¯å¼‚æ­¥çš„ç¼–ç¨‹ä¸­ï¼Œå¿…é¡»å»ç›‘å¬å¯å†™æ‰èƒ½ä¿è¯sendæ“ä½œæ˜¯å®Œå…¨éé˜»å¡çš„ã€‚</li><li>delä»reactorä¸­ç§»é™¤ï¼Œä¸å†ç›‘å¬äº‹ä»¶</li><li>callbackå°±æ˜¯äº‹ä»¶å‘ç”Ÿåå¯¹åº”çš„å¤„ç†é€»è¾‘ï¼Œä¸€èˆ¬åœ¨add/setæ—¶åˆ¶å®šã€‚Cè¯­è¨€ç”¨å‡½æ•°æŒ‡é’ˆå®ç°ï¼ŒJSå¯ä»¥ç”¨åŒ¿åå‡½æ•°ï¼ŒPHPå¯ä»¥ç”¨åŒ¿åå‡½æ•°ã€å¯¹è±¡æ–¹æ³•æ•°ç»„ã€å­—ç¬¦ä¸²å‡½æ•°åã€‚</li></ol><p>Reactoråªæ˜¯ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿå™¨ï¼Œå®é™…å¯¹socketå¥æŸ„çš„æ“ä½œï¼Œå¦‚connect/acceptã€send/recvã€closeæ˜¯åœ¨callbackä¸­å®Œæˆçš„ã€‚å…·ä½“ç¼–ç å¯å‚è€ƒä¸‹é¢çš„ä¼ªä»£ç ï¼š</p><p><img src="http://rango.swoole.com/static/io/6.png" alt=""></p><p>Reactoræ¨¡å‹è¿˜å¯ä»¥ä¸å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹ç»“åˆèµ·æ¥ç”¨ï¼Œæ—¢å®ç°å¼‚æ­¥éé˜»å¡IOï¼Œåˆåˆ©ç”¨åˆ°å¤šæ ¸ã€‚ç›®å‰æµè¡Œçš„å¼‚æ­¥æœåŠ¡å™¨ç¨‹åºéƒ½æ˜¯è¿™æ ·çš„æ–¹å¼ï¼šå¦‚</p><ul><li>Nginxï¼šå¤šè¿›ç¨‹Reactor</li><li>Nginx+Luaï¼šå¤šè¿›ç¨‹Reactor+åç¨‹</li><li>Golangï¼šå•çº¿ç¨‹Reactor+å¤šçº¿ç¨‹åç¨‹</li><li>Swooleï¼šå¤šçº¿ç¨‹Reactor+å¤šè¿›ç¨‹Worker</li></ul><h3 id="åç¨‹æ˜¯ä»€ä¹ˆ"><a class="header-anchor" href="#åç¨‹æ˜¯ä»€ä¹ˆ"></a>åç¨‹æ˜¯ä»€ä¹ˆ</h3><p>åç¨‹ä»åº•å±‚æŠ€æœ¯è§’åº¦çœ‹å®é™…ä¸Šè¿˜æ˜¯å¼‚æ­¥IO Reactoræ¨¡å‹ï¼Œåº”ç”¨å±‚è‡ªè¡Œå®ç°äº†ä»»åŠ¡è°ƒåº¦ï¼Œå€ŸåŠ©Reactoråˆ‡æ¢å„ä¸ªå½“å‰æ‰§è¡Œçš„ç”¨æˆ·æ€çº¿ç¨‹ï¼Œä½†ç”¨æˆ·ä»£ç ä¸­å®Œå…¨æ„ŸçŸ¥ä¸åˆ°Reactorçš„å­˜åœ¨ã€‚</p><h2 id="PHPå¹¶å‘IOç¼–ç¨‹å®è·µ"><a class="header-anchor" href="#PHPå¹¶å‘IOç¼–ç¨‹å®è·µ"></a>PHPå¹¶å‘IOç¼–ç¨‹å®è·µ</h2><h3 id="PHPç›¸å…³æ‰©å±•"><a class="header-anchor" href="#PHPç›¸å…³æ‰©å±•"></a>PHPç›¸å…³æ‰©å±•</h3><ul><li>Streamï¼šPHPå†…æ ¸æä¾›çš„socketå°è£…</li><li>Socketsï¼šå¯¹åº•å±‚Socket APIçš„å°è£…</li><li>Libeventï¼šå¯¹libeventåº“çš„å°è£…</li><li>Eventï¼šåŸºäºLibeventæ›´é«˜çº§çš„å°è£…ï¼Œæä¾›äº†é¢å‘å¯¹è±¡æ¥å£ã€å®šæ—¶å™¨ã€ä¿¡å·å¤„ç†çš„æ”¯æŒ</li><li>Pcntl/Posixï¼šå¤šè¿›ç¨‹ã€ä¿¡å·ã€è¿›ç¨‹ç®¡ç†çš„æ”¯æŒ</li><li>Pthreadï¼šå¤šçº¿ç¨‹ã€çº¿ç¨‹ç®¡ç†ã€é”çš„æ”¯æŒ</li><li>PHPè¿˜æœ‰å…±äº«å†…å­˜ã€ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—çš„ç›¸å…³æ‰©å±•</li><li>PECLï¼šPHPçš„æ‰©å±•åº“ï¼ŒåŒ…æ‹¬ç³»ç»Ÿåº•å±‚ã€æ•°æ®åˆ†æã€ç®—æ³•ã€é©±åŠ¨ã€ç§‘å­¦è®¡ç®—ã€å›¾å½¢ç­‰éƒ½æœ‰ã€‚å¦‚æœPHPæ ‡å‡†åº“ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œå¯ä»¥åœ¨PECLå¯»æ‰¾æƒ³è¦çš„åŠŸèƒ½ã€‚</li></ul><h3 id="PHPè¯­è¨€çš„ä¼˜åŠ£åŠ¿"><a class="header-anchor" href="#PHPè¯­è¨€çš„ä¼˜åŠ£åŠ¿"></a>PHPè¯­è¨€çš„ä¼˜åŠ£åŠ¿</h3><p><img src="http://rango.swoole.com/static/io/3.png" alt="" title="3"></p><p><strong>PHPçš„ä¼˜ç‚¹ï¼š</strong></p><ol><li>ç¬¬ä¸€ä¸ªæ˜¯ç®€å•ï¼ŒPHPæ¯”å…¶ä»–ä»»ä½•çš„è¯­è¨€éƒ½è¦ç®€å•ï¼Œå…¥é—¨çš„è¯PHPçœŸçš„æ˜¯å¯ä»¥ä¸€å‘¨å°±å…¥é—¨ã€‚C<ins>æœ‰ä¸€æœ¬ä¹¦å«åšã€Š21å¤©æ·±å…¥å­¦ä¹ C</ins>ã€‹ï¼Œå…¶å®21å¤©æ ¹æœ¬ä¸å¯èƒ½å­¦ä¼šï¼Œç”šè‡³å¯ä»¥è¯´C++æ²¡æœ‰3-5å¹´ä¸å¯èƒ½æ·±å…¥æŒæ¡ã€‚ä½†æ˜¯PHPç»å¯¹å¯ä»¥7å¤©å…¥é—¨ã€‚æ‰€ä»¥PHPç¨‹åºå‘˜çš„æ•°é‡éå¸¸å¤šï¼Œæ‹›è˜æ¯”å…¶ä»–è¯­è¨€æ›´å®¹æ˜“ã€‚</li><li>PHPçš„åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œå› ä¸ºPHPå®˜æ–¹çš„æ ‡å‡†åº“å’Œæ‰©å±•åº“é‡Œæä¾›äº†åšæœåŠ¡å™¨ç¼–ç¨‹èƒ½ç”¨åˆ°çš„99%çš„ä¸œè¥¿ã€‚PHPçš„PECLæ‰©å±•åº“é‡Œä½ æƒ³è¦çš„ä»»ä½•çš„åŠŸèƒ½ã€‚</li></ol><p>å¦å¤–PHPæœ‰è¶…è¿‡20å¹´çš„å†å²ï¼Œç”Ÿæ€åœˆæ˜¯éå¸¸å¤§çš„ï¼Œåœ¨Githubå¯ä»¥æ‰¾åˆ°å¾ˆå¤šä»£ç ã€‚</p><p><strong>PHPçš„ç¼ºç‚¹ï¼š</strong></p><ol><li>æ€§èƒ½æ¯”è¾ƒå·®ï¼Œå› ä¸ºæ¯•ç«Ÿæ˜¯åŠ¨æ€è„šæœ¬ï¼Œä¸é€‚åˆåšå¯†é›†è¿ç®—ï¼Œå¦‚æœåŒæ ·çš„ PHP ç¨‹åºä½¿ç”¨ C/C++ æ¥å†™ï¼ŒPHP ç‰ˆæœ¬è¦æ¯”å®ƒå·®ä¸€ç™¾å€ã€‚</li><li>å‡½æ•°å‘½åè§„èŒƒå·®ï¼Œè¿™ä¸€ç‚¹å¤§å®¶éƒ½æ˜¯äº†è§£çš„ï¼ŒPHPæ›´è®²ç©¶å®ç”¨æ€§ï¼Œæ²¡æœ‰ä¸€äº›è§„èŒƒã€‚ä¸€äº›å‡½æ•°çš„å‘½åæ˜¯å¾ˆæ··ä¹±çš„ï¼Œæ‰€ä»¥æ¯æ¬¡ä½ å¿…é¡»å»ç¿»PHPçš„æ‰‹å†Œã€‚</li><li>æä¾›çš„æ•°æ®ç»“æ„å’Œå‡½æ•°çš„æ¥å£ç²’åº¦æ¯”è¾ƒç²—ã€‚PHPåªæœ‰ä¸€ä¸ªArrayæ•°æ®ç»“æ„ï¼Œåº•å±‚åŸºäºHashTableã€‚PHPçš„Arrayé›†åˆäº†Mapï¼ŒSetï¼ŒVectorï¼ŒQueueï¼ŒStackï¼ŒHeapç­‰æ•°æ®ç»“æ„çš„åŠŸèƒ½ã€‚å¦å¤–PHPæœ‰ä¸€ä¸ªSPLæä¾›äº†å…¶ä»–æ•°æ®ç»“æ„çš„ç±»å°è£…ã€‚</li></ol><p>æ‰€ä»¥PHP</p><ol><li>PHPæ›´é€‚åˆåå®é™…åº”ç”¨å±‚é¢çš„ç¨‹åºï¼Œä¸šåŠ¡å¼€å‘ã€å¿«é€Ÿå®ç°çš„åˆ©å™¨</li><li>PHPä¸é€‚åˆå¼€å‘åº•å±‚è½¯ä»¶</li><li>ä½¿ç”¨C/C++ã€JAVAã€Golangç­‰é™æ€ç¼–è¯‘è¯­è¨€ä½œä¸ºPHPçš„è¡¥å……ï¼ŒåŠ¨é™ç»“åˆ</li><li>å€ŸåŠ©IDEå·¥å…·å®ç°è‡ªåŠ¨è¡¥å…¨ã€è¯­æ³•æç¤º</li></ol><h2 id="PHPçš„Swooleæ‰©å±•"><a class="header-anchor" href="#PHPçš„Swooleæ‰©å±•"></a>PHPçš„Swooleæ‰©å±•</h2><p>åŸºäºä¸Šé¢çš„æ‰©å±•ä½¿ç”¨çº¯PHPå°±å¯ä»¥å®Œå…¨å®ç°å¼‚æ­¥ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç¨‹åºã€‚ä½†æ˜¯æƒ³å®ç°ä¸€ä¸ªç±»ä¼¼äºå¤šIOçº¿ç¨‹ï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šç¹ççš„ç¼–ç¨‹å·¥ä½œè¦åšï¼ŒåŒ…æ‹¬å¦‚ä½•æ¥ç®¡ç†è¿æ¥ï¼Œå¦‚ä½•æ¥ä¿è¯æ•°æ®çš„æ”¶å‘åŸå­æ€§ï¼Œç½‘ç»œåè®®çš„å¤„ç†ã€‚å¦å¤–PHPä»£ç åœ¨åè®®å¤„ç†éƒ¨åˆ†æ€§èƒ½æ˜¯æ¯”è¾ƒå·®çš„ï¼Œæ‰€ä»¥æˆ‘å¯åŠ¨äº†ä¸€ä¸ªæ–°çš„å¼€æºé¡¹ç›®Swooleï¼Œä½¿ç”¨Cè¯­è¨€å’ŒPHPç»“åˆæ¥å®Œæˆäº†è¿™é¡¹å·¥ä½œã€‚çµæ´»å¤šå˜çš„ä¸šåŠ¡æ¨¡å—ä½¿ç”¨PHPå¼€å‘æ•ˆç‡é«˜ï¼ŒåŸºç¡€çš„åº•å±‚å’Œåè®®å¤„ç†éƒ¨åˆ†ç”¨Cè¯­è¨€å®ç°ï¼Œä¿è¯äº†é«˜æ€§èƒ½ã€‚å®ƒä»¥æ‰©å±•çš„æ–¹å¼åŠ è½½åˆ°äº†PHPä¸­ï¼Œæä¾›äº†ä¸€ä¸ªå®Œæ•´çš„ç½‘ç»œé€šä¿¡çš„æ¡†æ¶ï¼Œç„¶åPHPçš„ä»£ç å»å†™ä¸€äº›ä¸šåŠ¡ã€‚å®ƒçš„æ¨¡å‹æ˜¯åŸºäºå¤šçº¿ç¨‹Reactor+å¤šè¿›ç¨‹Workerï¼Œæ—¢æ”¯æŒå…¨å¼‚æ­¥ï¼Œä¹Ÿæ”¯æŒåŠå¼‚æ­¥åŠåŒæ­¥ã€‚</p><h3 id="Swooleçš„ä¸€äº›ç‰¹ç‚¹ï¼š"><a class="header-anchor" href="#Swooleçš„ä¸€äº›ç‰¹ç‚¹ï¼š"></a>Swooleçš„ä¸€äº›ç‰¹ç‚¹ï¼š</h3><ul><li>Acceptçº¿ç¨‹ï¼Œè§£å†³Acceptæ€§èƒ½ç“¶é¢ˆå’ŒæƒŠç¾¤é—®é¢˜</li><li>å¤šIOçº¿ç¨‹ï¼Œå¯ä»¥æ›´å¥½åœ°åˆ©ç”¨å¤šæ ¸</li><li>æä¾›äº†å…¨å¼‚æ­¥å’ŒåŠåŒæ­¥åŠå¼‚æ­¥2ç§æ¨¡å¼</li><li>å¤„ç†é«˜å¹¶å‘IOçš„éƒ¨åˆ†ç”¨å¼‚æ­¥æ¨¡å¼</li><li>å¤æ‚çš„ä¸šåŠ¡é€»è¾‘éƒ¨åˆ†ç”¨åŒæ­¥æ¨¡å¼</li><li>åº•å±‚æ”¯æŒäº†éå†æ‰€æœ‰è¿æ¥ã€äº’å‘æ•°æ®ã€è‡ªåŠ¨åˆå¹¶æ‹†åˆ†æ•°æ®åŒ…ã€æ•°æ®å‘é€åŸå­æ€§ã€‚</li></ul><h3 id="Swooleçš„è¿›ç¨‹-çº¿ç¨‹æ¨¡å‹ï¼š"><a class="header-anchor" href="#Swooleçš„è¿›ç¨‹-çº¿ç¨‹æ¨¡å‹ï¼š"></a>Swooleçš„è¿›ç¨‹/çº¿ç¨‹æ¨¡å‹ï¼š</h3><p><img src="http://rango.swoole.com/static/io/7.png" alt=""></p><h3 id="Swooleç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼š"><a class="header-anchor" href="#Swooleç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼š"></a>Swooleç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼š</h3><p><img src="http://rango.swoole.com/static/io/8.png" alt=""></p><h2 id="ä½¿ç”¨PHP-Swooleæ‰©å±•å®ç°å¼‚æ­¥é€šä¿¡ç¼–ç¨‹"><a class="header-anchor" href="#ä½¿ç”¨PHP-Swooleæ‰©å±•å®ç°å¼‚æ­¥é€šä¿¡ç¼–ç¨‹"></a>ä½¿ç”¨PHP+Swooleæ‰©å±•å®ç°å¼‚æ­¥é€šä¿¡ç¼–ç¨‹</h2><p>å®ä¾‹ä»£ç åœ¨https://github.com/swoole/swoole-src ä¸»é¡µæŸ¥çœ‹ã€‚</p><h3 id="TCPæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯"><a class="header-anchor" href="#TCPæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯"></a>TCPæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯</h3><p><strong>å¼‚æ­¥<strong><strong>TCP</strong></strong>æœåŠ¡å™¨ï¼š</strong></p><p><img src="http://rango.swoole.com/static/io/9.png" alt=""></p><p>åœ¨è¿™é‡Œnew swoole_serverå¯¹è±¡ï¼Œç„¶åå‚æ•°ä¼ å…¥ç›‘å¬çš„HOSTå’ŒPORTï¼Œç„¶åè®¾ç½®äº†3ä¸ªå›è°ƒå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯onConnectæœ‰æ–°çš„è¿æ¥è¿›å…¥ã€onReceiveæ”¶åˆ°äº†æŸä¸€ä¸ªå®¢æˆ·ç«¯çš„æ•°æ®ã€onCloseæŸä¸ªå®¢æˆ·ç«¯å…³é—­äº†è¿æ¥ã€‚æœ€åè°ƒç”¨startå¯åŠ¨æœåŠ¡å™¨ç¨‹åºã€‚swooleåº•å±‚ä¼šæ ¹æ®å½“å‰æœºå™¨æœ‰å¤šå°‘CPUæ ¸æ•°ï¼Œå¯åŠ¨å¯¹åº”æ•°é‡çš„Reactorçº¿ç¨‹å’ŒWorkerè¿›ç¨‹ã€‚</p><p><strong>å¼‚æ­¥å®¢æˆ·ç«¯ï¼š</strong></p><p><img src="http://rango.swoole.com/static/io/10.png" alt=""></p><p>å®¢æˆ·ç«¯çš„ä½¿ç”¨æ–¹æ³•å’ŒæœåŠ¡å™¨ç±»ä¼¼åªæ˜¯å›è°ƒäº‹ä»¶æœ‰4ä¸ªï¼ŒonConnectæˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¿™æ—¶å¯ä»¥å»å‘é€æ•°æ®åˆ°æœåŠ¡å™¨ã€‚onErrorè¿æ¥æœåŠ¡å™¨å¤±è´¥ã€‚onReceiveæœåŠ¡å™¨å‘å®¢æˆ·ç«¯è¿æ¥å‘é€äº†æ•°æ®ã€‚onCloseè¿æ¥å…³é—­ã€‚</p><p>è®¾ç½®å®Œäº‹ä»¶å›è°ƒåï¼Œå‘èµ·connectåˆ°æœåŠ¡å™¨ï¼Œå‚æ•°æ˜¯æœåŠ¡å™¨çš„IP,PORTå’Œè¶…æ—¶æ—¶é—´ã€‚</p><p><strong>åŒæ­¥å®¢æˆ·ç«¯ï¼š</strong></p><p><img src="http://rango.swoole.com/static/io/11.png" alt=""></p><p>åŒæ­¥å®¢æˆ·ç«¯ä¸éœ€è¦è®¾ç½®ä»»ä½•äº‹ä»¶å›è°ƒï¼Œå®ƒæ²¡æœ‰Reactorç›‘å¬ï¼Œæ˜¯é˜»å¡ä¸²è¡Œçš„ã€‚ç­‰å¾…IOå®Œæˆæ‰ä¼šè¿›å…¥ä¸‹ä¸€æ­¥ã€‚</p><p><strong>å¼‚æ­¥ä»»åŠ¡ï¼š</strong></p><p><img src="http://rango.swoole.com/static/io/12.png" alt=""></p><p>å¼‚æ­¥ä»»åŠ¡åŠŸèƒ½ç”¨äºåœ¨ä¸€ä¸ªçº¯å¼‚æ­¥çš„Serverç¨‹åºä¸­å»æ‰§è¡Œä¸€ä¸ªè€—æ—¶çš„æˆ–è€…é˜»å¡çš„å‡½æ•°ã€‚åº•å±‚å®ç°ä½¿ç”¨è¿›ç¨‹æ± ï¼Œä»»åŠ¡å®Œæˆåä¼šè§¦å‘onFinishï¼Œç¨‹åºä¸­å¯ä»¥å¾—åˆ°ä»»åŠ¡å¤„ç†çš„ç»“æœã€‚æ¯”å¦‚ä¸€ä¸ªIMéœ€è¦å¹¿æ’­ï¼Œå¦‚æœç›´æ¥åœ¨å¼‚æ­¥ä»£ç ä¸­å¹¿æ’­å¯èƒ½ä¼šå½±å“å…¶ä»–äº‹ä»¶çš„å¤„ç†ã€‚å¦å¤–æ–‡ä»¶è¯»å†™ä¹Ÿå¯ä»¥ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡å®ç°ï¼Œå› ä¸ºæ–‡ä»¶å¥æŸ„æ²¡åŠæ³•åƒsocketä¸€æ ·ä½¿ç”¨Reactorç›‘å¬ã€‚å› ä¸ºæ–‡ä»¶å¥æŸ„æ€»æ˜¯å¯è¯»çš„ï¼Œç›´æ¥è¯»å–æ–‡ä»¶å¯èƒ½ä¼šä½¿æœåŠ¡å™¨ç¨‹åºé˜»å¡ï¼Œä½¿ç”¨å¼‚æ­¥ä»»åŠ¡æ˜¯éå¸¸å¥½çš„é€‰æ‹©ã€‚</p><p><strong>å¼‚æ­¥æ¯«ç§’å®šæ—¶å™¨</strong></p><p><img src="http://rango.swoole.com/static/io/13.png" alt=""></p><p>è¿™2ä¸ªæ¥å£å®ç°äº†ç±»ä¼¼JSçš„setIntervalã€setTimeoutå‡½æ•°åŠŸèƒ½ï¼Œå¯ä»¥è®¾ç½®åœ¨næ¯«ç§’é—´éš”å®ç°ä¸€ä¸ªå‡½æ•°æˆ– næ¯«ç§’åæ‰§è¡Œä¸€ä¸ªå‡½æ•°ã€‚</p><p><strong>å¼‚æ­¥<strong><strong>MySQL</strong></strong>å®¢æˆ·ç«¯</strong></p><p><img src="http://rango.swoole.com/static/io/14.png" alt=""></p><p>swooleè¿˜æä¾›ä¸€ä¸ªå†…ç½®è¿æ¥æ± çš„MySQLå¼‚æ­¥å®¢æˆ·ç«¯ï¼Œå¯ä»¥è®¾å®šæœ€å¤§ä½¿ç”¨MySQLè¿æ¥æ•°ã€‚å¹¶å‘SQLè¯·æ±‚å¯ä»¥å¤ç”¨è¿™äº›è¿æ¥ï¼Œè€Œä¸æ˜¯é‡å¤åˆ›å»ºï¼Œè¿™æ ·å¯ä»¥ä¿æŠ¤MySQLé¿å…è¿æ¥èµ„æºè¢«è€—å°½ã€‚</p><p><strong>å¼‚æ­¥<strong><strong>Redis</strong></strong>å®¢æˆ·ç«¯</strong></p><p><img src="http://rango.swoole.com/static/io/15.png" alt=""></p><p><strong>å¼‚æ­¥çš„<strong><strong>Web</strong></strong>ç¨‹åº</strong></p><p><img src="http://rango.swoole.com/static/io/16.png" alt=""></p><p>ç¨‹åºçš„é€»è¾‘æ˜¯ä»Redisä¸­è¯»å–ä¸€ä¸ªæ•°æ®ï¼Œç„¶åæ˜¾ç¤ºHTMLé¡µé¢ã€‚ä½¿ç”¨abå‹æµ‹æ€§èƒ½å¦‚ä¸‹ï¼š</p><p><img src="http://rango.swoole.com/static/io/23.png" alt=""></p><p>åŒæ ·çš„é€»è¾‘åœ¨php-fpmä¸‹çš„æ€§èƒ½æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="http://rango.swoole.com/static/io/24.png" alt=""></p><p><strong>WebSocket****ç¨‹åº</strong></p><p><img src="http://rango.swoole.com/static/io/17.png" alt=""></p><p>swooleå†…ç½®äº†websocketæœåŠ¡å™¨ï¼Œå¯ä»¥åŸºäºæ­¤å®ç°Webé¡µé¢ä¸»åŠ¨æ¨é€çš„åŠŸèƒ½ï¼Œæ¯”å¦‚WebIMã€‚æœ‰ä¸€ä¸ªå¼€æºé¡¹ç›®å¯ä»¥ä½œä¸ºå‚è€ƒã€‚<a href="https://github.com/matyhtf/php-webim">https://github.com/matyhtf/php-webim</a></p><p><img src="http://rango.swoole.com/static/io/18.png" alt=""></p><h3 id="PHP-Swooleåç¨‹"><a class="header-anchor" href="#PHP-Swooleåç¨‹"></a>PHP+Swooleåç¨‹</h3><p>å¼‚æ­¥ç¼–ç¨‹ä¸€èˆ¬ä½¿ç”¨å›è°ƒæ–¹å¼ï¼Œå¦‚æœé‡åˆ°éå¸¸å¤æ‚çš„é€»è¾‘ï¼Œå¯èƒ½ä¼šå±‚å±‚åµŒå¥—å›è°ƒå‡½æ•°ã€‚åç¨‹å°±å¯ä»¥è§£å†³æ­¤é—®é¢˜ï¼Œå¯ä»¥é¡ºåºç¼–å†™ä»£ç ï¼Œä½†è¿è¡Œæ—¶æ˜¯å¼‚æ­¥éé˜»å¡çš„ã€‚è…¾è®¯çš„å·¥ç¨‹å¸ˆåŸºäºSwooleæ‰©å±•å’ŒPHP5.5çš„Yield/Generatorè¯­æ³•å®ç°ç±»ä¼¼äºGolangçš„åç¨‹ï¼Œé¡¹ç›®åç§°ä¸ºTSFï¼ˆTencent Server Frameworkï¼‰ï¼Œå¼€æºé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/tencent-php/tsf%E3%80%82%E7%9B%AE%E5%89%8D%E5%9C%A8%E8%85%BE%E8%AE%AF%E5%85%AC%E5%8F%B8%E7%9A%84%E4%BC%81%E4%B8%9AQQ%E3%80%81QQ%E5%85%AC%E4%BC%97%E5%8F%B7%E9%A1%B9%E7%9B%AE%E4%BB%A5%E5%8F%8A%E8%BD%A6%E8%BD%AE%E5%BF%BD%E7%95%A5%E7%9A%84%E6%9F%A5%E8%BF%9D%E7%AB%A0%E9%A1%B9%E7%9B%AE%E6%9C%89%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%BA%94%E7%94%A8">https://github.com/tencent-php/tsfã€‚ç›®å‰åœ¨è…¾è®¯å…¬å¸çš„ä¼ä¸šQQã€QQå…¬ä¼—å·é¡¹ç›®ä»¥åŠè½¦è½®å¿½ç•¥çš„æŸ¥è¿ç« é¡¹ç›®æœ‰å¤§è§„æ¨¡åº”ç”¨</a> ã€‚</p><p>TSFä½¿ç”¨ä¹Ÿéå¸¸ç®€å•ï¼Œä¸‹é¢è°ƒç”¨äº†3ä¸ªIOæ“ä½œï¼Œå®Œå…¨æ˜¯ä¸²è¡Œçš„å†™æ³•ã€‚ä½†å®é™…ä¸Šæ˜¯å¼‚æ­¥éé˜»å¡æ‰§è¡Œçš„ã€‚TSFåº•å±‚è°ƒåº¦å™¨æ¥ç®¡äº†ç¨‹åºçš„æ‰§è¡Œï¼Œåœ¨å¯¹åº”çš„IOå®Œæˆåæ‰ä¼šå‘ä¸‹ç»§ç»­æ‰§è¡Œã€‚</p><p><img src="http://rango.swoole.com/static/io/19.png" alt=""></p><h3 id="åœ¨æ ‘è“æ´¾ä¸Šä½¿ç”¨PHP-Swoole"><a class="header-anchor" href="#åœ¨æ ‘è“æ´¾ä¸Šä½¿ç”¨PHP-Swoole"></a>åœ¨æ ‘è“æ´¾ä¸Šä½¿ç”¨PHP+Swoole</h3><p>PHPå’ŒSwooleéƒ½å¯ä»¥åœ¨ARMå¹³å°ä¸Šç¼–è¯‘è¿è¡Œï¼Œæ‰€ä»¥åœ¨æ ‘è“æ´¾ç³»ç»Ÿä¸Šä¹Ÿå¯ä»¥ä½¿ç”¨PHP+Swooleæ¥å¼€å‘ç½‘ç»œé€šä¿¡çš„ç¨‹åºã€‚</p><p><img src="http://rango.swoole.com/static/io/20.jpg" alt=""><img src="http://rango.swoole.com/static/io/22.jpg" alt=""></p><blockquote><p>åŸæ–‡ï¼š<a href="http://rango.swoole.com/archives/508">PHPå¹¶å‘IOç¼–ç¨‹ä¹‹è·¯</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PHPçš„è¿‡æ»¤å™¨å‡½æ•°</title>
    <link href="/2018/09/13/php%E7%9A%84%E8%BF%87%E6%BB%A4%E5%99%A8%E5%87%BD%E6%95%B0/"/>
    <url>/2018/09/13/php%E7%9A%84%E8%BF%87%E6%BB%A4%E5%99%A8%E5%87%BD%E6%95%B0/</url>
    
    <content type="html"><![CDATA[<p><strong>PHPä¸­å¾ˆå±Œä½†ç»å¸¸è¢«å„ç§å¿½ç•¥çš„è¿‡æ»¤å™¨å‡½æ•°</strong> PHPå…¶å®è‡ªå¸¦ä¸€äº›åŠŸèƒ½å¼ºå¤§çš„å‡½æ•°ï¼Œåœ¨æˆ‘ä»¬å®ç°æŸä¸ªé€»è¾‘æˆ–åŠŸèƒ½æ—¶ï¼Œç»å¸¸ä¸ä¼šç”¨PHPè‡ªå¸¦çš„å¥½ç”¨çš„å‡½æ•°ï¼Œè€Œå¤§å¤šæ—¶å€™éƒ½æ˜¯é€‰æ‹©ç»•è¿œè·¯çš„æ–¹æ³•è‡ªå·±å»å®ç°ã€‚</p><h4 id="å…ˆæ‹‰ä¸¤ä¸ªå‡ºæ¥é›é›"><a class="header-anchor" href="#å…ˆæ‹‰ä¸¤ä¸ªå‡ºæ¥é›é›"></a>å…ˆæ‹‰ä¸¤ä¸ªå‡ºæ¥é›é›</h4><p><strong>1. filter_has_var</strong> åˆ¤æ–­$_GETä¸­æ˜¯å¦æœ‰æŸä¸ªå­—æ®µå‚æ•°é€šå¸¸çš„å†™æ³•</p><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET[â€œnameâ€])  <span class="hljs-comment">//æˆ–è€…postå‚æ•°ã€æˆ–è€…cookieé‡Œ</span></code></pre><p>å…¶å®è¿˜å¯ä»¥è¿™ä¹ˆå†™</p><pre><code class="hljs php">filter_has_var(INPUT_GET, â€˜nameâ€™) <span class="hljs-comment">//å¯ä»¥ç›´æ¥è¿”å›trueæˆ–false  ç¬¬ä¸€ä¸ªå‚æ•° å¯ä»¥å¡« INPUT_GETã€ INPUT_POSTã€ INPUT_COOKIEã€ INPUT_SERVERã€ INPUT_ENV çœ‹è‹±æ–‡ä½ åº”è¯¥çŸ¥é“ æ˜¯å¹²å•¥çš„</span></code></pre><p><strong>2. filter_var()</strong> æˆ‘ä»¬å‹¤åŠ³çš„phperé€šå¸¸æ¥éªŒè¯é‚®ä»¶æˆ–è€…ç”µè¯çš„æ ¼å¼æ—¶ï¼Œéƒ½ä¼šè¾›è¾›è‹¦è‹¦çš„é€šè¿‡æ­£åˆ™æ¥å®ç°ã€‚ æ¥çœ‹ä¸‹PHPå¯ä»¥çš„å·¥å…·å§</p><pre><code class="hljs php">filter_var(â€˜shenyi@hishenyi.com, FILTER_VALIDATE_EMAIL);</code></pre><p>å¯¹ï¼Œå°±è¿™ä¹ˆç®€å•~~~~ ä»¥å‰çš„ä»£ç ç™½å†™äº†ã€‚ è¿˜æœ‰è¿™ä¹ˆå¤šï¼ŒçœŸæ˜¯å¤ªæ–¹ä¾¿äº†ã€‚ã€‚ <a href="https://imgchr.com/i/iA57Wt"><img src="https://s1.ax1x.com/2018/09/13/iA57Wt.md.png" alt="iA57Wt.md.png"></a> <strong>è¿˜æœ‰æ›´å±Œçš„å‡€åŒ–è¿‡æ»¤</strong> FILTER_SANITIZE_NUMBER_INT è¿‡æ»¤æ‰éæ•°å­—å‹çš„å†…å®¹</p><pre><code class="hljs php"><span class="hljs-keyword">echo</span> filter_var(â€˜abc123â€™, FILTER_SANITIZE_NUMBER_INT);   <span class="hljs-comment">//ç›´æ¥è¿”å›123</span></code></pre><p>è¿˜æœ‰æ›´å¤šã€‚ã€‚ã€‚ <a href="https://imgchr.com/i/iAIQl6"><img src="https://s1.ax1x.com/2018/09/13/iAIQl6.md.png" alt="iAIQl6.md.png"></a> ä¸å¾—ä¸è¯´PHPçœŸçš„æ˜¯ä¸–ç•Œä¸Šæœ€å¥½çš„è¯­è¨€å•Š å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ <a href="https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=1926707095,4273239503&amp;fm=27&amp;gp=0.jpg" title="æ»‘ç¨½"><img src="https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=1926707095,4273239503&amp;fm=27&amp;gp=0.jpg" alt="æ»‘ç¨½" title="æ»‘ç¨½"></a></p>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>è¿‡æ»¤</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux ä¿®æ”¹æ—¶åŒºå’Œæ—¶é—´</title>
    <link href="/2018/09/06/linux-%E4%BF%AE%E6%94%B9%E6%97%B6%E5%8C%BA%E5%92%8C%E6%97%B6%E9%97%B4/"/>
    <url>/2018/09/06/linux-%E4%BF%AE%E6%94%B9%E6%97%B6%E5%8C%BA%E5%92%8C%E6%97%B6%E9%97%B4/</url>
    
    <content type="html"><![CDATA[<p><strong>æŸ¥çœ‹æ—¶åŒº</strong> <code>date -R</code> <strong>è®¾ç½®æ—¶åŒº</strong> <code>tzselect</code> <strong>å¤åˆ¶ç›¸åº”çš„æ—¶åŒºæ–‡ä»¶ï¼Œæ›¿æ¢ç³»ç»Ÿæ—¶åŒºæ–‡ä»¶ï¼›æˆ–è€…åˆ›å»ºé“¾æ¥æ–‡ä»¶</strong> <code>cp /usr/share/zoneinfo/$ä¸»æ—¶åŒº/$æ¬¡æ—¶åŒº /etc/localtime</code> ä¾‹å¦‚ï¼šä¸Šæµ· <code>cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</code> <strong>å°†å½“å‰æ—¶é—´å’Œæ—¥æœŸå†™å…¥BIOSï¼Œé¿å…é‡å¯åå¤±æ•ˆ</strong> <code>hwclock -w</code></p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ä¿®æ”¹æ—¶åŒºæ—¶é—´</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å…³é—­VirtualBoxè™šæ‹Ÿæœºçš„æ—¶é’ŸåŒæ­¥</title>
    <link href="/2018/09/05/%E5%85%B3%E9%97%ADvirtualbox%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E6%97%B6%E9%92%9F%E5%90%8C%E6%AD%A5/"/>
    <url>/2018/09/05/%E5%85%B3%E9%97%ADvirtualbox%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E6%97%B6%E9%92%9F%E5%90%8C%E6%AD%A5/</url>
    
    <content type="html"><![CDATA[<p><strong>ä½¿ç”¨VirtualBoxä½œä¸ºè™šæ‹Ÿæ“ä½œç³»ç»Ÿè½½ä½“ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ä¸»æœºä¸è™šæ‹Ÿæœºæ—¶é—´åŒæ­¥ä¸€è‡´ï¼Œæœ‰æ—¶å€™éœ€è¦ä¸¤è€…ä¹‹é—´æ—¶é—´ä¸ä¸€è‡´ï¼Œç»è¿‡æ•´ç†ä¸»è¦å­˜åœ¨ä»¥ä¸‹ä¸¤ç§æ–¹æ¡ˆã€‚</strong></p><h4 id="æ–¹æ¡ˆ1"><a class="header-anchor" href="#æ–¹æ¡ˆ1"></a>æ–¹æ¡ˆ1</h4><ul><li>å…³é—­æ—¶é—´åŒæ­¥</li></ul><pre><code class="hljs shell">VBoxManage setextradata &lt;è™šæ‹Ÿæœºå/è™šæ‹ŸæœºUUID&gt; &quot;VBoxInternal/Devices/VMMDev/0/Config/GetHostTimeDisabled&quot; &quot;1&quot;</code></pre><ul><li>æ‰“å¼€æ—¶é—´åŒæ­¥</li></ul><pre><code class="hljs shell">VBoxManage setextradata &lt;è™šæ‹Ÿæœºå/è™šæ‹ŸæœºUUID&gt; &quot;VBoxInternal/Devices/VMMDev/0/Config/GetHostTimeDisabled&quot; &quot;0&quot;</code></pre><h4 id="æ–¹æ¡ˆ2"><a class="header-anchor" href="#æ–¹æ¡ˆ2"></a>æ–¹æ¡ˆ2</h4><ul><li><p>å…³é—­æ—¶é—´åŒæ­¥ <code>vboxmanage guestproperty set &lt;è™šæ‹Ÿæœºå/è™šæ‹ŸæœºUUID&gt; --timesync-set-stop</code></p></li><li><p>æ‰“å¼€æ—¶é—´åŒæ­¥ <code>vboxmanage guestproperty set &lt;è™šæ‹Ÿæœºå/è™šæ‹ŸæœºUUID&gt; --timesync-set-start</code></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>vagrant</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è™šæ‹Ÿæœº</tag>
      
      <tag>VirtualBox</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux cpuå ç”¨ç‡ç›‘æ§è„šæœ¬</title>
    <link href="/2018/08/29/linux-cpu%E5%8D%A0%E7%94%A8%E7%8E%87%E7%9B%91%E6%8E%A7%E8%84%9A%E6%9C%AC/"/>
    <url>/2018/08/29/linux-cpu%E5%8D%A0%E7%94%A8%E7%8E%87%E7%9B%91%E6%8E%A7%E8%84%9A%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<p><strong>/proc/statï¼š</strong> è¿™ä¸ªæ–‡ä»¶åŒ…å«äº†æ‰€æœ‰CPUæ´»åŠ¨çš„ä¿¡æ¯ï¼Œè¯¥æ–‡ä»¶ä¸­çš„æ‰€æœ‰å€¼éƒ½æ˜¯ä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ã€‚å¯ä»¥åˆ©ç”¨å…¶ä¸­ä¿¡æ¯è®¡ç®—cpuçš„åˆ©ç”¨ç‡ã€‚ <code>cat /proc/stat</code> <img src="https://s1.ax1x.com/2018/08/29/PXK2tO.png" alt="PXK2tO.png"> æ¯è¡Œæ¯ä¸ªå‚æ•°çš„æ„æ€ä¸ºï¼ˆä»¥ç¬¬ä¸€è¡Œä¸ºä¾‹ï¼Œå•ä½ï¼šjiffiesï¼Œ1jiffies=0.01ç§’ï¼‰ï¼š userï¼ˆ1062726189ï¼‰ï¼šä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ï¼Œç”¨æˆ·æ€çš„CPUæ—¶é—´ï¼Œä¸åŒ…å« niceå€¼ä¸ºè´Ÿè¿›ç¨‹ã€‚ niceï¼ˆ0ï¼‰ï¼šä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ã€‚ systemï¼ˆ264108894ï¼‰ï¼šä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ï¼Œniceå€¼ä¸ºè´Ÿçš„è¿›ç¨‹æ‰€å ç”¨çš„CPUæ—¶é—´ã€‚ idleï¼ˆ2695159767ï¼‰ï¼šä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ï¼Œé™¤ç¡¬ç›˜IOç­‰å¾…æ—¶é—´ä»¥å¤–å…¶å®ƒç­‰å¾…æ—¶é—´ã€‚ iowaitï¼ˆ2950374ï¼‰ï¼šä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ï¼Œç¡¬ç›˜IOç­‰å¾…æ—¶é—´ã€‚ irqï¼ˆ0ï¼‰ï¼šä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ï¼Œç¡¬ä¸­æ–­æ—¶é—´ã€‚ softirqï¼ˆ45899110ï¼‰ï¼šä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ï¼Œè½¯ä¸­æ–­æ—¶é—´ã€‚ CPUæ—¶é—´=user+nice+system+idle+iowait+irq+softirqã€‚ CPUåˆ©ç”¨ç‡=(idle2-idle1)/(cpu2-cpu1)*100ã€‚</p><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span>interval=3cpu_num=`cat /proc/stat | grep cpu[0-9] -c`start_idle=()start_total=()cpu_rate=()while (true) do    start=$(cat /proc/stat | grep &quot;cpu &quot; | awk &#x27;&#123;print $2&quot; &quot;$3&quot; &quot;$4&quot; &quot;$5&quot; &quot;$6&quot; &quot;$7&quot; &quot;$8&#125;&#x27;)    start_idle[$&#123;cpu_num&#125;]=$(echo $&#123;start&#125; | awk &#x27;&#123;print $4&#125;&#x27;)    start_total[$&#123;cpu_num&#125;]=$(echo $&#123;start&#125; | awk &#x27;&#123;printf &quot;%.f&quot;,$1+$2+$3+$4+$5+$6+$7&#125;&#x27;)    sleep $&#123;interval&#125;    end=$(cat /proc/stat | grep &quot;cpu &quot; | awk &#x27;&#123;print $2&quot; &quot;$3&quot; &quot;$4&quot; &quot;$5&quot; &quot;$6&quot; &quot;$7&quot; &quot;$8&#125;&#x27;)    end_idle=$(echo $&#123;end&#125; | awk &#x27;&#123;print $4&#125;&#x27;)    end_total=$(echo $&#123;end&#125; | awk &#x27;&#123;printf &quot;%.f&quot;,$1+$2+$3+$4+$5+$6+$7&#125;&#x27;)    idle=`expr $&#123;end_idle&#125; - $&#123;start_idle[$cpu_num]&#125;`    total=`expr $&#123;end_total&#125; - $&#123;start_total[$cpu_num]&#125;`    idle_normal=`expr $&#123;idle&#125; \* 100`    cpu_usage=`expr $&#123;idle_normal&#125; / $&#123;total&#125;`    cpu_rate[$&#123;cpu_num&#125;]=`expr 100 - $&#123;cpu_usage&#125;`    echo &quot;The Average CPU Rate : $&#123;cpu_rate[$&#123;cpu_num&#125;]&#125;%&quot;    echo &quot;------------------&quot;done</code></pre>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
      <category>shell</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linuxè„šæœ¬</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>workerman è°ƒè¯•busyè¿›ç¨‹</title>
    <link href="/2018/08/29/workerman-%E8%B0%83%E8%AF%95busy%E8%BF%9B%E7%A8%8B/"/>
    <url>/2018/08/29/workerman-%E8%B0%83%E8%AF%95busy%E8%BF%9B%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<ul><li>ä½¿ç”¨<code>php start.php status</code>æŸ¥çœ‹wokermançŠ¶æ€ï¼Œè¿›ç¨‹çŠ¶æ€ä¸ºbusyï¼Œæ˜å¯¹åº”è¿›ç¨‹æ­£åœ¨å¤„ç†ä¸šåŠ¡ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¸šåŠ¡å¤„ç†å®Œæ¯•å¯¹åº”è¿›ç¨‹ä¼šæ¢å¤ä¸ºidleçŠ¶æ€ï¼Œè¿™ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚è‹¥è¿›ç¨‹æŒç»­å¾ˆä¹…éƒ½æ²¡æœ‰æ¢å¤åˆ°idleçŠ¶æ€ï¼Œè¿™è¯´æ˜è¿›ç¨‹ä¸šåŠ¡å·²ç»å‡ºç°å¼‚å¸¸ã€‚</li></ul><h4 id="åˆ©ç”¨strace-lsofå‘½ä»¤å®šä½"><a class="header-anchor" href="#åˆ©ç”¨strace-lsofå‘½ä»¤å®šä½"></a>åˆ©ç”¨strace+lsofå‘½ä»¤å®šä½</h4><ol><li>åˆ©ç”¨<code>php start.php status</code>å‘½ä»¤æ‰¾å‡ºbusyçŠ¶æ€çš„è¿›ç¨‹pidã€‚</li></ol><p><a href="http://doc.workerman.net/images/d1903ed65ef2f3b0850e84ccbedc52aa.png" title="workerman"><img src="http://doc.workerman.net/images/d1903ed65ef2f3b0850e84ccbedc52aa.png" alt="workerman" title="workerman"></a> å›¾ä¸­busyçš„è¿›ç¨‹çš„pidä¸º11725å’Œ11748</p><ol start="2"><li><code>strace</code> è·Ÿè¸ªè¿›ç¨‹ æŒ‘é€‰ä¸€ä¸ªè¿›ç¨‹pid(è¿™é‡Œé€‰æ‹©11725)ï¼Œè¿è¡Œ<code>strace -ttp 11725</code> æ˜¾ç¤ºå¦‚ä¸‹</li></ol><p><a href="http://doc.workerman.net/images/7ce9f36da926f670949609dcdc593ab4.png"><img src="http://doc.workerman.net/images/7ce9f36da926f670949609dcdc593ab4.png" alt=""></a> å¯ä»¥çœ‹åˆ°è¿›ç¨‹åœ¨ä¸æ–­çš„å¾ªç¯poll([{fd=16, events=â€¦çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ˜¯åœ¨ç­‰å¾…fdä¸º16çš„æè¿°ç¬¦å¯è¯»äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯åœ¨ç­‰è¿™ä¸ªæè¿°ç¬¦è¿”å›æ•°æ®ã€‚ å¦‚æœæ²¡æœ‰æ˜¾ç¤ºä»»ä½•ç³»ç»Ÿè°ƒç”¨ï¼Œä¿ç•™å½“å‰ç»ˆç«¯ï¼Œé‡æ–°å†æ‰“å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œè¿è¡Œkill -SIGALRM 11725(ç»™è¿›ç¨‹å‘é€ä¸€ä¸ªé—¹é’Ÿä¿¡å·)ï¼Œç„¶åçœ‹straceçš„ç»ˆç«¯æ˜¯å¦æœ‰å“åº”ï¼Œæ˜¯å¦é˜»å¡åœ¨æŸä¸ªç³»ç»Ÿè°ƒç”¨ä¸Šã€‚å¦‚æœä»ç„¶æ²¡æœ‰æ˜¾ç¤ºä»»ä½•ç³»ç»Ÿè°ƒç”¨è¯´æ˜ç¨‹åºå¾ˆå¯èƒ½å¤„äºä¸šåŠ¡æ­»å¾ªç¯ä¸­ï¼Œå‚è€ƒé¡µé¢ä¸‹éƒ¨å¼•èµ·è¿›ç¨‹é•¿æ—¶é—´busyçš„å…¶å®ƒåŸå›  ç¬¬2é¡¹ è§£å†³ã€‚ å¦‚æœç³»ç»Ÿé˜»å¡åœ¨epoll_waitæˆ–è€…selectç³»ç»Ÿè°ƒç”¨æ˜¯æ­£å¸¸æƒ…å†µï¼Œè¿™è¯´æ˜è¿›ç¨‹å·²ç»å¤„äºidleçŠ¶æ€ã€‚</p><ol start="3"><li>lsof æŸ¥çœ‹è¿›ç¨‹æè¿°ç¬¦ è¿è¡Œlsof -nPp 11725 æ˜¾ç¤ºå¦‚ä¸‹</li></ol><p><a href="http://doc.workerman.net/images/27bd629c3a1ac93f9f4b535d01df2ac1.png"><img src="http://doc.workerman.net/images/27bd629c3a1ac93f9f4b535d01df2ac1.png" alt=""></a> è¿°ç¬¦16å¯¹åº”çš„æ˜¯16uçš„è®°å½•(æœ€åä¸€è¡Œ)ï¼Œèƒ½çœ‹fd=16çš„æè¿°ç¬¦æ˜¯ä¸€ä¸ªtcpè¿æ¥ï¼Œè¿œç¨‹åœ°å€æ˜¯101.37.136.135:80ï¼Œè¯´æ˜è¿›ç¨‹åº”è¯¥æ˜¯åœ¨è®¿é—®ä¸€ä¸ªhttpèµ„æºï¼Œå¾ªç¯poll([{fd=16, events=â€¦æ˜¯ä¸€ç›´åœ¨ç­‰å¾…httpæœåŠ¡ç«¯è¿”å›æ•°æ®ï¼Œè¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆè¿›ç¨‹å¤„äºbusyçŠ¶æ€ è§£å†³ï¼š çŸ¥é“äº†è¿›ç¨‹é˜»å¡åœ¨å“ªé‡Œï¼Œæ¥ä¸‹æ¥å°±å®¹æ˜“è§£å†³äº†ï¼Œä¾‹å¦‚ä¸Šé¢ç»è¿‡å®šä½åº”è¯¥æ˜¯ä¸šåŠ¡åœ¨è°ƒç”¨curlï¼Œè€Œå¯¹åº”çš„urlé•¿æ—¶é—´æ²¡æœ‰è¿”å›æ•°æ®ï¼Œå¯¼è‡´è¿›ç¨‹ä¸€ç›´ç­‰å¾…ã€‚è¿™æ—¶å€™å¯ä»¥æ‰¾urlæä¾›è€…å®šä½urlè¿”å›æ…¢çš„åŸå› ï¼ŒåŒæ—¶åº”è¯¥åœ¨curlè°ƒç”¨çš„æ—¶å€™åŠ ä¸Šè¶…æ—¶å‚æ•°ï¼Œæ¯”å¦‚2ç§’æ²¡è¿”å›å°±è¶…æ—¶ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡å¡æ­»(è¿™æ ·è¿›ç¨‹å¯èƒ½ä¼šå‡ºç°2ç§’å·¦å³çš„busyçŠ¶æ€)ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>workerman</tag>
      
      <tag>è°ƒè¯•</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ¼«ç”»ï¼šä»€ä¹ˆæ˜¯æ—¶é—´å¤æ‚åº¦ï¼Ÿ</title>
    <link href="/2018/08/24/%E6%BC%AB%E7%94%BB%EF%BC%9A%E4%BB%80%E4%B9%88%E6%98%AF%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%EF%BC%9F/"/>
    <url>/2018/08/24/%E6%BC%AB%E7%94%BB%EF%BC%9A%E4%BB%80%E4%B9%88%E6%98%AF%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%EF%BC%9F/</url>
    
    <content type="html"><![CDATA[<h3 id="è½¬è‡³ç¨‹åºå‘˜å°ç°ï¼šä»€ä¹ˆæ˜¯æ—¶é—´å¤æ‚åº¦ï¼Ÿ"><a class="header-anchor" href="#è½¬è‡³ç¨‹åºå‘˜å°ç°ï¼šä»€ä¹ˆæ˜¯æ—¶é—´å¤æ‚åº¦ï¼Ÿ"></a>è½¬è‡³ç¨‹åºå‘˜å°ç°ï¼š<a href="https://mp.weixin.qq.com/s/1rYK3urLuun5WqnibJ2t3g" title="è½¬ï¼šä»€ä¹ˆæ˜¯æ—¶é—´å¤æ‚åº¦ï¼Ÿ">ä»€ä¹ˆæ˜¯æ—¶é—´å¤æ‚åº¦ï¼Ÿ</a></h3>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ—¶é—´å¤æ‚åº¦</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>OAuth 2.0 Server  PHP</title>
    <link href="/2018/08/15/oauth-2-0-server-php/"/>
    <url>/2018/08/15/oauth-2-0-server-php/</url>
    
    <content type="html"><![CDATA[<h3 id="è¦æ±‚"><a class="header-anchor" href="#è¦æ±‚"></a>è¦æ±‚</h3><p>æ­¤åº“éœ€è¦PHP 5.3.9+ã€‚ç„¶è€Œï¼Œæœ‰ä¸€ä¸ªç¨³å®šçš„ç‰ˆæœ¬å’Œå¼€å‘åˆ†æ”¯çš„PHP 5.2.x-5.3.8ä¸ºå¥½ã€‚</p><h3 id="å®‰è£…"><a class="header-anchor" href="#å®‰è£…"></a>å®‰è£…</h3><p>è¯¥åº“éµå¾ªzend PSR-0æ ‡å‡†ã€‚ç”±äºè¿™ä¸ªåŸå› ï¼Œå­˜åœ¨è®¸å¤šå¯ä»¥è‡ªåŠ¨åŠ è½½æ­¤åº“çš„è‡ªåŠ¨åŠ è½½å™¨ï¼Œä½†æ˜¯å¦‚æœæ‚¨ä¸ä½¿ç”¨å®ƒï¼Œåˆ™å¯ä»¥æ³¨å†ŒOAuth2\Autoloaderï¼š</p><pre><code class="hljs php"><span class="hljs-keyword">require_once</span>(<span class="hljs-string">&#x27;/path/to/oauth2-server-php/src/OAuth2/Autoloader.php&#x27;</span>);OAuth2\Autoloader::register();</code></pre><p>ä½¿ç”¨Composer æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><pre><code class="hljs shell">composer.phar require bshaffer/oauth2-server-php &quot;^1.10&quot;</code></pre><p>è¿™ä¼šå°†éœ€æ±‚æ·»åŠ åˆ°composer.jsonå¹¶å®‰è£…åº“ã€‚ <strong>å¼ºçƒˆå»ºè®®æ‚¨æ£€æŸ¥v1.10.0æ ‡è®°ï¼Œä»¥ç¡®ä¿æ‚¨çš„åº”ç”¨ç¨‹åºä¸ä¼šç ´åå‘åå…¼å®¹æ€§é—®é¢˜ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨å¸Œæœ›ä¿æŒå¼€å‘çš„æœ€å‰æ²¿ï¼Œå¯ä»¥å°†å…¶è®¾ç½®ä¸ºdev-masterç›¸åã€‚</strong></p><h3 id="å¼€å§‹ä½¿ç”¨æ­¤åº“"><a class="header-anchor" href="#å¼€å§‹ä½¿ç”¨æ­¤åº“"></a>å¼€å§‹ä½¿ç”¨æ­¤åº“</h3><pre><code class="hljs php">$storage = <span class="hljs-keyword">new</span> OAuth2\Storage\Pdo(<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;dsn&#x27;</span> =&gt; $dsn, <span class="hljs-string">&#x27;username&#x27;</span> =&gt; $username, <span class="hljs-string">&#x27;password&#x27;</span> =&gt; $password));$server = <span class="hljs-keyword">new</span> OAuth2\Server($storage);$server-&gt;addGrantType(<span class="hljs-keyword">new</span> OAuth2\GrantType\AuthorizationCode($storage)); <span class="hljs-comment">// or any grant type you like!</span>$server-&gt;handleTokenRequest(OAuth2\Request::createFromGlobals())-&gt;send();</code></pre><h3 id="ç”¨æˆ·å…³è”"><a class="header-anchor" href="#ç”¨æˆ·å…³è”"></a>ç”¨æˆ·å…³è”</h3><p>Once youâ€™ve authenticated a user and issued an access token (such as with an Authorize Controller), youâ€™ll probably want to know which user an access token applies to when it is used. You can do this by using the optional user_id parameter of handleAuthorizeRequest:</p><pre><code class="hljs php">$userid = <span class="hljs-number">1234</span>; <span class="hljs-comment">// A value on your server that identifies the user</span>$server-&gt;handleAuthorizeRequest($request, $response, $is_authorized, $userid);</code></pre><p>That will save the user ID into the database with the access token. When the token is used by a client, you can retrieve the associated ID:</p><pre><code class="hljs php"><span class="hljs-keyword">if</span> (!$server-&gt;verifyResourceRequest(OAuth2\Request::createFromGlobals())) &#123;    $server-&gt;getResponse()-&gt;send();    <span class="hljs-keyword">die</span>;&#125;$token = $server-&gt;getAccessTokenData(OAuth2\Request::createFromGlobals());<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;User ID associated with this token is &#123;$token[&#x27;user_id&#x27;]&#125;&quot;</span>;</code></pre>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>oauth2.0</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç†è§£OAuth 2.0</title>
    <link href="/2018/07/27/%E7%90%86%E8%A7%A3oauth-2-0/"/>
    <url>/2018/07/27/%E7%90%86%E8%A7%A3oauth-2-0/</url>
    
    <content type="html"><![CDATA[<p>OAuthæ˜¯ä¸€ä¸ªå…³äºæˆæƒï¼ˆauthorizationï¼‰çš„å¼€æ”¾ç½‘ç»œæ ‡å‡†ï¼Œåœ¨å…¨ä¸–ç•Œå¾—åˆ°å¹¿æ³›åº”ç”¨ï¼Œç›®å‰çš„ç‰ˆæœ¬æ˜¯2.0ç‰ˆã€‚ æœ¬æ–‡å¯¹OAuth 2.0çš„è®¾è®¡æ€è·¯å’Œè¿è¡Œæµç¨‹ï¼Œåšä¸€ä¸ªç®€æ˜é€šä¿—çš„è§£é‡Šï¼Œä¸»è¦å‚è€ƒææ–™ä¸ºRFC 6749ã€‚ <img src="https://s1.ax1x.com/2018/07/27/PNzGl9.png" alt="PNzGl9.png"></p><h2 id="ä¸€ã€åº”ç”¨åœºæ™¯"><a class="header-anchor" href="#ä¸€ã€åº”ç”¨åœºæ™¯"></a>ä¸€ã€åº”ç”¨åœºæ™¯</h2><p>ä¸ºäº†ç†è§£OAuthçš„é€‚ç”¨åœºåˆï¼Œè®©æˆ‘ä¸¾ä¸€ä¸ªå‡è®¾çš„ä¾‹å­ã€‚ æœ‰ä¸€ä¸ª&quot;äº‘å†²å°&quot;çš„ç½‘ç«™ï¼Œå¯ä»¥å°†ç”¨æˆ·å‚¨å­˜åœ¨Googleçš„ç…§ç‰‡ï¼Œå†²å°å‡ºæ¥ã€‚ç”¨æˆ·ä¸ºäº†ä½¿ç”¨è¯¥æœåŠ¡ï¼Œå¿…é¡»è®©&quot;äº‘å†²å°&quot;è¯»å–è‡ªå·±å‚¨å­˜åœ¨Googleä¸Šçš„ç…§ç‰‡ã€‚ <img src="https://s1.ax1x.com/2018/07/27/PNzaTK.png" alt="PNzaTK.png"> é—®é¢˜æ˜¯åªæœ‰å¾—åˆ°ç”¨æˆ·çš„æˆæƒï¼ŒGoogleæ‰ä¼šåŒæ„&quot;äº‘å†²å°&quot;è¯»å–è¿™äº›ç…§ç‰‡ã€‚é‚£ä¹ˆï¼Œâ€œäº‘å†²å°&quot;æ€æ ·è·å¾—ç”¨æˆ·çš„æˆæƒå‘¢ï¼Ÿ ä¼ ç»Ÿæ–¹æ³•æ˜¯ï¼Œç”¨æˆ·å°†è‡ªå·±çš„Googleç”¨æˆ·åå’Œå¯†ç ï¼Œå‘Šè¯‰&quot;äº‘å†²å°â€ï¼Œåè€…å°±å¯ä»¥è¯»å–ç”¨æˆ·çš„ç…§ç‰‡äº†ã€‚è¿™æ ·çš„åšæ³•æœ‰ä»¥ä¸‹å‡ ä¸ªä¸¥é‡çš„ç¼ºç‚¹ã€‚</p><ol><li><p>&quot;äº‘å†²å°&quot;ä¸ºäº†åç»­çš„æœåŠ¡ï¼Œä¼šä¿å­˜ç”¨æˆ·çš„å¯†ç ï¼Œè¿™æ ·å¾ˆä¸å®‰å…¨ã€‚</p></li><li><p>Googleä¸å¾—ä¸éƒ¨ç½²å¯†ç ç™»å½•ï¼Œè€Œæˆ‘ä»¬çŸ¥é“ï¼Œå•çº¯çš„å¯†ç ç™»å½•å¹¶ä¸å®‰å…¨ã€‚</p></li><li><p>&quot;äº‘å†²å°&quot;æ‹¥æœ‰äº†è·å–ç”¨æˆ·å‚¨å­˜åœ¨Googleæ‰€æœ‰èµ„æ–™çš„æƒåŠ›ï¼Œç”¨æˆ·æ²¡æ³•é™åˆ¶&quot;äº‘å†²å°&quot;è·å¾—æˆæƒçš„èŒƒå›´å’Œæœ‰æ•ˆæœŸã€‚</p></li><li><p>ç”¨æˆ·åªæœ‰ä¿®æ”¹å¯†ç ï¼Œæ‰èƒ½æ”¶å›èµ‹äºˆ&quot;äº‘å†²å°&quot;çš„æƒåŠ›ã€‚ä½†æ˜¯è¿™æ ·åšï¼Œä¼šä½¿å¾—å…¶ä»–æ‰€æœ‰è·å¾—ç”¨æˆ·æˆæƒçš„ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºå…¨éƒ¨å¤±æ•ˆã€‚</p></li><li><p>åªè¦æœ‰ä¸€ä¸ªç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºè¢«ç ´è§£ï¼Œå°±ä¼šå¯¼è‡´ç”¨æˆ·å¯†ç æ³„æ¼ï¼Œä»¥åŠæ‰€æœ‰è¢«å¯†ç ä¿æŠ¤çš„æ•°æ®æ³„æ¼ã€‚</p></li></ol><p>OAuthå°±æ˜¯ä¸ºäº†è§£å†³ä¸Šé¢è¿™äº›é—®é¢˜è€Œè¯ç”Ÿçš„ã€‚</p><h2 id="äºŒã€åè¯å®šä¹‰"><a class="header-anchor" href="#äºŒã€åè¯å®šä¹‰"></a>äºŒã€åè¯å®šä¹‰</h2><p>åœ¨è¯¦ç»†è®²è§£OAuth 2.0ä¹‹å‰ï¼Œéœ€è¦äº†è§£å‡ ä¸ªä¸“ç”¨åè¯ã€‚å®ƒä»¬å¯¹è¯»æ‡‚åé¢çš„è®²è§£ï¼Œå°¤å…¶æ˜¯å‡ å¼ å›¾ï¼Œè‡³å…³é‡è¦ã€‚</p><ol><li>Third-party applicationï¼šç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºï¼Œæœ¬æ–‡ä¸­åˆç§°&quot;å®¢æˆ·ç«¯&quot;ï¼ˆclientï¼‰ï¼Œå³ä¸Šä¸€èŠ‚ä¾‹å­ä¸­çš„&quot;äº‘å†²å°&quot;ã€‚</li><li>HTTP serviceï¼šHTTPæœåŠ¡æä¾›å•†ï¼Œæœ¬æ–‡ä¸­ç®€ç§°&quot;æœåŠ¡æä¾›å•†&quot;ï¼Œå³ä¸Šä¸€èŠ‚ä¾‹å­ä¸­çš„Googleã€‚</li><li>Resource Ownerï¼šèµ„æºæ‰€æœ‰è€…ï¼Œæœ¬æ–‡ä¸­åˆç§°&quot;ç”¨æˆ·&quot;ï¼ˆuserï¼‰ã€‚</li><li>User Agentï¼šç”¨æˆ·ä»£ç†ï¼Œæœ¬æ–‡ä¸­å°±æ˜¯æŒ‡æµè§ˆå™¨ã€‚</li><li>Authorization serverï¼šè®¤è¯æœåŠ¡å™¨ï¼Œå³æœåŠ¡æä¾›å•†ä¸“é—¨ç”¨æ¥å¤„ç†è®¤è¯çš„æœåŠ¡å™¨ã€‚</li><li>Resource serverï¼šèµ„æºæœåŠ¡å™¨ï¼Œå³æœåŠ¡æä¾›å•†å­˜æ”¾ç”¨æˆ·ç”Ÿæˆçš„èµ„æºçš„æœåŠ¡å™¨ã€‚å®ƒä¸è®¤è¯æœåŠ¡å™¨ï¼Œå¯ä»¥æ˜¯åŒä¸€å°æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸åŒçš„æœåŠ¡å™¨ã€‚</li></ol><p>çŸ¥é“äº†ä¸Šé¢è¿™äº›åè¯ï¼Œå°±ä¸éš¾ç†è§£ï¼ŒOAuthçš„ä½œç”¨å°±æ˜¯è®©&quot;å®¢æˆ·ç«¯&quot;å®‰å…¨å¯æ§åœ°è·å–&quot;ç”¨æˆ·&quot;çš„æˆæƒï¼Œä¸&quot;æœåŠ¡å•†æä¾›å•†&quot;è¿›è¡Œäº’åŠ¨ã€‚</p><h2 id="ä¸‰ã€OAuthçš„æ€è·¯"><a class="header-anchor" href="#ä¸‰ã€OAuthçš„æ€è·¯"></a>ä¸‰ã€OAuthçš„æ€è·¯</h2><p>OAuthåœ¨&quot;å®¢æˆ·ç«¯&quot;ä¸&quot;æœåŠ¡æä¾›å•†&quot;ä¹‹é—´ï¼Œè®¾ç½®äº†ä¸€ä¸ªæˆæƒå±‚ï¼ˆauthorization layerï¼‰ã€‚â€œå®¢æˆ·ç«¯&quot;ä¸èƒ½ç›´æ¥ç™»å½•&quot;æœåŠ¡æä¾›å•†â€ï¼Œåªèƒ½ç™»å½•æˆæƒå±‚ï¼Œä»¥æ­¤å°†ç”¨æˆ·ä¸å®¢æˆ·ç«¯åŒºåˆ†å¼€æ¥ã€‚&quot;å®¢æˆ·ç«¯&quot;ç™»å½•æˆæƒå±‚æ‰€ç”¨çš„ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œä¸ç”¨æˆ·çš„å¯†ç ä¸åŒã€‚ç”¨æˆ·å¯ä»¥åœ¨ç™»å½•çš„æ—¶å€™ï¼ŒæŒ‡å®šæˆæƒå±‚ä»¤ç‰Œçš„æƒé™èŒƒå›´å’Œæœ‰æ•ˆæœŸã€‚ &quot;å®¢æˆ·ç«¯&quot;ç™»å½•æˆæƒå±‚ä»¥åï¼Œ&quot;æœåŠ¡æä¾›å•†&quot;æ ¹æ®ä»¤ç‰Œçš„æƒé™èŒƒå›´å’Œæœ‰æ•ˆæœŸï¼Œå‘&quot;å®¢æˆ·ç«¯&quot;å¼€æ”¾ç”¨æˆ·å‚¨å­˜çš„èµ„æ–™ã€‚</p><h2 id="å››ã€è¿è¡Œæµç¨‹"><a class="header-anchor" href="#å››ã€è¿è¡Œæµç¨‹"></a>å››ã€è¿è¡Œæµç¨‹</h2><p>OAuth 2.0çš„è¿è¡Œæµç¨‹å¦‚ä¸‹å›¾ï¼Œæ‘˜è‡ªRFC 6749ã€‚ <a href="https://imgchr.com/i/PNz7Xn"><img src="https://s1.ax1x.com/2018/07/27/PNz7Xn.md.png" alt="PNz7Xn.md.png"></a> ï¼ˆAï¼‰ç”¨æˆ·æ‰“å¼€å®¢æˆ·ç«¯ä»¥åï¼Œå®¢æˆ·ç«¯è¦æ±‚ç”¨æˆ·ç»™äºˆæˆæƒã€‚ ï¼ˆBï¼‰ç”¨æˆ·åŒæ„ç»™äºˆå®¢æˆ·ç«¯æˆæƒã€‚ ï¼ˆCï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä¸Šä¸€æ­¥è·å¾—çš„æˆæƒï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚ ï¼ˆDï¼‰è®¤è¯æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯ä»¥åï¼Œç¡®è®¤æ— è¯¯ï¼ŒåŒæ„å‘æ”¾ä»¤ç‰Œã€‚ ï¼ˆEï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä»¤ç‰Œï¼Œå‘èµ„æºæœåŠ¡å™¨ç”³è¯·è·å–èµ„æºã€‚ ï¼ˆFï¼‰èµ„æºæœåŠ¡å™¨ç¡®è®¤ä»¤ç‰Œæ— è¯¯ï¼ŒåŒæ„å‘å®¢æˆ·ç«¯å¼€æ”¾èµ„æºã€‚ ä¸éš¾çœ‹å‡ºæ¥ï¼Œä¸Šé¢å…­ä¸ªæ­¥éª¤ä¹‹ä¸­ï¼ŒBæ˜¯å…³é”®ï¼Œå³ç”¨æˆ·æ€æ ·æ‰èƒ½ç»™äºå®¢æˆ·ç«¯æˆæƒã€‚æœ‰äº†è¿™ä¸ªæˆæƒä»¥åï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥è·å–ä»¤ç‰Œï¼Œè¿›è€Œå‡­ä»¤ç‰Œè·å–èµ„æºã€‚ ä¸‹é¢ä¸€ä¸€è®²è§£å®¢æˆ·ç«¯è·å–æˆæƒçš„å››ç§æ¨¡å¼ã€‚</p><h2 id="äº”ã€å®¢æˆ·ç«¯çš„æˆæƒæ¨¡å¼"><a class="header-anchor" href="#äº”ã€å®¢æˆ·ç«¯çš„æˆæƒæ¨¡å¼"></a>äº”ã€å®¢æˆ·ç«¯çš„æˆæƒæ¨¡å¼</h2><p>å®¢æˆ·ç«¯å¿…é¡»å¾—åˆ°ç”¨æˆ·çš„æˆæƒï¼ˆauthorization grantï¼‰ï¼Œæ‰èƒ½è·å¾—ä»¤ç‰Œï¼ˆaccess tokenï¼‰ã€‚OAuth 2.0å®šä¹‰äº†å››ç§æˆæƒæ–¹å¼ã€‚</p><ul><li>æˆæƒç æ¨¡å¼ï¼ˆauthorization codeï¼‰</li><li>ç®€åŒ–æ¨¡å¼ï¼ˆimplicitï¼‰</li><li>å¯†ç æ¨¡å¼ï¼ˆresource owner password credentialsï¼‰</li><li>å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆclient credentialsï¼‰</li></ul><h2 id="å…­ã€æˆæƒç æ¨¡å¼"><a class="header-anchor" href="#å…­ã€æˆæƒç æ¨¡å¼"></a>å…­ã€æˆæƒç æ¨¡å¼</h2><p>æˆæƒç æ¨¡å¼ï¼ˆauthorization codeï¼‰æ˜¯åŠŸèƒ½æœ€å®Œæ•´ã€æµç¨‹æœ€ä¸¥å¯†çš„æˆæƒæ¨¡å¼ã€‚å®ƒçš„ç‰¹ç‚¹å°±æ˜¯é€šè¿‡å®¢æˆ·ç«¯çš„åå°æœåŠ¡å™¨ï¼Œä¸&quot;æœåŠ¡æä¾›å•†&quot;çš„è®¤è¯æœåŠ¡å™¨è¿›è¡Œäº’åŠ¨ã€‚ <a href="https://imgchr.com/i/PUSEtO"><img src="https://s1.ax1x.com/2018/07/27/PUSEtO.md.png" alt="PUSEtO.md.png"></a> å®ƒçš„æ­¥éª¤å¦‚ä¸‹ï¼š ï¼ˆAï¼‰ç”¨æˆ·è®¿é—®å®¢æˆ·ç«¯ï¼Œåè€…å°†å‰è€…å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚ ï¼ˆBï¼‰ç”¨æˆ·é€‰æ‹©æ˜¯å¦ç»™äºˆå®¢æˆ·ç«¯æˆæƒã€‚ ï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯äº‹å…ˆæŒ‡å®šçš„&quot;é‡å®šå‘URI&quot;ï¼ˆredirection URIï¼‰ï¼ŒåŒæ—¶é™„ä¸Šä¸€ä¸ªæˆæƒç ã€‚ ï¼ˆDï¼‰å®¢æˆ·ç«¯æ”¶åˆ°æˆæƒç ï¼Œé™„ä¸Šæ—©å…ˆçš„&quot;é‡å®šå‘URI&quot;ï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚è¿™ä¸€æ­¥æ˜¯åœ¨å®¢æˆ·ç«¯çš„åå°çš„æœåŠ¡å™¨ä¸Šå®Œæˆçš„ï¼Œå¯¹ç”¨æˆ·ä¸å¯è§ã€‚ ï¼ˆEï¼‰è®¤è¯æœåŠ¡å™¨æ ¸å¯¹äº†æˆæƒç å’Œé‡å®šå‘URIï¼Œç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯å‘é€è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰å’Œæ›´æ–°ä»¤ç‰Œï¼ˆrefresh tokenï¼‰ã€‚ ä¸‹é¢æ˜¯ä¸Šé¢è¿™äº›æ­¥éª¤æ‰€éœ€è¦çš„å‚æ•°ã€‚ Aæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯ç”³è¯·è®¤è¯çš„URIï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p><ul><li>response_typeï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œå¿…é€‰é¡¹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º&quot;code&quot;</li><li>client_idï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„IDï¼Œå¿…é€‰é¡¹</li><li>redirect_uriï¼šè¡¨ç¤ºé‡å®šå‘URIï¼Œå¯é€‰é¡¹</li><li>scopeï¼šè¡¨ç¤ºç”³è¯·çš„æƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹</li><li>stateï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å€¼ï¼Œè®¤è¯æœåŠ¡å™¨ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå€¼ã€‚</li></ul><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p><pre><code class="hljs angelscript">GET /authorize?response_type=code&amp;client_id=s6BhdRkqt3&amp;state=xyz        &amp;redirect_uri=https%<span class="hljs-number">3</span>A%<span class="hljs-number">2</span>F%<span class="hljs-number">2</span>Fclient%<span class="hljs-number">2</span>Eexample%<span class="hljs-number">2</span>Ecom%<span class="hljs-number">2</span>Fcb HTTP/<span class="hljs-number">1.1</span>Host: server.example.com</code></pre><p>Cæ­¥éª¤ä¸­ï¼ŒæœåŠ¡å™¨å›åº”å®¢æˆ·ç«¯çš„URIï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p><ul><li>codeï¼šè¡¨ç¤ºæˆæƒç ï¼Œå¿…é€‰é¡¹ã€‚è¯¥ç çš„æœ‰æ•ˆæœŸåº”è¯¥å¾ˆçŸ­ï¼Œé€šå¸¸è®¾ä¸º10åˆ†é’Ÿï¼Œå®¢æˆ·ç«¯åªèƒ½ä½¿ç”¨è¯¥ç ä¸€æ¬¡ï¼Œå¦åˆ™ä¼šè¢«æˆæƒæœåŠ¡å™¨æ‹’ç»ã€‚è¯¥ç ä¸å®¢æˆ·ç«¯IDå’Œé‡å®šå‘URIï¼Œæ˜¯ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚</li><li>stateï¼šå¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚ä¸­åŒ…å«è¿™ä¸ªå‚æ•°ï¼Œè®¤è¯æœåŠ¡å™¨çš„å›åº”ä¹Ÿå¿…é¡»ä¸€æ¨¡ä¸€æ ·åŒ…å«è¿™ä¸ªå‚æ•°ã€‚</li></ul><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p><pre><code class="hljs pf">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">302</span> FoundLocation: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA          &amp;<span class="hljs-keyword">state</span>=xyz</code></pre><p>Dæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p><ul><li>grant_typeï¼šè¡¨ç¤ºä½¿ç”¨çš„æˆæƒæ¨¡å¼ï¼Œå¿…é€‰é¡¹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º&quot;authorization_code&quot;ã€‚</li><li>codeï¼šè¡¨ç¤ºä¸Šä¸€æ­¥è·å¾—çš„æˆæƒç ï¼Œå¿…é€‰é¡¹ã€‚</li><li>redirect_uriï¼šè¡¨ç¤ºé‡å®šå‘URIï¼Œå¿…é€‰é¡¹ï¼Œä¸”å¿…é¡»ä¸Aæ­¥éª¤ä¸­çš„è¯¥å‚æ•°å€¼ä¿æŒä¸€è‡´ã€‚</li><li>client_idï¼šè¡¨ç¤ºå®¢æˆ·ç«¯IDï¼Œå¿…é€‰é¡¹ã€‚</li></ul><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­</p><pre><code class="hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">/token</span> HTTP/1.1<span class="hljs-attribute">Host</span>: server.example.com<span class="hljs-attribute">Authorization</span>: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW<span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencodedgrant_type=authorization_code&amp;code=SplxlOBeZQQYbYS6WxSbIA&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb</code></pre><p>Eæ­¥éª¤ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨å‘é€çš„HTTPå›å¤ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p><ul><li>access_tokenï¼šè¡¨ç¤ºè®¿é—®ä»¤ç‰Œï¼Œå¿…é€‰é¡¹ã€‚</li><li>token_typeï¼šè¡¨ç¤ºä»¤ç‰Œç±»å‹ï¼Œè¯¥å€¼å¤§å°å†™ä¸æ•æ„Ÿï¼Œå¿…é€‰é¡¹ï¼Œå¯ä»¥æ˜¯bearerç±»å‹æˆ–macç±»å‹ã€‚</li><li>expires_inï¼šè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œå¿…é¡»å…¶ä»–æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</li><li>refresh_tokenï¼šè¡¨ç¤ºæ›´æ–°ä»¤ç‰Œï¼Œç”¨æ¥è·å–ä¸‹ä¸€æ¬¡çš„è®¿é—®ä»¤ç‰Œï¼Œå¯é€‰é¡¹ã€‚</li><li>scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ç”³è¯·çš„èŒƒå›´ä¸€è‡´ï¼Œæ­¤é¡¹å¯çœç•¥ã€‚</li></ul><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p><pre><code class="hljs sql">HTTP/1.1 200 OK     Content-Type: application/json;charset=UTF-8     <span class="hljs-keyword">Cache</span>-Control: <span class="hljs-keyword">no</span>-<span class="hljs-keyword">store</span>     <span class="hljs-keyword">Pragma</span>: <span class="hljs-keyword">no</span>-<span class="hljs-keyword">cache</span>     &#123;       <span class="hljs-string">&quot;access_token&quot;</span>:<span class="hljs-string">&quot;2YotnFZFEjr1zCsicMWpAA&quot;</span>,       <span class="hljs-string">&quot;token_type&quot;</span>:<span class="hljs-string">&quot;example&quot;</span>,       <span class="hljs-string">&quot;expires_in&quot;</span>:<span class="hljs-number">3600</span>,       <span class="hljs-string">&quot;refresh_token&quot;</span>:<span class="hljs-string">&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;</span>,       <span class="hljs-string">&quot;example_parameter&quot;</span>:<span class="hljs-string">&quot;example_value&quot;</span>     &#125;</code></pre><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œç›¸å…³å‚æ•°ä½¿ç”¨JSONæ ¼å¼å‘é€ï¼ˆContent-Type: application/jsonï¼‰ã€‚æ­¤å¤–ï¼ŒHTTPå¤´ä¿¡æ¯ä¸­æ˜ç¡®æŒ‡å®šä¸å¾—ç¼“å­˜ã€‚</p><h2 id="ä¸ƒã€ç®€åŒ–æ¨¡å¼"><a class="header-anchor" href="#ä¸ƒã€ç®€åŒ–æ¨¡å¼"></a>ä¸ƒã€ç®€åŒ–æ¨¡å¼</h2><p>ç®€åŒ–æ¨¡å¼ï¼ˆimplicit grant typeï¼‰ä¸é€šè¿‡ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œè·³è¿‡äº†&quot;æˆæƒç &quot;è¿™ä¸ªæ­¥éª¤ï¼Œå› æ­¤å¾—åã€‚æ‰€æœ‰æ­¥éª¤åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œä»¤ç‰Œå¯¹è®¿é—®è€…æ˜¯å¯è§çš„ï¼Œä¸”å®¢æˆ·ç«¯ä¸éœ€è¦è®¤è¯ã€‚ <img src="https://s1.ax1x.com/2018/07/27/PUS8N8.png" alt="PUS8N8.png"> å®ƒçš„æ­¥éª¤å¦‚ä¸‹ï¼š ï¼ˆAï¼‰å®¢æˆ·ç«¯å°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚ ï¼ˆBï¼‰ç”¨æˆ·å†³å®šæ˜¯å¦ç»™äºå®¢æˆ·ç«¯æˆæƒã€‚ ï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯æŒ‡å®šçš„&quot;é‡å®šå‘URI&quot;ï¼Œå¹¶åœ¨URIçš„Hashéƒ¨åˆ†åŒ…å«äº†è®¿é—®ä»¤ç‰Œã€‚ ï¼ˆDï¼‰æµè§ˆå™¨å‘èµ„æºæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä¸­ä¸åŒ…æ‹¬ä¸Šä¸€æ­¥æ”¶åˆ°çš„Hashå€¼ã€‚ ï¼ˆEï¼‰èµ„æºæœåŠ¡å™¨è¿”å›ä¸€ä¸ªç½‘é¡µï¼Œå…¶ä¸­åŒ…å«çš„ä»£ç å¯ä»¥è·å–Hashå€¼ä¸­çš„ä»¤ç‰Œã€‚ ï¼ˆFï¼‰æµè§ˆå™¨æ‰§è¡Œä¸Šä¸€æ­¥è·å¾—çš„è„šæœ¬ï¼Œæå–å‡ºä»¤ç‰Œã€‚ ï¼ˆGï¼‰æµè§ˆå™¨å°†ä»¤ç‰Œå‘ç»™å®¢æˆ·ç«¯ã€‚ ä¸‹é¢æ˜¯ä¸Šé¢è¿™äº›æ­¥éª¤æ‰€éœ€è¦çš„å‚æ•°ã€‚ Aæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p><ul><li>response_typeï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º&quot;token&quot;ï¼Œå¿…é€‰é¡¹ã€‚</li><li>client_idï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„IDï¼Œå¿…é€‰é¡¹ã€‚</li><li>redirect_uriï¼šè¡¨ç¤ºé‡å®šå‘çš„URIï¼Œå¯é€‰é¡¹ã€‚</li><li>scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹ã€‚</li><li>stateï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å€¼ï¼Œè®¤è¯æœåŠ¡å™¨ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå€¼ã€‚</li></ul><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p><pre><code class="hljs angelscript">GET /authorize?response_type=token&amp;client_id=s6BhdRkqt3&amp;state=xyz        &amp;redirect_uri=https%<span class="hljs-number">3</span>A%<span class="hljs-number">2</span>F%<span class="hljs-number">2</span>Fclient%<span class="hljs-number">2</span>Eexample%<span class="hljs-number">2</span>Ecom%<span class="hljs-number">2</span>Fcb HTTP/<span class="hljs-number">1.1</span>    Host: server.example.com</code></pre><p>Cæ­¥éª¤ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨å›åº”å®¢æˆ·ç«¯çš„URIï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p><ul><li>access_tokenï¼šè¡¨ç¤ºè®¿é—®ä»¤ç‰Œï¼Œå¿…é€‰é¡¹ã€‚</li><li>token_typeï¼šè¡¨ç¤ºä»¤ç‰Œç±»å‹ï¼Œè¯¥å€¼å¤§å°å†™ä¸æ•æ„Ÿï¼Œå¿…é€‰é¡¹ã€‚</li><li>expires_inï¼šè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œå¿…é¡»å…¶ä»–æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</li><li>scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ç”³è¯·çš„èŒƒå›´ä¸€è‡´ï¼Œæ­¤é¡¹å¯çœç•¥ã€‚</li><li>stateï¼šå¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚ä¸­åŒ…å«è¿™ä¸ªå‚æ•°ï¼Œè®¤è¯æœåŠ¡å™¨çš„å›åº”ä¹Ÿå¿…é¡»ä¸€æ¨¡ä¸€æ ·åŒ…å«è¿™ä¸ªå‚æ•°ã€‚</li></ul><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p><pre><code class="hljs pf">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">302</span> Found     Location: http://example.com/cb<span class="hljs-comment">#access_token=2YotnFZFEjr1zCsicMWpAA</span>               &amp;<span class="hljs-keyword">state</span>=xyz&amp;token_type=example&amp;expires_in=<span class="hljs-number">3600</span></code></pre><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨ç”¨HTTPå¤´ä¿¡æ¯çš„Locationæ ï¼ŒæŒ‡å®šæµè§ˆå™¨é‡å®šå‘çš„ç½‘å€ã€‚æ³¨æ„ï¼Œåœ¨è¿™ä¸ªç½‘å€çš„Hashéƒ¨åˆ†åŒ…å«äº†ä»¤ç‰Œã€‚ æ ¹æ®ä¸Šé¢çš„Dæ­¥éª¤ï¼Œä¸‹ä¸€æ­¥æµè§ˆå™¨ä¼šè®¿é—®LocationæŒ‡å®šçš„ç½‘å€ï¼Œä½†æ˜¯Hashéƒ¨åˆ†ä¸ä¼šå‘é€ã€‚æ¥ä¸‹æ¥çš„Eæ­¥éª¤ï¼ŒæœåŠ¡æä¾›å•†çš„èµ„æºæœåŠ¡å™¨å‘é€è¿‡æ¥çš„ä»£ç ï¼Œä¼šæå–å‡ºHashä¸­çš„ä»¤ç‰Œã€‚</p><h2 id="å…«ã€å¯†ç æ¨¡å¼"><a class="header-anchor" href="#å…«ã€å¯†ç æ¨¡å¼"></a>å…«ã€å¯†ç æ¨¡å¼</h2><p>å¯†ç æ¨¡å¼ï¼ˆResource Owner Password Credentials Grantï¼‰ä¸­ï¼Œç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™äº›ä¿¡æ¯ï¼Œå‘&quot;æœåŠ¡å•†æä¾›å•†&quot;ç´¢è¦æˆæƒã€‚ åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·å¿…é¡»æŠŠè‡ªå·±çš„å¯†ç ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸å¾—å‚¨å­˜å¯†ç ã€‚è¿™é€šå¸¸ç”¨åœ¨ç”¨æˆ·å¯¹å®¢æˆ·ç«¯é«˜åº¦ä¿¡ä»»çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…ç”±ä¸€ä¸ªè‘—åå…¬å¸å‡ºå“ã€‚è€Œè®¤è¯æœåŠ¡å™¨åªæœ‰åœ¨å…¶ä»–æˆæƒæ¨¡å¼æ— æ³•æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è€ƒè™‘ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚ <a href="https://imgchr.com/i/PUS0H0"><img src="https://s1.ax1x.com/2018/07/27/PUS0H0.md.png" alt="PUS0H0.md.png"></a> å®ƒçš„æ­¥éª¤å¦‚ä¸‹ï¼š ï¼ˆAï¼‰ç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›ç”¨æˆ·åå’Œå¯†ç ã€‚ ï¼ˆBï¼‰å®¢æˆ·ç«¯å°†ç”¨æˆ·åå’Œå¯†ç å‘ç»™è®¤è¯æœåŠ¡å™¨ï¼Œå‘åè€…è¯·æ±‚ä»¤ç‰Œã€‚ ï¼ˆCï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚ Bæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p><ul><li>grant_typeï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º&quot;password&quot;ï¼Œå¿…é€‰é¡¹ã€‚</li><li>usernameï¼šè¡¨ç¤ºç”¨æˆ·åï¼Œå¿…é€‰é¡¹ã€‚</li><li>passwordï¼šè¡¨ç¤ºç”¨æˆ·çš„å¯†ç ï¼Œå¿…é€‰é¡¹ã€‚</li><li>scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹ã€‚</li></ul><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p><pre><code class="hljs apache"><span class="hljs-attribute">POST</span> /token HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span>     <span class="hljs-attribute">Host</span>: server.example.com     <span class="hljs-attribute">Authorization</span>: Basic czZCaGRSa<span class="hljs-number">3</span>F<span class="hljs-number">0</span>MzpnWDFmQmF<span class="hljs-number">0</span>M<span class="hljs-number">2</span>JW     <span class="hljs-attribute">Content</span>-Type: application/x-www-form-urlencoded     <span class="hljs-attribute">grant_type</span>=password&amp;username=johndoe&amp;password=A<span class="hljs-number">3</span>ddj<span class="hljs-number">3</span>w</code></pre><p>Cæ­¥éª¤ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€è®¿é—®ä»¤ç‰Œï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p><pre><code class="hljs sql">HTTP/1.1 200 OK     Content-Type: application/json;charset=UTF-8     <span class="hljs-keyword">Cache</span>-Control: <span class="hljs-keyword">no</span>-<span class="hljs-keyword">store</span>     <span class="hljs-keyword">Pragma</span>: <span class="hljs-keyword">no</span>-<span class="hljs-keyword">cache</span>     &#123;       <span class="hljs-string">&quot;access_token&quot;</span>:<span class="hljs-string">&quot;2YotnFZFEjr1zCsicMWpAA&quot;</span>,       <span class="hljs-string">&quot;token_type&quot;</span>:<span class="hljs-string">&quot;example&quot;</span>,       <span class="hljs-string">&quot;expires_in&quot;</span>:<span class="hljs-number">3600</span>,       <span class="hljs-string">&quot;refresh_token&quot;</span>:<span class="hljs-string">&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;</span>,       <span class="hljs-string">&quot;example_parameter&quot;</span>:<span class="hljs-string">&quot;example_value&quot;</span>     &#125;</code></pre><p>ä¸Šé¢ä»£ç ä¸­ï¼Œå„ä¸ªå‚æ•°çš„å«ä¹‰å‚è§ã€Šæˆæƒç æ¨¡å¼ã€‹ä¸€èŠ‚ã€‚ æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯ä¸å¾—ä¿å­˜ç”¨æˆ·çš„å¯†ç ã€‚</p><h2 id="ä¹ã€å®¢æˆ·ç«¯æ¨¡å¼"><a class="header-anchor" href="#ä¹ã€å®¢æˆ·ç«¯æ¨¡å¼"></a>ä¹ã€å®¢æˆ·ç«¯æ¨¡å¼</h2><p>å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentials Grantï¼‰æŒ‡å®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰ï¼Œè€Œä¸æ˜¯ä»¥ç”¨æˆ·çš„åä¹‰ï¼Œå‘&quot;æœåŠ¡æä¾›å•†&quot;è¿›è¡Œè®¤è¯ã€‚ä¸¥æ ¼åœ°è¯´ï¼Œå®¢æˆ·ç«¯æ¨¡å¼å¹¶ä¸å±äºOAuthæ¡†æ¶æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·ç›´æ¥å‘å®¢æˆ·ç«¯æ³¨å†Œï¼Œå®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰è¦æ±‚&quot;æœåŠ¡æä¾›å•†&quot;æä¾›æœåŠ¡ï¼Œå…¶å®ä¸å­˜åœ¨æˆæƒé—®é¢˜ã€‚ <a href="https://imgchr.com/i/PUSo4O"><img src="https://s1.ax1x.com/2018/07/27/PUSo4O.md.png" alt="PUSo4O.md.png"></a> å®ƒçš„æ­¥éª¤å¦‚ä¸‹ï¼š ï¼ˆAï¼‰å®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶è¦æ±‚ä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚ ï¼ˆBï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚ Aæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p><ul><li>granttypeï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º&quot;clientcredentials&quot;ï¼Œå¿…é€‰é¡¹ã€‚</li><li>scopeï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹ã€‚</li></ul><pre><code class="hljs apache"><span class="hljs-attribute">POST</span> /token HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span>     <span class="hljs-attribute">Host</span>: server.example.com     <span class="hljs-attribute">Authorization</span>: Basic czZCaGRSa<span class="hljs-number">3</span>F<span class="hljs-number">0</span>MzpnWDFmQmF<span class="hljs-number">0</span>M<span class="hljs-number">2</span>JW     <span class="hljs-attribute">Content</span>-Type: application/x-www-form-urlencoded     <span class="hljs-attribute">grant_type</span>=client_credentials</code></pre><p>è®¤è¯æœåŠ¡å™¨å¿…é¡»ä»¥æŸç§æ–¹å¼ï¼ŒéªŒè¯å®¢æˆ·ç«¯èº«ä»½ã€‚ Bæ­¥éª¤ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€è®¿é—®ä»¤ç‰Œï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p><pre><code class="hljs sql">HTTP/1.1 200 OK     Content-Type: application/json;charset=UTF-8     <span class="hljs-keyword">Cache</span>-Control: <span class="hljs-keyword">no</span>-<span class="hljs-keyword">store</span>     <span class="hljs-keyword">Pragma</span>: <span class="hljs-keyword">no</span>-<span class="hljs-keyword">cache</span>     &#123;       <span class="hljs-string">&quot;access_token&quot;</span>:<span class="hljs-string">&quot;2YotnFZFEjr1zCsicMWpAA&quot;</span>,       <span class="hljs-string">&quot;token_type&quot;</span>:<span class="hljs-string">&quot;example&quot;</span>,       <span class="hljs-string">&quot;expires_in&quot;</span>:<span class="hljs-number">3600</span>,       <span class="hljs-string">&quot;example_parameter&quot;</span>:<span class="hljs-string">&quot;example_value&quot;</span>     &#125;</code></pre><p>ä¸Šé¢ä»£ç ä¸­ï¼Œå„ä¸ªå‚æ•°çš„å«ä¹‰å‚è§ã€Šæˆæƒç æ¨¡å¼ã€‹ä¸€èŠ‚ã€‚</p><h2 id="åã€æ›´æ–°ä»¤ç‰Œ"><a class="header-anchor" href="#åã€æ›´æ–°ä»¤ç‰Œ"></a>åã€æ›´æ–°ä»¤ç‰Œ</h2><p>å¦‚æœç”¨æˆ·è®¿é—®çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯çš„&quot;è®¿é—®ä»¤ç‰Œ&quot;å·²ç»è¿‡æœŸï¼Œåˆ™éœ€è¦ä½¿ç”¨&quot;æ›´æ–°ä»¤ç‰Œ&quot;ç”³è¯·ä¸€ä¸ªæ–°çš„è®¿é—®ä»¤ç‰Œã€‚ å®¢æˆ·ç«¯å‘å‡ºæ›´æ–°ä»¤ç‰Œçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p><ul><li>granttypeï¼šè¡¨ç¤ºä½¿ç”¨çš„æˆæƒæ¨¡å¼ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º&quot;refreshtoken&quot;ï¼Œå¿…é€‰é¡¹ã€‚</li><li>refresh_tokenï¼šè¡¨ç¤ºæ—©å‰æ”¶åˆ°çš„æ›´æ–°ä»¤ç‰Œï¼Œå¿…é€‰é¡¹ã€‚</li><li>scopeï¼šè¡¨ç¤ºç”³è¯·çš„æˆæƒèŒƒå›´ï¼Œä¸å¯ä»¥è¶…å‡ºä¸Šä¸€æ¬¡ç”³è¯·çš„èŒƒå›´ï¼Œå¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œåˆ™è¡¨ç¤ºä¸ä¸Šä¸€æ¬¡ä¸€è‡´ã€‚</li></ul><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p><pre><code class="hljs apache"><span class="hljs-attribute">POST</span> /token HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span>   <span class="hljs-attribute">Host</span>: server.example.com   <span class="hljs-attribute">Authorization</span>: Basic czZCaGRSa<span class="hljs-number">3</span>F<span class="hljs-number">0</span>MzpnWDFmQmF<span class="hljs-number">0</span>M<span class="hljs-number">2</span>JW   <span class="hljs-attribute">Content</span>-Type: application/x-www-form-urlencoded   <span class="hljs-attribute">grant_type</span>=refresh_token&amp;refresh_token=tGzv<span class="hljs-number">3</span>JOkF<span class="hljs-number">0</span>XG<span class="hljs-number">5</span>Qx<span class="hljs-number">2</span>TlKWIA</code></pre><p><strong>è½¬ï¼š<a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" title="è½¬è‡³é˜®ä¸€å³°è€å¸ˆã€Šç†è§£OAuth 2.0ã€‹">é˜®ä¸€å³°ã€Šç†è§£OAuth 2.0ã€‹</a></strong></p>]]></content>
    
    
    <categories>
      
      <category>ç½‘ç»œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Oauth2.0</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>phpç»†èŠ‚é—®é¢˜  int 0  å’Œ ç©ºçš„åŒºåˆ«åˆ¤æ–­</title>
    <link href="/2018/07/26/php%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98-int-0-%E5%92%8C-%E7%A9%BA%E7%9A%84%E5%8C%BA%E5%88%AB%E5%88%A4%E6%96%AD/"/>
    <url>/2018/07/26/php%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98-int-0-%E5%92%8C-%E7%A9%BA%E7%9A%84%E5%8C%BA%E5%88%AB%E5%88%A4%E6%96%AD/</url>
    
    <content type="html"><![CDATA[<h3 id="å¯¹0çš„åˆ¤æ–­"><a class="header-anchor" href="#å¯¹0çš„åˆ¤æ–­"></a>å¯¹0çš„åˆ¤æ–­</h3><pre><code class="hljs php"> $cast_id = <span class="hljs-number">0</span>;var_dump(strlen($cast_id));   <span class="hljs-comment">//1</span>var_dump(<span class="hljs-keyword">empty</span>($cast_id)); <span class="hljs-comment">// true</span>var_dump(<span class="hljs-keyword">isset</span>($cast_id)); <span class="hljs-comment">//true</span>var_dump(is_null($cast_id));<span class="hljs-comment">//false</span></code></pre><h3 id="å¯¹ç©ºçš„åˆ¤æ–­"><a class="header-anchor" href="#å¯¹ç©ºçš„åˆ¤æ–­"></a>å¯¹ç©ºçš„åˆ¤æ–­</h3><pre><code class="hljs php"> $cast_id = <span class="hljs-string">&quot;&quot;</span>;var_dump(strlen($cast_id));   <span class="hljs-comment">//0</span>var_dump(<span class="hljs-keyword">empty</span>($cast_id)); <span class="hljs-comment">// true</span>var_dump(<span class="hljs-keyword">isset</span>($cast_id)); <span class="hljs-comment">//true</span>var_dump(is_null($cast_id));<span class="hljs-comment">//false</span></code></pre><p><strong>é€šè¿‡phpå‡½æ•°å»åŒºåˆ†0ã€nullï¼Œâ€˜â€™,çš„åŒºåˆ«ï¼Œå¯ä»¥ç›´æ¥åˆ¤æ–­strlenå­—èŠ‚é•¿åº¦ã€‚</strong></p>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>ç©º</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DuerOS å¼€æ”¾å¹³å°</title>
    <link href="/2018/07/25/dueros-%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0/"/>
    <url>/2018/07/25/dueros-%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0/</url>
    
    <content type="html"><![CDATA[<p><strong>å…¬å¸æ™ºèƒ½å®¶å±…é¡¹ç›®ä¸‹ä¸€æ­¥å°†è¦æ¥å…¥æ™ºèƒ½è¯­éŸ³å¹³å°ï¼Œç°åœ¨äººå·¥æ™ºèƒ½è¯­éŸ³å¹³å°æ¯”è¾ƒæˆç†Ÿï¼Œç›¸åº”çš„å¹³å°å‚å®¶ä¹Ÿæ¯”è¾ƒå¤šï¼Œå›½å†…æœ‰è®¯é£ã€æ€å¿…é©°ã€DuerOSç­‰ç­‰ï¼Œå›½å¤–æœ‰googleçš„Google Assistantï¼ŒAmazonçš„Alexaç­‰ã€‚æˆ‘ä»¬å…ˆå°è¯•ç™¾åº¦çš„DuerOSå¹³å°</strong></p><h3 id="æ¦‚è¿°"><a class="header-anchor" href="#æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>DuerOS å¼€æ”¾å¹³å°ä¸»è¦é¢å‘ä¼ä¸šçº§ç”¨æˆ·åŠä¸ªäººå¼€å‘è€…ï¼Œæä¾›å¯¹è¯å¼æ“ä½œç³»ç»Ÿèƒ½åŠ›çš„è¾“å‡ºï¼ˆDuerOSæ™ºèƒ½è®¾å¤‡å¼€æ”¾å¹³å°ï¼‰åŠè¾“å…¥ï¼ˆDuerOSæŠ€èƒ½å¼€æ”¾å¹³å°ï¼‰ã€‚</p><ul><li><h4 id="æŠ€èƒ½å¼€æ”¾å¹³å°"><a class="header-anchor" href="#æŠ€èƒ½å¼€æ”¾å¹³å°"></a>æŠ€èƒ½å¼€æ”¾å¹³å°</h4><p>æŠ€èƒ½å¼€æ”¾å¹³å°æä¾›äº†å¯¹è¯å¼æŠ€èƒ½æ‰€éœ€çš„NLU(è‡ªç„¶è¯­ä¹‰ç†è§£)å¤„ç†å’Œå¼€å‘æä¾›äº†ç›´è§‚çš„å¯è§†åŒ–ç¼–è¾‘ç•Œé¢ã€‚é€šè¿‡ç¼–è¾‘ç•Œé¢ï¼Œå¯ä»¥ä¾¿æ·è®¾è®¡æŠ€èƒ½çš„æ„å›¾ã€è¯å…¸ç­‰å†…éƒ¨é€»è¾‘ï¼Œå¼€å‘å¯¹è¯å¼æŠ€èƒ½ã€‚</p></li><li><h4 id="æŠ€èƒ½æä¾›è‡ªç„¶çš„äº¤äº’æ–¹å¼"><a class="header-anchor" href="#æŠ€èƒ½æä¾›è‡ªç„¶çš„äº¤äº’æ–¹å¼"></a>æŠ€èƒ½æä¾›è‡ªç„¶çš„äº¤äº’æ–¹å¼</h4><p>çœ‹åˆ°æŠ€èƒ½æä¾›çš„å„ç§æœåŠ¡ï¼Œä½ ä¸ç¦ä¼šé—®æ‰‹æœºappä¹Ÿå¯ä»¥æä¾›è¿™äº›æœåŠ¡ï¼Œæœ‰äº›æ‰‹æœºappä¹Ÿæ”¯æŒè¯­éŸ³è¾“å…¥è¯·æ±‚ï¼Œé‚£ä¹ˆæŠ€èƒ½æä¾›çš„æœåŠ¡ä¸æ‰‹æœºappæœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿ æŠ€èƒ½æä¾›çš„æ˜¯å¯¹è¯å¼äº¤äº’æœåŠ¡ã€‚ç”¨æˆ·ä»…é€šè¿‡è¯­éŸ³å°±å¯ä»¥å®Œæˆä¸æŠ€èƒ½çš„äº¤äº’ï¼Œäº«ç”¨æŠ€èƒ½æä¾›çš„æœåŠ¡ï¼Œä¸­é—´ä¸éœ€è¦å€ŸåŠ©å…¶ä»–äº¤äº’ã€‚æŠ€èƒ½ä¸ç”¨æˆ·äº¤äº’è¿‡ç¨‹æ˜¯æ¨¡æ‹Ÿç”¨æˆ·å®é™…ç”Ÿæ´»ä¸­çš„äº¤äº’åœºæ™¯ï¼Œç”¨æˆ·ä¸æŠ€èƒ½äº¤äº’æ—¶ï¼Œå°±åƒä¸äººäº¤äº’ä¸€æ ·è‡ªç„¶ã€‚å¦‚ç”¨æˆ·ä½¿ç”¨è®¢ç¥¨æŠ€èƒ½è´­ä¹°ç«è½¦ç¥¨æ—¶ï¼Œå°±åƒç”¨æˆ·ä¸å”®ç¥¨å‘˜äº¤æµä¸€æ ·è‡ªç„¶ã€‚ <strong>æˆ‘ä»¬éœ€è¦æ¥å…¥çš„æ˜¯åªèƒ½å®¶å±…å¹³å°ï¼ŒDuerOSæ™ºèƒ½å®¶å±…çš„æŠ€èƒ½ä¸éœ€è¦å…³æ³¨æŠ€èƒ½ä¸ç”¨æˆ·äº¤äº’å®ç°è¿‡ç¨‹ï¼Œè¿™éƒ¨åˆ†å·¥ä½œç”±DuerOSå®Œæˆã€‚æˆ‘ä»¬åªéœ€è€ƒè™‘å¦‚ä½•å»ä½¿ç”¨æ™ºèƒ½å®¶å±…æŠ€èƒ½æ¥å’Œæˆ‘ä»¬è‡ªèº«çš„è®¾å¤‡æ§åˆ¶äº‘è¿›è¡Œäº¤äº’ï¼Œè¾¾åˆ°è¯­éŸ³æ§åˆ¶è®¾å¤‡çš„ç›®çš„ã€‚</strong> ps:å¦‚æœä½ çš„æ™ºèƒ½è®¾å¤‡åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æƒ³å‚ä¸åˆ°ç”¨æˆ·äº¤äº’ä¸­ï¼Œé‚£ä½ éœ€è¦è®¾è®¡æŠ€èƒ½ä¸ç”¨æˆ·çš„äº¤äº’æ¨¡å‹ï¼Œæ­¤æ—¶ä½ éœ€è¦é€‰æ‹©è‡ªå®šä¹‰æŠ€èƒ½å®ç°å¯¹è®¾å¤‡çš„æ§åˆ¶ã€‚</p></li><li><h4 id="æ™ºèƒ½å®¶å±…æŠ€èƒ½"><a class="header-anchor" href="#æ™ºèƒ½å®¶å±…æŠ€èƒ½"></a>æ™ºèƒ½å®¶å±…æŠ€èƒ½</h4><p>æ™ºèƒ½å®¶å±…æŠ€èƒ½è®©ç”¨æˆ·é€šè¿‡å£°éŸ³æ¥æ§åˆ¶æ™ºèƒ½è®¾å¤‡ï¼ŒæŸ¥çœ‹è®¾å¤‡çš„çŠ¶æ€ï¼Œå¦‚æ§åˆ¶å¼€ç¯ã€å…³ç¯ã€‚æ™ºèƒ½å®¶å±…æŠ€èƒ½è¿˜æ”¯æŒæ™ºèƒ½åœºæ™¯çš„è®¾ç½®ã€‚æ™ºèƒ½åœºæ™¯æ˜¯æŒ‡ä¸€äº›æ™ºèƒ½è®¾å¤‡çš„ç»„åˆä½¿ç”¨ï¼ŒæŠŠå¤šä¸ªæ™ºèƒ½è®¾å¤‡è°ƒåˆ°é¢„å…ˆè®¾å®šå¥½çš„çŠ¶æ€ã€‚å¦‚ç”¨æˆ·ä½¿ç”¨ç¡çœ åœºæ™¯æ—¶ï¼Œæ™ºèƒ½å®¶å±…æŠ€èƒ½ä¼šè°ƒæš—ç¯å…‰ã€å…³ä¸Šçª—å¸˜ã€‚</p></li><li><h4 id="æ™ºèƒ½å®¶å±…è®¾å¤‡å·¥ä½œæµç¨‹"><a class="header-anchor" href="#æ™ºèƒ½å®¶å±…è®¾å¤‡å·¥ä½œæµç¨‹"></a>æ™ºèƒ½å®¶å±…è®¾å¤‡å·¥ä½œæµç¨‹</h4><p><a href="https://imgchr.com/i/Ptpyq0"><img src="https://s1.ax1x.com/2018/07/25/Ptpyq0.md.png" alt="Ptpyq0.md.png"></a></p></li><li><h4 id="æ™ºèƒ½å®¶å±…åè®®"><a class="header-anchor" href="#æ™ºèƒ½å®¶å±…åè®®"></a>æ™ºèƒ½å®¶å±…åè®®</h4></li><li><p><strong>ç®€ä»‹</strong> æ™ºèƒ½å®¶å±…åè®®æ˜¯DuerOSä¸æ™ºèƒ½å®¶å±…æŠ€èƒ½ä¹‹é—´çš„é€šè®¯åè®®ã€‚é€šè¿‡è¿™äº›åè®®æ‚¨å¯ä»¥è½»æ¾çš„é€šè¿‡è¯­éŸ³æ§åˆ¶å®¶é‡Œçš„æ™ºèƒ½è®¾å¤‡ï¼Œä¸è®¾å¤‡è¿›è¡Œäº¤äº’ã€‚æ™ºèƒ½å®¶å±…åè®®ä½¿ç”¨HTTPSä¼ è¾“ï¼Œåè®®é‡‡ç”¨JSONæ¶ˆæ¯æ ¼å¼ã€‚</p></li><li><p><strong>è®¤è¯</strong> æ™ºèƒ½å®¶å±…åè®®éµå¾ªOAuth2.0è§„èŒƒã€‚ ä»DuerOSå‘é€åˆ°æŠ€èƒ½çš„æ¯ä¸ªè¯·æ±‚éƒ½åŒ…å«OAuthçš„access tokenã€‚</p></li><li><p><strong>åè®®</strong> æ™ºèƒ½å®¶å±…åè®®æŒ‡ä»¤ï¼ˆdirectivesï¼‰ç”±Headerå’ŒPayloadä¸¤éƒ¨åˆ†ç»„æˆã€‚</p></li><li><p><strong>Headerä¿¡æ¯</strong> HeaderåŒ…å«æ¶ˆæ¯æ ‡è¯†ç¬¦ã€æŒ‡ä»¤åç§°ã€å‘½ä»¤ç©ºé—´å’Œpayloadç‰ˆæœ¬ä¿¡æ¯ã€‚ æ¶ˆæ¯æ ¼å¼ï¼š</p></li></ul><pre><code class="hljs json">&#123;    <span class="hljs-attr">&quot;header&quot;</span>: &#123;        <span class="hljs-attr">&quot;namespace&quot;</span>: <span class="hljs-string">&quot;DuerOS.ConnectedHome.Discovery&quot;</span>,        <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;DiscoverAppliancesRequest&quot;</span>,        <span class="hljs-attr">&quot;messageId&quot;</span>: <span class="hljs-string">&quot;6d6d6e14-8aee-473e-8c24-0d31ff9c17a2&quot;</span>,        <span class="hljs-attr">&quot;payloadVersion&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>    &#125;&#125;</code></pre><blockquote><p>æ€»ç»“ï¼šç™¾åº¦çš„DuerOSå¯ä»¥è§†ä¸ºçœŸæ­£æ„ä¹‰ä¸Šçš„æ“ä½œç³»ç»Ÿï¼Œç±»ä¼¼äºAndroidç³»ç»Ÿï¼ŒæŠ€èƒ½å°±ç›¸å½“äºAndroidä¸­çš„Appã€‚è½½ä½“å°±ç”±æ‰‹æœºå’Œå„ç§æ™ºèƒ½è§¦å±è®¾å¤‡å˜æˆè¯­éŸ³è¾“å…¥è®¾å¤‡ï¼Œå¹¶ä¸”æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯DuerOSéå¸¸å¼€æ”¾ï¼Œä¸Androidç›¸æ¯”å¼€æ”¾ç¨‹åº¦æœ‰ä¹‹è¿‡è€Œæ— ä¸åŠï¼Œç›¸ä¿¡æœªæ¥DuerOSåœ¨æ™ºèƒ½è¯­éŸ³é¢†åŸŸä¹Ÿä¼šæˆä¸ºå¦‚Androidä¸€æ ·ä¼Ÿå¤§çš„å¹³å°ã€‚</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>æ™ºèƒ½è¯­éŸ³</category>
      
    </categories>
    
    
    <tags>
      
      <tag>dueros</tag>
      
      <tag>æ–‡æ¡£</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CGIã€FastCGIã€PHP-FPM</title>
    <link href="/2018/07/12/cgi%E3%80%81fastcgi%E3%80%81php-fpm/"/>
    <url>/2018/07/12/cgi%E3%80%81fastcgi%E3%80%81php-fpm/</url>
    
    <content type="html"><![CDATA[<p>è½¬ï¼š<a href="https://www.cnblogs.com/f-ck-need-u/p/7627035.html" title="https://www.cnblogs.com/f-ck-need-u/p/7627035.html">æ–‡ç« å‡ºå¤„</a></p><blockquote><p>CGI â€“ common gateway interfaceçš„ç¼©å†™ï¼Œé€šå¸¸è¯‘ä¸ºï¼šé€šç”¨ç½‘å…³æ¥å£</p></blockquote><p>ç›¸ä¿¡å¤šæ•°äººå’Œæˆ‘ä¸€æ ·æ— æ³•çŸ¥å…¶åè€ŒçŸ¥å…¶æ„ï¼Œcgiå®ƒæ˜¯ä¸€ç§åè®®ã€‚é€šè¿‡cgiåè®®ï¼Œweb serverå¯ä»¥å°†åŠ¨æ€è¯·æ±‚å’Œç›¸å…³å‚æ•°å‘é€ç»™ä¸“é—¨å¤„ç†åŠ¨æ€å†…å®¹çš„åº”ç”¨ç¨‹åºã€‚ webæœåŠ¡å™¨æ‰€å¤„ç†çš„å†…å®¹éƒ½æ˜¯é™æ€çš„ï¼Œè¦æƒ³å¤„ç†åŠ¨æ€å†…å®¹ï¼Œéœ€è¦ä¾èµ–äºwebåº”ç”¨ç¨‹åºï¼Œå¦‚phpã€jspã€pythonã€perlç­‰ã€‚webæœåŠ¡å™¨è¦å°†è¯·æ±‚äº¤ç»™webåº”ç”¨ç¨‹åºå°±å¿…é¡»è¦é€šè¿‡cgiåè®®çš„å¸®åŠ©ï¼Œweb serverå’Œwebåº”ç”¨äº¤æ¢ä¿¡æ¯çš„è§„èŒƒã€‚</p><blockquote><p>ç®€å•cgiå·¥ä½œå›¾</p></blockquote><p><a href="https://i.loli.net/2018/07/12/5b46d545ed88d.png"><img src="https://i.loli.net/2018/07/12/5b46d545ed88d.png" alt=""></a></p><blockquote><p>æœ¯è¯­é‡Šç–‘</p></blockquote><p>ä¸æ˜¯ç§‘ç­å‡ºèº«çš„åŒå­¦å°±åƒæˆ‘ï¼Œæ¥è§¦ç¼–ç¨‹æ—¶éƒ½ä¼šè¢«ä¸€äº›ä¸“ä¸šæœ¯è¯­åè¯æå‡ºä¸€å †ç–‘é—®ï¼Œcgiåˆ°åº•æ˜¯ä¸ªä»€ä¹ˆé¬¼ï¼Œé€šç”¨ç½‘å…³æ¥å£åˆæ˜¯ä¸ªå•¥ï¼Œfast-cgiå‘¢ï¼Ÿ ä»¥ä¸‹æ˜¯ä»¥phpä¸ºä¾‹å„åè¯è§£é‡Š <strong>cgi</strong>ï¼šå®ƒæ˜¯ä¸€ç§åè®®ã€‚é€šè¿‡cgiåè®®ï¼Œweb serverå¯ä»¥å°†åŠ¨æ€è¯·æ±‚å’Œç›¸å…³å‚æ•°å‘é€ç»™ä¸“é—¨å¤„ç†åŠ¨æ€å†…å®¹çš„åº”ç”¨ç¨‹åºã€‚ <strong>fast-cgi</strong>ï¼šä¹Ÿæ˜¯ä¸€ç§åè®®ï¼Œåªä¸è¿‡æ˜¯cgiçš„ä¼˜åŒ–ç‰ˆã€‚cgiçš„æ€§èƒ½è¾ƒçƒ‚ï¼Œfastcgiåˆ™åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œäº†æ”¹è¿›ã€‚ <strong>php-cgi</strong>ï¼šfastcgiæ˜¯ä¸€ç§åè®®ï¼Œè€Œphp-cgiå®ç°äº†è¿™ç§åè®®ã€‚ä¸è¿‡è¿™ç§å®ç°æ¯”è¾ƒçƒ‚ã€‚å®ƒæ˜¯å•è¿›ç¨‹çš„ï¼Œä¸€ä¸ªè¿›ç¨‹å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œå¤„ç†ç»“æŸåè¿›ç¨‹å°±é”€æ¯ã€‚ <strong>php-fmp</strong>ï¼šæ˜¯å¯¹php-cgiçš„æ”¹è¿›ç‰ˆï¼Œå®ƒç›´æ¥ç®¡ç†å¤šä¸ªphp-cgiè¿›ç¨‹/çº¿ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œphp-fpmæ˜¯php-cgiçš„è¿›ç¨‹ç®¡ç†å™¨å› æ­¤å®ƒä¹Ÿç®—æ˜¯fastcgiåè®®çš„å®ç°ã€‚åœ¨ä¸€å®šç¨‹åº¦ä¸Šè®²ï¼Œphp-fpmä¸phpçš„å…³ç³»ï¼Œå’Œtomcatå¯¹javaçš„å…³ç³»æ˜¯ç±»ä¼¼çš„ã€‚ <strong>cgiè¿›ç¨‹/çº¿ç¨‹</strong>ï¼šåœ¨phpä¸Šï¼Œå°±æ˜¯php-cgiè¿›ç¨‹/çº¿ç¨‹ã€‚ä¸“é—¨ç”¨äºæ¥æ”¶web serverçš„åŠ¨æ€è¯·æ±‚ï¼Œè°ƒç”¨å¹¶åˆå§‹åŒ–zendè™šæ‹Ÿæœºã€‚ <strong>cgiè„šæœ¬</strong>ï¼šè¢«æ‰§è¡Œçš„phpæºä»£ç æ–‡ä»¶ã€‚ <strong>zendè™šæ‹Ÿæœº</strong>ï¼šå¯¹phpæ–‡ä»¶åšè¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€ç¼–è¯‘æˆopcodeï¼Œå¹¶æ‰§è¡Œã€‚æœ€åå…³é—­zendè™šæ‹Ÿæœºã€‚ <strong>cgiè¿›ç¨‹/çº¿ç¨‹å’Œzendè™šæ‹Ÿæœºçš„å…³ç³»</strong>ï¼šcgiè¿›ç¨‹è°ƒç”¨å¹¶åˆå§‹åŒ–zendè™šæ‹Ÿæœºçš„å„ç§ç¯å¢ƒã€‚ ä»¥php-fpmä¸ºä¾‹ï¼Œweb serverä»è½¬å‘åŠ¨æ€è¯·æ±‚åˆ°ç»“æŸçš„è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š <a href="https://i.loli.net/2018/07/12/5b46f288cdb4e.png"><img src="https://i.loli.net/2018/07/12/5b46f288cdb4e.png" alt=""></a> è€Œæ¯ä¸ªphp-cgiè¿›ç¨‹çš„ä½œç”¨å¤§è‡´åŒ…æ‹¬ï¼š(æœ‰äº›åŠŸèƒ½åˆ†ç±»é”™è¯¯ï¼Œè¯·æ— è§†ï¼ŒçŸ¥é“å¤§è‡´åŠŸèƒ½å°±å¤Ÿäº†) <a href="https://i.loli.net/2018/07/12/5b46f3dbd59c0.png"><img src="https://i.loli.net/2018/07/12/5b46f3dbd59c0.png" alt=""></a></p><blockquote><p>web serverå’ŒCGIçš„äº¤äº’æ¨¡å¼</p></blockquote><p>web serverå¯¹cgiè¿›ç¨‹/çº¿ç¨‹æ¥è¯´ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å‘èµ·åŠ¨æ€å¤„ç†è¯·æ±‚ï¼Œä¼ é€’ä¸€äº›å‚æ•°å’Œç¯å¢ƒå˜é‡ï¼Œæœ€åæ¥æ”¶cgiçš„è¿”å›ç»“æœã€‚å†é€šä¿—è€Œä¸ä¸¥è°¨åœ°è¯´ï¼Œweb serveré€šè¿‡cgi/fastcgiåè®®å°†åŠ¨æ€è¯·æ±‚è½¬å‘ç»™æ‰§è¡Œcgiè„šæœ¬çš„åº”ç”¨ç¨‹åºã€‚ ä»¥æœ€å…¸å‹çš„apache httpdå’Œphpä¸ºä¾‹ï¼Œå¯¹äºhttpdæ¥è¯´ï¼Œweb serverå’Œphp-cgiæœ‰3ç§äº¤äº’æ¨¡å¼ã€‚ <strong>cgiæ¨¡å¼</strong>ï¼šhttpdæ¥æ”¶åˆ°ä¸€ä¸ªåŠ¨æ€è¯·æ±‚å°±forkä¸€ä¸ªcgiè¿›ç¨‹ï¼Œcgiè¿›ç¨‹è¿”å›ç»“æœç»™httpdè¿›ç¨‹åè‡ªæˆ‘é”€æ¯ã€‚ <strong>åŠ¨æ€æ¨¡å—æ¨¡å¼</strong>ï¼šå°†php-cgiçš„æ¨¡å—(ä¾‹å¦‚php5_module)ç¼–è¯‘è¿›httpdã€‚åœ¨httpdå¯åŠ¨æ—¶ä¼šåŠ è½½æ¨¡å—ï¼ŒåŠ è½½æ—¶ä¹Ÿå°†å¯¹åº”çš„æ¨¡å—æ¿€æ´»ï¼Œphp-cgiä¹Ÿå°±å¯åŠ¨äº†ã€‚(æ³¨ï¼šçº æ­£ä¸€ä¸ªå°å°é”™è¯¯ï¼Œå¾ˆå¤šäººä»¥ä¸ºåŠ¨æ€ç¼–è¯‘çš„æ¨¡å—æ˜¯å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™éšæ—¶åŠ è½½è°ƒç”¨ï¼Œä¸éœ€è¦çš„æ—¶å€™å®ƒä»¬å°±åœæ­¢äº†ï¼Œå®é™…ä¸Šä¸æ˜¯è¿™æ ·çš„ã€‚å’Œé™æ€ç¼–è¯‘çš„æ¨¡å—ä¸€æ ·ï¼ŒåŠ¨æ€åŠ è½½çš„æ¨¡å—åœ¨è¢«åŠ è½½æ—¶å°±è¢«åŠ å…¥åˆ°æ¿€æ´»é“¾è¡¨ä¸­ï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨å®ƒï¼Œå®ƒéƒ½å·²ç»è¿è¡Œåœ¨apache httpdçš„å†…éƒ¨ã€‚å¯å‚è€ƒLoadModuleæŒ‡ä»¤çš„å®˜æ–¹æ‰‹å†Œ) <strong>php-fpmæ¨¡å¼</strong>ï¼šä½¿ç”¨php-fpmç®¡ç†php-cgiï¼Œæ­¤æ—¶httpdä¸å†æ§åˆ¶php-cgiè¿›ç¨‹çš„å¯åŠ¨ã€‚å¯ä»¥å°†php-fpmç‹¬ç«‹è¿è¡Œåœ¨éwebæœåŠ¡å™¨ä¸Šï¼Œå®ç°æ‰€è°“çš„åŠ¨é™åˆ†ç¦»ã€‚ å®é™…ä¸Šï¼Œå€ŸåŠ©æ¨¡å—mod_fastcgiè¿˜å¯ä»¥å®ç°fastcgiæ¨¡å¼ã€‚åŒcgiä¸€æ ·ï¼Œç®¡ç†æ¨¡å¼çš„å…ˆå¤©ç¼ºé™·å†³å®šäº†è¿™å¹¶ä¸æ˜¯ä¸€ç§å¥½æ–¹æ³•ã€‚</p><blockquote><p>CGIæ¨¡å¼</p></blockquote><p>ä½¿ç”¨CGIæ¨¡å¼æ—¶ï¼Œå½“åŠ¨æ€è¯·æ±‚åˆ°è¾¾ï¼Œhttpdä¸´æ—¶å¯åŠ¨ä¸€ä¸ªcgiè§£é‡Šå™¨ï¼Œå¹¶é€šè¿‡cgiåè®®è½¬å‘è¦è¿è¡Œçš„å†…å®¹ã€‚å½“cgiè„šæœ¬è¿è¡Œç»“æŸåï¼Œå°†ç»“æœè¿”å›ç»™httpdï¼Œç„¶åcgiè§£é‡Šå™¨è¿›ç¨‹è‡ªæˆ‘é”€æ¯ã€‚å½“å¤šä¸ªåŠ¨æ€è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå°†å…ˆåå¯åŠ¨å¤šä¸ªcgiè§£é‡Šå™¨ã€‚å› æ­¤ï¼Œè¿™ç§æ–¹æ³•æ•ˆç‡æä½ã€‚</p><blockquote><p>æ¨¡å—æ–¹å¼</p></blockquote><p>åœ¨ç¼–è¯‘phpæ—¶ï¼Œå°†php5_moduleæ¨¡å—ç¼–è¯‘åˆ°apacheä¸­ï¼Œä¾‹å¦‚åœ¨ç¼–è¯‘phpæ—¶åœ¨./configureé…ç½®ä¸­åŠ ä¸Š&quot;â€“with-apxs2=/usr/local/apache/bin/apxs&quot;ã€‚ è¿™ç§äº¤äº’æ¨¡å¼ä¸‹ï¼Œhttpdåœ¨å¯åŠ¨æ—¶åŠ è½½å¹¶æ¿€æ´»php_moduleã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œphp-cgiå¸¸é©»åœ¨httpdè¿›ç¨‹å†…éƒ¨ã€‚å½“åŠ¨æ€è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œhttpdä¸ç”¨å†ç”Ÿæˆcgiè§£é‡Šå™¨ï¼Œè€Œæ˜¯ç›´æ¥å°†åŠ¨æ€è¯·æ±‚è½¬å‘ç»™å®ƒå†…éƒ¨php-cgiã€‚ é…ç½®å®ç”¨è¿™ç§äº¤äº’æ¨¡å¼éå¸¸ç®€å•ï¼Œåªéœ€ä½¿ç”¨LoadModuleåŠ è½½php_moduleï¼Œå†æ·»åŠ å¯¹åº”çš„MIMEå¤„ç†å™¨å³å¯ã€‚</p><pre><code class="hljs shell">LoadModule php5_module modules/libphp5.so<span class="hljs-meta">#</span><span class="bash"> åœ¨mimeæ¨¡å—ä¸­æ·»åŠ å¯¹åº”çš„ç±»å‹</span>&lt;IfModule mime_module&gt;AddType application/x-httpd-php .phpAddType applicaiton/x-httpd-php-source .phps&lt;/IfModule&gt;</code></pre><blockquote><p>php-fpmæ–¹å¼</p></blockquote><p>å‰é¢è¯´äº†ï¼Œphp-fpmæ˜¯php-cgiçš„è¿›ç¨‹ç®¡ç†å™¨ã€‚è¿™ç§äº¤äº’æ–¹å¼å®é™…ä¸Šæ˜¯è®©php-cgiä»¥ç‹¬ç«‹äºhttpdçš„æ–¹å¼å­˜åœ¨ï¼Œç›®å‰åŸºæœ¬ä½¿ç”¨php-fpmçš„æ–¹å¼ç®¡ç†php-cgiè¿›ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ç§æ¨¡å¼ä¸‹ï¼Œphp-cgiå’Œhttpdå·²ç»åˆ†ç¦»äº†ï¼Œå®ƒä»¬çš„åˆ†ç¦»æ„å‘³ç€è¯·æ±‚çš„åŠ¨é™åˆ†ç¦»å˜ä¸ºå¯èƒ½ï¼šhttpdå’Œphp-fpmåˆ†åˆ«è¿è¡Œåœ¨ä¸åŒæœåŠ¡å™¨ä¸Šã€‚åŠ¨é™åˆ†ç¦»åï¼Œå‹åŠ›ä¹Ÿåˆ†æ•£åˆ°å„è‡ªçš„æœåŠ¡å™¨ä¸Šã€‚ è¦è®©php-fpmä»¥è¿™ç§æ–¹å¼è¿è¡Œï¼Œéœ€è¦åœ¨ç¼–è¯‘çš„./configureé…ç½®é€‰é¡¹ä¸­æ·»åŠ &quot;â€“enable-fpm&quot;é€‰é¡¹ã€‚å½“ç„¶ï¼Œè¿˜å¾—å¯åŠ¨php-fpmæœåŠ¡ã€‚ä¾‹å¦‚ï¼š <code>service php-fpm start</code> è¿™æ ·php-cgiè¿›ç¨‹å°±å¼€æ”¾ç€ç«¯å£(é»˜è®¤9000)ç­‰å¾…httpdè½¬å‘åŠ¨æ€è¯·æ±‚ã€‚è¦è®©httpdèƒ½å¤Ÿè½¬å‘è¯·æ±‚åˆ°php-cgiä¸Šï¼Œéœ€è¦åœ¨httpd.confä¸­å…³é—­æ­£å‘ä»£ç†ï¼Œå¹¶è®¾ç½®fastcgiåè®®ä»£ç†å‚æ•°ã€‚ä¾‹å¦‚ï¼Œè½¬å‘åˆ°192.168.100.54ä¸»æœºä¸Šçš„php-fpmã€‚</p><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> åŠ è½½ä»£ç†æ¨¡å—</span>LoadModule proxy_module modules/mod_proxy.soLoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so<span class="hljs-meta">#</span><span class="bash"> æ·»åŠ MIMEç±»å‹</span>AddType application/x-httpd-php .phpAddType application/x-httpd-php-source .phps<span class="hljs-meta">#</span><span class="bash"> åœ¨éœ€è¦è½¬å‘çš„è™šæ‹Ÿä¸»æœºä¸­é…ç½®è½¬å‘ä»£ç†</span>ProxyRequests offProxyPassMatch ^/(.*\.php)$ fcgi://192.168.100.54:9000/usr/local/apache/htdocs/$1</code></pre>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CGI</tag>
      
      <tag>FastCGI</tag>
      
      <tag>PHP-FPM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åˆ«å†ä½¿ç”¨å¤è€çš„topäº†  ç”¨htopå§ï¼</title>
    <link href="/2018/07/11/%E5%88%AB%E5%86%8D%E4%BD%BF%E7%94%A8%E5%8F%A4%E8%80%81%E7%9A%84top%E4%BA%86-%E7%94%A8htop%E5%90%A7%EF%BC%81/"/>
    <url>/2018/07/11/%E5%88%AB%E5%86%8D%E4%BD%BF%E7%94%A8%E5%8F%A4%E8%80%81%E7%9A%84top%E4%BA%86-%E7%94%A8htop%E5%90%A7%EF%BC%81/</url>
    
    <content type="html"><![CDATA[<blockquote><p>åœ¨linuxç³»ç»Ÿä¸­æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨topå‘½ä»¤å»æŸ¥çœ‹è¿›ç¨‹çŠ¶å†µï¼Œç³»ç»Ÿèµ„æºå ç”¨çŠ¶å†µã€‚</p></blockquote><p><a href="https://imgchr.com/i/Pu1MNT"><img src="https://s1.ax1x.com/2018/07/11/Pu1MNT.md.png" alt="Pu1MNT.md.png"></a></p><blockquote><p><strong>ç°åœ¨æˆ‘ä»¬æœ‰äº†æ›´å¥½çš„é€‰æ‹©</strong> â€“ htop</p></blockquote><p>htop æ˜¯Linuxç³»ç»Ÿä¸­çš„ä¸€ä¸ªäº’åŠ¨çš„è¿›ç¨‹æŸ¥çœ‹å™¨ï¼Œä¸€ä¸ªæ–‡æœ¬æ¨¡å¼çš„åº”ç”¨ç¨‹åº(åœ¨æ§åˆ¶å°æˆ–è€…Xç»ˆç«¯ä¸­)ï¼Œéœ€è¦ncursesã€‚ä¸Linuxä¼ ç»Ÿçš„topç›¸æ¯”ï¼Œhtopæ›´åŠ äººæ€§åŒ–ã€‚å®ƒå¯è®©ç”¨æˆ·äº¤äº’å¼æ“ä½œï¼Œæ”¯æŒé¢œè‰²ä¸»é¢˜ï¼Œå¯æ¨ªå‘æˆ–çºµå‘æ»šåŠ¨æµè§ˆè¿›ç¨‹åˆ—è¡¨ï¼Œå¹¶æ”¯æŒé¼ æ ‡æ“ä½œã€‚ ä¸topç›¸æ¯”ï¼Œhtopæœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li>å¯ä»¥æ¨ªå‘æˆ–çºµå‘æ»šåŠ¨æµè§ˆè¿›ç¨‹åˆ—è¡¨ï¼Œä»¥ä¾¿çœ‹åˆ°æ‰€æœ‰çš„è¿›ç¨‹å’Œå®Œæ•´çš„å‘½ä»¤è¡Œã€‚</li><li>åœ¨å¯åŠ¨ä¸Šï¼Œæ¯”top æ›´å¿«ã€‚</li><li>æ€è¿›ç¨‹æ—¶ä¸éœ€è¦è¾“å…¥è¿›ç¨‹å·ã€‚</li><li>htop æ”¯æŒé¼ æ ‡æ“ä½œã€‚</li></ul><p><strong>è¦æ˜¯htopç¬¬ä¸€æ­¥å…ˆå®‰è£…å§</strong> <code>apt-get install htop</code> #htopå‘½ä»¤æ‰“å¼€ <code>root@vagrant-ubuntu-trusty-64:/www/# htop</code> <a href="https://imgchr.com/i/Pu1z24"><img src="https://s1.ax1x.com/2018/07/11/Pu1z24.md.png" alt="Pu1z24.md.png"></a> htopæ•´ä½“å¸ƒå±€å’Œtopå¾ˆç›¸ä¼¼ï¼Œä¸Šé¢å·¦ä¸Šè§’æ˜¾ç¤ºCPUã€å†…å­˜ã€äº¤æ¢åŒºçš„ä½¿ç”¨æƒ…å†µï¼Œå³è¾¹æ˜¾ç¤ºä»»åŠ¡ã€è´Ÿè½½ã€å¼€æœºæ—¶é—´ï¼Œä¸‹é¢å°±æ˜¯è¿›ç¨‹å®æ—¶çŠ¶å†µã€‚å¹¶ä¸”å¯ä»¥ä»¥è¿›ç¨‹æ ‘çš„æ–¹å¼æ¥æ˜¾ç¤ºï¼Œåœ¨è®¾ç½®å¯ä»¥è®¾ç½®é»˜è®¤æ˜¾ç¤ºã€‚ ä¸‹é¢æ˜¯ F1~F10 çš„åŠŸèƒ½å’Œå¯¹åº”çš„å­—æ¯å¿«æ·é”®ã€‚</p><table><thead><tr><th>Shortcut Key</th><th>Function Key</th><th>Description</th><th>ä¸­æ–‡è¯´æ˜</th></tr></thead><tbody><tr><td>h, ?</td><td>F1</td><td>Invoke htop Help</td><td>æŸ¥çœ‹htopä½¿ç”¨è¯´æ˜</td></tr><tr><td>S</td><td>F2</td><td>Htop Setup Menu</td><td>htop è®¾å®š</td></tr><tr><td>/</td><td>F3</td><td>Search for a Process</td><td>æœç´¢è¿›ç¨‹</td></tr><tr><td>\</td><td>F4</td><td>Incremental process filtering</td><td>å¢é‡è¿›ç¨‹è¿‡æ»¤å™¨</td></tr><tr><td>T</td><td>F5</td><td>Tree View</td><td>æ˜¾ç¤ºæ ‘å½¢ç»“æ„</td></tr><tr><td>&lt;,&gt;</td><td>F6</td><td>Sort by a column</td><td>é€‰æ‹©æ’åºæ–¹å¼</td></tr><tr><td>[</td><td>F7</td><td>Nice â€“ (change priority)</td><td>å¯å‡å°‘niceå€¼ï¼Œè¿™æ ·å°±å¯ä»¥æé«˜å¯¹åº”è¿›ç¨‹çš„ä¼˜å…ˆçº§</td></tr><tr><td>]</td><td>F8</td><td>Nice â€“ (change priority)</td><td>å¯å¢åŠ niceå€¼ï¼Œè¿™æ ·å°±å¯ä»¥é™ä½å¯¹åº”è¿›ç¨‹çš„ä¼˜å…ˆçº§</td></tr><tr><td>k</td><td>F9</td><td>Kill a Process</td><td>å¯å¯¹è¿›ç¨‹ä¼ é€’ä¿¡å·</td></tr><tr><td>q</td><td>F10</td><td>Quit htop</td><td>ç»“æŸhtop</td></tr></tbody></table><p><strong>å‘½ä»¤è¡Œé€‰é¡¹ï¼ˆCOMMAND-LINE OPTIONSï¼‰</strong> -C --no-colorã€€ã€€ã€€ã€€ ã€€ã€€ ä½¿ç”¨ä¸€ä¸ªå•è‰²çš„é…è‰²æ–¹æ¡ˆ -d --delay=DELAYã€€ã€€ã€€ã€€ è®¾ç½®å»¶è¿Ÿæ›´æ–°æ—¶é—´ï¼Œå•ä½ç§’ -h --helpã€€ã€€ã€€ã€€ã€€ã€€ ã€€ã€€ æ˜¾ç¤ºhtop å‘½ä»¤å¸®åŠ©ä¿¡æ¯ -u --user=USERNAMEã€€ã€€ åªæ˜¾ç¤ºä¸€ä¸ªç»™å®šçš„ç”¨æˆ·çš„è¿‡ç¨‹ -p --pid=PID,PIDâ€¦ã€€ã€€ã€€ åªæ˜¾ç¤ºç»™å®šçš„PIDs -s --sort-key COLUMNã€€ ä¾æ­¤åˆ—æ¥æ’åº -v â€“versionã€€ã€€ã€€ã€€ã€€ã€€ã€€ æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ <strong>äº¤äº’å¼å‘½ä»¤ï¼ˆINTERACTIVE COMMANDSï¼‰</strong> ä¸Šä¸‹é”®æˆ–<strong>PgUP</strong>, <strong>PgDn</strong> é€‰å®šæƒ³è¦çš„è¿›ç¨‹ï¼Œå·¦å³é”®æˆ–<strong>Home</strong>, <strong>End</strong> ç§»åŠ¨å­—æ®µï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ç”¨é¼ æ ‡é€‰å®šè¿›ç¨‹ï¼› <strong>Space</strong> æ ‡è®°/å–æ¶ˆæ ‡è®°ä¸€ä¸ªè¿›ç¨‹ã€‚å‘½ä»¤å¯ä»¥ä½œç”¨äºå¤šä¸ªè¿›ç¨‹ï¼Œä¾‹å¦‚ <strong>â€œkillâ€</strong>ï¼Œå°†åº”ç”¨äºæ‰€æœ‰å·²æ ‡è®°çš„è¿›ç¨‹ <strong>U</strong> å–æ¶ˆæ ‡è®°æ‰€æœ‰è¿›ç¨‹ <strong>s</strong> é€‰æ‹©æŸä¸€è¿›ç¨‹ï¼ŒæŒ‰s:ç”¨straceè¿½è¸ªè¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ <strong>l</strong> æ˜¾ç¤ºè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶: å¦‚æœå®‰è£…äº†lsofï¼ŒæŒ‰æ­¤é”®å¯ä»¥æ˜¾ç¤ºè¿›ç¨‹æ‰€æ‰“å¼€çš„æ–‡ä»¶ <strong>I</strong> å€’è½¬æ’åºé¡ºåºï¼Œå¦‚æœæ’åºæ˜¯æ­£åºçš„ï¼Œåˆ™åè½¬æˆå€’åºçš„ï¼Œåä¹‹äº¦ç„¶ <strong>+, -</strong> When in tree view mode, expand or collapse subtree. When a subtree is collapsed a â€œ+â€ sign shows to the left of the process name. <strong>a</strong> (åœ¨æœ‰å¤šå¤„ç†å™¨çš„æœºå™¨ä¸Š) è®¾ç½® CPU affinity: æ ‡è®°ä¸€ä¸ªè¿›ç¨‹å…è®¸ä½¿ç”¨å“ªäº›CPU <strong>u</strong> æ˜¾ç¤ºç‰¹å®šç”¨æˆ·è¿›ç¨‹ <strong>M</strong> æŒ‰Memory ä½¿ç”¨æ’åº <strong>P</strong> æŒ‰CPU ä½¿ç”¨æ’åº <strong>T</strong> æŒ‰Time+ ä½¿ç”¨æ’åº <strong>F</strong> è·Ÿè¸ªè¿›ç¨‹: å¦‚æœæ’åºé¡ºåºå¼•èµ·é€‰å®šçš„è¿›ç¨‹åœ¨åˆ—è¡¨ä¸Šåˆ°å¤„ç§»åŠ¨ï¼Œè®©é€‰å®šæ¡è·Ÿéšè¯¥è¿›ç¨‹ã€‚è¿™å¯¹ç›‘è§†ä¸€ä¸ªè¿›ç¨‹éå¸¸æœ‰ç”¨ï¼šé€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥è®©ä¸€ä¸ªè¿›ç¨‹åœ¨å±å¹•ä¸Šä¸€ç›´å¯è§ã€‚ä½¿ç”¨æ–¹å‘é”®ä¼šåœæ­¢è¯¥åŠŸèƒ½ã€‚ <strong>K</strong> æ˜¾ç¤º/éšè—å†…æ ¸çº¿ç¨‹ <strong>H</strong> æ˜¾ç¤º/éšè—ç”¨æˆ·çº¿ç¨‹ <strong>Ctrl-L</strong> åˆ·æ–° <strong>Numbers</strong> PID æŸ¥æ‰¾: è¾“å…¥PIDï¼Œå…‰æ ‡å°†ç§»åŠ¨åˆ°ç›¸åº”çš„è¿›ç¨‹ä¸Š</p><a id="more"></a>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>top</tag>
      
      <tag>Htop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>awk è¡Œå¤„ç†å™¨</title>
    <link href="/2018/07/10/awk-%E8%A1%8C%E5%A4%84%E7%90%86%E5%99%A8/"/>
    <url>/2018/07/10/awk-%E8%A1%8C%E5%A4%84%E7%90%86%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<blockquote><p><strong>linux å¼ºå¤§çš„awkå‘½ä»¤</strong> ç›¸æ¯”è¾ƒå±å¹•å¤„ç†çš„ä¼˜ç‚¹ï¼Œåœ¨å¤„ç†åºå¤§æ–‡ä»¶æ—¶ä¸ä¼šå‡ºç°å†…å­˜æº¢å‡ºæˆ–æ˜¯å¤„ç†ç¼“æ…¢çš„é—®é¢˜ï¼Œé€šå¸¸ç”¨æ¥æ ¼å¼åŒ–æ–‡æœ¬ä¿¡æ¯</p></blockquote><h4 id="å‘½ä»¤è¡Œ"><a class="header-anchor" href="#å‘½ä»¤è¡Œ"></a>å‘½ä»¤è¡Œ</h4><p><code>awk [-F|-f|-v] 'BEGIN&#123;&#125; //&#123;command1; command2&#125; END&#123;&#125;' file</code> <code>[-F|-f|-v]</code> å¤§å‚æ•°ï¼Œ-FæŒ‡å®šåˆ†éš”ç¬¦ï¼Œ-fè°ƒç”¨è„šæœ¬ï¼Œ-vå®šä¹‰å˜é‡ var=value <code>''</code> å¼•ç”¨ä»£ç å— <code>BEGIN</code> åˆå§‹ä»£ç å—ï¼Œåœ¨å¯¹æ¯ä¸€è¡Œè¿›è¡Œå¤„ç†ä¹‹å‰ï¼Œåˆå§‹åŒ–ä»£ç ï¼Œå¼•ç”¨å…¨å±€å˜é‡ï¼Œè®¾ç½®åˆ†å‰²ç¬¦FS <code>//</code> åŒ¹é…ä»£ç å—ï¼Œå¯ä»¥ä½¿å­—ç¬¦ä¸²æˆ–æ­£åˆ™è¡¨è¾¾å¼ <code>&#123;&#125;</code> å‘½ä»¤ä»£ç å—ï¼ŒåŒ…å«ä¸€æ¡æˆ–å¤šæ¡å‘½ä»¤ <code>;</code> å¤šæ¡å‘½ä»¤ä½¿ç”¨åˆ†å·åˆ†éš” <code>END</code> ç»“å°¾ä»£ç å—ï¼Œåœ¨å¯¹æ¯ä¸€è¡Œè¿›è¡Œå¤„ç†ä¹‹åå†æ‰§è¡Œçš„ä»£ç å—ï¼Œä¸»è¦æ˜¯è¿›è¡Œæœ€ç»ˆè®¡ç®—æˆ–è¾“å‡ºç»“å°¾æ‘˜è¦ä¿¡æ¯</p><h4 id="è¦ç‚¹"><a class="header-anchor" href="#è¦ç‚¹"></a>è¦ç‚¹</h4><p><code>$0</code> è¡¨ç¤ºå½“å‰è¡Œ <code>$1</code> æ¯è¡Œä¸€ä¸ªå­—æ®µ <code>NF</code> å­—æ®µæ•°é‡ <code>NR</code> è¡Œå· <code>FNR</code> ä¸NRç±»ä¼¼ï¼Œä¸è¿‡å¤šæ–‡ä»¶è®°å½•ä¸é€’å¢ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½ä»1å¼€å§‹ <code>\tã€\n</code> æ ¼å¼åŒ–ç¬¦å· <code>FS</code> BEGINæ—¶å®šä¹‰åˆ†éš”ç¬¦ <code>RS</code> è¾“å…¥çš„è®°å½•åˆ†éš”ç¬¦ï¼Œ é»˜è®¤ä¸ºæ¢è¡Œç¬¦(å³æ–‡æœ¬æ˜¯æŒ‰ä¸€è¡Œä¸€è¡Œè¾“å…¥) <code>~</code> åŒ¹é…ï¼Œä¸==ç›¸æ¯”ä¸æ˜¯ç²¾ç¡®æ¯”è¾ƒ <code>!~</code> ä¸åŒ¹é…ï¼Œä¸ç²¾ç¡®æ¯”è¾ƒ <code>==</code> ç­‰äºï¼Œå¿…é¡»å…¨éƒ¨ç›¸ç­‰ï¼Œç²¾ç¡®æ¯”è¾ƒ <code>!=</code> ä¸ç­‰äºï¼Œç²¾ç¡®æ¯”è¾ƒ <code>&amp;&amp;</code> é€»è¾‘ä¸ <code>||</code> é€»è¾‘æˆ– <code>+</code> åŒ¹é…æ—¶è¡¨ç¤º1ä¸ªæˆ–1ä¸ªä»¥ä¸Š <code>/[0-9][0-9]+/</code> ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šæ•°å­— <code>/[0-9][0-9]*/</code> ä¸€ä¸ªæˆ–ä¸€ä¸ªä»¥ä¸Šæ•°å­— <code>FILENAME</code> æ–‡ä»¶å <code>OFS</code> è¾“å‡ºå­—æ®µåˆ†éš”ç¬¦ï¼Œ é»˜è®¤ä¹Ÿæ˜¯ç©ºæ ¼ï¼Œå¯ä»¥æ”¹ä¸ºåˆ¶è¡¨ç¬¦ç­‰ <code>ORS</code> è¾“å‡ºçš„è®°å½•åˆ†éš”ç¬¦ï¼Œé»˜è®¤ä¸ºæ¢è¡Œç¬¦,å³å¤„ç†ç»“æœä¹Ÿæ˜¯ä¸€è¡Œä¸€è¡Œè¾“å‡ºåˆ°å±å¹• <code>-F'[:#/]'</code> å®šä¹‰ä¸‰ä¸ªåˆ†éš”ç¬¦ <strong>print</strong> print æ˜¯awkæ‰“å°æŒ‡å®šå†…å®¹çš„ä¸»è¦å‘½ä»¤ <code>awk '&#123;print&#125;' /etc/passwd == awk '&#123;print $0&#125;' /etc/passwd</code> <code>awk '&#123;print &quot; &quot;&#125;' /etc/passwd</code> æ¯å¤„ç†ä¸€è¡Œè¾“å‡ºä¸€ä¸ªç©ºè¡Œ <code>awk '&#123;print &quot;a&quot;&#125;' /etc/passwd</code> æ¯å¤„ç†ä¸€è¡Œè¾“å‡ºä¸€ä¸ªè¡Œä¸”è¡Œå†…å®¹åªæœ‰aå­—ç¬¦ <code>awk -F&quot;:&quot; '&#123;print $1&#125;' /etc/passwd</code> ä»¥ï¼šä¸ºåˆ†éš”ç¬¦æ¯è¡Œè¾“å‡ºä¸€ä¸ªå­—æ®µ <code>awk -F: '&#123;print $1; print $2&#125;' /etc/passwd</code> ä»¥ï¼šä¸ºåˆ†éš”ç¬¦åˆ†è¡Œè¾“å‡ºç¬¬ä¸€ä¸ªå­—æ®µå’Œç¬¬äºŒä¸ªå­—æ®µ <code>awk -F: '&#123;print $1,$3,$6&#125;' OFS=&quot;\t&quot; /etc/passwd</code> è¾“å‡ºå­—æ®µ1,3,6ï¼Œä»¥åˆ¶è¡¨ç¬¦ä½œä¸ºåˆ†éš”ç¬¦ <strong>-fæŒ‡å®šè„šæœ¬æ–‡ä»¶</strong> <code>awk -f script.awk file</code></p><pre><code class="hljs shell">BEGIN&#123;FS=&quot;:&quot;&#125;&#123;print $1&#125;</code></pre><p>æ•ˆæœä¸awk -F&quot;:&quot; '{print $1}'ç›¸åŒ,åªæ˜¯åˆ†éš”ç¬¦ä½¿ç”¨FSåœ¨ä»£ç è‡ªèº«ä¸­æŒ‡å®š <code>ls -l|awk 'BEGIN&#123;sum=0&#125; !/^d/&#123;sum+=$5&#125; END&#123;print &quot;total size is&quot;,sum&#125;'</code> è®¡ç®—å½“å‰ç›®å½•æ–‡ä»¶æ€»å¤§å° <strong>-FæŒ‡å®šåˆ†éš”ç¬¦</strong> <code>awk -F'[:#/]' '&#123;print NF&#125;' test.sh</code> æŒ‡å®šä¸‰ä¸ªåˆ†éš”ç¬¦ï¼Œå¹¶è¾“å‡ºæ¯è¡Œå­—æ®µæ•° <strong>//åŒ¹é…ä»£ç å— //çº¯å­—ç¬¦åŒ¹é… !//çº¯å­—ç¬¦ä¸åŒ¹é… ~//å­—æ®µå€¼åŒ¹é… !~//å­—æ®µå€¼ä¸åŒ¹é… ~/a1|a2/å­—æ®µå€¼åŒ¹é…a1æˆ–a2</strong> <code>awk '/mysql/' /etc/passwd</code> æ‹¼é…mysqlå­—ç¬¦ <code>awk '!/mysql/&#123;print $0&#125;' /etc/passwd</code> è¾“å‡ºä¸åŒ¹é…mysqlçš„è¡Œ <code>awk -F: '/mail/,/mysql/&#123;print&#125;' /etc/passwd</code> åŒºé—´åŒ¹é… <code>awk -F: '$1~/mail/&#123;print $1&#125;' /etc/passwd</code> $1åŒ¹é…æŒ‡å®šå†…å®¹æ‰æ˜¾ç¤º <code>awk -F: '&#123;if($1~/mail/) print $1&#125;' /etc/passwd</code> ä¸ä¸Šé¢ç›¸åŒ <code>awk -F: '$1!~/mail/&#123;print $1&#125;' /etc/passwd</code> ä¸åŒ¹é… <strong>ifè¯­å¥</strong> <code>awk -F: '&#123;if($1~/mail/) print $1&#125;' /etc/passwd == awk -F: '&#123;if($1~/mail/) &#123;print $1&#125;&#125;' /etc/passwd</code> <code>awk -F: '&#123;if($1~/mail/) &#123;print $1&#125; else &#123;print $2&#125;&#125;' /etc/passwd</code> <strong>æ¡ä»¶è¡¨è¾¾å¼ == != &gt; &gt;=</strong></p><pre><code class="hljs shell">awk -F&quot;:&quot; &#x27;$1==&quot;mysql&quot;&#123;print $3&#125;&#x27; /etc/passwd  awk -F&quot;:&quot; &#x27;&#123;if($1==&quot;mysql&quot;) print $3&#125;&#x27; /etc/passwd          //ä¸ä¸Šé¢ç›¸åŒ awk -F&quot;:&quot; &#x27;$1!=&quot;mysql&quot;&#123;print $3&#125;&#x27; /etc/passwd                 //ä¸ç­‰äºawk -F&quot;:&quot; &#x27;$3&gt;1000&#123;print $3&#125;&#x27; /etc/passwd                      //å¤§äºawk -F&quot;:&quot; &#x27;$3&gt;=100&#123;print $3&#125;&#x27; /etc/passwd                     //å¤§äºç­‰äºawk -F&quot;:&quot; &#x27;$3&lt;1&#123;print $3&#125;&#x27; /etc/passwd                            //å°äºawk -F&quot;:&quot; &#x27;$3&lt;=1&#123;print $3&#125;&#x27; /etc/passwd</code></pre><p>**é€»è¾‘è¿ç®—ç¬¦ &amp;&amp;ã€€|| **</p><pre><code class="hljs shell">awk -F: &#x27;$1~/mail/ &amp;&amp; $3&gt;8 &#123;print &#125;&#x27; /etc/passwd         //é€»è¾‘ä¸ï¼Œ$1åŒ¹é…mailï¼Œå¹¶ä¸”$3&gt;8awk -F: &#x27;&#123;if($1~/mail/ &amp;&amp; $3&gt;8) print &#125;&#x27; /etc/passwdawk -F: &#x27;$1~/mail/ || $3&gt;1000 &#123;print &#125;&#x27; /etc/passwd       //é€»è¾‘æˆ–awk -F: &#x27;&#123;if($1~/mail/ || $3&gt;1000) print &#125;&#x27; /etc/passwd   //å–æ•´</code></pre><p><strong>è¾“å‡ºåˆ†éš”ç¬¦OFS</strong> <code>awk -F &quot;:&quot; '&#123;print $1,$3&#125;' OFS=&quot;\n&quot; /etc/passwd</code></p><pre><code class="hljs shell">root0daemon1bin2sys3sync4games5man6lp7mail8news9uucp</code></pre><p><strong>whileè¯­å¥</strong></p><pre><code class="hljs shell">awk -F: &#x27;BEGIN&#123;i=1&#125; &#123;while(i&lt;NF) print NF,$i,i++&#125;&#x27; /etc/passwd 7 root 17 x 27 0 37 0 47 root 57 /root 6</code></pre><p><strong>æ•°ç»„</strong></p><pre><code class="hljs shell">netstat -anp|awk &#x27;NR!=1&#123;a[$6]++&#125; END&#123;for (i in a) print i,&quot;\t&quot;,a[i]&#125;&#x27;netstat -anp|awk &#x27;NR!=1&#123;a[$6]++&#125; END&#123;for (i in a) printf &quot;%-20s %-10s %-5s \n&quot;, i,&quot;\t&quot;,a[i]&#125;&#x27;9523                               19929                               1LISTEN                            67903                               13038/cupsd                          110837                             19833                               1</code></pre>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
      <category>shell</category>
      
    </categories>
    
    
    <tags>
      
      <tag>awk</tag>
      
      <tag>å‘½ä»¤è¡Œ</tag>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>workermanå‹åŠ›æµ‹è¯•</title>
    <link href="/2018/07/10/workerman%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/"/>
    <url>/2018/07/10/workerman%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p><strong>å…¬å¸é¦™æ¸¯æœåŠ¡å™¨wokerman å‡ºç°å†…å­˜æ³„éœ²é—®é¢˜</strong> æ€€ç–‘æ˜¯å¦æ˜¯æ¡†æ¶è‡ªèº«é—®é¢˜</p></blockquote><h4 id="å‹åŠ›æµ‹è¯•è„šæœ¬"><a class="header-anchor" href="#å‹åŠ›æµ‹è¯•è„šæœ¬"></a>å‹åŠ›æµ‹è¯•è„šæœ¬</h4><pre><code class="hljs php"><span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;./Workerman/Autoloader.php&#x27;</span>;<span class="hljs-keyword">use</span> <span class="hljs-title">Workerman</span>\<span class="hljs-title">Worker</span>;$worker = <span class="hljs-keyword">new</span> Worker(<span class="hljs-string">&#x27;tcp://0.0.0.0:1234&#x27;</span>);<span class="hljs-comment">// è¿›ç¨‹æ•°é…ç½®æˆcpuæ ¸æ•°-1ï¼Œä¿ç•™ä¸€ä¸ªcpuç»™abè¿›ç¨‹</span>$worker-&gt;count= <span class="hljs-number">1</span>;$worker-&gt;onMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$connection, $data</span>)</span><span class="hljs-function"></span>&#123;    $connection-&gt;send(<span class="hljs-string">&quot;HTTP/1.1 200 OK\r\nConnection: keep-alive\r\nServer: workerman\1.1.4\r\n\r\nhello&quot;</span>);&#125;;Worker::runAll();</code></pre><h4 id="ä½¿ç”¨Apacheè‡ªå¸¦å·¥å…·ab-æ¥æ¨¡æ‹Ÿè¯·æ±‚-å®‰è£…-apt-get-install-apache2-utils"><a class="header-anchor" href="#ä½¿ç”¨Apacheè‡ªå¸¦å·¥å…·ab-æ¥æ¨¡æ‹Ÿè¯·æ±‚-å®‰è£…-apt-get-install-apache2-utils"></a>ä½¿ç”¨Apacheè‡ªå¸¦å·¥å…·ab æ¥æ¨¡æ‹Ÿè¯·æ±‚ å®‰è£… apt-get install apache2-utils</h4><pre><code class="hljs shell">ab -n1000000 -c100 -k http://127.0.0.1:1234/</code></pre><blockquote><p><strong>ç»“æœ</strong></p></blockquote><pre><code class="hljs shell">root@vagrant-ubuntu-trusty-64:/www/cloud/mj_ipc# ab -n1000000 -c100 -k http://127.0.0.1:1234/This is ApacheBench, Version 2.3 &lt;$Revision: 1528965 $&gt;Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/Licensed to The Apache Software Foundation, http://www.apache.org/Benchmarking 127.0.0.1 (be patient)Completed 100000 requestsCompleted 200000 requestsCompleted 300000 requestsCompleted 400000 requestsCompleted 500000 requestsCompleted 600000 requestsCompleted 700000 requestsCompleted 800000 requestsCompleted 900000 requestsCompleted 1000000 requestsFinished 1000000 requestsServer Software:        workermanServer Hostname:        127.0.0.1Server Port:            1234Document Path:          /Document Length:        5 bytesConcurrency Level:      100Time taken for tests:   16.332 secondsComplete requests:      1000000Failed requests:        0Keep-Alive requests:    1000000Total transferred:      72000000 bytesHTML transferred:       5000000 bytesRequests per second:    61227.94 [#/sec] (mean)Time per request:       1.633 [ms] (mean)Time per request:       0.016 [ms] (mean, across all concurrent requests)Transfer rate:          4305.09 [Kbytes/sec] receivedConnection Times (ms)              min  mean[+/-sd] median   maxConnect:        0    0   0.0      0       6Processing:     0    2   0.3      2      10Waiting:        0    2   0.3      2      10Total:          0    2   0.3      2      17Percentage of the requests served within a certain time (ms)<span class="hljs-meta">  50%</span><span class="bash">      2</span><span class="hljs-meta">  66%</span><span class="bash">      2</span><span class="hljs-meta">  75%</span><span class="bash">      2</span><span class="hljs-meta">  80%</span><span class="bash">      2</span><span class="hljs-meta">  90%</span><span class="bash">      2</span><span class="hljs-meta">  95%</span><span class="bash">      2</span><span class="hljs-meta">  98%</span><span class="bash">      2</span><span class="hljs-meta">  99%</span><span class="bash">      3</span><span class="hljs-meta"> 100%</span><span class="bash">     17 (longest request)</span></code></pre><blockquote><p>psï¼šæœ¬å‹æµ‹è„šæœ¬ä¸šåŠ¡é€»è¾‘ç®€å• å¯æ ¹æ®æƒ…å†µè‡ªè¡Œä¿®æ”¹</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>workerman</tag>
      
      <tag>å‹åŠ›æµ‹è¯•</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql ç”¨æˆ·æˆæƒ</title>
    <link href="/2018/07/02/mysql-%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83/"/>
    <url>/2018/07/02/mysql-%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æ–°å»ºç”¨æˆ·</p></blockquote><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> username <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;password&#x27;</span>;</code></pre><blockquote><p>åˆ†é…ç”¨æˆ·æƒé™</p></blockquote><pre><code class="hljs sql"><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">ON</span> *.* <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;username&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;password&#x27;</span>;</code></pre><blockquote><p>æ’¤é”€ç”¨æˆ·æƒé™ é‡æ–°åˆ†é…</p></blockquote><pre><code class="hljs sql">EVOKE ALL PRIVILEGES ON *.* FROM &#x27;username&#x27;@&#x27;localhost&#x27;;<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">ON</span> wordpress.* <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;username&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;password&#x27;</span>;</code></pre><blockquote><p>å•ä¸€æƒé™æˆæƒ å¦‚ä¸‹ï¼Œæˆæƒselect updateæƒé™</p></blockquote><pre><code class="hljs sql"><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> wordpress.* <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;username&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;password&#x27;</span>;</code></pre><blockquote><p>åˆ·æ–°æƒé™</p></blockquote><pre><code class="hljs sql"><span class="hljs-keyword">FLUSH</span> <span class="hljs-keyword">PRIVILEGES</span>;</code></pre><blockquote><p>åˆ é™¤ç”¨æˆ·</p></blockquote><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">USER</span> username@localhost;</code></pre><blockquote><p>æŸ¥çœ‹ç”¨æˆ·</p></blockquote><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">User</span>, Host <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span>;</code></pre><blockquote><p>æŸ¥çœ‹ç”¨æˆ·æˆæƒçŠ¶æ€</p></blockquote><pre><code class="hljs sql"><span class="hljs-keyword">show</span> <span class="hljs-keyword">grants</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">user</span>;</code></pre>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
      <tag>æƒé™</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql åˆ†åŒºè¡¨</title>
    <link href="/2018/06/27/mysql-%E5%88%86%E5%8C%BA%E8%A1%A8/"/>
    <url>/2018/06/27/mysql-%E5%88%86%E5%8C%BA%E8%A1%A8/</url>
    
    <content type="html"><![CDATA[<blockquote><h3 id="mysql-åˆ†åŒºè¡¨"><a class="header-anchor" href="#mysql-åˆ†åŒºè¡¨"></a>mysql åˆ†åŒºè¡¨</h3></blockquote><h4 id="ä»€ä¹ˆæ˜¯åˆ†åŒºè¡¨"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯åˆ†åŒºè¡¨"></a>ä»€ä¹ˆæ˜¯åˆ†åŒºè¡¨</h4><p><strong>å•è¡¨æ•°æ®åˆ°äº†å‡ ç™¾ä¸‡ç”šè‡³ä¸Šåƒä¸‡æ—¶ï¼Œä¼šä½¿å¾—æ•°æ®åº“çš„æŸ¥è¯¢æ•ˆç‡å˜å¾—å¾ˆä½ï¼Œæœ‰å¤æ‚çš„è”åˆæŸ¥è¯¢æ—¶å¯èƒ½ä¼šå¯¼è‡´mysqlè¿›ç¨‹æŒ‚æœºæˆ–å®•æœºã€‚<strong>æ­¤æ—¶é€šè¿‡åˆ†è¡¨æˆ–è€…åˆ†åŒºå°†ä¸€å¼ æ•°æ®è¡¨ä¸­çš„æ•°æ®åˆ†å‰²æˆå¤šä»½å°çš„æ•°æ®ï¼Œæœ¬æ¬¡è¦è®²çš„æ˜¯</strong>åˆ†åŒº</strong>ã€‚</p><blockquote><blockquote><p>ä»Mysql5.1ä¹‹åï¼Œåˆ†åŒºåŠŸèƒ½å‡ºç°äº†ï¼Œè¡¨åˆ†åŒºå°±åƒæ˜¯å°†ä¸€ä¸ªå¤§è¡¨åˆ†æˆäº†è‹¥å¹²ä¸ªå°è¡¨ï¼Œç”¨æˆ·åœ¨æ‰§è¡ŒæŸ¥è¯¢çš„æ—¶å€™æ— éœ€è¿›è¡Œå…¨è¡¨æ‰«æï¼Œåªéœ€è¦å¯¹æ»¡è¶³è¦æ±‚çš„è¡¨åˆ†åŒºä¸­è¿›è¡ŒæŸ¥è¯¢å³å¯ï¼Œæå¤§çš„æé«˜äº†æŸ¥è¯¢é€Ÿç‡ï¼Œå¦å¤–ï¼Œè¡¨åˆ†åŒºçš„å®ç°ä¹Ÿæ–¹ä¾¿äº†å¯¹æ•°æ®çš„ç®¡ç†ï¼Œæ¯”å¦‚äº§å“éœ€è¦åˆ é™¤å»å¹´çš„æ‰€æœ‰æ•°æ®ï¼Œé‚£ä¹ˆåªéœ€è¦å°†å»å¹´æ•°æ®æ‰€åœ¨çš„è¡¨åˆ†åŒºåˆ é™¤å³å¯ã€‚</p></blockquote></blockquote><h4 id="å¸¸è§çš„åˆ†åŒºç±»å‹"><a class="header-anchor" href="#å¸¸è§çš„åˆ†åŒºç±»å‹"></a>å¸¸è§çš„åˆ†åŒºç±»å‹</h4><blockquote><p><strong>RANGE</strong>åˆ†åŒºï¼šåŸºäºå±äºä¸€ä¸ªç»™å®šè¿ç»­åŒºé—´çš„åˆ—å€¼ï¼ŒæŠŠå¤šè¡Œåˆ†é…ç»™åˆ†åŒºã€‚ <strong>LIST</strong>åˆ†åŒºï¼šç±»ä¼¼äºæŒ‰RANGEåˆ†åŒºï¼ŒåŒºåˆ«åœ¨äºLISTåˆ†åŒºæ˜¯åŸºäºåˆ—å€¼åŒ¹é…ä¸€ä¸ªç¦»æ•£å€¼é›†åˆä¸­çš„æŸä¸ªå€¼æ¥è¿›è¡Œé€‰æ‹©ã€‚ <strong>HASH</strong>åˆ†åŒºï¼šåŸºäºç”¨æˆ·å®šä¹‰çš„è¡¨è¾¾å¼çš„è¿”å›å€¼æ¥è¿›è¡Œé€‰æ‹©çš„åˆ†åŒºï¼Œè¯¥è¡¨è¾¾å¼ä½¿ç”¨å°†è¦æ’å…¥åˆ°è¡¨ä¸­çš„è¿™äº›è¡Œçš„åˆ—å€¼è¿›è¡Œè®¡ç®—ã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥åŒ…å«MySQL ä¸­æœ‰æ•ˆçš„ã€äº§ç”Ÿéè´Ÿæ•´æ•°å€¼çš„ä»»ä½•è¡¨è¾¾å¼ã€‚ <strong>KEY</strong>åˆ†åŒºï¼šç±»ä¼¼äºæŒ‰HASHåˆ†åŒºï¼ŒåŒºåˆ«åœ¨äºKEYåˆ†åŒºåªæ”¯æŒè®¡ç®—ä¸€åˆ—æˆ–å¤šåˆ—ï¼Œä¸”MySQLæœåŠ¡å™¨æä¾›å…¶è‡ªèº«çš„å“ˆå¸Œå‡½æ•°ã€‚å¿…é¡»æœ‰ä¸€åˆ—æˆ–å¤šåˆ—åŒ…å«æ•´æ•°å€¼ã€‚</p></blockquote><p>**æ³¨æ„ï¼š**æ‰€æœ‰çš„è¡¨åˆ†åŒºä½¿ç”¨çš„åˆ—å‡éœ€è¦ä½¿ç”¨æºè¡¨ä¸­å­˜åœ¨çš„ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•åˆ—ï¼Œå¦åˆ™åˆ›å»ºå¤±è´¥ï¼Œå¦‚æœæºè¡¨ä¸­æœ¬æ¥å°±ä¸å­˜åœ¨ä»»ä½•çš„ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•åˆ—ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨åˆ†åŒºçš„æ—¶å€™æ ¹æ®éœ€è¦é€‰å–ä»»æ„åˆ—ã€‚</p><blockquote><blockquote><p>RANGEï¼šé¡¾åæ€ä¹‰ï¼Œé€šè¿‡ç¡®å®šé€‰å–åˆ—çš„å€¼çš„èŒƒå›´çš„æ–¹å¼è¿›è¡Œåˆ†åŒºã€‚ å¦‚ä¸‹æ˜¯åˆ›å»ºæ™®é€šè¡¨çš„è¯­å¥ï¼š ä¸ºäº†å®éªŒçš„æ–¹ä¾¿ï¼Œæ­¤å¤„date å­—æ®µä½¿ç”¨çš„æ—¶é—´ç±»å‹ä¸ºï¼šDATETIME,è€ŒéTIMESTAMPï¼ŒåŸå› æ˜¯TIMESTAMPä¸æ”¯æŒåœ¨åˆ†åŒºçš„æ—¶å€™ä½¿ç”¨YEAR(),MONTH(),TO_DAYS()ç­‰æ“ä½œï¼Œåªèƒ½ä½¿ç”¨UNIX_TIMSTAMP()å‡½æ•°ï¼Œæ‰€ä»¥åœ¨è®¾è®¡è¡¨çš„æ—¶å€™éœ€è¦è€ƒè™‘åˆ°è¿™ç‚¹</p></blockquote></blockquote><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span>  <span class="hljs-keyword">TABLE</span> t1  ( <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span>, <span class="hljs-built_in">date</span> DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">Innodb</span>;</code></pre><p>æ’å…¥æµ‹è¯•æ•°æ®</p><pre><code class="hljs sql">mysql&gt; SELECT * FROM t1;+<span class="hljs-comment">------+---------------------+</span>| id   | date                |+<span class="hljs-comment">------+---------------------+</span>|    1 | 2013-05-23 12:59:39 ||    2 | 2013-05-23 12:59:43 ||    3 | 2013-05-23 12:59:44 ||    4 | 2013-07-04 19:35:45 ||    5 | 2014-04-04 19:35:45 ||    6 | 2014-05-04 19:35:45 ||    7 | 2015-05-04 19:35:45 ||    8 | 2015-05-05 19:35:45 ||    9 | 2017-05-05 19:35:45 ||   10 | 2018-05-05 19:35:45 |+<span class="hljs-comment">------+---------------------+</span>10 rows in <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)</code></pre><p>æŸ¥è¯¢ ç»“æœä¸ºå…¨è¡¨æ‰«æ</p><pre><code class="hljs sql">mysql&gt; EXPLAIN SELECT * FROM t1;+<span class="hljs-comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span>| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra |+<span class="hljs-comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span>|  1 | SIMPLE      | t1    | ALL  | NULL          | NULL | NULL    | NULL |   10 | NULL  |+<span class="hljs-comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span>1 row in <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)mysql&gt; <span class="hljs-keyword">EXPLAIN</span> <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> t1 <span class="hljs-keyword">WHERE</span> <span class="hljs-built_in">date</span> &gt;= <span class="hljs-string">&#x27;2014-03-05 19:00:12&#x27;</span>    -&gt; <span class="hljs-keyword">AND</span> <span class="hljs-built_in">date</span> &lt;= <span class="hljs-string">&#x27;2016-03-05 18:45:12&#x27;</span>;+<span class="hljs-comment">----+-------------+-------+------+---------------+------+---------+------+------+-------------+</span>| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra       |+<span class="hljs-comment">----+-------------+-------+------+---------------+------+---------+------+------+-------------+</span>|  1 | SIMPLE      | t1    | ALL  | NULL          | NULL | NULL    | NULL |   10 | Using where |+<span class="hljs-comment">----+-------------+-------+------+---------------+------+---------+------+------+-------------+</span>1 row in <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)</code></pre><blockquote><p><strong>è¿›è¡ŒRANGEåˆ†åŒº</strong></p></blockquote><pre><code class="hljs sql">mysql&gt; ALTER  TABLE t1  PARTITION BY RANGE (YEAR(date)) (    -&gt;     PARTITION p2013 VALUES LESS THAN(2014),    -&gt;     PARTITION p2014 VALUES LESS THAN(2015),    -&gt;     PARTITION p2015 VALUES LESS THAN(2016),    -&gt;     PARTITION p2016 VALUES LESS THAN(2017),    -&gt;     PARTITION p2017 VALUES LESS THAN(2018),    -&gt;     PARTITION p2099 VALUES LESS THAN MAXVALUE    -&gt; ) ;</code></pre><p>æŸ¥çœ‹æ•°æ®åˆ†åŒºçŠ¶æ€ï¼š</p><pre><code class="hljs sql">mysql&gt; SELECT table_name,partition_name,table_rows FROM information_schema.PARTITIONS  WHERE  table_schema=database() AND table_name=&#x27;t1&#x27;;+<span class="hljs-comment">------------+----------------+------------+</span>| table_name | partition_name | table_rows |+<span class="hljs-comment">------------+----------------+------------+</span>| t2         | p2013          |          4 || t2         | p2014          |          2 || t2         | p2015          |          2 || t2         | p2016          |          0 || t2         | p2017          |          1 || t2         | p2099          |          1 |+<span class="hljs-comment">------------+----------------+------------+</span></code></pre><p>where æŸ¥è¯¢</p><pre><code class="hljs sql">mysql&gt; EXPLAIN PARTITIONS SELECT * FROM t2 WHERE date &gt;= &#x27;2014-03-05 19:00:12&#x27; AND date &lt;= &#x27;2016-03-05 18:45:12&#x27;;+<span class="hljs-comment">----+-------------+-------+-------------------+------+---------------+------+---------+------+------+-------------+</span>| id | select_type | table | partitions        | type | possible_keys | key  | key_len | ref  | rows | Extra       |+<span class="hljs-comment">----+-------------+-------+-------------------+------+---------------+------+---------+------+------+-------------+</span>|  1 | SIMPLE      | t2    | p2014,p2015,p2016 | ALL  | NULL          | NULL | NULL    | NULL |    5 | Using where |+<span class="hljs-comment">----+-------------+-------+-------------------+------+---------------+------+---------+------+------+-------------+</span></code></pre><blockquote><p><strong>hashåˆ†åŒº</strong> æµ‹è¯•æ•°æ®é‡ 310ä¸‡+</p></blockquote><p>æœªåˆ†åŒºå‰æŸ¥è¯¢ï¼š <img src="https://s1.ax1x.com/2018/06/27/PPI4UJ.png" alt="PPI4UJ.png"> <strong>åˆ†åŒº</strong> hashè§„åˆ™ï¼šé€šè¿‡å°†æ•´å¼ æ•°æ®è¡¨ä¸­çš„æ•°æ®åˆ†æˆä¸º7ä¸ªåˆ†åŒºï¼Œå¯¹äºæ¯ä¸€å¤©çš„æ•°æ®è®°å½•åˆ†æˆä¸€ä¸ªåŒºã€‚åœ¨æŸ¥è¯¢æ•°æ®æ—¶ é€šè¿‡å–æ¨¡æ–¹æ³•è·å–æ‰€æŸ¥æ•°æ®çš„åˆ†åŒºåï¼ˆpartï¼‰ ï¼Œè¿›è€ŒæŒ‡å®šåˆ†åŒºï¼ˆhashåˆ†åŒºåï¼Œè‹¥ä¸æŒ‡å®šåˆ†åŒºæŸ¥è¯¢ è¿˜æ˜¯å¯¹æ•°æ®è¿›è¡Œå…¨éƒ¨åˆ†åŒºæ‰«æ ï¼Œåˆ†åŒºçš„æ„ä¹‰ä¹Ÿå°±ä¸åœ¨ï¼‰è¿›è¡ŒæŸ¥è¯¢ã€‚</p><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> camera_alarm <span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">hash</span>(<span class="hljs-keyword">to_days</span>(<span class="hljs-built_in">time</span>)) <span class="hljs-keyword">partitions</span> <span class="hljs-number">7</span>;</code></pre><pre><code class="hljs sql">mysql&gt; SELECT      -&gt;   partition_name part,       -&gt;   partition_expression expr,       -&gt;   table_rows       -&gt; FROM      -&gt;   INFORMATION_SCHEMA.partitions       -&gt; WHERE      -&gt;   TABLE_SCHEMA = schema()       -&gt;   AND TABLE_NAME=&#x27;camera_alarm&#x27;;+<span class="hljs-comment">------+---------------+------------+</span>| part | expr          | table_rows |+<span class="hljs-comment">------+---------------+------------+</span>| p0   | to_days(time) |     528175 || p1   | to_days(time) |     549812 || p2   | to_days(time) |     144302 || p3   | to_days(time) |     493172 || p4   | to_days(time) |     493332 || p5   | to_days(time) |     494127 || p6   | to_days(time) |     512142 |+<span class="hljs-comment">------+---------------+------------+</span>7 rows in <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)</code></pre><p><strong>åˆ†åŒºå</strong>æŒ‡å®šåˆ†åŒºæŸ¥è¯¢ï¼š</p><pre><code class="hljs sql">mysql&gt; select * from camera_alarm PARTITION (p4) where time &lt;= &#x27;2018-03-21 23:59:59&#x27; and time &gt; &#x27;2018-03-21 00:00:00&#x27;;mysql&gt; show profiles;+<span class="hljs-comment">----------+------------+------------------------------------------------------------------------------------------------------------------------+</span>| Query_ID | Duration   | Query                                                                                                                  |+<span class="hljs-comment">----------+------------+------------------------------------------------------------------------------------------------------------------------+</span>|        1 |  0.0011805 | <span class="hljs-keyword">explain</span> <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> camera_alarm <span class="hljs-keyword">PARTITION</span> (p4) <span class="hljs-keyword">where</span> <span class="hljs-built_in">time</span> &lt;= <span class="hljs-string">&#x27;2018-03-21 23:59:59&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">time</span> &gt; <span class="hljs-string">&#x27;2018-03-21 00:00:00&#x27;</span> ||        <span class="hljs-number">2</span> | <span class="hljs-number">1.34151975</span> | <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> camera_alarm <span class="hljs-keyword">PARTITION</span> (p4) <span class="hljs-keyword">where</span> <span class="hljs-built_in">time</span> &lt;= <span class="hljs-string">&#x27;2018-03-21 23:59:59&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">time</span> &gt; <span class="hljs-string">&#x27;2018-03-21 00:00:00&#x27;</span>         |+<span class="hljs-comment">----------+------------+------------------------------------------------------------------------------------------------------------------------+</span><span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span></code></pre><p><strong>åˆ†åŒºåæŒ‡å®šåˆ†åŒºè¿›è¡ŒæŸ¥è¯¢æ•ˆç‡æé«˜è¶…100%</strong></p><blockquote><blockquote><p>listå’Œkeyåˆ†åŒºç±»å‹æ­¤å¤„ä¸ä½œç ”ç©¶</p></blockquote></blockquote>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åˆ†åŒºè¡¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>swooleå…¥é—¨-- EchoæœåŠ¡å™¨</title>
    <link href="/2018/06/22/swoole%E5%85%A5%E9%97%A8-echo%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <url>/2018/06/22/swoole%E5%85%A5%E9%97%A8-echo%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h4 id="ç½‘ç»œç¼–ç¨‹çš„-â€œHello-Worldâ€"><a class="header-anchor" href="#ç½‘ç»œç¼–ç¨‹çš„-â€œHello-Worldâ€"></a>ç½‘ç»œç¼–ç¨‹çš„ <strong>â€œHello Worldâ€</strong></h4><blockquote><p>åˆ›å»ºä¸€ä¸ªserver.php ä½œä¸ºæœåŠ¡å™¨ç¨‹åº</p></blockquote><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Server</span></span><span class="hljs-class"></span>&#123;    <span class="hljs-keyword">private</span> $serv;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;        <span class="hljs-keyword">$this</span>-&gt;serv = <span class="hljs-keyword">new</span> swoole_server(<span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-number">9501</span>);        <span class="hljs-keyword">$this</span>-&gt;serv-&gt;set(<span class="hljs-keyword">array</span>(            <span class="hljs-string">&#x27;worker_num&#x27;</span> =&gt; <span class="hljs-number">8</span>,            <span class="hljs-string">&#x27;daemonize&#x27;</span> =&gt; <span class="hljs-literal">false</span>,        ));        <span class="hljs-keyword">$this</span>-&gt;serv-&gt;on(<span class="hljs-string">&#x27;Start&#x27;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-keyword">$this</span>, <span class="hljs-string">&#x27;onStart&#x27;</span>));        <span class="hljs-keyword">$this</span>-&gt;serv-&gt;on(<span class="hljs-string">&#x27;Connect&#x27;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-keyword">$this</span>, <span class="hljs-string">&#x27;onConnect&#x27;</span>));        <span class="hljs-keyword">$this</span>-&gt;serv-&gt;on(<span class="hljs-string">&#x27;Receive&#x27;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-keyword">$this</span>, <span class="hljs-string">&#x27;onReceive&#x27;</span>));        <span class="hljs-keyword">$this</span>-&gt;serv-&gt;on(<span class="hljs-string">&#x27;Close&#x27;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-keyword">$this</span>, <span class="hljs-string">&#x27;onClose&#x27;</span>));        <span class="hljs-keyword">$this</span>-&gt;serv-&gt;start();    &#125;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onStart</span>(<span class="hljs-params"> $serv </span>) </span>&#123;        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Start\n&quot;</span>;    &#125;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onConnect</span>(<span class="hljs-params"> $serv, $fd, $from_id </span>) </span>&#123;        $serv-&gt;send( $fd, <span class="hljs-string">&quot;Hello &#123;$fd&#125;!&quot;</span> );    &#125;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onReceive</span>(<span class="hljs-params"> swoole_server $serv, $fd, $from_id, $data </span>) </span>&#123;        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Get Message From Client &#123;$fd&#125;:&#123;$data&#125;\n&quot;</span>;        $serv-&gt;send($fd, $data);    &#125;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onClose</span>(<span class="hljs-params"> $serv, $fd, $from_id </span>) </span>&#123;        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Client &#123;$fd&#125; close connection\n&quot;</span>;    &#125;&#125;<span class="hljs-comment">// å¯åŠ¨æœåŠ¡å™¨ Start the server</span>$server = <span class="hljs-keyword">new</span> Server();</code></pre><blockquote><p>åˆ›å»ºä¸€ä¸ªclient.php ä½œä¸ºå®¢æˆ·ç«¯ç¨‹åº</p></blockquote><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span></span><span class="hljs-class"></span>&#123;    <span class="hljs-keyword">private</span> $client;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;        <span class="hljs-keyword">$this</span>-&gt;client = <span class="hljs-keyword">new</span> swoole_client(SWOOLE_SOCK_TCP);    &#125;    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connect</span>(<span class="hljs-params"></span>) </span>&#123;        <span class="hljs-keyword">if</span>( !<span class="hljs-keyword">$this</span>-&gt;client-&gt;connect(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">9501</span> , <span class="hljs-number">1</span>) ) &#123;            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Error: &#123;$this-&gt;client-&gt;errMsg&#125;[&#123;$this-&gt;client-&gt;errCode&#125;]\n&quot;</span>;        &#125;        fwrite(STDOUT, <span class="hljs-string">&quot;è¯·è¾“å…¥æ¶ˆæ¯ Please input msgï¼š&quot;</span>);          $msg = trim(fgets(STDIN));        <span class="hljs-keyword">$this</span>-&gt;client-&gt;send( $msg );        $message = <span class="hljs-keyword">$this</span>-&gt;client-&gt;recv();        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Get Message From Server:&#123;$message&#125;\n&quot;</span>;    &#125;&#125;$client = <span class="hljs-keyword">new</span> Client();$client-&gt;connect();</code></pre><blockquote><p>è¿è¡Œserver.php</p></blockquote><pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>vagrant-ubuntu-trusty<span class="hljs-number">-64</span>:~# php server.php [<span class="hljs-number">2018</span><span class="hljs-number">-06</span><span class="hljs-number">-22</span> <span class="hljs-number">01</span>:<span class="hljs-number">18</span>:<span class="hljs-number">00</span> @<span class="hljs-number">8674.0</span>]   TRACE   Create swoole_server host=<span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>, port=<span class="hljs-number">9501</span>, mode=<span class="hljs-number">3</span>, type=<span class="hljs-number">1</span>Start</code></pre><blockquote><p>è¿è¡Œclient.php</p></blockquote><pre><code class="hljs elixir">root<span class="hljs-variable">@vagrant</span>-ubuntu-trusty<span class="hljs-number">-64</span><span class="hljs-symbol">:~</span><span class="hljs-comment"># php client.php </span>è¯·è¾“å…¥æ¶ˆæ¯ Please input msgï¼š</code></pre><blockquote><p>é€šä¿¡</p></blockquote><p><code>è¯·è¾“å…¥æ¶ˆæ¯ Please input msgï¼šhello php</code></p><pre><code class="hljs angelscript">[<span class="hljs-number">2018</span><span class="hljs-number">-06</span><span class="hljs-number">-22</span> <span class="hljs-number">01</span>:<span class="hljs-number">21</span>:<span class="hljs-number">14</span> #<span class="hljs-number">8989.2</span>]   TRACE   [Master] Accept new connection. maxfd=<span class="hljs-number">4</span>|reactor_id=<span class="hljs-number">2</span>|conn=<span class="hljs-number">25</span>[<span class="hljs-number">2018</span><span class="hljs-number">-06</span><span class="hljs-number">-22</span> <span class="hljs-number">01</span>:<span class="hljs-number">21</span>:<span class="hljs-number">14</span> *<span class="hljs-number">8994.1</span>]   TRACE   [Worker] send: sendn=<span class="hljs-number">20</span>|type=<span class="hljs-number">0</span>|content=Hello <span class="hljs-number">1</span>![<span class="hljs-number">2018</span><span class="hljs-number">-06</span><span class="hljs-number">-22</span> <span class="hljs-number">01</span>:<span class="hljs-number">22</span>:<span class="hljs-number">21</span> #<span class="hljs-number">8989.1</span>]   TRACE   send <span class="hljs-built_in">string</span> package, size=<span class="hljs-number">9</span> bytes.[<span class="hljs-number">2018</span><span class="hljs-number">-06</span><span class="hljs-number">-22</span> <span class="hljs-number">01</span>:<span class="hljs-number">22</span>:<span class="hljs-number">21</span> #<span class="hljs-number">8989.1</span>]   TRACE   dispatch, type=<span class="hljs-number">10</span>|len=<span class="hljs-number">9</span>Get Message From Client <span class="hljs-number">1</span>:hello php</code></pre>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>swoole</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang --æ–°çš„ç©å…·</title>
    <link href="/2018/06/20/golang-%E6%96%B0%E7%9A%84%E7%8E%A9%E5%85%B7/"/>
    <url>/2018/06/20/golang-%E6%96%B0%E7%9A%84%E7%8E%A9%E5%85%B7/</url>
    
    <content type="html"><![CDATA[<h3 id="Golang-ç®€ä»‹"><a class="header-anchor" href="#Golang-ç®€ä»‹"></a>Golang ç®€ä»‹</h3><p><img src="https://upload-images.jianshu.io/upload_images/3462294-882a2d694e522197.jpg" alt="logo"> Golangæ˜¯Googleå…¬å¸åœ¨2009å¹´å‘å¸ƒçš„ä¸€æ¬¾å¼€æºç¼–ç¨‹è¯­è¨€ï¼Œåœ¨2012å¹´æ—©äº›æ—¶å€™å‘å¸ƒäº†Go 1.0ç¨³å®šç‰ˆæœ¬ã€‚ç°åœ¨Goçš„å¼€å‘å·²ç»æ˜¯å®Œå…¨å¼€æ”¾çš„ï¼Œå¹¶ä¸”æ‹¥æœ‰ä¸€ä¸ªæ´»è·ƒçš„ç¤¾åŒºã€‚èƒŒé Googleçˆ¸çˆ¸ï¼ŒGolangåœ¨äº’è”ç½‘é¢†åŸŸå‘å±•é£å¿«ï¼Œåœ¨å›½å†…å¤–å¤§å‚ï¼ˆGoogleã€Facebookã€alibabaã€tencentã€jd ç­‰ç­‰ï¼‰æµè¡Œç¨‹åº¦å¤§æœ‰æ‹³æ‰“javaè„šè¸¢C++çš„è¶‹åŠ¿ã€‚åœ¨å¤§æ•°æ®å’Œåˆ†å¸ƒå¼å¹³å°é¢†åŸŸGolangå¯ä»¥è¯´æ˜¯ä¸€ä¸ªåˆæ ¼çš„è´¡çŒ®è€…ï¼Œç‰¹åˆ«æ˜¯åç»­çš„äººå·¥æ™ºèƒ½é¢†åŸŸçš„å‘å±•æ½œåŠ›å·¨å¤§ã€‚å¹³æ—¶å·¥ä½œä¸­çš„ä¸»åŠ›è¯­è¨€æ˜¯è„šæœ¬è¯­è¨€ï¼Œæ‰€ä»¥æƒ³é€šè¿‡å­¦ä¹ ä¸€é—¨ç¼–è¯‘è¯­è¨€æ¥è¡¥å……è„šæœ¬è¯­è¨€åœ¨æŸäº›æƒ…å†µçš„ç¼ºé™·å¹¶è·Ÿè¿›æ—¶ä»£çš„è„šæ­¥ï¼Œè¿™æ˜¯æˆ‘å­¦ä¹ Golangçš„åˆè¡·ã€‚</p><h4 id="Golangç‰¹è‰²"><a class="header-anchor" href="#Golangç‰¹è‰²"></a>Golangç‰¹è‰²</h4><ul><li>æ¯”PHPã€Pythonç­‰è§£é‡Šæ€§è¯­è¨€å¿«ï¼Œä½†è¯­æ³•ç®€æ´ç¨‹åº¦ä¸äºšäºå®ƒä»¬ã€‚</li><li>å¹¶å‘æ€§èƒ½æŸäº›åœºæ™¯æ¯”è‚©java</li><li>éƒ¨ç½²ç®€æ˜“ï¼Œå®‰å…¨å¯é </li><li>C/C++èƒ½åšçš„åå°å·¥ä½œGolangéƒ½å¯ä»¥èƒœä»»ï¼Œåœ¨å¼€å‘æ•ˆç‡ä¸Šå¯ä»¥ç§’æ€å‰è€…ï¼Œå› ä¸ºæ˜¯ç¼–è¯‘è¯­è¨€ï¼Œæ€§èƒ½æ–¹é¢ä¹Ÿä¸ä¼šæœ‰éå¸¸å¤§çš„å·®è·ã€‚</li></ul><hr><h4 id="å®‰è£…"><a class="header-anchor" href="#å®‰è£…"></a>å®‰è£…</h4><p>å®‰è£…Goå·¥å…· <strong>Linuxã€Mac OS X å’Œ FreeBSD çš„å®‰è£…åŒ…</strong> ä¸‹è½½æ­¤å‹ç¼©åŒ…å¹¶æå–åˆ° /usr/local ç›®å½•ï¼Œåœ¨ /usr/local/go ä¸­åˆ›å»ºGoç›®å½•æ ‘ã€‚ä¾‹å¦‚ï¼š <code>tar -C /usr/local -xzf go$VERSION.$OS-$ARCH.tar.gz</code> è¯¥å‹ç¼©åŒ…çš„åç§°å¯èƒ½ä¸åŒï¼Œè¿™å–å†³äºä½ å®‰è£…çš„Goç‰ˆæœ¬å’Œä½ çš„æ“ä½œç³»ç»Ÿä»¥åŠå¤„ç†å™¨æ¶æ„ã€‚ ï¼ˆæ­¤å‘½ä»¤å¿…é¡»ä½œä¸ºrootæˆ–é€šè¿‡ sudo è¿è¡Œã€‚ï¼‰ è¦å°† /usr/local/go/bin æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡ï¼Œ ä½ éœ€è¦å°†æ­¤è¡Œæ·»åŠ åˆ°ä½ çš„ /etc/profileï¼ˆå…¨ç³»ç»Ÿå®‰è£…ï¼‰æˆ– $HOME/.profile æ–‡ä»¶ä¸­ï¼š <code>export PATH=$PATH:/usr/local/go/bin</code> <strong>å®‰è£…åˆ°æŒ‡å®šä½ç½®</strong> GoäºŒè¿›åˆ¶å‘è¡Œç‰ˆå‡å®šå®ƒä»¬ä¼šè¢«å®‰è£…åˆ° /usr/local/go ï¼ˆæˆ–Windowsä¸‹çš„ c:\Goï¼‰ä¸­ï¼Œä½†ä¹Ÿå¯å°†Goå·¥å…·å®‰è£…åˆ°ä¸åŒçš„ä½ç½®ã€‚ æ­¤æ—¶ä½ å¿…é¡»è®¾ç½® GOROOT ç¯å¢ƒå˜é‡æ¥æŒ‡å‡ºå®ƒæ‰€å®‰è£…çš„ä½ç½®ã€‚ ä¾‹å¦‚ï¼Œè‹¥ä½ å°†Goå®‰è£…åˆ°ä½ çš„homeç›®å½•ä¸‹ï¼Œä½ åº”å½“å°†ä»¥ä¸‹å‘½ä»¤æ·»åŠ åˆ° $HOME/.profile æ–‡ä»¶ä¸­ï¼š</p><pre><code class="hljs routeros"><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">GOROOT</span>=<span class="hljs-variable">$HOME</span>/go<span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$PATH</span>:$GOROOT/bin</code></pre><p><strong>æ³¨ï¼šGOROOT ä»…åœ¨å®‰è£…åˆ°æŒ‡å®šä½ç½®æ—¶æ‰éœ€è¦è®¾ç½®ã€‚</strong> å¯¹äºWindowsç”¨æˆ·ï¼ŒGoé¡¹ç›®æä¾›ä¸¤ç§å®‰è£…é€‰é¡¹ï¼ˆä»æºç å®‰è£…é™¤å¤–ï¼‰ï¼š zipå‹ç¼©åŒ…éœ€è¦ä½ è®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œè€Œå®éªŒæ€§MSIå®‰è£…ç¨‹åºåˆ™ä¼šè‡ªåŠ¨é…ç½®ä½ çš„å®‰è£…ã€‚</p><h4 id="æµ‹è¯•å®‰è£…æ˜¯å¦æˆåŠŸ"><a class="header-anchor" href="#æµ‹è¯•å®‰è£…æ˜¯å¦æˆåŠŸ"></a>æµ‹è¯•å®‰è£…æ˜¯å¦æˆåŠŸ</h4><h5 id="ç¬¬ä¸€ä¸ªGoè¯­è¨€ç¨‹åº-â€”-HelloGolang-go"><a class="header-anchor" href="#ç¬¬ä¸€ä¸ªGoè¯­è¨€ç¨‹åº-â€”-HelloGolang-go"></a>ç¬¬ä¸€ä¸ªGoè¯­è¨€ç¨‹åº â€” HelloGolang.go</h5><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;    fmt.Printf(<span class="hljs-string">&quot;hello,golang\n&quot;</span>)&#125;</code></pre><p><em>è¿è¡Œï¼š</em></p><pre><code class="hljs dockerfile">go <span class="hljs-keyword">run</span><span class="bash"> HelloGolang.go</span>hello,golang</code></pre>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>å…¥é—¨</tag>
      
      <tag>ç©å…·</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>workerman --å¾ˆå–œæ¬¢çš„ä¸€ä¸ªé«˜æ€§èƒ½socket æœåŠ¡å™¨æ¡†æ¶</title>
    <link href="/2018/06/08/workerman-%E5%BE%88%E5%96%9C%E6%AC%A2%E7%9A%84%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BDsocket-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A1%86%E6%9E%B6/"/>
    <url>/2018/06/08/workerman-%E5%BE%88%E5%96%9C%E6%AC%A2%E7%9A%84%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BDsocket-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A1%86%E6%9E%B6/</url>
    
    <content type="html"><![CDATA[<h1>æœ€è¿‘é¡¹ç›®ä¸­ä¸€ç›´åœ¨ä½¿ç”¨wokerman ç¡®åˆ‡çš„è¯´åº”è¯¥æ˜¯GatewayWorkerï¼ˆåŸºäºwokermanå°è£…çš„TCPé•¿è¿æ¥åº”ç”¨æ¡†æ¶ï¼‰ã€‚</h1><p>GatewayWorkeræ˜¯åŸºäºWorkermanå¼€å‘çš„ä¸€å¥—<strong>TCPé•¿è¿æ¥</strong>çš„åº”ç”¨æ¡†æ¶ï¼Œå®ç°äº†å•å‘ã€ç¾¤å‘ã€å¹¿æ’­ç­‰æ¥å£ï¼Œå†…ç½®äº†mysqlç±»åº“ï¼ŒGatewayWorkeråˆ†ä¸ºGatewayè¿›ç¨‹å’ŒWorkerè¿›ç¨‹ï¼Œå¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œèƒ½å¤Ÿæ”¯æŒåºå¤§çš„è¿æ¥æ•°ï¼ˆç™¾ä¸‡ç”šè‡³åƒä¸‡è¿æ¥çº§åˆ«çš„åº”ç”¨ï¼‰ã€‚<br>å¯ç”¨äºå¼€å‘IMèŠå¤©åº”ç”¨ã€ç§»åŠ¨é€šè®¯ã€æ¸¸æˆåå°ã€ç‰©è”ç½‘ã€æ™ºèƒ½å®¶å±…åå°ç­‰ç­‰ã€‚GatewayWorkeræ˜¯ä¸æ”¯æŒudpçš„ï¼Œè‹¥éœ€è¦udpæœåŠ¡è¯·é€‰æ‹©wokermanã€‚</p><p>GatewayWorkerä½¿ç”¨ç»å…¸çš„Gatewayå’ŒWorkerè¿›ç¨‹æ¨¡å‹ã€‚Gatewayè¿›ç¨‹è´Ÿè´£ç»´æŒå®¢æˆ·ç«¯è¿æ¥ï¼Œå¹¶è½¬å‘å®¢æˆ·ç«¯çš„æ•°æ®ç»™BusinessWorkerè¿›ç¨‹å¤„ç†ï¼ŒBusinessWorkerè¿›ç¨‹è´Ÿè´£å¤„ç†å®é™…çš„ä¸šåŠ¡é€»è¾‘ï¼ˆé»˜è®¤è°ƒç”¨Events.phpå¤„ç†ä¸šåŠ¡ï¼‰ï¼Œå¹¶å°†ç»“æœæ¨é€ç»™å¯¹åº”çš„å®¢æˆ·ç«¯ã€‚GatewayæœåŠ¡å’ŒBusinessWorkeræœåŠ¡å¯ä»¥åˆ†å¼€éƒ¨ç½²åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œå®ç°åˆ†å¸ƒå¼é›†ç¾¤ã€‚</p><p>GatewayWorkeræä¾›éå¸¸æ–¹ä¾¿çš„APIï¼Œå¯ä»¥å…¨å±€å¹¿æ’­æ•°æ®ã€å¯ä»¥å‘æŸä¸ªç¾¤ä½“å¹¿æ’­æ•°æ®ã€ä¹Ÿå¯ä»¥å‘æŸä¸ªç‰¹å®šå®¢æˆ·ç«¯æ¨é€æ•°æ®ã€‚é…åˆWorkermançš„å®šæ—¶å™¨ï¼Œä¹Ÿå¯ä»¥å®šæ—¶æ¨é€æ•°æ®ã€‚</p><h1>GatewayWorkerç‰¹æ€§</h1><h3 id="1ã€åŸºäºWorkermanå¼€å‘"><a class="header-anchor" href="#1ã€åŸºäºWorkermanå¼€å‘"></a>1ã€åŸºäºWorkermanå¼€å‘</h3><p>GatewayWorkeræ˜¯åŸºäºWorkermanå¼€å‘çš„</p><h3 id="2ã€åŸºäºGatewayã€Workerè¿›ç¨‹æ¨¡å‹"><a class="header-anchor" href="#2ã€åŸºäºGatewayã€Workerè¿›ç¨‹æ¨¡å‹"></a>2ã€åŸºäºGatewayã€Workerè¿›ç¨‹æ¨¡å‹</h3><p>GatewayWorkerä½¿ç”¨ç»å…¸çš„Gatewayå’ŒWorkerè¿›ç¨‹æ¨¡å‹ã€‚Gatewayè¿›ç¨‹è´Ÿè´£ç»´æŒå®¢æˆ·ç«¯è¿æ¥ï¼Œå¹¶è½¬å‘å®¢æˆ·ç«¯çš„æ•°æ®ç»™Workerè¿›ç¨‹å¤„ç†ï¼›Workerè¿›ç¨‹è´Ÿè´£å¤„ç†å®é™…çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶å°†ç»“æœæ¨é€ç»™å¯¹åº”çš„å®¢æˆ·ç«¯ã€‚GatewayæœåŠ¡å’ŒWorkeræœåŠ¡å¯ä»¥åˆ†å¼€éƒ¨ç½²åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œå®ç°åˆ†å¸ƒå¼é›†ç¾¤ã€‚</p><h3 id="3ã€æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²"><a class="header-anchor" href="#3ã€æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²"></a>3ã€æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²</h3><p>GatewayWorkerå¯ä»¥éå¸¸æ–¹ä¾¿å®ç°åˆ†å¸ƒå¼éƒ¨ç½²ï¼ŒGatewayæœåŠ¡å’ŒWorkeræœåŠ¡éƒ½å¯ä»¥åˆ†å¼€éƒ¨ç½²åœ¨ä¸åŒçš„æœåŠ¡å™¨é›†ç¾¤ä¸Šã€‚å¹¶ä¸”æ“ä½œç®€å•ã€å®¹æ˜“æ‰©å®¹ã€ä¸Šä¸‹çº¿ç”¨æˆ·æ— æ„ŸçŸ¥ã€‚</p><h3 id="4ã€æ”¯æŒé«˜å¹¶å‘"><a class="header-anchor" href="#4ã€æ”¯æŒé«˜å¹¶å‘"></a>4ã€æ”¯æŒé«˜å¹¶å‘</h3><p>Gatewayè¿›ç¨‹åªè´Ÿè´£ç½‘ç»œIOï¼ŒWorkerè¿›ç¨‹è´Ÿè´£ä¸šåŠ¡é€»è¾‘ã€‚å…¶ä¸­æ¯ä¸ªGatewayè¿›ç¨‹å¯ä»¥ç»´æŒä¸Šä¸‡çš„å¹¶å‘è¿æ¥ï¼Œå¤šä¸ªGatewayè¿›ç¨‹å¯ä»¥ç»´æŒæ•°åä¸‡ç”šè‡³ç™¾ä¸‡çš„å¹¶å‘è¿æ¥ï¼ŒGatewayé›†ç¾¤åˆ™å¯ä»¥ç»´æŒåƒä¸‡çº§åˆ«çš„å¹¶å‘è¿æ¥ã€‚</p><h3 id="5ã€æ”¯æŒå…¨å±€å¹¿æ’­æˆ–è€…å‘ä»»æ„å®¢æˆ·ç«¯æ¨é€æ•°æ®"><a class="header-anchor" href="#5ã€æ”¯æŒå…¨å±€å¹¿æ’­æˆ–è€…å‘ä»»æ„å®¢æˆ·ç«¯æ¨é€æ•°æ®"></a>5ã€æ”¯æŒå…¨å±€å¹¿æ’­æˆ–è€…å‘ä»»æ„å®¢æˆ·ç«¯æ¨é€æ•°æ®</h3><p>GatewayWorkeræä¾›éå¸¸æ–¹ä¾¿çš„APIï¼Œå¯ä»¥å…¨å±€å¹¿æ’­æ•°æ®ã€å¯ä»¥å‘æŸä¸ªç¾¤ä½“å¹¿æ’­æ•°æ®ã€ä¹Ÿå¯ä»¥å‘æŸä¸ªç‰¹å®šå®¢æˆ·ç«¯æ¨é€æ•°æ®ã€‚é…åˆWorkermançš„å®šæ—¶å™¨ï¼Œä¹Ÿå¯ä»¥å®šæ—¶æ¨é€æ•°æ®ã€‚</p><h3 id="6ã€æ”¯æŒå„ç§åº”ç”¨å±‚åè®®"><a class="header-anchor" href="#6ã€æ”¯æŒå„ç§åº”ç”¨å±‚åè®®"></a>6ã€æ”¯æŒå„ç§åº”ç”¨å±‚åè®®</h3><p>WorkerManæ¥å£ä¸Šæ”¯æŒå„ç§åº”ç”¨å±‚åè®®ï¼ŒåŒ…æ‹¬è‡ªå®šä¹‰åè®®ã€‚åŒæ ·GatewayWorkerä¹Ÿæ”¯æŒå„ç§åº”ç”¨å±‚åè®®ã€‚</p><h3 id="7ã€å¤šåè®®æ”¯æŒ"><a class="header-anchor" href="#7ã€å¤šåè®®æ”¯æŒ"></a>7ã€å¤šåè®®æ”¯æŒ</h3><p>æœ‰æ—¶åº”ç”¨å®¢æˆ·ç«¯æ‰€ä½¿ç”¨çš„åè®®ä¸æ­¢ä¸€ç§ï¼Œä¾‹å¦‚PCç½‘é¡µå®¢æˆ·ç«¯ä½¿ç”¨çš„æ˜¯WebSocketåè®®ï¼Œè€Œæ‰‹æœºAppä½¿ç”¨çš„æ˜¯å…¶å®ƒåè®®ã€‚GatewayWorkerå¯ä»¥éå¸¸æ–¹ä¾¿çš„æ”¯æŒå¤šåè®®ï¼Œåªéœ€è¦ä»¥ä¸åŒçš„åè®®å¼€ä¸åŒçš„ç«¯å£å³å¯ï¼Œä¸šåŠ¡ä»£ç æ— éœ€æ”¹åŠ¨ã€‚</p><h3 id="8ã€æ”¯æŒå¯¹è±¡æˆ–è€…èµ„æºæ°¸ä¹…ä¿æŒ"><a class="header-anchor" href="#8ã€æ”¯æŒå¯¹è±¡æˆ–è€…èµ„æºæ°¸ä¹…ä¿æŒ"></a>8ã€æ”¯æŒå¯¹è±¡æˆ–è€…èµ„æºæ°¸ä¹…ä¿æŒ</h3><p>WorkerManåœ¨è¿è¡Œè¿‡ç¨‹ä¸­åªä¼šè½½å…¥è§£æä¸€æ¬¡PHPæ–‡ä»¶ï¼Œç„¶åä¾¿å¸¸é©»å†…å­˜ï¼Œè¿™ä½¿å¾—ç±»åŠå‡½æ•°å£°æ˜ã€PHPæ‰§è¡Œç¯å¢ƒã€ç¬¦å·è¡¨ç­‰ä¸ä¼šé‡å¤åˆ›å»ºé”€æ¯ï¼Œè¿™ä¸Webå®¹å™¨ä¸‹è¿è¡Œçš„PHPæœºåˆ¶æ˜¯å®Œå…¨ä¸åŒçš„ã€‚åœ¨WorkerManä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹ç”Ÿå‘½å‘¨æœŸå†…é™æ€æˆå‘˜æˆ–è€…å…¨å±€å˜é‡åœ¨ä¸ä¸»åŠ¨é”€æ¯çš„æƒ…å†µä¸‹æ˜¯æ°¸ä¹…ä¿æŒçš„ï¼Œä¹Ÿå°±æ˜¯å°†å¯¹è±¡æˆ–è€…é“¾æ¥ç­‰èµ„æºæ”¾åˆ°å…¨å±€å˜é‡æˆ–è€…ç±»é™æ€æˆå‘˜ä¸­åˆ™æ•´ä¸ªè¿›ç¨‹ç”Ÿå‘½å‘¨æœŸå†…çš„æ‰€æœ‰è¯·æ±‚éƒ½å¯ä»¥å¤ç”¨ã€‚ä¾‹å¦‚åªè¦å•ä¸ªè¿›ç¨‹å†…åˆå§‹åŒ–ä¸€æ¬¡æ•°æ®åº“è¿æ¥ï¼Œåˆ™ä»¥åè¿™ä¸ªè¿›ç¨‹çš„æ‰€æœ‰è¯·æ±‚éƒ½å¯ä»¥å¤ç”¨è¿™ä¸ªæ•°æ®åº“è¿æ¥ï¼Œé¿å…äº†é¢‘ç¹è¿æ¥æ•°æ®åº“è¿‡ç¨‹ä¸­TCPä¸‰æ¬¡æ¡æ‰‹ã€ æ•°æ®åº“æƒé™éªŒè¯ã€æ–­å¼€è¿æ¥æ—¶TCPå››æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ï¼Œæå¤§çš„æé«˜äº†åº”ç”¨ç¨‹åºæ•ˆç‡ã€‚</p><h3 id="9ã€é«˜æ€§èƒ½"><a class="header-anchor" href="#9ã€é«˜æ€§èƒ½"></a>9ã€é«˜æ€§èƒ½</h3><p>ç”±äºphpæ–‡ä»¶ä»ç£ç›˜è¯»å–è§£æä¸€æ¬¡åä¾¿ä¼šå¸¸é©»å†…å­˜ï¼Œä¸‹æ¬¡ä½¿ç”¨æ—¶ç›´æ¥ä½¿ç”¨å†…å­˜ä¸­çš„opcodeï¼Œ æå¤§çš„å‡å°‘äº†ç£ç›˜IOåŠPHPä¸­è¯·æ±‚åˆå§‹åŒ–ã€åˆ›å»ºæ‰§è¡Œç¯å¢ƒã€è¯æ³•è§£æã€è¯­æ³•è§£æã€ç¼–è¯‘opcodeã€è¯·æ±‚å…³é—­ç­‰è¯¸å¤šè€—æ—¶è¿‡ç¨‹ï¼Œ å¹¶ä¸”ä¸ä¾èµ–nginxã€apacheç­‰å®¹å™¨ï¼Œå°‘äº†nginxç­‰å®¹å™¨ä¸PHPé€šä¿¡çš„å¼€é”€ï¼Œæœ€ä¸»è¦çš„æ˜¯èµ„æºå¯ä»¥æ°¸ä¹…ä¿æŒï¼Œä¸å¿…æ¯æ¬¡åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ç­‰ç­‰ï¼Œ æ‰€ä»¥ä½¿ç”¨WorkerManå¼€å‘åº”ç”¨ç¨‹åºï¼Œæ€§èƒ½éå¸¸é«˜ã€‚</p><h3 id="10ã€æ”¯æŒHHVM"><a class="header-anchor" href="#10ã€æ”¯æŒHHVM"></a>10ã€æ”¯æŒHHVM</h3><p>æ”¯æŒåœ¨HHVMè™šæ‹Ÿæœºä¸Šè¿è¡Œï¼Œå¯æˆå€æå‡PHPæ€§èƒ½ã€‚å°¤å…¶æ˜¯åœ¨cpuå¯†é›†è¿ç®—ä¸šåŠ¡ä¸­ï¼Œæ€§èƒ½éå¸¸ä¼˜å¼‚ï¼Œæ˜¯PHP Zendè™šæ‹Ÿæœº8å€å·¦å³ã€‚é€šè¿‡å®é™…å‹åŠ›æµ‹è¯•å¯¹æ¯”ï¼Œåœ¨æ²¡æœ‰è´Ÿè½½ä¸šåŠ¡çš„æƒ…å†µä¸‹ï¼ŒWorkerManåœ¨HHVMä¸‹è¿è¡Œæ¯”åœ¨Zend PHP5.6è¿è¡Œç½‘ç»œååé‡æé«˜äº†30-80%å·¦å³</p><h3 id="11ã€æ–¹ä¾¿ä¸å…¶å®ƒé¡¹ç›®é›†æˆ"><a class="header-anchor" href="#11ã€æ–¹ä¾¿ä¸å…¶å®ƒé¡¹ç›®é›†æˆ"></a>11ã€æ–¹ä¾¿ä¸å…¶å®ƒé¡¹ç›®é›†æˆ</h3><p>é’ˆå¯¹å…¶å®ƒé¡¹ç›®ï¼ŒGatewayWorkeræä¾›æ¨é€éå¸¸ç®€å•æ–¹ä¾¿çš„APIï¼Œå¯ä»¥åœ¨ä»»ä½•é¡¹ç›®ä¸­ä½¿ç”¨è¿™ä¸ªAPIå‘æ‰€æœ‰å®¢æˆ·ç«¯æˆ–è€…ç‰¹å®šå®¢æˆ·ç«¯æ¨é€æ•°æ®ï¼Œæ¯”å¦‚åœ¨æ™®é€šWebé¡¹ç›®ä¸­æ¨é€æ•°æ®ã€‚</p><h3 id="12ã€æ”¯æŒä»£ç çƒ­æ›´æ–°"><a class="header-anchor" href="#12ã€æ”¯æŒä»£ç çƒ­æ›´æ–°"></a>12ã€æ”¯æŒä»£ç çƒ­æ›´æ–°</h3><p>å¯ä»¥reload Workerè¿›ç¨‹å®ç°ä¸šåŠ¡ä»£ç æ›´æ–°å‡çº§ï¼Œè€Œä¸å¿…æ‹…å¿ƒå®¢æˆ·ç«¯è¿æ¥ä¼šæ–­å¼€ï¼Œå› ä¸ºå®¢æˆ·ç«¯è¿æ¥éƒ½ç”±Gatewayè¿›ç¨‹ç»´æŒã€‚</p><h3 id="13ã€æ”¯æŒé•¿è¿æ¥"><a class="header-anchor" href="#13ã€æ”¯æŒé•¿è¿æ¥"></a>13ã€æ”¯æŒé•¿è¿æ¥</h3><p>GatewayWorkerä¸»è¦ç”¨äºé•¿è¿æ¥å³æ—¶é€šè®¯åº”ç”¨ã€‚å¦‚æ¸¸æˆæœåŠ¡å™¨ã€ç‰©è”ç½‘äº‘æœåŠ¡ã€IMã€ç§»åŠ¨åº”ç”¨ç­‰ã€‚</p><p>workermançš„æ‰‹å†Œå¯¹å¼€å‘è€…éå¸¸å‹å¥½ï¼ŒåŸºæœ¬æ¯ä¸€ä¸ªç‚¹éƒ½å†™çš„å¾ˆæ¸…æ™°æ˜äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»å®˜ç½‘çœ‹çœ‹å®ƒçš„æ‰‹å†Œã€‚</p><p>æ‰‹å†Œåœ°å€ï¼š<a href="https://doc2.workerman.net/">https://doc2.workerman.net/</a></p><p>ä¸‹é¢è®²ä¸‹æœ€è¿‘æ˜¨å¤©ç”¨çš„å¾ˆå¤šçš„å®šæ—¶å™¨ï¼ˆçº¯PHPçš„å®šæ—¶å™¨ï¼Œç®€ç›´ä¸è¦å¤ªé«˜çº§å•Šï¼ï¼ï¼ï¼‰</p><p>Timer::add(float $time_interval, callable $callback [,$args = array(), bool $persistent = true]) //åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨</p><p>æ³¨æ„ï¼šå®šæ—¶å™¨æ˜¯åœ¨å½“å‰è¿›ç¨‹ä¸­è¿è¡Œçš„ï¼Œworkermanä¸­ä¸ä¼šåˆ›å»ºæ–°çš„è¿›ç¨‹æˆ–è€…çº¿ç¨‹å»è¿è¡Œå®šæ—¶å™¨ã€‚</p><h3 id="å‚æ•°"><a class="header-anchor" href="#å‚æ•°"></a>å‚æ•°</h3><p>time_interval</p><p>å¤šé•¿æ—¶é—´æ‰§è¡Œä¸€æ¬¡ï¼Œå•ä½ç§’ï¼Œæ”¯æŒå°æ•°ï¼Œå¯ä»¥ç²¾ç¡®åˆ°0.001ï¼Œå³ç²¾ç¡®åˆ°æ¯«ç§’çº§åˆ«ã€‚</p><p>callback</p><p>å›è°ƒå‡½æ•°æ³¨æ„ï¼šå¦‚æœå›è°ƒå‡½æ•°æ˜¯ç±»çš„æ–¹æ³•ï¼Œåˆ™æ–¹æ³•å¿…é¡»æ˜¯publicå±æ€§</p><p>args</p><p>å›è°ƒå‡½æ•°çš„å‚æ•°ï¼Œå¿…é¡»ä¸ºæ•°ç»„ï¼Œæ•°ç»„å…ƒç´ ä¸ºå‚æ•°å€¼</p><p>persistent</p><p>æ˜¯å¦æ˜¯æŒä¹…çš„ï¼Œå¦‚æœåªæƒ³å®šæ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œåˆ™ä¼ é€’falseï¼ˆåªæ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡åœ¨æ‰§è¡Œå®Œæ¯•åä¼šè‡ªåŠ¨é”€æ¯ï¼Œä¸å¿…è°ƒç”¨Timer::del()ï¼‰ã€‚é»˜è®¤æ˜¯trueï¼Œå³ä¸€ç›´å®šæ—¶æ‰§è¡Œã€‚</p><p>æ¯ä¸ªå®šæ—¶å™¨éƒ½ä¼šè¿”å›ä¸€ä¸ª timeridï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Timer::del($timerid)é”€æ¯è¿™ä¸ªå®šæ—¶å™¨ã€‚</p><p><strong>ç”¨æ³•ï¼š</strong></p><p><strong>1. å®šæ—¶å‡½æ•°ä¸ºåŒ¿åå‡½æ•°ï¼ˆé—­åŒ…ï¼‰</strong></p><p>// æ¯2.5ç§’æ‰§è¡Œä¸€æ¬¡</p><p>$time_interval = 2.5;<br>Timer::add($time_interval, function() { echo â€œtask run\nâ€;<br>});</p><p><strong>2</strong>**.** <strong>å®šæ—¶å‡½æ•°ä¸ºåŒ¿åå‡½æ•°ï¼Œåˆ©ç”¨é—­åŒ…ä¼ é€’å‚æ•°</strong></p><p>// æ¯10ç§’æ‰§è¡Œä¸€æ¬¡ $time_interval = 10;<br>$connect_time = time(); // ç»™connectionå¯¹è±¡ä¸´æ—¶æ·»åŠ ä¸€ä¸ªtimer_idå±æ€§ä¿å­˜å®šæ—¶å™¨id $connection-&gt;timer_id = Timer::add($time_interval, function()use($connect_time) {<br>$connection-&gt;send($connect_time);<br>});</p><h3 id=""><a class="header-anchor" href="#"></a></h3><pre><code>3ã€å®šæ—¶å™¨å‡½æ•°ä¸ºåŒ¿åå‡½æ•°ï¼Œåˆ©ç”¨å®šæ—¶å™¨æ¥å£ä¼ é€’å‚æ•°</code></pre><p>// æ¯10ç§’æ‰§è¡Œä¸€æ¬¡ $time_interval = 10;<br>$connect_time = time(); // ç»™connectionå¯¹è±¡ä¸´æ—¶æ·»åŠ ä¸€ä¸ªtimer_idå±æ€§ä¿å­˜å®šæ—¶å™¨id $connection-&gt;timer_id = Timer::add($time_interval, function($connection, $connect_time) {<br>$connection-&gt;send($connect_time);<br>}, array($connection, $connect_time));<br>}; // è¿æ¥å…³é—­æ—¶ï¼Œåˆ é™¤å¯¹åº”è¿æ¥çš„å®šæ—¶å™¨ $ws_worker-&gt;onClose = function($connection) { // åˆ é™¤å®šæ—¶å™¨ Timer::del($connection-&gt;timer_id);<br>};</p><h3 id="-2"><a class="header-anchor" href="#-2"></a></h3><pre><code>4ã€å®šæ—¶å‡½æ•°ä¸ºæ™®é€šå‡½æ•°</code></pre><p>function send_mail($to, $content){}</p><p>// 10ç§’åæ‰§è¡Œå‘é€é‚®ä»¶ä»»åŠ¡ï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¼ é€’falseï¼Œè¡¨ç¤ºåªè¿è¡Œä¸€æ¬¡ Timer::add(10, â€˜send_mailâ€™, array($to, $content), false);</p><h3 id="-3"><a class="header-anchor" href="#-3"></a></h3><pre><code>5ã€å®šæ—¶å‡½æ•°ä¸ºç±»çš„æ–¹æ³•</code></pre><p>class Mail { // æ³¨æ„ï¼Œå›è°ƒå‡½æ•°å±æ€§å¿…é¡»æ˜¯public public function send($to, $content) { echo â€œsend mail â€¦\nâ€;</p><p>}</p><p>}</p><p>// 10ç§’åå‘é€ä¸€æ¬¡é‚®ä»¶ $mail = new Mail();<br>$to = â€˜workerman@workerman.netâ€™;<br>$content = â€˜hello workermanâ€™;<br>Timer::add(10, array($mail, â€˜sendâ€™), array($to, $content), false);</p><h3 id="-4"><a class="header-anchor" href="#-4"></a></h3><pre><code>6ã€å®šæ—¶å‡½æ•°ä¸ºç±»çš„é™æ€æ–¹æ³•</code></pre><p>class Mail {</p><p>// æ³¨æ„è¿™ä¸ªæ˜¯é™æ€æ–¹æ³•ï¼Œå›è°ƒå‡½æ•°å±æ€§ä¹Ÿå¿…é¡»æ˜¯public public static function send($to, $content) { echo â€œsend mail â€¦\nâ€;<br>}<br>}</p><p>// 10ç§’åå‘é€ä¸€æ¬¡é‚®ä»¶ $to = â€˜workerman@workerman.netâ€™;<br>$content = â€˜hello workermanâ€™; // å®šæ—¶è°ƒç”¨ç±»çš„é™æ€æ–¹æ³• Timer::add(10, array(â€˜Mailâ€™, â€˜sendâ€™), array($to, $content), false);</p>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>workerman</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é€šä¿—åŒ– HTTPS</title>
    <link href="/2018/05/31/%E9%80%9A%E4%BF%97%E5%8C%96-https/"/>
    <url>/2018/05/31/%E9%80%9A%E4%BF%97%E5%8C%96-https/</url>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡è¯•å›¾ä»¥é€šä¿—æ˜“é€šçš„æ–¹å¼ä»‹ç»Httpsçš„å·¥ä½œåŸç†ï¼Œä¸çº ç»“å…·ä½“çš„æœ¯è¯­ï¼Œä¸è€ƒè¯ä¸¥æ ¼çš„æµç¨‹ã€‚æˆ‘ç›¸ä¿¡å¼„æ‡‚äº†åŸç†ä¹‹åï¼Œåˆ°äº†å…·ä½“æ“ä½œå’Œå®ç°çš„æ—¶å€™ï¼Œæ–¹å‘å°±ä¸ä¼šé”™ï¼Œç„¶åæ¡æ¡å¤§è·¯é€šç½—é©¬ã€‚é˜…è¯»æ–‡æœ¬éœ€è¦æå‰å¤§è‡´äº†è§£å¯¹ç§°åŠ å¯†ã€éå¯¹ç§°åŠ å¯†ã€ä¿¡æ¯è®¤è¯ç­‰å¯†ç å­¦çŸ¥è¯†ã€‚å¦‚æœä½ ä¸å¤ªäº†è§£ï¼Œå¯ä»¥é˜…è¯»Erlangå‘æ˜äººJoe Armstrongæœ€è¿‘å†™çš„<a href="https://github.com/joearms/crypto_tutorial">Cryptography Tutorial</a>ã€‚å¤§ç‰›å‡ºå“ï¼Œé€šä¿—æ˜“æ‡‚ï¼Œå¼ºåŠ›æ¨èã€‚</p><h3 id="Httpsæ¶‰åŠåˆ°çš„ä¸»ä½“"><a class="header-anchor" href="#Httpsæ¶‰åŠåˆ°çš„ä¸»ä½“"></a>Httpsæ¶‰åŠåˆ°çš„ä¸»ä½“</h3><ol><li>å®¢æˆ·ç«¯ã€‚é€šå¸¸æ˜¯æµè§ˆå™¨(Chromeã€IEã€FireFoxç­‰)ï¼Œä¹Ÿå¯ä»¥è‡ªå·±ç¼–å†™çš„å„ç§è¯­è¨€çš„å®¢æˆ·ç«¯ç¨‹åºã€‚</li><li>æœåŠ¡ç«¯ã€‚ä¸€èˆ¬æŒ‡æ”¯æŒHttpsçš„ç½‘ç«™ï¼Œæ¯”å¦‚githubã€æ”¯ä»˜å®ã€‚</li><li>CA(Certificate Authorities)æœºæ„ã€‚Httpsè¯ä¹¦ç­¾å‘å’Œç®¡ç†æœºæ„ï¼Œæ¯”å¦‚Symantecã€Comodoã€GoDaddyã€GlobalSignã€‚</li></ol><p>ä¸‹å›¾é‡Œæˆ‘ç”»å‡ºäº†è¿™å‡ ä¸ªè§’è‰²ï¼š<br><a href="https://imgchr.com/i/BCmllj"><img src="https://s1.ax1x.com/2020/10/21/BCmllj.md.png" alt="BCmllj.md.png"></a></p><h3 id="å‘æ˜Httpsçš„åŠ¨æœº"><a class="header-anchor" href="#å‘æ˜Httpsçš„åŠ¨æœº"></a>å‘æ˜Httpsçš„åŠ¨æœº</h3><ol><li>è®¤è¯æ­£åœ¨è®¿é—®çš„ç½‘ç«™ã€‚ä»€ä¹ˆå«è®¤è¯ç½‘ç«™ï¼Ÿæ¯”å¦‚ä½ æ­£åœ¨è®¿é—®æ”¯ä»˜å®ï¼Œæ€æ ·ç¡®å®šä½ æ­£åœ¨è®¿é—®çš„æ˜¯é˜¿é‡Œå·´å·´æä¾›çš„æ”¯ä»˜å®è€Œä¸æ˜¯å‡å†’ä¼ªåŠ£çš„é’“é±¼ç½‘ç«™å‘¢ï¼Ÿ</li><li>ä¿è¯æ‰€ä¼ è¾“æ•°æ®çš„ç§å¯†æ€§å’Œå®Œæ•´æ€§ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒHttpæ˜¯æ˜æ–‡ä¼ è¾“çš„ï¼Œæ‰€ä»¥å¤„åœ¨åŒä¸€ç½‘ç»œä¸­çš„å…¶å®ƒç”¨æˆ·å¯ä»¥é€šè¿‡ç½‘ç»œæŠ“åŒ…æ¥çªƒå–å’Œç¯¡æ”¹æ•°æ®åŒ…çš„å†…å®¹ï¼Œç”šè‡³è¿è¥å•†æˆ–è€…wifiæä¾›è€…ï¼Œæœ‰å¯èƒ½ä¼šç¯¡æ”¹httpæŠ¥æ–‡ï¼Œæ·»åŠ å¹¿å‘Šç­‰ä¿¡æ¯ä»¥è¾¾åˆ°ç›ˆåˆ©çš„ç›®çš„ã€‚</li></ol><h3 id="Httpsçš„å·¥ä½œæµç¨‹"><a class="header-anchor" href="#Httpsçš„å·¥ä½œæµç¨‹"></a>Httpsçš„å·¥ä½œæµç¨‹</h3><p>è¿™ä¸€èŠ‚é€šè¿‡ä»‹ç»Httpsåè®®çš„å·¥ä½œæµç¨‹ï¼Œæ¥è¯´æ˜Httpsæ˜¯å¦‚ä½•è¾¾æˆè‡ªå·±çš„ä¸¤ä¸ªç›®çš„çš„ã€‚ä¸‹å›¾æˆ‘ç”»å‡ºäº†Httpsçš„å·¥ä½œæµç¨‹ï¼Œæ³¨æ„ï¼Œè¿™åªæ˜¯åŸç†ç¤ºæ„å›¾ï¼Œå¹¶ä¸æ˜¯è¯¦ç»†çš„åè®®è§£æã€‚</p><p><a href="https://imgchr.com/i/BCmNkT"><img src="https://s1.ax1x.com/2020/10/21/BCmNkT.md.png" alt="BCmNkT.md.png"></a></p><p>å¯ä»¥çœ‹åˆ°å·¥ä½œæµç¨‹ï¼ŒåŸºæœ¬åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ol><li><p>è®¤è¯æœåŠ¡å™¨ã€‚æµè§ˆå™¨å†…ç½®ä¸€ä¸ªå—ä¿¡ä»»çš„CAæœºæ„åˆ—è¡¨ï¼Œå¹¶ä¿å­˜äº†è¿™äº›CAæœºæ„çš„è¯ä¹¦ã€‚ç¬¬ä¸€é˜¶æ®µæœåŠ¡å™¨ä¼šæä¾›ç»CAæœºæ„è®¤è¯é¢å‘çš„æœåŠ¡å™¨è¯ä¹¦ï¼Œå¦‚æœè®¤è¯è¯¥æœåŠ¡å™¨è¯ä¹¦çš„CAæœºæ„ï¼Œå­˜åœ¨äºæµè§ˆå™¨çš„å—ä¿¡ä»»CAæœºæ„åˆ—è¡¨ä¸­ï¼Œå¹¶ä¸”æœåŠ¡å™¨è¯ä¹¦ä¸­çš„ä¿¡æ¯ä¸å½“å‰æ­£åœ¨è®¿é—®çš„ç½‘ç«™ï¼ˆåŸŸåç­‰ï¼‰ä¸€è‡´ï¼Œé‚£ä¹ˆæµè§ˆå™¨å°±è®¤ä¸ºæœåŠ¡ç«¯æ˜¯å¯ä¿¡çš„ï¼Œå¹¶ä»æœåŠ¡å™¨è¯ä¹¦ä¸­å–å¾—æœåŠ¡å™¨å…¬é’¥ï¼Œç”¨äºåç»­æµç¨‹ã€‚å¦åˆ™ï¼Œæµè§ˆå™¨å°†æç¤ºç”¨æˆ·ï¼Œæ ¹æ®ç”¨æˆ·çš„é€‰æ‹©ï¼Œå†³å®šæ˜¯å¦ç»§ç»­ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥ç®¡ç†è¿™ä¸ªå—ä¿¡ä»»CAæœºæ„åˆ—è¡¨ï¼Œæ·»åŠ æˆ‘ä»¬æƒ³è¦ä¿¡ä»»çš„CAæœºæ„ï¼Œæˆ–è€…ç§»é™¤æˆ‘ä»¬ä¸ä¿¡ä»»çš„CAæœºæ„ã€‚</p></li><li><p>åå•†ä¼šè¯å¯†é’¥ã€‚å®¢æˆ·ç«¯åœ¨è®¤è¯å®ŒæœåŠ¡å™¨ï¼Œè·å¾—æœåŠ¡å™¨çš„å…¬é’¥ä¹‹åï¼Œåˆ©ç”¨è¯¥å…¬é’¥ä¸æœåŠ¡å™¨è¿›è¡ŒåŠ å¯†é€šä¿¡ï¼Œåå•†å‡ºä¸¤ä¸ªä¼šè¯å¯†é’¥ï¼Œåˆ†åˆ«æ˜¯ç”¨äºåŠ å¯†å®¢æˆ·ç«¯å¾€æœåŠ¡ç«¯å‘é€æ•°æ®çš„å®¢æˆ·ç«¯ä¼šè¯å¯†é’¥ï¼Œç”¨äºåŠ å¯†æœåŠ¡ç«¯å¾€å®¢æˆ·ç«¯å‘é€æ•°æ®çš„æœåŠ¡ç«¯ä¼šè¯å¯†é’¥ã€‚åœ¨å·²æœ‰æœåŠ¡å™¨å…¬é’¥ï¼Œå¯ä»¥åŠ å¯†é€šè®¯çš„å‰æä¸‹ï¼Œè¿˜è¦åå•†ä¸¤ä¸ªå¯¹ç§°å¯†é’¥çš„åŸå› ï¼Œæ˜¯å› ä¸ºéå¯¹ç§°åŠ å¯†ç›¸å¯¹å¤æ‚åº¦æ›´é«˜ï¼Œåœ¨æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨å¯¹ç§°åŠ å¯†ï¼Œå¯ä»¥èŠ‚çœè®¡ç®—èµ„æºã€‚å¦å¤–ï¼Œä¼šè¯å¯†é’¥æ˜¯éšæœºç”Ÿæˆï¼Œæ¯æ¬¡åå•†éƒ½ä¼šæœ‰ä¸ä¸€æ ·çš„ç»“æœï¼Œæ‰€ä»¥å®‰å…¨æ€§ä¹Ÿæ¯”è¾ƒé«˜ã€‚</p></li><li><p>åŠ å¯†é€šè®¯ã€‚æ­¤æ—¶å®¢æˆ·ç«¯æœåŠ¡å™¨åŒæ–¹éƒ½æœ‰äº†æœ¬æ¬¡é€šè®¯çš„ä¼šè¯å¯†é’¥ï¼Œä¹‹åä¼ è¾“çš„æ‰€æœ‰Httpæ•°æ®ï¼Œéƒ½é€šè¿‡ä¼šè¯å¯†é’¥åŠ å¯†ã€‚è¿™æ ·ç½‘è·¯ä¸Šçš„å…¶å®ƒç”¨æˆ·ï¼Œå°†å¾ˆéš¾çªƒå–å’Œç¯¡æ”¹å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´ä¼ è¾“çš„æ•°æ®ï¼Œä»è€Œä¿è¯äº†æ•°æ®çš„ç§å¯†æ€§å’Œå®Œæ•´æ€§ã€‚</p></li></ol><h3 id="ä½¿ç”¨Httpsçš„æµç¨‹"><a class="header-anchor" href="#ä½¿ç”¨Httpsçš„æµç¨‹"></a>ä½¿ç”¨Httpsçš„æµç¨‹</h3><p>å¦‚æœä½ æ˜¯ä¸€ä¸ªæœåŠ¡å™¨å¼€å‘è€…ï¼Œæƒ³ä½¿ç”¨Httpsæ¥ä¿æŠ¤è‡ªå·±çš„æœåŠ¡å’Œç”¨æˆ·æ•°æ®å®‰å…¨ï¼Œä½ å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æµç¨‹æ¥æ“ä½œã€‚</p><p><a href="https://imgchr.com/i/BCmwp4"><img src="https://s1.ax1x.com/2020/10/21/BCmwp4.png" alt="BCmwp4.png"></a></p><h3 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“"></a>æ€»ç»“</h3><ol><li>è¯´æ˜¯è®¨è®ºHttpsï¼Œäº‹å®ä¸ŠHttpså°±æ˜¯Httpè·‘åœ¨SSlæˆ–è€…TLSä¸Šï¼Œæ‰€ä»¥æœ¬æ–‡è®¨è®ºçš„åŸç†å’Œæµç¨‹å…¶å®æ˜¯SSLå’ŒTLSçš„æµç¨‹ï¼Œå¯¹äºå…¶å®ƒä½¿ç”¨SSLæˆ–è€…TLSçš„åº”ç”¨å±‚åè®®ï¼Œæœ¬æ–‡å†…å®¹ä¸€æ ·æœ‰æ•ˆã€‚</li><li>æœ¬æ–‡åªè®¨è®ºäº†å®¢æˆ·ç«¯éªŒè¯æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯ä¹Ÿå¯ä»¥ç»™å®¢æˆ·ç«¯é¢å‘è¯ä¹¦å¹¶éªŒè¯å®¢æˆ·ç«¯ï¼ŒåšåŒå‘éªŒè¯ï¼Œä½†åº”ç”¨æ²¡æœ‰é‚£ä¹ˆå¹¿æ³›ï¼ŒåŸç†ç±»ä¼¼ã€‚</li><li>ç”±äºé‡‡ç”¨äº†åŠ å¯†é€šè®¯ï¼ŒHttpsæ— ç–‘è¦æ¯”Httpæ›´è€—è´¹æœåŠ¡å™¨èµ„æºï¼Œè¿™ä¹Ÿæ˜¯å¾ˆå¤šå…¬å¸æ˜æ˜æ”¯æŒHttpså´é»˜è®¤æä¾›Httpçš„åŸå› ã€‚</li></ol><p>è½¬ï¼š<a href="https://www.cnblogs.com/xinzhao/p/4949344.html">https://www.cnblogs.com/xinzhao/p/4949344.html</a></p>]]></content>
    
    
    <categories>
      
      <category>ç½‘ç»œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>https</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é˜¿é‡Œäº‘ecsè·¨è´¦å·ã€è·¨åŒºåŸŸé€šä¿¡</title>
    <link href="/2018/05/29/%E9%98%BF%E9%87%8C%E4%BA%91ecs%E8%B7%A8%E8%B4%A6%E5%8F%B7%E3%80%81%E8%B7%A8%E5%8C%BA%E5%9F%9F%E9%80%9A%E4%BF%A1/"/>
    <url>/2018/05/29/%E9%98%BF%E9%87%8C%E4%BA%91ecs%E8%B7%A8%E8%B4%A6%E5%8F%B7%E3%80%81%E8%B7%A8%E5%8C%BA%E5%9F%9F%E9%80%9A%E4%BF%A1/</url>
    
    <content type="html"><![CDATA[<h2 id="æ­¥éª¤ä¸€ï¼šåˆ›å»ºå‘èµ·ç«¯è·¯ç”±å™¨æ¥å£"><a class="header-anchor" href="#æ­¥éª¤ä¸€ï¼šåˆ›å»ºå‘èµ·ç«¯è·¯ç”±å™¨æ¥å£"></a>æ­¥éª¤ä¸€ï¼šåˆ›å»ºå‘èµ·ç«¯è·¯ç”±å™¨æ¥å£</h2><p>åœ¨æ­å»ºé«˜é€Ÿé€šé“çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦åœ¨ä¸¤ä¾§VPCçš„è·¯ç”±å™¨ä¸Šåˆ†åˆ«åˆ›å»ºå‘èµ·ç«¯å’Œæ¥å—ç«¯è·¯ç”±å™¨æ¥å£ï¼Œç„¶åç”±å‘èµ·ç«¯å‘èµ·VPCè¿æ¥ã€‚</p><p>å®Œæˆä»¥ä¸‹æ“ä½œï¼Œåœ¨è´¦å·Aä¸‹çš„VPCä¸­åˆ›å»ºå‘èµ·ç«¯çš„è·¯ç”±å™¨æ¥å£ï¼š</p><ol><li><p>ä½¿ç”¨è´¦å·Aç™»å½•<a href="https://vpc.console.aliyun.com/expressConnect#/connection/cn-beijing/list">é«˜é€Ÿé€šé“ç®¡ç†æ§åˆ¶å°</a>ã€‚</p></li><li><p>åœ¨å·¦ä¾§å¯¼èˆªæ ï¼Œå•å‡»ä¸“æœ‰ç½‘ç»œè¿æ¥ &gt; è·¯ç”±å™¨æ¥å£ã€‚</p></li><li><p>å•å‡»åˆ›å»ºè·¯ç”±å™¨æ¥å£ï¼Œå‚è€ƒä»¥ä¸‹é…ç½®ï¼Œåˆ›å»ºè·¯ç”±å™¨æ¥å£ã€‚å…·ä½“é…ç½®è¯´æ˜ï¼Œå‚è§<a href="https://help.aliyun.com/document_detail/49136.html">åˆ›å»ºè·¯ç”±å™¨æ¥å£</a>ã€‚</p></li></ol><ul><li><p>è®¡è´¹æ–¹å¼ï¼šé€‰æ‹©ä¸€ç§è®¡è´¹æ–¹å¼ï¼Œæœ¬æ“ä½œä¸­é€‰æ‹©æŒ‰é‡ä»˜è´¹ã€‚</p></li><li><p>è¿æ¥åœºæ™¯ï¼šé€‰æ‹©VPCäº’è¿</p></li><li><p>åˆ›å»ºè·¯ç”±å™¨æ¥å£åœºæ™¯ï¼šé€‰æ‹©åªåˆ›å»ºå‘èµ·ç«¯</p></li><li><p>åœ°åŸŸï¼šé€‰æ‹©æœ¬ç«¯VPCçš„æ‰€å±åœ°åŸŸï¼Œæœ¬æ“ä½œä¸­é€‰æ‹©ååŒ—2(åŒ—äº¬)ã€‚</p></li><li><p>æœ¬ç«¯VPC IDï¼šé€‰æ‹©å‘èµ·ç«¯çš„VPCï¼Œæœ¬æ“ä½œä¸­é€‰æ‹©VPC Açš„IDã€‚</p></li><li><p>å¯¹ç«¯åœ°åŸŸï¼šé€‰æ‹©è¦è¿æ¥çš„VPCçš„æ‰€å±åœ°åŸŸï¼Œæœ¬æ“ä½œä¸­é€‰æ‹©åä¸œ1(æ­å·)ã€‚</p></li><li><p>è§„æ ¼ï¼šé€‰æ‹©å‘èµ·ç«¯è·¯ç”±å™¨æ¥å£çš„è§„æ ¼ï¼Œæœ¬æ“ä½œä¸­é€‰æ‹©å¤§å‹1æ¡£ã€‚</p></li></ul><p><img src="/wp-content/uploads/2018/05/20180529175328_53141.png" alt=""></p><h2 id="æ­¥éª¤äºŒï¼šåˆ›å»ºæ¥å—ç«¯è·¯ç”±å™¨æ¥å£"><a class="header-anchor" href="#æ­¥éª¤äºŒï¼šåˆ›å»ºæ¥å—ç«¯è·¯ç”±å™¨æ¥å£"></a>æ­¥éª¤äºŒï¼šåˆ›å»ºæ¥å—ç«¯è·¯ç”±å™¨æ¥å£</h2><p>å®Œæˆä»¥ä¸‹æ“ä½œï¼Œåœ¨è´¦å·Bä¸‹çš„VPCä¸­åˆ›å»ºæ¥å—ç«¯çš„è·¯ç”±å™¨æ¥å£ï¼š</p><ol><li><p>ä½¿ç”¨è´¦å·Bç™»å½•<a href="https://vpc.console.aliyun.com/expressConnect#/connection/cn-beijing/list">é«˜é€Ÿé€šé“ç®¡ç†æ§åˆ¶å°</a>ã€‚</p></li><li><p>åœ¨å·¦ä¾§å¯¼èˆªæ ï¼Œå•å‡»ä¸“æœ‰ç½‘ç»œè¿æ¥ &gt; è·¯ç”±å™¨æ¥å£ã€‚</p></li><li><p>å•å‡»åˆ›å»ºè·¯ç”±å™¨æ¥å£ï¼Œå‚è€ƒä»¥ä¸‹é…ç½®ï¼Œåˆ›å»ºè·¯ç”±å™¨æ¥å£ã€‚å…·ä½“é…ç½®è¯´æ˜ï¼Œå‚è§<a href="https://help.aliyun.com/document_detail/49136.html">åˆ›å»ºè·¯ç”±å™¨æ¥å£</a>ã€‚</p><ul><li><p>è®¡è´¹æ–¹å¼ï¼šé€‰æ‹©ä¸€ç§è®¡è´¹æ–¹å¼ï¼Œæœ¬æ“ä½œä¸­é€‰æ‹©æŒ‰é‡ä»˜è´¹ã€‚</p></li><li><p>è¿æ¥åœºæ™¯ï¼šé€‰æ‹©VPCäº’è¿</p></li><li><p>åˆ›å»ºè·¯ç”±å™¨æ¥å£åœºæ™¯ï¼šé€‰æ‹©åªåˆ›å»ºæ¥å—ç«¯</p></li><li><p>åœ°åŸŸï¼šé€‰æ‹©æœ¬ç«¯VPCçš„æ‰€å±åœ°åŸŸï¼Œæœ¬æ“ä½œä¸­é€‰æ‹©åä¸œ1(æ­å·)ã€‚</p></li><li><p>æœ¬ç«¯VPC IDï¼šé€‰æ‹©æ¥æ”¶ç«¯è·¯ç”±å™¨æ¥å£æ‰€åœ¨çš„VPCï¼Œæœ¬æ“ä½œä¸­é€‰æ‹©VPC Bçš„IDã€‚</p></li><li><p>å¯¹ç«¯åœ°åŸŸï¼šé€‰æ‹©è¦è¿æ¥çš„VPCçš„æ‰€å±åœ°åŸŸï¼Œæœ¬æ“ä½œä¸­é€‰æ‹©ååŒ—2(åŒ—äº¬)ã€‚</p></li></ul></li></ol><p><img src="/wp-content/uploads/2018/05/20180529175403_13877.png" alt=""></p><h2 id="æ­¥éª¤ä¸‰ï¼šæ·»åŠ å¯¹ç«¯è·¯ç”±å™¨æ¥å£å¹¶å‘èµ·è¿æ¥"><a class="header-anchor" href="#æ­¥éª¤ä¸‰ï¼šæ·»åŠ å¯¹ç«¯è·¯ç”±å™¨æ¥å£å¹¶å‘èµ·è¿æ¥"></a>æ­¥éª¤ä¸‰ï¼šæ·»åŠ å¯¹ç«¯è·¯ç”±å™¨æ¥å£å¹¶å‘èµ·è¿æ¥</h2><p>å®Œæˆä»¥ä¸‹æ“ä½œï¼Œåœ¨ä¸¤ä¾§çš„è·¯ç”±å™¨æ¥å£ä¸­æ·»åŠ å¯¹ç«¯è·¯ç”±å™¨æ¥å£å¹¶å‘èµ·è¿æ¥ï¼š</p><ol><li><p>ä½¿ç”¨è´¦å·Bç™»å½•<a href="https://vpc.console.aliyun.com/expressConnect#/connection/cn-beijing/list">é«˜é€Ÿé€šé“ç®¡ç†æ§åˆ¶å°</a>ã€‚</p></li><li><p>åœ¨è·¯ç”±å™¨æ¥å£åˆ—è¡¨é¡µé¢ï¼Œå•å‡»è·¯ç”±å™¨æ¥å£ri-BBBæ“ä½œåˆ—ä¸‹çš„æ›´å¤šÂ &gt;Â ç¼–è¾‘å¯¹ç«¯è·¯ç”±å™¨æ¥å£ä¿¡æ¯ã€‚</p></li><li><p>åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ï¼Œæ ¹æ®ä»¥ä¸‹ä¿¡æ¯ä¸ºè´¦å·Bé…ç½®å¯¹ç«¯è·¯ç”±å™¨æ¥å£ï¼š</p><ul><li><p>å¯¹ç«¯è´¦å·IDï¼šå¯¹ç«¯è´¦å·IDã€‚åœ¨æœ¬æ“ä½œä¸­è¾“å…¥è´¦å·Aã€‚</p></li><li><p>å¯¹ç«¯è·¯ç”±å™¨IDï¼šå¯¹ç«¯è·¯ç”±å™¨IDã€‚åœ¨æœ¬æ“ä½œä¸­è¾“å…¥vrt-AAAã€‚</p></li><li><p>å¯¹ç«¯è·¯ç”±å™¨æ¥å£IDï¼šå¯¹ç«¯è·¯ç”±å™¨æ¥å£IDã€‚åœ¨æœ¬æ“ä½œä¸­è¾“å…¥ri-AAAã€‚</p></li></ul></li><li><p>å•å‡»ç¡®å®šã€‚</p></li><li><p>é‡å¤ä»¥ä¸Šæ­¥éª¤ï¼Œä¸ºè´¦å·Aä¸ºé…ç½®å¯¹ç«¯è·¯ç”±å™¨æ¥å£ã€‚</p></li><li><p>è¿”å›è·¯ç”±å™¨æ¥å£åˆ—è¡¨é¡µé¢ï¼Œåœ¨è·¯ç”±å™¨æ¥å£ri-AAAçš„æ“ä½œåˆ—ä¸‹å•å‡»å‘èµ·è¿æ¥ã€‚å½“ä¸¤ä¸ªè´¦å·ä¸‹çš„è·¯ç”±å™¨æ¥å£ri-AAAå’Œri-BBBçš„çŠ¶æ€ä¸ºå·²æ¿€æ´»æ—¶ï¼Œè¡¨ç¤ºè¿æ¥æˆåŠŸã€‚</p></li></ol><h2 id="æ­¥éª¤å››ï¼šé…ç½®è·¯ç”±"><a class="header-anchor" href="#æ­¥éª¤å››ï¼šé…ç½®è·¯ç”±"></a>æ­¥éª¤å››ï¼šé…ç½®è·¯ç”±</h2><p>åˆ›å»ºè·¯ç”±å™¨æ¥å£åï¼Œå®Œæˆä»¥ä¸‹æ“ä½œä¸ºä¸¤ç«¯çš„VPCé…ç½®è·¯ç”±ï¼š</p><ol><li>åœ¨è·¯ç”±å™¨æ¥å£åˆ—è¡¨é¡µé¢ï¼Œæ‰¾åˆ°ç›®æ ‡è·¯ç”±å™¨æ¥å£ï¼Œç„¶åå•å‡»è·¯ç”±é…ç½®ã€‚</li></ol>]]></content>
    
    
    <categories>
      
      <category>äº‘ä¸»æœº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é˜¿é‡Œäº‘</tag>
      
      <tag>ecs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¤§å‹ç½‘ç«™æ¶æ„ä¹‹åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—</title>
    <link href="/2018/05/25/%E5%A4%A7%E5%9E%8B%E7%BD%91%E7%AB%99%E6%9E%B6%E6%9E%84%E4%B9%8B%E5%88%86%E5%B8%83%E5%BC%8F%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    <url>/2018/05/25/%E5%A4%A7%E5%9E%8B%E7%BD%91%E7%AB%99%E6%9E%B6%E6%9E%84%E4%B9%8B%E5%88%86%E5%B8%83%E5%BC%8F%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/</url>
    
    <content type="html"><![CDATA[<p>ä»¥ä¸‹æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ä»¥ä¸‹çš„å¤§çº²ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°ï¼Œæ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨åœºæ™¯å’Œæ¶ˆæ¯ä¸­é—´ä»¶ç¤ºä¾‹ï¼ˆç”µå•†ï¼Œæ—¥å¿—ç³»ç»Ÿï¼‰ã€‚</p><h2 id="æœ¬æ¬¡åˆ†äº«å¤§çº²"><a class="header-anchor" href="#æœ¬æ¬¡åˆ†äº«å¤§çº²"></a>æœ¬æ¬¡åˆ†äº«å¤§çº²</h2><ol><li>æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°</li><li>æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨åœºæ™¯</li><li>æ¶ˆæ¯ä¸­é—´ä»¶ç¤ºä¾‹</li><li>JMSæ¶ˆæ¯æœåŠ¡</li><li>å¸¸ç”¨æ¶ˆæ¯é˜Ÿåˆ—</li><li>å‚è€ƒï¼ˆæ¨èï¼‰èµ„æ–™</li><li>æœ¬æ¬¡åˆ†äº«æ€»ç»“</li></ol><h2 id="ä¸€ã€æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°"><a class="header-anchor" href="#ä¸€ã€æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°"></a>ä¸€ã€æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°</h2><p>æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é‡è¦çš„ç»„ä»¶ï¼Œä¸»è¦è§£å†³åº”ç”¨è€¦åˆï¼Œå¼‚æ­¥æ¶ˆæ¯ï¼Œæµé‡å‰Šé”‹ç­‰é—®é¢˜ã€‚å®ç°é«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨ï¼Œå¯ä¼¸ç¼©å’Œæœ€ç»ˆä¸€è‡´æ€§æ¶æ„ã€‚æ˜¯å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯ç¼ºå°‘çš„ä¸­é—´ä»¶ã€‚</p><p>ç›®å‰åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œä½¿ç”¨è¾ƒå¤šçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰ActiveMQï¼ŒRabbitMQï¼ŒZeroMQï¼ŒKafkaï¼ŒMetaMQï¼ŒRocketMQç­‰ã€‚</p><h2 id="äºŒã€æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨åœºæ™¯"><a class="header-anchor" href="#äºŒã€æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨åœºæ™¯"></a>äºŒã€æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨åœºæ™¯</h2><p>ä»¥ä¸‹ä»‹ç»æ¶ˆæ¯é˜Ÿåˆ—åœ¨å®é™…åº”ç”¨ä¸­å¸¸ç”¨çš„ä½¿ç”¨åœºæ™¯ã€‚å¼‚æ­¥å¤„ç†ï¼Œåº”ç”¨è§£è€¦ï¼Œæµé‡å‰Šé”‹å’Œæ¶ˆæ¯é€šè®¯å››ä¸ªåœºæ™¯ã€‚</p><h3 id="2-1å¼‚æ­¥å¤„ç†"><a class="header-anchor" href="#2-1å¼‚æ­¥å¤„ç†"></a>2.1å¼‚æ­¥å¤„ç†</h3><p>åœºæ™¯è¯´æ˜ï¼šç”¨æˆ·æ³¨å†Œåï¼Œéœ€è¦å‘æ³¨å†Œé‚®ä»¶å’Œæ³¨å†ŒçŸ­ä¿¡ã€‚ä¼ ç»Ÿçš„åšæ³•æœ‰ä¸¤ç§1.ä¸²è¡Œçš„æ–¹å¼ï¼›2.å¹¶è¡Œæ–¹å¼ã€‚</p><p>ï¼ˆ1ï¼‰ä¸²è¡Œæ–¹å¼ï¼šå°†æ³¨å†Œä¿¡æ¯å†™å…¥æ•°æ®åº“æˆåŠŸåï¼Œå‘é€æ³¨å†Œé‚®ä»¶ï¼Œå†å‘é€æ³¨å†ŒçŸ­ä¿¡ã€‚ä»¥ä¸Šä¸‰ä¸ªä»»åŠ¡å…¨éƒ¨å®Œæˆåï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ï¼ˆæ¶æ„KKQï¼š466097527ï¼Œæ¬¢è¿åŠ å…¥ï¼‰</p><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124211106000-2080222350.png" alt=""></p><p>ï¼ˆ2ï¼‰å¹¶è¡Œæ–¹å¼ï¼šå°†æ³¨å†Œä¿¡æ¯å†™å…¥æ•°æ®åº“æˆåŠŸåï¼Œå‘é€æ³¨å†Œé‚®ä»¶çš„åŒæ—¶ï¼Œå‘é€æ³¨å†ŒçŸ­ä¿¡ã€‚ä»¥ä¸Šä¸‰ä¸ªä»»åŠ¡å®Œæˆåï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ä¸ä¸²è¡Œçš„å·®åˆ«æ˜¯ï¼Œå¹¶è¡Œçš„æ–¹å¼å¯ä»¥æé«˜å¤„ç†çš„æ—¶é—´ã€‚</p><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124211115703-218873208.png" alt=""></p><p>å‡è®¾ä¸‰ä¸ªä¸šåŠ¡èŠ‚ç‚¹æ¯ä¸ªä½¿ç”¨50æ¯«ç§’é’Ÿï¼Œä¸è€ƒè™‘ç½‘ç»œç­‰å…¶ä»–å¼€é”€ï¼Œåˆ™ä¸²è¡Œæ–¹å¼çš„æ—¶é—´æ˜¯150æ¯«ç§’ï¼Œå¹¶è¡Œçš„æ—¶é—´å¯èƒ½æ˜¯100æ¯«ç§’ã€‚</p><p>å› ä¸ºCPUåœ¨å•ä½æ—¶é—´å†…å¤„ç†çš„è¯·æ±‚æ•°æ˜¯ä¸€å®šçš„ï¼Œå‡è®¾CPU1ç§’å†…ååé‡æ˜¯100æ¬¡ã€‚åˆ™ä¸²è¡Œæ–¹å¼1ç§’å†…CPUå¯å¤„ç†çš„è¯·æ±‚é‡æ˜¯7æ¬¡ï¼ˆ1000/150ï¼‰ã€‚å¹¶è¡Œæ–¹å¼å¤„ç†çš„è¯·æ±‚é‡æ˜¯10æ¬¡ï¼ˆ1000/100ï¼‰ã€‚</p><p>å°ç»“ï¼šå¦‚ä»¥ä¸Šæ¡ˆä¾‹æè¿°ï¼Œä¼ ç»Ÿçš„æ–¹å¼ç³»ç»Ÿçš„æ€§èƒ½ï¼ˆå¹¶å‘é‡ï¼Œååé‡ï¼Œå“åº”æ—¶é—´ï¼‰ä¼šæœ‰ç“¶é¢ˆã€‚å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><p>å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå°†ä¸æ˜¯å¿…é¡»çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¼‚æ­¥å¤„ç†ã€‚æ”¹é€ åçš„æ¶æ„å¦‚ä¸‹ï¼š</p><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124211131625-1083908699.png" alt=""></p><p>æŒ‰ç…§ä»¥ä¸Šçº¦å®šï¼Œç”¨æˆ·çš„å“åº”æ—¶é—´ç›¸å½“äºæ˜¯æ³¨å†Œä¿¡æ¯å†™å…¥æ•°æ®åº“çš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯50æ¯«ç§’ã€‚æ³¨å†Œé‚®ä»¶ï¼Œå‘é€çŸ­ä¿¡å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—åï¼Œç›´æ¥è¿”å›ï¼Œå› æ­¤å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—çš„é€Ÿåº¦å¾ˆå¿«ï¼ŒåŸºæœ¬å¯ä»¥å¿½ç•¥ï¼Œå› æ­¤ç”¨æˆ·çš„å“åº”æ—¶é—´å¯èƒ½æ˜¯50æ¯«ç§’ã€‚å› æ­¤æ¶æ„æ”¹å˜åï¼Œç³»ç»Ÿçš„ååé‡æé«˜åˆ°æ¯ç§’20 QPSã€‚æ¯”ä¸²è¡Œæé«˜äº†3å€ï¼Œæ¯”å¹¶è¡Œæé«˜äº†ä¸¤å€ã€‚</p><h3 id="2-2åº”ç”¨è§£è€¦"><a class="header-anchor" href="#2-2åº”ç”¨è§£è€¦"></a>2.2åº”ç”¨è§£è€¦</h3><p>åœºæ™¯è¯´æ˜ï¼šç”¨æˆ·ä¸‹å•åï¼Œè®¢å•ç³»ç»Ÿéœ€è¦é€šçŸ¥åº“å­˜ç³»ç»Ÿã€‚ä¼ ç»Ÿçš„åšæ³•æ˜¯ï¼Œè®¢å•ç³»ç»Ÿè°ƒç”¨åº“å­˜ç³»ç»Ÿçš„æ¥å£ã€‚å¦‚ä¸‹å›¾ï¼šï¼ˆæ¶æ„KKQï¼š466097527ï¼Œæ¬¢è¿åŠ å…¥ï¼‰</p><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124211254187-1511483255.png" alt=""></p><p>ä¼ ç»Ÿæ¨¡å¼çš„ç¼ºç‚¹ï¼š</p><p>1ï¼‰Â  å‡å¦‚åº“å­˜ç³»ç»Ÿæ— æ³•è®¿é—®ï¼Œåˆ™è®¢å•å‡åº“å­˜å°†å¤±è´¥ï¼Œä»è€Œå¯¼è‡´è®¢å•å¤±è´¥ï¼›</p><p>2ï¼‰Â  è®¢å•ç³»ç»Ÿä¸åº“å­˜ç³»ç»Ÿè€¦åˆï¼›</p><p>å¦‚ä½•è§£å†³ä»¥ä¸Šé—®é¢˜å‘¢ï¼Ÿå¼•å…¥åº”ç”¨æ¶ˆæ¯é˜Ÿåˆ—åçš„æ–¹æ¡ˆï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124211307687-1914946501.png" alt=""></p><ul><li>è®¢å•ç³»ç»Ÿï¼šç”¨æˆ·ä¸‹å•åï¼Œè®¢å•ç³»ç»Ÿå®ŒæˆæŒä¹…åŒ–å¤„ç†ï¼Œå°†æ¶ˆæ¯å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿”å›ç”¨æˆ·è®¢å•ä¸‹å•æˆåŠŸã€‚</li><li>åº“å­˜ç³»ç»Ÿï¼šè®¢é˜…ä¸‹å•çš„æ¶ˆæ¯ï¼Œé‡‡ç”¨æ‹‰/æ¨çš„æ–¹å¼ï¼Œè·å–ä¸‹å•ä¿¡æ¯ï¼Œåº“å­˜ç³»ç»Ÿæ ¹æ®ä¸‹å•ä¿¡æ¯ï¼Œè¿›è¡Œåº“å­˜æ“ä½œã€‚</li><li>å‡å¦‚ï¼šåœ¨ä¸‹å•æ—¶åº“å­˜ç³»ç»Ÿä¸èƒ½æ­£å¸¸ä½¿ç”¨ã€‚ä¹Ÿä¸å½±å“æ­£å¸¸ä¸‹å•ï¼Œå› ä¸ºä¸‹å•åï¼Œè®¢å•ç³»ç»Ÿå†™å…¥æ¶ˆæ¯é˜Ÿåˆ—å°±ä¸å†å…³å¿ƒå…¶ä»–çš„åç»­æ“ä½œäº†ã€‚å®ç°è®¢å•ç³»ç»Ÿä¸åº“å­˜ç³»ç»Ÿçš„åº”ç”¨è§£è€¦ã€‚</li></ul><h3 id="2-3æµé‡å‰Šé”‹"><a class="header-anchor" href="#2-3æµé‡å‰Šé”‹"></a>2.3æµé‡å‰Šé”‹</h3><p>æµé‡å‰Šé”‹ä¹Ÿæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å¸¸ç”¨åœºæ™¯ï¼Œä¸€èˆ¬åœ¨ç§’æ€æˆ–å›¢æŠ¢æ´»åŠ¨ä¸­ä½¿ç”¨å¹¿æ³›ã€‚</p><p>åº”ç”¨åœºæ™¯ï¼šç§’æ€æ´»åŠ¨ï¼Œä¸€èˆ¬ä¼šå› ä¸ºæµé‡è¿‡å¤§ï¼Œå¯¼è‡´æµé‡æš´å¢ï¼Œåº”ç”¨æŒ‚æ‰ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€èˆ¬éœ€è¦åœ¨åº”ç”¨å‰ç«¯åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><ol><li>å¯ä»¥æ§åˆ¶æ´»åŠ¨çš„äººæ•°ï¼›</li><li>å¯ä»¥ç¼“è§£çŸ­æ—¶é—´å†…é«˜æµé‡å‹å®åº”ç”¨ï¼›</li></ol><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124211333125-923847962.png" alt=""></p><ol><li>ç”¨æˆ·çš„è¯·æ±‚ï¼ŒæœåŠ¡å™¨æ¥æ”¶åï¼Œé¦–å…ˆå†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚å‡å¦‚æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦è¶…è¿‡æœ€å¤§æ•°é‡ï¼Œåˆ™ç›´æ¥æŠ›å¼ƒç”¨æˆ·è¯·æ±‚æˆ–è·³è½¬åˆ°é”™è¯¯é¡µé¢ï¼›</li><li>ç§’æ€ä¸šåŠ¡æ ¹æ®æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ä¿¡æ¯ï¼Œå†åšåç»­å¤„ç†ã€‚</li></ol><h3 id="2-4æ—¥å¿—å¤„ç†"><a class="header-anchor" href="#2-4æ—¥å¿—å¤„ç†"></a>2.4æ—¥å¿—å¤„ç†</h3><p>æ—¥å¿—å¤„ç†æ˜¯æŒ‡å°†æ¶ˆæ¯é˜Ÿåˆ—ç”¨åœ¨æ—¥å¿—å¤„ç†ä¸­ï¼Œæ¯”å¦‚Kafkaçš„åº”ç”¨ï¼Œè§£å†³å¤§é‡æ—¥å¿—ä¼ è¾“çš„é—®é¢˜ã€‚æ¶æ„ç®€åŒ–å¦‚ä¸‹ï¼šï¼ˆæ¶æ„KKQï¼š466097527ï¼Œæ¬¢è¿åŠ å…¥ï¼‰</p><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124211436718-1054529852.png" alt=""></p><ul><li>æ—¥å¿—é‡‡é›†å®¢æˆ·ç«¯ï¼Œè´Ÿè´£æ—¥å¿—æ•°æ®é‡‡é›†ï¼Œå®šæ—¶å†™å—å†™å…¥Kafkaé˜Ÿåˆ—ï¼›</li><li>Kafkaæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè´Ÿè´£æ—¥å¿—æ•°æ®çš„æ¥æ”¶ï¼Œå­˜å‚¨å’Œè½¬å‘ï¼›</li><li>æ—¥å¿—å¤„ç†åº”ç”¨ï¼šè®¢é˜…å¹¶æ¶ˆè´¹kafkaé˜Ÿåˆ—ä¸­çš„æ—¥å¿—æ•°æ®ï¼›</li></ul><p>ä»¥ä¸‹æ˜¯æ–°æµªkafkaæ—¥å¿—å¤„ç†åº”ç”¨æ¡ˆä¾‹ï¼š</p><p>è½¬è‡ªï¼ˆ<a href="https://cloud.51cto.com/art/201507/484338.htm%EF%BC%89">https://cloud.51cto.com/art/201507/484338.htmï¼‰</a></p><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124211447875-1251492581.png" alt=""></p><p>(1)Kafkaï¼šæ¥æ”¶ç”¨æˆ·æ—¥å¿—çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><p>(2)Logstashï¼šåšæ—¥å¿—è§£æï¼Œç»Ÿä¸€æˆJSONè¾“å‡ºç»™Elasticsearchã€‚</p><p>(3)Elasticsearchï¼šå®æ—¶æ—¥å¿—åˆ†ææœåŠ¡çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œä¸€ä¸ªschemalessï¼Œå®æ—¶çš„æ•°æ®å­˜å‚¨æœåŠ¡ï¼Œé€šè¿‡indexç»„ç»‡æ•°æ®ï¼Œå…¼å…·å¼ºå¤§çš„æœç´¢å’Œç»Ÿè®¡åŠŸèƒ½ã€‚</p><p>(4)Kibanaï¼šåŸºäºElasticsearchçš„æ•°æ®å¯è§†åŒ–ç»„ä»¶ï¼Œè¶…å¼ºçš„æ•°æ®å¯è§†åŒ–èƒ½åŠ›æ˜¯ä¼—å¤šå…¬å¸é€‰æ‹©ELK stackçš„é‡è¦åŸå› ã€‚</p><h3 id="2-5æ¶ˆæ¯é€šè®¯"><a class="header-anchor" href="#2-5æ¶ˆæ¯é€šè®¯"></a>2.5æ¶ˆæ¯é€šè®¯</h3><p>æ¶ˆæ¯é€šè®¯æ˜¯æŒ‡ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸€èˆ¬éƒ½å†…ç½®äº†é«˜æ•ˆçš„é€šä¿¡æœºåˆ¶ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç”¨åœ¨çº¯çš„æ¶ˆæ¯é€šè®¯ã€‚æ¯”å¦‚å®ç°ç‚¹å¯¹ç‚¹æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ–è€…èŠå¤©å®¤ç­‰ã€‚</p><p>ç‚¹å¯¹ç‚¹é€šè®¯ï¼š</p><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124211500718-1411703435.png" alt=""></p><p>å®¢æˆ·ç«¯Aå’Œå®¢æˆ·ç«¯Bä½¿ç”¨åŒä¸€é˜Ÿåˆ—ï¼Œè¿›è¡Œæ¶ˆæ¯é€šè®¯ã€‚</p><p>èŠå¤©å®¤é€šè®¯ï¼š</p><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124211511859-1166529202.png" alt=""></p><p>å®¢æˆ·ç«¯Aï¼Œå®¢æˆ·ç«¯Bï¼Œå®¢æˆ·ç«¯Nè®¢é˜…åŒä¸€ä¸»é¢˜ï¼Œè¿›è¡Œæ¶ˆæ¯å‘å¸ƒå’Œæ¥æ”¶ã€‚å®ç°ç±»ä¼¼èŠå¤©å®¤æ•ˆæœã€‚</p><p>ä»¥ä¸Šå®é™…æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸¤ç§æ¶ˆæ¯æ¨¡å¼ï¼Œç‚¹å¯¹ç‚¹æˆ–å‘å¸ƒè®¢é˜…æ¨¡å¼ã€‚æ¨¡å‹ä¸ºç¤ºæ„å›¾ï¼Œä¾›å‚è€ƒã€‚</p><h2 id="ä¸‰ã€æ¶ˆæ¯ä¸­é—´ä»¶ç¤ºä¾‹"><a class="header-anchor" href="#ä¸‰ã€æ¶ˆæ¯ä¸­é—´ä»¶ç¤ºä¾‹"></a>ä¸‰ã€æ¶ˆæ¯ä¸­é—´ä»¶ç¤ºä¾‹</h2><h3 id="3-1ç”µå•†ç³»ç»Ÿ"><a class="header-anchor" href="#3-1ç”µå•†ç³»ç»Ÿ"></a>3.1ç”µå•†ç³»ç»Ÿ</h3><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124220821515-1142658553.jpg" alt=""></p><p>æ¶ˆæ¯é˜Ÿåˆ—é‡‡ç”¨é«˜å¯ç”¨ï¼Œå¯æŒä¹…åŒ–çš„æ¶ˆæ¯ä¸­é—´ä»¶ã€‚æ¯”å¦‚Active MQï¼ŒRabbit MQï¼ŒRocket Mqã€‚ï¼ˆ1ï¼‰åº”ç”¨å°†ä¸»å¹²é€»è¾‘å¤„ç†å®Œæˆåï¼Œå†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚æ¶ˆæ¯å‘é€æ˜¯å¦æˆåŠŸå¯ä»¥å¼€å¯æ¶ˆæ¯çš„ç¡®è®¤æ¨¡å¼ã€‚ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—è¿”å›æ¶ˆæ¯æ¥æ”¶æˆåŠŸçŠ¶æ€åï¼Œåº”ç”¨å†è¿”å›ï¼Œè¿™æ ·ä¿éšœæ¶ˆæ¯çš„å®Œæ•´æ€§ï¼‰</p><p>ï¼ˆ2ï¼‰æ‰©å±•æµç¨‹ï¼ˆå‘çŸ­ä¿¡ï¼Œé…é€å¤„ç†ï¼‰è®¢é˜…é˜Ÿåˆ—æ¶ˆæ¯ã€‚é‡‡ç”¨æ¨æˆ–æ‹‰çš„æ–¹å¼è·å–æ¶ˆæ¯å¹¶å¤„ç†ã€‚</p><p>ï¼ˆ3ï¼‰æ¶ˆæ¯å°†åº”ç”¨è§£è€¦çš„åŒæ—¶ï¼Œå¸¦æ¥äº†æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œå¯ä»¥é‡‡ç”¨æœ€ç»ˆä¸€è‡´æ€§æ–¹å¼è§£å†³ã€‚æ¯”å¦‚ä¸»æ•°æ®å†™å…¥æ•°æ®åº“ï¼Œæ‰©å±•åº”ç”¨æ ¹æ®æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶ç»“åˆæ•°æ®åº“æ–¹å¼å®ç°åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„åç»­å¤„ç†ã€‚</p><h3 id="3-2æ—¥å¿—æ”¶é›†ç³»ç»Ÿ"><a class="header-anchor" href="#3-2æ—¥å¿—æ”¶é›†ç³»ç»Ÿ"></a>3.2æ—¥å¿—æ”¶é›†ç³»ç»Ÿ</h3><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124220830750-1886187340.jpg" alt=""></p><p>åˆ†ä¸ºZookeeperæ³¨å†Œä¸­å¿ƒï¼Œæ—¥å¿—æ”¶é›†å®¢æˆ·ç«¯ï¼ŒKafkaé›†ç¾¤å’ŒStormé›†ç¾¤ï¼ˆOtherAppï¼‰å››éƒ¨åˆ†ç»„æˆã€‚</p><ul><li>Zookeeperæ³¨å†Œä¸­å¿ƒï¼Œæå‡ºè´Ÿè½½å‡è¡¡å’Œåœ°å€æŸ¥æ‰¾æœåŠ¡ï¼›</li><li>æ—¥å¿—æ”¶é›†å®¢æˆ·ç«¯ï¼Œç”¨äºé‡‡é›†åº”ç”¨ç³»ç»Ÿçš„æ—¥å¿—ï¼Œå¹¶å°†æ•°æ®æ¨é€åˆ°kafkaé˜Ÿåˆ—ï¼›</li><li>Kafkaé›†ç¾¤ï¼šæ¥æ”¶ï¼Œè·¯ç”±ï¼Œå­˜å‚¨ï¼Œè½¬å‘ç­‰æ¶ˆæ¯å¤„ç†ï¼›</li></ul><p>Stormé›†ç¾¤ï¼šä¸OtherAppå¤„äºåŒä¸€çº§åˆ«ï¼Œé‡‡ç”¨æ‹‰çš„æ–¹å¼æ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼›</p><p>å››ã€JMSæ¶ˆæ¯æœåŠ¡</p><p>è®²æ¶ˆæ¯é˜Ÿåˆ—å°±ä¸å¾—ä¸æJMS ã€‚JMSï¼ˆJAVA Message Service,javaæ¶ˆæ¯æœåŠ¡ï¼‰APIæ˜¯ä¸€ä¸ªæ¶ˆæ¯æœåŠ¡çš„æ ‡å‡†/è§„èŒƒï¼Œå…è®¸åº”ç”¨ç¨‹åºç»„ä»¶åŸºäºJavaEEå¹³å°åˆ›å»ºã€å‘é€ã€æ¥æ”¶å’Œè¯»å–æ¶ˆæ¯ã€‚å®ƒä½¿åˆ†å¸ƒå¼é€šä¿¡è€¦åˆåº¦æ›´ä½ï¼Œæ¶ˆæ¯æœåŠ¡æ›´åŠ å¯é ä»¥åŠå¼‚æ­¥æ€§ã€‚</p><p>åœ¨EJBæ¶æ„ä¸­ï¼Œæœ‰æ¶ˆæ¯beanå¯ä»¥æ— ç¼çš„ä¸JMæ¶ˆæ¯æœåŠ¡é›†æˆã€‚åœ¨J2EEæ¶æ„æ¨¡å¼ä¸­ï¼Œæœ‰æ¶ˆæ¯æœåŠ¡è€…æ¨¡å¼ï¼Œç”¨äºå®ç°æ¶ˆæ¯ä¸åº”ç”¨ç›´æ¥çš„è§£è€¦ã€‚</p><h3 id="4-1æ¶ˆæ¯æ¨¡å‹"><a class="header-anchor" href="#4-1æ¶ˆæ¯æ¨¡å‹"></a>4.1æ¶ˆæ¯æ¨¡å‹</h3><p>åœ¨JMSæ ‡å‡†ä¸­ï¼Œæœ‰ä¸¤ç§æ¶ˆæ¯æ¨¡å‹P2Pï¼ˆPoint to Pointï¼‰,Publish/Subscribe(Pub/Sub)ã€‚</p><h4 id="4-1-1-P2Pæ¨¡å¼"><a class="header-anchor" href="#4-1-1-P2Pæ¨¡å¼"></a>4.1.1 P2Pæ¨¡å¼</h4><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124221143281-46837068.png" alt=""></p><p>P2Pæ¨¡å¼åŒ…å«ä¸‰ä¸ªè§’è‰²ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆQueueï¼‰ï¼Œå‘é€è€…(Sender)ï¼Œæ¥æ”¶è€…(Receiver)ã€‚æ¯ä¸ªæ¶ˆæ¯éƒ½è¢«å‘é€åˆ°ä¸€ä¸ªç‰¹å®šçš„é˜Ÿåˆ—ï¼Œæ¥æ”¶è€…ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ã€‚é˜Ÿåˆ—ä¿ç•™ç€æ¶ˆæ¯ï¼Œç›´åˆ°ä»–ä»¬è¢«æ¶ˆè´¹æˆ–è¶…æ—¶ã€‚</p><p>P2Pçš„ç‰¹ç‚¹</p><ul><li>æ¯ä¸ªæ¶ˆæ¯åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆConsumerï¼‰(å³ä¸€æ—¦è¢«æ¶ˆè´¹ï¼Œæ¶ˆæ¯å°±ä¸å†åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­)</li><li>å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´åœ¨æ—¶é—´ä¸Šæ²¡æœ‰ä¾èµ–æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‘é€è€…å‘é€äº†æ¶ˆæ¯ä¹‹åï¼Œä¸ç®¡æ¥æ”¶è€…æœ‰æ²¡æœ‰æ­£åœ¨è¿è¡Œï¼Œå®ƒä¸ä¼šå½±å“åˆ°æ¶ˆæ¯è¢«å‘é€åˆ°é˜Ÿåˆ—</li><li>æ¥æ”¶è€…åœ¨æˆåŠŸæ¥æ”¶æ¶ˆæ¯ä¹‹åéœ€å‘é˜Ÿåˆ—åº”ç­”æˆåŠŸ</li></ul><p>å¦‚æœå¸Œæœ›å‘é€çš„æ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æˆåŠŸå¤„ç†çš„è¯ï¼Œé‚£ä¹ˆéœ€è¦P2Pæ¨¡å¼ã€‚ï¼ˆæ¶æ„KKQï¼š466097527ï¼Œæ¬¢è¿åŠ å…¥ï¼‰</p><h4 id="4-1-2-Pub-subæ¨¡å¼"><a class="header-anchor" href="#4-1-2-Pub-subæ¨¡å¼"></a>4.1.2 Pub/subæ¨¡å¼</h4><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124221155968-1666724216.png" alt=""></p><p>åŒ…å«ä¸‰ä¸ªè§’è‰²ä¸»é¢˜ï¼ˆTopicï¼‰ï¼Œå‘å¸ƒè€…ï¼ˆPublisherï¼‰ï¼Œè®¢é˜…è€…ï¼ˆSubscriberï¼‰ ã€‚å¤šä¸ªå‘å¸ƒè€…å°†æ¶ˆæ¯å‘é€åˆ°Topic,ç³»ç»Ÿå°†è¿™äº›æ¶ˆæ¯ä¼ é€’ç»™å¤šä¸ªè®¢é˜…è€…ã€‚</p><p>Pub/Subçš„ç‰¹ç‚¹</p><ul><li>æ¯ä¸ªæ¶ˆæ¯å¯ä»¥æœ‰å¤šä¸ªæ¶ˆè´¹è€…</li><li>å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´æœ‰æ—¶é—´ä¸Šçš„ä¾èµ–æ€§ã€‚é’ˆå¯¹æŸä¸ªä¸»é¢˜ï¼ˆTopicï¼‰çš„è®¢é˜…è€…ï¼Œå®ƒå¿…é¡»åˆ›å»ºä¸€ä¸ªè®¢é˜…è€…ä¹‹åï¼Œæ‰èƒ½æ¶ˆè´¹å‘å¸ƒè€…çš„æ¶ˆæ¯ã€‚</li><li>ä¸ºäº†æ¶ˆè´¹æ¶ˆæ¯ï¼Œè®¢é˜…è€…å¿…é¡»ä¿æŒè¿è¡Œçš„çŠ¶æ€ã€‚</li></ul><p>ä¸ºäº†ç¼“å’Œè¿™æ ·ä¸¥æ ¼çš„æ—¶é—´ç›¸å…³æ€§ï¼ŒJMSå…è®¸è®¢é˜…è€…åˆ›å»ºä¸€ä¸ªå¯æŒä¹…åŒ–çš„è®¢é˜…ã€‚è¿™æ ·ï¼Œå³ä½¿è®¢é˜…è€…æ²¡æœ‰è¢«æ¿€æ´»ï¼ˆè¿è¡Œï¼‰ï¼Œå®ƒä¹Ÿèƒ½æ¥æ”¶åˆ°å‘å¸ƒè€…çš„æ¶ˆæ¯ã€‚</p><p>å¦‚æœå¸Œæœ›å‘é€çš„æ¶ˆæ¯å¯ä»¥ä¸è¢«åšä»»ä½•å¤„ç†ã€æˆ–è€…åªè¢«ä¸€ä¸ªæ¶ˆæ¯è€…å¤„ç†ã€æˆ–è€…å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…å¤„ç†çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥é‡‡ç”¨Pub/Subæ¨¡å‹ã€‚</p><h3 id="4-2æ¶ˆæ¯æ¶ˆè´¹"><a class="header-anchor" href="#4-2æ¶ˆæ¯æ¶ˆè´¹"></a>4.2æ¶ˆæ¯æ¶ˆè´¹</h3><p>åœ¨JMSä¸­ï¼Œæ¶ˆæ¯çš„äº§ç”Ÿå’Œæ¶ˆè´¹éƒ½æ˜¯å¼‚æ­¥çš„ã€‚å¯¹äºæ¶ˆè´¹æ¥è¯´ï¼ŒJMSçš„æ¶ˆæ¯è€…å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æ¥æ¶ˆè´¹æ¶ˆæ¯ã€‚</p><p>ï¼ˆ1ï¼‰åŒæ­¥</p><p>è®¢é˜…è€…æˆ–æ¥æ”¶è€…é€šè¿‡receiveæ–¹æ³•æ¥æ¥æ”¶æ¶ˆæ¯ï¼Œreceiveæ–¹æ³•åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹å‰ï¼ˆæˆ–è¶…æ—¶ä¹‹å‰ï¼‰å°†ä¸€ç›´é˜»å¡ï¼›</p><p>ï¼ˆ2ï¼‰å¼‚æ­¥</p><p>è®¢é˜…è€…æˆ–æ¥æ”¶è€…å¯ä»¥æ³¨å†Œä¸ºä¸€ä¸ªæ¶ˆæ¯ç›‘å¬å™¨ã€‚å½“æ¶ˆæ¯åˆ°è¾¾ä¹‹åï¼Œç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ç›‘å¬å™¨çš„onMessageæ–¹æ³•ã€‚</p><p>JNDIï¼šJavaå‘½åå’Œç›®å½•æ¥å£,æ˜¯ä¸€ç§æ ‡å‡†çš„Javaå‘½åç³»ç»Ÿæ¥å£ã€‚å¯ä»¥åœ¨ç½‘ç»œä¸ŠæŸ¥æ‰¾å’Œè®¿é—®æœåŠ¡ã€‚é€šè¿‡æŒ‡å®šä¸€ä¸ªèµ„æºåç§°ï¼Œè¯¥åç§°å¯¹åº”äºæ•°æ®åº“æˆ–å‘½åæœåŠ¡ä¸­çš„ä¸€ä¸ªè®°å½•ï¼ŒåŒæ—¶è¿”å›èµ„æºè¿æ¥å»ºç«‹æ‰€å¿…é¡»çš„ä¿¡æ¯ã€‚</p><p>JNDIåœ¨JMSä¸­èµ·åˆ°æŸ¥æ‰¾å’Œè®¿é—®å‘é€ç›®æ ‡æˆ–æ¶ˆæ¯æ¥æºçš„ä½œç”¨ã€‚ï¼ˆæ¶æ„KKQï¼š466097527ï¼Œæ¬¢è¿åŠ å…¥ï¼‰</p><h3 id="4-3JMSç¼–ç¨‹æ¨¡å‹"><a class="header-anchor" href="#4-3JMSç¼–ç¨‹æ¨¡å‹"></a>4.3JMSç¼–ç¨‹æ¨¡å‹</h3><p>(1) ConnectionFactory</p><p>åˆ›å»ºConnectionå¯¹è±¡çš„å·¥å‚ï¼Œé’ˆå¯¹ä¸¤ç§ä¸åŒçš„jmsæ¶ˆæ¯æ¨¡å‹ï¼Œåˆ†åˆ«æœ‰QueueConnectionFactoryå’ŒTopicConnectionFactoryä¸¤ç§ã€‚å¯ä»¥é€šè¿‡JNDIæ¥æŸ¥æ‰¾ConnectionFactoryå¯¹è±¡ã€‚</p><p>(2) Destination</p><p>Destinationçš„æ„æ€æ˜¯æ¶ˆæ¯ç”Ÿäº§è€…çš„æ¶ˆæ¯å‘é€ç›®æ ‡æˆ–è€…è¯´æ¶ˆæ¯æ¶ˆè´¹è€…çš„æ¶ˆæ¯æ¥æºã€‚å¯¹äºæ¶ˆæ¯ç”Ÿäº§è€…æ¥è¯´ï¼Œå®ƒçš„Destinationæ˜¯æŸä¸ªé˜Ÿåˆ—ï¼ˆQueueï¼‰æˆ–æŸä¸ªä¸»é¢˜ï¼ˆTopicï¼‰;å¯¹äºæ¶ˆæ¯æ¶ˆè´¹è€…æ¥è¯´ï¼Œå®ƒçš„Destinationä¹Ÿæ˜¯æŸä¸ªé˜Ÿåˆ—æˆ–ä¸»é¢˜ï¼ˆå³æ¶ˆæ¯æ¥æºï¼‰ã€‚</p><p>æ‰€ä»¥ï¼ŒDestinationå®é™…ä¸Šå°±æ˜¯ä¸¤ç§ç±»å‹çš„å¯¹è±¡ï¼šQueueã€Topicå¯ä»¥é€šè¿‡JNDIæ¥æŸ¥æ‰¾Destinationã€‚</p><p>(3) Connection</p><p>Connectionè¡¨ç¤ºåœ¨å®¢æˆ·ç«¯å’ŒJMSç³»ç»Ÿä¹‹é—´å»ºç«‹çš„é“¾æ¥ï¼ˆå¯¹TCP/IP socketçš„åŒ…è£…ï¼‰ã€‚Connectionå¯ä»¥äº§ç”Ÿä¸€ä¸ªæˆ–å¤šä¸ªSessionã€‚è·ŸConnectionFactoryä¸€æ ·ï¼ŒConnectionä¹Ÿæœ‰ä¸¤ç§ç±»å‹ï¼šQueueConnectionå’ŒTopicConnectionã€‚</p><p>(4) Session</p><p>Sessionæ˜¯æ“ä½œæ¶ˆæ¯çš„æ¥å£ã€‚å¯ä»¥é€šè¿‡sessionåˆ›å»ºç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€æ¶ˆæ¯ç­‰ã€‚Sessionæä¾›äº†äº‹åŠ¡çš„åŠŸèƒ½ã€‚å½“éœ€è¦ä½¿ç”¨sessionå‘é€/æ¥æ”¶å¤šä¸ªæ¶ˆæ¯æ—¶ï¼Œå¯ä»¥å°†è¿™äº›å‘é€/æ¥æ”¶åŠ¨ä½œæ”¾åˆ°ä¸€ä¸ªäº‹åŠ¡ä¸­ã€‚åŒæ ·ï¼Œä¹Ÿåˆ†QueueSessionå’ŒTopicSessionã€‚</p><p>(5) æ¶ˆæ¯çš„ç”Ÿäº§è€…</p><p>æ¶ˆæ¯ç”Ÿäº§è€…ç”±Sessionåˆ›å»ºï¼Œå¹¶ç”¨äºå°†æ¶ˆæ¯å‘é€åˆ°Destinationã€‚åŒæ ·ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…åˆ†ä¸¤ç§ç±»å‹ï¼šQueueSenderå’ŒTopicPublisherã€‚å¯ä»¥è°ƒç”¨æ¶ˆæ¯ç”Ÿäº§è€…çš„æ–¹æ³•ï¼ˆsendæˆ–publishæ–¹æ³•ï¼‰å‘é€æ¶ˆæ¯ã€‚</p><p>(6) æ¶ˆæ¯æ¶ˆè´¹è€…</p><p>æ¶ˆæ¯æ¶ˆè´¹è€…ç”±Sessionåˆ›å»ºï¼Œç”¨äºæ¥æ”¶è¢«å‘é€åˆ°Destinationçš„æ¶ˆæ¯ã€‚ä¸¤ç§ç±»å‹ï¼šQueueReceiverå’ŒTopicSubscriberã€‚å¯åˆ†åˆ«é€šè¿‡sessionçš„createReceiver(Queue)æˆ–createSubscriber(Topic)æ¥åˆ›å»ºã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥sessionçš„creatDurableSubscriberæ–¹æ³•æ¥åˆ›å»ºæŒä¹…åŒ–çš„è®¢é˜…è€…ã€‚</p><p>(7) MessageListener</p><p>æ¶ˆæ¯ç›‘å¬å™¨ã€‚å¦‚æœæ³¨å†Œäº†æ¶ˆæ¯ç›‘å¬å™¨ï¼Œä¸€æ—¦æ¶ˆæ¯åˆ°è¾¾ï¼Œå°†è‡ªåŠ¨è°ƒç”¨ç›‘å¬å™¨çš„onMessageæ–¹æ³•ã€‚EJBä¸­çš„MDBï¼ˆMessage-Driven Beanï¼‰å°±æ˜¯ä¸€ç§MessageListenerã€‚</p><p>æ·±å…¥å­¦ä¹ JMSå¯¹æŒæ¡JAVAæ¶æ„ï¼ŒEJBæ¶æ„æœ‰å¾ˆå¥½çš„å¸®åŠ©ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶ä¹Ÿæ˜¯å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿå¿…é¡»çš„ç»„ä»¶ã€‚æœ¬æ¬¡åˆ†äº«ä¸»è¦åšå…¨å±€æ€§ä»‹ç»ï¼Œå…·ä½“çš„æ·±å…¥éœ€è¦å¤§å®¶å­¦ä¹ ï¼Œå®è·µï¼Œæ€»ç»“ï¼Œé¢†ä¼šã€‚</p><h2 id="äº”ã€å¸¸ç”¨æ¶ˆæ¯é˜Ÿåˆ—"><a class="header-anchor" href="#äº”ã€å¸¸ç”¨æ¶ˆæ¯é˜Ÿåˆ—"></a>äº”ã€å¸¸ç”¨æ¶ˆæ¯é˜Ÿåˆ—</h2><p>ä¸€èˆ¬å•†ç”¨çš„å®¹å™¨ï¼Œæ¯”å¦‚WebLogicï¼ŒJBossï¼Œéƒ½æ”¯æŒJMSæ ‡å‡†ï¼Œå¼€å‘ä¸Šå¾ˆæ–¹ä¾¿ã€‚ä½†å…è´¹çš„æ¯”å¦‚Tomcatï¼ŒJettyç­‰åˆ™éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„æ¶ˆæ¯ä¸­é—´ä»¶ã€‚æœ¬éƒ¨åˆ†å†…å®¹ä»‹ç»å¸¸ç”¨çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆActive MQ,Rabbit MQï¼ŒZero MQ,Kafkaï¼‰ä»¥åŠä»–ä»¬çš„ç‰¹ç‚¹ã€‚</p><h3 id="5-1-ActiveMQ"><a class="header-anchor" href="#5-1-ActiveMQ"></a>5.1 ActiveMQ</h3><p>ActiveMQ æ˜¯Apacheå‡ºå“ï¼Œæœ€æµè¡Œçš„ï¼Œèƒ½åŠ›å¼ºåŠ²çš„å¼€æºæ¶ˆæ¯æ€»çº¿ã€‚ActiveMQ æ˜¯ä¸€ä¸ªå®Œå…¨æ”¯æŒJMS1.1å’ŒJ2EE 1.4è§„èŒƒçš„ JMS Providerå®ç°ï¼Œå°½ç®¡JMSè§„èŒƒå‡ºå°å·²ç»æ˜¯å¾ˆä¹…çš„äº‹æƒ…äº†ï¼Œä½†æ˜¯JMSåœ¨å½“ä»Šçš„J2EEåº”ç”¨ä¸­é—´ä»ç„¶æ‰®æ¼”ç€ç‰¹æ®Šçš„åœ°ä½ã€‚</p><p>ActiveMQç‰¹æ€§å¦‚ä¸‹ï¼š</p><p>â’ˆ å¤šç§è¯­è¨€å’Œåè®®ç¼–å†™å®¢æˆ·ç«¯ã€‚è¯­è¨€: Java,C,C++,C#,Ruby,Perl,Python,PHPã€‚åº”ç”¨åè®®ï¼š OpenWire,Stomp REST,WS Notification,XMPP,AMQP</p><p>â’‰ å®Œå…¨æ”¯æŒJMS1.1å’ŒJ2EE 1.4è§„èŒƒ ï¼ˆæŒä¹…åŒ–ï¼ŒXAæ¶ˆæ¯ï¼Œäº‹åŠ¡)</p><p>â’Š å¯¹Springçš„æ”¯æŒï¼ŒActiveMQå¯ä»¥å¾ˆå®¹æ˜“å†…åµŒåˆ°ä½¿ç”¨Springçš„ç³»ç»Ÿé‡Œé¢å»ï¼Œè€Œä¸”ä¹Ÿæ”¯æŒSpring2.0çš„ç‰¹æ€§</p><p>â’‹ é€šè¿‡äº†å¸¸è§J2EEæœåŠ¡å™¨ï¼ˆå¦‚ Geronimo,JBoss 4,GlassFish,WebLogic)çš„æµ‹è¯•ï¼Œå…¶ä¸­é€šè¿‡JCA 1.5 resource adaptorsçš„é…ç½®ï¼Œå¯ä»¥è®©ActiveMQå¯ä»¥è‡ªåŠ¨çš„éƒ¨ç½²åˆ°ä»»ä½•å…¼å®¹J2EE 1.4 å•†ä¸šæœåŠ¡å™¨ä¸Š</p><p>â’Œ æ”¯æŒå¤šç§ä¼ é€åè®®ï¼šin-VM,TCP,SSL,NIO,UDP,JGroups,JXTA</p><p>â’ æ”¯æŒé€šè¿‡JDBCå’Œjournalæä¾›é«˜é€Ÿçš„æ¶ˆæ¯æŒä¹…åŒ–</p><p>â’ ä»è®¾è®¡ä¸Šä¿è¯äº†é«˜æ€§èƒ½çš„é›†ç¾¤ï¼Œå®¢æˆ·ç«¯-æœåŠ¡å™¨ï¼Œç‚¹å¯¹ç‚¹</p><p>â’ æ”¯æŒAjax</p><p>â’ æ”¯æŒä¸Axisçš„æ•´åˆ</p><p>â’‘ å¯ä»¥å¾ˆå®¹æ˜“å¾—è°ƒç”¨å†…åµŒJMS providerï¼Œè¿›è¡Œæµ‹è¯•</p><h3 id="5-2-RabbitMQ"><a class="header-anchor" href="#5-2-RabbitMQ"></a>5.2 RabbitMQ</h3><p>RabbitMQæ˜¯æµè¡Œçš„å¼€æºæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œç”¨erlangè¯­è¨€å¼€å‘ã€‚RabbitMQæ˜¯AMQPï¼ˆé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼‰çš„æ ‡å‡†å®ç°ã€‚æ”¯æŒå¤šç§å®¢æˆ·ç«¯ï¼Œå¦‚ï¼šPythonã€Rubyã€.NETã€Javaã€JMSã€Cã€PHPã€ActionScriptã€XMPPã€STOMPç­‰ï¼Œæ”¯æŒAJAXï¼ŒæŒä¹…åŒ–ã€‚ç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å­˜å‚¨è½¬å‘æ¶ˆæ¯ï¼Œåœ¨æ˜“ç”¨æ€§ã€æ‰©å±•æ€§ã€é«˜å¯ç”¨æ€§ç­‰æ–¹é¢è¡¨ç°ä¸ä¿—ã€‚</p><p>ç»“æ„å›¾å¦‚ä¸‹ï¼šï¼ˆæ¶æ„KKQï¼š466097527ï¼Œæ¬¢è¿åŠ å…¥ï¼‰</p><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124221240875-1959295808.png" alt=""></p><p>å‡ ä¸ªé‡è¦æ¦‚å¿µï¼š</p><p>Brokerï¼šç®€å•æ¥è¯´å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å®ä½“ã€‚</p><p>Exchangeï¼šæ¶ˆæ¯äº¤æ¢æœºï¼Œå®ƒæŒ‡å®šæ¶ˆæ¯æŒ‰ä»€ä¹ˆè§„åˆ™ï¼Œè·¯ç”±åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚</p><p>Queueï¼šæ¶ˆæ¯é˜Ÿåˆ—è½½ä½“ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æŠ•å…¥åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚</p><p>Bindingï¼šç»‘å®šï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æŠŠexchangeå’ŒqueueæŒ‰ç…§è·¯ç”±è§„åˆ™ç»‘å®šèµ·æ¥ã€‚</p><p>Routing Keyï¼šè·¯ç”±å…³é”®å­—ï¼Œexchangeæ ¹æ®è¿™ä¸ªå…³é”®å­—è¿›è¡Œæ¶ˆæ¯æŠ•é€’ã€‚</p><p>vhostï¼šè™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ªbrokeré‡Œå¯ä»¥å¼€è®¾å¤šä¸ªvhostï¼Œç”¨ä½œä¸åŒç”¨æˆ·çš„æƒé™åˆ†ç¦»ã€‚</p><p>producerï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå°±æ˜¯æŠ•é€’æ¶ˆæ¯çš„ç¨‹åºã€‚</p><p>consumerï¼šæ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå°±æ˜¯æ¥å—æ¶ˆæ¯çš„ç¨‹åºã€‚</p><p>channelï¼šæ¶ˆæ¯é€šé“ï¼Œåœ¨å®¢æˆ·ç«¯çš„æ¯ä¸ªè¿æ¥é‡Œï¼Œå¯å»ºç«‹å¤šä¸ªchannelï¼Œæ¯ä¸ªchannelä»£è¡¨ä¸€ä¸ªä¼šè¯ä»»åŠ¡ã€‚</p><p>æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨è¿‡ç¨‹ï¼Œå¦‚ä¸‹ï¼š</p><p>ï¼ˆ1ï¼‰å®¢æˆ·ç«¯è¿æ¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨ï¼Œæ‰“å¼€ä¸€ä¸ªchannelã€‚</p><p>ï¼ˆ2ï¼‰å®¢æˆ·ç«¯å£°æ˜ä¸€ä¸ªexchangeï¼Œå¹¶è®¾ç½®ç›¸å…³å±æ€§ã€‚</p><p>ï¼ˆ3ï¼‰å®¢æˆ·ç«¯å£°æ˜ä¸€ä¸ªqueueï¼Œå¹¶è®¾ç½®ç›¸å…³å±æ€§ã€‚</p><p>ï¼ˆ4ï¼‰å®¢æˆ·ç«¯ä½¿ç”¨routing keyï¼Œåœ¨exchangeå’Œqueueä¹‹é—´å»ºç«‹å¥½ç»‘å®šå…³ç³»ã€‚</p><p>ï¼ˆ5ï¼‰å®¢æˆ·ç«¯æŠ•é€’æ¶ˆæ¯åˆ°exchangeã€‚</p><p>exchangeæ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œå°±æ ¹æ®æ¶ˆæ¯çš„keyå’Œå·²ç»è®¾ç½®çš„bindingï¼Œè¿›è¡Œæ¶ˆæ¯è·¯ç”±ï¼Œå°†æ¶ˆæ¯æŠ•é€’åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—é‡Œã€‚</p><h3 id="5-3-ZeroMQ"><a class="header-anchor" href="#5-3-ZeroMQ"></a>5.3 ZeroMQ</h3><p>å·ç§°å²ä¸Šæœ€å¿«çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒå®é™…ç±»ä¼¼äºSocketçš„ä¸€ç³»åˆ—æ¥å£ï¼Œä»–è·ŸSocketçš„åŒºåˆ«æ˜¯ï¼šæ™®é€šçš„socketæ˜¯ç«¯åˆ°ç«¯çš„ï¼ˆ1:1çš„å…³ç³»ï¼‰ï¼Œè€ŒZMQå´æ˜¯å¯ä»¥Nï¼šM çš„å…³ç³»ï¼Œäººä»¬å¯¹BSDå¥—æ¥å­—çš„äº†è§£è¾ƒå¤šçš„æ˜¯ç‚¹å¯¹ç‚¹çš„è¿æ¥ï¼Œç‚¹å¯¹ç‚¹è¿æ¥éœ€è¦æ˜¾å¼åœ°å»ºç«‹è¿æ¥ã€é”€æ¯è¿æ¥ã€é€‰æ‹©åè®®ï¼ˆTCP/UDPï¼‰å’Œå¤„ç†é”™è¯¯ç­‰ï¼Œè€ŒZMQå±è”½äº†è¿™äº›ç»†èŠ‚ï¼Œè®©ä½ çš„ç½‘ç»œç¼–ç¨‹æ›´ä¸ºç®€å•ã€‚ZMQç”¨äºnodeä¸nodeé—´çš„é€šä¿¡ï¼Œnodeå¯ä»¥æ˜¯ä¸»æœºæˆ–è€…æ˜¯è¿›ç¨‹ã€‚</p><p>å¼•ç”¨å®˜æ–¹çš„è¯´æ³•ï¼š â€œZMQ(ä»¥ä¸‹ZeroMQç®€ç§°ZMQ)æ˜¯ä¸€ä¸ªç®€å•å¥½ç”¨çš„ä¼ è¾“å±‚ï¼Œåƒæ¡†æ¶ä¸€æ ·çš„ä¸€ä¸ªsocket libraryï¼Œä»–ä½¿å¾—Socketç¼–ç¨‹æ›´åŠ ç®€å•ã€ç®€æ´å’Œæ€§èƒ½æ›´é«˜ã€‚æ˜¯ä¸€ä¸ªæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—åº“ï¼Œå¯åœ¨å¤šä¸ªçº¿ç¨‹ã€å†…æ ¸å’Œä¸»æœºç›’ä¹‹é—´å¼¹æ€§ä¼¸ç¼©ã€‚ZMQçš„æ˜ç¡®ç›®æ ‡æ˜¯â€œæˆä¸ºæ ‡å‡†ç½‘ç»œåè®®æ ˆçš„ä¸€éƒ¨åˆ†ï¼Œä¹‹åè¿›å…¥Linuxå†…æ ¸â€ã€‚ç°åœ¨è¿˜æœªçœ‹åˆ°å®ƒä»¬çš„æˆåŠŸã€‚ä½†æ˜¯ï¼Œå®ƒæ— ç–‘æ˜¯æå…·å‰æ™¯çš„ã€å¹¶ä¸”æ˜¯äººä»¬æ›´åŠ éœ€è¦çš„â€œä¼ ç»Ÿâ€BSDå¥—æ¥å­—ä¹‹ä¸Šçš„ä¸€ å±‚å°è£…ã€‚ZMQè®©ç¼–å†™é«˜æ€§èƒ½ç½‘ç»œåº”ç”¨ç¨‹åºæä¸ºç®€å•å’Œæœ‰è¶£ã€‚â€</p><p>ç‰¹ç‚¹æ˜¯ï¼š</p><ul><li>é«˜æ€§èƒ½ï¼ŒéæŒä¹…åŒ–ï¼›</li><li>è·¨å¹³å°ï¼šæ”¯æŒLinuxã€Windowsã€OS Xç­‰ã€‚</li><li>å¤šè¯­è¨€æ”¯æŒï¼› Cã€C++ã€Javaã€.NETã€Pythonç­‰30å¤šç§å¼€å‘è¯­è¨€ã€‚</li><li>å¯å•ç‹¬éƒ¨ç½²æˆ–é›†æˆåˆ°åº”ç”¨ä¸­ä½¿ç”¨ï¼›</li><li>å¯ä½œä¸ºSocketé€šä¿¡åº“ä½¿ç”¨ã€‚</li></ul><p>ä¸RabbitMQç›¸æ¯”ï¼ŒZMQå¹¶ä¸åƒæ˜¯ä¸€ä¸ªä¼ ç»Ÿæ„ä¹‰ä¸Šçš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨ï¼Œäº‹å®ä¸Šï¼Œå®ƒä¹Ÿæ ¹æœ¬ä¸æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œæ›´åƒä¸€ä¸ªåº•å±‚çš„ç½‘ç»œé€šè®¯åº“ï¼Œåœ¨Socket APIä¹‹ä¸Šåšäº†ä¸€å±‚å°è£…ï¼Œå°†ç½‘ç»œé€šè®¯ã€è¿›ç¨‹é€šè®¯å’Œçº¿ç¨‹é€šè®¯æŠ½è±¡ä¸ºç»Ÿä¸€çš„APIæ¥å£ã€‚æ”¯æŒâ€œRequest-Reply â€œï¼Œâ€Publisher-Subscriberâ€œï¼Œâ€Parallel Pipelineâ€ä¸‰ç§åŸºæœ¬æ¨¡å‹å’Œæ‰©å±•æ¨¡å‹ã€‚</p><p>ZeroMQé«˜æ€§èƒ½è®¾è®¡è¦ç‚¹ï¼š</p><p>1ã€æ— é”çš„é˜Ÿåˆ—æ¨¡å‹</p><p>å¯¹äºè·¨çº¿ç¨‹é—´çš„äº¤äº’ï¼ˆç”¨æˆ·ç«¯å’Œsessionï¼‰ä¹‹é—´çš„æ•°æ®äº¤æ¢é€šé“pipeï¼Œé‡‡ç”¨æ— é”çš„é˜Ÿåˆ—ç®—æ³•CASï¼›åœ¨pipeä¸¤ç«¯æ³¨å†Œæœ‰å¼‚æ­¥äº‹ä»¶ï¼Œåœ¨è¯»æˆ–è€…å†™æ¶ˆæ¯åˆ°pipeçš„æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘è¯»å†™äº‹ä»¶ã€‚</p><p>2ã€æ‰¹é‡å¤„ç†çš„ç®—æ³•</p><p>å¯¹äºä¼ ç»Ÿçš„æ¶ˆæ¯å¤„ç†ï¼Œæ¯ä¸ªæ¶ˆæ¯åœ¨å‘é€å’Œæ¥æ”¶çš„æ—¶å€™ï¼Œéƒ½éœ€è¦ç³»ç»Ÿçš„è°ƒç”¨ï¼Œè¿™æ ·å¯¹äºå¤§é‡çš„æ¶ˆæ¯ï¼Œç³»ç»Ÿçš„å¼€é”€æ¯”è¾ƒå¤§ï¼ŒzeroMQå¯¹äºæ‰¹é‡çš„æ¶ˆæ¯ï¼Œè¿›è¡Œäº†é€‚åº”æ€§çš„ä¼˜åŒ–ï¼Œå¯ä»¥æ‰¹é‡çš„æ¥æ”¶å’Œå‘é€æ¶ˆæ¯ã€‚</p><p>3ã€å¤šæ ¸ä¸‹çš„çº¿ç¨‹ç»‘å®šï¼Œæ— é¡»CPUåˆ‡æ¢</p><p>åŒºåˆ«äºä¼ ç»Ÿçš„å¤šçº¿ç¨‹å¹¶å‘æ¨¡å¼ï¼Œä¿¡å·é‡æˆ–è€…ä¸´ç•ŒåŒºï¼Œ zeroMQå……åˆ†åˆ©ç”¨å¤šæ ¸çš„ä¼˜åŠ¿ï¼Œæ¯ä¸ªæ ¸ç»‘å®šè¿è¡Œä¸€ä¸ªå·¥ä½œè€…çº¿ç¨‹ï¼Œé¿å…å¤šçº¿ç¨‹ä¹‹é—´çš„CPUåˆ‡æ¢å¼€é”€ã€‚</p><h3 id="5-4-Kafka"><a class="header-anchor" href="#5-4-Kafka"></a>5.4 Kafka</h3><p>Kafkaæ˜¯ä¸€ç§é«˜ååé‡çš„åˆ†å¸ƒå¼å‘å¸ƒè®¢é˜…æ¶ˆæ¯ç³»ç»Ÿï¼Œå®ƒå¯ä»¥å¤„ç†æ¶ˆè´¹è€…è§„æ¨¡çš„ç½‘ç«™ä¸­çš„æ‰€æœ‰åŠ¨ä½œæµæ•°æ®ã€‚ è¿™ç§åŠ¨ä½œï¼ˆç½‘é¡µæµè§ˆï¼Œæœç´¢å’Œå…¶ä»–ç”¨æˆ·çš„è¡ŒåŠ¨ï¼‰æ˜¯åœ¨ç°ä»£ç½‘ç»œä¸Šçš„è®¸å¤šç¤¾ä¼šåŠŸèƒ½çš„ä¸€ä¸ªå…³é”®å› ç´ ã€‚ è¿™äº›æ•°æ®é€šå¸¸æ˜¯ç”±äºååé‡çš„è¦æ±‚è€Œé€šè¿‡å¤„ç†æ—¥å¿—å’Œæ—¥å¿—èšåˆæ¥è§£å†³ã€‚ å¯¹äºåƒHadoopçš„ä¸€æ ·çš„æ—¥å¿—æ•°æ®å’Œç¦»çº¿åˆ†æç³»ç»Ÿï¼Œä½†åˆè¦æ±‚å®æ—¶å¤„ç†çš„é™åˆ¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚Kafkaçš„ç›®çš„æ˜¯é€šè¿‡Hadoopçš„å¹¶è¡ŒåŠ è½½æœºåˆ¶æ¥ç»Ÿä¸€çº¿ä¸Šå’Œç¦»çº¿çš„æ¶ˆæ¯å¤„ç†ï¼Œä¹Ÿæ˜¯ä¸ºäº†é€šè¿‡é›†ç¾¤æœºæ¥æä¾›å®æ—¶çš„æ¶ˆè´¹ã€‚</p><p>Kafkaæ˜¯ä¸€ç§é«˜ååé‡çš„åˆ†å¸ƒå¼å‘å¸ƒè®¢é˜…æ¶ˆæ¯ç³»ç»Ÿï¼Œæœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š</p><ul><li>é€šè¿‡O(1)çš„ç£ç›˜æ•°æ®ç»“æ„æä¾›æ¶ˆæ¯çš„æŒä¹…åŒ–ï¼Œè¿™ç§ç»“æ„å¯¹äºå³ä½¿æ•°ä»¥TBçš„æ¶ˆæ¯å­˜å‚¨ä¹Ÿèƒ½å¤Ÿä¿æŒé•¿æ—¶é—´çš„ç¨³å®šæ€§èƒ½ã€‚ï¼ˆæ–‡ä»¶è¿½åŠ çš„æ–¹å¼å†™å…¥æ•°æ®ï¼Œè¿‡æœŸçš„æ•°æ®å®šæœŸåˆ é™¤ï¼‰</li><li>é«˜ååé‡ï¼šå³ä½¿æ˜¯éå¸¸æ™®é€šçš„ç¡¬ä»¶Kafkaä¹Ÿå¯ä»¥æ”¯æŒæ¯ç§’æ•°ç™¾ä¸‡çš„æ¶ˆæ¯ã€‚</li><li>æ”¯æŒé€šè¿‡KafkaæœåŠ¡å™¨å’Œæ¶ˆè´¹æœºé›†ç¾¤æ¥åˆ†åŒºæ¶ˆæ¯ã€‚</li><li>æ”¯æŒHadoopå¹¶è¡Œæ•°æ®åŠ è½½ã€‚</li></ul><p>Kafkaç›¸å…³æ¦‚å¿µ</p><ul><li>Broker</li></ul><p>Kafkaé›†ç¾¤åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡å™¨ï¼Œè¿™ç§æœåŠ¡å™¨è¢«ç§°ä¸ºbroker[5]</p><ul><li>Topic</li></ul><p>æ¯æ¡å‘å¸ƒåˆ°Kafkaé›†ç¾¤çš„æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªç±»åˆ«ï¼Œè¿™ä¸ªç±»åˆ«è¢«ç§°ä¸ºTopicã€‚ï¼ˆç‰©ç†ä¸Šä¸åŒTopicçš„æ¶ˆæ¯åˆ†å¼€å­˜å‚¨ï¼Œé€»è¾‘ä¸Šä¸€ä¸ªTopicçš„æ¶ˆæ¯è™½ç„¶ä¿å­˜äºä¸€ä¸ªæˆ–å¤šä¸ªbrokerä¸Šä½†ç”¨æˆ·åªéœ€æŒ‡å®šæ¶ˆæ¯çš„Topicå³å¯ç”Ÿäº§æˆ–æ¶ˆè´¹æ•°æ®è€Œä¸å¿…å…³å¿ƒæ•°æ®å­˜äºä½•å¤„ï¼‰</p><ul><li>Partition</li></ul><p>Paritionæ˜¯ç‰©ç†ä¸Šçš„æ¦‚å¿µï¼Œæ¯ä¸ªTopicåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªPartition.</p><ul><li>Producer</li></ul><p>è´Ÿè´£å‘å¸ƒæ¶ˆæ¯åˆ°Kafka broker</p><ul><li>Consumer</li></ul><p>æ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå‘Kafka brokerè¯»å–æ¶ˆæ¯çš„å®¢æˆ·ç«¯ã€‚</p><ul><li>Consumer Group</li></ul><p>æ¯ä¸ªConsumerå±äºä¸€ä¸ªç‰¹å®šçš„Consumer Groupï¼ˆå¯ä¸ºæ¯ä¸ªConsumeræŒ‡å®šgroup nameï¼Œè‹¥ä¸æŒ‡å®šgroup nameåˆ™å±äºé»˜è®¤çš„groupï¼‰ã€‚</p><p>ä¸€èˆ¬åº”ç”¨åœ¨å¤§æ•°æ®æ—¥å¿—å¤„ç†æˆ–å¯¹å®æ—¶æ€§ï¼ˆå°‘é‡å»¶è¿Ÿï¼‰ï¼Œå¯é æ€§ï¼ˆå°‘é‡ä¸¢æ•°æ®ï¼‰è¦æ±‚ç¨ä½çš„åœºæ™¯ä½¿ç”¨ã€‚</p><h2 id="å…­ã€å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å…­ã€å‚è€ƒèµ„æ–™"></a>å…­ã€å‚è€ƒèµ„æ–™</h2><p>ä»¥ä¸‹æ˜¯æœ¬æ¬¡åˆ†äº«å‚è€ƒçš„èµ„æ–™å’Œæ¨èå¤§å®¶å‚è€ƒçš„èµ„æ–™ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼ˆå¯å‚è€ƒèµ„æ–™ï¼‰ï¼š</p><p>ï¼ˆ1ï¼‰Jms</p><p><a href="https://blog.sina.com.cn/s/blog_3fba24680100r777.html">https://blog.sina.com.cn/s/blog_3fba24680100r777.html</a></p><p><a href="https://blog.csdn.net/jiuqiyuliang/article/details/46701559">https://blog.csdn.net/jiuqiyuliang/article/details/46701559</a>ï¼ˆæ·±å…¥æµ…å‡ºJMS(ä¸€)â€“JMSåŸºæœ¬æ¦‚å¿µï¼‰</p><p>ï¼ˆ2ï¼‰RabbitMQ</p><p><a href="https://baike.baidu.com/link?url=s2cU-QgOsXan7j0AM5qxxlmruz6WEeBQXX-Bbk0O3F5jt9Qts2uYQARxQxl7CBT2SO2NF2VkzX_XZLqU-CTaPa">https://baike.baidu.com/link?url=s2cU-QgOsXan7j0AM5qxxlmruz6WEeBQXX-Bbk0O3F5jt9Qts2uYQARxQxl7CBT2SO2NF2VkzX_XZLqU-CTaPa</a></p><p><a href="https://blog.csdn.net/sun305355024sun/article/details/41913105">https://blog.csdn.net/sun305355024sun/article/details/41913105</a></p><p>ï¼ˆ3ï¼‰Zero MQ</p><p><a href="https://www.searchtb.com/2012/08/zeromq-primer.html">https://www.searchtb.com/2012/08/zeromq-primer.html</a></p><p><a href="https://blog.csdn.net/yangbutao/article/details/8498790">https://blog.csdn.net/yangbutao/article/details/8498790</a></p><p><a href="https://wenku.baidu.com/link?url=yYoiZ_pYPCuUxEsGQvMMleY08bcptZvwF3IMHo2W1i-ti66YXXPpLLJBGXboddwgGBnOehHiUdslFhtz7RGZYkrtMQQ02DV5sv9JFF4LZnK">https://wenku.baidu.com/link?url=yYoiZ_pYPCuUxEsGQvMMleY08bcptZvwF3IMHo2W1i-ti66YXXPpLLJBGXboddwgGBnOehHiUdslFhtz7RGZYkrtMQQ02DV5sv9JFF4LZnK</a></p><p>ï¼ˆ4ï¼‰Kafka</p><p><a href="https://baike.baidu.com/link?url=qQXyqvPQ1MVrw9WkOGSGEfSX1NHy4unsgc4ezzJwU94SrPuVnrKf2tbm4SllVaN3ArGGxV_N5hw8JTT2-lw4QK">https://baike.baidu.com/link?url=qQXyqvPQ1MVrw9WkOGSGEfSX1NHy4unsgc4ezzJwU94SrPuVnrKf2tbm4SllVaN3ArGGxV_N5hw8JTT2-lw4QK</a></p><p><a href="https://www.infoq.com/cn/articles/apache-kafka/">https://www.infoq.com/cn/articles/apache-kafka/</a></p><p><a href="https://www.mincoder.com/article/3942.shtml">https://www.mincoder.com/article/3942.shtml</a></p><p>å·²åˆ†äº«çš„ç”µå­èµ„æ–™ï¼ˆåœ¨ç¾¤æ–‡ä»¶ä¸­ï¼‰</p><p>ï¼ˆ1ï¼‰Active MQ</p><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124221410015-1002634229.png" alt=""></p><p>ï¼ˆ2ï¼‰Kafka</p><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124221418875-383176625.png" alt=""></p><p>ï¼ˆ3ï¼‰Notify</p><p><img src="https://finalshares.cn/attachment/threadsImgs/images2015.cnblogs.com/blog/820332/201601/820332-20160124221427656-1416954592.png" alt=""></p><h2 id="ä¸ƒã€æœ¬æ¬¡åˆ†äº«æ€»ç»“"><a class="header-anchor" href="#ä¸ƒã€æœ¬æ¬¡åˆ†äº«æ€»ç»“"></a>ä¸ƒã€æœ¬æ¬¡åˆ†äº«æ€»ç»“</h2><p>ä»¥ä¸Šæ˜¯æœ¬å‘¨çš„åˆ†äº«ï¼Œä¸»è¦è®²è§£äº†æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°ï¼Œå¸¸ç”¨æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨åœºæ™¯ï¼ˆå¼‚æ­¥å¤„ç†ï¼Œåº”ç”¨è§£è€¦ï¼Œæµé‡å‰Šé”‹ï¼Œæ—¥å¿—å¤„ç†å’Œæ¶ˆæ¯é€šè®¯ï¼‰ï¼ŒJMS Javaæ¶ˆæ¯æœåŠ¡ï¼Œä»¥åŠç›®å‰æµè¡Œçš„å‡ æ¬¾æ¶ˆæ¯é˜Ÿåˆ—ä»‹ç»ã€‚æœ€åæ¼”ç¤ºäº†ä¸¤ä¸ªä½¿ç”¨æ¶ˆæ¯ä¸­é—´ä»¶çš„æ¶æ„ã€‚</p><p>å› ä¸ºæ—¶é—´å…³ç³»ï¼Œæœ‰äº›è®²è§£çš„ä¸ç»†è‡´ï¼Œå¤§å®¶å¯ä»¥é—®ä¸‹åº¦å¨˜/Googleï¼Œå¸Œæœ›æœ¬æ¬¡åˆ†äº«å¯¹å¤§å®¶æœ‰å¸®åŠ©ã€‚</p><p>æœ¬æ¬¡æ˜¯æ˜¥èŠ‚å‰æœ€åä¸€æ¬¡åˆ†äº«ï¼Œæˆ‘ä»¬çš„åˆ†äº«å¹´åä¼šç»§ç»­ï¼Œæ˜å¹´ä¼šç»§ç»­ã€Šå¤§å‹ç½‘ç«™æ¶æ„ç³»åˆ—ã€‹ï¼Œå¹¶ä¼šå¢åŠ ã€Šä¸€æ­¥ä¸€æ­¥å­¦æ¶æ„ç³»åˆ—ã€‹ã€‚å…·ä½“æ—¶é—´å’Œåˆ†äº«å†…å®¹ä¼šä»¥QQç¾¤å…¬å‘Šçš„æ–¹å¼é€šçŸ¥å¤§å®¶ã€‚æ„Ÿè°¢å¤§å®¶çš„å…³æ³¨ã€‚</p><p>åˆ†äº«æ˜¯å¿«ä¹çš„ï¼Œä¹Ÿæ˜¯ä¸ªäººæˆé•¿çš„è¿‡ç¨‹ã€‚æ–‡ç« ä¸€èˆ¬æ˜¯è‡ªå·±çš„å­¦ä¹ æ€»ç»“ï¼Œå·¥ä½œç»éªŒï¼Œä¸è¶³ä¹‹å¤„åœ¨æ‰€éš¾å…ï¼Œè¯·å¤§å®¶æŒ‡æ­£ï¼Œå…±åŒè¿›æ­¥ã€‚å»ºç«‹äº†ä¸€ä¸ªä»¥æ¶æ„ä¸ºä¸­å¿ƒçš„KKç¾¤466097527 ï¼Œæ¬¢è¿å¤§å®¶åŠ å…¥ã€‚ä¸“æ³¨å¤§å‹åˆ†å¸ƒå¼ç½‘ç«™æ¶æ„ï¼Œå¤§æ•°æ®ï¼Œæ¶æ„æ¨¡å¼ï¼Œè®¾è®¡æ¨¡å¼ã€‚</p><p>åŸæ–‡ï¼š<a href="https://www.cnblogs.com/itfly8/p/5155983.html">https://www.cnblogs.com/itfly8/p/5155983.html</a></p>]]></content>
    
    
    <categories>
      
      <category>project</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ¶æ„</tag>
      
      <tag>æ¶ˆæ¯é˜Ÿåˆ—</tag>
      
      <tag>åˆ†å¸ƒå¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql tableæ“ä½œå‘½ä»¤</title>
    <link href="/2018/05/25/mysql-table%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/"/>
    <url>/2018/05/25/mysql-table%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<pre><code class="hljs sql">1ã€æŸ¥çœ‹æ•°æ®åº“ä¸­æ‰€æœ‰è¡¨<span class="hljs-keyword">show</span> <span class="hljs-keyword">tables</span>ï¼›<span class="hljs-number">2</span>ã€åˆ›å»ºè¡¨<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span>( <span class="hljs-keyword">id</span> <span class="hljs-built_in">bigint</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> auto_increment, <span class="hljs-keyword">name</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>)<span class="hljs-keyword">charset</span> = utf8,<span class="hljs-keyword">engine</span>=<span class="hljs-keyword">innodb</span>;3ã€æ˜¾ç¤ºè¡¨ç»“æ„<span class="hljs-keyword">show</span> <span class="hljs-keyword">columns</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span>;4ã€æ˜¾ç¤ºè¡¨å…¨éƒ¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡¨ç»“æ„ã€è¡¨ä½¿ç”¨å¼•æ“ã€ç¼–ç ç­‰<span class="hljs-keyword">show</span> <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span>;5ã€ä¿®æ”¹è¡¨ç¼–ç <span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">default</span> <span class="hljs-built_in">character</span> <span class="hljs-keyword">set</span> gbk;6ã€ä¿®æ”¹è¡¨å¼•æ“<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">engine</span> = <span class="hljs-keyword">InnoDb</span>;7ã€æ–°å¢åˆ—<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span>  <span class="hljs-keyword">user</span> <span class="hljs-keyword">add</span> age <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>;8ã€åˆ é™¤åˆ—<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span>  <span class="hljs-keyword">user</span> <span class="hljs-keyword">drop</span> age;9ã€ä¿®æ”¹åˆ—ä¿¡æ¯<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">modify</span> age <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> <span class="hljs-number">18</span>;<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">change</span> age age <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> <span class="hljs-number">20</span> <span class="hljs-keyword">comment</span> â€˜å¹´é¾„â€™;ps:<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> ã€è¡¨åå­—ã€‘ <span class="hljs-keyword">CHANGE</span> ã€åˆ—åç§°ã€‘ã€æ–°åˆ—åç§°ã€‘ <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>  <span class="hljs-keyword">COMMENT</span> â€˜æ³¨é‡Šè¯´æ˜â€™<span class="hljs-number">10</span>ã€ç´¢å¼•æ“ä½œæŸ¥çœ‹ç´¢å¼•:<span class="hljs-keyword">show</span> <span class="hljs-keyword">index</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span>;10.1ã€æ™®é€šç´¢å¼•æ·»åŠ :<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> è¡¨å <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">index</span>ç´¢å¼•å(åˆ—å) æˆ–è€… <span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> ç´¢å¼•å <span class="hljs-keyword">on</span> è¡¨å(åˆ—å)<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">index</span> age1(age);<span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> age1 <span class="hljs-keyword">on</span> <span class="hljs-keyword">user</span>(age)åˆ é™¤:<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">index</span> age1;<span class="hljs-keyword">drop</span> <span class="hljs-keyword">index</span> age1 <span class="hljs-keyword">on</span> <span class="hljs-keyword">user</span>;10.2ã€å”¯ä¸€ç´¢å¼•æ·»åŠ ï¼š<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> è¡¨å <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">UNIQUE</span> ç´¢å¼•å(åˆ—å) æˆ–è€… <span class="hljs-keyword">create</span> <span class="hljs-keyword">UNIQUE</span> ç´¢å¼•å <span class="hljs-keyword">on</span> è¡¨å(åˆ—å)<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">unique</span> <span class="hljs-keyword">name</span>(<span class="hljs-keyword">name</span>);<span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> <span class="hljs-keyword">index</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">user</span>(<span class="hljs-keyword">name</span>);åˆ é™¤ï¼š<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">index</span> <span class="hljs-keyword">name</span>;10.3ã€ä¸»é”®ç´¢å¼•æ·»åŠ :<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> è¡¨å <span class="hljs-keyword">ADD</span> primary <span class="hljs-keyword">key</span>ç´¢å¼•å(åˆ—å)<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">add</span> primary <span class="hljs-keyword">key</span> <span class="hljs-keyword">id</span>(<span class="hljs-keyword">id</span>);ä¿®æ”¹ä¸ºè‡ªå¢é•¿å±æ€§ï¼š<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">change</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">id</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> auto_increment;<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">change</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">id</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>;åˆ é™¤ï¼š<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">drop</span> primary <span class="hljs-keyword">key</span><span class="hljs-number">10.4</span>ã€å…¨å±€ç´¢å¼•åªèƒ½é€‚åˆåœ¨MyISAMå¼•æ“ä¸Š<span class="hljs-number">11</span>ã€å¤–é”®æ“ä½œï¼ˆ<span class="hljs-number">1</span>ï¼‰åªæœ‰<span class="hljs-keyword">InnoDB</span>ç±»å‹çš„è¡¨æ‰å¯ä»¥ä½¿ç”¨å¤–é”®ï¼Œmysqlé»˜è®¤æ˜¯MyISAMï¼Œè¿™ç§ç±»å‹ä¸æ”¯æŒå¤–é”®çº¦æŸï¼ˆ<span class="hljs-number">2</span>ï¼‰å¤–é”®çš„å¥½å¤„ï¼šå¯ä»¥ä½¿å¾—ä¸¤å¼ è¡¨å…³è”ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå®ç°ä¸€äº›çº§è”æ“ä½œï¼›ï¼ˆ<span class="hljs-number">3</span>ï¼‰å¤–é”®çš„ä½œç”¨ï¼šä¿æŒæ•°æ®ä¸€è‡´æ€§ï¼Œå®Œæ•´æ€§ï¼Œä¸»è¦ç›®çš„æ˜¯æ§åˆ¶å­˜å‚¨åœ¨å¤–é”®è¡¨ä¸­çš„æ•°æ®ã€‚ ä½¿ä¸¤å¼ è¡¨å½¢æˆå…³è”ï¼Œå¤–é”®åªèƒ½å¼•ç”¨å¤–è¡¨ä¸­çš„åˆ—çš„å€¼ï¼ï¼ˆ<span class="hljs-number">4</span>ï¼‰å»ºç«‹å¤–é”®çš„å‰æï¼šä¸¤ä¸ªè¡¨å¿…é¡»æ˜¯<span class="hljs-keyword">InnoDB</span>è¡¨ç±»å‹ã€‚ä½¿ç”¨åœ¨å¤–é”®å…³ç³»çš„åŸŸå¿…é¡»ä¸ºç´¢å¼•å‹(<span class="hljs-keyword">Index</span>)ã€‚ä½¿ç”¨åœ¨å¤–é”®å…³ç³»çš„åŸŸå¿…é¡»ä¸æ•°æ®ç±»å‹ç›¸ä¼¼ï¼ˆ<span class="hljs-number">5</span>ï¼‰åˆ›å»ºçš„æ­¥éª¤æŒ‡å®šä¸»é”®å…³é”®å­—ï¼š <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span>(åˆ—å)å¼•ç”¨å¤–é”®å…³é”®å­—ï¼š <span class="hljs-keyword">references</span> &lt;å¤–é”®è¡¨å&gt;(å¤–é”®åˆ—å)ï¼ˆ<span class="hljs-number">6</span>ï¼‰äº‹ä»¶è§¦å‘é™åˆ¶:<span class="hljs-keyword">on</span> <span class="hljs-keyword">delete</span>å’Œ<span class="hljs-keyword">on</span> <span class="hljs-keyword">update</span> , å¯è®¾å‚æ•°<span class="hljs-keyword">cascade</span>(è·Ÿéšå¤–é”®æ”¹åŠ¨), restrict(é™åˆ¶å¤–è¡¨ä¸­çš„å¤–é”®æ”¹åŠ¨),<span class="hljs-keyword">set</span> <span class="hljs-literal">Null</span>(è®¾ç©ºå€¼ï¼‰,<span class="hljs-keyword">set</span> <span class="hljs-keyword">Default</span>ï¼ˆè®¾é»˜è®¤å€¼ï¼‰,[é»˜è®¤]<span class="hljs-keyword">no</span> <span class="hljs-keyword">action</span><span class="hljs-number">11.1</span>ã€æ·»åŠ è¯­æ³•:<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> è¡¨å <span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> FK_ID(å¤–é”®å) <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span>(å¤–é”®å­—æ®µå) <span class="hljs-keyword">REFERENCES</span> å¤–è¡¨è¡¨å(å¯¹åº”çš„è¡¨çš„ä¸»é”®å­—æ®µå);ä¾‹: <span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> locstock <span class="hljs-keyword">add</span> <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span> locstock_ibfk2(stockid) <span class="hljs-keyword">references</span> product(stockid)locstock ä¸ºè¡¨å, locstock_ibfk2 ä¸ºå¤–é”®å ç¬¬ä¸€ä¸ªæ‹¬å·é‡Œå¡«å†™å¤–é”®åˆ—å, productä¸ºè¡¨å,ç¬¬äºŒä¸ªæ‹¬å·é‡Œæ˜¯å†™å¤–é”®å…³è”çš„åˆ—å<span class="hljs-number">12.2</span>ã€åˆ é™¤ï¼š<span class="hljs-keyword">ALTER</span>   <span class="hljs-keyword">TABLE</span>   è¡¨å   <span class="hljs-keyword">DROP</span>   <span class="hljs-keyword">FOREIGN</span>   <span class="hljs-keyword">KEY</span>   å¤–é”®å     //å»æ‰å¤–é”®å”¯ä¸€ç´¢å¼•<span class="hljs-number">1</span>ã€æŸ¥çœ‹æ•°æ®åº“ä¸­æ‰€æœ‰è¡¨<span class="hljs-keyword">show</span> <span class="hljs-keyword">tables</span>ï¼›<span class="hljs-number">2</span>ã€åˆ›å»ºè¡¨<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span>( <span class="hljs-keyword">id</span> <span class="hljs-built_in">bigint</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> auto_increment, <span class="hljs-keyword">name</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>)<span class="hljs-keyword">charset</span> = utf8,<span class="hljs-keyword">engine</span>=<span class="hljs-keyword">innodb</span>;3ã€æ˜¾ç¤ºè¡¨ç»“æ„<span class="hljs-keyword">show</span> <span class="hljs-keyword">columns</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span>;4ã€æ˜¾ç¤ºè¡¨å…¨éƒ¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡¨ç»“æ„ã€è¡¨ä½¿ç”¨å¼•æ“ã€ç¼–ç ç­‰<span class="hljs-keyword">show</span> <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span>;5ã€ä¿®æ”¹è¡¨ç¼–ç <span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">default</span> <span class="hljs-built_in">character</span> <span class="hljs-keyword">set</span> gbk;6ã€ä¿®æ”¹è¡¨å¼•æ“<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">engine</span> = <span class="hljs-keyword">InnoDb</span>;7ã€æ–°å¢åˆ—<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span>  <span class="hljs-keyword">user</span> <span class="hljs-keyword">add</span> age <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>;8ã€åˆ é™¤åˆ—<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span>  <span class="hljs-keyword">user</span> <span class="hljs-keyword">drop</span> age;9ã€ä¿®æ”¹åˆ—ä¿¡æ¯<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">modify</span> age <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> <span class="hljs-number">18</span>;<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">change</span> age age <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> <span class="hljs-number">20</span> <span class="hljs-keyword">comment</span> â€˜å¹´é¾„â€™;ps:<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> ã€è¡¨åå­—ã€‘ <span class="hljs-keyword">CHANGE</span> ã€åˆ—åç§°ã€‘ã€æ–°åˆ—åç§°ã€‘ <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>  <span class="hljs-keyword">COMMENT</span> â€˜æ³¨é‡Šè¯´æ˜â€™<span class="hljs-number">10</span>ã€ç´¢å¼•æ“ä½œæŸ¥çœ‹ç´¢å¼•:<span class="hljs-keyword">show</span> <span class="hljs-keyword">index</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span>;10.1ã€æ™®é€šç´¢å¼•æ·»åŠ :<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> è¡¨å <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">index</span>ç´¢å¼•å(åˆ—å) æˆ–è€… <span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> ç´¢å¼•å <span class="hljs-keyword">on</span> è¡¨å(åˆ—å)<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">index</span> age1(age);<span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> age1 <span class="hljs-keyword">on</span> <span class="hljs-keyword">user</span>(age)åˆ é™¤:<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">index</span> age1;<span class="hljs-keyword">drop</span> <span class="hljs-keyword">index</span> age1 <span class="hljs-keyword">on</span> <span class="hljs-keyword">user</span>;10.2ã€å”¯ä¸€ç´¢å¼•æ·»åŠ ï¼š<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> è¡¨å <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">UNIQUE</span> ç´¢å¼•å(åˆ—å) æˆ–è€… <span class="hljs-keyword">create</span> <span class="hljs-keyword">UNIQUE</span> ç´¢å¼•å <span class="hljs-keyword">on</span> è¡¨å(åˆ—å)<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">unique</span> <span class="hljs-keyword">name</span>(<span class="hljs-keyword">name</span>);<span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> <span class="hljs-keyword">index</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">user</span>(<span class="hljs-keyword">name</span>);åˆ é™¤ï¼š<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">index</span> <span class="hljs-keyword">name</span>;10.3ã€ä¸»é”®ç´¢å¼•æ·»åŠ :<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> è¡¨å <span class="hljs-keyword">ADD</span> primary <span class="hljs-keyword">key</span>ç´¢å¼•å(åˆ—å)<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">add</span> primary <span class="hljs-keyword">key</span> <span class="hljs-keyword">id</span>(<span class="hljs-keyword">id</span>);ä¿®æ”¹ä¸ºè‡ªå¢é•¿å±æ€§ï¼š<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">change</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">id</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> auto_increment;<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">change</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">id</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>;åˆ é™¤ï¼š<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">drop</span> primary <span class="hljs-keyword">key</span><span class="hljs-number">10.4</span>ã€å…¨å±€ç´¢å¼•åªèƒ½é€‚åˆåœ¨MyISAMå¼•æ“ä¸Š<span class="hljs-number">11</span>ã€å¤–é”®æ“ä½œï¼ˆ<span class="hljs-number">1</span>ï¼‰åªæœ‰<span class="hljs-keyword">InnoDB</span>ç±»å‹çš„è¡¨æ‰å¯ä»¥ä½¿ç”¨å¤–é”®ï¼Œmysqlé»˜è®¤æ˜¯MyISAMï¼Œè¿™ç§ç±»å‹ä¸æ”¯æŒå¤–é”®çº¦æŸï¼ˆ<span class="hljs-number">2</span>ï¼‰å¤–é”®çš„å¥½å¤„ï¼šå¯ä»¥ä½¿å¾—ä¸¤å¼ è¡¨å…³è”ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå®ç°ä¸€äº›çº§è”æ“ä½œï¼›ï¼ˆ<span class="hljs-number">3</span>ï¼‰å¤–é”®çš„ä½œç”¨ï¼šä¿æŒæ•°æ®ä¸€è‡´æ€§ï¼Œå®Œæ•´æ€§ï¼Œä¸»è¦ç›®çš„æ˜¯æ§åˆ¶å­˜å‚¨åœ¨å¤–é”®è¡¨ä¸­çš„æ•°æ®ã€‚ ä½¿ä¸¤å¼ è¡¨å½¢æˆå…³è”ï¼Œå¤–é”®åªèƒ½å¼•ç”¨å¤–è¡¨ä¸­çš„åˆ—çš„å€¼ï¼ï¼ˆ<span class="hljs-number">4</span>ï¼‰å»ºç«‹å¤–é”®çš„å‰æï¼šä¸¤ä¸ªè¡¨å¿…é¡»æ˜¯<span class="hljs-keyword">InnoDB</span>è¡¨ç±»å‹ã€‚ä½¿ç”¨åœ¨å¤–é”®å…³ç³»çš„åŸŸå¿…é¡»ä¸ºç´¢å¼•å‹(<span class="hljs-keyword">Index</span>)ã€‚ä½¿ç”¨åœ¨å¤–é”®å…³ç³»çš„åŸŸå¿…é¡»ä¸æ•°æ®ç±»å‹ç›¸ä¼¼ï¼ˆ<span class="hljs-number">5</span>ï¼‰åˆ›å»ºçš„æ­¥éª¤æŒ‡å®šä¸»é”®å…³é”®å­—ï¼š <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span>(åˆ—å)å¼•ç”¨å¤–é”®å…³é”®å­—ï¼š <span class="hljs-keyword">references</span> &lt;å¤–é”®è¡¨å&gt;(å¤–é”®åˆ—å)ï¼ˆ<span class="hljs-number">6</span>ï¼‰äº‹ä»¶è§¦å‘é™åˆ¶:<span class="hljs-keyword">on</span> <span class="hljs-keyword">delete</span>å’Œ<span class="hljs-keyword">on</span> <span class="hljs-keyword">update</span> , å¯è®¾å‚æ•°<span class="hljs-keyword">cascade</span>(è·Ÿéšå¤–é”®æ”¹åŠ¨), restrict(é™åˆ¶å¤–è¡¨ä¸­çš„å¤–é”®æ”¹åŠ¨),<span class="hljs-keyword">set</span> <span class="hljs-literal">Null</span>(è®¾ç©ºå€¼ï¼‰,<span class="hljs-keyword">set</span> <span class="hljs-keyword">Default</span>ï¼ˆè®¾é»˜è®¤å€¼ï¼‰,[é»˜è®¤]<span class="hljs-keyword">no</span> <span class="hljs-keyword">action</span><span class="hljs-number">11.1</span>ã€æ·»åŠ è¯­æ³•:<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> è¡¨å <span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> FK_ID(å¤–é”®å) <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span>(å¤–é”®å­—æ®µå) <span class="hljs-keyword">REFERENCES</span> å¤–è¡¨è¡¨å(å¯¹åº”çš„è¡¨çš„ä¸»é”®å­—æ®µå);ä¾‹: <span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> locstock <span class="hljs-keyword">add</span> <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span> locstock_ibfk2(stockid) <span class="hljs-keyword">references</span> product(stockid)locstock ä¸ºè¡¨å, locstock_ibfk2 ä¸ºå¤–é”®å ç¬¬ä¸€ä¸ªæ‹¬å·é‡Œå¡«å†™å¤–é”®åˆ—å, productä¸ºè¡¨å,ç¬¬äºŒä¸ªæ‹¬å·é‡Œæ˜¯å†™å¤–é”®å…³è”çš„åˆ—å<span class="hljs-number">12.2</span>ã€åˆ é™¤ï¼š<span class="hljs-keyword">ALTER</span>   <span class="hljs-keyword">TABLE</span>   è¡¨å   <span class="hljs-keyword">DROP</span>   <span class="hljs-keyword">FOREIGN</span>   <span class="hljs-keyword">KEY</span>   å¤–é”®å     //å»æ‰å¤–é”®å”¯ä¸€ç´¢å¼•</code></pre>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysqlå‘½ä»¤</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysqléƒ¨åˆ†ç³»ç»Ÿå‘½ä»¤</title>
    <link href="/2018/05/25/mysql%E9%83%A8%E5%88%86%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4/"/>
    <url>/2018/05/25/mysql%E9%83%A8%E5%88%86%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<p>1ã€æŸ¥çœ‹æ‰€æœ‰ç³»ç»Ÿè®¾ç½®<br>show variables;</p><p>2ã€æŸ¥çœ‹æŒ‡å®šç³»ç»Ÿè®¾ç½®<br>show variables like â€˜%bulk_insert_buffer_size%â€™</p><p>3ã€è®¾ç½®<br>set low_priority_updates=0;</p><p>4ã€å¸¸è§ç³»ç»Ÿå‚æ•°<br>show status like â€˜uptimeâ€™;<br>show status like â€˜com_selectâ€™;<br>show status like â€˜com_insertâ€™;<br>show status like â€˜com_updateâ€™;<br>show status like â€˜com_deleteâ€™;<br>show status like â€˜connectionsâ€™;<br>show status like â€˜slow_queriesâ€™;</p><p>5ã€æŸ¥çœ‹MySQLè¿æ¥æ•°<br>show processlist<br>show full processlist</p><p>æˆ–è€…<br>mysqladmin -uroot -p processlist</p><p>6ã€åªæŸ¥çœ‹å½“å‰è¿æ¥æ•°(Threadså°±æ˜¯è¿æ¥æ•°.):<br>mysqladmin Â -uadmin -p status</p><p>7ã€è®¾ç½®mysqlé“¾æ¥æ•°æ®<br>#vim /etc/my.cnf<br>max_user_connections=30 è¿™ä¸ªå°±æ˜¯å•ç”¨æˆ·çš„è¿æ¥æ•°<br>max_connections=800 è¿™ä¸ªæ˜¯å…¨å±€çš„é™åˆ¶è¿æ¥æ•°</p>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å‘½ä»¤</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>tcpdump æŠ“åŒ…tcp flagå«ä¹‰</title>
    <link href="/2018/05/25/tcpdump-%E6%8A%93%E5%8C%85tcp-flag%E5%90%AB%E4%B9%89/"/>
    <url>/2018/05/25/tcpdump-%E6%8A%93%E5%8C%85tcp-flag%E5%90%AB%E4%B9%89/</url>
    
    <content type="html"><![CDATA[<h4 id="TCP-FLAG-æ ‡è®°"><a class="header-anchor" href="#TCP-FLAG-æ ‡è®°"></a>TCP FLAG æ ‡è®°</h4><p>åŸºäºæ ‡è®°çš„TCPåŒ…åŒ¹é…ç»å¸¸è¢«ç”¨äºè¿‡æ»¤è¯•å›¾æ‰“å¼€æ–°è¿æ¥çš„TCPæ•°æ®åŒ…ã€‚</p><ul><li><p>TCPæ ‡è®°å’Œä»–ä»¬çš„æ„ä¹‰å¦‚ä¸‹æ‰€åˆ—ï¼š</p><p>* F : FIN - ç»“æŸ; ç»“æŸä¼šè¯<br>* S : SYN - åŒæ­¥; è¡¨ç¤ºå¼€å§‹ä¼šè¯è¯·æ±‚<br>* R : RST - å¤ä½;ä¸­æ–­ä¸€ä¸ªè¿æ¥<br>* P : PUSH - æ¨é€; æ•°æ®åŒ…ç«‹å³å‘é€<br>* A : ACK - åº”ç­”<br>* U : URG - ç´§æ€¥<br>* E : ECE - æ˜¾å¼æ‹¥å¡æé†’å›åº”<br>* W : CWR - æ‹¥å¡çª—å£å‡å°‘</p></li></ul><p>ç¤ºä¾‹ï¼š</p><ul><li>ä¸‰æ¬¡æ¡æ‰‹Three-way Handshake</li></ul><p>ä¸€ä¸ªè™šæ‹Ÿè¿æ¥çš„å»ºç«‹æ˜¯é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹æ¥å®ç°çš„</p><p>1. (B) --&gt; [SYN] --&gt; (A)</p><p>å‡å¦‚æœ‰æœåŠ¡å™¨Aã€å®¢æˆ·æœºB. å½“Bè¦å’ŒAé€šä¿¡æ—¶ï¼ŒBé¦–å…ˆå‘Aå‘ä¸€ä¸ªSYN (Synchronize) æ ‡è®°çš„åŒ…ï¼Œå‘Šè¯‰Aè¯·æ±‚å»ºç«‹è¿æ¥.</p><p>æ³¨æ„: ä¸€ä¸ª SYNåŒ…å°±æ˜¯ä»…SYNæ ‡è®°è®¾ä¸º1çš„TCPåŒ…(å‚è§TCPåŒ…å¤´Resources). åªæœ‰å½“Aæ”¶åˆ°Bå‘æ¥çš„SYNåŒ…ï¼Œæ‰å¯å»ºç«‹è¿æ¥ï¼Œé™¤æ­¤ä¹‹å¤–åˆ«æ— ä»–æ³•ã€‚</p><p>2. (B) &lt;-- [SYN/ACK] &lt;â€“(A)</p><p>æ¥ç€ï¼ŒAæ”¶åˆ°åä¼šå‘ä¸€ä¸ªå¯¹SYNåŒ…çš„ç¡®è®¤åŒ…(SYN/ACK)å›å»ï¼Œè¡¨ç¤ºå¯¹ç¬¬ä¸€ä¸ªSYNåŒ…çš„ç¡®è®¤ï¼Œå¹¶ç»§ç»­æ¡æ‰‹æ“ä½œ.</p><p>æ³¨æ„: SYN/ACKåŒ…æ˜¯ä»…SYN å’Œ ACK æ ‡è®°ä¸º1çš„åŒ….</p><p>3. (B) --&gt; [ACK] --&gt; (A)</p><p>Bæ”¶åˆ°SYN/ACK åŒ…,Bå‘ä¸€ä¸ªç¡®è®¤åŒ…(ACK)ï¼Œé€šçŸ¥Aè¿æ¥å·²å»ºç«‹ã€‚è‡³æ­¤ï¼Œä¸‰æ¬¡æ¡æ‰‹å®Œæˆï¼Œä¸€ä¸ªTCPè¿æ¥å®Œæˆã€‚</p><p>æ³¨æ„: ACKåŒ…å°±æ˜¯ä»…ACK æ ‡è®°è®¾ä¸º1çš„TCPåŒ….</p><p>ç‰¹åˆ«æ³¨æ„ï¼šéœ€è¦æ³¨æ„çš„æ˜¯å½“ä¸‰æ­¤æ¡æ‰‹å®Œæˆã€è¿æ¥å»ºç«‹ä»¥åï¼ŒTCPè¿æ¥çš„æ¯ä¸ªåŒ…éƒ½ä¼šè®¾ç½®ACKä½</p><p>PSï¼šè¿™å°±æ˜¯ä¸ºä½•è¿æ¥è·Ÿè¸ªå¾ˆé‡è¦çš„åŸå› äº†. æ²¡æœ‰è¿æ¥è·Ÿè¸ª,é˜²ç«å¢™å°†æ— æ³•åˆ¤æ–­æ”¶åˆ°çš„ACKåŒ…æ˜¯å¦å±äºä¸€ä¸ªå·²ç»å»ºç«‹çš„è¿æ¥.ä¸€èˆ¬çš„åŒ…è¿‡æ»¤(Ipchains)æ”¶åˆ°ACKåŒ…æ—¶,ä¼šè®©å®ƒé€šè¿‡(è¿™ç»å¯¹ä¸æ˜¯ä¸ªå¥½ä¸»æ„). è€Œå½“çŠ¶æ€å‹é˜²ç«å¢™æ”¶åˆ°æ­¤ç§åŒ…æ—¶ï¼Œå®ƒä¼šå…ˆåœ¨è¿æ¥è¡¨ä¸­æŸ¥æ‰¾æ˜¯å¦å±äºå“ªä¸ªå·²å»ºè¿æ¥ï¼Œå¦åˆ™ä¸¢å¼ƒè¯¥åŒ…</p><ul><li>å››æ¬¡æ¡æ‰‹Four-way Handshake</li></ul><p>å››æ¬¡æ¡æ‰‹ç”¨æ¥å…³é—­å·²å»ºç«‹çš„TCPè¿æ¥</p><p>1. (B) --&gt; ACK/FIN --&gt; (A)</p><p>2. (B) &lt;-- ACK &lt;-- (A)</p><p>3. (B) &lt;-- ACK/FIN &lt;-- (A)</p><p>4. (B) --&gt; ACK --&gt; (A)</p><p>æ³¨æ„: ç”±äºTCPè¿æ¥æ˜¯åŒå‘è¿æ¥, å› æ­¤å…³é—­è¿æ¥éœ€è¦åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šåšã€‚ACK/FIN åŒ…(ACK å’ŒFIN æ ‡è®°è®¾ä¸º1)é€šå¸¸è¢«è®¤ä¸ºæ˜¯FIN(ç»ˆç»“)åŒ….ç„¶è€Œ, ç”±äºè¿æ¥è¿˜æ²¡æœ‰å…³é—­, FINåŒ…æ€»æ˜¯æ‰“ä¸ŠACKæ ‡è®°. æ²¡æœ‰ACKæ ‡è®°è€Œä»…æœ‰FINæ ‡è®°çš„åŒ…ä¸æ˜¯åˆæ³•çš„åŒ…ï¼Œå¹¶ä¸”é€šå¸¸è¢«è®¤ä¸ºæ˜¯æ¶æ„çš„</p><ul><li>è¿æ¥å¤ä½Resetting a connection</li></ul><p>å››æ¬¡æ¡æ‰‹ä¸æ˜¯å…³é—­TCPè¿æ¥çš„å”¯ä¸€æ–¹æ³•. æœ‰æ—¶,å¦‚æœä¸»æœºéœ€è¦å°½å¿«å…³é—­è¿æ¥(æˆ–è¿æ¥è¶…æ—¶,ç«¯å£æˆ–ä¸»æœºä¸å¯è¾¾),RST (Reset)åŒ…å°†è¢«å‘é€. æ³¨æ„åœ¨ï¼Œç”±äºRSTåŒ…ä¸æ˜¯TCPè¿æ¥ä¸­çš„å¿…é¡»éƒ¨åˆ†,Â å¯ä»¥åªå‘é€RSTåŒ…(å³ä¸å¸¦ACKæ ‡è®°). ä½†åœ¨æ­£å¸¸çš„TCPè¿æ¥ä¸­RSTåŒ…å¯ä»¥å¸¦ACKç¡®è®¤æ ‡è®°ã€‚</p><p>æ³¨æ„ï¼šRSTåŒ…æ˜¯å¯ä»¥ä¸è¦æ”¶åˆ°æ–¹ç¡®è®¤çš„</p><ul><li>æ— æ•ˆçš„TCPæ ‡è®°Invalid TCP Flags</li></ul><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä½ å·²ç»çœ‹åˆ°äº† SYN, ACK, FIN, å’ŒRST æ ‡è®°. å¦å¤–ï¼Œè¿˜æœ‰PSH (Push) å’ŒURG (Urgent)æ ‡è®°.</p><p>æœ€å¸¸è§çš„éæ³•ç»„åˆæ˜¯SYN/FIN åŒ…. æ³¨æ„:ç”±äº SYNåŒ…æ˜¯ç”¨æ¥åˆå§‹åŒ–è¿æ¥çš„, å®ƒä¸å¯èƒ½å’Œ FINå’ŒRSTæ ‡è®°ä¸€èµ·å‡ºç°. è¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ¶æ„æ”»å‡».</p><p>ç”±äºç°åœ¨å¤§å¤šæ•°é˜²ç«å¢™å·²çŸ¥ SYN/FIN åŒ…, åˆ«çš„ä¸€äº›ç»„åˆ,ä¾‹å¦‚SYN/FIN/PSH, SYN/FIN/RST, SYN/FIN/RST/PSHã€‚å¾ˆæ˜æ˜¾ï¼Œå½“ç½‘ç»œä¸­å‡ºç°è¿™ç§åŒ…æ—¶ï¼Œå¾ˆä½ çš„ç½‘ç»œè‚¯å®šå—åˆ°æ”»å‡»äº†ã€‚</p><p>åˆ«çš„å·²çŸ¥çš„éæ³•åŒ…æœ‰FIN (æ— ACKæ ‡è®°)å’Œ&quot;NULL&quot;åŒ…ã€‚å¦‚åŒæ—©å…ˆè®¨è®ºçš„ï¼Œç”±äºACK/FINåŒ…çš„å‡ºç°æ˜¯ä¸ºäº†å…³é—­ä¸€ä¸ªTCPè¿æ¥ï¼Œé‚£ä¹ˆæ­£å¸¸çš„FINåŒ…æ€»æ˜¯å¸¦æœ‰ ACK æ ‡è®°ã€‚&quot;NULL&quot;åŒ…å°±æ˜¯æ²¡æœ‰ä»»ä½•TCPæ ‡è®°çš„åŒ…(URG,ACK,PSH,RST,SYN,FINéƒ½ä¸º0)ã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ­£å¸¸çš„ç½‘ç»œæ´»åŠ¨ä¸‹ï¼ŒTCPåè®®æ ˆä¸å¯èƒ½äº§ç”Ÿå¸¦æœ‰ä¸Šé¢æåˆ°çš„ä»»ä½•ä¸€ç§æ ‡è®°ç»„åˆçš„TCPåŒ…ã€‚å½“ä½ å‘ç°è¿™äº›ä¸æ­£å¸¸çš„åŒ…æ—¶ï¼Œè‚¯å®šæœ‰äººå¯¹ä½ çš„ç½‘ç»œä¸æ€€å¥½æ„ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>ç½‘ç»œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>tcpdump</tag>
      
      <tag>æŠ“åŒ…</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql æºç å®‰è£…</title>
    <link href="/2018/05/19/mysql-%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85/"/>
    <url>/2018/05/19/mysql-%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<p><strong>ä¾èµ–ï¼š</strong> <code>apt-get install make bison g++ build-essential libncurses5-dev cmake sysv-rc-conf git</code> <strong>1ã€æ·»åŠ mysqlç”¨æˆ·ç»„å¹¶æ·»åŠ mysqlç”¨æˆ·ï¼Œå¹¶ä¸”ä¸å…è®¸ç™»å½•</strong></p><pre><code class="hljs gradle">groupadd mysqluseradd -r -g mysql -s <span class="hljs-regexp">/bin/</span><span class="hljs-keyword">false</span> -M mysql</code></pre><p><strong>2ã€ä¸‹è½½mysqlæºç åŒ…ï¼Œæ­¤å¤„ä¸‹è½½ä¸ºmysql5.7.20</strong> <code>https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.20.tar.gz</code> <strong>è§£å‹</strong></p><pre><code class="hljs apache"><span class="hljs-attribute">tar</span> -zxvf mysql-<span class="hljs-number">5</span>.<span class="hljs-number">7</span>.<span class="hljs-number">20</span>.tar.gz<span class="hljs-attribute">cd</span> mysql-<span class="hljs-number">5</span>.<span class="hljs-number">7</span>.<span class="hljs-number">20</span></code></pre><p><strong>3ã€æ›´æ–°ç¯å¢ƒ</strong></p><pre><code class="hljs routeros">apt-<span class="hljs-builtin-name">get</span> updateapt-<span class="hljs-builtin-name">get</span> upgrade</code></pre><p><strong>å®‰è£…gccã€bisonã€cmake</strong></p><pre><code class="hljs routeros">apt-<span class="hljs-builtin-name">get</span> install gccapt-<span class="hljs-builtin-name">get</span> install bisonapt-<span class="hljs-builtin-name">get</span> install cmake</code></pre><p><strong>4ã€å®‰è£…</strong> 4.1ã€åˆ›å»ºå®‰è£…è·¯å¾„ä»¥åŠæ•°æ®å­˜å‚¨è·¯å¾„</p><pre><code class="hljs awk">mkdir <span class="hljs-regexp">/usr/</span>local/mysqlmkdir <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/mysql/</span>data</code></pre><p>4.2ã€cmakeé…ç½®</p><pre><code class="hljs routeros">cmake \<span class="hljs-attribute">-DCMAKE_INSTALL_PREFIX</span>=/usr/local/mysql \<span class="hljs-attribute">-DMYSQL_UNIX_ADDR</span>=/usr/local/mysql/mysql.sock \<span class="hljs-attribute">-DSYSCONFDIR</span>=/etc \<span class="hljs-attribute">-DDEFAULT_CHARSET</span>=utf8 \<span class="hljs-attribute">-DDEFAULT_COLLATION</span>=utf8_general_ci \<span class="hljs-attribute">-DWITH_MYISAM_STORAGE_ENGINE</span>=1 \<span class="hljs-attribute">-DWITH_INNOBASE_STORAGE_ENGINE</span>=1 \<span class="hljs-attribute">-DWITH_ARCHIVE_STORAGE_ENGINE</span>=1 \<span class="hljs-attribute">-DWITH_BLACKHOLE_STORAGE_ENGINE</span>=1 \<span class="hljs-attribute">-DENABLED_LOCAL_INFILE</span>=1 \<span class="hljs-attribute">-DMYSQL_DATADIR</span>=/usr/local/mysql/data \<span class="hljs-attribute">-DDOWNLOAD_BOOST</span>=1 \<span class="hljs-attribute">-DWITH_BOOST</span>=/usr/local/mysql/mysql-boost \<span class="hljs-attribute">-DMYSQL_TCP_PORT</span>=3306 \<span class="hljs-attribute">-DENABLE_DOWNLOADS</span>=1é”™è¯¯1ï¼šubuntu mysql Could <span class="hljs-keyword">NOT</span> <span class="hljs-builtin-name">find</span> Gitapt-<span class="hljs-builtin-name">get</span> install gitå¦å¤–éœ€è¦rm CMakeCache.txté”™è¯¯2ï¼š<span class="hljs-literal">No</span> CMAKE_CXX_COMPILER could be foundapt-<span class="hljs-builtin-name">get</span> install g++é”™è¯¯3ï¼šCurses library <span class="hljs-keyword">not</span> foundapt-<span class="hljs-builtin-name">get</span> install libncurses5-devå¦å¤–éœ€è¦rm CMakeCache.txté”™è¯¯4ï¼šg++: internal compiler error: Killed (program cc1plus)ä¸»è¦åŸå› å¤§ä½“ä¸Šæ˜¯å› ä¸ºå†…å­˜ä¸è¶³ï¼Œä¸´æ—¶ä½¿ç”¨äº¤æ¢åˆ†åŒºæ¥è§£å†³sudo dd <span class="hljs-attribute">if</span>=/dev/zero <span class="hljs-attribute">of</span>=/swapfile <span class="hljs-attribute">bs</span>=64M <span class="hljs-attribute">count</span>=16sudo mkswap /swapfilesudo swapon /swapfileå®‰è£…å®Œæˆä¹‹åï¼Œåˆ é™¤åˆ›å»ºçš„äº¤æ¢åˆ†åŒºsudo swapoff /swapfilesudo rm /swapfile</code></pre><p><strong>4.3ã€make &amp;&amp; make install</strong> <strong>5ã€æƒé™é™å®š</strong> <code>chown -R mysql: /usr/local/mysql</code> <strong>6ã€åˆå§‹åŒ–æ•°æ®åº“</strong></p><pre><code class="hljs awk"><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/mysql/</span>bin<span class="hljs-regexp">/mysqld â€“initialize â€“user=mysql â€“basedir=/u</span>sr<span class="hljs-regexp">/local/my</span>sql â€“datadir=<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/mysql/</span>data<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/mysql/</span>bin<span class="hljs-regexp">/mysqld â€“initialize-insecure â€“user=mysql â€“basedir=/u</span>sr<span class="hljs-regexp">/local/my</span>sql<span class="hljs-regexp">/ â€“datadir=/u</span>sr<span class="hljs-regexp">/local/my</span>sql<span class="hljs-regexp">/data/</span></code></pre>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç¼–è¯‘å®‰è£…</tag>
      
      <tag>æºç å®‰è£…</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>php æºç å®‰è£…</title>
    <link href="/2018/05/19/php-%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85/"/>
    <url>/2018/05/19/php-%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<pre><code class="hljs awk">ä¾èµ–åº“ apt-get install libxml2-dev autoconf libxml2-dev build-essential libcurl4-gnutls-dev openssl make <span class="hljs-number">1</span>ã€ä¸‹è½½æºç ï¼ˆç‰ˆæœ¬é€‰æ‹©ï¼‰wget https:<span class="hljs-regexp">//</span>cn2.php.net<span class="hljs-regexp">/distributions/</span>php-<span class="hljs-number">7.2</span>.<span class="hljs-number">3</span>.tar.gz wget https:<span class="hljs-regexp">//</span>cn2.php.net<span class="hljs-regexp">/distributions/</span>php-<span class="hljs-number">7.2</span>.<span class="hljs-number">0</span>.tar.gzwget https:<span class="hljs-regexp">//</span>cn2.php.net<span class="hljs-regexp">/distributions/</span>php-<span class="hljs-number">7.1</span>.<span class="hljs-number">15</span>.tar.gzwget https:<span class="hljs-regexp">//</span>cn.php.net<span class="hljs-regexp">/distributions/</span>php-<span class="hljs-number">5.6</span>.<span class="hljs-number">34</span>.tar.gz<span class="hljs-number">2</span>è§£å‹tar -zxvf php-<span class="hljs-number">7.2</span>.<span class="hljs-number">3</span>.tar.gz<span class="hljs-number">3</span>ã€å‡†å¤‡å®‰è£…æ–‡ä»¶å¤¹mkdir <span class="hljs-regexp">/usr/</span>local/php<span class="hljs-number">4</span>ã€é…ç½®cd php-<span class="hljs-number">7.2</span>.<span class="hljs-number">3</span>Aã€å¦‚æœPHPæ­é…Apacheä½¿ç”¨ï¼Œé‚£ä¹ˆé…ç½®å¦‚ä¸‹.<span class="hljs-regexp">/configure â€“prefix=/u</span>sr<span class="hljs-regexp">/local/</span>php â€“with-apxs2=<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/apache2/</span>bin/apxsæ³¨ï¼š<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/apache2/</span>bin/apxsï¼Œå…¶ä¸­apxsæ˜¯åœ¨å®‰è£…Apacheæ—¶äº§ç”Ÿçš„ï¼Œapxsæ˜¯ä¸€ä¸ªä¸ºApache HTTPæœåŠ¡å™¨ç¼–è¯‘å’Œå®‰è£…æ‰©å±•æ¨¡å—çš„å·¥å…·ï¼Œä½¿ä¹‹å¯ä»¥ç”¨ç”±mod_soæä¾›çš„LoadModuleæŒ‡ä»¤åœ¨è¿è¡Œæ—¶åŠ è½½åˆ°ApacheæœåŠ¡å™¨ä¸­Bã€å¦‚æœåªæ˜¯å•ç‹¬å®‰è£…PHPä»¥åŠMySQLçš„æ‰©å±•ï¼Œè€Œä¸å®‰è£…MySQLæœåŠ¡ï¼Œé‚£ä¹ˆéœ€è¦æ·»åŠ ä¸‹é¢çš„é…ç½®â€“enable-sockets=shared  â€“with-pdo-mysql=shared,mysqlnd æˆ–è€… â€“with-mysql=shared,mysqlndCã€å¯åŠ¨é…ç½®php-fpmâ€“enable-fpmæ€»ç»“ï¼šå®‰è£…çš„æ˜¯ä¸å¸¦Apache å’Œ Mysql æœåŠ¡å™¨ï¼Œå¹¶ä¸”ä½¿ç”¨PDOæ‰©å±•ï¼Œé‚£ä¹ˆé…ç½®å¦‚ä¸‹ï¼š.<span class="hljs-regexp">/configure â€“prefix=/u</span>sr<span class="hljs-regexp">/local/</span>php â€“enable-sockets=shared  â€“enable-fpm â€“with-pdo-mysql=shared,mysqlndå®‰è£…çš„å¸¦apacheçš„ï¼š.<span class="hljs-regexp">/configure â€“prefix=/u</span>sr<span class="hljs-regexp">/local/</span>php â€“with-apxs2=<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/apache2/</span>bin/apxs â€“enable-sockets=shared  â€“enable-fpm â€“with-pdo-mysql=shared,mysqlnd<span class="hljs-number">5</span>ï¼Œç¼–è¯‘ make<span class="hljs-number">6</span>ã€å®‰è£… make install æ³¨ï¼šå¦‚æœè¿‡ç¨‹å¤±è´¥ï¼Œmake distclean å¹¶é‡æ–°æ“ä½œ<span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> ï¼Œ<span class="hljs-number">7</span>ã€å¤åˆ¶inicp <span class="hljs-regexp">/php-7.2.0/</span>php.ini-development  <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>lib/php.ini    æŠŠåŸæ¥ä½äºæºä»£ç é‡Œé¢çš„php.ini-developmentæ‹·è´åˆ°<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>lib/php.iniä¸‹ï¼Œå¹¶ä¸”é‡å‘½åä¸ºphp.ini<span class="hljs-number">8</span>ã€æŠŠphpåŠ å…¥åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡echo â€œexport PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>bin<span class="hljs-regexp">/phpâ€  &gt;&gt; /</span>etc/profilesource <span class="hljs-regexp">/etc/</span>profile<span class="hljs-number">9</span>ã€æŸ¥çœ‹phpç‰ˆæœ¬<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>bin/php â€“version<span class="hljs-number">10</span>ã€å®‰è£…æ‰©å±•é¦–å…ˆï¼Œè¯·ç¡®ä¿å·²ç»å®‰è£…äº†autoconfï¼Œå¦‚æœªå®‰è£…ï¼Œè¯·æ‰§è¡Œapt-get install autoconfç¼–è¯‘å®Œæˆä¹‹åï¼Œå°†ä¼šè‡ªåŠ¨æŠŠmysql.soæ”¾åˆ°äº†é»˜è®¤çš„phpæ‰©å±•ç›®å½•ä¸‹ï¼ˆphpinfoå¯æŸ¥çœ‹ï¼Œæˆ‘çš„ä¸º <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>lib<span class="hljs-regexp">/php/</span>extensions/no-debug-zts-<span class="hljs-number">20090626</span>ï¼‰ï¼Œå†ä¿®æ”¹php.iniä¿®æ”¹php.ini,æ·»åŠ ä¸€å¥extension=mbstring.sombstringæ‰©å±•[html] view plain copy<span class="hljs-number">1</span>ã€è¿›å…¥æºç mbstringæ–‡ä»¶å¤¹  cd <span class="hljs-regexp">/php-7.2.0/</span>ext/mbstring  <span class="hljs-number">2</span>ã€<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>bin/phpize   ç”Ÿæˆmakefileæ–‡ä»¶  <span class="hljs-number">3</span>ã€æ‰§è¡Œç”Ÿæˆconfigureï¼ˆå‡è®¾phpå®‰è£…åœ¨<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/phpç›®å½•ä¸‹ï¼‰  ./</span>configure â€“with-php-config=<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>bin/php-config  <span class="hljs-number">4</span>ã€ç¼–è¯‘&amp;å®‰è£…  make &amp;&amp; make install  php.ini æ·»åŠ ä¸€è¡Œï¼šextension=mbstring.sopdo_mysqlæ‰©å±•<span class="hljs-number">1</span>ã€è¿›å…¥æºç pdo_mysqlæ–‡ä»¶å¤¹ cd <span class="hljs-regexp">/php-7.2.0/</span>ext/pdo_mysql <span class="hljs-number">2</span>ã€æ‰§è¡Œç”Ÿæˆconfigureï¼ˆå‡è®¾phpå®‰è£…åœ¨<span class="hljs-regexp">/usr/</span>local/phpç›®å½•ä¸‹ï¼‰ <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>bin/phpize <span class="hljs-number">3</span>ã€ç”Ÿæˆmakefileæ–‡ä»¶ .<span class="hljs-regexp">/configure â€“with-php-config=/u</span>sr<span class="hljs-regexp">/local/</span>php<span class="hljs-regexp">/bin/</span>php-config å‡å¦‚ä½ åœ¨æœ¬åœ°å®‰è£…äº†mysqlæœåŠ¡ï¼Œé‚£ä¹ˆéœ€æ‰§è¡Œä¸‹é¢å‘½ä»¤ .<span class="hljs-regexp">/configure â€“with-php-config=/u</span>sr<span class="hljs-regexp">/local/</span>php<span class="hljs-regexp">/bin/</span>php-config â€“with-pdo-mysql=<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/mysql/</span> <span class="hljs-number">4</span>ã€ç¼–è¯‘&amp;å®‰è£… make &amp;&amp; make install <span class="hljs-number">5</span>ã€ä¿®æ”¹php.ini,æ·»åŠ ä¸€å¥extension=pdo_mysql.so zlibæ‰©å±•æ­¤æ‰©å±•è¿›å…¥æºç <span class="hljs-regexp">/php-7.2.0/</span>ext/zlibå®‰è£…ä¼šå‡ºé”™ï¼Œå› æ­¤å…ˆæ‰§è¡Œä¸‹é¢è¯­å¥ <span class="hljs-number">1</span>ã€ https:<span class="hljs-regexp">//</span>www.zlib.net/ä¸‹è½½zlibæºç  wget https:<span class="hljs-regexp">//</span>www.zlib.net/zlib-<span class="hljs-number">1.2</span>.<span class="hljs-number">11</span>.tar.gz <span class="hljs-number">2</span>ã€è§£å‹ï¼Œé…ç½®ï¼Œç¼–è¯‘ï¼Œå®‰è£… tar -zxvf zlib-<span class="hljs-number">1.2</span>.<span class="hljs-number">11</span>.tar.gz cd zlib-<span class="hljs-number">1.2</span>.<span class="hljs-number">11</span>/ .<span class="hljs-regexp">/configure â€“prefix=/u</span>sr<span class="hljs-regexp">/local/</span>zlib make &amp;&amp; make install <span class="hljs-number">3</span>ã€é‡æ–°é…ç½®ã€ç¼–è¯‘ã€å®‰è£…PHP,å¢åŠ å‚æ•°â€“with-zlib-dir=<span class="hljs-regexp">/usr/</span>local/zlib .<span class="hljs-regexp">/configure â€“prefix=/u</span>sr<span class="hljs-regexp">/local/</span>php \ â€“enable-sockets=shared \ â€“with-pdo-mysql=shared,mysqlnd \ â€“with-zlib-dir=<span class="hljs-regexp">/usr/</span>local/zlib curlæ‰©å±•[html] view plain copy<span class="hljs-number">1</span>ã€å®‰è£…apt-get install libcurl4-gnutls-devï¼Œå¦‚æœå‡ºé”™ï¼Œè¯·å…ˆapt-get update <span class="hljs-number">2</span>ã€è¿›å…¥æºç curlæ–‡ä»¶å¤¹ cd <span class="hljs-regexp">/php-7.2.0/</span>ext/curl <span class="hljs-number">3</span>ã€æ‰§è¡Œç”Ÿæˆconfigureï¼ˆå‡è®¾phpå®‰è£…åœ¨<span class="hljs-regexp">/usr/</span>local/phpç›®å½•ä¸‹ï¼‰ <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>bin/phpize <span class="hljs-number">4</span>ã€ç”Ÿæˆmakefileæ–‡ä»¶ .<span class="hljs-regexp">/configure â€“with-php-config=/u</span>sr<span class="hljs-regexp">/local/</span>php<span class="hljs-regexp">/bin/</span>php-config <span class="hljs-number">5</span>ã€ç¼–è¯‘&amp;å®‰è£… make &amp;&amp; make install <span class="hljs-number">6</span>ã€ä¿®æ”¹php.ini,æ·»åŠ ä¸€å¥extension=curl.so libevent/event æ‰©å±•<span class="hljs-number">1</span>. ç”±äºPHP5.<span class="hljs-number">7</span>ä»¥ååªæ”¯æŒeventï¼Œå› æ­¤æˆ‘å®‰è£…çš„eventï¼Œä½†æ˜¯libeventçš„å®‰è£…æ–¹æ³•å’Œeventæ–¹æ³•ä¸€æ · <span class="hljs-number">2</span>. æ‰©å±•ä¾èµ–äºåŸå§‹çš„libeventåº“ï¼Œå¿…é¡»å…ˆæŠŠlibeventåº“å®‰è£… <span class="hljs-number">3</span>. å®‰è£…libeventåº“(https:<span class="hljs-regexp">//</span>libevent.org/) <span class="hljs-number">1</span>. wget https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/libevent/</span>libevent<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/release-2.1.8-stable/</span>libevent-<span class="hljs-number">2.1</span>.<span class="hljs-number">8</span>-stable.tar.gz <span class="hljs-number">1</span>. tar -zxvf libevent-<span class="hljs-number">2.1</span>.<span class="hljs-number">8</span>-stable.tar.gz <span class="hljs-number">1</span>. cd libevent-<span class="hljs-number">2.1</span>.<span class="hljs-number">8</span>-stable/ <span class="hljs-number">1</span>. .<span class="hljs-regexp">/configure â€“prefix=/u</span>sr<span class="hljs-regexp">/local/</span>libevent-<span class="hljs-number">2.1</span>.<span class="hljs-number">8</span>/ <span class="hljs-number">1</span>. make &amp;&amp; make install <span class="hljs-number">1</span>. å®‰è£…eventæ‰©å±•(https:<span class="hljs-regexp">//</span>pecl.php.net<span class="hljs-regexp">/package/</span>event) <span class="hljs-number">1</span>. wget https:<span class="hljs-regexp">//</span>pecl.php.net<span class="hljs-regexp">/get/</span>event-<span class="hljs-number">2.3</span>.<span class="hljs-number">0</span>.tgz <span class="hljs-number">1</span>. tar -zxvf event-<span class="hljs-number">2.3</span>.<span class="hljs-number">0</span>.tgz <span class="hljs-number">1</span>. cd event-<span class="hljs-number">2.3</span>.<span class="hljs-number">0</span>/ <span class="hljs-number">1</span>. <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>bin/phpize <span class="hljs-number">1</span>. .<span class="hljs-regexp">/configure â€“with-php-config=/u</span>sr<span class="hljs-regexp">/local/</span>php<span class="hljs-regexp">/bin/</span>php-config â€“with-event-libevent-dir=<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/libevent-2.1.8/</span> <span class="hljs-number">1</span>. å¦‚æœæ˜¯libevent<span class="hljs-number">1</span>. .<span class="hljs-regexp">/configure â€“with-php-config=/u</span>sr<span class="hljs-regexp">/local/</span>php<span class="hljs-regexp">/bin/</span>php-config â€“with-libevent=<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/libevent-2.1.8/</span> <span class="hljs-number">1</span>. make &amp;&amp; make install redisæ‰©å±•(phpredis)<span class="hljs-number">1</span>ã€ä¸‹è½½æºç https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/phpredis/</span>phpredis/releases wget https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/phpredis/</span>phpredis<span class="hljs-regexp">/archive/</span><span class="hljs-number">3.1</span>.<span class="hljs-number">4</span>.tar.gz <span class="hljs-number">2</span>ã€mv <span class="hljs-number">3.1</span>.<span class="hljs-number">4</span>.tar.gz phpredis.tar.gz <span class="hljs-number">3</span>ã€tar -zxvf phpredis.tar.gz <span class="hljs-number">4</span>ã€cd phpredis-<span class="hljs-number">3.1</span>.<span class="hljs-number">4</span>/ <span class="hljs-number">5</span>ã€<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>bin/phpize <span class="hljs-number">6</span>ã€.<span class="hljs-regexp">/configure â€“with-php-config=/u</span>sr<span class="hljs-regexp">/local/</span>php<span class="hljs-regexp">/bin/</span>php-config <span class="hljs-number">7</span>ã€ make &amp;&amp; make install <span class="hljs-number">8</span>ã€echo extension=redis.so &gt;&gt; <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>lib/php.iniopensslæ‰©å±•<span class="hljs-number">1</span>ã€è¿›å…¥æºç opensslæ–‡ä»¶å¤¹ cd <span class="hljs-regexp">/php-7.2.0/</span>ext/openssl <span class="hljs-number">2</span>ã€æ‰§è¡Œç”Ÿæˆconfigureï¼ˆå‡è®¾phpå®‰è£…åœ¨<span class="hljs-regexp">/usr/</span>local/phpç›®å½•ä¸‹ï¼‰ cp config0.m4 config.m4 <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>bin/phpize <span class="hljs-number">3</span>ã€ç”Ÿæˆmakefileæ–‡ä»¶ .<span class="hljs-regexp">/configure â€“with-php-config=/u</span>sr<span class="hljs-regexp">/local/</span>php<span class="hljs-regexp">/bin/</span>php-config <span class="hljs-number">4</span>ã€ç¼–è¯‘&amp;å®‰è£… make &amp;&amp; make install <span class="hljs-number">5</span>ã€echo extension=openssl.so &gt;&gt; <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/php/</span>lib/php.ini</code></pre>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç¼–è¯‘å®‰è£…</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>apache æºç å®‰è£…</title>
    <link href="/2018/05/19/apache-%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85/"/>
    <url>/2018/05/19/apache-%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<p>æ³¨ï¼šapt-get installÂ  gccÂ  makeÂ  g++Â  build-essential</p><p>1ã€wget <a href="https://mirrors.tuna.tsinghua.edu.cn/apache/httpd/httpd-2.4.32.tar.gz">https://mirrors.tuna.tsinghua.edu.cn/apache/httpd/httpd-2.4.32.tar.gz</a> <a href="https://mirrors.tuna.tsinghua.edu.cn/apache//apr/apr-1.6.3.tar.gz">https://mirrors.tuna.tsinghua.edu.cn/apache//apr/apr-1.6.3.tar.gz</a> <a href="https://mirrors.tuna.tsinghua.edu.cn/apache//apr/apr-util-1.6.1.tar.gz">https://mirrors.tuna.tsinghua.edu.cn/apache//apr/apr-util-1.6.1.tar.gz</a> <a href="https://ftp.pcre.org/pub/pcre/pcre-8.40.tar.gz">https://ftp.pcre.org/pub/pcre/pcre-8.40.tar.gz</a></p><p>2ã€tar -zxvf apr-1.6.3.tar.gzÂ  &amp;&amp; tar -zxvf apr-util-1.6.1.tar.gz &amp;&amp; tar -zxvf httpd-2.4.32.tar.gz &amp;&amp; tar -zxvfÂ  pcre-8.40.tar.gz</p><p>3ã€å»ºç«‹ç›®å½•<br>Â mkdir /usr/local/apache2</p><p>å…ˆæŠŠapråŠapr-utilä¸‹è½½è§£å‹åˆ°apacheæ–‡ä»¶å¤¹ä¸­çš„å­æ–‡ä»¶å¤¹srclibçš„apråŠapr-utilä¸­ï¼Œåœ¨è¿›è¡Œapacheçš„å®‰è£…</p><p>cp -r apr-1.6.3 httpd-2.4.32/srclib/apr &amp;&amp; cp -r apr-util-1.6.1 httpd-2.4.32/srclib/apr-util</p><p>4ã€å®‰è£…pcre<br>cd pcre-8.40Â <br>mkdir /usr/local/pcre<br>./configure --prefix=/usr/local/pcre<br>make<br>make install</p><p>5 ã€é…ç½®</p><p>cd â€¦/httpd-2.4.32Â <br>Aã€å‡å¦‚aprå’Œapr-utilæ˜¯æ‹·è´åˆ°httpd-2.4.23/srclibä¸­ï¼Œé‚£ä¹ˆåªéœ€è¦<br>./configure --prefix=/usr/local/apache2 --with-pcre=/usr/local/pcre --enable-module=shared</p><p>Bã€å‡å¦‚aprå’Œapr-utiléƒ½æ˜¯å’Œpcreé‚£æ ·è¿›è¡Œç¼–è¯‘å®‰è£…çš„ï¼Œå› æ­¤éœ€è¦å¦‚ä¸‹é…ç½®<br>./configure --prefix=/usr/local/apache2 --with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util --with- pcre=/usr/local/pcre --enable-module=shared</p><p>5ã€ç¼–è¯‘<br>Â  Â  makeÂ  Â Â <br>6ã€å®‰è£…<br>Â  Â  make install</p><p>7ã€vi /usr/local/apache2/conf/httpd.conf</p><p>æ‰¾åˆ°ï¼š<br>Â  Â  AddTypeÂ  application/x-compress .Z<br>Â  Â  AddType application/x-gzip .gz .tgz<br>Â  Â  åœ¨åé¢æ·»åŠ ï¼š<br>Â  Â  AddType application/x-httpd-php .phpï¼ˆä½¿Apccheæ”¯æŒPHPï¼‰<br>Â  Â  AddType application/x-httpd-php-source .phpsï¼ˆphpsæ”¯æŒphp7ï¼‰</p><p>æ‰¾åˆ°ï¼š<br>Â  Â  &lt;IfModule dir_module&gt;<br>Â  Â  DirectoryIndex index.htmlÂ  æ·»åŠ  index.php<br>Â  Â  </IfModule></p><p>æ‰¾åˆ°ï¼š<br>Â  Â  ï¼ƒServerName <a href="http://www.example.com:80">www.example.com:80</a><br>Â  Â  ä¿®æ”¹ä¸ºï¼š<br>Â  Â  ServerName 127.0.0.1:80æˆ–è€…ServerName localhost:80</p><p>8ã€åŠ å…¥åˆ°ç³»ç»Ÿå¼€æœºè‡ªåŠ¨å¯åŠ¨æœåŠ¡å™¨<br>cp /usr/local/apache2/bin/apachectl /etc/init.d/apache2<br>sysv-rc-conf apache2 onÂ <br>æˆ–è€… #update-rc.d apache2Â  defaults<br>æŸ¥çœ‹<br>sysv-rc-conf<br>sysv-rc-conf --list<br>sysv-rc-conf --list apache2Â Â <br>æ³¨æ„ï¼š2345ç©ºæ ¼å¼€å¯</p><p>9ã€apache2.å¯åŠ¨ï¼Œé‡å¯å’Œåœæ­¢ ï¼Œå…ˆåˆ‡æ¢åˆ°å®‰è£…å®Œæˆåçš„ç›®å½•/usr/local/apache2/bin<br>Â  Â  ./apachectl -k start<br>Â  Â  ./apachectl -k restart<br>Â  Â  ./apachectl -k stop</p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>apache</tag>
      
      <tag>ç¼–è¯‘å®‰è£…</tag>
      
      <tag>æºç å®‰è£…</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç®¡é“å‘½ä»¤</title>
    <link href="/2018/05/15/%E7%AE%A1%E9%81%93%E5%91%BD%E4%BB%A4/"/>
    <url>/2018/05/15/%E7%AE%A1%E9%81%93%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<p>ç®¡é“å‘½ä»¤ | åœ¨linuxä¸­éå¸¸å¸¸ç”¨ å‡ ä¹æ¯æ—¶æ¯åˆ»éƒ½ä¼šç”¨åˆ°è¿™ä¸ªå‘½ä»¤ é¦–å…ˆä¸¾ä¸ªæ —å­ï¼š<code>ps -ef |grep nginx |grep -v â€œgrepâ€</code> è¿™é‡Œæ˜¯è¦æ‰¾å‡ºnginxçš„æ‰€æœ‰è¿›ç¨‹ï¼Œåœ¨æ‰€æœ‰è¿›ç¨‹çš„æŸ¥è¯¢ç»“æœä¸­å§grepè‡ªèº«è¿™ä¸ªè¿›ç¨‹è¿‡æ»¤æ‰ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥æ¸…æ™°å¯è§çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå‘½ä»¤1è¾“å‡ºçš„ç»“æœå½“ä½œå‘½ä»¤2çš„è¾“å…¥ï¼Œå‘½ä»¤çš„2è¾“å‡ºçš„ç»“æœåˆè¢«å‘½ä»¤3å½“ä½œè¾“å…¥ã€‚ å¦‚ä¸‹å›¾ï¼š <a href="https://imgchr.com/i/CzjQh9"><img src="https://s1.ax1x.com/2018/06/20/CzjQh9.png" alt="CzjQh9.png"></a> 1ã€ç®¡é“å‘½ä»¤åªå¤„ç†å‰ä¸€ä¸ªå‘½ä»¤æ­£ç¡®è¾“å‡ºï¼Œä¸å¤„ç†é”™è¯¯è¾“å‡º 2ã€ç®¡é“å‘½ä»¤å³è¾¹å‘½ä»¤ï¼Œå¿…é¡»èƒ½å¤Ÿæ¥æ”¶æ ‡å‡†è¾“å…¥æµå‘½ä»¤æ‰è¡Œ <code>cat test.sh | grep -n 'good'</code> è¾“å‡º: <code>1:echo very good 2:echo good</code> grepæ˜¯æ–‡æœ¬æ­£åˆ™æŸ¥æ‰¾å‘½ä»¤, -n è¡¨ç¤ºæ‰¾åˆ°åè¾“å‡ºè¡Œå·; grepçš„è¾“å…¥æ˜¯ catå‘½ä»¤çš„è¾“å‡º ä¹Ÿå°±æ˜¯æ•´ä¸ªtesh.shæ–‡æœ¬çš„æ ‡å‡†è¾“å‡º ä¹Ÿæœ‰ä¸€äº›å‘½ä»¤æ˜¯ä¸æ”¯æŒæ ‡å‡†è¾“å…¥çš„ä¾‹å¦‚psã€ls</p><pre><code class="hljs tcl">root@vagrant-ubuntu-trusty<span class="hljs-number">-64</span>:/# cat stdout |lsbin   dev       etc   initrd.img  lib64       media  opt   root  sbin  stdout  tmp  vagrant  vmlinuzboot  dump.rdb  home  lib         lost+found  mnt    <span class="hljs-keyword">proc</span><span class="hljs-title">  run</span> <span class="hljs-title">  srv</span> <span class="hljs-title">  sys</span> <span class="hljs-title">    usr</span> <span class="hljs-title"> var</span> <span class="hljs-title">     www</span></code></pre><p><code>cat stdout</code>çš„ç»“æœè¢«ä¸¢å¼ƒ ç›´æ¥æ‰“å°çš„æ˜¯lsè¾“å‡ºçš„ç»“æœ åˆ—ä¸¾ä¸€äº›æ”¯æŒç®¡é“çš„å‘½ä»¤ï¼š å…³é”®è¯æœç´¢æŒ‡å®šè¡Œï¼š<code>grep</code> é€‰å–æŒ‡å®šåˆ—ï¼š<code>cut</code> æ’åºï¼š<code>sort</code> å»é™¤é‡å¤è¡Œï¼š<code>uniq</code> ç»Ÿè®¡å­—æ•°ã€è¡Œæ•°ã€å­—ç¬¦æ•°ï¼š<code>wc</code> åŒå‘é‡å®šå‘ï¼š<code>tee</code> è¿æ¥ä¸¤ä¸ªæ–‡ä»¶ï¼š<code>join</code> åˆ‡å‰²æ–‡ä»¶ï¼š<code>split</code></p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
      <category>shell</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç®¡é“å‘½ä»¤</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¸¸ç”¨çš„grepå‘½ä»¤</title>
    <link href="/2018/05/15/%E5%B8%B8%E7%94%A8%E7%9A%84grep%E5%91%BD%E4%BB%A4/"/>
    <url>/2018/05/15/%E5%B8%B8%E7%94%A8%E7%9A%84grep%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<p><strong>grep (global search regular expression(RE) and print out the line,å…¨é¢æœç´¢æ­£åˆ™è¡¨è¾¾å¼å¹¶æŠŠè¡Œæ‰“å°å‡ºæ¥)æ˜¯ä¸€ç§å¼ºå¤§çš„æ–‡æœ¬æœç´¢å·¥å…·ï¼Œå®ƒèƒ½ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æœç´¢æ–‡æœ¬ï¼Œå¹¶æŠŠåŒ¹é…çš„è¡Œæ‰“å°å‡ºæ¥ã€‚</strong></p><h2 id="grepå¸¸ç”¨ç”¨æ³•"><a class="header-anchor" href="#grepå¸¸ç”¨ç”¨æ³•"></a><strong>grepå¸¸ç”¨ç”¨æ³•</strong></h2><p>[root@www ~]# grep [-acinv] [â€“color=auto] â€˜æœå¯»å­—ç¬¦ä¸²â€™ filename<br>é€‰é¡¹ä¸å‚æ•°ï¼š<br>-a ï¼šå°† binary æ–‡ä»¶ä»¥ text æ–‡ä»¶çš„æ–¹å¼æœå¯»æ•°æ®<br>-c ï¼šè®¡ç®—æ‰¾åˆ° â€˜æœå¯»å­—ç¬¦ä¸²â€™ çš„æ¬¡æ•°<br>-i ï¼šå¿½ç•¥å¤§å°å†™çš„ä¸åŒï¼Œæ‰€ä»¥å¤§å°å†™è§†ä¸ºç›¸åŒ<br>-n ï¼šé¡ºä¾¿è¾“å‡ºè¡Œå·<br>-v ï¼šåå‘é€‰æ‹©ï¼Œäº¦å³æ˜¾ç¤ºå‡ºæ²¡æœ‰ â€˜æœå¯»å­—ç¬¦ä¸²â€™ å†…å®¹çš„é‚£ä¸€è¡Œï¼<br>â€“color=auto ï¼šå¯ä»¥å°†æ‰¾åˆ°çš„å…³é”®è¯éƒ¨åˆ†åŠ ä¸Šé¢œè‰²çš„æ˜¾ç¤ºå–”ï¼</p><p>å–å‡º/etc/passwd æœ‰å‡ºç°rootçš„è¡Œ</p><p>root@vagrant-ubuntu-trusty-64:# grep root /etc/passwd<br>rootâŒ0:0:root:/root:/bin/bash</p><p>æ˜¾ç¤ºè¡Œå·</p><p>root@vagrant-ubuntu-trusty-64:# grep -n root /etc/passwd<br>1:rootâŒ0:0:root:/root:/bin/bash</p><p>å°†/etc/passwdï¼Œå°†æ²¡æœ‰å‡ºç° root çš„è¡Œå–å‡ºæ¥</p><p>grep -v root /etc/passwd</p><p>daemonâŒ1:1:daemon:/usr/sbin:/usr/sbin/nologin<br>binâŒ2:2:bin:/bin:/usr/sbin/nologin<br>sysâŒ3:3:sys:/dev:/usr/sbin/nologin<br>syncâŒ4:65534:sync:/bin:/bin/sync<br>gamesâŒ5:60:games:/usr/games:/usr/sbin/nologin<br>manâŒ6:12ğŸ‘¨/var/cache/man:/usr/sbin/nologin<br>lpâŒ7:7:lp:/var/spool/lpd:/usr/sbin/nologin<br>mailâŒ8:8:mail:/var/mail:/usr/sbin/nologin<br>newsâŒ9:9:news:/var/spool/news:/usr/sbin/nologin<br>uucpâŒ10:10:uucp:/var/spool/uucp:/usr/sbin/nologin<br>proxyâŒ13:13:proxy:/bin:/usr/sbin/nologin<br>www-dataâŒ33:33:www-data:/var/www:/usr/sbin/nologin<br>backupâŒ34:34:backup:/var/backups:/usr/sbin/nologin<br>listâŒ38:38:Mailing List Manager:/var/list:/usr/sbin/nologin<br>ircâŒ39:39:ircd:/var/run/ircd:/usr/sbin/nologin<br>gnatsâŒ41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin<br>nobodyâŒ65534:65534:nobody:/nonexistent:/usr/sbin/nologin<br>libuuidâŒ100:101::/var/lib/libuuid:<br>syslogâŒ101:104::/home/syslog:/bin/false<br>messagebusâŒ102:106::/var/run/dbus:/bin/false<br>landscapeâŒ103:109::/var/lib/landscape:/bin/false<br>sshdâŒ104:65534::/var/run/sshd:/usr/sbin/nologin<br>pollinateâŒ105:1::/var/cache/pollinate:/bin/false<br>vagrantâŒ1000:1000::/home/vagrant:/bin/bash<br>colordâŒ106:112:colord colour management daemon,:/var/lib/colord:/bin/false<br>statdâŒ107:65534::/var/lib/nfs:/bin/false<br>puppetâŒ108:114:Puppet configuration management daemon,:/var/lib/puppet:/bin/false<br>ubuntuâŒ1001:1001:Ubuntu:/home/ubuntu:/bin/bash<br>mysqlâŒ999:1002::/home/mysql:/bin/false</p><p>ç”¨ dmesg åˆ—å‡ºæ ¸å¿ƒä¿¡æ¯ï¼Œå†ä»¥ grep æ‰¾å‡ºå†…å« eth é‚£è¡Œ,è¦å°†æ‰åˆ°çš„å…³é”®å­—æ˜¾è‰²ï¼Œä¸”åŠ ä¸Šè¡Œå·æ¥è¡¨ç¤ºï¼š</p><p>[root@www ~]# dmesg | grep -n --color=auto â€˜ethâ€™<br>247:eth0: RealTek RTL8139 at 0xee846000, 00:90:cc:a6:34:84, IRQ 10<br>248:eth0: Identified 8139 chip type â€˜RTL-8139Câ€™<br>294:eth0: link up, 100Mbps, full-duplex, lpa 0xC5E1<br>305:eth0: no IPv6 routers present</p><h1>ä½ ä¼šå‘ç°é™¤äº† eth ä¼šæœ‰ç‰¹æ®Šé¢œè‰²æ¥è¡¨ç¤ºä¹‹å¤–ï¼Œæœ€å‰é¢è¿˜æœ‰è¡Œå·å–”ï¼</h1><p>åœ¨å…³é”®å­—çš„æ˜¾ç¤ºæ–¹é¢ï¼Œgrep å¯ä»¥ä½¿ç”¨ --color=auto æ¥å°†å…³é”®å­—éƒ¨åˆ†ä½¿ç”¨é¢œè‰²æ˜¾ç¤ºã€‚ è¿™å¯æ˜¯ä¸ªå¾ˆä¸é”™çš„åŠŸèƒ½å•Šï¼ä½†æ˜¯å¦‚æœæ¯æ¬¡ä½¿ç”¨ grep éƒ½å¾—è¦è‡ªè¡ŒåŠ ä¸Š --color=auto åˆæ˜¾çš„å¾ˆéº»çƒ¦ï½ æ­¤æ—¶é‚£ä¸ªå¥½ç”¨çš„ alias å°±å¾—æ¥å¤„ç†ä¸€ä¸‹å•¦ï¼ä½ å¯ä»¥åœ¨ ~/.bashrc å†…åŠ ä¸Šè¿™è¡Œï¼šã€alias grep=â€˜grep --color=autoâ€™ã€å†ä»¥ã€ source ~/.bashrc ã€æ¥ç«‹å³ç”Ÿæ•ˆå³å¯å–”ï¼ è¿™æ ·æ¯æ¬¡è¿è¡Œ grep ä»–éƒ½ä¼šè‡ªåŠ¨å¸®ä½ åŠ ä¸Šé¢œè‰²æ˜¾ç¤º</p><p>ç”¨ dmesg åˆ—å‡ºæ ¸å¿ƒä¿¡æ¯ï¼Œå†ä»¥ grep æ‰¾å‡ºå†…å« eth é‚£è¡Œ,åœ¨å…³é”®å­—æ‰€åœ¨è¡Œçš„å‰ä¸¤è¡Œä¸åä¸‰è¡Œä¹Ÿä¸€èµ·æ‰å‡ºæ¥æ˜¾ç¤º</p><p>[root@www ~]# dmesg | grep -n -A3 -B2 --color=auto â€˜ethâ€™<br>245-PCI: setting IRQ 10 as level-triggered<br>246-ACPI: PCI Interrupt 0000:00:0e.0[A] -&gt; Link [LNKB] â€¦<br>247:eth0: RealTek RTL8139 at 0xee846000, 00:90:cc:a6:34:84, IRQ 10<br>248:eth0: Identified 8139 chip type â€˜RTL-8139Câ€™<br>249-input: PC Speaker as /class/input/input2<br>250-ACPI: PCI Interrupt 0000:00:01.4[B] -&gt; Link [LNKB] â€¦<br>251-hdb: ATAPI 48X DVD-ROM DVD-R-RAM CD-R/RW drive, 2048kB Cache, UDMA(66)</p><h1>å¦‚ä¸Šæ‰€ç¤ºï¼Œä½ ä¼šå‘ç°å…³é”®å­— 247 æ‰€åœ¨çš„å‰ä¸¤è¡ŒåŠ 248 åä¸‰è¡Œä¹Ÿéƒ½è¢«æ˜¾ç¤ºå‡ºæ¥ï¼</h1><h1>è¿™æ ·å¯ä»¥è®©ä½ å°†å…³é”®å­—å‰åæ•°æ®æ‰å‡ºæ¥è¿›è¡Œåˆ†æå•¦ï¼</h1><p>æ ¹æ®æ–‡ä»¶å†…å®¹é€’å½’æŸ¥æ‰¾ç›®å½•</p><p># grep â€˜energywiseâ€™ *           #åœ¨å½“å‰ç›®å½•æœç´¢å¸¦â€™energywiseâ€™è¡Œçš„æ–‡ä»¶</p><h1>grep -r â€˜energywiseâ€™ *        #åœ¨å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸‹æœç´¢â€™energywiseâ€™è¡Œçš„æ–‡ä»¶</h1><p># grep -l -r â€˜energywiseâ€™ *     #åœ¨å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸‹æœç´¢â€™energywiseâ€™è¡Œçš„æ–‡ä»¶ï¼Œä½†æ˜¯ä¸æ˜¾ç¤ºåŒ¹é…çš„è¡Œï¼Œåªæ˜¾ç¤ºåŒ¹é…çš„æ–‡ä»¶</p><p>è¿™å‡ ä¸ªå‘½ä»¤å¾ˆä½¿ç”¨ï¼Œæ˜¯æŸ¥æ‰¾æ–‡ä»¶çš„åˆ©å™¨ã€‚</p><p>grepæ˜¯ä¸€ä¸ªæ— æ¯”å¼ºå¤§çš„å‘½ä»¤è¿˜æœ‰è®¸å¤šæ›´åŠ é«˜é˜¶çš„æ­£åˆ™ç”¨æ³•</p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
      <category>shell</category>
      
    </categories>
    
    
    <tags>
      
      <tag>grep</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linuxçš„ä¸€äº›å¸¸ç”¨å‘½ä»¤</title>
    <link href="/2018/05/11/linux%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/2018/05/11/linux%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<p>æ ¼å¼ï¼š<code>pstree -p</code> ä»¥æ ‘çŠ¶å›¾æ˜¾ç¤ºè¿›ç¨‹ï¼Œè¿˜æ˜¾ç¤ºè¿›ç¨‹PIDã€‚ æ ¼å¼ï¼š<code>pstree &lt;pid&gt;</code> æ ¼å¼ï¼š<code>pstree -p &lt;pid&gt;</code> ä»¥æ ‘çŠ¶å›¾æ˜¾ç¤ºè¿›ç¨‹PIDä¸ºçš„è¿›ç¨‹ä»¥åŠå­å­™è¿›ç¨‹ï¼Œå¦‚æœæœ‰-på‚æ•°åˆ™åŒæ—¶æ˜¾ç¤ºæ¯ä¸ªè¿›ç¨‹çš„PIDã€‚ <img src="/wp-content/uploads/2018/05/20180511112155_32168.png" alt=""> <code>netstat -tunpl</code> åˆ—å‡ºæ‰€æœ‰tcpå’Œudpè¿æ¥ <img src="/wp-content/uploads/2018/05/20180511113613_30081.png" alt=""></p><blockquote><p>telnet å‘½ä»¤</p></blockquote><p>æ ¼å¼ï¼š <code>telnet ip prot</code> æµ‹è¯•åŸŸåè§£æï¼š</p><pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>vagrant-ubuntu-trusty<span class="hljs-number">-64</span>:~# telnet ipc.iloveismarthome.comTrying <span class="hljs-number">47.92</span><span class="hljs-number">.39</span><span class="hljs-number">.114</span>â€¦</code></pre><p>æµ‹è¯•socketç«¯å£ï¼š</p><pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>vagrant-ubuntu-trusty<span class="hljs-number">-64</span>:~# telnet ipc.iloveismarthome.com <span class="hljs-number">8</span>***Trying <span class="hljs-number">47.92</span><span class="hljs-number">.39</span><span class="hljs-number">.114</span>â€¦Connected to ipc.iloveismarthome.com.Escape character <span class="hljs-keyword">is</span> â€˜^]â€™.&#123;â€œwelcomeâ€: â€œwelcome to huabei3 IPC Serverâ€&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>å‘½ä»¤</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é˜¿é‡Œäº‘SLB + workerman åˆ†å¸ƒå¼éƒ¨ç½²</title>
    <link href="/2018/05/11/%E9%98%BF%E9%87%8C%E4%BA%91slb-workerman-%E5%88%86%E5%B8%83%E5%BC%8F%E9%83%A8%E7%BD%B2/"/>
    <url>/2018/05/11/%E9%98%BF%E9%87%8C%E4%BA%91slb-workerman-%E5%88%86%E5%B8%83%E5%BC%8F%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<p>è¿‘ä¸¤å¤©å·¥ä½œä¸Šçš„ä»»åŠ¡ï¼Œè¦åœ¨äº‘ç«¯åŠ ä¸€å°æœåŠ¡å™¨å°†workerman åšæˆåˆ†å¸ƒå¼é›†ç¾¤ï¼Œç°åœ¨åšä¸€ä¸‹æ€»ç»“å§ã€‚é¦–å…ˆè´­ä¹°é˜¿é‡ŒSLBå’ŒECSå°±ç•¥è¿‡äº†ï¼Œé˜¿é‡Œçš„æ–‡æ¡£å·²ç»å†™çš„å¾ˆæ¸…æ¥šäº†ã€‚ é‡ç‚¹è®°å½•ä¸€ä¸‹é‡åˆ°çš„å‘å§ï¼Œé¦–å…ˆæ˜¯æºç å®‰è£…nginxçš„æ—¶å€™1.8.1ç‰ˆæœ¬æœ‰ä¸ªå®˜æ–¹bugï¼Œä¸opensll-1.1.0gä¸å…¼å®¹ï¼Œæ­»æ´»makeä¸é€šè¿‡ï¼Œæ¢nginxæœ€æ–°ç¨³å®šç‰ˆè§£å†³ ä»¥ä¸‹æ˜¯æºç å®‰è£…nginxçš„ä¸€äº›æ­¥éª¤ï¼š ç¯å¢ƒï¼šubuntu 14.04 ï¼ˆApahce + php + nginx + workerman + redis + mysql ï¼‰nginxåšåå‘ä»£ç†http&amp;&amp;https 1ã€Nginxæºç ä¸‹è½½ <a href="https://nginx.org/download/nginx-(%E7%89%88%E6%9C%AC%E5%8F%B7)tar.gz">https://nginx.org/download/nginx-(ç‰ˆæœ¬å·)tar.gz</a> 2ã€ä¸‹è½½ä¾èµ–æ¨¡å—pcreã€opensslã€zlib 2.1ã€pcreï¼š<a href="https://www.pcre.org/">https://www.pcre.org/</a> wget <a href="https://ftp.pcre.org/pub/pcre/pcre-8.41.tar.gz">https://ftp.pcre.org/pub/pcre/pcre-8.41.tar.gz</a> 2.2ã€openssl:<a href="https://www.openssl.org/">https://www.openssl.org/</a> wget <a href="https://www.openssl.org/source/openssl-1.1.0g.tar.gz">https://www.openssl.org/source/openssl-1.1.0g.tar.gz</a> 2.3ã€zlib:<a href="https://zlib.net">https://zlib.net</a> wgetï¼š<a href="https://zlib.net/zlib-1.2.11.tar.gz">https://zlib.net/zlib-1.2.11.tar.gz</a> 3ã€å®‰è£…å‰é…ç½®</p><pre><code class="hljs shell">./configure â€“sbin-path=/usr/local/nginx/nginx \â€“conf-path=/usr/local/nginx/nginx.conf \â€“pid-path=/usr/local/nginx/nginx.pid \â€“with-http_ssl_module \â€“with-pcre=/root/pcre-8.41 \â€“with-zlib=/root/zlib-1.2.11 \â€“with-openssl=/root/openssl-1.1.0g</code></pre><p>4ã€ç¼–è¯‘å’Œå®‰è£… <code>make &amp;&amp; make install</code> åœ¨/etc/init.d/ æ·»åŠ å¼€æœºè„šæœ¬nginx</p><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><span class="hljs-meta">#</span><span class="bash"><span class="hljs-comment">## BEGIN INIT INFO</span></span><span class="hljs-meta">#</span><span class="bash"> Provides: Nginx</span><span class="hljs-meta">#</span><span class="bash"> Required-Start: <span class="hljs-variable">$network</span> <span class="hljs-variable">$remote_fs</span> <span class="hljs-variable">$syslog</span></span><span class="hljs-meta">#</span><span class="bash"> Required-Stop: <span class="hljs-variable">$network</span> <span class="hljs-variable">$remote_fs</span> <span class="hljs-variable">$syslog</span></span><span class="hljs-meta">#</span><span class="bash"> Default-Start: 2 3 4 5</span><span class="hljs-meta">#</span><span class="bash"> Default-Stop: 0 1 6</span><span class="hljs-meta">#</span><span class="bash"> Short-Description: Very secure Nginx HTTP server</span><span class="hljs-meta">#</span><span class="bash"> Description: Nginx is a high-performance web and proxy server</span><span class="hljs-meta">#</span><span class="bash"><span class="hljs-comment">## END INIT INFO</span></span></code></pre><p>#æ³¨æ„ï¼šè¿™é‡Œçš„ä¸‰ä¸ªå˜é‡éœ€è¦æ ¹æ®å…·ä½“çš„ç¯å¢ƒè€Œåšä¿®æ”¹ã€‚</p><pre><code class="hljs shell">nginxd=/usr/local/nginx/nginxnginx_config=/usr/local/nginx/nginx.confnginx_pid=/usr/local/nginx/logs/nginx.pidRETVAL=0prog=â€nginxâ€</code></pre><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> Check that networking is up.</span>[ -x $nginxd ] || exit 0<span class="hljs-meta">#</span><span class="bash"> Start nginx daemons <span class="hljs-built_in">functions</span>.</span>start() &#123;if [ -e $nginx_pid ];thenecho â€œnginx already runningâ€¦.â€exit 1fiecho -n $â€Starting $prog: â€<span class="hljs-meta">$</span><span class="bash">nginxd -c <span class="hljs-variable">$&#123;nginx_config&#125;</span></span>RETVAL=$?echo[ $RETVAL = 0 ]return $RETVAL&#125;<span class="hljs-meta">#</span><span class="bash"> Stop nginx daemons <span class="hljs-built_in">functions</span>.</span>stop() &#123;echo -n $â€Stopping $prog: â€<span class="hljs-meta">$</span><span class="bash">nginxd -s stop</span>RETVAL=$?echo[ $RETVAL = 0 ] &amp;&amp; rm -f /var/lock/subsys/nginx $nginx_pid&#125;<span class="hljs-meta">#</span><span class="bash"> reload nginx service <span class="hljs-built_in">functions</span>.</span>reload() &#123;echo -n $â€Reloading $prog: â€kill -HUP `cat $&#123;nginx_pid&#125;`RETVAL=$?echo&#125;<span class="hljs-meta">#</span><span class="bash"> See how we were called.</span>case â€œ$1â€³ instart)start;;stop)stop;;reload)reload;;restart)stopstart;;status)status $progRETVAL=$?;;*)echo $â€Usage: $prog &#123;start|stop|restart|reload|status|help&#125;â€exit 1esacexit $RETVAL</code></pre><p>è®¾ç½®è„šæœ¬æƒé™ <code>chmod -R 755 /etc/init.d/nginx</code> åŠ å…¥å¼€æœºæœåŠ¡ <code>update-rc.d nginx defaults</code> å¯ä»¥ä½¿ç”¨ sysv-rc-confå·¥å…·è¿›è¡ŒæŸ¥çœ‹å’Œç®¡ç†å¼€æœºå¯åŠ¨é¡¹ï¼ˆéœ€è¦å®‰è£…apt-get install sysv-rc-confï¼‰ å¯åŠ¨ã€é‡å¯ã€åœæ­¢ <code>service nginx start|stop|restart</code> å¹³æ»‘é‡å¯ <code>kill -USR2 pid</code></p><blockquote><p>workerman éƒ¨åˆ†ï¼š</p></blockquote><p>ä½¿ç”¨çš„æ˜¯GatewayWorker åšé›†ç¾¤ï¼Œé€‰æ‹©ä¸€å°masteræœåŠ¡å™¨æä¾›RegisteræœåŠ¡ï¼ˆç«¯å£1234ï¼‰å³å¯ï¼ˆç»Ÿè®¡socketæ—¶ç›´æ¥ä½¿ç”¨è¿™å°æœåŠ¡å™¨ipï¼‰å‡è®¾è¿™å°æœåŠ¡å™¨ä¸º192.168.1.1ï¼Œå…¶ä»–æœåŠ¡å™¨å°±ä¸éœ€è¦ start_register.phpè¿™ä¸ªæ–‡ä»¶äº†ï¼Œç„¶åå°†start_geteway.phpã€start_businessworker.phpä¸­çš„registerAddressä¸º192.168.1.1:1234ï¼Œstart_gateway.phpä¸­çš„lanIä¸ºå½“å‰æœåŠ¡å™¨çš„å†…ç½‘ipï¼š192.168.1.1ï¼ˆæ‰€æœ‰æœåŠ¡å™¨çš„ipéƒ½è¦æ˜¯å†…ç½‘æˆ–è€…å¤–ç½‘ipï¼Œä¸€å®šä¸èƒ½æ˜¯å›è·¯ip 127.0.0.1ï¼‰ å…¶ä»–taskæœåŠ¡å™¨åªéœ€é…ç½®start_gateway ï¼ŒregisterAddressä¸º192.168.1.1:1234,ï¼Œlanipä¸ºæœ¬æœåŠ¡å™¨ipã€‚start_businessworker.phpçš„registerAddress:192.168.1.1:1234 â‘ ã€RegisteræœåŠ¡ç›‘å¬çš„ç«¯å£è¦å¯ä»¥è¢«å…¶å®ƒå†…ç½‘æœåŠ¡å™¨è®¿é—®ï¼ˆå¤–ç½‘è®¿é—®å¯ä»¥å±è”½ï¼‰ï¼› â‘¡ã€start_gateway.phpä¸­å¦‚æœ$gateway-&gt;startPort=2300; $gateway-&gt;count=4;ï¼Œåˆ™2300 2301 2302 2303å››ä¸ªç«¯å£éœ€è¦è¢«è®¾ç½®æˆèƒ½è¢«å…¶å®ƒæœåŠ¡å™¨è®¿é—®ï¼Œä¹Ÿå°±æ˜¯èµ·å§‹ç«¯å£$gateway-&gt;startPortåˆ° $gateway-&gt;startPort + $gateway-&gt;count - 1è¿™ $gateway-&gt;countä¸ªç«¯å£è¦è®¾ç½®æˆèƒ½è¢«å…¶å®ƒå†…ç½‘ æœåŠ¡å™¨è®¿é—®ã€‚(åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°å®‰å…¨ç»„è§„åˆ™å…è®¸å…¥ç½‘ ï¼Œå¯ä»¥debugæ¨¡å¼è¿è¡Œç«¯å£é€šè®¯æ˜¯å¦æ­£å¸¸)åœ¨å‰ç«¯ä½¿ ç”¨SLBè¿›è¡Œè¯·æ±‚æ¥æ”¶å’Œè½¬å‘ç»™ï¼Œå®Œæˆéƒ¨ç½²ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>workerman</tag>
      
      <tag>é˜¿é‡Œäº‘</tag>
      
      <tag>slb</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vagrantå¸¸ç”¨å‘½ä»¤</title>
    <link href="/2018/04/26/vagrant%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/2018/04/26/vagrant%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> vagrant init      <span class="hljs-comment"># åˆå§‹åŒ–</span></span><span class="hljs-meta">$</span><span class="bash"> vagrant up        <span class="hljs-comment"># å¯åŠ¨è™šæ‹Ÿæœº</span></span><span class="hljs-meta">$</span><span class="bash"> vagrant halt      <span class="hljs-comment"># å…³é—­è™šæ‹Ÿæœº</span></span><span class="hljs-meta">$</span><span class="bash"> vagrant reload    <span class="hljs-comment"># é‡å¯è™šæ‹Ÿæœº</span></span><span class="hljs-meta">$</span><span class="bash"> vagrant ssh       <span class="hljs-comment"># SSH è‡³è™šæ‹Ÿæœº</span></span><span class="hljs-meta">$</span><span class="bash"> vagrant <span class="hljs-built_in">suspend</span>   <span class="hljs-comment"># æŒ‚èµ·è™šæ‹Ÿæœº</span></span><span class="hljs-meta">$</span><span class="bash"> vagrant resume    <span class="hljs-comment"># å”¤é†’è™šæ‹Ÿæœº</span></span><span class="hljs-meta">$</span><span class="bash"> vagrant status    <span class="hljs-comment"># æŸ¥çœ‹è™šæ‹Ÿæœºè¿è¡ŒçŠ¶æ€</span></span><span class="hljs-meta">$</span><span class="bash"> vagrant destroy   <span class="hljs-comment"># é”€æ¯å½“å‰è™šæ‹Ÿæœº</span></span><span class="hljs-meta">#</span><span class="bash">boxç®¡ç†å‘½ä»¤</span><span class="hljs-meta">$</span><span class="bash"> vagrant box list    <span class="hljs-comment"># æŸ¥çœ‹æœ¬åœ°boxåˆ—è¡¨</span></span><span class="hljs-meta">$</span><span class="bash"> vagrant box add     <span class="hljs-comment"># æ·»åŠ boxåˆ°åˆ—è¡¨</span></span><span class="hljs-meta">$</span><span class="bash"> vagrant box remove  <span class="hljs-comment"># ä»boxåˆ—è¡¨ç§»é™¤</span></span></code></pre>]]></content>
    
    
    <categories>
      
      <category>vagrant</category>
      
    </categories>
    
    
    <tags>
      
      <tag>vagrant</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åˆè¯† swoole</title>
    <link href="/2018/04/10/hello-world/"/>
    <url>/2018/04/10/hello-world/</url>
    
    <content type="html"><![CDATA[<blockquote><p>PHPä½œä¸ºâ€œä¸–ç•Œä¸Šæœ€å¥½çš„è¯­è¨€â€ï¼Œä¸€ç›´ä»¥æ¥è¢«å¹¿ç”¨äºwebç¨‹åºå¼€å‘ï¼Œä»…æ­¤è€Œå·²ã€‚å®ƒæ¥äº†â€“ Swooleï¼šé¢å‘ç”Ÿäº§ç¯å¢ƒçš„ PHP å¼‚æ­¥ç½‘ç»œé€šä¿¡å¼•æ“ã€‚ PHPçš„å¼‚æ­¥ã€å¹¶è¡Œã€é«˜æ€§èƒ½ç½‘ç»œé€šä¿¡å¼•æ“ï¼Œä½¿ç”¨çº¯Cè¯­è¨€ç¼–å†™ï¼Œæä¾›äº†PHPè¯­è¨€çš„å¼‚æ­¥å¤šçº¿ç¨‹æœåŠ¡å™¨ï¼Œå¼‚æ­¥TCP/UDPç½‘ç»œå®¢æˆ·ç«¯ï¼Œå¼‚æ­¥MySQLï¼Œå¼‚æ­¥Redisï¼Œæ•°æ®åº“è¿æ¥æ± ï¼ŒAsyncTaskï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯«ç§’å®šæ—¶å™¨ï¼Œå¼‚æ­¥æ–‡ä»¶è¯»å†™ï¼Œå¼‚æ­¥DNSæŸ¥è¯¢ã€‚ Swooleå†…ç½®äº†Http/WebSocketæœåŠ¡å™¨ç«¯/å®¢æˆ·ç«¯ã€Http2.0æœåŠ¡å™¨ç«¯/å®¢æˆ·ç«¯ï¼ˆå®˜ç½‘å¤åˆ¶ï¼‰ã€‚</p></blockquote><p>åæ­£swooleå„ç§ç‰›é€¼å°±æ˜¯äº†å“ˆå“ˆå“ˆ ğŸ˜„ ç«Ÿç„¶è¿™ä¹ˆç‰›é€¼æˆ‘ä»¬å°±å¼€å§‹å®‰è£…ä¸€æ­¥ä¸€æ­¥æ¥å­¦ä¹ å®ƒå§ï¼Œåœ¨å®‰è£…ä¹‹å‰æˆ‘ä»¬è¦å…ˆç¡®è®¤ç¯å¢ƒ(åªè®²linuxä¸‹)æ˜¯å¦ç¬¦åˆï¼š</p><blockquote><p>ä»…æ”¯æŒLinuxã€FreeBSDã€MacOSä¸‰ç§æ“ä½œç³»ç»Ÿ</p></blockquote><p>åœ¨Windowså¹³å°ï¼Œå¯ä½¿ç”¨CygWinæˆ–WSL(Windows Subsystem for Linux) Linuxå†…æ ¸ç‰ˆæœ¬2.3.32ä»¥ä¸Š gcc4.4ä»¥ä¸Šç‰ˆæœ¬æˆ–è€…clang ç¼–è¯‘ä¸ºlibswoole.soä½œä¸ºC/C++åº“æ—¶éœ€è¦ä½¿ç”¨cmake-2.4æˆ–æ›´é«˜ç‰ˆæœ¬ å»ºè®®ä½¿ç”¨Ubuntu14ã€CentOS7æˆ–æ›´é«˜ç‰ˆæœ¬çš„æ“ä½œç³»ç»Ÿ</p><blockquote><p>PHPç‰ˆæœ¬ä¾èµ–</p></blockquote><p>Swoole-1.xéœ€è¦PHP-5.3.10æˆ–æ›´é«˜ç‰ˆæœ¬ Swoole-2.xéœ€è¦PHP-7.0.0æˆ–æ›´é«˜ç‰ˆæœ¬ ä¸ä¾èµ–PHPçš„streamã€socketsã€pcntlã€posixã€sysvmsgç­‰æ‰©å±•ã€‚PHPåªéœ€å®‰è£…æœ€åŸºæœ¬çš„æ‰©å±•å³å¯</p><blockquote><p>ç¼–è¯‘å®‰è£…</p></blockquote><p>Swooleæ‰©å±•æ˜¯æŒ‰ç…§PHPæ ‡å‡†æ‰©å±•æ„å»ºçš„ã€‚ä½¿ç”¨phpizeæ¥ç”Ÿæˆç¼–è¯‘æ£€æµ‹è„šæœ¬ï¼Œ./configureæ¥åšç¼–è¯‘é…ç½®æ£€æµ‹ï¼Œmakeè¿›è¡Œç¼–è¯‘ï¼Œmake installè¿›è¡Œå®‰è£…ã€‚ è¯·ä¸‹è½½releasesç‰ˆæœ¬çš„swooleï¼Œç›´æ¥ä»githubä¸»å¹²ä¸Šæ‹‰å–æœ€æ–°ä»£ç å¯èƒ½ä¼šç¼–è¯‘ä¸è¿‡ å¦‚æœå½“å‰ç”¨æˆ·ä¸æ˜¯rootï¼Œå¯èƒ½æ²¡æœ‰PHPå®‰è£…ç›®å½•çš„å†™æƒé™ï¼Œå®‰è£…æ—¶éœ€è¦sudoæˆ–è€…su å¦‚æœæ˜¯åœ¨gitåˆ†æ”¯ä¸Šç›´æ¥git pullæ›´æ–°ä»£ç ï¼Œé‡æ–°ç¼–è¯‘å‰åŠ¡å¿…è¦æ‰§è¡Œmake clean ä¸‹è½½åœ°å€ <a href="https://github.com/swoole/swoole-src/releases">https://github.com/swoole/swoole-src/releases</a> <a href="https://pecl.php.net/package/swoole">https://pecl.php.net/package/swoole</a> <a href="https://git.oschina.net/swoole/swoole">https://git.oschina.net/swoole/swoole</a> ä¸‹è½½æºä»£ç åŒ…åï¼Œåœ¨ç»ˆç«¯è¿›å…¥æºç ç›®å½•ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œç¼–è¯‘å’Œå®‰è£…</p><pre><code class="hljs properties"><span class="hljs-attr">cd</span> <span class="hljs-string">swoole</span><span class="hljs-attr">phpize</span><span class="hljs-attr">./configure</span><span class="hljs-attr">make</span> <span class="hljs-string"></span><span class="hljs-attr">sudo</span> <span class="hljs-string">make install</span></code></pre><p>PECL swooleé¡¹ç›®å·²æ”¶å½•åˆ°PHPå®˜æ–¹æ‰©å±•åº“ï¼Œé™¤äº†æ‰‹å·¥ä¸‹è½½ç¼–è¯‘å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡PHPå®˜æ–¹æä¾›çš„peclå‘½ä»¤ï¼Œä¸€é”®ä¸‹è½½å®‰è£…swoole <code>pecl install swoole</code> é…ç½®php.ini ç¼–è¯‘å®‰è£…æˆåŠŸåï¼Œä¿®æ”¹php.iniåŠ å…¥ <code>extension=swoole.so</code> é€šè¿‡php -mæˆ–phpinfo()æ¥æŸ¥çœ‹æ˜¯å¦æˆåŠŸåŠ è½½äº†swooleï¼Œå¦‚æœæ²¡æœ‰å¯èƒ½æ˜¯php.iniçš„è·¯å¾„ä¸å¯¹ï¼Œå¯ä»¥ä½¿ç”¨php â€“iniæ¥å®šä½åˆ°php.iniçš„ç»å¯¹è·¯å¾„ã€‚</p><blockquote><p>å¿«é€Ÿèµ·æ­¥</p></blockquote><p>Swooleçš„ç»å¤§éƒ¨åˆ†åŠŸèƒ½åªèƒ½ç”¨äºcliå‘½ä»¤è¡Œç¯å¢ƒï¼Œè¯·é¦–å…ˆå‡†å¤‡å¥½Linux Shellç¯å¢ƒã€‚å¯ä½¿ç”¨vimã€emacsã€phpstormæˆ–å…¶ä»–ç¼–è¾‘å™¨ç¼–å†™ä»£ç ï¼Œå¹¶åœ¨å‘½ä»¤è¡Œä¸­é€šè¿‡ä¸‹åˆ—æŒ‡ä»¤æ‰§è¡Œç¨‹åºã€‚ <code>php /path/to/your_file.php</code> æˆåŠŸæ‰§è¡ŒSwooleæœåŠ¡å™¨ç¨‹åºåï¼Œå¦‚æœä½ çš„ä»£ç ä¸­æ²¡æœ‰ä»»ä½•echoè¯­å¥ï¼Œå±å¹•ä¸ä¼šæœ‰ä»»ä½•è¾“å‡ºï¼Œä½†å®é™…ä¸Šåº•å±‚å·²ç»åœ¨ç›‘å¬ç½‘ç»œç«¯å£ï¼Œç­‰å¾…å®¢æˆ·ç«¯å‘èµ·è¿æ¥ã€‚å¯ä½¿ç”¨ç›¸åº”çš„å®¢æˆ·ç«¯å·¥å…·å’Œç¨‹åºè¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¿›è¡Œæµ‹è¯•ã€‚</p><blockquote><p>è¿›ç¨‹ç®¡ç†</p></blockquote><p>é»˜è®¤ä½¿ç”¨SWOOLE_PROCESSæ¨¡å¼ï¼Œå› æ­¤ä¼šé¢å¤–åˆ›å»ºMasterå’ŒManagerä¸¤ä¸ªè¿›ç¨‹ã€‚åœ¨è®¾ç½®worker_numä¹‹åï¼Œå®é™…ä¼šå‡ºç°2 + worker_numä¸ªè¿›ç¨‹ æœåŠ¡å™¨å¯åŠ¨åï¼Œå¯ä»¥é€šè¿‡kill ä¸»è¿›ç¨‹IDæ¥ç»“æŸæ‰€æœ‰å·¥ä½œè¿›ç¨‹</p><blockquote><p>PHPç¯å¢ƒ</p></blockquote><p>Swooleæä¾›çš„ç»å¤§çš„éƒ¨åˆ†æ¨¡å—åªèƒ½ç”¨äºcliå‘½ä»¤è¡Œç»ˆç«¯ã€‚ç›®å‰åªæœ‰ClientåŒæ­¥å®¢æˆ·ç«¯å¯ä»¥ç”¨äºphp-fpmç¯å¢ƒä¸‹ã€‚è¯·å‹¿åœ¨Webç¯å¢ƒä¸­ä½¿ç”¨Serverç­‰æ¨¡å—ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>swoole</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>çº¿ç¨‹ã€è¿›ç¨‹ã€å¹¶è¡Œã€å¹¶å‘</title>
    <link href="/2012/02/28/%E7%BA%BF%E7%A8%8B%E3%80%81%E8%BF%9B%E7%A8%8B%E3%80%81%E5%B9%B6%E8%A1%8C%E3%80%81%E5%B9%B6%E5%8F%91/"/>
    <url>/2012/02/28/%E7%BA%BF%E7%A8%8B%E3%80%81%E8%BF%9B%E7%A8%8B%E3%80%81%E5%B9%B6%E8%A1%8C%E3%80%81%E5%B9%B6%E5%8F%91/</url>
    
    <content type="html"><![CDATA[<h1>ç¬¬äºŒèŠ‚ çº¿ç¨‹ï¼Œè¿›ç¨‹å’Œå¹¶å‘</h1><h2 id="è¿›ç¨‹"><a class="header-anchor" href="#è¿›ç¨‹"></a>è¿›ç¨‹</h2><p>è¿›ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿè¿›ç¨‹æ˜¯æ­£åœ¨æ‰§è¡Œçš„ç¨‹åºï¼›è¿›ç¨‹æ˜¯æ­£åœ¨è®¡ç®—æœºä¸Šæ‰§è¡Œçš„ç¨‹åºå®ä¾‹ï¼›è¿›ç¨‹æ˜¯èƒ½åˆ†é…ç»™å¤„ç†å™¨å¹¶ç”±å¤„ç†å™¨æ‰§è¡Œçš„å®ä½“ã€‚ è¿›ç¨‹ä¸€èˆ¬ä¼šåŒ…æ‹¬æŒ‡ä»¤é›†å’Œç³»ç»Ÿèµ„æºé›†ï¼Œè¿™é‡Œçš„æŒ‡ä»¤é›†æ˜¯æŒ‡ç¨‹åºä»£ç ï¼Œè¿™é‡Œçš„ç³»ç»Ÿèµ„æºé›†æ˜¯æŒ‡I/Oã€CPUã€å†…å­˜ç­‰ã€‚ ç»¼åˆèµ·æ¥ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç†è§£è¿›ç¨‹æ˜¯å…·æœ‰ä¸€å®šç‹¬ç«‹åŠŸèƒ½çš„ç¨‹åºåœ¨å…³äºæŸä¸ªæ•°æ®é›†åˆä¸Šçš„ä¸€æ¬¡è¿è¡Œæ´»åŠ¨ï¼Œ è¿›ç¨‹æ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„ä¸€ä¸ªç‹¬ç«‹å•ä½ã€‚ åœ¨è¿›ç¨‹æ‰§è¡Œæ—¶ï¼Œè¿›ç¨‹éƒ½å¯ä»¥è¢«å”¯ä¸€çš„è¡¨ç¤ºï¼Œç”±ä»¥ä¸‹ä¸€äº›å…ƒç´ ç»„æˆï¼š</p><ul><li>è¿›ç¨‹æè¿°ç¬¦ï¼šè¿›ç¨‹çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨æ¥å’Œå…¶å®ƒè¿›ç¨‹åŒºåˆ†ã€‚åœ¨Linuxä¸­å«è¿›ç¨‹IDï¼Œåœ¨ç³»ç»Ÿè°ƒç”¨forkæœŸé—´ç”Ÿæˆï¼Œåªæ˜¯æˆ‘ä»¬é€šè¿‡getpidè¿”å›çš„ä¸æ˜¯å…¶pidå­—æ®µï¼Œè€Œæ˜¯å…¶çº¿ç¨‹ç»„å·tgidã€‚</li><li>è¿›ç¨‹çŠ¶æ€ï¼šæˆ‘ä»¬å¸¸è¯´çš„æŒ‚èµ·ã€è¿è¡Œç­‰çŠ¶æ€ï¼Œå…¶è¡¨ç¤ºçš„æ˜¯å½“å‰çš„çŠ¶æ€ã€‚</li><li>ä¼˜å…ˆçº§ï¼šè¿›ç¨‹é—´çš„æ‰§è¡Œè°ƒåº¦ç›¸å…³ï¼Œç›¸å¯¹äºå…¶å®ƒè¿›ç¨‹è€Œè¨€ã€‚</li><li>ç¨‹åºè®¡æ•°å™¨ï¼šç¨‹åºä¸­å³å°†è¢«æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œè¯¥åœ°å€æ˜¯å†…æ ¸æœ¯ä¸­æˆ–ç”¨æˆ·å†…å­˜ç©ºé—´ä¸­çš„å†…å­˜åœ°å€ã€‚</li><li>å†…å­˜æŒ‡é’ˆï¼šåŒ…æ‹¬ç¨‹åºä»£ç å’Œè¿›ç¨‹ç›¸å…³æ•°æ®çš„æŒ‡é’ˆï¼Œè¿˜æœ‰å’Œå…¶å®ƒè¿›ç¨‹å…±äº«å†…å­˜å—çš„æŒ‡é’ˆã€‚</li><li>ä¸Šä¸‹æ–‡æ•°æ®ï¼šè¿›ç¨‹æ‰§è¡Œæ—¶å¤„ç†å™¨çš„å¯„å­˜å™¨çš„æ•°æ®ã€‚</li><li>I/OçŠ¶æ€ä¿¡æ¯ï¼šåŒ…æ‹¬æ˜¾å¼çš„I/Oè¯·æ±‚ã€åˆ†é…ç»™è¿›ç¨‹çš„I/Oè®¾å¤‡ç­‰</li><li>è®°è´¦ä¿¡æ¯ï¼šå¯èƒ½åŒ…æ‹¬å¤„ç†å™¨æ—¶é—´æ€»å’Œã€ä½¿ç”¨çš„æ—¶é’Ÿæ•°æ€»å’Œã€æ—¶é—´é™åˆ¶ç­‰</li></ul><p>ä»¥ä¸Šçš„è¿™äº›å…ƒç´ éƒ½ä¼šæ”¾åœ¨ä¸€ä¸ªå«åšè¿›ç¨‹æ§åˆ¶å—çš„æ•°æ®ç»“æ„ä¸­ã€‚è¿›ç¨‹æ§åˆ¶å—æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿæ”¯æŒå¤šè¿›ç¨‹å’Œæä¾›å¤šå¤„ç†çš„ç»“æ„ã€‚ å½“æ“ä½œç³»ç»Ÿåšè¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œä¸¤æ­¥æ“ä½œï¼Œä¸€æ˜¯ä¸­æ–­å½“å‰å¤„ç†å™¨ä¸­çš„è¿›ç¨‹ï¼ŒäºŒæ˜¯æ‰§è¡Œä¸‹ä¸€ä¸ªè¿›ç¨‹ã€‚ ä¸ç®¡æ˜¯ä¸­æ–­è¿˜æ˜¯æ‰§è¡Œï¼Œè¿›ç¨‹æ§åˆ¶å—ä¸­çš„ç¨‹åºè®¡æ•°å™¨ã€ä¸Šä¸‹æ–‡æ•°æ®å’Œè¿›ç¨‹çŠ¶æ€éƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚ å½“è¿›ç¨‹ä¸­æ–­æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæŠŠç¨‹åºè®¡æ•°å™¨å’Œå¤„ç†å™¨å¯„å­˜å™¨ï¼ˆå¯¹åº”è¿›ç¨‹æ§åˆ¶å—ä¸­çš„ä¸Šä¸‹æ–‡æ•°æ®ï¼‰ä¿å­˜åˆ°è¿›ç¨‹æ§åˆ¶å—ä¸­çš„ç›¸åº”ä½ç½®ï¼Œ è¿›ç¨‹çŠ¶æ€ä¹Ÿä¼šæœ‰æ‰€å˜åŒ–ï¼Œå¯èƒ½è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œä¹Ÿæœ‰å¯èƒ½è¿›å…¥å°±ç»ªæ€ã€‚ å½“æ‰§è¡Œä¸‹ä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œæ“ä½œç³»ç»ŸæŒ‰è§„åˆ™å°†ä¸‹ä¸€ä¸ªè¿›ç¨‹è®¾ç½®ä¸ºè¿è¡Œæ€ï¼Œå¹¶åŠ è½½å³å°†è¦æ‰§è¡Œè¿›ç¨‹çš„ç¨‹åºä¸Šä¸‹æ–‡æ•°æ®å’Œç¨‹åºè®¡æ•°å™¨ç­‰ã€‚</p><h2 id="çº¿ç¨‹"><a class="header-anchor" href="#çº¿ç¨‹"></a>çº¿ç¨‹</h2><p>è¿›ç¨‹æœ‰ä¸¤ä¸ªç‰¹æ€§éƒ¨åˆ†ï¼šèµ„æºæ‰€æœ‰æƒå’Œè°ƒåº¦æ‰§è¡Œã€‚ èµ„æºæ‰€æœ‰æƒæ˜¯æŒ‡è¿›ç¨‹åŒ…æ‹¬äº†è¿›ç¨‹è¿è¡Œæ‰€éœ€è¦çš„å†…å­˜ç©ºé—´ã€I/Oç­‰èµ„æºã€‚ è°ƒåº¦æ‰§è¡Œæ˜¯æŒ‡è¿›ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­é—´çš„æ‰§è¡Œè·¯å¾„ï¼Œæˆ–è€…è¯´ç¨‹åºçš„æŒ‡ä»¤æ‰§è¡Œæµã€‚ è¿™ä¸¤ä¸ªç‰¹æ€§éƒ¨åˆ†æ˜¯å¯ä»¥åˆ†å¼€çš„ï¼Œåˆ†å¼€åï¼Œæ‹¥æœ‰èµ„æ–™æ‰€æœ‰æƒçš„é€šå¸¸ç§°ä¸ºè¿›ç¨‹ï¼Œæ‹¥æœ‰æ‰§è¡Œä»£ç çš„å¯åˆ†æ´¾éƒ¨åˆ†çš„è¢«ç§°ä¹‹ä¸ºçº¿ç¨‹æˆ–è½»é‡çº§è¿›ç¨‹ã€‚ çº¿ç¨‹æœ‰â€œæ‰§è¡Œçš„çº¿ç´¢â€çš„æ„æ€åœ¨é‡Œé¢ï¼Œè€Œè¿›ç¨‹åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¢«å®šä¹‰ä¸ºèµ„æºæ‰€æœ‰è€…ï¼Œå…¶è¿˜æ˜¯ä¼šå­˜å‚¨è¿›ç¨‹çš„è¿›ç¨‹æ§åˆ¶å—ã€‚ çº¿ç¨‹çš„ç»“æ„ä¸è¿›ç¨‹ä¸åŒï¼Œæ¯ä¸ªçº¿ç¨‹åŒ…æ‹¬ï¼š</p><ul><li>çº¿ç¨‹çŠ¶æ€ï¼š çº¿ç¨‹å½“å‰çš„çŠ¶æ€ã€‚</li><li>ä¸€ä¸ªæ‰§è¡Œæ ˆ</li><li>ç§æœ‰çš„æ•°æ®åŒºï¼š ç”¨äºæ¯ä¸ªçº¿ç¨‹å±€éƒ¨å˜é‡çš„é™æ€å­˜å‚¨ç©ºé—´</li><li>å¯„å­˜å™¨é›†ï¼š å­˜å‚¨å¤„ç†å™¨çš„ä¸€äº›çŠ¶æ€</li></ul><p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹æ§åˆ¶å—å’Œç”¨æˆ·åœ°å€ç©ºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„æ ˆå’Œç‹¬ç«‹çš„æ§åˆ¶å—ï¼Œéƒ½æœ‰è‡ªå·±ä¸€ä¸ªç‹¬ç«‹æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚ å…¶ç»“æ„å¦‚å›¾8.1æ‰€ç¤ºã€‚ <img src="http://www.php-internals.com/images/book/chapt08/08-02-01-thread-model.jpg" alt="å›¾8.1 è¿›ç¨‹æ¨¡å‹å›¾"> å›¾8.1 è¿›ç¨‹æ¨¡å‹å›¾ çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸è¿›ç¨‹æœ‰ä¸€äº›ä¸åŒã€‚æ¯ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æœ‰ä¸€ä¸ªç¨‹åºè¿è¡Œçš„å…¥å£ã€é¡ºåºæ‰§è¡Œåºåˆ—å’Œç¨‹åºçš„å‡ºå£ã€‚ ä½†æ˜¯çº¿ç¨‹ä¸èƒ½å¤Ÿç‹¬ç«‹æ‰§è¡Œï¼Œå¿…é¡»ä¾å­˜åœ¨äºè¿›ç¨‹ä¹‹ä¸­ï¼Œç”±è¿›ç¨‹æä¾›å¤šä¸ªçº¿ç¨‹æ‰§è¡Œæ§åˆ¶ã€‚ ä»é€»è¾‘è§’åº¦æ¥çœ‹ï¼Œå¤šçº¿ç¨‹çš„æ„ä¹‰åœ¨äºä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œæœ‰å¤šä¸ªæ‰§è¡Œéƒ¨åˆ†å¯ä»¥åŒæ—¶æ‰§è¡Œã€‚ æ­¤æ—¶ï¼Œè¿›ç¨‹æœ¬èº«ä¸æ˜¯åŸºæœ¬è¿è¡Œå•ä½ï¼Œè€Œæ˜¯çº¿ç¨‹çš„å®¹å™¨ã€‚ çº¿ç¨‹è¾ƒä¹‹è¿›ç¨‹ï¼Œå…¶ä¼˜åŠ¿åœ¨äºä¸€ä¸ªå¿«ï¼Œä¸ç®¡æ˜¯åˆ›å»ºæ–°çš„çº¿ç¨‹è¿˜æ˜¯ç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼›ä¸ç®¡æ˜¯çº¿ç¨‹é—´çš„åˆ‡æ¢è¿˜æ˜¯çº¿ç¨‹é—´å…±äº«æ•°æ®æˆ–é€šä¿¡ï¼Œå…¶é€Ÿåº¦ä¸è¿›ç¨‹ç›¸æ¯”éƒ½æœ‰è¾ƒå¤§çš„ä¼˜åŠ¿ã€‚</p><h2 id="å¹¶å‘åŠå¹¶è¡Œ"><a class="header-anchor" href="#å¹¶å‘åŠå¹¶è¡Œ"></a>å¹¶å‘åŠå¹¶è¡Œ</h2><p>å¹¶å‘åˆç§°å…±è¡Œï¼Œæ˜¯æŒ‡èƒ½å¤„ç†å¤šä¸ªåŒæ—¶æ€§æ´»åŠ¨çš„èƒ½åŠ›ï¼Œå¹¶å‘äº‹ä»¶ä¹‹é—´ä¸ä¸€å®šè¦åŒä¸€æ—¶åˆ»å‘ç”Ÿã€‚ æ¯”å¦‚ï¼Œç°ä»£è®¡ç®—æœºç³»ç»Ÿå¯åœ¨åŒä¸€æ®µæ—¶é—´å†…ä»¥è¿›ç¨‹çš„å½¢å¼å°†å¤šä¸ªç¨‹åºåŠ è½½åˆ°å­˜å‚¨å™¨ä¸­ï¼Œå¹¶å€Ÿç”±å¤„ç†å™¨çš„æ—¶åˆ†å¤ç”¨ï¼Œ ä»¥åœ¨ä¸€ä¸ªå¤„ç†å™¨ä¸Šè¡¨ç°å‡ºåŒæ—¶è¿è¡Œçš„æ„Ÿè§‰ã€‚ å¹¶è¡Œæ˜¯æŒ‡åŒæ—¶å‘ç”Ÿçš„ä¸¤ä¸ªå¹¶å‘äº‹ä»¶ï¼Œå…·æœ‰å¹¶å‘çš„å«ä¹‰ï¼Œè€Œå¹¶å‘åˆ™ä¸ä¸€å®šå¹¶è¡Œã€‚ å¹¶å‘å’Œå¹¶è¡Œçš„åŒºåˆ«å°±æ˜¯ä¸€ä¸ªå¤„ç†å™¨åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡å’Œå¤šä¸ªå¤„ç†å™¨æˆ–è€…æ˜¯å¤šæ ¸çš„å¤„ç†å™¨åŒæ—¶å¤„ç†å¤šä¸ªä¸åŒçš„ä»»åŠ¡ã€‚ å‰è€…æ˜¯é€»è¾‘ä¸Šçš„åŒæ—¶å‘ç”Ÿï¼ˆsimultaneousï¼‰ï¼Œè€Œåè€…æ˜¯ç‰©ç†ä¸Šçš„åŒæ—¶å‘ç”Ÿã€‚</p><h3 id="PHPçš„å„ç§å¹¶å‘æ¨¡å‹"><a class="header-anchor" href="#PHPçš„å„ç§å¹¶å‘æ¨¡å‹"></a>PHPçš„å„ç§å¹¶å‘æ¨¡å‹</h3><p>æ—¢ç„¶æœ‰ä¸¤ç§æ¨¡å‹ï¼Œé‚£ä¹ˆPHPä½¿ç”¨çš„æ˜¯å“ªä¸€ç§å‘¢ï¼Ÿç­”æ¡ˆæ˜¯éƒ½æ”¯æŒï¼Œä¹Ÿå°±æ˜¯è¯´PHPæ”¯æŒå¤šçº¿ç¨‹çš„æ¨¡å‹ï¼Œ åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹é€šå¸¸è¦è§£å†³èµ„æºå…±äº«å’Œéš”ç¦»çš„é—®é¢˜ã€‚PHPæœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><blockquote><p>å…·ä½“æ¥è¯´æ˜¯å“ªç§æ¨¡å‹éœ€è¦çœ‹ä½¿ç”¨çš„æ˜¯å“ªä¸ªSAPIï¼Œæ¯”å¦‚è¯´åœ¨Apacheä¸­ï¼Œé‚£ä¹ˆå°±å¯èƒ½ä½¿ç”¨å¤šçº¿ç¨‹æ¨¡å‹ï¼Œ ä¹Ÿå¯èƒ½ä½¿ç”¨å¤šè¿›ç¨‹æ¨¡å‹ã€‚è€Œphp-fpmä½¿ç”¨çš„å°±æ˜¯å¤šè¿›ç¨‹æ¨¡å‹ã€‚</p></blockquote><p>ç›®å‰æ¯”è¾ƒæ¨èçš„æ–¹å¼æ˜¯ä½¿ç”¨php-fpmçš„æ¨¡å‹ï¼Œå› ä¸ºè¿™ä¸ªæ¨¡å‹å¯¹äºPHPæ¥è¯´æœ‰è¯¸å¤šçš„ä¼˜åŠ¿ï¼š</p><ol><li>å†…å­˜é‡Šæ”¾ç®€å•ï¼Œä½¿ç”¨å¤šè¿›ç¨‹æ¨¡å‹æ—¶è¿›ç¨‹å¯ä»¥å®¹æ˜“é€šè¿‡é€€å‡ºçš„æ–¹å¼æ¥é‡Šæ”¾å†…å­˜ï¼Œ ç”±äºPHPæœ‰éå¸¸å¤šçš„æ‰©å±•ï¼Œç¨æœ‰ä¸æ…å°±å¯èƒ½å¯¼è‡´å†…å­˜æ³„éœ²ï¼Œfpmé€šè¿‡è¿›ç¨‹é€€å‡ºæ–¹å¼ ç®€å•ç²—æš´çš„è§£å†³äº†é—®é¢˜ã€‚</li><li>å®¹ç¾èƒ½åŠ›å¼ºï¼ŒåŒæ ·çš„é—®é¢˜ï¼Œæ‰©å±•æˆ–è€…phpå¯èƒ½ä¼šå‡ºç°æ®µé”™è¯¯ï¼Œå¦‚æœæ˜¯å•è¿›ç¨‹å¤šçº¿ç¨‹æ¨¡å‹ï¼Œ é‚£ä¹ˆæ•´ä¸ªPHPå°±æŒ‚æ‰äº†ã€‚è¿™ä¼šå½±å“æœåŠ¡ï¼Œå¤šè¿›ç¨‹çš„è¯ï¼ŒæŸä¸ªè¿›ç¨‹æ­»æ‰äº†ä¹Ÿä¸ä¼šå½±å“æ•´ä½“çš„æœåŠ¡ã€‚</li></ol><p>å¤šè¿›ç¨‹æœ‰å¤šè¿›ç¨‹çš„ä¼˜åŠ¿ï¼Œå¤šçº¿ç¨‹ä¹Ÿæœ‰å¤šçº¿ç¨‹çš„ä¼˜åŠ¿ï¼Œæ¯”å¦‚HHVMå®ƒé€‰æ‹©çš„æ˜¯å¤šçº¿ç¨‹æ¨¡å‹ã€‚ å¤šçº¿ç¨‹æ¨¡å‹æœ€å¤§çš„å¥½å¤„æ˜¯ä¿¡æ¯å…±äº«å’Œé€šä¿¡æ–¹ä¾¿ï¼Œå› ä¸ºåœ¨åŒä¸€ä¸ªè¿›ç¨‹ç©ºé—´å†…ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨æŒ‡é’ˆã€‚ æ¯”å¦‚opcode cacheå·¥å…·ï¼Œåœ¨PHPé‡Œï¼Œapcä»¥åŠopcacheç­‰ç­‰ä½¿ç”¨çš„æ˜¯å…±äº«å†…å­˜æ¥å…±äº«opcodeï¼Œ é‚£ä¹ˆåœ¨HHVMä¸­åˆ™ä¸éœ€è¦èµ°å…±äº«å†…å­˜ï¼Œå…±äº«å†…å­˜è¿˜æœ‰ä¸ªé—®é¢˜æ˜¯å­˜å‚¨å¤æ‚çš„æ•°æ®ç»“æ„ä¸æ–¹ä¾¿ï¼Œ å› ä¸ºæŒ‡é’ˆçš„é—®é¢˜ï¼Œå¤šçº¿ç¨‹æƒ…å†µä¸‹C/C++ä¸­çš„æ•°æ®ç»“æ„æ˜¯å¯ä»¥å…±äº«çš„ã€‚è¿™å¯¹æ•ˆç‡æå‡ä¹Ÿæ˜¯æœ‰å¸®åŠ©çš„ã€‚ å¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹è¿˜æœ‰ä¸€ä¸ªæ˜æ˜¾çš„æ¨¡å‹åŒºåˆ«ï¼šåœ¨å¤„ç†è¯·æ±‚æ—¶çš„é€»è¾‘ã€‚ åœ¨å¤šè¿›ç¨‹æƒ…å†µä¸‹ï¼Œç”±äºè·¨è¿›ç¨‹æ˜¯ä¸å¥½ä¼ é€’fdè¿æ¥çš„ã€‚é‚£ä¹ˆå¤šè¿›ç¨‹é€šå¸¸é‡‡ç”¨åœ¨çˆ¶è¿›ç¨‹ä¸­<code>listen()</code>ï¼Œ ç„¶åå„ä¸ªå­è¿›ç¨‹<code>accept()</code>çš„æ–¹å¼æ¥å®ç°è´Ÿè½½å‡è¡¡ã€‚è¿™æ ·çš„æ¨¡å‹ä¸‹å¯èƒ½ä¼šæœ‰æƒŠç¾¤çš„é—®é¢˜ã€‚ è€Œå¤šçº¿ç¨‹æ¨¡å‹ä¸‹ï¼Œå¯ä»¥é‡‡ç”¨ä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹æ¥å—è¯·æ±‚ç„¶åæ´¾å‘åˆ°å„ä¸ªworkerçº¿ç¨‹çš„æ–¹å¼ã€‚</p><p><strong>å‚è€ƒï¼š<a href="http://www.php-internals.com/" title="ã€Šæ·±å…¥PHPå†…æ ¸ã€‹">ã€Šæ·±å…¥PHPå†…æ ¸ã€‹</a></strong></p>]]></content>
    
    
    <categories>
      
      <category>åŸç†</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¹¶å‘</tag>
      
      <tag>çº¿ç¨‹</tag>
      
      <tag>è¿›ç¨‹</tag>
      
      <tag>å¹¶è¡Œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
